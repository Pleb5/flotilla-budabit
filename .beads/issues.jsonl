{"id":"flotilla-02w29iuy","title":"From 695235359c518ae157c842eeeee4e015e7cbb3bc Mon Sep 17 00:00:00 2001","description":"From 695235359c518ae157c842eeeee4e015e7cbb3bc Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 11 Dec 2025 13:48:18 +1000\nSubject: [PATCH 1/2] ``` feat(config): add feature flags and fix NIP-29 relay error handling\n\n- Add feature flag definitions in vite.config.ts for production/development mode and optional features\n- Add __STRICT_NIP29__ flag to conditionally handle strict NIP-29 relay errors\n- Fix duplicate isStrictNip29Relay check in relay auth error derivation\n- Update nostr-git submodule reference (dirty state)\n```\n---\n .env.example           |  84 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n FEATURE_FLAGS.md       | 318 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/app/core/state.ts  |   4 ++--\n src/feature-flags.d.ts |   7 +++++++\n vite.config.ts         |   9 +++++++++\n 5 files changed, 420 insertions(+), 2 deletions(-)\n create mode 100644 .env.example\n create mode 100644 FEATURE_FLAGS.md\n create mode 100644 src/feature-flags.d.ts\n\ndiff --git a/.env.example b/.env.example\nnew file mode 100644\nindex 0000000..0d72f16\n--- /dev/null\n+++ b/.env.example\n@@ -0,0 +1,84 @@\n+# Budabit Environment Configuration\n+\n+# Platform Configuration\n+VITE_PLATFORM_NAME=Budabit\n+VITE_PLATFORM_ACCENT=#8B5CF6\n+VITE_PLATFORM_DESCRIPTION=Decentralized Git collaboration on Nostr\n+\n+# Build Environment\n+NODE_ENV=development\n+\n+# ====================================================================\n+# FEATURE FLAGS (Build-time Constants)\n+# ====================================================================\n+# These flags control which features are compiled into the application.\n+# When set to \"0\", the associated code is completely removed from the\n+# final bundle via tree-shaking, reducing bundle size.\n+#\n+# Default behavior (when not set):\n+# - FEATURE_GRASP: enabled (included in build)\n+# - FEATURE_TERMINAL: enabled (included in build)\n+# - FEATURE_NIP34_PR: disabled (excluded from build)\n+# - FEATURE_CICD: disabled (excluded from build)\n+# - FEATURE_STRICT_NIP29: disabled (excluded from build)\n+# ====================================================================\n+\n+# GRASP Git Protocol Integration\n+# Enables GRASP relay support for Git repository state synchronization\n+# Set to \"0\" to disable and remove ~50KB from bundle\n+FEATURE_GRASP=1\n+\n+# Terminal UI Components\n+# Enables terminal emulator components for Git CLI operations\n+# Set to \"0\" to disable and remove ~150KB from bundle\n+FEATURE_TERMINAL=1\n+\n+# NIP-34 Pull Request Format\n+# Enables updated NIP-34 Pull Request event format support\n+# Set to \"1\" to enable experimental PR format features\n+FEATURE_NIP34_PR=0\n+\n+# CI/CD Automation Features\n+# Enables GitHub Actions integration and automation workflows\n+# Set to \"1\" to enable CI/CD features\n+FEATURE_CICD=0\n+\n+# Strict NIP-29 Validation\n+# Enables strict validation for NIP-29 group/room federation\n+# Set to \"1\" to enforce stricter conversation thread validation\n+FEATURE_STRICT_NIP29=0\n+\n+# ====================================================================\n+# Nostr Configuration\n+# ====================================================================\n+\n+# Default Nostr Relays (semicolon-separated)\n+NOSTR_DEFAULT_RELAYS=wss://relay.damus.io;wss://nos.lol;wss://relay.nostr.band\n+\n+# Fallback Relays\n+NOSTR_FALLBACK_RELAYS=wss://purplerelay.com;wss://purplepages.es;wss://relayable.org\n+\n+# GRASP Relays (only used when FEATURE_GRASP=1)\n+NOSTR_GRASP_RELAYS=wss://relay.ngit.dev;wss://gitnostr.com\n+\n+# GRASP Integration Toggle (runtime, requires FEATURE_GRASP=1)\n+NOSTR_ENABLE_GRASP=true\n+\n+# Repository State Publishing\n+NOSTR_PUBLISH_REPO_STATE=true\n+NOSTR_PUBLISH_REPO_ANNOUNCEMENTS=false\n+\n+# ====================================================================\n+# Git Configuration\n+# ====================================================================\n+\n+# CORS Proxy for Git HTTP operations\n+# Set to \"none\" to disable proxy\n+GIT_DEFAULT_CORS_PROXY=https://corsproxy.budabit.club\n+\n+# ====================================================================\n+# Development/Debug\n+# ====================================================================\n+\n+# Show debug logging in extension\n+NOSTR_GIT_SHOW_DEBUG=true\ndiff --git a/FEATURE_FLAGS.md b/FEATURE_FLAGS.md\nnew file mode 100644\nindex 0000000..d0b0b59\n--- /dev/null\n+++ b/FEATURE_FLAGS.md\n@@ -0,0 +1,318 @@\n+# Feature Flags Reference\n+\n+Budabit uses **build-time feature flags** to enable/disable features and optimize bundle size through dead-code elimination.\n+\n+## Overview\n+\n+Feature flags are compile-time constants defined during the build process. When a feature is disabled, the bundler (Vite/esbuild) automatically removes all associated code from the final bundle through tree-shaking, resulting in smaller bundle sizes and faster load times.\n+\n+## Available Flags\n+\n+### `__PRODUCTION__` / `__DEVELOPMENT__`\n+\n+**Type**: Environment  \n+**Default**: Based on `NODE_ENV`  \n+**Control**: Automatic\n+\n+Indicates the build environment. Used for debug logging, development-only features, and source maps.\n+\n+```typescript\n+if (__DEVELOPMENT__) {\n+  console.log('Debug info:', data);\n+}\n+```\n+\n+### `__GRASP__`\n+\n+**Type**: Feature  \n+**Default**: Enabled  \n+**Control**: `FEATURE_GRASP` environment variable\n+\n+Enables GRASP (Git Repository Announcement State Protocol) integration for Git-over-Nostr functionality.\n+\n+**When enabled**:\n+- GRASP relay support\n+- Repository state synchronization\n+- GRASP-specific Git providers\n+- ~50KB bundle size\n+\n+**Usage**:\n+```bash\n+# Disable GRASP features\n+FEATURE_GRASP=0 npm run build\n+```\n+\n+**Code gating**:\n+```typescript\n+if (__GRASP__) {\n+  const graspApi = new GraspApi(config);\n+}\n+```\n+\n+### `__TERMINAL__`\n+\n+**Type**: Feature  \n+**Default**: Enabled  \n+**Control**: `FEATURE_TERMINAL` environment variable\n+\n+Enables terminal emulator components for Git CLI operations.\n+\n+**When enabled**:\n+- Terminal.svelte component\n+- Git CLI adapters\n+- XTerm.js integration\n+- Command execution UI\n+- ~150KB bundle size (includes xterm dependencies)\n+\n+**Usage**:\n+```bash\n+# Disable terminal features\n+FEATURE_TERMINAL=0 npm run build\n+```\n+\n+**Code gating**:\n+```svelte\n+{#if __TERMINAL__}\n+  \u003cTerminal {options} /\u003e\n+{/if}\n+```\n+\n+### `__NIP34_PR__`\n+\n+**Type**: Feature  \n+**Default**: Disabled  \n+**Control**: `FEATURE_NIP34_PR` environment variable\n+\n+Enables experimental NIP-34 Pull Request format support.\n+\n+**When enabled**:\n+- Updated PR event structures\n+- Enhanced patch metadata\n+- PR-specific validation\n+\n+**Usage**:\n+```bash\n+# Enable NIP-34 PR features\n+FEATURE_NIP34_PR=1 npm run build\n+```\n+\n+**Code gating**:\n+```typescript\n+if (__NIP34_PR__) {\n+  // Use updated PR format\n+  event.tags.push(['pr-status', status]);\n+}\n+```\n+\n+### `__CICD__`\n+\n+**Type**: Feature  \n+**Default**: Disabled  \n+**Control**: `FEATURE_CICD` environment variable\n+\n+Enables CI/CD automation features and GitHub Actions integration.\n+\n+**When enabled**:\n+- Automated workflow triggers\n+- Build pipeline integration\n+- GitHub Actions event handlers\n+\n+**Usage**:\n+```bash\n+# Enable CI/CD features\n+FEATURE_CICD=1 npm run build\n+```\n+\n+**Code gating**:\n+```typescript\n+if (__CICD__) {\n+  setupGitHubActionsIntegration();\n+}\n+```\n+\n+### `__STRICT_NIP29__`\n+\n+**Type**: Feature  \n+**Default**: Disabled  \n+**Control**: `FEATURE_STRICT_NIP29` environment variable\n+\n+Enables strict validation for NIP-29 group/room specifications.\n+\n+**When enabled**:\n+- Stricter conversation thread validation\n+- Enhanced group membership checks\n+- Stricter relay requirement enforcement\n+\n+**Usage**:\n+```bash\n+# Enable strict NIP-29 validation\n+FEATURE_STRICT_NIP29=1 npm run build\n+```\n+\n+**Code gating**:\n+```typescript\n+const isStrictRelay = __STRICT_NIP29__ \u0026\u0026 \n+  error.includes(\"missing group (`h`) tag\");\n+```\n+\n+## Build Configuration\n+\n+Feature flags are defined in multiple build configuration files:\n+\n+### Main Application (Vite)\n+\n+**File**: `vite.config.ts`\n+\n+```typescript\n+export default defineConfig({\n+  define: {\n+    __PRODUCTION__: JSON.stringify(process.env.NODE_ENV === \"production\"),\n+    __DEVELOPMENT__: JSON.stringify(process.env.NODE_ENV !== \"production\"),\n+    __GRASP__: JSON.stringify(process.env.FEATURE_GRASP !== \"0\"),\n+    __NIP34_PR__: JSON.stringify(process.env.FEATURE_NIP34_PR === \"1\"),\n+    __CICD__: JSON.stringify(process.env.FEATURE_CICD === \"1\"),\n+    __TERMINAL__: JSON.stringify(process.env.FEATURE_TERMINAL !== \"0\"),\n+    __STRICT_NIP29__: JSON.stringify(process.env.FEATURE_STRICT_NIP29 === \"1\"),\n+  }\n+});\n+```\n+\n+### Browser Extension (esbuild)\n+\n+**File**: `packages/nostr-git/packages/extension/esbuild.config.js`\n+\n+```javascript\n+define: {\n+  __PRODUCTION__: JSON.stringify(isProd),\n+  __DEVELOPMENT__: JSON.stringify(!isProd),\n+  __GRASP__: JSON.stringify(process.env.FEATURE_GRASP !== \"0\"),\n+  // ... other flags\n+}\n+```\n+\n+### Git Worker (Vite)\n+\n+**File**: `packages/nostr-git/packages/git-worker/vite.config.ts`\n+\n+Same as main application configuration.\n+\n+## TypeScript Support\n+\n+Feature flag type declarations are provided in `feature-flags.d.ts`:\n+\n+```typescript\n+declare const __PRODUCTION__: boolean;\n+declare const __DEVELOPMENT__: boolean;\n+declare const __GRASP__: boolean;\n+declare const __NIP34_PR__: boolean;\n+declare const __CICD__: boolean;\n+declare const __TERMINAL__: boolean;\n+declare const __STRICT_NIP29__: boolean;\n+```\n+\n+## Best Practices\n+\n+### 1. Use build-time checks, not runtime\n+\n+✅ **Good** - Tree-shakeable:\n+```typescript\n+if (__GRASP__) {\n+  import('./grasp-api.js');\n+}\n+```\n+\n+❌ **Bad** - Not tree-shakeable:\n+```typescript\n+if (process.env.FEATURE_GRASP === '1') {\n+  import('./grasp-api.js');\n+}\n+```\n+\n+### 2. Gate entire code blocks\n+\n+✅ **Good**:\n+```typescript\n+if (__TERMINAL__) {\n+  function setupTerminal() {\n+    // All terminal code here\n+  }\n+  setupTerminal();\n+}\n+```\n+\n+❌ **Bad**:\n+```typescript\n+function setupTerminal() {\n+  if (__TERMINAL__) {\n+    // Mixed gating reduces tree-shaking effectiveness\n+  }\n+}\n+```\n+\n+### 3. Keep exports unconditional\n+\n+✅ **Good** - TypeScript compatible:\n+```typescript\n+export { Terminal } from './Terminal.svelte';\n+// Usage site gates access\n+```\n+\n+❌ **Bad** - TypeScript error:\n+```typescript\n+if (__TERMINAL__) {\n+  export { Terminal } from './Terminal.svelte';\n+}\n+```\n+\n+### 4. Gate at consumption point\n+\n+For components, gate usage in parent components:\n+\n+```svelte\n+\u003cscript\u003e\n+  import { Terminal } from '@nostr-git/ui';\n+\u003c/script\u003e\n+\n+{#if __TERMINAL__}\n+  \u003cTerminal /\u003e\n+{/if}\n+```\n+\n+## Verification\n+\n+To verify tree-shaking is working:\n+\n+```bash\n+# Build with feature disabled\n+FEATURE_GRASP=0 npm run build\n+\n+# Check bundle size\n+ls -lh dist/assets/*.js\n+\n+# Search for feature-specific code (should find nothing)\n+grep -r \"GraspApi\" dist/\n+```\n+\n+## Migration Guide\n+\n+When adding new feature flags:\n+\n+1. **Add to build configs**: Update all three config files (main, extension, worker)\n+2. **Add TypeScript declarations**: Update all `feature-flags.d.ts` files\n+3. **Document**: Add to this file and `.env.example`\n+4. **Gate code**: Wrap feature code in `if (__FLAG__)` blocks\n+5. **Test**: Build with flag disabled and verify tree-shaking\n+\n+## Bundle Size Impact\n+\n+Approximate bundle size savings when features are disabled:\n+\n+| Feature | Size Reduction |\n+|---------|----------------|\n+| `__GRASP__` | ~50KB |\n+| `__TERMINAL__` | ~150KB |\n+| `__NIP34_PR__` | ~5KB |\n+| `__CICD__` | ~10KB |\n+| `__STRICT_NIP29__` | ~2KB |\n+\n+**Total potential savings**: ~217KB when all optional features are disabled.\ndiff --git a/src/app/core/state.ts b/src/app/core/state.ts\nindex ebfef1a..ff771e4 100644\n--- a/src/app/core/state.ts\n+++ b/src/app/core/state.ts\n@@ -834,9 +834,9 @@ export const deriveRelayAuthError = (url: string, claim = \"\") =\u003e {\n       if (error) {\n         const isIgnored = error.startsWith(\"mute: \")\n         const isEmptyInvite = !claim \u0026\u0026 error.includes(\"invite code\")\n-        const isStrictNip29Relay = error.includes(\"missing group (`h`) tag\")\n+        const isStrictNip29Relay = __STRICT_NIP29__ \u0026\u0026 error.includes(\"missing group (`h`) tag\")\n \n-        if (!isStrictNip29Relay \u0026\u0026 !isIgnored \u0026\u0026 !isEmptyInvite \u0026\u0026 !isStrictNip29Relay) {\n+        if (!isStrictNip29Relay \u0026\u0026 !isIgnored \u0026\u0026 !isEmptyInvite) {\n           return stripPrefix(error) || \"join request rejected\"\n         }\n       }\ndiff --git a/src/feature-flags.d.ts b/src/feature-flags.d.ts\nnew file mode 100644\nindex 0000000..64f1a01\n--- /dev/null\n+++ b/src/feature-flags.d.ts\n@@ -0,0 +1,7 @@\n+declare const __PRODUCTION__: boolean;\n+declare const __DEVELOPMENT__: boolean;\n+declare const __GRASP__: boolean;\n+declare const __NIP34_PR__: boolean;\n+declare const __CICD__: boolean;\n+declare const __TERMINAL__: boolean;\n+declare const __STRICT_NIP29__: boolean;\ndiff --git a/vite.config.ts b/vite.config.ts\nindex 41945e0..954a558 100644\n--- a/vite.config.ts\n+++ b/vite.config.ts\n@@ -22,6 +22,15 @@ export default defineConfig({\n   build: {\n     sourcemap: true,\n   },\n+  define: {\n+    __PRODUCTION__: JSON.stringify(process.env.NODE_ENV === \"production\"),\n+    __DEVELOPMENT__: JSON.stringify(process.env.NODE_ENV !== \"production\"),\n+    __GRASP__: JSON.stringify(process.env.FEATURE_GRASP !== \"0\"),\n+    __NIP34_PR__: JSON.stringify(process.env.FEATURE_NIP34_PR === \"1\"),\n+    __CICD__: JSON.stringify(process.env.FEATURE_CICD === \"1\"),\n+    __TERMINAL__: JSON.stringify(process.env.FEATURE_TERMINAL !== \"0\"),\n+    __STRICT_NIP29__: JSON.stringify(process.env.FEATURE_STRICT_NIP29 === \"1\"),\n+  },\n   optimizeDeps: {\n     exclude: [\n       \"svelte-codemirror-editor\",\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-0cuez44u","title":"Forks: fork fails in case of forking repos of others","description":"https://i.nostr.build/kH3OwhSA20Jge0K6.png\n\nGithub says something about 'Repo not found' and returns 404. We might be misusing github api to create the repo.\n'Owner: unknown' is suspicious in particular, see screenshot","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","create_repo","issue"]}
{"id":"flotilla-0eq936xj","title":"Cannot Change patch status","description":"Need to be able to change patch statuses manually","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue"]}
{"id":"flotilla-0fxu36b4","title":"From f35e50d99dee83509262edb82a09e8d3bcae40cf Mon Sep 17 00:00:00 2001","description":"From f35e50d99dee83509262edb82a09e8d3bcae40cf Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 23 Nov 2025 17:38:44 +0500\nSubject: [PATCH 5/6] chore: update nostr-git submodule and add pubkey validation to GitItem\n\nProblem:\n- GitItem component could display invalid maintainer pubkeys\n- No validation of pubkeys before using them for display\n- Could cause rendering issues with malformed pubkey data\n- Forking was adding git username as maintainer which was causing rendering issues\n\nSolution:\n- Add pubkey validation consistent with nostr-git submodule changes\n- Filter invalid maintainers before selecting display pubkey\n- Ensure only valid 64-character hex pubkeys are used\n---\n packages/nostr-git                |  2 +-\n src/app/components/GitItem.svelte | 21 +++++++++++++++++----\n 2 files changed, 18 insertions(+), 5 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex d33ae61..181d6ed 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit d33ae613e5257534ae198a5369efb481306dac13\n+Subproject commit 181d6ed732987ebf719f88b87d6d9dd8b619679c\ndiff --git a/src/app/components/GitItem.svelte b/src/app/components/GitItem.svelte\nindex 5e824ed..8d99a97 100644\n--- a/src/app/components/GitItem.svelte\n+++ b/src/app/components/GitItem.svelte\n@@ -20,13 +20,26 @@\n \n   const name = event.tags.find(nthEq(0, \"name\"))?.[1]\n   const description = event.tags.find(nthEq(0, \"description\"))?.[1]\n-  \n+\n+  // Validate that a string is a valid hex pubkey (exactly 64 hex characters)\n+  const isValidPubkey = (pubkey: string | undefined | null): boolean =\u003e {\n+    if (!pubkey || typeof pubkey !== 'string') return false;\n+    return /^[0-9a-f]{64}$/i.test(pubkey);\n+  }\n+\n   // Get maintainers from the event, or fall back to the event author\n   const maintainersTag = event.tags.find(nthEq(0, \"maintainers\"))\n-  const maintainers = maintainersTag ? maintainersTag.slice(1) : [event.pubkey]\n+  const maintainers = maintainersTag \n+    ? maintainersTag.slice(1).filter((pk: string) =\u003e isValidPubkey(pk))\n+    : []\n+  \n+  // Use first valid maintainer, or fall back to event author if valid\n+  const displayPubkey = maintainers.length \u003e 0 \u0026\u0026 isValidPubkey(maintainers[0])\n+    ? maintainers[0]\n+    : event.pubkey\n   \n-  // Create a modified event with the first maintainer as the pubkey for display\n-  const displayEvent = {...event, pubkey: maintainers[0]}\n+  // Create a modified event with the validated pubkey for display\n+  const displayEvent = displayPubkey ? {...event, pubkey: displayPubkey} : event\n \u003c/script\u003e\n \n \u003cNoteCard event={displayEvent} class=\"card2 sm:card2-sm bg-alt\"\u003e\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-0ivt9fy6","title":"From fedb941b0696e3c1966b1642ebaba4b3c47331e2 Mon Sep 17 00:00:00 2001","description":"From fedb941b0696e3c1966b1642ebaba4b3c47331e2 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 17 Jun 2025 22:19:10 -0700\nSubject: [PATCH 1/8] feat: redesign repository overview with commits tab and enhanced UI\n\n---\n package.json                                                  |   2 ++\n packages/nostr-git                                            |   2 +-\n pnpm-lock.yaml                                                | Bin 489191 -\u003e 493808 bytes\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte       |   6 +++---\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte         | 509 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------------------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte | 175 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte |   2 +-\n 7 files changed, 558 insertions(+), 138 deletions(-)\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n\ndiff --git a/package.json b/package.json\nindex 914d04b..2c3ce67 100644\n--- a/package.json\n+++ b/package.json\n@@ -19,6 +19,7 @@\n     \"@sentry/cli\": \"^2.40.0\",\n     \"@sveltejs/kit\": \"^2.5.27\",\n     \"@sveltejs/vite-plugin-svelte\": \"^4.0.0\",\n+    \"@types/date-fns\": \"^2.6.3\",\n     \"@types/eslint\": \"^9.6.0\",\n     \"@types/markdown-it\": \"^14.1.2\",\n     \"@types/mustache\": \"^4.2.6\",\n@@ -74,6 +75,7 @@\n     \"@welshman/store\": \"^0.3.0\",\n     \"@welshman/util\": \"^0.3.0\",\n     \"daisyui\": \"^4.12.10\",\n+    \"date-fns\": \"^4.1.0\",\n     \"date-picker-svelte\": \"^2.13.0\",\n     \"dotenv\": \"^16.4.5\",\n     \"emoji-picker-element\": \"^1.22.8\",\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 7e69223..7de4657 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 7e692237ea99cdee33f895a360cb21f01bedd795\n+Subproject commit 7de4657fbc68b8b40b27d76ec1817d74ca2b0cef\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 98c9f2d7721d576eca6647bc5cc4d3bb6323f110..631349f86ab93a3c03b145720f5b6f247ca0e940 100644\nGIT binary patch\ndelta 3672\nzc$~#oTZr4}6~^g!rkys~gr\u003c{ZlT5T-(p;3WBunyT(uMK;BH5NLOS1j2RF-5*wl20V\nzw(Mm)1j\u003ef?Ww#hs\u003e|6U%=)x{3S#Y7H(3i4(=zAYZ\u003eAtjuZXw%;K9o`_du~bAvy@\u0026a\nzSQvB;|M|}O\u0026-uQiKm7UnlkaXnf-lUbiLXBfFBCU6MBbKmI{NIv%}Z;qhC`9rgWZck\nz|38F2?p)r!d\u0026wF}s_!8fqNFLNX_z~bsMyAg\u0026t5u%gk}`+l}ktn3n8~pJoX|XIE38s\nzK6)#-_4r%K*Wb8$Y=U^lHUvW(sFE%Den`v\u003c+zZ^^r}Ft^BWq}kg{QM%+)h\u003cW5MywW\nzMir}Jm`aw*a*gNW6hYM)I2~0By;\u003eK|s4idB\u003etjoWjJ#5dqa58xCrzm@8%!=m+1*!O\nzd3|#e0B-G_V1xYN8n26%A3PR9ZtePZ0GPci-PkA89NTm{`BHW2w#90ttdNsjHO+9a\nzVw+@ZJVaAMGwKdT@fKOj52yVkZP=0_B=dGDWi+EuO2J%tN}F|~Ad%f@*3CQocohbf\nz*SikiT^0a20x|oc1nlE|8eyW6R\u003e`q3Y~-du(@EMB++w;y8n\u0026f~IB^D(8k-AGdAcXp\nz)1@d%$}GXy\u003e{uDnQlvW8GDZTUQwkGH5L9;JXbG;m5`\u0026`K%NpQ^H83U1nEm#zSNAPc\nzM+wEsM@1JMS%#D=xmLTD=n@iEK}Ky;Cz2^ui^nMj?r^T=S}tzZ!c=Ei?G|h\u003eTq+fl\nz`L\u003cHT%}zlio1J95Tpn48RTwOZHwD\u003e8f%|nhf-\u00262CYkQy2IBAg1M0$)!M)a7FNDK\u003eu\nznnqH|7TzLsMaaaA90OTs)l9I3GzhaYnKh@3Bd|n1hr=iiCFx0D\u0026bVn3YG_e0Z_CPR\nz3^u\u003e)L_8EeDTMd\u0026{lK;TEIYKQp-piF%aW)_(e5NR\u0026Sas9R\u003e(N)G\u003ecFK%C?!V={5#M\nzhR#\u003cxt~JGqrMfY6YOdZNgJ^`T^IEEv3o8yErtBfySqWmKNMj!Z8vPWAW+RP~Vz)YQ\nzs}|mqE0tC_Ut{ZFt%t`e80`qrZkQoQEwHJ?q*PxK`ewg{7qgC$maQ;dN3?PQpVC\u0026j\nz*{z}F9FJ8Pv#l?\u003e^6}q3d`\u0026tlO{IgGF!Vjdd+?pW-TiUY=m{~YmmHemT86SXx7agF\nzSt|ietaK_{Na?X@rc#S*=5ShZ!n`II\u003eP?4C$M|lf(dxjdY$I*T#Bdx1Z7wD\u003eB9Stm\nzK1o|$hLn}Atoo0=hlIk%bGYb1uL1_H`Z\u003cVBAFGuibn38`XmJP+a%2%5PV|Axu$CMx\nzw3\u00269U7mI-o8%_-9gdXX0-7xQ\u003cO0f;XEhX9~\u003e|v)\u003c$k5%gP-}24PNSa(p_+bl%=_K_\nz!0qP1feECSDu{X\u00263G-Z;Pp}N$o+{C#h\u003eUTph-OmVM48f\u003eq+KN_IG^l=g$#rXMlv0V\nzl\u003cElVw(Ww$m{Ge6({kGy^\u003ciz9wFg0gt+$0\u003eaQ^L3Ko4BwO{J$p9Yq\u0026+1l6%@$=qq1\nz65scszz0xNSdPV-aw|I_#6}@o?$F#|(xdHkFP9\u0026;ASS99ZGk|9YBe3Rq@GnNi\u0026eYM\nzG9WT$%LtVmV=$#C`6Mz*;B=I\u0026cd7~%Uy$Ma2^8QTe(`|ut-S@?fAXu_`-Ft3\u003c8WC)\nzY-n6!4ALgD8eLA2##E\u003e$#mGo24YL#`*QO0U;?rK)jz`;6q5-\u003ej6A}\u003cSO\u003c`!C7\u003ezk(\nzBKRP25JP)xby@4hor==HlmtJfxC_)}#RB{v4_LO-2JFc|vVfK-`PEQt#n3~*p\u0026VJj\nzz%)jR=$jSW0*tY~bOugbt$ToF029LjL\u003c7(b8_*?51ngx1-5+XImBi3IJr7)QK7TZ4\nz-Z#`Wuvv`tK)nT~L{2M6*+Q\u003c7$+okUJy4pwkS(Qav7DMG(845NEtXO|TkGW9c)1Sd\nzU1c;vgg(hpqq5i\u003c\u003eSEi3qADw!9f%$+%Ip0aTfgr8@{fTV4`=tz%xCvLC;ug=8R8!1\nz4YtnQX^izWlAo|cpDYStP$F8OWFXAAD|c)vGI6r9lpGEvu+60mJK0Nx38bmpQn5hR\nzN)}3\u0026FcyMEGQ%NsDjY3w6g~m9vF4BR{K@v(qxCO8FVTK;d*|OdbBCcuC=M\u002680XLyU\nzt6qmD;R?wcx-3\u003cPiLr{qd9kAm_;7KAv|y}GQ+S_ZCT\u003e-)^@grg\u003cD%(Cr4hIAvWOsd\nzUQDWSrAbe{?`wgVfRmWJz^e\u003c{hnIH_00(Qsu6OQX;96kQ\u003cJI-8hwt57o4\u003cE6_|vnW\nzxeq+52e0q1l*?PYz=2\u003eM#`rXkFFkxFU*)ji*rk2Jvd0eUQv~Q+7i5HPZeBTcY4AP~\nzgD\u003es\u003eU%\u003e\u0026urBk*E4}O2`tNZ_\u003exX\u00267o`TNj*l6LZlTbCB\u003e_*l!HsM3x\u003c4!eNAF8Z%e\nz-$=X*AFN%E|J!+ZKl*t6;)|y*8(!k#`u6?*;DVL`uAI6_crSdgcH_Qw8qqK70\u003cS2*\nz@fNT=;PPqk7SUfk|9m;U-~4I)`s^Pcg5KZ7;Ffpp_Qs9*FVG+eLC;A1;wt@vUOQck\nzz3;uhcH?WOwcc~mxd3``mG6=2z4P*C\u003eD^-8@v(TmE?u6#D+IT{dG;xB@=x\u0026_;pz)V\nznsAUQJpai@!I$aHldlbr|M~j%vy|~PtsG2dEEHLFuSb);bc(H\u003e-hXMt_ZRJZcnZFf\nz1D5@Fc!|h=gC=|r!BBm=7Yuzg|2?)oe)6TI+${RRudC\u003cl0^oT+Ub{Gd\u003cL1WC*6yrO\nrh*Lh@ez3D~_xw}bzI^Syd2eIOgF_o%@Dz3ZoagiT#=LQN\u003c4y9PSs|Bh\n\ndelta 162\nzc%1t%QSSL$*$oDQ)2}Bp@ougYv|!\u0026P$*;A!(Ydy5`aCCAjmf)w\u003cu^|{r\u003c*!my_l7M\nz`y^AwV#evqidhA\u003e?=olfY~L\u003c(fRU%PeU~ZI_FbmT^FD2Vsll?8ZTihxHs1Eh1}xhr\nz8?f%--3~OULmzCw^v6Z4Gq(fv\u003e(@;OYUSRp@`;r@c)PC~Tm6UWK)s^df0(gfVgVbl\nKJ\u003c5iCnhyYL1wVKI\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 62bb304..e1ffa14 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -80,9 +80,9 @@\n           {/snippet}\n         \u003c/RepoTab\u003e\n         \u003cRepoTab\n-          tabValue=\"workbench\"\n-          label=\"Workbench\"\n-          href={`/spaces/${encodedRelay}/git/${id}/workbench`}\n+          tabValue=\"commits\"\n+          label=\"Commits\"\n+          href={`/spaces/${encodedRelay}/git/${id}/commits`}\n           {activeTab}\u003e\n           {#snippet icon()}\n             \u003cGitBranch class=\"h-4 w-4\" /\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 109772e..b08d99e 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -2,36 +2,75 @@\n   import {getContext} from \"svelte\"\n   import markdownit from \"markdown-it\"\n   import {Card, Repo} from \"@nostr-git/ui\"\n-  import {CircleAlert, GitBranch, GitPullRequest, Users} from \"@lucide/svelte\"\n+  import {\n+    CircleAlert,\n+    GitBranch,\n+    GitPullRequest,\n+    Users,\n+    Calendar,\n+    Globe,\n+    Hash,\n+    GitCommit,\n+    Clock,\n+    User,\n+    Link,\n+    Eye,\n+    BookOpen,\n+  } from \"@lucide/svelte\"\n   import {fly} from \"@lib/transition\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n-    import { pushToast } from \"@src/app/toast\"\n+  import {pushToast} from \"@src/app/toast\"\n+  import {formatDistanceToNow} from \"date-fns\"\n+  import {nthEq} from \"@welshman/lib\"\n \n   let loading = $state(true)\n+  let lastCommit = $state\u003cany\u003e(null)\n \n   const repoClass = getContext\u003cRepo\u003e(\"repoClass\")\n \n-  const stats = [\n+  const stats = $derived([\n     {\n       label: \"Branches\",\n-      value: () =\u003e repoClass.branches?.length,\n+      value: repoClass.branches?.length || 0,\n       icon: GitBranch,\n+      color: \"text-blue-600\",\n     },\n     {\n-      label: \"Contributors\",\n-      value: () =\u003e repoClass.maintainers?.length,\n+      label: \"Doers\",\n+      value: repoClass.maintainers?.length || 0,\n       icon: Users,\n+      color: \"text-green-600\",\n     },\n     {\n       label: \"Issues\",\n-      value: () =\u003e repoClass.issues?.length,\n-      icon: CircleAlert},\n+      value: repoClass.issues?.length || 0,\n+      icon: CircleAlert,\n+      color: \"text-red-600\",\n+    },\n     {\n       label: \"Patches\",\n-      value: () =\u003e repoClass.patches?.length,\n+      value: repoClass.patches?.length || 0,\n       icon: GitPullRequest,\n+      color: \"text-purple-600\",\n     },\n-  ]\n+  ])\n+\n+  const repoMetadata = $derived({\n+    name: repoClass.repo?.name || \"Unknown Repository\",\n+    description: repoClass.repo?.description || \"\",\n+    repoId: repoClass.repo?.repoId || \"\",\n+    maintainers: repoClass.maintainers || [],\n+    relays: repoClass.relays || [],\n+    cloneUrls: repoClass.repo?.clone || [],\n+    webUrls: repoClass.repo?.web || [],\n+    mainBranch: repoClass.mainBranch || \"main\",\n+    createdAt: repoClass.repoEvent?.created_at\n+      ? new Date(repoClass.repoEvent.created_at * 1000)\n+      : null,\n+    updatedAt: repoClass.repoStateEvent?.created_at\n+      ? new Date(repoClass.repoStateEvent.created_at * 1000)\n+      : null,\n+  })\n \n   let readme = $state\u003cstring | undefined\u003e(undefined)\n   let renderedReadme = $state\u003cstring | undefined\u003e(undefined)\n@@ -43,136 +82,340 @@\n \n   $effect(() =\u003e {\n     if (repoClass.repoEvent) {\n-      repoClass\n-        .getFileContent({\n-          path: \"README.md\",\n-        })\n-        .then(content =\u003e {\n-          readme = content\n-          renderedReadme = readme ? md.render(readme) : \"\"\n-          loading = false\n-        })\n-        .catch((e) =\u003e {\n-          console.error(e)\n-          pushToast({message: \"Failed to load README.md: \" + e, theme: \"error\"})\n-          loading = false\n-        })\n+      loadRepoInfo()\n     }\n   })\n+\n+  async function loadRepoInfo() {\n+    try {\n+      try {\n+        const readmeContent = await repoClass.getFileContent({path: \"README.md\"})\n+        readme = readmeContent\n+        renderedReadme = readme ? md.render(readme) : \"\"\n+      } catch (e) {\n+        console.log(\"No README.md found\")\n+      }\n+\n+      try {\n+        if (repoClass.mainBranch) {\n+          const commits = await repoClass.getCommitHistory({\n+            branch: repoClass.mainBranch,\n+            depth: 1,\n+          })\n+          if (commits \u0026\u0026 commits.length \u003e 0) {\n+            lastCommit = commits[0]\n+          }\n+        }\n+      } catch (e) {\n+        console.log(\"Could not fetch commit info:\", e)\n+      }\n+\n+      loading = false\n+    } catch (e) {\n+      console.error(\"Error loading repo info:\", e)\n+      pushToast({message: \"Failed to load repository information: \" + e, theme: \"error\"})\n+      loading = false\n+    }\n+  }\n+\n+  function formatDate(date: Date | null) {\n+    if (!date) return \"Unknown\"\n+    return formatDistanceToNow(date, {addSuffix: true})\n+  }\n+\n+  function truncateHash(hash: string, length = 8) {\n+    return hash ? hash.substring(0, length) : \"\"\n+  }\n \u003c/script\u003e\n \n-\u003cdiv class=\"relative flex flex-col gap-3 px-2\"\u003e\n-  \u003cdiv class=\"grid grid-cols-4 gap-4\"\u003e\n-    {#each stats as stat}\n-      \u003cCard class=\"p-4\"\u003e\n-        \u003cdiv class=\"flex items-center gap-2\"\u003e\n-          \u003cstat.icon class=\"h-5 text-muted-foreground\" /\u003e\n-          \u003cdiv\u003e\n-            \u003cp class=\"text-sm text-muted-foreground\"\u003e{stat.label}\u003c/p\u003e\n-            \u003cp class=\"text-2xl font-semibold\"\u003e{stat.value()}\u003c/p\u003e\n+\u003cdiv class=\"relative flex flex-col gap-6 py-2\"\u003e\n+  {#if loading}\n+    \u003cdiv class=\"flex justify-center py-8\"\u003e\n+      \u003cSpinner /\u003e\n+    \u003c/div\u003e\n+  {:else}\n+    \u003c!-- Stats Grid --\u003e\n+    \u003cdiv class=\"grid grid-cols-2 gap-4 md:grid-cols-4\"\u003e\n+      {#each stats as stat}\n+        \u003cCard class=\"p-4 transition-shadow hover:shadow-md\"\u003e\n+          \u003cdiv class=\"flex items-center gap-3\"\u003e\n+            \u003cdiv class=\"p-2\"\u003e\n+              \u003cstat.icon class=\"h-5 w-5 {stat.color}\" /\u003e\n+            \u003c/div\u003e\n+            \u003cdiv\u003e\n+              \u003cp class=\"text-sm text-muted-foreground\"\u003e{stat.label}\u003c/p\u003e\n+              \u003cp class=\"text-2xl font-semibold\"\u003e{stat.value}\u003c/p\u003e\n+            \u003c/div\u003e\n+          \u003c/div\u003e\n+        \u003c/Card\u003e\n+      {/each}\n+    \u003c/div\u003e\n+\n+    \u003cdiv class=\"grid gap-6 md:grid-cols-2\"\u003e\n+    \u003c!-- Repository Details --\u003e\n+    \u003cCard class=\"p-6\"\u003e\n+      \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+        \u003cGitCommit class=\"h-5 w-5\" /\u003e\n+        Repo Information\n+      \u003c/h3\u003e\n+      \u003cdiv class=\"grid gap-6 md:grid-cols-1\"\u003e\n+        \u003c!-- Git Information --\u003e\n+        \u003cdiv class=\"space-y-3\"\u003e\n+          \u003cdiv class=\"flex items-center justify-between\"\u003e\n+            \u003cspan class=\"text-sm text-muted-foreground\"\u003eDefault Branch\u003c/span\u003e\n+            \u003cspan class=\"rounded px-2 py-1 font-mono text-sm\"\u003e\n+              {repoMetadata.mainBranch}\n+            \u003c/span\u003e\n           \u003c/div\u003e\n+\n+          {#if lastCommit}\n+            \u003cdiv class=\"border-t pt-3\"\u003e\n+              \u003cdiv class=\"mb-2 flex items-start justify-between\"\u003e\n+                \u003cspan class=\"text-sm text-muted-foreground\"\u003eLatest Commit\u003c/span\u003e\n+                \u003cspan class=\"rounded px-2 py-1 font-mono text-xs\"\u003e\n+                  {truncateHash(lastCommit.oid)}\n+                \u003c/span\u003e\n+              \u003c/div\u003e\n+              \u003cp class=\"text-sm\"\u003e{lastCommit.commit.message}\u003c/p\u003e\n+              \u003cdiv class=\"mt-2 flex items-center gap-2 text-xs text-muted-foreground\"\u003e\n+                \u003cUser class=\"h-3 w-3\" /\u003e\n+                \u003cspan\u003e{lastCommit.commit.author.name}\u003c/span\u003e\n+                \u003cspan\u003e•\u003c/span\u003e\n+                \u003cspan\u003e{formatDate(new Date(lastCommit.commit.author.timestamp * 1000))}\u003c/span\u003e\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          {#if repoClass.branches \u0026\u0026 repoClass.branches.length \u003e 0}\n+            \u003cdiv class=\"border-t pt-3\"\u003e\n+              \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eBranches\u003c/span\u003e\n+              \u003cdiv class=\"flex flex-wrap gap-1\"\u003e\n+                {#each repoClass.branches.slice(0, 5) as branch}\n+                  \u003cspan\n+                    class=\"rounded-full bg-blue-100 px-2 py-1 text-xs text-blue-800 dark:bg-blue-900/30 dark:text-blue-200\"\u003e\n+                    {branch.name}\n+                    {#if branch.isHead}\n+                      \u003cspan class=\"ml-1\"\u003e•\u003c/span\u003e\n+                    {/if}\n+                  \u003c/span\u003e\n+                {/each}\n+                {#if repoClass.branches.length \u003e 5}\n+                  \u003cspan class=\"px-2 py-1 text-xs text-muted-foreground\"\u003e\n+                    +{repoClass.branches.length - 5} more\n+                  \u003c/span\u003e\n+                {/if}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+        \u003c/div\u003e\n+\n+        \u003c!-- Nostr Information --\u003e\n+        \u003cdiv class=\"space-y-3\"\u003e\n+          {#if repoMetadata.maintainers.length \u003e 0}\n+            \u003cdiv\u003e\n+              \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eMaintainers\u003c/span\u003e\n+              \u003cdiv class=\"space-y-1\"\u003e\n+                {#each repoMetadata.maintainers as maintainer}\n+                  \u003cdiv class=\"flex items-center gap-2 text-sm\"\u003e\n+                    \u003cUser class=\"h-3 w-3\" /\u003e\n+                    \u003cspan class=\"font-mono text-xs\"\u003e{truncateHash(maintainer, 16)}\u003c/span\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          {#if repoMetadata.relays.length \u003e 0}\n+            \u003cdiv class=\"border-t pt-3\"\u003e\n+              \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eRelays\u003c/span\u003e\n+              \u003cdiv class=\"space-y-1\"\u003e\n+                {#each repoMetadata.relays.slice(0, 3) as relay}\n+                  \u003cdiv class=\"flex items-center gap-2 text-sm\"\u003e\n+                    \u003cGlobe class=\"h-3 w-3\" /\u003e\n+                    \u003cspan class=\"truncate\"\u003e{relay}\u003c/span\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+                {#if repoMetadata.relays.length \u003e 3}\n+                  \u003cspan class=\"text-xs text-muted-foreground\"\u003e\n+                    +{repoMetadata.relays.length - 3} more relays\n+                  \u003c/span\u003e\n+                {/if}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          {#if repoMetadata.cloneUrls.length \u003e 0}\n+            \u003cdiv class=\"border-t pt-3\"\u003e\n+              \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eClone URLs\u003c/span\u003e\n+              \u003cdiv class=\"space-y-1\"\u003e\n+                {#each repoMetadata.cloneUrls as url}\n+                  \u003cdiv class=\"flex items-center gap-2 text-sm\"\u003e\n+                    \u003cLink class=\"h-3 w-3\" /\u003e\n+                    \u003cspan class=\"truncate font-mono text-xs\"\u003e{url}\u003c/span\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    \u003c/Card\u003e\n+\n+    \u003c!-- Activity Overview --\u003e\n+    {#if repoClass.issues.length \u003e 0 || repoClass.patches.length \u003e 0}\n+      \u003cCard class=\"p-6\"\u003e\n+        \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+          \u003cEye class=\"h-5 w-5\" /\u003e\n+          Recent Activity\n+        \u003c/h3\u003e\n+        \u003cdiv class=\"space-y-4\"\u003e\n+          {#if repoClass.issues.length \u003e 0}\n+            \u003cdiv\u003e\n+              \u003ch4 class=\"mb-2 text-sm font-medium text-muted-foreground\"\u003eRecent Issues\u003c/h4\u003e\n+              \u003cdiv class=\"space-y-2\"\u003e\n+                {#each repoClass.issues.slice(0, 3) as issue}\n+                  \u003cdiv class=\"flex items-start gap-3 rounded-lg p-3 outline outline-1 outline-gray-200\"\u003e\n+                    \u003cCircleAlert class=\"mt-0.5 h-4 w-4 text-red-500\" /\u003e\n+                    \u003cdiv class=\"min-w-0 flex-1\"\u003e\n+                      \u003cp class=\"truncate text-sm font-medium\"\u003e\n+                        {issue.tags.find(nthEq(0, \"t\"))?.[1] || \"Untitled Issue\"}\n+                      \u003c/p\u003e\n+                      \u003cp class=\"text-xs text-muted-foreground\"\u003e\n+                        {formatDate(new Date(issue.created_at * 1000))}\n+                      \u003c/p\u003e\n+                    \u003c/div\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          {#if repoClass.patches.length \u003e 0}\n+            \u003cdiv\u003e\n+              \u003ch4 class=\"mb-2 text-sm font-medium text-muted-foreground\"\u003eRecent Patches\u003c/h4\u003e\n+              \u003cdiv class=\"space-y-2\"\u003e\n+                {#each repoClass.patches.slice(0, 3) as patch}\n+                  \u003cdiv class=\"flex items-start gap-3 rounded-lg p-3 outline outline-1 outline-gray-200\"\u003e\n+                    \u003cGitPullRequest class=\"mt-0.5 h-4 w-4 text-purple-500\" /\u003e\n+                    \u003cdiv class=\"min-w-0 flex-1\"\u003e\n+                      \u003cp class=\"truncate text-sm font-medium\"\u003e\n+                        {patch.tags.find(nthEq(0, \"title\"))?.[1] || \"Untitled Patch\"}\n+                      \u003c/p\u003e\n+                      \u003cp class=\"text-xs text-muted-foreground\"\u003e\n+                        {formatDate(new Date(patch.created_at * 1000))}\n+                      \u003c/p\u003e\n+                    \u003c/div\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n         \u003c/div\u003e\n       \u003c/Card\u003e\n-    {/each}\n-  \u003c/div\u003e\n-  {#if renderedReadme}\n-    \u003cdiv class=\"prose max-w-2xl bg-white dark:bg-zinc-900\" in:fly\u003e\n-      {@html renderedReadme}\n-      \u003cstyle\u003e\n-        .prose {\n-          color: theme(\"colors.zinc.50\");\n-          background: none;\n-        }\n-        .dark .prose {\n-          color: theme(\"colors.white\");\n-        }\n-        .prose h1,\n-        .prose h2,\n-        .prose h3 {\n-          font-weight: 600;\n-          line-height: 1.25;\n-          color: theme(\"colors.zinc.50\");\n-          margin-top: 2rem;\n-          margin-bottom: 1rem;\n-        }\n-        .prose h1 {\n-          font-size: 2rem;\n-          border-bottom: 1px solid theme(\"colors.zinc.50\");\n-          padding-bottom: 0.3em;\n-        }\n-        .prose h2 {\n-          font-size: 1.5rem;\n-          border-bottom: 1px solid theme(\"colors.zinc.50\");\n-          padding-bottom: 0.2em;\n-        }\n-        .prose h3 {\n-          font-size: 1.25rem;\n-          padding-bottom: 0.1em;\n-        }\n-        .prose ul,\n-        .prose ol {\n-          margin: 1em 0;\n-          padding-left: 2em;\n-        }\n-        .prose li {\n-          margin: 0.3em 0;\n-        }\n-        .prose a {\n-          color: theme(\"colors.accent\");\n-          text-decoration: underline;\n-          text-underline-offset: 2px;\n-          transition: color 0.2s;\n-        }\n-        .prose a:hover {\n-          color: theme(\"colors.primary\");\n-        }\n-        .prose code {\n-          background: theme(\"colors.zinc.700\");\n-          color: theme(\"colors.zinc.100\");\n-          border-radius: 4px;\n-          padding: 0.2em 0.4em;\n-          font-size: 0.95em;\n-        }\n-        .prose pre {\n-          background: theme(\"colors.zinc.900\");\n-          color: theme(\"colors.zinc.100\");\n-          border-radius: 8px;\n-          padding: 1em;\n-          margin: 1.5em 0;\n-          font-size: 1em;\n-          overflow-x: auto;\n-        }\n-        .prose blockquote {\n-          border-left: 4px solid theme(\"colors.zinc.300\");\n-          background: theme(\"colors.zinc.50\");\n-          color: theme(\"colors.zinc.600\");\n-          padding: 1em 1.5em;\n-          border-radius: 0.5em;\n-          margin: 1.5em 0;\n-          font-style: italic;\n-        }\n-        .prose table {\n-          width: 100%;\n-          border-collapse: collapse;\n-          margin-bottom: 1.5em;\n-          background: theme(\"colors.zinc.50\");\n-          border-radius: 0.5em;\n-          overflow: hidden;\n-        }\n-        .prose th,\n-        .prose td {\n-          border: 1px solid theme(\"colors.zinc.200\");\n-          padding: 0.6em 1em;\n-        }\n-        .prose th {\n-          background: theme(\"colors.zinc.100\");\n-          font-weight: 600;\n-        }\n-      \u003c/style\u003e\n+    {/if}\n     \u003c/div\u003e\n-  {:else if loading}\n-    \u003cSpinner {loading}\u003eLoading README.md...\u003c/Spinner\u003e\n-  {:else}\n-    \u003cdiv class=\"text-muted-foreground\"\u003eNo README.md found.\u003c/div\u003e\n+    \u003c!-- README --\u003e\n+    {#if renderedReadme}\n+      \u003cCard class=\"p-6\"\u003e\n+        \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+          \u003cBookOpen class=\"h-5 w-5\" /\u003e\n+          README\n+        \u003c/h3\u003e\n+        \u003cdiv class=\"prose max-w-2xl bg-white dark:bg-zinc-900\" in:fly\u003e\n+          {@html renderedReadme}\n+          \u003cstyle\u003e\n+            .prose {\n+              color: theme(\"colors.zinc.50\");\n+              background: none;\n+            }\n+            .dark .prose {\n+              color: theme(\"colors.white\");\n+            }\n+            .prose h1,\n+            .prose h2,\n+            .prose h3 {\n+              font-weight: 600;\n+              line-height: 1.25;\n+              color: theme(\"colors.zinc.50\");\n+              margin-top: 2rem;\n+              margin-bottom: 1rem;\n+            }\n+            .prose h1 {\n+              font-size: 2rem;\n+              border-bottom: 1px solid theme(\"colors.zinc.50\");\n+              padding-bottom: 0.3em;\n+            }\n+            .prose h2 {\n+              font-size: 1.5rem;\n+              border-bottom: 1px solid theme(\"colors.zinc.50\");\n+              padding-bottom: 0.2em;\n+            }\n+            .prose h3 {\n+              font-size: 1.25rem;\n+              padding-bottom: 0.1em;\n+            }\n+            .prose ul,\n+            .prose ol {\n+              margin: 1em 0;\n+              padding-left: 2em;\n+            }\n+            .prose li {\n+              margin: 0.3em 0;\n+            }\n+            .prose a {\n+              color: theme(\"colors.accent\");\n+              text-decoration: underline;\n+              text-underline-offset: 2px;\n+              transition: color 0.2s;\n+            }\n+            .prose a:hover {\n+              color: theme(\"colors.primary\");\n+            }\n+            .prose code {\n+              background: theme(\"colors.zinc.700\");\n+              color: theme(\"colors.zinc.100\");\n+              border-radius: 4px;\n+              padding: 0.2em 0.4em;\n+              font-size: 0.95em;\n+            }\n+            .prose pre {\n+              background: theme(\"colors.zinc.900\");\n+              color: theme(\"colors.zinc.100\");\n+              border-radius: 8px;\n+              padding: 1em;\n+              margin: 1.5em 0;\n+              font-size: 1em;\n+              overflow-x: auto;\n+            }\n+            .prose blockquote {\n+              border-left: 4px solid theme(\"colors.zinc.300\");\n+              background: theme(\"colors.zinc.50\");\n+              color: theme(\"colors.zinc.600\");\n+              padding: 1em 1.5em;\n+              border-radius: 0.5em;\n+              margin: 1.5em 0;\n+              font-style: italic;\n+            }\n+            .prose table {\n+              width: 100%;\n+              border-collapse: collapse;\n+              margin-bottom: 1.5em;\n+              background: theme(\"colors.zinc.50\");\n+              border-radius: 0.5em;\n+              overflow: hidden;\n+            }\n+            .prose th,\n+            .prose td {\n+              border: 1px solid theme(\"colors.zinc.200\");\n+              padding: 0.6em 1em;\n+            }\n+            .prose th {\n+              background: theme(\"colors.zinc.100\");\n+              font-weight: 600;\n+            }\n+          \u003c/style\u003e\n+        \u003c/div\u003e\n+      \u003c/Card\u003e\n+    {/if}\n   {/if}\n \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\nnew file mode 100644\nindex 0000000..afb0e08\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n@@ -0,0 +1,175 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {GitBranch, Funnel, User, Search} from \"@lucide/svelte\"\n+  import {\n+    Button,\n+    Input,\n+    Select,\n+    SelectContent,\n+    SelectTrigger,\n+    SelectItem,\n+    Separator,\n+    CommitCard,\n+  } from \"@nostr-git/ui\"\n+  import {formatDistanceToNow} from \"date-fns\"\n+  import Spinner from \"@src/lib/components/Spinner.svelte\"\n+\n+  let {data} = $props()\n+  const {repoClass} = data\n+\n+  // Reactive state for UI\n+  let searchQuery = $state(\"\")\n+  let selectedBranch = $state([repoClass.mainBranch.split(\"/\").pop() || \"\"])\n+  let selectedAuthor = $state([])\n+\n+  // Get commits from the repo class (lazy-loaded and reactive)\n+  let commitsLoading = $state(true)\n+  let commitsError = $state\u003cstring | undefined\u003e(undefined)\n+  let commits = $state\u003cany[]\u003e([])\n+  // Get available branches for filtering\n+  let branches = $state\u003cstring[]\u003e([])\n+\n+  // Get unique authors from commits for filtering\n+  let authors = $state\u003cSet\u003cstring\u003e\u003e(new Set())\n+\n+  $effect(() =\u003e {\n+    if (repoClass.commits) {\n+      commits = repoClass.commits\n+    }\n+  })\n+\n+  $effect(() =\u003e {\n+    if (repoClass.branches) {\n+      branches = repoClass.branches.map((branch: any) =\u003e branch.name.split(\"/\").pop())\n+    }\n+  })\n+\n+  $effect(() =\u003e {\n+    if (repoClass.commits \u0026\u0026 repoClass.commits.length \u003e 0) {\n+      authors = new Set(repoClass.commits.map((commit: any) =\u003e commit.commit.author.name))\n+      commitsLoading = false\n+    }\n+  })\n+\n+  // Filter commits based on search and filters\n+  const filteredCommits = $derived.by(() =\u003e {\n+    if (commits) {\n+      let filtered = commits\n+\n+      // Filter by search query\n+      if (searchQuery.trim()) {\n+        const query = searchQuery.toLowerCase()\n+        filtered = filtered.filter(\n+          commit =\u003e\n+            commit.commit.message.toLowerCase().includes(query) ||\n+            commit.commit.author.name.toLowerCase().includes(query) ||\n+            commit.oid.toLowerCase().includes(query),\n+        )\n+      }\n+\n+      // Filter by branch (if branch filtering is implemented)\n+      if (selectedBranch.length \u003e 0) {\n+        //filtered = filtered.filter(commit =\u003e commit.branch === selectedBranch[0])\n+      }\n+\n+      // Filter by author\n+      if (selectedAuthor.length \u003e 0) {\n+        filtered = filtered.filter(commit =\u003e commit.commit.author.name === selectedAuthor[0])\n+      }\n+\n+      return filtered\n+    }\n+    return []\n+  })\n+\n+  const handleReact = (commitId: string, type: \"heart\") =\u003e {\n+    console.log(`Reacting to commit ${commitId} with ${type}`)\n+  }\n+\n+  const handleComment = (commitId: string, comment: string) =\u003e {\n+    console.log(`Commenting on commit ${commitId}: ${comment}`)\n+    // TODO: Implement Nostr comments for commits\n+  }\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"flex flex-col gap-6\"\u003e\n+  {#if commitsLoading}\n+    \u003cdiv class=\"flex items-center justify-center py-12\"\u003e\n+      \u003cSpinner loading={commitsLoading}\u003e\n+        Loading commits...\n+      \u003c/Spinner\u003e\n+    \u003c/div\u003e\n+  {:else if commitsError}\n+    \u003cdiv class=\"py-12 text-center\"\u003e\n+      \u003cp class=\"text-muted-foreground\"\u003eFailed to load commits.\u003c/p\u003e\n+    \u003c/div\u003e\n+  {:else}\n+    \u003cdiv class=\"mt-6\"\u003e\n+      \u003cdiv class=\"mb-6 flex flex-col gap-4 rounded-lg border border-border bg-card p-4 sm:flex-row\"\u003e\n+        \u003cdiv class=\"flex-1\"\u003e\n+          \u003cdiv class=\"relative\"\u003e\n+            \u003cSearch\n+              class=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 transform text-muted-foreground\" /\u003e\n+            \u003cInput placeholder=\"Search commits...\" bind:value={searchQuery} class=\"pl-10\" /\u003e\n+          \u003c/div\u003e\n+        \u003c/div\u003e\n+\n+        \u003cSelect bind:value={selectedBranch}\u003e\n+          \u003cSelectTrigger class=\"w-[140px]\"\u003e\n+            \u003cGitBranch class=\"mr-2 h-4 w-4\" /\u003e\n+            \u003cspan\u003e{selectedBranch}\u003c/span\u003e\n+          \u003c/SelectTrigger\u003e\n+          \u003cSelectContent\u003e\n+            {#each branches as branch (branch)}\n+              \u003cSelectItem value={branch}\u003e\n+                {branch}\n+              \u003c/SelectItem\u003e\n+            {/each}\n+          \u003c/SelectContent\u003e\n+        \u003c/Select\u003e\n+\n+        \u003cSelect bind:value={selectedAuthor}\u003e\n+          \u003cSelectTrigger class=\"w-[120px]\"\u003e\n+            \u003cUser class=\"mr-2 h-4 w-4\" /\u003e\n+            \u003cspan\u003e{selectedAuthor.length \u003e 0 ? selectedAuthor[0] : \"All authors\"}\u003c/span\u003e\n+          \u003c/SelectTrigger\u003e\n+          \u003cSelectContent\u003e\n+            {#each authors as author (author)}\n+              \u003cSelectItem value={author}\u003e\n+                {author}\n+              \u003c/SelectItem\u003e\n+            {/each}\n+          \u003c/SelectContent\u003e\n+        \u003c/Select\u003e\n+      \u003c/div\u003e\n+\n+      \u003cdiv class=\"space-y-4\"\u003e\n+        \u003cdiv class=\"flex items-center justify-between\"\u003e\n+          \u003ch2 class=\"text-lg font-semibold\"\u003e\n+            {filteredCommits?.length} commit{filteredCommits?.length !== 1 ? \"s\" : \"\"}\n+            {#if selectedBranch.length \u003e 0}\n+              on {selectedBranch[0]}{/if}\n+          \u003c/h2\u003e\n+\n+          \u003cButton variant=\"outline\" size=\"sm\" class=\"gap-2\"\u003e\n+            \u003cFunnel class=\"h-4 w-4\" /\u003e\n+            More filters\n+          \u003c/Button\u003e\n+        \u003c/div\u003e\n+\n+        \u003cSeparator /\u003e\n+\n+        {#if !repoClass.commits || repoClass.commits.length === 0}\n+          \u003cdiv class=\"py-12 text-center\"\u003e\n+            \u003cp class=\"text-muted-foreground\"\u003eNo commits found in this repository.\u003c/p\u003e\n+          \u003c/div\u003e\n+        {:else}\n+          \u003cdiv class=\"space-y-3\"\u003e\n+            {#each filteredCommits as commit (commit.oid)}\n+              \u003cCommitCard {commit} onReact={handleReact} onComment={handleComment} /\u003e\n+            {/each}\n+          \u003c/div\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  {/if}\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 9c706dc..1359cba 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -1,5 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {Button, IssueCard, PatchCard, Repo} from \"@nostr-git/ui\"\n+  import {Button, PatchCard, Repo} from \"@nostr-git/ui\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Address, type TrustedEvent} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-0lxhl3uy","title":"From d7bb12360cd08749fb9ac8169877dc7226324a25 Mon Sep 17 00:00:00 2001","description":"From d7bb12360cd08749fb9ac8169877dc7226324a25 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Fri, 4 Jul 2025 18:00:22 -0700\nSubject: [PATCH 2/2] feat: improve event kind labels and remove debug logging\n\n---\n src/app/state.ts                                           |  1 -\n src/lib/unknown-kinds.ts                                   | 16 ++++++++--------\n src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte |  3 +--\n 3 files changed, 9 insertions(+), 11 deletions(-)\n\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 34c93e9..9e4d2ae 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -613,7 +613,6 @@ export const channels = derived(\n           const id = makeChannelId(url, room)\n \n           if (!$channels.some(c =\u003e c.id === id)) {\n-            console.log(\"adding channel\", event)\n             $channels.push({\n               id,\n               url,\ndiff --git a/src/lib/unknown-kinds.ts b/src/lib/unknown-kinds.ts\nindex c0f9210..5f1748e 100644\n--- a/src/lib/unknown-kinds.ts\n+++ b/src/lib/unknown-kinds.ts\n@@ -8,16 +8,16 @@ const DEFAULT_TEMPLATES: Record\u003cnumber, string\u003e = {\n   7: \"{{pubkey}} reacts to {{tags.e}} by {{tags.p}}{{#content}} with {{content}}{{/content}}\",\n   10002: \"canonical relays list for {{pubkey}}\",\n \n-  1111: \"{{content}}\",\n+  1111: \"{{#nevent}}{{tags.E}}{{/nevent}}\\n{{content}}\",\n   30617: \"Git repository {{tags.name}} hosted at {{{tags.clone}}} by {{#npub}}{{pubkey}}{{/npub}}\",\n   30618: \"## Git repository state {{tags.d}} hosted at {{tags.clone}} by {{#npub}}{{pubkey}}{{/npub}}\",\n-  1617: \"```\\n{{{content}}}\\n```\",\n-  1621: \"{{#tags.subject}}Subject{{tags.subject}}\\n{{/tags.subject}}{{content}} {{#npub}}{{tags.p}}{{/npub}}\",\n-  1623: \"```\\n{{{content}}}\\n```\",\n-  1630: \"Status: Open {{#nevent}}{{tags.e}}{{/nevent}}\",\n-  1631: \"Patch Applied\",\n-  1632: \"Closed\",\n-  1633: \"Draft\",\n+  1617: \"Patch\",\n+  1621: \"Issue: {{tags.subject}}\\n{{content}}\",\n+  1623: \"```\\n{{content}}\\n```\",\n+  1630: \"Status changed to Open {{#nevent}}{{tags.e}}{{/nevent}}\",\n+  1631: \"Patch applied: {{#nevent}}{{tags.e}}{{/nevent}}\",\n+  1632: \"Status changed to Closed {{#nevent}}{{tags.e}}{{/nevent}}\",\n+  1633: \"Status changed to Draft {{#nevent}}{{tags.e}}{{/nevent}}\",\n \n   31922: \"{{tags.title}} happening at {{tags.start}}\",\n }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte\nindex 3148a7a..a366ad4 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte\n@@ -273,7 +273,7 @@\n       ...repoClass.patches.filter(p =\u003e p.tags.some(t =\u003e t[0] === \"t\" \u0026\u0026 t[1] === \"root\")),\n     )\n \n-initialEvents.sort((a, b) =\u003e b.created_at - a.created_at)\n+    initialEvents.sort((a, b) =\u003e b.created_at - a.created_at)\n \n     const feed = makeFeed({\n       element: element!,\n@@ -336,7 +336,6 @@ initialEvents.sort((a, b) =\u003e b.created_at - a.created_at)\n   })\n \u003c/script\u003e\n \n-\n \u003cdiv bind:this={element} onscroll={onScroll} class=\"flex flex-col-reverse pt-4\"\u003e\n   \u003cdiv bind:this={dynamicPadding}\u003e\u003c/div\u003e\n   {#if $channel?.private \u0026\u0026 $membershipStatus !== MembershipStatus.Granted}\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-0wqt5zro","title":"From c94f5a455030905d808cae883871ea6dbdc10f88 Mon Sep 17 00:00:00 2001","description":"From c94f5a455030905d808cae883871ea6dbdc10f88 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Thu, 5 Jun 2025 08:54:09 -0700\nSubject: [PATCH 23/67] Move relay status to its own component\n\n---\n src/app/components/SpaceRelayStatus.svelte | 70 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/+page.svelte     | 59 ++---------------------------------------------------------\n 2 files changed, 72 insertions(+), 57 deletions(-)\n create mode 100644 src/app/components/SpaceRelayStatus.svelte\n\ndiff --git a/src/app/components/SpaceRelayStatus.svelte b/src/app/components/SpaceRelayStatus.svelte\nnew file mode 100644\nindex 0000000..f29235d\n--- /dev/null\n+++ b/src/app/components/SpaceRelayStatus.svelte\n@@ -0,0 +1,70 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {deriveRelay} from \"@welshman/app\"\n+  import Icon from \"@lib/components/Icon.svelte\"\n+  import SocketStatusIndicator from \"@lib/components/SocketStatusIndicator.svelte\"\n+  import ProfileLink from \"@app/components/ProfileLink.svelte\"\n+\n+  interface Props {\n+    url: string\n+  }\n+\n+  const {url}: Props = $props()\n+\n+  const relay = deriveRelay(url)\n+  const owner = $derived($relay?.profile?.pubkey)\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"card2 bg-alt\"\u003e\n+  \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+    \u003cIcon icon=\"server\" /\u003e\n+    Relay Status\n+  \u003c/h3\u003e\n+  \u003cdiv class=\"flex flex-col gap-3\"\u003e\n+    \u003cSocketStatusIndicator {url} /\u003e\n+    {#if $relay?.profile}\n+      {@const {software, version, supported_nips, limitation} = $relay.profile}\n+      \u003cdiv class=\"flex flex-wrap gap-1\"\u003e\n+        {#if owner}\n+          \u003cdiv class=\"badge badge-neutral\"\u003e\n+            \u003cspan class=\"ellipsize\"\u003eAdministrator: \u003cProfileLink unstyled pubkey={owner} /\u003e\u003c/span\u003e\n+          \u003c/div\u003e\n+        {/if}\n+        {#if $relay?.profile?.contact}\n+          \u003cdiv class=\"badge badge-neutral\"\u003e\n+            \u003cspan class=\"ellipsize\"\u003eContact: {$relay.profile.contact}\u003c/span\u003e\n+          \u003c/div\u003e\n+        {/if}\n+        {#if software}\n+          \u003cdiv class=\"badge badge-neutral\"\u003e\n+            \u003cspan class=\"ellipsize\"\u003eSoftware: {software}\u003c/span\u003e\n+          \u003c/div\u003e\n+        {/if}\n+        {#if version}\n+          \u003cdiv class=\"badge badge-neutral\"\u003e\n+            \u003cspan class=\"ellipsize\"\u003eVersion: {version}\u003c/span\u003e\n+          \u003c/div\u003e\n+        {/if}\n+        {#if Array.isArray(supported_nips)}\n+          \u003cp class=\"badge badge-neutral\"\u003e\n+            \u003cspan class=\"ellipsize\"\u003eSupported NIPs: {supported_nips.join(\", \")}\u003c/span\u003e\n+          \u003c/p\u003e\n+        {/if}\n+        {#if limitation?.auth_required}\n+          \u003cp class=\"badge badge-warning\"\u003e\n+            \u003cspan class=\"ellipsize\"\u003eAuth Required\u003c/span\u003e\n+          \u003c/p\u003e\n+        {/if}\n+        {#if limitation?.payment_required}\n+          \u003cp class=\"badge badge-warning\"\u003e\n+            \u003cspan class=\"ellipsize\"\u003ePayment Required\u003c/span\u003e\n+          \u003c/p\u003e\n+        {/if}\n+        {#if limitation?.min_pow_difficulty}\n+          \u003cp class=\"badge badge-warning\"\u003e\n+            \u003cspan class=\"ellipsize\"\u003eMin PoW: {limitation?.min_pow_difficulty}\u003c/span\u003e\n+          \u003c/p\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    {/if}\n+  \u003c/div\u003e\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/+page.svelte b/src/routes/spaces/[relay]/+page.svelte\nindex 6d24186..648060e 100644\n--- a/src/routes/spaces/[relay]/+page.svelte\n+++ b/src/routes/spaces/[relay]/+page.svelte\n@@ -7,8 +7,6 @@\n   import Button from \"@lib/components/Button.svelte\"\n   import PageBar from \"@lib/components/PageBar.svelte\"\n   import PageContent from \"@lib/components/PageContent.svelte\"\n-  import SocketStatusIndicator from \"@lib/components/SocketStatusIndicator.svelte\"\n-  import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n   import ProfileLatest from \"@app/components/ProfileLatest.svelte\"\n   import SpaceJoin from \"@app/components/SpaceJoin.svelte\"\n@@ -16,6 +14,7 @@\n   import RelayDescription from \"@app/components/RelayDescription.svelte\"\n   import SpaceQuickLinks from \"@app/components/SpaceQuickLinks.svelte\"\n   import SpaceRecentActivity from \"@app/components/SpaceRecentActivity.svelte\"\n+  import SpaceRelayStatus from \"@app/components/SpaceRelayStatus.svelte\"\n   import {decodeRelay, userRoomsByUrl} from \"@app/state\"\n   import {\n     makeChatPath,\n@@ -157,61 +156,7 @@\n       \u003c/div\u003e\n     \u003c/div\u003e\n     \u003cdiv class=\"flex flex-col gap-2\"\u003e\n-      \u003cdiv class=\"card2 bg-alt\"\u003e\n-        \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n-          \u003cIcon icon=\"server\" /\u003e\n-          Relay Status\n-        \u003c/h3\u003e\n-        \u003cdiv class=\"flex flex-col gap-3\"\u003e\n-          \u003cSocketStatusIndicator {url} /\u003e\n-          {#if $relay?.profile}\n-            {@const {software, version, supported_nips, limitation} = $relay.profile}\n-            \u003cdiv class=\"flex flex-wrap gap-1\"\u003e\n-              {#if owner}\n-                \u003cdiv class=\"badge badge-neutral\"\u003e\n-                  \u003cspan class=\"ellipsize\"\n-                    \u003eAdministrator: \u003cProfileLink unstyled pubkey={owner} /\u003e\u003c/span\u003e\n-                \u003c/div\u003e\n-              {/if}\n-              {#if $relay?.profile?.contact}\n-                \u003cdiv class=\"badge badge-neutral\"\u003e\n-                  \u003cspan class=\"ellipsize\"\u003eContact: {$relay.profile.contact}\u003c/span\u003e\n-                \u003c/div\u003e\n-              {/if}\n-              {#if software}\n-                \u003cdiv class=\"badge badge-neutral\"\u003e\n-                  \u003cspan class=\"ellipsize\"\u003eSoftware: {software}\u003c/span\u003e\n-                \u003c/div\u003e\n-              {/if}\n-              {#if version}\n-                \u003cdiv class=\"badge badge-neutral\"\u003e\n-                  \u003cspan class=\"ellipsize\"\u003eVersion: {version}\u003c/span\u003e\n-                \u003c/div\u003e\n-              {/if}\n-              {#if Array.isArray(supported_nips)}\n-                \u003cp class=\"badge badge-neutral\"\u003e\n-                  \u003cspan class=\"ellipsize\"\u003eSupported NIPs: {supported_nips.join(\", \")}\u003c/span\u003e\n-                \u003c/p\u003e\n-              {/if}\n-              {#if limitation?.auth_required}\n-                \u003cp class=\"badge badge-warning\"\u003e\n-                  \u003cspan class=\"ellipsize\"\u003eAuth Required\u003c/span\u003e\n-                \u003c/p\u003e\n-              {/if}\n-              {#if limitation?.payment_required}\n-                \u003cp class=\"badge badge-warning\"\u003e\n-                  \u003cspan class=\"ellipsize\"\u003ePayment Required\u003c/span\u003e\n-                \u003c/p\u003e\n-              {/if}\n-              {#if limitation?.min_pow_difficulty}\n-                \u003cp class=\"badge badge-warning\"\u003e\n-                  \u003cspan class=\"ellipsize\"\u003eMin PoW: {limitation?.min_pow_difficulty}\u003c/span\u003e\n-                \u003c/p\u003e\n-              {/if}\n-            \u003c/div\u003e\n-          {/if}\n-        \u003c/div\u003e\n-      \u003c/div\u003e\n+      \u003cSpaceRelayStatus {url} /\u003e\n       {#if owner}\n         \u003cdiv class=\"card2 bg-alt\"\u003e\n           \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-0wznh5y9","title":"From d2b678d3782eed033822d36263e837bdeac35301 Mon Sep 17 00:00:00 2001","description":"From d2b678d3782eed033822d36263e837bdeac35301 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Thu, 5 Jun 2025 09:19:25 -0700\nSubject: [PATCH 25/67] Add claude context file and mock up recent activity\n\n---\n CLAUDE.md                                     | 121 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/app/components/SpaceRecentActivity.svelte | 132 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++------------------------\n 2 files changed, 229 insertions(+), 24 deletions(-)\n create mode 100644 CLAUDE.md\n\ndiff --git a/CLAUDE.md b/CLAUDE.md\nnew file mode 100644\nindex 0000000..682c0d2\n--- /dev/null\n+++ b/CLAUDE.md\n@@ -0,0 +1,121 @@\n+# CLAUDE.md\n+\n+This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n+\n+## Project Overview\n+\n+Flotilla is a Discord-like Nostr client that operates on the concept of \"relays as groups/spaces.\" Built with SvelteKit 2.5 and Svelte 5, it provides messaging, threads, calendar events, and social features across Nostr relays.\n+\n+## Development Commands\n+\n+```bash\n+# Development\n+pnpm run dev          # Start dev server on port 1847\n+pnpm run check        # TypeScript checking\n+pnpm run check:watch  # Watch mode TypeScript checking\n+\n+# Production\n+pnpm run build        # Custom build with env processing\n+./build.sh            # Main build script with PWA assets\n+pnpm run sourcemaps   # Build with sourcemap upload\n+\n+# Code Quality\n+pnpm run lint         # ESLint + Prettier checking\n+pnpm run format       # Auto-format with Prettier\n+\n+# Mobile\n+pnpm run release:android  # Android APK build\n+npx cap sync             # Sync web assets to native\n+```\n+\n+## Architecture\n+\n+### Core Technology Stack\n+- **SvelteKit 2.5 + Svelte 5** - Reactive UI framework with runes\n+- **Welshman Libraries** - Comprehensive Nostr toolkit (@welshman/app, @welshman/net, @welshman/signer, etc.)\n+- **TailwindCSS + DaisyUI** - Utility-first styling with component library\n+- **Capacitor 7** - Cross-platform mobile deployment\n+- **TypeScript** - Full type safety throughout\n+\n+### Key Directories\n+- `/src/app/state.ts` - Global state management, stores, derived values\n+- `/src/app/components/` - 80+ feature-specific Svelte components\n+- `/src/lib/components/` - Shared/generic UI components\n+- `/src/routes/` - SvelteKit file-based routing with dynamic relay/room routes\n+- `/src/app/commands.ts` - User actions and business logic\n+- `/src/assets/icons/` - 60+ custom SVG icons\n+\n+### State Management Patterns\n+- Svelte stores with Welshman reactive patterns\n+- Repository pattern for Nostr event storage with 10k event limit\n+- Derived stores for computed values and real-time updates\n+- Event-based architecture with reactive data flow\n+\n+### Nostr Integration Architecture\n+- **NIP-29 support** - Group chat functionality via relays\n+- **NIP-46 support** - Remote signing (Nostr Connect/Bunker)\n+- **Event unwrapping** - Handles gift-wrapped messages for privacy\n+- **Real-time relay management** - Automatic connection and authentication\n+- **Web of trust calculations** - User reputation and content filtering\n+\n+### Mobile \u0026 PWA Features\n+- Responsive navigation (drawer on mobile, sidebar on desktop)\n+- Capacitor integration for native mobile apps\n+- PWA with offline support and auto-updating\n+- Safe area handling for iOS/Android\n+\n+## Environment Configuration\n+\n+All environment variables are optional and enable platform customization:\n+\n+```bash\n+# Branding\n+VITE_PLATFORM_NAME=\"Custom Name\"\n+VITE_PLATFORM_LOGO=\"/custom-logo.png\"\n+VITE_PLATFORM_DESCRIPTION=\"Custom description\"\n+\n+# Platform Mode (single-relay instance)\n+VITE_PLATFORM_RELAYS=\"wss://relay.example.com\"\n+\n+# Bootstrap and Discovery\n+VITE_DEFAULT_PUBKEYS=\"npub1...,npub2...\"  # Web of trust seed\n+VITE_INDEXER_RELAYS=\"wss://indexer1.com,wss://indexer2.com\"\n+\n+# Monitoring\n+VITE_GLITCHTIP_API_KEY=\"...\"  # Error reporting\n+```\n+\n+The `build.sh` script processes these variables and generates theme files.\n+\n+## Important Patterns\n+\n+### Component Organization\n+- Components are organized by feature (Chat, Calendar, Profile, Space)\n+- Use existing components from `/lib/components/` before creating new ones\n+- Follow the established naming convention (PascalCase, descriptive names)\n+\n+### Routing Structure\n+- Dynamic routes: `/spaces/[relay]/[room]` for relay-based navigation\n+- All routes use the `+layout.svelte` for app shell and initialization\n+- Route helpers in `/src/app/routes.ts` for URL generation\n+\n+### Nostr Event Handling\n+- Events flow through the repository pattern in `state.ts`\n+- Use Welshman utilities for event validation and parsing\n+- Handle both plain and gift-wrapped events for privacy\n+\n+### Styling Conventions\n+- TailwindCSS with DaisyUI components\n+- Dark/light theme support via CSS custom properties\n+- Responsive design with mobile-first approach\n+- Custom color scheme configurable via environment variables\n+- When styling html, prefer flex/gap classes over margin or space-y classes.\n+\n+## Testing Notes\n+This project does not include formal testing infrastructure. Code quality is maintained through TypeScript strict mode, ESLint, Prettier, and Svelte compiler validation.\n+\n+## Performance Considerations\n+- Event storage is limited to 10k events with ranking system\n+- Components use lazy loading patterns\n+- Large lists should implement virtualization\n+- Image proxy optimization for external content\ndiff --git a/src/app/components/SpaceRecentActivity.svelte b/src/app/components/SpaceRecentActivity.svelte\nindex c5d4641..14b2d0c 100644\n--- a/src/app/components/SpaceRecentActivity.svelte\n+++ b/src/app/components/SpaceRecentActivity.svelte\n@@ -1,7 +1,9 @@\n \u003cscript lang=\"ts\"\u003e\n   import Icon from \"@lib/components/Icon.svelte\"\n-  import ChannelName from \"@app/components/ChannelName.svelte\"\n-  import {makeChannelId, channelsById, deriveUserRooms} from \"@app/state\"\n+  import Button from \"@lib/components/Button.svelte\"\n+  import ProfileCircle from \"@app/components/ProfileCircle.svelte\"\n+  import ProfileCircles from \"@app/components/ProfileCircles.svelte\"\n+  import {formatTimestamp} from \"@welshman/lib\"\n \n   interface Props {\n     url: string\n@@ -9,34 +11,116 @@\n \n   const {url}: Props = $props()\n \n-  const userRooms = deriveUserRooms(url)\n+  // Mock conversation data similar to Slack's threads view\n+  const mockConversations = [\n+    {\n+      id: \"conv1\",\n+      starter: {\n+        pubkey: \"npub1xyz123\",\n+        content:\n+          \"What's everyone's thoughts on the new relay implementation? I'm seeing some interesting performance improvements...\",\n+        timestamp: Date.now() - 3600000, // 1 hour ago\n+      },\n+      room: \"general\",\n+      replyCount: 12,\n+      lastActivity: Date.now() - 900000, // 15 minutes ago\n+      participants: [\"npub1abc\", \"npub1def\", \"npub1ghi\", \"npub1jkl\"],\n+      latestReply: {\n+        pubkey: \"npub1abc\",\n+        content: \"The latency improvements are definitely noticeable in my tests\",\n+      },\n+    },\n+    {\n+      id: \"conv2\",\n+      starter: {\n+        pubkey: \"npub2abc456\",\n+        content:\n+          \"Has anyone tried the new calendar integration? Looking for feedback before we roll it out to more spaces\",\n+        timestamp: Date.now() - 7200000, // 2 hours ago\n+      },\n+      room: \"development\",\n+      replyCount: 8,\n+      lastActivity: Date.now() - 1800000, // 30 minutes ago\n+      participants: [\"npub2def\", \"npub2ghi\", \"npub2jkl\"],\n+      latestReply: {\n+        pubkey: \"npub2def\",\n+        content: \"Works great on mobile, had one small sync issue but figured it out\",\n+      },\n+    },\n+    {\n+      id: \"conv3\",\n+      starter: {\n+        pubkey: \"npub3def789\",\n+        content:\n+          \"Quick question about zap splitting - should we implement this at the relay level or client level?\",\n+        timestamp: Date.now() - 10800000, // 3 hours ago\n+      },\n+      room: \"random\",\n+      replyCount: 5,\n+      lastActivity: Date.now() - 3600000, // 1 hour ago\n+      participants: [\"npub3abc\", \"npub3ghi\"],\n+      latestReply: {\n+        pubkey: \"npub3abc\",\n+        content: \"I think client level makes more sense for privacy\",\n+      },\n+    },\n+  ]\n \u003c/script\u003e\n \n \u003cdiv class=\"card2 bg-alt\"\u003e\n-  \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n-    \u003cIcon icon=\"chat-round\" /\u003e\n-    Recent Activity\n-  \u003c/h3\u003e\n-  \u003cdiv class=\"flex flex-col gap-3\"\u003e\n-    {#if $userRooms.length \u003e 0}\n-      {#each $userRooms.slice(0, 3) as room (room)}\n-        {@const channel = $channelsById.get(makeChannelId(url, room))}\n-        \u003cdiv class=\"flex items-center gap-3 rounded bg-base-100\"\u003e\n-          \u003cdiv class=\"flex items-center gap-2\"\u003e\n-            {#if channel?.closed || channel?.private}\n-              \u003cIcon icon=\"lock\" size={4} /\u003e\n-            {:else}\n-              \u003cIcon icon=\"hashtag\" /\u003e\n+  \u003cdiv class=\"flex flex-col gap-4\"\u003e\n+    \u003ch3 class=\"flex items-center gap-2 text-lg font-semibold\"\u003e\n+      \u003cIcon icon=\"chat-round\" /\u003e\n+      Recent Conversations\n+    \u003c/h3\u003e\n+    \u003cdiv class=\"flex flex-col gap-4\"\u003e\n+      {#each mockConversations as conversation (conversation.id)}\n+        \u003cdiv class=\"card2 bg-alt\"\u003e\n+          \u003cdiv class=\"flex flex-col gap-3\"\u003e\n+            \u003cdiv class=\"flex items-start gap-3\"\u003e\n+              \u003cProfileCircle pubkey={conversation.starter.pubkey} size={10} /\u003e\n+              \u003cdiv class=\"min-w-0 flex-1\"\u003e\n+                \u003cdiv class=\"flex items-center gap-2 text-sm opacity-70\"\u003e\n+                  \u003cspan class=\"font-medium text-blue-400\"\u003e#{conversation.room}\u003c/span\u003e\n+                  \u003cspan class=\"opacity-50\"\u003e•\u003c/span\u003e\n+                  \u003cspan\u003e{formatTimestamp(conversation.starter.timestamp)}\u003c/span\u003e\n+                \u003c/div\u003e\n+                \u003cdiv class=\"flex flex-col gap-2\"\u003e\n+                  \u003cp class=\"text-base leading-relaxed\"\u003e{conversation.starter.content}\u003c/p\u003e\n+                \u003c/div\u003e\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+            \u003cdiv class=\"ml-13 flex items-center justify-between\"\u003e\n+              \u003cdiv class=\"flex items-center gap-4\"\u003e\n+                \u003cspan class=\"flex items-center gap-2 text-sm opacity-70\"\u003e\n+                  \u003cIcon icon=\"alt-arrow-left\" size={4} /\u003e\n+                  {conversation.replyCount} replies\n+                \u003c/span\u003e\n+                \u003cdiv class=\"flex -space-x-2\"\u003e\n+                  \u003cProfileCircles pubkeys={conversation.participants} size={6} /\u003e\n+                \u003c/div\u003e\n+              \u003c/div\u003e\n+              \u003cspan class=\"text-sm opacity-50\"\u003e\n+                {formatTimestamp(conversation.lastActivity)}\n+              \u003c/span\u003e\n+            \u003c/div\u003e\n+            {#if conversation.latestReply}\n+              \u003cdiv class=\"card2 bg-alt\"\u003e\n+                \u003cdiv class=\"flex flex-col gap-2\"\u003e\n+                  \u003cdiv class=\"flex items-center gap-2 text-sm opacity-70\"\u003e\n+                    \u003cProfileCircle pubkey={conversation.latestReply.pubkey} size={5} /\u003e\n+                    \u003cspan class=\"font-medium\"\u003eLatest reply:\u003c/span\u003e\n+                  \u003c/div\u003e\n+                  \u003cp class=\"text-sm leading-relaxed opacity-90\"\u003e\n+                    {conversation.latestReply.content}\n+                  \u003c/p\u003e\n+                \u003c/div\u003e\n+              \u003c/div\u003e\n             {/if}\n-            \u003cspan class=\"font-medium\"\u003e\n-              \u003cChannelName {url} {room} /\u003e\n-            \u003c/span\u003e\n           \u003c/div\u003e\n-          \u003cspan class=\"ml-auto text-sm opacity-60\"\u003eActive conversations\u003c/span\u003e\n         \u003c/div\u003e\n       {/each}\n-    {:else}\n-      \u003cp class=\"text-sm opacity-60\"\u003eNo recent activity\u003c/p\u003e\n-    {/if}\n+      \u003cButton class=\"btn btn-primary btn-sm\"\u003eView all conversations →\u003c/Button\u003e\n+    \u003c/div\u003e\n   \u003c/div\u003e\n \u003c/div\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-0x64z77n","title":"From 43a7e7da5b6e801b1c0940bae23e0a2352934635 Mon Sep 17 00:00:00 2001","description":"From 43a7e7da5b6e801b1c0940bae23e0a2352934635 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Fri, 12 Dec 2025 00:22:57 +0500\nSubject: [PATCH 11/13] Add token-based authentication for git push operations\n\n- Update GitActions component to extract hostname from remote URLs\n- Implement token matching and retry logic for authenticated pushes\n- Support both SSH (git@host) and HTTPS URL formats\n- Fallback to unauthenticated push if no tokens available\n- Update nostr-git submodule reference\n- Update pnpm-lock.yaml with dependency changes\n---\n pnpm-lock.yaml                       | Bin 548939 -\u003e 549005 bytes\n src/app/components/GitActions.svelte | 35 ++++++++++++++++++++++++++++++++++-\n 2 files changed, 34 insertions(+), 1 deletion(-)\n\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex c04570460e0c12b0745e9127f13fe320b55fd887..aa6a9f59ceeb867341b58c9e813399268b8865c0 100644\nGIT binary patch\ndelta 70\nzc$_\u003cZK(Y6r;)WR#?70P{MVV=plP7vgFd9!zG#6nt)-%\u003eKXzrJ2@0VZ%VkRJF24WT\u003c\nRW(8t4AZFj*FTt_L9RPUN7jFOn\n\ndelta 46\ntc%17!sCfE-;)WR#\u00269@}lZ%Hr$F%u9o12GE_vjQ\u003c25VLQ;CBd=T9RS+?69)hQ\n\ndiff --git a/src/app/components/GitActions.svelte b/src/app/components/GitActions.svelte\nindex 4d980a0..a7b278b 100644\n--- a/src/app/components/GitActions.svelte\n+++ b/src/app/components/GitActions.svelte\n@@ -24,6 +24,8 @@\n   import Link from \"@lib/components/Link.svelte\"\n   import { onMount } from \"svelte\"\n   import { parseRepoAnnouncementEvent } from \"@nostr-git/shared-types\"\n+  import {tokens as tokensStore} from \"@nostr-git/ui\"\n+  import {tryTokensForHost, getTokensForHost} from \"@nostr-git/ui\"\n \n   interface Props {\n     url: any\n@@ -195,7 +197,38 @@\n     const remoteUrl = cloneUrls[0]\n     syncing = true\n     try {\n-      await workerApi.pushToRemote({ repoId, remoteUrl })\n+      // Extract hostname for token matching\n+      let hostname: string\n+      try {\n+        // Handle SSH URLs like git@github.com:owner/repo.git\n+        if (remoteUrl.startsWith('git@')) {\n+          const match = remoteUrl.match(/git@([^:]+):/)\n+          hostname = match ? match[1] : ''\n+        } else {\n+          // Handle HTTPS URLs\n+          const urlObj = new URL(remoteUrl)\n+          hostname = urlObj.hostname\n+        }\n+      } catch {\n+        hostname = ''\n+      }\n+      const tokens = await tokensStore.waitForInitialization()\n+      const matchingTokens = getTokensForHost(tokens, hostname)\n+\n+      // Try all tokens for this host until one succeeds, or push without token if none available\n+      if (matchingTokens.length \u003e 0) {\n+        await tryTokensForHost(\n+          tokens,\n+          hostname,\n+          async (token: string, host: string) =\u003e {\n+            return await workerApi.pushToRemote({ repoId, remoteUrl, token })\n+          }\n+        )\n+      } else {\n+        // No tokens available - try pushing without authentication (may fail for private repos)\n+        await workerApi.pushToRemote({ repoId, remoteUrl })\n+      }\n+\n       const syncResult = await workerApi.syncWithRemote({ repoId, cloneUrls })\n       \n       // Handle warnings like CORS issues gracefully\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-0xeowf4i","title":"Issue, Patches page: No sticky behavior, scroll to top button","description":"Sticky search bar is annoying, takes up too much space.\nScroll to top is better overall","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T18:05:14.807558-08:00","closed_at":"2026-01-24T18:05:14.807558-08:00","close_reason":"Verified implemented via codebase triage","labels":["enhancement","good first issue","issue","issues","patches"]}
{"id":"flotilla-0xfilj5i","title":"From 6f7f113b19f6897bd74c27ed6846da05571f83b5 Mon Sep 17 00:00:00 2001","description":"From 6f7f113b19f6897bd74c27ed6846da05571f83b5 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 9 Jun 2025 16:21:22 -0700\nSubject: [PATCH 3/4] implemented git file view and download\n\n---\n .env                                                                    |  2 +-\n package.json                                                            |  3 +--\n packages/nostr-git                                                      |  2 +-\n pnpm-lock.yaml                                                          | Bin 486154 -\u003e 486091 bytes\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |  9 ---------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte                   |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte              | 16 ++++++++++++----\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte |  1 -\n src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte         | 12 +++++-------\n 9 files changed, 21 insertions(+), 26 deletions(-)\n\ndiff --git a/.env b/.env\nindex 059979e..cfc0cb8 100644\n--- a/.env\n+++ b/.env\n@@ -5,7 +5,7 @@ VITE_PLATFORM_TERMS=\n VITE_PLATFORM_PRIVACY=\n VITE_PLATFORM_NAME=Budabit\n VITE_PLATFORM_LOGO=static/budabit.png\n-VITE_PLATFORM_RELAY=wss://budabit.nostr1.com/\n+VITE_PLATFORM_RELAY=ws://192.168.10.149:7000\n VITE_PLATFORM_ACCENT=\"#D4AF37\"\n VITE_PLATFORM_SECONDARY=\"#EB5E28\"\n VITE_PLATFORM_DESCRIPTION=\"The Club for Builders in Freedom Tech.\"\ndiff --git a/package.json b/package.json\nindex 1a2160a..589f8fe 100644\n--- a/package.json\n+++ b/package.json\n@@ -85,8 +85,7 @@\n     \"qrcode\": \"^1.5.4\",\n     \"sharp\": \"^0.34.1\",\n     \"throttle-debounce\": \"^5.0.2\",\n-    \"tippy.js\": \"^6.3.7\",\n-    \"buffer\": \"^6.0.3\"\n+    \"tippy.js\": \"^6.3.7\"\n   },\n   \"pnpm\": {\n     \"ignoredBuiltDependencies\": [\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 89be359..414f02c 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 89be359b3968d98d5a2d426e5c42601602469cf6\n+Subproject commit 414f02c61f2199bea76c7838a156c31d4990e963\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 89e4b99eb14cb5eec9dd5771fe4641bed7455905..6d44bbbcbe8f757c9b51b726cf2d8d3da78a4e61 100644\nGIT binary patch\ndelta 299\nzc%19HCVTp-?1mcxo5clL%$N=Ij3zfqim(D{J;Uh%TI@c}\u0026F\u003c~Z?u\u003capw7uD#dGS+5\nzqv;!6m^8xzw8Kgb3nS91Qd2TBi*h~uosBEJ-5n!Sqe=pj!z|Oy%_6ib(v93)OiCit\nzgUk(6%Y7Y\u003cO(TtqovVziGBW-2Q_54*f(pDM3@V+H)5|jr(\u003c1x=9j6QEvPewdr^_;(\nz(O~*VK_\u003c;mql(-N$25~r\u0026t\u00266(%q;)VWUl~6L!ST\u003e$E1pkf@F_U4__l^BeM!$gKP`K\nzB7@vSM}M=@{Lo;J9An3T+%k`-\u003cVe%xDCbE1q{vdQlr*\u003cQlT`Qo#L0~(WZOULu\u003edja\nh_K$jO^1oS)^vv`Ori*H^n\u003c0E(1`*wUT8rJ@0RRA!VI}|o\n\ndelta 297\nzc$_\u003cZRkrJz?1mcxlTB3ZH{TFoF=I5GY{)3aYN%(RXE0q*i`}Q$#l79doe_wcw!649\nzFMc|Gku0-TXpVW6wtr-ld2Xq(OGsgnkA+20rgxFIXQ98bUvhz~zeSk7e~N)gl3zht\nzwn28Lr(0f%yK8=7T4_~TmPuu4Mo_kgcUDlgr\u003e9Ysws)|RM_NE~aK-csIxOPTYjs\u0026\u003e\nzPIu\u0026G(h4;S4^ApGDa~\u003cptt@r\u0026\u0026d\u003eEP%_}W2Gj*{DjViAw^2iTLi_EKVPY(3U^C-*-\nzb}lf|b~2BwG78tOEb?\u003cHstC$Y@sB8RchNV@cTV\u003cp_jAe%E%Ys%o+!^K-@ZkU1\u0026CR\u003c\ngZ_#6u{mp6\u0026^sdqLYntq42%nchM7Q^7vD-TU0Fwn^r2qf`\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 224fa4b..56d37ff 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -172,15 +172,6 @@\n             \u003cGitPullRequest class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab\n-          tabValue=\"workbench\"\n-          label=\"Workbench\"\n-          href={`/spaces/${encodeddRelay}/git/${id}/workbench`}\n-          {activeTab}\u003e\n-          {#snippet icon()}\n-            \u003cLayers class=\"h-4 w-4\" /\u003e\n-          {/snippet}\n-        \u003c/RepoTab\u003e\n       {/snippet}\n     \u003c/RepoHeader\u003e\n     {@render children()}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 977bd01..6ec39f4 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -14,7 +14,7 @@\n   import {repository} from \"@welshman/app\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {getRootEventTagValue} from \"@src/lib/util\"\n-  import {Card} from \"@nostr-git/ui\"\n+  import {Card, Repo} from \"@nostr-git/ui\"\n   import {CircleAlert, GitBranch, GitPullRequest, Users} from \"@lucide/svelte\"\n   import {\n     parseRepoAnnouncementEvent,\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex 8a30724..89d147d 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -2,9 +2,8 @@\n   import {getContext} from \"svelte\"\n   import {FileView} from \"@nostr-git/ui\"\n   import {GitBranch} from \"@lucide/svelte\"\n-  import {listRepoFilesFromEvent, type FileEntry, listBranchesFromEvent} from \"@nostr-git/core\"\n+  import {listRepoFilesFromEvent, type FileEntry, listBranchesFromEvent, getRepoFileContentFromEvent} from \"@nostr-git/core\"\n   import {\n-    parseRepoAnnouncementEvent,\n     parseRepoStateEvent,\n     type RepoAnnouncementEvent,\n     type RepoStateEvent,\n@@ -27,7 +26,7 @@\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n     patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n   }\u003e(\"repo\")\n-\n+  \n   // UI state\n   let loading = $state(true)\n   let error: string | null = $state(null)\n@@ -79,6 +78,15 @@\n   const openMenu = () =\u003e {\n     showMenu = true\n   }\n+\n+const getFileContent = async (path: string) =\u003e {\n+  return await getRepoFileContentFromEvent({\n+    repoEvent: $repoEvent,\n+    branch: selectedBranchValue?.split(\"/\").pop() || \"master\",\n+    path,\n+  })\n+}\n+\n \u003c/script\u003e\n \n \u003cdiv class=\"rounded-lg border border-border bg-card\"\u003e\n@@ -143,7 +151,7 @@\n               \u003cdiv class=\"text-muted-foreground\"\u003eNo files found in this branch.\u003c/div\u003e\n             {:else}\n               {#each files as file}\n-                \u003cFileView name={file.name} type={file.type} path={file.path} /\u003e\n+                \u003cFileView {file} getFileContent={getFileContent}/\u003e\n               {/each}\n             {/if}\n           {/await}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex eb7014c..b8f52ee 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -12,7 +12,6 @@\n   import {deriveEvents} from \"@welshman/store\"\n   import {load} from \"@welshman/net\"\n   import {COMMENT, GIT_PATCH, type Filter} from \"@welshman/util\"\n-  import {nthEq} from \"@welshman/lib\"\n \n   const repo = getContext\u003c{\n     repo: Readable\u003cTrustedEvent\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\nindex 4b12723..b62575a 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n@@ -17,10 +17,7 @@\n   import {Card, CardContent, CardHeader, CardTitle} from \"@nostr-git/ui\"\n   import {Tabs, TabsContent, TabsList, TabsTrigger} from \"@nostr-git/ui\"\n   import {Badge} from \"@nostr-git/ui\"\n-  import PatchSelector from \"@nostr-git/ui\"\n-  import CommitSelector from \"@nostr-git/ui\"\n-  import MergeAnalyzer from \"@nostr-git/ui\"\n-  import ConflictVisualizer from \"@nostr-git/ui\"\n+  import {PatchSelector, CommitSelector, MergeAnalyzer, ConflictVisualizer} from \"@nostr-git/ui\"\n   import {getContext} from \"svelte\"\n   import type {Readable} from \"svelte/store\"\n   import type {RepoStateEvent} from \"@nostr-git/shared-types\"\n@@ -36,6 +33,7 @@\n     repo: Readable\u003cTrustedEvent\u003e\n     state: () =\u003e Readable\u003cRepoStateEvent\u003e\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n   }\u003e(\"repo\")\n \n   // Simulate merge analysis when both patch and commit are selected\n@@ -87,7 +85,7 @@\n   }\n \u003c/script\u003e\n \n-\u003cdiv class=\"container max-w-7xl py-6\"\u003e\n+\u003cdiv\u003e\n   \u003cdiv class=\"mt-6\"\u003e\n     \u003cdiv class=\"mb-6\"\u003e\n       \u003cdiv class=\"mb-2 flex items-center gap-3\"\u003e\n@@ -104,8 +102,8 @@\n     \u003c/div\u003e\n \n     \u003cdiv class=\"mb-6 grid grid-cols-2 gap-6\"\u003e\n-      \u003cPatchSelector selectedPatch={$selectedPatch} onPatchSelect={setSelectedPatch} /\u003e\n-      \u003cCommitSelector selectedCommit={$selectedCommit} onCommitSelect={setSelectedCommit} /\u003e\n+      \u003cPatchSelector patches={repo.patches()} selectedPatch={$selectedPatch} onPatchSelect={(patch) =\u003e selectedPatch = patch} /\u003e\n+      \u003cCommitSelector commits={[]} selectedCommit={$selectedCommit} onCommitSelect={(commit) =\u003e selectedCommit = commit} /\u003e\n     \u003c/div\u003e\n \n     {#if selectedPatch \u0026\u0026 selectedCommit}\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-0za7cdcn","title":"From 1b5eddf439d788a2094c731d6bda4b93dfbfc1cc Mon Sep 17 00:00:00 2001","description":"From 1b5eddf439d788a2094c731d6bda4b93dfbfc1cc Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Fri, 12 Dec 2025 01:20:47 +0500\nSubject: [PATCH 2/2] chore: update nostr-git submodule\n\nUpdate submodule to include:\n- Improved __GRASP__ undefined checks\n- Component registry updates (AlertDescription, Markdown removal)\n---\n packages/nostr-git | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 7ed3590..80f6507 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 7ed35909df81c287fe7507775b3695e926bf2713\n+Subproject commit 80f6507aef29ac32eaf421aeb039fb34cb5a8167\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-10imd65j","title":"From 9f1abb09e44049ec50b200d1ce2f44fafba39ab3 Mon Sep 17 00:00:00 2001","description":"From 9f1abb09e44049ec50b200d1ce2f44fafba39ab3 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Fri, 9 May 2025 12:55:26 -0700\nSubject: [PATCH 1/3] feat: integrate nostr-git UI components and repository views\n\n---\n package.json                                                  |   4 ++++\n pnpm-workspace.yaml                                           |   5 +++++\n src/app.css                                                   |   3 +++\n src/app/state.ts                                              |  25 +++++++++++++++++++++++++\n src/routes/spaces/[relay]/+layout.svelte                      |   3 ++-\n src/routes/spaces/[relay]/git/+page.svelte                    |  51 +++++++++++++++++++++++++++++----------------------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte       |  51 +++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte         |   2 ++\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte    |  39 +++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte  |  61 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte |  60 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/jobs/+page.svelte                   | 116 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------------------------\n src/routes/spaces/[relay]/jobs/[id]/+page.svelte              | 133 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------------------------------------------------------------\n tailwind.config.js                                            |   4 +++-\n 14 files changed, 420 insertions(+), 137 deletions(-)\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n\ndiff --git a/package.json b/package.json\nindex ac6c4c3..09dc6f4 100644\n--- a/package.json\n+++ b/package.json\n@@ -43,8 +43,12 @@\n     \"@capacitor/cli\": \"^7.0.0\",\n     \"@capacitor/core\": \"^7.0.1\",\n     \"@capacitor/ios\": \"^7.0.0\",\n+    \"@capacitor/keyboard\": \"^7.0.0\",\n+    \"@lucide/svelte\": \"^0.509.0\",\n     \"@noble/curves\": \"^1.5.0\",\n     \"@noble/hashes\": \"^1.4.0\",\n+    \"@nostr-git/shared-types\": \"link:../../../Library/pnpm/global/5/node_modules/@nostr-git/shared-types\",\n+    \"@nostr-git/ui\": \"link:../../../Library/pnpm/global/5/node_modules/@nostr-git/ui\",\n     \"@poppanator/sveltekit-svg\": \"^4.2.1\",\n     \"@sentry/browser\": \"^8.35.0\",\n     \"@sveltejs/adapter-static\": \"^3.0.4\",\ndiff --git a/pnpm-workspace.yaml b/pnpm-workspace.yaml\nindex e6654d6..f8b5454 100644\n--- a/pnpm-workspace.yaml\n+++ b/pnpm-workspace.yaml\n@@ -1,2 +1,7 @@\n onlyBuiltDependencies:\n   - sharp\n+\n+overrides:\n+  ui: link:../../../Library/pnpm/global/5/node_modules/@nostr-git/ui\n+  '@nostr-git/ui': link:../../../Library/pnpm/global/5/node_modules/@nostr-git/ui\n+  '@nostr-git/shared-types': link:../../../Library/pnpm/global/5/node_modules/@nostr-git/shared-types\ndiff --git a/src/app.css b/src/app.css\nindex 89f2953..143d578 100644\n--- a/src/app.css\n+++ b/src/app.css\n@@ -1,3 +1,6 @@\n+@import \"@welshman/editor/index.css\";\n+@import '@nostr-git/ui/index.css';\n+\n @tailwind base;\n @tailwind components;\n @tailwind utilities;\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 456d11c..96716b0 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -66,6 +66,7 @@ import {\n import type {Thunk, Relay} from \"@welshman/app\"\n import type {SubscribeRequestWithHandlers} from \"@welshman/net\"\n import {deriveEvents, deriveEventsMapped, withGetter, synced} from \"@welshman/store\"\n+import type { AddressPointer } from \"nostr-tools/nip19\"\n \n export const ROOM = \"h\"\n \n@@ -237,6 +238,30 @@ export const deriveEvent = (idOrAddress: string, hints: string[] = []) =\u003e {\n   )\n }\n \n+export const deriveNaddrEvent = (naddr: string, hints: string[] = []) =\u003e {\n+  let attempted = false\n+  const decoded = nip19.decode(naddr).data as AddressPointer\n+  const fallbackRelays = [...hints, ...INDEXER_RELAYS]\n+  const relays = decoded.relays?.length \u003e 0 ? decoded.relays : fallbackRelays\n+  const filters = [{\n+    authors: [decoded.pubkey],\n+    kinds: [decoded.kind],\n+    \"#d\": [decoded.identifier],\n+  }]\n+\n+  return derived(\n+    deriveEvents(repository, {filters}),\n+    (events: TrustedEvent[]) =\u003e {\n+      if (!attempted \u0026\u0026 events.length === 0) {\n+        load({relays: relays as string[], filters})\n+        attempted = true\n+      }\n+\n+      return events[0]\n+    },\n+  )\n+}\n+\n export const getUrlsForEvent = derived([trackerStore, thunks], ([$tracker, $thunks]) =\u003e {\n   const getThunksByEventId = memoize(() =\u003e {\n     const thunksByEventId = new Map\u003cstring, Thunk[]\u003e()\ndiff --git a/src/routes/spaces/[relay]/+layout.svelte b/src/routes/spaces/[relay]/+layout.svelte\nindex e2e65c3..40dd071 100644\n--- a/src/routes/spaces/[relay]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/+layout.svelte\n@@ -15,7 +15,7 @@\n   import {decodeRelay, userRoomsByUrl} from \"@app/state\"\n   import {pullConservatively} from \"@app/requests\"\n   import {notifications} from \"@app/notifications\"\n-    import { FREELANCE_JOB } from \"@src/lib/util\"\n+    import { FREELANCE_JOB, GIT_REPO } from \"@src/lib/util\"\n   interface Props {\n     children?: import(\"svelte\").Snippet\n   }\n@@ -64,6 +64,7 @@\n       relays,\n       filters: [\n         {kinds: [GROUP_META]},\n+        {kinds: [GIT_REPO]},\n         {kinds: [THREAD, EVENT_TIME], since},\n         {kinds: [COMMENT], \"#K\": [String(THREAD), String(EVENT_TIME)], since},\n         {kinds: [FREELANCE_JOB], \"#s\": [\"0\"]},\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 9394673..83877b0 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -1,7 +1,13 @@\n \u003cscript lang=\"ts\"\u003e\n   import {onMount} from \"svelte\"\n   import {page} from \"$app/stores\"\n-  import {getPubkeyTagValues, getListTags, Address, NAMED_BOOKMARKS, type TrustedEvent} from \"@welshman/util\"\n+  import {\n+    getPubkeyTagValues,\n+    getListTags,\n+    Address,\n+    NAMED_BOOKMARKS,\n+    type TrustedEvent,\n+  } from \"@welshman/util\"\n   import {GIT_REPO} from \"@src/lib/util\"\n   import {userMutes} from \"@welshman/app\"\n   import {fly} from \"@lib/transition\"\n@@ -19,12 +25,13 @@\n   import {pubkey} from \"@welshman/app\"\n   import {getAddressTags} from \"@welshman/util\"\n   import {Router} from \"@welshman/router\"\n+  import PageContent from \"@src/lib/components/PageContent.svelte\"\n \n   const url = decodeRelay($page.params.relay)\n   const mutedPubkeys = getPubkeyTagValues(getListTags($userMutes))\n   const repos: TrustedEvent[] = $state([])\n   let loading = $state(true)\n-  let loadedBookmarkedRepos: Array\u003c{address: string, event: TrustedEvent, relayHint: string}\u003e = []\n+  let loadedBookmarkedRepos: Array\u003c{address: string; event: TrustedEvent; relayHint: string}\u003e = []\n \n   async function loadBookmarkedRepos() {\n     repos.length = 0\n@@ -76,26 +83,26 @@\n   }\n \u003c/script\u003e\n \n-\u003cdiv class=\"relative flex h-screen flex-col\"\u003e\n-  \u003cPageBar\u003e\n-    {#snippet icon()}\n-      \u003cdiv class=\"center\"\u003e\n+\u003cPageBar\u003e\n+  {#snippet icon()}\n+    \u003cdiv class=\"center\"\u003e\n+      \u003cIcon icon=\"git\" /\u003e\n+    \u003c/div\u003e\n+  {/snippet}\n+  {#snippet title()}\n+    \u003cstrong\u003eFollowed Repos\u003c/strong\u003e\n+  {/snippet}\n+  {#snippet action()}\n+    \u003cdiv class=\"row-2\"\u003e\n+      \u003cButton class=\"btn btn-primary btn-sm\" disabled={loading} onclick={onAddRepo}\u003e\n         \u003cIcon icon=\"git\" /\u003e\n-      \u003c/div\u003e\n-    {/snippet}\n-    {#snippet title()}\n-      \u003cstrong\u003eFollowed Repos\u003c/strong\u003e\n-    {/snippet}\n-    {#snippet action()}\n-      \u003cdiv class=\"row-2\"\u003e\n-        \u003cButton class=\"btn btn-primary btn-sm\" disabled={loading} onclick={onAddRepo}\u003e\n-          \u003cIcon icon=\"git\" /\u003e\n-          \u003cspan\u003eAdd Repo\u003c/span\u003e\n-        \u003c/Button\u003e\n-        \u003cMenuSpaceButton {url} /\u003e\n-      \u003c/div\u003e\n-    {/snippet}\n-  \u003c/PageBar\u003e\n+        \u003cspan\u003eAdd Repo\u003c/span\u003e\n+      \u003c/Button\u003e\n+      \u003cMenuSpaceButton {url} /\u003e\n+    \u003c/div\u003e\n+  {/snippet}\n+\u003c/PageBar\u003e\n+\u003cPageContent\u003e\n   \u003cdiv class=\"flex flex-grow flex-col gap-2 overflow-auto p-2\"\u003e\n     {#if loading || repos.length === 0}\n       \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n@@ -115,4 +122,4 @@\n       {/each}\n     {/if}\n   \u003c/div\u003e\n-\u003c/div\u003e\n+\u003c/PageContent\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nnew file mode 100644\nindex 0000000..63dcb65\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -0,0 +1,51 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {RepoHeader, RepoTab} from \"@nostr-git/ui\"\n+  import {page} from \"$app/stores\"\n+  import {deriveNaddrEvent} from \"@app/state\"\n+  import PageContent from \"@src/lib/components/PageContent.svelte\"\n+  import {FileCode, GitBranch, CircleAlert, GitPullRequest, Book} from \"@lucide/svelte\"\n+  import {type RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n+  const {id, relay} = $page.params\n+  const relayArray = Array.isArray(relay) ? relay : [relay]\n+  const eventStore = deriveNaddrEvent(id, relayArray)\n+  let {children} = $props()\n+\u003c/script\u003e\n+\n+\u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n+  {#if $eventStore === undefined}\n+    \u003cdiv class=\"p-4 text-center\"\u003eLoading repository...\u003c/div\u003e\n+  {:else if !$eventStore}\n+    \u003cdiv class=\"p-4 text-center text-red-500\"\u003eRepository not found.\u003c/div\u003e\n+  {:else}\n+    \u003cRepoHeader event={$eventStore as RepoAnnouncementEvent}\u003e\n+      {#snippet children()}\n+        \u003cRepoTab tabValue=\"overview\" label=\"Overview\" href=\"overview\"\u003e\n+          {#snippet icon()}\n+            \u003cFileCode class=\"h-4 w-4\" /\u003e\n+          {/snippet}\n+        \u003c/RepoTab\u003e\n+        \u003cRepoTab tabValue=\"code\" label=\"Code\" href={`./${id}/code`}\u003e\n+          {#snippet icon()}\n+            \u003cGitBranch class=\"h-4 w-4\" /\u003e\n+          {/snippet}\n+        \u003c/RepoTab\u003e\n+        \u003cRepoTab tabValue=\"issues\" label=\"Issues\" href=\"issues\"\u003e\n+          {#snippet icon()}\n+            \u003cCircleAlert class=\"h-4 w-4\" /\u003e\n+          {/snippet}\n+        \u003c/RepoTab\u003e\n+        \u003cRepoTab tabValue=\"patches\" label=\"Patches\" href=\"patches\"\u003e\n+          {#snippet icon()}\n+            \u003cGitPullRequest class=\"h-4 w-4\" /\u003e\n+          {/snippet}\n+        \u003c/RepoTab\u003e\n+        \u003cRepoTab tabValue=\"wiki\" label=\"Wiki\" href=\"wiki\"\u003e\n+          {#snippet icon()}\n+            \u003cBook class=\"h-4 w-4\" /\u003e\n+          {/snippet}\n+        \u003c/RepoTab\u003e\n+      {/snippet}\n+    \u003c/RepoHeader\u003e\n+    {@render children()}\n+  {/if}\n+\u003c/PageContent\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 1208f82..ec7af86 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -30,6 +30,7 @@\n   import type {AddressPointer} from \"nostr-tools/nip19\"\n   import {fly} from \"svelte/transition\"\n   import {Router} from \"@welshman/router\"\n+  import {RepoHeader} from \"@nostr-git/ui\"\n \n   const {relay, id} = $page.params\n   const url = decodeRelay(relay)\n@@ -224,6 +225,7 @@\n     {/snippet}\n   \u003c/PageBar\u003e\n   {#if !loading \u0026\u0026 repoEvent}\n+    \u003cRepoHeader event={repoEvent} /\u003e\n     \u003cGitItem {url} event={repoEvent} showIssues={false} /\u003e\n     \u003cDivider /\u003e\n     {#if orderedElements}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nnew file mode 100644\nindex 0000000..e6f3b57\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -0,0 +1,39 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {FileView} from \"@nostr-git/ui\"\n+  import {GitBranch} from \"@lucide/svelte\"\n+  import {deriveNaddrEvent} from \"@app/state\"\n+  import {page} from \"$app/stores\"\n+  const {id, relay} = $page.params\n+  const relayArray = Array.isArray(relay) ? relay : [relay]\n+  const repo = deriveNaddrEvent(id, relayArray)\n+\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"border-border bg-card rounded-lg border\"\u003e\n+  \u003cdiv class=\"p-4\"\u003e\n+    \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n+      \u003cdiv class=\"flex items-center gap-2\"\u003e\n+        \u003cGitBranch class=\"text-muted-foreground h-5 w-5\" /\u003e\n+        \u003cselect class=\"border-border rounded border bg-secondary px-2 py-1\"\u003e\n+          {#each $repo.branches as branch}\n+            \u003coption key={branch.name} value={branch.name}\u003e\n+              {branch.name}\n+              {branch.isDefault \u0026\u0026 \"(default)\"}\n+            \u003c/option\u003e\n+          {/each}\n+        \u003c/select\u003e\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+\n+    \u003cdiv class=\"border-border border-t pt-4\"\u003e\n+      \u003cdiv class=\"space-y-2\"\u003e\n+        \u003ch3 class=\"mb-4 font-medium\"\u003eFiles\u003c/h3\u003e\n+        \u003cdiv class=\"space-y-2\"\u003e\n+          {#each $repo.files as file}\n+            \u003cFileView name={file.name} type={file.type} path={file.path} content={file.content} /\u003e\n+          {/each}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  \u003c/div\u003e\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nnew file mode 100644\nindex 0000000..708b472\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -0,0 +1,61 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {Button, IssueCard} from \"@nostr-git/ui\"\n+  import {Filter, Plus} from \"@lucide/svelte\"\n+  import {deriveNaddrEvent} from \"@app/state\"\n+  import {page} from \"$app/stores\"\n+  import {GIT_ISSUE} from \"@welshman/util\"\n+  import {Address} from \"@welshman/util\"\n+  import {load} from \"@welshman/net\"\n+  import {onMount} from \"svelte\"\n+  import {setChecked} from \"@src/app/notifications\"\n+  const {id, relay} = $page.params\n+  const relayArray = Array.isArray(relay) ? relay : [relay]\n+  const repo = deriveNaddrEvent(id, relayArray)\n+  const issues = $state([])\n+\n+  async function loadIssues() {\n+    issues.length = 0\n+    const issueFilter = {\n+      kinds: [GIT_ISSUE],\n+      \"#d\": [Address.fromEvent($repo).toString()],\n+    }\n+    const issue = await load({\n+      relays: relayArray,\n+      filters: [issueFilter],\n+    })\n+    if (issue.length \u003e 0) {\n+      issues.push(...issue)\n+    }\n+  }\n+\n+  onMount(() =\u003e {\n+    loadIssues()\n+    return () =\u003e setChecked($page.url.pathname)\n+  })\n+\u003c/script\u003e\n+\n+\u003cdiv\u003e\n+  \u003cdiv\n+    class=\"z-10 bg-background/95 supports-[backdrop-filter]:bg-background/60 sticky top-0 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n+    \u003cdiv\u003e\n+      \u003ch2 class=\"text-xl font-semibold\"\u003eIssues\u003c/h2\u003e\n+      \u003cp class=\"text-muted-foreground text-sm\"\u003eTrack bugs and feature requests\u003c/p\u003e\n+    \u003c/div\u003e\n+\n+    \u003cdiv class=\"flex items-center gap-2\"\u003e\n+      \u003cButton variant=\"outline\" size=\"sm\" class=\"gap-2\"\u003e\n+        \u003cFilter class=\"h-4 w-4\" /\u003e\n+        Filter\n+      \u003c/Button\u003e\n+\n+      \u003cButton size=\"sm\" class=\"bg-git hover:bg-git-hover gap-2\"\u003e\n+        \u003cPlus class=\"h-4 w-4\" /\u003e\n+        New Issue\n+      \u003c/Button\u003e\n+    \u003c/div\u003e\n+  \u003c/div\u003e\n+\n+  {#each issues as issue}\n+    \u003cIssueCard event={issue} /\u003e\n+  {/each}\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nnew file mode 100644\nindex 0000000..b91c619\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -0,0 +1,60 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {page} from \"$app/state\"\n+  import {Filter, Plus} from \"@lucide/svelte\"\n+  import {Button, PatchCard} from \"@nostr-git/ui\"\n+  import {setChecked} from \"@src/app/notifications\"\n+  import {deriveNaddrEvent} from \"@src/app/state\"\n+  import {load} from \"@welshman/net\"\n+  import {Address, GIT_PATCH} from \"@welshman/util\"\n+  import {onMount} from \"svelte\"\n+\n+  const {id, relay} = page.params\n+  const relayArray = Array.isArray(relay) ? relay : [relay]\n+  const repo = deriveNaddrEvent(id, relayArray)\n+  const patches = $state([])\n+\n+  async function loadPatches() {\n+    patches.length = 0\n+    const patchFilter = {\n+      kinds: [GIT_PATCH],\n+      \"#d\": [Address.fromEvent($repo).toString()],\n+    }\n+    const patch = await load({\n+      relays: relayArray,\n+      filters: [patchFilter],\n+    })\n+    if (patch.length \u003e 0) {\n+      patches.push(...patch)\n+    }\n+  }\n+\n+  onMount(() =\u003e {\n+    loadPatches()\n+    return () =\u003e setChecked(page.url.pathname)\n+  })\n+\u003c/script\u003e\n+\n+\u003cdiv\u003e\n+  \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n+    \u003cdiv\u003e\n+      \u003ch2 class=\"text-xl font-semibold\"\u003ePatches\u003c/h2\u003e\n+      \u003cp class=\"text-muted-foreground text-sm\"\u003eReview and merge code changes\u003c/p\u003e\n+    \u003c/div\u003e\n+\n+    \u003cdiv class=\"flex items-center gap-2\"\u003e\n+      \u003cButton variant=\"outline\" size=\"sm\" class=\"gap-2\"\u003e\n+        \u003cFilter class=\"h-4 w-4\" /\u003e\n+        Filter\n+      \u003c/Button\u003e\n+\n+      \u003cButton size=\"sm\" class=\"bg-git hover:bg-git-hover gap-2\"\u003e\n+        \u003cPlus class=\"h-4 w-4\" /\u003e\n+        New Patch\n+      \u003c/Button\u003e\n+    \u003c/div\u003e\n+  \u003c/div\u003e\n+\n+  {#each patches as patch}\n+    \u003cPatchCard event={patch} /\u003e\n+  {/each}\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/jobs/+page.svelte b/src/routes/spaces/[relay]/jobs/+page.svelte\nindex 2eb2319..5b67456 100644\n--- a/src/routes/spaces/[relay]/jobs/+page.svelte\n+++ b/src/routes/spaces/[relay]/jobs/+page.svelte\n@@ -1,47 +1,61 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {decodeRelay, deriveEventsForUrl, getEventsForUrl} from \"@src/app/state\"\n-  import {FREELANCE_JOB} from \"@src/lib/util\"\n-  import {COMMENT, getListTags, getPubkeyTagValues, type TrustedEvent} from \"@welshman/util\"\n   import {onMount} from \"svelte\"\n-  import {page} from \"$app/state\"\n-  import {derived, readable, type Readable} from \"svelte/store\"\n-  import {setChecked} from \"@src/app/notifications\"\n-  import PageBar from \"@src/lib/components/PageBar.svelte\"\n-  import Icon from \"@src/lib/components/Icon.svelte\"\n-  import MenuSpaceButton from \"@src/app/components/MenuSpaceButton.svelte\"\n-  import Button from \"@src/lib/components/Button.svelte\"\n-  import Spinner from \"@src/lib/components/Spinner.svelte\"\n-  import JobItem from \"@src/app/components/JobItem.svelte\"\n-  import {fly} from \"@src/lib/transition\"\n-  import Link from \"@src/lib/components/Link.svelte\"\n-  import {makeFeed} from \"@src/app/requests\"\n-  import PageContent from \"@src/lib/components/PageContent.svelte\"\n+  import {page} from \"$app/stores\"\n+  import {sortBy, min, nthEq} from \"@welshman/lib\"\n+  import type {TrustedEvent} from \"@welshman/util\"\n+  import {FREELANCE_JOB} from \"@src/lib/util\"\n+  import {COMMENT, getListTags, getPubkeyTagValues} from \"@welshman/util\"\n   import {userMutes} from \"@welshman/app\"\n+  import {fly} from \"@lib/transition\"\n+  import Icon from \"@lib/components/Icon.svelte\"\n+  import Button from \"@lib/components/Button.svelte\"\n+  import PageBar from \"@lib/components/PageBar.svelte\"\n+  import PageContent from \"@lib/components/PageContent.svelte\"\n+  import Spinner from \"@lib/components/Spinner.svelte\"\n+  import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n+  import JobItem from \"@app/components/JobItem.svelte\"\n+  import Link from \"@lib/components/Link.svelte\"\n+  import {decodeRelay, getEventsForUrl, INDEXER_RELAYS} from \"@app/state\"\n+  import {setChecked} from \"@app/notifications\"\n+  import {makeFeed} from \"@app/requests\"\n \n-  const url = decodeRelay(page.params.relay)\n+  const url = decodeRelay($page.params.relay)\n   const mutedPubkeys = getPubkeyTagValues(getListTags($userMutes))\n   const jobs: TrustedEvent[] = $state([])\n   const comments: TrustedEvent[] = $state([])\n+  const jobFilter = {kinds: [FREELANCE_JOB], \"#s\": [\"0\"]}\n+  const commentFilter = {kinds: [COMMENT], \"#K\": [String(FREELANCE_JOB)]}\n \n-  let element: HTMLElement | undefined = $state()\n   let loading = $state(true)\n-  const limit = 20\n+  let element: HTMLElement | undefined = $state()\n+\n+  const events = $derived.by(() =\u003e {\n+    const scores = new Map\u003cstring, number\u003e()\n+    for (const comment of comments) {\n+      const id = comment.tags.find(nthEq(0, \"E\"))?.[1]\n+      if (id) {\n+        scores.set(id, min([scores.get(id), -comment.created_at]))\n+      }\n+    }\n+    return sortBy(\n+      (e: TrustedEvent) =\u003e min([scores.get(e.id), -e.created_at]),\n+      jobs.filter((e: TrustedEvent) =\u003e !mutedPubkeys.includes(e.pubkey)),\n+    )\n+  })\n \n   onMount(() =\u003e {\n     const {cleanup} = makeFeed({\n       element: element!,\n-      relays: [url],\n-      feedFilters: [{kinds: [FREELANCE_JOB]}],\n-      subscriptionFilters: [\n-        {kinds: [FREELANCE_JOB]},\n-        {kinds: [COMMENT], \"#K\": [String(FREELANCE_JOB)]},\n-      ],\n-      initialEvents: getEventsForUrl(url, [{kinds: [FREELANCE_JOB], limit}]),\n+      relays: INDEXER_RELAYS,\n+      feedFilters: [jobFilter, commentFilter],\n+      subscriptionFilters: [jobFilter, commentFilter],\n+      initialEvents: getEventsForUrl(url, [\n+        {kinds: [FREELANCE_JOB, COMMENT], \"#s\": [\"0\"], limit: 10},\n+      ]),\n       onEvent: event =\u003e {\n-        if (event.kind === FREELANCE_JOB) {\n+        if (event.kind === FREELANCE_JOB \u0026\u0026 !mutedPubkeys.includes(event.pubkey)) {\n           jobs.push(event)\n         }\n-\n         if (event.kind === COMMENT) {\n           comments.push(event)\n         }\n@@ -50,10 +64,9 @@\n         loading = false\n       },\n     })\n-\n     return () =\u003e {\n       cleanup()\n-      setChecked(page.url.pathname)\n+      setChecked($page.url.pathname)\n     }\n   })\n \u003c/script\u003e\n@@ -83,25 +96,28 @@\n   {/snippet}\n \u003c/PageBar\u003e\n \n-\u003cPageContent bind:element class=\"flex flex-col gap-2 p-2 pt-4\"\u003e\n-  {#each jobs as event (event.id)}\n-    \u003cdiv class={\"job-event\" + event.id} in:fly\u003e\n-      \u003cJobItem\n-        {url}\n-        {event}\n-        showComment={true}\n-        showExternal={true}\n-        showThreadAction={true}\n-        showActivity={true} /\u003e\n+\u003cPageContent bind:element class=\"flex flex-grow flex-col overflow-auto p-3\"\u003e\n+  {#if loading}\n+    \u003cdiv class=\"flex h-32 items-center justify-center\"\u003e\n+      \u003cSpinner {loading}\u003eLooking for jobs...\u003c/Spinner\u003e\n+    \u003c/div\u003e\n+  {:else if events.length === 0}\n+    \u003cdiv class=\"flex h-32 items-center justify-center text-gray-400\"\u003e\n+      \u003cIcon icon=\"jobs\" class=\"mr-2\" /\u003e No Jobs found.\n+    \u003c/div\u003e\n+  {:else}\n+    \u003cdiv class=\"flex flex-col gap-3\"\u003e\n+      {#each events as event: TrustedEvent (event.id)}\n+        \u003cdiv in:fly\u003e\n+          \u003cJobItem\n+            {url}\n+            {event}\n+            showComment={true}\n+            showExternal={true}\n+            showThreadAction={true}\n+            showActivity={true} /\u003e\n+        \u003c/div\u003e\n+      {/each}\n     \u003c/div\u003e\n-  {/each}\n-  \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n-    \u003cSpinner {loading}\u003e\n-      {#if loading}\n-        Looking for jobs...\n-      {:else if jobs.length === 0}\n-        No Jobs found.\n-      {/if}\n-    \u003c/Spinner\u003e\n-  \u003c/p\u003e\n+  {/if}\n \u003c/PageContent\u003e\ndiff --git a/src/routes/spaces/[relay]/jobs/[id]/+page.svelte b/src/routes/spaces/[relay]/jobs/[id]/+page.svelte\nindex c67037d..e9c44c0 100644\n--- a/src/routes/spaces/[relay]/jobs/[id]/+page.svelte\n+++ b/src/routes/spaces/[relay]/jobs/[id]/+page.svelte\n@@ -3,8 +3,6 @@\n   import {page} from \"$app/stores\"\n   import {sortBy, sleep, now} from \"@welshman/lib\"\n   import {COMMENT, type TrustedEvent} from \"@welshman/util\"\n-  import {repository} from \"@welshman/app\"\n-  import {deriveEvents} from \"@welshman/store\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import PageBar from \"@lib/components/PageBar.svelte\"\n   import Spinner from \"@lib/components/Spinner.svelte\"\n@@ -18,15 +16,19 @@\n   import {setChecked} from \"@app/notifications\"\n   import JobItem from \"@src/app/components/JobItem.svelte\"\n   import Divider from \"@src/lib/components/Divider.svelte\"\n-  import {readable, type Readable} from \"svelte/store\"\n-  import {on} from \"svelte/events\"\n-    import { makeFeed } from \"@src/app/requests\"\n+  import {makeFeed} from \"@src/app/requests\"\n+  import {readable, writable, type Readable} from \"svelte/store\"\n+  import PageContent from \"@src/lib/components/PageContent.svelte\"\n \n   const {relay, id} = $page.params\n   const url = decodeRelay(relay)\n   const event = deriveEvent(id)\n-  const filters = [{kinds: [COMMENT], \"#E\": [id]}]\n-  const replies = deriveEvents(repository, {filters})\n+  const replies = writable\u003cTrustedEvent[]\u003e([])\n+\n+  onMount(() =\u003e {\n+    const initialReplies = getEventsForUrl(url, [{kinds: [COMMENT], \"#E\": [id], limit: 20}])\n+    replies.set(initialReplies)\n+  })\n \n   const back = () =\u003e history.back()\n \n@@ -54,17 +56,15 @@\n     ;({events, cleanup} = makeFeed({\n       element: element!,\n       relays: [url],\n-      feedFilters: filters,\n+      feedFilters: [{kinds: [COMMENT], \"#E\": [id]}],\n       subscriptionFilters: [{kinds: [COMMENT], \"#E\": [id], since: now()}],\n-      initialEvents: getEventsForUrl(url, [{...filters, limit: 20}]),\n+      initialEvents: getEventsForUrl(url, [{kinds: [COMMENT], \"#E\": [id], limit: 20}]),\n       onExhausted: () =\u003e {\n         loadingEvents = false\n       },\n     }))\n \n-\n-    return () =\u003e {\n-    }\n+    return () =\u003e {}\n   })\n \n   onDestroy(() =\u003e {\n@@ -75,59 +75,66 @@\n   })\n \u003c/script\u003e\n \n-\u003cdiv class=\"relative flex flex-col-reverse gap-3 px-2\"\u003e\n-  {#if $event}\n-    {#if !showReply}\n-      \u003cdiv class=\"flex justify-end px-2 pb-2\"\u003e\n-        \u003cButton class=\"btn btn-primary\" onclick={openReply}\u003e\n-          \u003cIcon icon=\"reply\" /\u003e\n-          Comment on Job\n-        \u003c/Button\u003e\n-      \u003c/div\u003e\n-    {/if}\n-    {#each sortBy(e =\u003e -e.created_at, $replies).slice(0, showAll ? undefined : 4) as reply (reply.id)}\n-      \u003cNoteCard event={reply} class=\"card2 bg-alt z-feature w-full\"\u003e\n-        \u003cdiv class=\"col-3 ml-12\"\u003e\n-          \u003cContent showEntire event={reply} /\u003e\n-          \u003cJobActions event={reply} {url} showExternal={false} /\u003e\n+\u003cPageBar class=\"mx-0\"\u003e\n+  {#snippet icon()}\n+    \u003cdiv\u003e\n+      \u003cButton class=\"btn btn-neutral btn-sm\" onclick={back}\u003e\n+        \u003cIcon icon=\"alt-arrow-left\" /\u003e\n+      \u003c/Button\u003e\n+    \u003c/div\u003e\n+  {/snippet}\n+  {#snippet title()}\n+    \u003ch1 class=\"text-center text-xl sm:text-lg\"\u003eJob Discussion\u003c/h1\u003e\n+  {/snippet}\n+  {#snippet action()}\n+    \u003cdiv\u003e\n+      \u003cMenuSpaceButton {url} /\u003e\n+    \u003c/div\u003e\n+  {/snippet}\n+\u003c/PageBar\u003e\n+\u003cPageContent bind:element class=\"flex flex-grow flex-col overflow-auto p-3\"\u003e\n+  \u003cdiv class=\"relative flex flex-col-reverse gap-3 px-2\"\u003e\n+    {#if $event}\n+      {#if !showReply}\n+        \u003cdiv class=\"flex justify-end px-2 pb-2\"\u003e\n+          \u003cButton class=\"btn btn-primary\" onclick={openReply}\u003e\n+            \u003cIcon icon=\"reply\" /\u003e\n+            Comment on Job\n+          \u003c/Button\u003e\n+        \u003c/div\u003e\n+      {/if}\n+      {#each sortBy(e =\u003e -e.created_at, $replies).slice(0, showAll ? undefined : 4) as reply (reply.id)}\n+        \u003cNoteCard event={reply} class=\"card2 bg-alt z-feature w-full\"\u003e\n+          \u003cdiv class=\"col-3 ml-12\"\u003e\n+            \u003cContent showEntire event={reply} /\u003e\n+            \u003cJobActions event={reply} {url} showExternal={false} /\u003e\n+          \u003c/div\u003e\n+        \u003c/NoteCard\u003e\n+      {/each}\n+      {#if !showAll \u0026\u0026 $replies.length \u003e 4}\n+        \u003cdiv class=\"flex justify-center\"\u003e\n+          \u003cButton class=\"btn btn-link\" onclick={expand}\u003e\n+            \u003cIcon icon=\"sort-vertical\" /\u003e\n+            Show all {$replies.length} replies\n+          \u003c/Button\u003e\n         \u003c/div\u003e\n-      \u003c/NoteCard\u003e\n-    {/each}\n-    {#if !showAll \u0026\u0026 $replies.length \u003e 4}\n-      \u003cdiv class=\"flex justify-center\"\u003e\n-        \u003cButton class=\"btn btn-link\" onclick={expand}\u003e\n-          \u003cIcon icon=\"sort-vertical\" /\u003e\n-          Show all {$replies.length} replies\n-        \u003c/Button\u003e\n-      \u003c/div\u003e\n+      {/if}\n+      \u003cDivider /\u003e\n+      \u003cJobItem\n+        {url}\n+        event={$event}\n+        showActivity={true}\n+        showExternal={true}\n+        showThreadAction={true} /\u003e\n+    {:else}\n+      {#await sleep(5000)}\n+        \u003cSpinner loading\u003eLoading comments...\u003c/Spinner\u003e\n+      {:then}\n+        \u003cp\u003eFailed to load comments.\u003c/p\u003e\n+      {/await}\n     {/if}\n-    \u003cDivider /\u003e\n-    \u003cJobItem {url} event={$event} showActivity={true} showExternal={true} showThreadAction={true} /\u003e\n-  {:else}\n-    {#await sleep(5000)}\n-      \u003cSpinner loading\u003eLoading comments...\u003c/Spinner\u003e\n-    {:then}\n-      \u003cp\u003eFailed to load comments.\u003c/p\u003e\n-    {/await}\n-  {/if}\n-  \u003cPageBar class=\"mx-0\"\u003e\n-    {#snippet icon()}\n-      \u003cdiv\u003e\n-        \u003cButton class=\"btn btn-neutral btn-sm\" onclick={back}\u003e\n-          \u003cIcon icon=\"alt-arrow-left\" /\u003e\n-        \u003c/Button\u003e\n-      \u003c/div\u003e\n-    {/snippet}\n-    {#snippet title()}\n-      \u003ch1 class=\"text-center text-xl sm:text-lg\"\u003eJob Discussion\u003c/h1\u003e\n-    {/snippet}\n-    {#snippet action()}\n-      \u003cdiv\u003e\n-        \u003cMenuSpaceButton {url} /\u003e\n-      \u003c/div\u003e\n-    {/snippet}\n-  \u003c/PageBar\u003e\n-\u003c/div\u003e\n+  \u003c/div\u003e\n+\u003c/PageContent\u003e\n {#if showReply}\n   \u003cEventReply {url} event={$event} onClose={closeReply} onSubmit={closeReply} /\u003e\n {/if}\ndiff --git a/tailwind.config.js b/tailwind.config.js\nindex 30f06f5..4c83b8a 100644\n--- a/tailwind.config.js\n+++ b/tailwind.config.js\n@@ -1,13 +1,14 @@\n import {config} from \"dotenv\"\n import daisyui from \"daisyui\"\n import themes from \"daisyui/src/theming/themes\"\n+import uiPreset from '@nostr-git/ui/tailwind.preset.js';\n \n config({path: \".env.local\"})\n config({path: \".env\"})\n \n /** @type {import('tailwindcss').Config} */\n export default {\n-  content: [\"./src/**/*.{html,js,svelte,ts}\"],\n+  content: [\"./src/**/*.{html,js,svelte,ts}\", \"./node_modules/@nostr-git/ui/src/**/*.{html,js,svelte,ts}\"],\n   theme: {\n     extend: {},\n     zIndex: {\n@@ -23,6 +24,7 @@ export default {\n     },\n   },\n   plugins: [daisyui],\n+  presets: [uiPreset],\n   daisyui: {\n     themes: [\n       {\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-135zblxl","title":"From f17634bcabf2d30a9c6e77956018140f420f8b9b Mon Sep 17 00:00:00 2001","description":"From f17634bcabf2d30a9c6e77956018140f420f8b9b Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 16 Nov 2025 21:20:58 +0500\nSubject: [PATCH 1/4] feat: implemented the logic for inline comments in diff viewer\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 48 ++++++++++++++++++++++++++++++++++++++++++++++++\n 1 file changed, 48 insertions(+)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex dda7746..cbdb94a 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -312,6 +312,54 @@\n     }\n   })\n \n+  // Transform CommentEvent[] into DiffViewer Comment[] format\n+  const diffComments = $derived.by(() =\u003e {\n+    const comments = $threadComments\n+    if (!comments || comments.length === 0) return []\n+    \n+    return comments.map((commentEvent: CommentEvent) =\u003e {\n+      // Parse line number and file path from comment content\n+      // Format: \"comment text\\n\\n---\\nFile: path\\nLine: 123\"\n+      let lineNumber = 0\n+      let filePath = \"\"\n+      let content = commentEvent.content\n+      \n+      const separatorIndex = content.indexOf('\\n\\n---\\n')\n+      if (separatorIndex !== -1) {\n+        // Extract the actual comment content (before the separator)\n+        content = content.substring(0, separatorIndex).trim()\n+        \n+        // Extract file path and line number from the metadata section\n+        const metadataSection = commentEvent.content.substring(separatorIndex + 6)\n+        const fileMatch = metadataSection.match(/File:\\s*(.+?)(?:\\n|$)/i)\n+        if (fileMatch) {\n+          filePath = fileMatch[1].trim()\n+        }\n+        const lineMatch = metadataSection.match(/Line:\\s*(\\d+)/i)\n+        if (lineMatch) {\n+          lineNumber = parseInt(lineMatch[1], 10)\n+        }\n+      }\n+      \n+      // Get profile information for the author\n+      const profile = $profilesByPubkey.get(commentEvent.pubkey)\n+      const authorName = profile?.name || profile?.display_name || commentEvent.pubkey.slice(0, 8)\n+      const authorAvatar = profile?.picture || \"\"\n+      \n+      return {\n+        id: commentEvent.id || \"\",\n+        lineNumber,\n+        filePath,\n+        content,\n+        author: {\n+          name: authorName,\n+          avatar: authorAvatar,\n+        },\n+        createdAt: new Date(commentEvent.created_at * 1000).toISOString(),\n+      }\n+    })\n+  })\n+\n   const getStatusFilter = () =\u003e ({\n     kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n     \"#e\": [selectedPatch?.id ?? \"\"],\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-14qrc5yo","title":"From 019e03f15b71eeb74751ee8311982a5876363de7 Mon Sep 17 00:00:00 2001","description":"From 019e03f15b71eeb74751ee8311982a5876363de7 Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/1] Git repository handling improvements\n\nThis PR includes changes that improve the overall responsiveness of git repo operations, adds folder navigation and codeview code viewer to the code view section","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-17s41nqq","title":"From cc09b1e1d8752c89068cc1a158da537d5186b958 Mon Sep 17 00:00:00 2001","description":"From cc09b1e1d8752c89068cc1a158da537d5186b958 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 15 May 2025 17:39:16 -0700\nSubject: [PATCH 2/2] feat: enhance git repo loading with error handling and branch selector UI\n\n---\n src/app/components/GitActions.svelte                       | 10 ++++++----\n src/routes/spaces/[relay]/git/+page.svelte                 | 44 +++++++++++++++++++++++++++++++++-----------\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte | 54 +++++++++++++++++++++++++++++++++++++-----------------\n 3 files changed, 76 insertions(+), 32 deletions(-)\n\ndiff --git a/src/app/components/GitActions.svelte b/src/app/components/GitActions.svelte\nindex e4401f9..d4ab776 100644\n--- a/src/app/components/GitActions.svelte\n+++ b/src/app/components/GitActions.svelte\n@@ -94,8 +94,10 @@\n \n \u003cdiv class=\"flex flex-wrap items-center justify-between gap-2\"\u003e\n   \u003cdiv class=\"flex flex-grow flex-wrap justify-end gap-2\"\u003e\n-    \u003cButton class=\"btn btn-primary btn-sm\" disabled={!gitworkshopLink}\u003e\n-      \u003cLink external class=\"w-full cursor-pointer\" href={gitworkshopLink}\u003e\n+    \u003cButton class=\"btn btn-primary btn-sm\"\u003e\n+      \u003cLink\n+        class=\"w-full cursor-pointer\"\n+        href={makeGitPath(url, Address.fromEvent(event).toNaddr())}\u003e\n         \u003cspan class=\"\"\u003eBrowse\u003c/span\u003e\n       \u003c/Link\u003e\n     \u003c/Button\u003e\n@@ -103,9 +105,9 @@\n       \u003cButton class=\"btn btn-secondary btn-sm\"\u003e\n         \u003cLink\n           class=\"flex h-full w-full cursor-pointer items-center\"\n-          href={makeGitPath(url, Address.fromEvent(event).toNaddr())}\u003e\n+          href={makeGitPath(url, Address.fromEvent(event).toNaddr()) + \"/issues\"}\u003e\n           \u003cSpinner loading={loadingIssues} minHeight={\"min-h-6\"}\u003e\n-            \u003cspan class=\"\"\u003e{\"Issues(\" + issueCount + \")\"}\u003c/span\u003e\n+            \u003cspan class=\"\"\u003e{\"Issues (\" + issueCount + \")\"}\u003c/span\u003e\n           \u003c/Spinner\u003e\n         \u003c/Link\u003e\n       \u003c/Button\u003e\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 83877b0..d064661 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -30,17 +30,29 @@\n   const url = decodeRelay($page.params.relay)\n   const mutedPubkeys = getPubkeyTagValues(getListTags($userMutes))\n   const repos: TrustedEvent[] = $state([])\n+\n   let loading = $state(true)\n   let loadedBookmarkedRepos: Array\u003c{address: string; event: TrustedEvent; relayHint: string}\u003e = []\n \n   async function loadBookmarkedRepos() {\n     repos.length = 0\n     loading = true\n-    const bookmarkFilter = {kinds: [NAMED_BOOKMARKS], authors: [pubkey.get()!]}\n-    const bookmark = await load({\n-      relays: [url, ...Router.get().FromUser().getUrls()],\n-      filters: [bookmarkFilter],\n-    })\n+    // --- Logging bookmark filter and relays ---\n+    const bookmarkFilter = { kinds: [NAMED_BOOKMARKS], authors: [pubkey.get()!] };\n+    const bookmarkRelays = [url, ...Router.get().FromUser().getUrls()];\n+    console.log(\"[RepoLoad] Bookmark filter:\", bookmarkFilter, \"Relays:\", bookmarkRelays);\n+    let bookmark = [];\n+    try {\n+      bookmark = await load({\n+        relays: bookmarkRelays,\n+        filters: [bookmarkFilter],\n+      });\n+      console.log(\"[RepoLoad] Bookmark result:\", bookmark);\n+    } catch (e) {\n+      console.error(\"[RepoLoad] Bookmark load() error:\", e, \"Relays:\", bookmarkRelays, \"Filter:\", bookmarkFilter);\n+      loading = false;\n+      return;\n+    }\n     if (bookmark.length \u003e 0) {\n       const aTagList = getAddressTags(bookmark[0].tags)\n       const dTagValues: string[] = []\n@@ -51,13 +63,22 @@\n         dTagValues.push(value.split(\":\")[2])\n         authors.push(value.split(\":\")[1])\n         relaysOfAddresses.set(value, relayHint || \"\")\n-        if (relayHint) relayHints.push(relayHint)\n-      })\n-      const repoFilter = {kinds: [GIT_REPO], authors, \"#d\": dTagValues}\n-      const loadedRepos = await load({\n-        relays: relayHints,\n-        filters: [repoFilter],\n+        if (relayHint \u0026\u0026 !relayHints.includes(relayHint)) relayHints.push(relayHint)\n       })\n+      const repoFilter = { kinds: [GIT_REPO], authors, \"#d\": dTagValues };\n+      console.log(\"[RepoLoad] Repo filter:\", repoFilter, \"Relay hints:\", relayHints);\n+      let loadedRepos = [];\n+      try {\n+        loadedRepos = await load({\n+          relays: relayHints,\n+          filters: [repoFilter],\n+        });\n+        console.log(\"[RepoLoad] Loaded repos result:\", loadedRepos);\n+      } catch (e) {\n+        console.error(\"[RepoLoad] Repo load() error:\", e, \"Relays:\", relayHints, \"Filter:\", repoFilter);\n+        loading = false;\n+        return;\n+      }\n       loadedBookmarkedRepos = loadedRepos.map(repo =\u003e {\n         const address = Address.fromEvent(repo)\n         const addressString = address.toString()\n@@ -66,6 +87,7 @@\n         return {address: addressString, event: repo, relayHint: hint}\n       })\n       loadedRepos.filter(e =\u003e !mutedPubkeys.includes(e.pubkey)).forEach(e =\u003e repos.push(e))\n+      console.log(loadedRepos)\n     }\n     loading = false\n   }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex 1613054..709f357 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -1,6 +1,6 @@\n \u003cscript lang=\"ts\"\u003e\n   import {getContext, onMount} from \"svelte\"\n-  import {FileView} from \"@nostr-git/ui\"\n+  import {FileView, Tabs, TabsList, TabsTrigger} from \"@nostr-git/ui\"\n   import {GitBranch} from \"@lucide/svelte\"\n   import {listRepoFilesFromEvent, type FileEntry} from \"@nostr-git/core\"\n   import {load} from \"@welshman/net\"\n@@ -9,11 +9,13 @@\n   import {parseRepoStateEvent, type TrustedEvent} from \"@nostr-git/shared-types\"\n   import {page} from \"$app/stores\"\n   import type {Readable} from \"svelte/store\"\n-    import { nthEq } from \"@welshman/lib\"\n+  import {nthEq} from \"@welshman/lib\"\n+  import Popover from \"@src/lib/components/Popover.svelte\"\n+  import Button from \"@src/lib/components/Button.svelte\"\n+  import {fly} from \"svelte/transition\"\n+  import Icon from \"@lib/components/Icon.svelte\"\n \n   const {id, relay} = $page.params\n-  const relayArray = Array.isArray(relay) ? relay : [relay]\n-\n   const eventStore = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n   // UI state\n@@ -113,6 +115,16 @@\n     }\n   }\n \n+  let showMenu = false\n+\n+  const toggleMenu = () =\u003e {\n+    showMenu = !showMenu\n+  }\n+\n+  const openMenu = () =\u003e {\n+    showMenu = true\n+  }\n+\n   onMount(() =\u003e {\n     tryLoadRepoStateEvent()\n   })\n@@ -146,19 +158,27 @@\n         \u003cdiv class=\"text-muted-foreground\"\u003eNo files available for this branch.\u003c/div\u003e\n       \u003c/div\u003e\n     {:else}\n-      \u003cdiv class=\"mb-4 flex items-center gap-2\"\u003e\n-        \u003cGitBranch class=\"h-5 w-5 text-muted-foreground\" /\u003e\n-        \u003cselect\n-          class=\"rounded border border-border bg-secondary px-2 py-1\"\n-          bind:value={selectedBranch}\n-          on:change={onBranchChange}\u003e\n-          {#each branches as branch}\n-            \u003coption value={branch.name}\u003e\n-              {branch.name}\n-              {branch.isDefault ? \" (default)\" : \"\"}\n-            \u003c/option\u003e\n-          {/each}\n-        \u003c/select\u003e\n+      \u003cdiv class=\"mb-4\"\u003e\n+        \u003cButton\n+          onclick={openMenu}\n+          class=\"flex items-center gap-3 text-left transition-all hover:text-base-content\"\u003e\n+          \u003cGitBranch class=\"h-5 w-5 text-muted-foreground\" /\u003e\n+          \u003cspan\u003e{selectedBranch}\u003c/span\u003e\n+          \u003cIcon icon=\"alt-arrow-down\" /\u003e\n+        \u003c/Button\u003e\n+        {#if showMenu}\n+          \u003cPopover hideOnClick onClose={toggleMenu}\u003e\n+            \u003cul transition:fly class=\"menu z-popover mt-2 rounded-box bg-base-100 p-2 shadow-xl\"\u003e\n+              {#each branches as branch}\n+                \u003cli\u003e\n+                  \u003cButton onclick={() =\u003e (selectedBranch = branch.name)}\u003e\n+                    \u003cspan\u003e{branch.name}\u003c/span\u003e\n+                  \u003c/Button\u003e\n+                \u003c/li\u003e\n+              {/each}\n+            \u003c/ul\u003e\n+          \u003c/Popover\u003e\n+        {/if}\n       \u003c/div\u003e\n       \u003cdiv class=\"border-t border-border pt-4\"\u003e\n         {#if files.length === 0}\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-1b03zl62","title":"From 3345ae80fafc4830874d64448690d8807298784e Mon Sep 17 00:00:00 2001","description":"From 3345ae80fafc4830874d64448690d8807298784e Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Wed, 4 Jun 2025 13:52:00 -0700\nSubject: [PATCH 17/67] Add new room dashboard layout\n\n---\n src/routes/spaces/[relay]/+page.svelte | 16 ++++++++++++++++\n 1 file changed, 16 insertions(+)\n\ndiff --git a/src/routes/spaces/[relay]/+page.svelte b/src/routes/spaces/[relay]/+page.svelte\nindex 374f2ef..06003f5 100644\n--- a/src/routes/spaces/[relay]/+page.svelte\n+++ b/src/routes/spaces/[relay]/+page.svelte\n@@ -45,7 +45,23 @@\n \n   const addRoom = () =\u003e pushModal(RoomCreate, {url})\n \n+  let relayAdminEvents: TrustedEvent[] = $state([])\n+  let roomSearchQuery = $state(\"\")\n+\n   const pubkey = $derived($relay?.profile?.pubkey)\n+\n+  const filteredRooms = $derived(() =\u003e {\n+    if (!roomSearchQuery) return [...$userRooms, ...$otherRooms]\n+\n+    const query = roomSearchQuery.toLowerCase()\n+    const allRooms = [...$userRooms, ...$otherRooms]\n+\n+    return allRooms.filter(room =\u003e {\n+      const channel = $channelsById.get(makeChannelId(url, room))\n+      const roomName = channel?.name || room\n+      return roomName.toLowerCase().includes(query)\n+    })\n+  })\n \u003c/script\u003e\n \n \u003cdiv class=\"relative flex flex-col\"\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-1ika2fhk","title":"From 8983c367155b74620dd860088c40ec4537f73b92 Mon Sep 17 00:00:00 2001","description":"From 8983c367155b74620dd860088c40ec4537f73b92 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Sat, 10 May 2025 12:32:22 -0700\nSubject: [PATCH 2/3] fix: update tag selectors from #d to #a and add relay configuration\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte       | 15 ++++++++-------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte         | 77 +++++++++++++++++++++++++----------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte  |  9 ++++++---\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte |  2 +-\n 4 files changed, 40 insertions(+), 63 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 63dcb65..89d3c03 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -9,6 +9,7 @@\n   const relayArray = Array.isArray(relay) ? relay : [relay]\n   const eventStore = deriveNaddrEvent(id, relayArray)\n   let {children} = $props()\n+  let activeTab = $page.url.pathname.split(\"/\").pop()\n \u003c/script\u003e\n \n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n@@ -17,29 +18,29 @@\n   {:else if !$eventStore}\n     \u003cdiv class=\"p-4 text-center text-red-500\"\u003eRepository not found.\u003c/div\u003e\n   {:else}\n-    \u003cRepoHeader event={$eventStore as RepoAnnouncementEvent}\u003e\n-      {#snippet children()}\n-        \u003cRepoTab tabValue=\"overview\" label=\"Overview\" href=\"overview\"\u003e\n+    \u003cRepoHeader event={$eventStore as RepoAnnouncementEvent} activeTab={activeTab}\u003e\n+      {#snippet children(activeTab)}\n+        \u003cRepoTab tabValue=\"overview\" label=\"Overview\" href=\".\" {activeTab}\u003e\n           {#snippet icon()}\n             \u003cFileCode class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab tabValue=\"code\" label=\"Code\" href={`./${id}/code`}\u003e\n+        \u003cRepoTab tabValue=\"code\" label=\"Code\" href=\"code\" {activeTab}\u003e\n           {#snippet icon()}\n             \u003cGitBranch class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab tabValue=\"issues\" label=\"Issues\" href=\"issues\"\u003e\n+        \u003cRepoTab tabValue=\"issues\" label=\"Issues\" href=\"issues\" {activeTab}\u003e\n           {#snippet icon()}\n             \u003cCircleAlert class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab tabValue=\"patches\" label=\"Patches\" href=\"patches\"\u003e\n+        \u003cRepoTab tabValue=\"patches\" label=\"Patches\" href=\"patches\" {activeTab}\u003e\n           {#snippet icon()}\n             \u003cGitPullRequest class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab tabValue=\"wiki\" label=\"Wiki\" href=\"wiki\"\u003e\n+        \u003cRepoTab tabValue=\"wiki\" label=\"Wiki\" href=\"wiki\" {activeTab}\u003e\n           {#snippet icon()}\n             \u003cBook class=\"h-4 w-4\" /\u003e\n           {/snippet}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex ec7af86..e9e12d1 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -14,24 +14,18 @@\n   } from \"@welshman/util\"\n   import {repository} from \"@welshman/app\"\n   import {deriveEvents} from \"@welshman/store\"\n-  import Icon from \"@lib/components/Icon.svelte\"\n-  import PageBar from \"@lib/components/PageBar.svelte\"\n-  import Spinner from \"@lib/components/Spinner.svelte\"\n-  import Button from \"@lib/components/Button.svelte\"\n-  import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n   import {decodeRelay} from \"@app/state\"\n   import {setChecked} from \"@app/notifications\"\n   import {load} from \"@welshman/net\"\n-  import GitItem from \"@src/app/components/GitItem.svelte\"\n-  import GitIssueItem from \"@src/app/components/GitIssueItem.svelte\"\n   import {nip19} from \"nostr-tools\"\n   import {getRootEventTagValue} from \"@src/lib/util\"\n   import Divider from \"@src/lib/components/Divider.svelte\"\n   import type {AddressPointer} from \"nostr-tools/nip19\"\n-  import {fly} from \"svelte/transition\"\n   import {Router} from \"@welshman/router\"\n-  import {RepoHeader} from \"@nostr-git/ui\"\n-\n+  import {Card} from \"@nostr-git/ui\"\n+    import { GitBranch, GitCommit, Users } from \"@lucide/svelte\"\n+    import key from \"@lucide/svelte/icons/key\"\n+    \n   const {relay, id} = $page.params\n   const url = decodeRelay(relay)\n \n@@ -204,49 +198,28 @@\n       setChecked($page.url.pathname)\n     }\n   })\n+\n+  const stats = [\n+    { label: 'Active Branches', value: '5', icon: GitBranch },\n+    { label: 'Total Commits', value: '241', icon: GitCommit },\n+    { label: 'Contributors', value: '15', icon: Users },\n+  ];\n+\n \u003c/script\u003e\n \n \u003cdiv class=\"relative flex flex-col gap-3 px-2\"\u003e\n-  \u003cPageBar class=\"mx-0\"\u003e\n-    {#snippet icon()}\n-      \u003cdiv\u003e\n-        \u003cButton class=\"btn btn-neutral btn-sm\" onclick={back}\u003e\n-          \u003cIcon icon=\"alt-arrow-left\" /\u003e Go back\n-        \u003c/Button\u003e\n-      \u003c/div\u003e\n-    {/snippet}\n-    {#snippet title()}\n-      \u003ch1 class=\"text-center text-xl\"\u003eRepo Issues\u003c/h1\u003e\n-    {/snippet}\n-    {#snippet action()}\n-      \u003cdiv\u003e\n-        \u003cMenuSpaceButton {url} /\u003e\n-      \u003c/div\u003e\n-    {/snippet}\n-  \u003c/PageBar\u003e\n-  {#if !loading \u0026\u0026 repoEvent}\n-    \u003cRepoHeader event={repoEvent} /\u003e\n-    \u003cGitItem {url} event={repoEvent} showIssues={false} /\u003e\n-    \u003cDivider /\u003e\n-    {#if orderedElements}\n-      {#each orderedElements as { issue: issueItem, latestStatus } (issueItem.id)}\n-        {@const foundIssue = $issues!.find(i =\u003e i.id === issueItem.id) as TrustedEvent}\n-        {@const status = $statuses?.find(s =\u003e s.id === latestStatus?.sid)}\n-        \u003cGitIssueItem issue={foundIssue} latestStatus={status} showThreadAction={true} /\u003e\n-      {/each}\n-      {#if orderedElements.length === 0}\n-        \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n-          \u003cspan\u003eNo issues found.\u003c/span\u003e\n-        \u003c/p\u003e\n-      {/if}\n-    {/if}\n-  {:else}\n-    \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n-      {#if failedToLoad}\n-        \u003cspan\u003eFailed to load issues.\u003c/span\u003e\n-      {:else}\n-        \u003cSpinner loading\u003eLoading issues...\u003c/Spinner\u003e\n-      {/if}\n-    \u003c/p\u003e\n-  {/if}\n+  \u003cdiv class=\"grid grid-cols-3 gap-4\"\u003e\n+    {#each stats as stat}\n+      \u003cCard class=\"p-4\"\u003e\n+        \u003cdiv class=\"flex items-center gap-2\"\u003e\n+          \u003cstat.icon class=\"h-5 w-5 text-muted-foreground\" /\u003e\n+          \u003cdiv\u003e\n+            \u003cp class=\"text-sm text-muted-foreground\"\u003e{stat.label}\u003c/p\u003e\n+            \u003cp class=\"text-2xl font-semibold\"\u003e{stat.value}\u003c/p\u003e\n+          \u003c/div\u003e\n+        \u003c/div\u003e\n+      \u003c/Card\u003e\n+    {/each}\n+  \u003c/div\u003e\n+\n \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex 708b472..f459c16 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -8,19 +8,22 @@\n   import {load} from \"@welshman/net\"\n   import {onMount} from \"svelte\"\n   import {setChecked} from \"@src/app/notifications\"\n+  import {nthEq} from \"@welshman/lib\"\n   const {id, relay} = $page.params\n   const relayArray = Array.isArray(relay) ? relay : [relay]\n-  const repo = deriveNaddrEvent(id, relayArray)\n+  const repo = deriveNaddrEvent(id)\n   const issues = $state([])\n \n   async function loadIssues() {\n     issues.length = 0\n     const issueFilter = {\n       kinds: [GIT_ISSUE],\n-      \"#d\": [Address.fromEvent($repo).toString()],\n+      \"#a\": [Address.fromEvent($repo).toString()],\n     }\n+    const [tagId, ...relays] = $repo.tags.find(nthEq(0, \"relays\")) || []\n+\n     const issue = await load({\n-      relays: relayArray,\n+      relays: relays,\n       filters: [issueFilter],\n     })\n     if (issue.length \u003e 0) {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex b91c619..10a7b67 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -17,7 +17,7 @@\n     patches.length = 0\n     const patchFilter = {\n       kinds: [GIT_PATCH],\n-      \"#d\": [Address.fromEvent($repo).toString()],\n+      \"#a\": [Address.fromEvent($repo).toString()],\n     }\n     const patch = await load({\n       relays: relayArray,\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-1yfd5dmv","title":"From 4cf997876f98ed13e7bef2c98b3ebc73efb1dac7 Mon Sep 17 00:00:00 2001","description":"From 4cf997876f98ed13e7bef2c98b3ebc73efb1dac7 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 21 Jul 2025 21:37:15 -0700\nSubject: [PATCH 5/5] feat: add event renderer component and update project documentation\n\n---\n CLAUDE.md                         | 60 ++++++++++++++++++++++++++++++++++++++++++++++++++----------\n packages/nostr-git                |  2 +-\n src/app/components/Content.svelte |  8 ++++++--\n 3 files changed, 57 insertions(+), 13 deletions(-)\n\ndiff --git a/CLAUDE.md b/CLAUDE.md\nindex e2149e5..65a434f 100644\n--- a/CLAUDE.md\n+++ b/CLAUDE.md\n@@ -1,26 +1,66 @@\n ## Project Overview\n \n-Flotilla is a Discord-like Nostr client that operates on the concept of \"relays as groups/spaces.\" Built with SvelteKit 2.5 and Svelte 5, it provides messaging, threads, calendar events, and social features across Nostr relays.\n+Flotilla-Budabit is a Discord-like client built on the Nostr protocol, designed around the concept of \"relays as groups/spaces.\" Developed with SvelteKit 2.5 and Svelte 5, Flotilla-Budabit enables interactive communication through messaging, threads, calendar events, and comprehensive social interaction, leveraging Nostr relays to manage decentralized content and user interactions.\n+\n+The project has recently expanded to include robust Git integration based on NIP-34, providing seamless collaboration features like issue tracking, repository announcements, patches, and discussions directly through Nostr events.\n+\n+## Technology Stack\n+\n+* **Framework:** SvelteKit 2.5, Svelte 5\n+* **Reactivity:** Svelte 5 runes (`$state`, `$derived`, `$effect`, `$props`)\n+* **Protocol:** Nostr (NIPs: 01, 05, 10, 23, 34, 46, 54, 95)\n+* **Libraries:** `nostr-tools`, `isomorphic-git`, `@nostr-git`\n \n ## Important Patterns\n \n ### Finding Code\n-- Prefer navigating from one file to the next following imports when possible\n-- If search is necessary, use `ack`, not `grep` or `rg`.\n+\n+* Prefer navigating file-by-file using imports.\n+* Use `ack` for search operations instead of `grep` or `rg`.\n \n ### Nostr Event Handling\n-- Prefer seconds to milliseconds when handling nostr events.\n+\n+* Always handle Nostr events using seconds, never milliseconds.\n+* Utilize `nostr-tools` and a centralized `SimplePool` instance for event subscription and publication.\n+\n+### Git/Nostr Integration\n+\n+* Follow the NIP-34 specifications strictly for git-related event handling.\n+* Git state and issue tracking are maintained through reactive components that subscribe to Nostr event streams.\n \n ### Styling Conventions\n-- When styling html, prefer flex/gap classes over margin or space-y classes.\n \n-### Room/space memberships\n+* Favor `flex` and `gap` CSS classes for layout instead of margin-based or space-y classes.\n+* Aim for clarity and simplicity in CSS structure.\n+\n+### Svelte Components\n \n-Memberships are surfaced as \"bookmarks\" to the user.\n+* Use new runes-based syntax: `$state`, `$derived`, `$effect`, `$props`.\n+* Ensure clear encapsulation and documentation within each component.\n+* Components should clearly define reactive properties, computed values, and side effects explicitly.\n+\n+### Room/Space Memberships\n+\n+Memberships appear as user \"bookmarks.\"\n \n ```typescript\n-import {membershipsByPubkey, getMembershipUrls} from '@app/state'\n+import { membershipsByPubkey, getMembershipUrls, getMembershipRooms } from '@app/state';\n \n-const spaces = getMembershipUrls($membershipsByPubkey.get(pubkey))\n-const rooms = getMembershipRooms($membershipsByPubkey.get(pubkey))\n+const spaces = getMembershipUrls($membershipsByPubkey.get(pubkey));\n+const rooms = getMembershipRooms($membershipsByPubkey.get(pubkey));\n ```\n+\n+### Web Worker Usage\n+\n+* Offload intensive tasks (e.g., git operations using `isomorphic-git`) to WebWorkers to maintain UI responsiveness.\n+* Clearly serialize messages using structured clone algorithms for worker thread communication.\n+\n+### Event and Component Patterns\n+\n+* Prefer callback props (`onclick`) over Svelte's deprecated `createEventDispatcher`.\n+* Avoid slot usage; migrate to the new snippet (`{@render ...}`) structure.\n+\n+## Documentation and Code Quality\n+\n+* Maintain robust, clear inline documentation, especially around complex interactions with Nostr and Git.\n+* Clearly comment all reactive logic and component lifecycle events to ensure developer maintainability.\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 2add9f0..621eb91 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 2add9f07ac9f0ebff49a63b934f07c9ff5799b5e\n+Subproject commit 621eb910969b0ed324b7b02af664352afe7c53c4\ndiff --git a/src/app/components/Content.svelte b/src/app/components/Content.svelte\nindex 0d3ad78..15fb27e 100644\n--- a/src/app/components/Content.svelte\n+++ b/src/app/components/Content.svelte\n@@ -32,7 +32,7 @@\n   import ContentTopic from \"@app/components/ContentTopic.svelte\"\n   import ContentMention from \"@app/components/ContentMention.svelte\"\n   import {entityLink, userSettingValues} from \"@app/state\"\n-  import {Template, isKnownUnknown} from \"@nostr-git/ui\"\n+  import {Template, isKnownUnknown, EventRenderer, isKnownEventKind} from \"@nostr-git/ui\"\n \n   interface Props {\n     event: any\n@@ -130,7 +130,11 @@\n       \u003c/p\u003e\n     \u003c/div\u003e\n   {:else}\n-    {#if isKnownUnknown(event.kind)}\n+    {#if isKnownEventKind(event.kind)}\n+      \u003cdiv class=\"event-renderer\"\u003e\n+        \u003cEventRenderer {event} /\u003e\n+      \u003c/div\u003e\n+    {:else if isKnownUnknown(event.kind)}\n       \u003cdiv class=\"unknown-kind\"\u003e\n         {@html new Template(event).render()}\n       \u003c/div\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-21twdbi3","title":"From 756c7f9c0a65834d26eaa784d2f72ae86c40e754 Mon Sep 17 00:00:00 2001","description":"From 756c7f9c0a65834d26eaa784d2f72ae86c40e754 Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/2] updated nostr-git\n\nupdated nostr-git to latest commit","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-23mys2km","title":"From 72c50b376cdc928bbfd3efc4ef362fadc69f9242 Mon Sep 17 00:00:00 2001","description":"From 72c50b376cdc928bbfd3efc4ef362fadc69f9242 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 14 Aug 2025 10:26:34 -0700\nSubject: [PATCH 2/2] feat: add overview navigation function to repository layout\n\n---\n packages/nostr-git                                      | 2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte | 7 +++++++\n 2 files changed, 8 insertions(+), 1 deletion(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 261627e..8cca45e 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 261627e06c4be63e31ce3608a043b6b30a51ea50\n+Subproject commit 8cca45e58173b97fb5478b11ad72b5522b88fbfb\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 6505b3a..0bcb724 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -23,6 +23,7 @@\n   import { load } from \"@welshman/net\"\n   import { Router } from \"@welshman/router\"\n   import { GRASP_SET_KIND, DEFAULT_GRASP_SET_ID, parseGraspServersEvent } from \"@nostr-git/core\"\n+    import { goto } from \"$app/navigation\"\n \n   const {id, relay} = $page.params\n \n@@ -130,6 +131,11 @@\n     })\n   }\n \n+  function overviewRepo() {\n+    if (!repoClass) return\n+    goto(`/spaces/${relay}/git/${id}/`)\n+  }\n+\n   // Connect the nostr-git toast store to the toast component\n   $effect(() =\u003e {\n     if ($toast.length \u003e 0) {\n@@ -165,6 +171,7 @@\n       {isRefreshing}\n       {forkRepo}\n       {settingsRepo}\n+      {overviewRepo}\n       \u003e\n       {#snippet children(activeTab: string)}\n         \u003cRepoTab\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-23xdpbbh","title":"From 7e7d124736594a17239284e926e057da5946879a Mon Sep 17 00:00:00 2001","description":"From 7e7d124736594a17239284e926e057da5946879a Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 16 Nov 2025 21:20:58 +0500\nSubject: [PATCH 1/6] feat: implemented the logic for inline comments in diff viewer\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 48 ++++++++++++++++++++++++++++++++++++++++++++++++\n 1 file changed, 48 insertions(+)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 4f23b5a..a8eeeae 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -345,6 +345,54 @@\n     }\n   })\n \n+  // Transform CommentEvent[] into DiffViewer Comment[] format\n+  const diffComments = $derived.by(() =\u003e {\n+    const comments = $threadComments\n+    if (!comments || comments.length === 0) return []\n+    \n+    return comments.map((commentEvent: CommentEvent) =\u003e {\n+      // Parse line number and file path from comment content\n+      // Format: \"comment text\\n\\n---\\nFile: path\\nLine: 123\"\n+      let lineNumber = 0\n+      let filePath = \"\"\n+      let content = commentEvent.content\n+      \n+      const separatorIndex = content.indexOf('\\n\\n---\\n')\n+      if (separatorIndex !== -1) {\n+        // Extract the actual comment content (before the separator)\n+        content = content.substring(0, separatorIndex).trim()\n+        \n+        // Extract file path and line number from the metadata section\n+        const metadataSection = commentEvent.content.substring(separatorIndex + 6)\n+        const fileMatch = metadataSection.match(/File:\\s*(.+?)(?:\\n|$)/i)\n+        if (fileMatch) {\n+          filePath = fileMatch[1].trim()\n+        }\n+        const lineMatch = metadataSection.match(/Line:\\s*(\\d+)/i)\n+        if (lineMatch) {\n+          lineNumber = parseInt(lineMatch[1], 10)\n+        }\n+      }\n+      \n+      // Get profile information for the author\n+      const profile = $profilesByPubkey.get(commentEvent.pubkey)\n+      const authorName = profile?.name || profile?.display_name || commentEvent.pubkey.slice(0, 8)\n+      const authorAvatar = profile?.picture || \"\"\n+      \n+      return {\n+        id: commentEvent.id || \"\",\n+        lineNumber,\n+        filePath,\n+        content,\n+        author: {\n+          name: authorName,\n+          avatar: authorAvatar,\n+        },\n+        createdAt: new Date(commentEvent.created_at * 1000).toISOString(),\n+      }\n+    })\n+  })\n+\n   const getStatusFilter = () =\u003e ({\n     kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n     \"#e\": [selectedPatch?.id ?? \"\"],\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-28i5jxe6","title":"From 7dd20d1c1bf119d3ca86ba2a0d2a77911cc5ac81 Mon Sep 17 00:00:00 2001","description":"From 7dd20d1c1bf119d3ca86ba2a0d2a77911cc5ac81 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Sat, 10 May 2025 18:18:51 -0700\nSubject: [PATCH 3/3] feat: update repo navigation with encoded relay URLs and add author details to issues/patches\n\n---\n .env                                                          |  2 ++\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte       | 12 +++++++-----\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte  |  3 ++-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte |  4 ++--\n 4 files changed, 13 insertions(+), 8 deletions(-)\n\ndiff --git a/.env b/.env\nindex d774467..4a2ff78 100644\n--- a/.env\n+++ b/.env\n@@ -10,3 +10,5 @@ VITE_PLATFORM_ACCENT=\"#D4AF37\"\n VITE_PLATFORM_DESCRIPTION=\"The Club for Builders in Freedom Tech.\"\n VITE_GLITCHTIP_API_KEY=\n GLITCHTIP_AUTH_TOKEN=\n+VITE_INDEXER_RELAYS=wss://purplepag.es/,wss://relay.damus.io/,wss://relay.nostr.band/\n+VITE_SIGNER_RELAYS=wss://relay.nsec.app/,wss://bucket.coracle.social/\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 89d3c03..eda9862 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -6,6 +6,8 @@\n   import {FileCode, GitBranch, CircleAlert, GitPullRequest, Book} from \"@lucide/svelte\"\n   import {type RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n   const {id, relay} = $page.params\n+  // Decode params for use in the app\n+  const encodeddRelay = encodeURIComponent(relay)\n   const relayArray = Array.isArray(relay) ? relay : [relay]\n   const eventStore = deriveNaddrEvent(id, relayArray)\n   let {children} = $props()\n@@ -20,27 +22,27 @@\n   {:else}\n     \u003cRepoHeader event={$eventStore as RepoAnnouncementEvent} activeTab={activeTab}\u003e\n       {#snippet children(activeTab)}\n-        \u003cRepoTab tabValue=\"overview\" label=\"Overview\" href=\".\" {activeTab}\u003e\n+        \u003cRepoTab tabValue=\"overview\" label=\"Overview\" href={`/spaces/${encodeddRelay}/git/${id}`} {activeTab}\u003e\n           {#snippet icon()}\n             \u003cFileCode class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab tabValue=\"code\" label=\"Code\" href=\"code\" {activeTab}\u003e\n+        \u003cRepoTab tabValue=\"code\" label=\"Code\" href={`/spaces/${encodeddRelay}/git/${id}/code`} {activeTab}\u003e\n           {#snippet icon()}\n             \u003cGitBranch class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab tabValue=\"issues\" label=\"Issues\" href=\"issues\" {activeTab}\u003e\n+        \u003cRepoTab tabValue=\"issues\" label=\"Issues\" href={`/spaces/${encodeddRelay}/git/${id}/issues`} {activeTab}\u003e\n           {#snippet icon()}\n             \u003cCircleAlert class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab tabValue=\"patches\" label=\"Patches\" href=\"patches\" {activeTab}\u003e\n+        \u003cRepoTab tabValue=\"patches\" label=\"Patches\" href={`/spaces/${encodeddRelay}/git/${id}/patches`} {activeTab}\u003e\n           {#snippet icon()}\n             \u003cGitPullRequest class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab tabValue=\"wiki\" label=\"Wiki\" href=\"wiki\" {activeTab}\u003e\n+        \u003cRepoTab tabValue=\"wiki\" label=\"Wiki\" href={`/spaces/${encodeddRelay}/git/${id}/wiki`} {activeTab}\u003e\n           {#snippet icon()}\n             \u003cBook class=\"h-4 w-4\" /\u003e\n           {/snippet}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex f459c16..58c4a5a 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -9,6 +9,7 @@\n   import {onMount} from \"svelte\"\n   import {setChecked} from \"@src/app/notifications\"\n   import {nthEq} from \"@welshman/lib\"\n+  import {deriveProfile} from \"@welshman/app\"\n   const {id, relay} = $page.params\n   const relayArray = Array.isArray(relay) ? relay : [relay]\n   const repo = deriveNaddrEvent(id)\n@@ -59,6 +60,6 @@\n   \u003c/div\u003e\n \n   {#each issues as issue}\n-    \u003cIssueCard event={issue} /\u003e\n+    \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)}/\u003e\n   {/each}\n \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 10a7b67..45e5305 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -5,7 +5,7 @@\n   import {setChecked} from \"@src/app/notifications\"\n   import {deriveNaddrEvent} from \"@src/app/state\"\n   import {load} from \"@welshman/net\"\n-  import {Address, GIT_PATCH} from \"@welshman/util\"\n+  import {Address, displayPubkey, GIT_PATCH} from \"@welshman/util\"\n   import {onMount} from \"svelte\"\n \n   const {id, relay} = page.params\n@@ -55,6 +55,6 @@\n   \u003c/div\u003e\n \n   {#each patches as patch}\n-    \u003cPatchCard event={patch} /\u003e\n+    \u003cPatchCard event={patch} owner={displayPubkey(patch.pubkey)}/\u003e\n   {/each}\n \u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-2c4ae84z","title":"From e9c499f55ccbe06859b2912e2ef665e5ccf333df Mon Sep 17 00:00:00 2001","description":"From e9c499f55ccbe06859b2912e2ef665e5ccf333df Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/1] Refactor and new features for Issues and Patches\n\nThis patch includes a refactoring of the event loading code for Issues and Patches as well as new features including filters for both lists and status editing for Issues","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-2dldo9x0","title":"NIP29 groups appear as rooms in BudaBit?","description":"There is a potential bug where Flotilla code tries to fetch nip29 groups *from other relays* . NIP29 groups in BudaBit are rooms, but these groups are potentially added in BudaBit to the 'Rooms' section.\nNeeds verification and some testing.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue","question","rooms","v1"]}
{"id":"flotilla-2h5s0poj","title":"From b911bcb28f6a128b726b342e6e8e55ced3848123 Mon Sep 17 00:00:00 2001","description":"From b911bcb28f6a128b726b342e6e8e55ced3848123 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 9 Nov 2025 16:03:26 +0500\nSubject: [PATCH] feat: add tabs, search, and URI support to git repos page\n\n- Add 'My Repos' and 'Bookmarks' tabs with icons\n- Add search bar with responsive layout (mobile/desktop)\n- Implement URI search: detect and fetch repos via naddr/nostr:naddr\n- Add 'Bookmark a Repo' button in bookmarks tab\n- Improve responsive design: tabs use flexbox for equal sizing on mobile\n- Show 'Found Repository' section when URI search matches a repo\n- Normal search filters repos within current tab\n---\n src/routes/spaces/[relay]/git/+page.svelte | 298 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------\n 1 file changed, 272 insertions(+), 26 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 79eb5da..a1f56ac 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -40,6 +40,10 @@\n     RepoPicker,\n     bookmarksStore,\n     repositoriesStore,\n+    Tabs,\n+    TabsContent,\n+    TabsList,\n+    TabsTrigger,\n   } from \"@nostr-git/ui\"\n   import NewRepoWizardWrapper from \"@app/components/NewRepoWizardWrapper.svelte\"\n   import {\n@@ -47,15 +51,20 @@\n     deriveMaintainersForEuc,\n     loadRepoAnnouncements,\n     derivePatchGraph,\n+    deriveNaddrEvent,\n   } from \"@lib/budabit/state\"\n   import {getInitializedGitWorker} from \"@src/lib/budabit/worker-singleton\"\n   import AddCircle from \"@assets/icons/add-circle.svg?dataurl\"\n   import Bookmark from \"@assets/icons/bookmark.svg?dataurl\"\n   import Git from \"@assets/icons/git.svg?dataurl\"\n+  import Magnifier from \"@assets/icons/magnifier.svg?dataurl\"\n+  import FolderWithFiles from \"@assets/icons/folder-with-files.svg?dataurl\"\n \n   const url = decodeRelay($page.params.relay)\n \n   let loading = $state(true)\n+  let activeTab = $state\u003c\"my-repos\" | \"bookmarks\"\u003e(\"bookmarks\")\n+  let searchQuery = $state(\"\")\n \n   // Initialize worker for Git operations\n   // Note: Not using $state because Comlink proxies don't work well with Svelte reactivity\n@@ -70,6 +79,12 @@\n     } catch (error) {\n       console.error(\"[+page.svelte] Failed to initialize worker:\", error)\n     }\n+    \n+    // Load my repos on mount\n+    if ($pubkey) {\n+      const filter = {kinds: [GIT_REPO_ANNOUNCEMENT], authors: [$pubkey]}\n+      load({relays: bookmarkRelays, filters: [filter]})\n+    }\n   })\n \n   // Normalize all relay URLs to avoid whitespace/trailing-slash/socket issues\n@@ -165,12 +180,131 @@\n     })\n   })\n \n-  // Update repositoriesStore whenever loadedBookmarkedRepos changes\n+  const myReposEvents = $derived.by(() =\u003e {\n+    if (!$pubkey) return undefined\n+    const filter = {kinds: [GIT_REPO_ANNOUNCEMENT], authors: [$pubkey]} as any\n+    return deriveEvents(repository, {filters: [filter]})\n+  })\n+\n+  const loadedMyRepos = $derived.by(() =\u003e {\n+    if (!$myReposEvents) return []\n+    \n+    return $myReposEvents.map(repo =\u003e {\n+      let addressString = \"\"\n+      try {\n+        const address = Address.fromEvent(repo)\n+        addressString = address.toString()\n+      } catch (e) {\n+        const dTag = (repo.tags || []).find((t: string[]) =\u003e t[0] === \"d\")?.[1]\n+        if (dTag \u0026\u0026 repo.pubkey \u0026\u0026 repo.kind) {\n+          addressString = `${repo.kind}:${repo.pubkey}:${dTag}`\n+        }\n+      }\n+\n+      const relayHintFromEvent = Router.get().getRelaysForPubkey(repo.pubkey)?.[0]\n+      return {address: addressString, event: repo, relayHint: relayHintFromEvent || \"\"}\n+    })\n+  })\n+\n+\n+  // Filter repos based on active tab\n+  const filteredRepos = $derived.by(() =\u003e {\n+    if (activeTab === \"bookmarks\") {\n+      return loadedBookmarkedRepos\n+    } else {\n+      return loadedMyRepos\n+    }\n+  })\n+\n+  // Detect if search query is a URI (naddr or nostr:naddr)\n+  const isUriSearch = $derived.by(() =\u003e {\n+    const trimmed = searchQuery.trim()\n+    return trimmed.startsWith(\"naddr1\") || trimmed.startsWith(\"nostr:naddr1\")\n+  })\n+\n+  // Extract naddr from search query (handle both naddr1... and nostr:naddr1...)\n+  const extractedNaddr = $derived.by(() =\u003e {\n+    if (!isUriSearch) return null\n+    const trimmed = searchQuery.trim()\n+    if (trimmed.startsWith(\"nostr:\")) {\n+      return trimmed.replace(\"nostr:\", \"\")\n+    }\n+    return trimmed\n+  })\n+\n+  // Fetch event for URI search\n+  const uriSearchEvent = $derived.by(() =\u003e {\n+    if (!extractedNaddr) return null\n+    const naddr = extractedNaddr\n+    \n+    try {\n+      const decoded = nip19.decode(naddr) as {type: string; data: any}\n+      // Only fetch if it's a repo announcement (kind 30617)\n+      if (decoded.type === \"naddr\" \u0026\u0026 decoded.data.kind === GIT_REPO_ANNOUNCEMENT) {\n+        const eventStore = deriveNaddrEvent(naddr, bookmarkRelays)\n+        return getStore(eventStore)\n+      }\n+    } catch (e) {\n+      console.error(\"[+page.svelte] Failed to decode naddr:\", e)\n+    }\n+    return null\n+  })\n+\n+  // Convert URI search event to repo card format if found\n+  const uriSearchRepo = $derived.by(() =\u003e {\n+    const event = uriSearchEvent\n+    if (!event) return null\n+\n+    try {\n+      let addressString = \"\"\n+      try {\n+        const address = Address.fromEvent(event)\n+        addressString = address.toString()\n+      } catch (e) {\n+        const dTag = (event.tags || []).find((t: string[]) =\u003e t[0] === \"d\")?.[1]\n+        if (dTag \u0026\u0026 event.pubkey \u0026\u0026 event.kind) {\n+          addressString = `${event.kind}:${event.pubkey}:${dTag}`\n+        }\n+      }\n+\n+      const relayHintFromEvent = Router.get().getRelaysForPubkey(event.pubkey)?.[0]\n+      return {address: addressString, event: event, relayHint: relayHintFromEvent || \"\"}\n+    } catch (e) {\n+      console.error(\"[+page.svelte] Failed to process URI search event:\", e)\n+      return null\n+    }\n+  })\n+\n+  // Filter repos based on search query (from current tab) \n+  const searchFilteredRepos = $derived.by(() =\u003e {\n+    const repos = filteredRepos\n+    // If URI search, don't filter tab repos (URI search shows in separate section)\n+    if (isUriSearch) return repos\n+    \n+    if (!searchQuery.trim()) return repos\n+\n+    const query = searchQuery.toLowerCase().trim()\n+    return repos.filter(repo =\u003e {\n+      try {\n+        // Cast event to RepoAnnouncementEvent for parsing\n+        const parsed = parseRepoAnnouncementEvent(repo.event as any)\n+        const title = parsed?.name || \"\"\n+        const description = parsed?.description || \"\"\n+        return title.toLowerCase().includes(query) || description.toLowerCase().includes(query)\n+      } catch {\n+        return false\n+      }\n+    })\n+  })\n+\n+  // Store for URI search repo card\n+  let uriSearchRepoCard = $state\u003cany[]\u003e([])\n+\n+  // Update URI search repo card\n   $effect(() =\u003e {\n-    if (loadedBookmarkedRepos.length \u003e 0) {\n-      loading = false\n-      // Compute cards using the store's method\n-      const cards = repositoriesStore.computeCards(loadedBookmarkedRepos, {\n+    const repo = uriSearchRepo\n+    if (repo) {\n+      const cards = repositoriesStore.computeCards([repo], {\n         deriveMaintainersForEuc,\n         deriveRepoRefState,\n         derivePatchGraph,\n@@ -179,9 +313,32 @@\n         nip19,\n         Address,\n       })\n-      repositoriesStore.set(cards)\n+      uriSearchRepoCard = cards\n     } else {\n-      repositoriesStore.clear()\n+      uriSearchRepoCard = []\n+    }\n+  })\n+\n+  // Update repositoriesStore whenever repos change\n+  $effect(() =\u003e {\n+    const reposToShow = searchFilteredRepos\n+    if (reposToShow.length \u003e 0 || !loading) {\n+      loading = false\n+      if (reposToShow.length \u003e 0) {\n+        // Compute cards using the store's method\n+        const cards = repositoriesStore.computeCards(reposToShow, {\n+          deriveMaintainersForEuc,\n+          deriveRepoRefState,\n+          derivePatchGraph,\n+          parseRepoAnnouncementEvent,\n+          Router,\n+          nip19,\n+          Address,\n+        })\n+        repositoriesStore.set(cards)\n+      } else {\n+        repositoriesStore.clear()\n+      }\n     }\n   })\n \n@@ -424,41 +581,130 @@\n   {/snippet}\n   {#snippet action()}\n     \u003cdiv class=\"row-2\"\u003e\n-      \u003cnav class=\"w-full rounded-md bg-muted text-muted-foreground\"\u003e\n-        \u003cdiv class=\"scrollbar-hide flex overflow-x-auto\"\u003e\n-          \u003cdiv class=\"m-1 flex w-full min-w-max justify-evenly gap-1\"\u003e\n-          \u003c/div\u003e\n-        \u003c/div\u003e\n-      \u003c/nav\u003e\n-      \u003cButton class=\"btn btn-secondary btn-sm\" onclick={() =\u003e onNewRepo()}\u003e\n+      \u003cButton class=\"btn btn-primary btn-sm\" onclick={() =\u003e onNewRepo()}\u003e\n         \u003cIcon icon={AddCircle} /\u003e\n         New Repo\n       \u003c/Button\u003e\n-      \u003cButton class=\"btn btn-primary btn-sm\" onclick={() =\u003e onAddRepo()}\u003e\n-        \u003cIcon icon={Bookmark} /\u003e\n-        My Repos\n-      \u003c/Button\u003e\n-      \u003cButton class=\"btn btn-primary btn-sm\" onclick={() =\u003e onAddRepo()}\u003e\n-        \u003cIcon icon={Git} /\u003e\n-        All Repos\n-      \u003c/Button\u003e\n     \u003c/div\u003e\n   {/snippet}\n \u003c/PageBar\u003e\n \n-\u003cPageContent class=\"mt-4 flex flex-grow flex-col gap-2 overflow-auto p-2\"\u003e\n+\u003cPageContent class=\"mt-4 flex flex-grow flex-col gap-4 overflow-auto p-2\"\u003e\n+  \u003c!-- Tabs and Search Bar --\u003e\n+  \u003cdiv class=\"flex flex-col gap-3\"\u003e\n+    \u003cTabs bind:value={activeTab} class=\"w-full\"\u003e\n+      \u003cdiv class=\"flex flex-col gap-3\"\u003e\n+        \u003cdiv class=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3\"\u003e\n+          \u003cTabsList class=\"flex w-full sm:w-auto\"\u003e\n+            \u003cTabsTrigger value=\"my-repos\" class=\"flex-1 sm:flex-none\"\u003e\n+              \u003cspan class=\"flex items-center gap-2\"\u003e\n+                \u003cIcon icon={FolderWithFiles} /\u003e\n+                \u003cspan\u003eMy Repos\u003c/span\u003e\n+              \u003c/span\u003e\n+            \u003c/TabsTrigger\u003e\n+            \u003cTabsTrigger value=\"bookmarks\" class=\"flex-1 sm:flex-none\"\u003e\n+              \u003cspan class=\"flex items-center gap-2\"\u003e\n+                \u003cIcon icon={Bookmark} /\u003e\n+                \u003cspan\u003eBookmarks\u003c/span\u003e\n+              \u003c/span\u003e\n+            \u003c/TabsTrigger\u003e\n+          \u003c/TabsList\u003e\n+          \u003cdiv class=\"flex flex-col sm:flex-row gap-2 sm:items-center w-full sm:w-auto\"\u003e\n+            {#if activeTab === \"bookmarks\"}\n+              \u003cButton class=\"btn btn-primary btn-sm order-2 sm:order-1 w-full sm:w-auto\" onclick={onAddRepo}\u003e\n+                \u003cIcon icon={Bookmark} /\u003e\n+                \u003cspan\u003eBookmark a Repo\u003c/span\u003e\n+              \u003c/Button\u003e\n+            {/if}\n+            \u003clabel class=\"input input-bordered flex w-full sm:w-auto sm:max-w-md items-center gap-2 order-1 sm:order-2\"\u003e\n+              \u003cIcon icon={Magnifier} /\u003e\n+              \u003cinput\n+                bind:value={searchQuery}\n+                class=\"grow\"\n+                type=\"text\"\n+                placeholder=\"Search repositories...\" /\u003e\n+            \u003c/label\u003e\n+          \u003c/div\u003e\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    \u003c/Tabs\u003e\n+  \u003c/div\u003e\n+\n+  \u003c!-- URI Search Result (if found) --\u003e\n+  {#if uriSearchRepoCard.length \u003e 0}\n+    \u003cdiv class=\"flex flex-col gap-2\"\u003e\n+      \u003ch3 class=\"text-sm font-semibold text-muted-foreground\"\u003eFound Repository\u003c/h3\u003e\n+      \u003cdiv class=\"grid gap-3 md:grid-cols-2 xl:grid-cols-3\"\u003e\n+        {#each uriSearchRepoCard as g (g.repoNaddr || g.euc)}\n+          \u003cdiv class=\"rounded-md border border-border bg-card p-3\" in:fly\u003e\n+            {#if g.first}\n+              \u003cGitItem\n+                {url}\n+                event={g.first as any}\n+                showActivity={true}\n+                showIssues={true}\n+                showActions={true} /\u003e\n+            {/if}\n+            \u003cdiv class=\"mt-3 flex items-center justify-between\"\u003e\n+              \u003cdiv class=\"flex items-center gap-2\"\u003e\n+                \u003cdiv class=\"flex -space-x-2\"\u003e\n+                  {#each g.maintainers.slice(0, 4) as pk (pk)}\n+                    {@const prof = $profilesByPubkey.get(pk)}\n+                    \u003cAvatar class=\"h-6 w-6 border\" title={prof?.display_name || prof?.name || pk}\u003e\n+                      \u003cAvatarImage src={prof?.picture} alt={prof?.name || pk} /\u003e\n+                      \u003cAvatarFallback\n+                        \u003e{(prof?.display_name || prof?.name || pk)\n+                          .slice(0, 2)\n+                          .toUpperCase()}\u003c/AvatarFallback\u003e\n+                    \u003c/Avatar\u003e\n+                  {/each}\n+                  {#if g.maintainers.length \u003e 4}\n+                    \u003cdiv\n+                      class=\"grid h-6 w-6 place-items-center rounded-full border bg-muted text-[10px]\"\u003e\n+                      +{g.maintainers.length - 4}\n+                    \u003c/div\u003e\n+                  {/if}\n+                \u003c/div\u003e\n+                \u003cspan class=\"text-xs opacity-60\"\n+                  \u003e{g.maintainers.length} maintainer{g.maintainers.length !== 1 ? \"s\" : \"\"}\u003c/span\u003e\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          \u003c/div\u003e\n+        {/each}\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  {/if}\n+\n+  \u003c!-- Tab-filtered Repos Grid --\u003e\n   \u003cdiv\u003e\n-    {#if loading}\n+    {#if loading \u0026\u0026 !uriSearchRepoCard.length}\n       \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n         \u003cSpinner {loading}\u003e\n           {#if loading}\n             Looking for Your Git Repos...\n-          {:else if !$repos || $repos.length === 0}\n+          {:else if $repositoriesStore.length === 0}\n             No Repos found.\n           {/if}\n         \u003c/Spinner\u003e\n       \u003c/p\u003e\n-    {:else}\n+    {:else if $repositoriesStore.length === 0 \u0026\u0026 !uriSearchRepoCard.length}\n+      \u003cp class=\"flex h-10 items-center justify-center py-20 text-muted-foreground\"\u003e\n+        {#if searchQuery.trim() \u0026\u0026 !isUriSearch}\n+          No repositories found matching \"{searchQuery}\".\n+        {:else if isUriSearch \u0026\u0026 !uriSearchRepoCard.length}\n+          Repository not found. Please check the URI.\n+        {:else if activeTab === \"my-repos\"}\n+          You haven't created any repositories yet.\n+        {:else}\n+          No bookmarked repositories found.\n+        {/if}\n+      \u003c/p\u003e\n+    {:else if $repositoriesStore.length \u003e 0}\n+      {#if uriSearchRepoCard.length \u003e 0}\n+        \u003ch3 class=\"text-sm font-semibold text-muted-foreground mb-2\"\u003e\n+          {activeTab === \"my-repos\" ? \"My Repositories\" : \"Bookmarked Repositories\"}\n+        \u003c/h3\u003e\n+      {/if}\n       \u003cdiv class=\"grid gap-3 md:grid-cols-2 xl:grid-cols-3\"\u003e\n         {#each $repositoriesStore as g (g.repoNaddr || g.euc)}\n           \u003cdiv class=\"rounded-md border border-border bg-card p-3\" in:fly\u003e\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-2ks84x3o","title":"From f18d5993555d705bb719481e63b1786078397148 Mon Sep 17 00:00:00 2001","description":"From f18d5993555d705bb719481e63b1786078397148 Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/1] optimize git repository navigation with non-blocking data loading\n\n ","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-2wi1sgcm","title":"test","description":"test","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T18:05:15.830656-08:00","closed_at":"2026-01-24T18:05:15.830656-08:00","close_reason":"Test/placeholder issue - closing as invalid","labels":["bug","draft","issue","test"]}
{"id":"flotilla-2zysy1ss","title":"How to add an issue label after posting?","description":"The kind 1621 is not replaceable so there is no simple way to do this. This is a very common thing to add extra labels to issues after they have been posted.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["issue","question"]}
{"id":"flotilla-3lfdlav8","title":"From e61f9bec9f2f76f6617df20eb12c4ad931fd3a1c Mon Sep 17 00:00:00 2001","description":"From e61f9bec9f2f76f6617df20eb12c4ad931fd3a1c Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Sat, 5 Jul 2025 15:23:36 -0700\nSubject: [PATCH 4/4] refactor: simplify git feed layout and remove unused components\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte    |   3 +--\n src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte | 121 +++++++++++++++++++++++++++++++++++--------------------------------------------------------------------------------------\n 2 files changed, 36 insertions(+), 88 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex f8ff9fe..2c24058 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -1,7 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n   import { RepoHeader, RepoTab, toast} from \"@nostr-git/ui\"\n   import {ConfigProvider} from \"@nostr-git/ui\"\n-  import {FileCode, GitBranch, CircleAlert, GitPullRequest, PencilRuler, GitCommit, Layers} from \"@lucide/svelte\"\n+  import {FileCode, GitBranch, CircleAlert, GitPullRequest, GitCommit, Layers} from \"@lucide/svelte\"\n   import {page} from \"$app/stores\"\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n   import Avatar from \"@lib/components/Avatar.svelte\"\n@@ -11,7 +11,6 @@\n   import Input from \"@lib/components/Field.svelte\"\n   import Dialog from \"@lib/components/Dialog.svelte\"\n   import {pushToast} from \"@src/app/toast\"\n-  import { REPO_KEY, REPO_RELAYS_KEY } from \"@src/app/state.js\"\n \n   const {id, relay} = $page.params\n \ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte\nindex a366ad4..e847708 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte\n@@ -1,11 +1,10 @@\n \u003cscript lang=\"ts\"\u003e\n-  import cx from \"classnames\"\n   import {readable} from \"svelte/store\"\n   import {onMount, onDestroy} from \"svelte\"\n   import {page} from \"$app/stores\"\n   import type {Readable} from \"svelte/store\"\n   import {now, formatTimestampAsDate} from \"@welshman/lib\"\n-  import {load, request} from \"@welshman/net\"\n+  import {load} from \"@welshman/net\"\n   import type {TrustedEvent, EventContent} from \"@welshman/util\"\n   import {\n     makeEvent,\n@@ -13,8 +12,6 @@\n     MESSAGE,\n     DELETE,\n     REACTION,\n-    ROOM_ADD_USER,\n-    ROOM_REMOVE_USER,\n     GIT_ISSUE,\n     GIT_PATCH,\n     Address,\n@@ -30,22 +27,16 @@\n     getThunkError,\n     joinRoom,\n     leaveRoom,\n-    deriveRelay,\n   } from \"@welshman/app\"\n   import {slide, fade, fly} from \"@lib/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n   import Spinner from \"@lib/components/Spinner.svelte\"\n-  import PageBar from \"@lib/components/PageBar.svelte\"\n-  import PageContent from \"@lib/components/PageContent.svelte\"\n   import Divider from \"@lib/components/Divider.svelte\"\n-  import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n-  import ChannelName from \"@app/components/ChannelName.svelte\"\n   import ChannelMessage from \"@app/components/ChannelMessage.svelte\"\n   import ChannelCompose from \"@app/components/ChannelCompose.svelte\"\n   import ChannelComposeParent from \"@app/components/ChannelComposeParent.svelte\"\n   import {\n-    userRoomsByUrl,\n     userSettingValues,\n     decodeRelay,\n     deriveUserMembershipStatus,\n@@ -53,7 +44,7 @@\n     MembershipStatus,\n   } from \"@app/state\"\n   import {setChecked, checked} from \"@app/notifications\"\n-  import {addRoomMembership, removeRoomMembership, prependParent} from \"@app/commands\"\n+  import {prependParent} from \"@app/commands\"\n   import {PROTECTED} from \"@app/state\"\n   import {makeFeed} from \"@app/requests\"\n   import {popKey} from \"@app/implicit\"\n@@ -91,14 +82,8 @@\n \n   const filter = [roomFilter, issueFilter, patchFilter, statusFilter, commentFilter]\n \n-  const isFavorite = $derived($userRoomsByUrl.get(url)?.has(room))\n   const membershipStatus = deriveUserMembershipStatus(url, room)\n \n-  const addFavorite = () =\u003e addRoomMembership(url, room)\n-\n-  const removeFavorite = () =\u003e removeRoomMembership(url, room)\n-  const relay = deriveRelay(url)\n-\n   const join = async () =\u003e {\n     joining = true\n \n@@ -294,21 +279,6 @@\n   }\n \n   onMount(() =\u003e {\n-    const controller = new AbortController()\n-\n-    request({\n-      signal: controller.signal,\n-      relays: [url],\n-      filters: [\n-        {\n-          kinds: [ROOM_ADD_USER, ROOM_REMOVE_USER],\n-          \"#p\": [$pubkey!],\n-          \"#h\": [room],\n-          limit: 10,\n-        },\n-      ],\n-    })\n-\n     const observer = new ResizeObserver(() =\u003e {\n       if (dynamicPadding \u0026\u0026 chatCompose) {\n         dynamicPadding!.style.minHeight = `${chatCompose!.offsetHeight}px`\n@@ -320,14 +290,13 @@\n     start()\n \n     return () =\u003e {\n-      controller.abort()\n       observer.unobserve(chatCompose!)\n       observer.unobserve(dynamicPadding!)\n     }\n   })\n \n   onDestroy(() =\u003e {\n-    cleanup()\n+    cleanup?.()\n \n     // Sveltekit calls onDestroy at the beginning of the page load for some reason\n     setTimeout(() =\u003e {\n@@ -336,60 +305,40 @@\n   })\n \u003c/script\u003e\n \n-\u003cdiv bind:this={element} onscroll={onScroll} class=\"flex flex-col-reverse pt-4\"\u003e\n+\u003cdiv\n+  bind:this={element}\n+  onscroll={onScroll}\n+  class=\"scroll-container cw md:bottom-sai fixed bottom-[calc(var(--saib)+3.5rem)] top-[calc(var(--sait)+16em)] flex flex-col-reverse overflow-y-auto overflow-x-hidden px-6 w-full\"\u003e\n   \u003cdiv bind:this={dynamicPadding}\u003e\u003c/div\u003e\n-  {#if $channel?.private \u0026\u0026 $membershipStatus !== MembershipStatus.Granted}\n-    \u003cdiv class=\"py-20\"\u003e\n-      \u003cdiv class=\"card2 col-8 m-auto max-w-md items-center text-center\"\u003e\n-        \u003cp class=\"row-2\"\u003eYou aren't currently a member of this room.\u003c/p\u003e\n-        {#if $membershipStatus === MembershipStatus.Pending}\n-          \u003cButton class=\"btn btn-neutral btn-sm\" disabled={leaving} onclick={leave}\u003e\n-            \u003cIcon icon=\"clock-circle\" /\u003e\n-            Access Pending\n-          \u003c/Button\u003e\n-        {:else}\n-          \u003cButton class=\"btn btn-neutral btn-sm\" disabled={joining} onclick={join}\u003e\n-            {#if joining}\n-              \u003cspan class=\"loading loading-spinner loading-sm\"\u003e\u003c/span\u003e\n-            {:else}\n-              \u003cIcon icon=\"login-2\" /\u003e\n-            {/if}\n-            Join Room\n-          \u003c/Button\u003e\n-        {/if}\n+  {#each elements as { type, id, value, showPubkey } (id)}\n+    {#if type === \"new-messages\"}\n+      \u003cdiv\n+        bind:this={newMessages}\n+        class=\"flex items-center py-2 text-xs transition-colors\"\n+        class:opacity-0={showFixedNewMessages}\u003e\n+        \u003cdiv class=\"h-px flex-grow bg-primary\"\u003e\u003c/div\u003e\n+        \u003cp class=\"rounded-full bg-primary px-2 py-1 text-primary-content\"\u003eNew Messages\u003c/p\u003e\n+        \u003cdiv class=\"h-px flex-grow bg-primary\"\u003e\u003c/div\u003e\n       \u003c/div\u003e\n-    \u003c/div\u003e\n-  {:else}\n-    {#each elements as { type, id, value, showPubkey } (id)}\n-      {#if type === \"new-messages\"}\n-        \u003cdiv\n-          bind:this={newMessages}\n-          class=\"flex items-center py-2 text-xs transition-colors\"\n-          class:opacity-0={showFixedNewMessages}\u003e\n-          \u003cdiv class=\"h-px flex-grow bg-primary\"\u003e\u003c/div\u003e\n-          \u003cp class=\"rounded-full bg-primary px-2 py-1 text-primary-content\"\u003eNew Messages\u003c/p\u003e\n-          \u003cdiv class=\"h-px flex-grow bg-primary\"\u003e\u003c/div\u003e\n-        \u003c/div\u003e\n-      {:else if type === \"date\"}\n-        \u003cDivider\u003e{value}\u003c/Divider\u003e\n-      {:else}\n-        \u003cdiv in:slide class:-mt-1={!showPubkey}\u003e\n-          \u003cChannelMessage\n-            {url}\n-            {replyTo}\n-            event={$state.snapshot(value as TrustedEvent)}\n-            {showPubkey} /\u003e\n-        \u003c/div\u003e\n-      {/if}\n-    {/each}\n-    \u003cp class=\"flex h-10 items-center justify-center py-20\"\u003e\n-      {#if loadingEvents}\n-        \u003cSpinner loading={loadingEvents}\u003eLooking for messages...\u003c/Spinner\u003e\n-      {:else}\n-        \u003cSpinner\u003eEnd of message history\u003c/Spinner\u003e\n-      {/if}\n-    \u003c/p\u003e\n-  {/if}\n+    {:else if type === \"date\"}\n+      \u003cDivider\u003e{value}\u003c/Divider\u003e\n+    {:else}\n+      \u003cdiv in:slide class:-mt-1={!showPubkey}\u003e\n+        \u003cChannelMessage\n+          {url}\n+          {replyTo}\n+          event={$state.snapshot(value as TrustedEvent)}\n+          {showPubkey} /\u003e\n+      \u003c/div\u003e\n+    {/if}\n+  {/each}\n+  \u003cp class=\"flex h-10 items-center justify-center py-20\"\u003e\n+    {#if loadingEvents}\n+      \u003cSpinner loading={loadingEvents}\u003eLooking for messages...\u003c/Spinner\u003e\n+    {:else}\n+      \u003cSpinner\u003eEnd of message history\u003c/Spinner\u003e\n+    {/if}\n+  \u003c/p\u003e\n \u003c/div\u003e\n \n \u003cdiv class=\"chat__compose bg-base-200\" bind:this={chatCompose}\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-3mji3a7o","title":"From d449470777405fb8e9379c39516f177edb877ef2 Mon Sep 17 00:00:00 2001","description":"From d449470777405fb8e9379c39516f177edb877ef2 Mon Sep 17 00:00:00 2001\nFrom: Five \u003cco22rkn@protonmail.com\u003e\nDate: Sun, 13 Jul 2025 13:35:17 +0200\nSubject: [PATCH 1/1] added test file for patch testing\n\n---\n test_patches.txt | 0\n 1 file changed, 0 insertions(+), 0 deletions(-)\n create mode 100644 test_patches.txt\n\ndiff --git a/test_patches.txt b/test_patches.txt\nnew file mode 100644\nindex 0000000..e69de29\n--- /dev/null\n+++ b/test_patches.txt\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-3mrmd8zz","title":"From e62f7b5fcff92f8d31525ee4c6bde0f8e0c51131 Mon Sep 17 00:00:00 2001","description":"From e62f7b5fcff92f8d31525ee4c6bde0f8e0c51131 Mon Sep 17 00:00:00 2001\nFrom: Five \u003cco22rkn@protonmail.com\u003e\nDate: Fri, 20 Jun 2025 12:24:38 +0200\nSubject: [PATCH 4/8] Deleted unused repo.ts\n\n---\n src/lib/repo.ts | 81 ---------------------------------------------------------------------------------\n 1 file changed, 81 deletions(-)\n delete mode 100644 src/lib/repo.ts\n\ndiff --git a/src/lib/repo.ts b/src/lib/repo.ts\ndeleted file mode 100644\nindex 477fe7e..0000000\n--- a/src/lib/repo.ts\n+++ /dev/null\n@@ -1,81 +0,0 @@\n-import { derived, get } from 'svelte/store';\n-import { parseRepoAnnouncementEvent, type CommentEvent, type IssueEvent, type RepoAnnouncementEvent } from '@nostr-git/shared-types';\n-import { deriveNaddrEvent } from '@src/app/state';\n-import { deriveEvents } from '@welshman/store';\n-import { publishThunk, repository } from '@welshman/app';\n-import { GIT_ISSUE, GIT_PATCH, type Filter } from '@welshman/util';\n-import { Address } from '@welshman/util';\n-import { GIT_REPO_STATE } from '@src/lib/util';\n-import { nthEq } from '@welshman/lib';\n-\n-\n-export function createRepoModel({ id, relay }: { id: string; relay: string }) {\n-    const repoEvent = deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay]);\n-\n-    const issues = derived(repoEvent, $repoEvent =\u003e {\n-        if (!$repoEvent) return [];\n-        const address = Address.fromEvent($repoEvent).toString();\n-        const issueFilter = [{ kinds: [GIT_ISSUE], \"#a\": [address] }];\n-        return deriveEvents(repository, { filters: issueFilter });\n-    });\n-\n-    const patches = derived(repoEvent, $repoEvent =\u003e {\n-        if (!$repoEvent) return [];\n-        const address = Address.fromEvent($repoEvent).toString();\n-        const patchFilter = [{ kinds: [GIT_PATCH], \"#a\": [address], \"#t\": [\"root\"] }];\n-        return deriveEvents(repository, { filters: patchFilter });\n-    });\n-\n-    const repoState = derived(repoEvent, $repoEvent =\u003e {\n-        if (!$repoEvent) return null;\n-        const repoAnn = parseRepoAnnouncementEvent($repoEvent as RepoAnnouncementEvent);\n-        const address = repoAnn.repoId;\n-        const repoStateFilter: Filter[] = [\n-            { kinds: [GIT_REPO_STATE], \"#d\": [address!] },\n-        ];\n-        return deriveEvents(repository, { filters: repoStateFilter });\n-    });\n-\n-    const relays = derived(repoEvent, $repoEvent =\u003e {\n-        if ($repoEvent) {\n-            const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || [];\n-            return relays;\n-        }\n-    });\n-\n-    function postComment(comment: CommentEvent) {\n-        const currentRelays = get(relays);\n-        if (!currentRelays?.length) {\n-            console.error('No relays available for posting comment');\n-            return Promise.reject('No relays available');\n-        }\n-\n-        return publishThunk({\n-            relays: currentRelays,\n-            event: comment,\n-        });\n-    }\n-\n-    function postIssue(issue: IssueEvent) {\n-        const currentRelays = get(relays);\n-        if (!currentRelays?.length) {\n-            console.error('No relays available for posting issue');\n-            return Promise.reject('No relays available');\n-        }\n-\n-        return publishThunk({\n-            relays: currentRelays,\n-            event: issue,\n-        });\n-    }\n-\n-    return {\n-        repoEvent,\n-        issues,\n-        patches,\n-        repoState,\n-        relays,\n-        postComment,\n-        postIssue,\n-    }\n-}\n\\ No newline at end of file\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-3s19n6vo","title":"Repo overview page overextends on mobile","description":"Probably due to clone urls or repo naddr stretching the ui","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["UI","bug","issue","repos","v1"]}
{"id":"flotilla-3teymc27","title":"Build: build-in-production script returns errors","description":"'pnpm build' works, the production script returns this:\nhttps://i.nostr.build/9mfhw7WES8PKZd7r.png","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["bug","build","issue","v1"]}
{"id":"flotilla-3zuogm56","title":"From 76bdb5a49f13aaa5919d9ef80355d808a6098bc7 Mon Sep 17 00:00:00 2001","description":"From 76bdb5a49f13aaa5919d9ef80355d808a6098bc7 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Mon, 2 Jun 2025 16:33:55 -0700\nSubject: [PATCH 12/67] Remove space blossom detection\n\n---\n src/app/components/ContentLinkBlockImage.svelte | 47 ++++++-----------------------------------------\n src/app/editor/index.ts                         | 51 +++++----------------------------------------------\n src/routes/spaces/[relay]/+layout.svelte        |  5 -----\n 3 files changed, 11 insertions(+), 92 deletions(-)\n\ndiff --git a/src/app/components/ContentLinkBlockImage.svelte b/src/app/components/ContentLinkBlockImage.svelte\nindex e0154b8..87db740 100644\n--- a/src/app/components/ContentLinkBlockImage.svelte\n+++ b/src/app/components/ContentLinkBlockImage.svelte\n@@ -1,49 +1,14 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {onDestroy} from \"svelte\"\n-  import {now} from \"@welshman/lib\"\n-  import {BLOSSOM_AUTH, makeEvent, getTags, getTagValue, tagsFromIMeta} from \"@welshman/util\"\n-  import {signer} from \"@welshman/app\"\n+  import {getTags, getTagValue, tagsFromIMeta} from \"@welshman/util\"\n   import {imgproxy} from \"@app/state\"\n \n   const {value, event, ...props} = $props()\n \n   const url = value.url.toString()\n-\n-  // If we fail to fetch the image, try authenticating if we have a blossom hash\n-  const onerror = async () =\u003e {\n-    const meta = getTags(\"imeta\", event.tags)\n-      .map(tagsFromIMeta)\n-      .find(meta =\u003e getTagValue(\"url\", meta) === url)\n-    const hash = meta ? getTagValue(\"x\", meta) : undefined\n-\n-    if (hash \u0026\u0026 $signer) {\n-      const event = await signer.get().sign(\n-        makeEvent(BLOSSOM_AUTH, {\n-          tags: [\n-            [\"t\", \"get\"],\n-            [\"x\", hash],\n-            [\"expiration\", String(now() + 30)],\n-          ],\n-        }),\n-      )\n-\n-      const res = await fetch(url, {\n-        headers: {\n-          Authorization: `Nostr ${btoa(JSON.stringify(event))}`,\n-        },\n-      })\n-\n-      if (res.status === 200) {\n-        src = URL.createObjectURL(await res.blob())\n-      }\n-    }\n-  }\n-\n-  let src = $state(imgproxy(url))\n-\n-  onDestroy(() =\u003e {\n-    URL.revokeObjectURL(src)\n-  })\n+  const meta = getTags(\"imeta\", event.tags)\n+    .map(tagsFromIMeta)\n+    .find(meta =\u003e getTagValue(\"url\", meta) === url)\n+  const src = imgproxy(url)\n \u003c/script\u003e\n \n-\u003cimg alt=\"\" {src} {onerror} {...props} /\u003e\n+\u003cimg alt=\"\" {src} {...props} /\u003e\ndiff --git a/src/app/editor/index.ts b/src/app/editor/index.ts\nindex 387c1ec..c560a50 100644\n--- a/src/app/editor/index.ts\n+++ b/src/app/editor/index.ts\n@@ -2,59 +2,18 @@ import {mount} from \"svelte\"\n import type {Writable} from \"svelte/store\"\n import {get} from \"svelte/store\"\n import type {StampedEvent} from \"@welshman/util\"\n-import {makeEvent, getTagValues, getListTags, BLOSSOM_AUTH} from \"@welshman/util\"\n-import {simpleCache, normalizeUrl, removeNil, now} from \"@welshman/lib\"\n+import {getTagValues, getListTags} from \"@welshman/util\"\n import {Router} from \"@welshman/router\"\n import {signer, profileSearch, userBlossomServers} from \"@welshman/app\"\n import {Editor, MentionSuggestion, WelshmanExtension} from \"@welshman/editor\"\n import {makeMentionNodeView} from \"./MentionNodeView\"\n import ProfileSuggestion from \"./ProfileSuggestion.svelte\"\n \n-export const hasBlossomSupport = simpleCache(async ([url]: [string]) =\u003e {\n-  const $signer = signer.get()\n-  const headers: Record\u003cstring, string\u003e = {\n-    \"X-Content-Type\": \"text/plain\",\n-    \"X-Content-Length\": \"1\",\n-    \"X-SHA-256\": \"73cb3858a687a8494ca3323053016282f3dad39d42cf62ca4e79dda2aac7d9ac\",\n-  }\n-\n-  try {\n-    if ($signer) {\n-      const event = await signer.get().sign(\n-        makeEvent(BLOSSOM_AUTH, {\n-          tags: [\n-            [\"t\", \"upload\"],\n-            [\"server\", url],\n-            [\"expiration\", String(now() + 30)],\n-          ],\n-        }),\n-      )\n-\n-      headers.Authorization = `Nostr ${btoa(JSON.stringify(event))}`\n-    }\n-\n-    const res = await fetch(normalizeUrl(url) + \"/upload\", {method: \"head\", headers})\n-\n-    return res.status === 200\n-  } catch (e) {\n-    if (!String(e).includes(\"Failed to fetch\")) {\n-      console.error(e)\n-    }\n-  }\n-\n-  return false\n-})\n-\n-export const getUploadUrl = async (spaceUrl?: string) =\u003e {\n+export const getUploadUrl = () =\u003e {\n   const userUrls = getTagValues(\"server\", getListTags(userBlossomServers.get()))\n-  const allUrls = removeNil([spaceUrl, ...userUrls])\n-\n-  for (let url of allUrls) {\n-    url = url.replace(/^ws/, \"http\")\n \n-    if (await hasBlossomSupport(url)) {\n-      return url\n-    }\n+  for (const url of userUrls) {\n+    return url.replace(/^ws/, \"http\")\n   }\n \n   return \"https://cdn.satellite.earth\"\n@@ -98,7 +57,7 @@ export const makeEditor = async ({\n         submit,\n         sign: signWithAssert,\n         defaultUploadType: \"blossom\",\n-        defaultUploadUrl: await getUploadUrl(url),\n+        defaultUploadUrl: getUploadUrl(),\n         extensions: {\n           placeholder: {\n             config: {\ndiff --git a/src/routes/spaces/[relay]/+layout.svelte b/src/routes/spaces/[relay]/+layout.svelte\nindex 892a446..8bb3a47 100644\n--- a/src/routes/spaces/[relay]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/+layout.svelte\n@@ -51,11 +51,6 @@\n   onMount(() =\u003e {\n     checkConnection()\n \n-    // Prime our cache so inputs show up quickly\n-    // Commented out to prevent warning over no blossom server endpoint\n-    // function doesn't seem to do what the comment says it does\n-    // getUploadUrl(url)\n-\n     const relays = [url]\n     const since = ago(WEEK)\n     const controller = new AbortController()\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-497a9uqc","title":"From f5d32b6c7ce31b2e30d0e47b9b410f7e407c7589 Mon Sep 17 00:00:00 2001","description":"From f5d32b6c7ce31b2e30d0e47b9b410f7e407c7589 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Thu, 6 Nov 2025 11:43:46 +0500\nSubject: [PATCH] fix: issue page responsiveness\n\n- Add responsive padding and spacing with sm breakpoints\n- Make text sizes responsive (text-lg sm:text-xl, etc.)\n- Improve flex layouts for mobile (flex-col sm:flex-row)\n- Add break-words to prevent text overflow\n- Improve button sizing for mobile (min-h-[44px] for touch targets)\n- Update nostr-git submodule\n---\n packages/nostr-git                                                     |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte | 54 ++++++++++++++++++++++++++++--------------------------\n 2 files changed, 29 insertions(+), 27 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 72d1024..d06f175 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 72d1024d12f27d399a2329cdf3e0e53a61359d64\n+Subproject commit d06f17550182224baafe87e3e13b8eb643f91d1a\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte\nindex 9db407d..217534d 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte\n@@ -320,20 +320,20 @@\n \u003c/svelte:head\u003e\n \n {#if issue}\n-  \u003cdiv class=\"z-10 sticky top-0 items-center justify-between py-4 backdrop-blur\" transition:slide\u003e\n-    \u003cCard class=\"git-card transition-colors\"\u003e\n-      \u003cdiv class=\"flex items-start gap-4\"\u003e\n+  \u003cdiv class=\"z-10 sticky top-0 items-center justify-between py-2 sm:py-4 backdrop-blur px-2 sm:px-0\" transition:slide\u003e\n+    \u003cCard class=\"git-card transition-colors p-4 sm:p-6\"\u003e\n+      \u003cdiv class=\"flex items-start gap-2 sm:gap-4\"\u003e\n         {#if statusIcon}\n           {@const {icon: Icon, color} = statusIcon()}\n-          \u003cdiv class=\"mt-1\"\u003e\n-            \u003cdiv class=\"flex h-10 w-10 items-center justify-center rounded-full bg-amber-500/10\"\u003e\n-              \u003cIcon class={`h-6 w-6 ${color}`} /\u003e\n+          \u003cdiv class=\"mt-1 flex-shrink-0\"\u003e\n+            \u003cdiv class=\"flex h-8 w-8 sm:h-10 sm:w-10 items-center justify-center rounded-full bg-amber-500/10\"\u003e\n+              \u003cIcon class={`h-4 w-4 sm:h-6 sm:w-6 ${color}`} /\u003e\n             \u003c/div\u003e\n           \u003c/div\u003e\n         {/if}\n-        \u003cdiv\u003e\n-          \u003ch1 class=\"break-words text-2xl font-semibold\"\u003e{issue.subject || \"Issue\"}\u003c/h1\u003e\n-          \u003cdiv class=\"mt-2 flex items-center gap-2\"\u003e\n+        \u003cdiv class=\"min-w-0 flex-1\"\u003e\n+          \u003ch1 class=\"break-words text-lg sm:text-xl font-semibold\"\u003e{issue.subject || \"Issue\"}\u003c/h1\u003e\n+          \u003cdiv class=\"mt-2 flex flex-col sm:flex-row sm:items-center gap-2\"\u003e\n             \u003cStatus\n               repo={repoClass}\n               rootId={issue.id}\n@@ -343,19 +343,21 @@\n               actorPubkey={$pubkey}\n               compact={true}\n               ProfileComponent={ProfileLink} /\u003e\n-            \u003cspan class=\"text-sm text-muted-foreground\"\u003e\n+            \u003cspan class=\"text-xs sm:text-sm text-muted-foreground flex flex-wrap items-center gap-1\"\u003e\n               \u003cProfileLink pubkey={issue?.author.pubkey}\u003e\u003c/ProfileLink\u003e\n-              opened this issue • {new Date(issue?.createdAt).toLocaleString()}\n+              \u003cspan class=\"hidden sm:inline\"\u003eopened this issue •\u003c/span\u003e\n+              \u003cspan class=\"sm:hidden\"\u003eopened\u003c/span\u003e\n+              \u003cspan class=\"text-xs break-all sm:break-normal\"\u003e{new Date(issue?.createdAt).toLocaleString()}\u003c/span\u003e\n             \u003c/span\u003e\n           \u003c/div\u003e\n         \u003c/div\u003e\n       \u003c/div\u003e\n \n-      \u003cdiv class=\"prose-sm dark:prose-invert prose mt-8 max-w-none truncate\"\u003e\n+      \u003cdiv class=\"prose-sm dark:prose-invert prose mt-6 sm:mt-8 max-w-none break-words [\u0026_*]:break-words [\u0026_pre]:overflow-x-auto [\u0026_code]:break-words\"\u003e\n         {@html markdown.render(issue.content)}\n       \u003c/div\u003e\n \n-      \u003cdiv class=\"git-separator my-6\"\u003e\u003c/div\u003e\n+      \u003cdiv class=\"git-separator my-4 sm:my-6\"\u003e\u003c/div\u003e\n \n       \u003c!-- Labels Section --\u003e\n       \u003cdiv class=\"my-4 space-y-2\"\u003e\n@@ -367,19 +369,19 @@\n           \u003c/div\u003e\n         {/if}\n         {#if isMaintainerOrAuthor}\n-          \u003cdiv class=\"flex items-center gap-2\"\u003e\n+          \u003cdiv class=\"flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full max-w-full\"\u003e\n             \u003cinput\n-              class=\"rounded-md border border-border bg-background px-2 py-1 text-sm\"\n+              class=\"flex-1 min-w-0 rounded-md border border-border bg-background px-3 py-2 sm:px-2 sm:py-1 text-sm min-h-[44px] sm:min-h-0\"\n               placeholder=\"Add tag...\"\n               bind:value={newLabel}\n               onkeydown={e =\u003e {\n                 if (e.key === \"Enter\") addLabel()\n               }} /\u003e\n             \u003cbutton\n-              class=\"rounded-md border border-border px-3 py-1 text-sm\"\n+              class=\"flex-shrink-0 rounded-md border border-border px-3 py-2 sm:px-3 sm:py-1 text-sm min-h-[44px] sm:min-h-0\"\n               onclick={addLabel}\n               disabled={addingLabel || !newLabel.trim()}\u003e\n-              {addingLabel ? \"Adding...\" : \"Add Tag\"}\n+              \u003cspan class=\"whitespace-nowrap\"\u003e{addingLabel ? \"Adding...\" : \"Add Tag\"}\u003c/span\u003e\n             \u003c/button\u003e\n           \u003c/div\u003e\n         {/if}\n@@ -439,13 +441,13 @@\n               {/each}\n             \u003c/div\u003e\n           {:else}\n-            \u003cdiv class=\"text-sm text-muted-foreground\"\u003eNo assignees yet.\u003c/div\u003e\n+            \u003cdiv class=\"text-xs sm:text-sm text-muted-foreground\"\u003eNo assignees yet.\u003c/div\u003e\n           {/if}\n         {/if}\n       \u003c/div\u003e\n \n       \u003c!-- Status Section --\u003e\n-      \u003cdiv class=\"my-6\"\u003e\n+      \u003cdiv class=\"my-4 sm:my-6\"\u003e\n         \u003cStatus\n           repo={repoClass}\n           rootId={issue.id}\n@@ -458,11 +460,11 @@\n           onPublish={handleStatusPublish} /\u003e\n       \u003c/div\u003e\n \n-      \u003cdiv class=\"git-separator my-6\"\u003e\u003c/div\u003e\n+      \u003cdiv class=\"git-separator my-4 sm:my-6\"\u003e\u003c/div\u003e\n \n-      \u003ch2 class=\"my-2 flex items-center gap-2 text-lg font-medium\"\u003e\n-        \u003cMessageSquare class=\"h-5 w-5\" /\u003e\n-        Discussion ({$threadComments?.length})\n+      \u003ch2 class=\"my-2 flex items-center gap-2 text-base sm:text-lg font-medium\"\u003e\n+        \u003cMessageSquare class=\"h-4 w-4 sm:h-5 sm:w-5 flex-shrink-0\" /\u003e\n+        \u003cspan class=\"break-words\"\u003eDiscussion ({$threadComments?.length})\u003c/span\u003e\n       \u003c/h2\u003e\n \n       \u003cIssueThread\n@@ -474,8 +476,8 @@\n     \u003c/Card\u003e\n   \u003c/div\u003e\n {:else}\n-  \u003cdiv class=\"flex flex-col items-center justify-center py-12\"\u003e\n-    \u003cSearchX class=\"mb-2 h-8 w-8\" /\u003e\n-    No issue found.\n+  \u003cdiv class=\"flex flex-col items-center justify-center py-8 sm:py-12 px-4\"\u003e\n+    \u003cSearchX class=\"mb-2 h-6 w-6 sm:h-8 sm:w-8\" /\u003e\n+    \u003cp class=\"text-sm sm:text-base text-center\"\u003eNo issue found.\u003c/p\u003e\n   \u003c/div\u003e\n {/if}\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-4dn41jdf","title":"From 0461faf180d89631d7201701ec56bcc341467431 Mon Sep 17 00:00:00 2001","description":"From 0461faf180d89631d7201701ec56bcc341467431 Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/2] Add permalink conversion and rendering to editor\n\nThese commits add the permalink event converter to the budabit editor as well as various feed adjustments","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-4m7ndojd","title":"From 61b6b23a893c5860fb521fe74ea619618bff29b2 Mon Sep 17 00:00:00 2001","description":"From 61b6b23a893c5860fb521fe74ea619618bff29b2 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 30 Nov 2025 22:03:32 +0500\nSubject: [PATCH 10/13] feat(repo): add prominent clone URL section to repository overview\n\nAdd a highly visible clone URL section at the top of the repository\noverview page with one-click copy functionality.\n\nChanges:\n- Add new clone URL section positioned after stats grid\n- Display all available clone URLs with copy-to-clipboard functionality\n- Implement visual feedback (checkmark) when URL is copied\n- Make entire URL row clickable for easier copying\n- Use subtle gray theming to match overall design aesthetic\n\nTechnical improvements:\n- Fix repoMetadata to use repoClass properties directly instead of\n  accessing private repo object\n- Use repoClass.cloneUrls getter for proper clone URL retrieval\n- Use repoClass.name and repoClass.description for metadata\n- Add Copy and Check icons from lucide-svelte\n- Add copiedUrl state for tracking copy feedback\n- Implement copyUrl() function with 2-second feedback timeout\n\nUX enhancements:\n- Entire URL container is now a clickable button\n- Hover and active states provide clear interaction feedback\n- Keyboard accessible (tab navigation + Enter/Space to copy)\n- Responsive design with proper dark mode support\n- Icon changes to green checkmark after successful copy\n\nThis addresses the issue where clone URLs were buried in the\nrepository details sidebar and not immediately visible to users\nwanting to clone the repository.\n\nRelated: packages/nostr-git submodule updated to commit 74fe3465\n---\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte | 61 +++++++++++++++++++++++++++++++++++++++++++++++++++++--------\n 1 file changed, 53 insertions(+), 8 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex f3a80da..855343d 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -12,6 +12,8 @@\n     Link,\n     Eye,\n     BookOpen,\n+    Copy,\n+    Check,\n   } from \"@lucide/svelte\"\n   import {fade, fly, slide} from \"@lib/transition\"\n   import Spinner from \"@lib/components/Spinner.svelte\"\n@@ -45,6 +47,7 @@\n   let _prevRepoKey = $state\u003cstring | undefined\u003e(undefined)\n   let _prevMain = $state\u003cstring | undefined\u003e(undefined)\n   let _prevBranchSig = $state\u003cstring | undefined\u003e(undefined)\n+  let copiedUrl = $state\u003cstring | null\u003e(null)\n \n   const stats = $derived([\n     {\n@@ -106,14 +109,14 @@\n   }\n \n   const repoMetadata = $derived({\n-    name: ((repoClass as any).repo?.name as string) || \"Unknown Repository\",\n-    description: ((repoClass as any).repo?.description as string) || \"\",\n+    name: repoClass.name || \"Unknown Repository\",\n+    description: repoClass.description || \"\",\n     repoId: repoClass.key || \"\",\n     maintainers: maintainers || [],\n     relays: $repoRelays,\n     cloneUrls: (() =\u003e {\n-      const rep: any = (repoClass as any).repo\n-      let urls = [...(rep?.clone || [])]\n+      // Get clone URLs from repoClass directly\n+      let urls = [...(repoClass.cloneUrls || [])]\n       if (!urls.find(u =\u003e u.startsWith(\"nostr://\"))) {\n         const def = buildDefaultNgitCloneUrl()\n         if (def \u0026\u0026 !urls.includes(def)) urls.push(def)\n@@ -121,8 +124,8 @@\n       return urls\n     })(),\n     webUrls: (() =\u003e {\n-      const rep: any = (repoClass as any).repo\n-      let urls = [...(rep?.web || [])]\n+      // Get web URLs from repoClass directly\n+      let urls = [...(repoClass.web || [])]\n       if (!urls.find(u =\u003e u.startsWith(\"https://gitworkshop.dev\"))) {\n         const def = buildDefaultViewRepoUrl()\n         if (def \u0026\u0026 !urls.includes(def)) urls.push(def)\n@@ -130,8 +133,8 @@\n       return urls\n     })(),\n     mainBranch: repoClass.mainBranch,\n-    createdAt: (repoClass as any).repoEvent?.created_at\n-      ? new Date(((repoClass as any).repoEvent.created_at as number) * 1000)\n+    createdAt: repoClass.repoEvent?.created_at\n+      ? new Date(repoClass.repoEvent.created_at * 1000)\n       : null,\n     updatedAt: (repoClass as any).repoStateEvent?.created_at\n       ? new Date(((repoClass as any).repoStateEvent.created_at as number) * 1000)\n@@ -292,6 +295,18 @@\n   function truncateHash(hash: string, length = 8) {\n     return hash ? hash.substring(0, length) : \"\"\n   }\n+\n+  async function copyUrl(url: string) {\n+    try {\n+      await clip(url)\n+      copiedUrl = url\n+      setTimeout(() =\u003e {\n+        copiedUrl = null\n+      }, 2000)\n+    } catch (e) {\n+      console.error(\"Failed to copy URL\", e)\n+    }\n+  }\n \u003c/script\u003e\n \n \u003csvelte:head\u003e\n@@ -321,6 +336,36 @@\n       {/each}\n     \u003c/div\u003e\n \n+    \u003c!-- Clone URL Section - Prominent Display --\u003e\n+    {#if repoMetadata.cloneUrls.length \u003e 0}\n+      \u003cdiv transition:fade\u003e\n+        \u003cCard class=\"p-6\"\u003e\n+          \u003ch3 class=\"mb-3 text-lg font-semibold flex items-center gap-2\"\u003e\n+            \u003cGitBranch class=\"h-5 w-5\" /\u003e\n+            Clone Repository\n+          \u003c/h3\u003e\n+          \u003cdiv class=\"space-y-2\"\u003e\n+            {#each repoMetadata.cloneUrls as url, index}\n+              \u003cbutton\n+                type=\"button\"\n+                class=\"flex w-full items-center gap-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 p-3 transition-all hover:border-gray-300 dark:hover:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700/50 active:scale-[0.99] cursor-pointer group\"\n+                title=\"Click to copy\"\n+                onclick={() =\u003e copyUrl(url)}\u003e\n+                \u003ccode class=\"flex-1 font-mono text-sm overflow-x-auto whitespace-nowrap text-left\"\u003e{url}\u003c/code\u003e\n+                \u003cdiv class=\"flex-shrink-0 p-1 rounded-md transition-colors group-hover:bg-gray-200 dark:group-hover:bg-gray-600\"\u003e\n+                  {#if copiedUrl === url}\n+                    \u003cCheck class=\"h-4 w-4 text-green-600 dark:text-green-400\" /\u003e\n+                  {:else}\n+                    \u003cCopy class=\"h-4 w-4 text-gray-600 dark:text-gray-400\" /\u003e\n+                  {/if}\n+                \u003c/div\u003e\n+              \u003c/button\u003e\n+            {/each}\n+          \u003c/div\u003e\n+        \u003c/Card\u003e\n+      \u003c/div\u003e\n+    {/if}\n+\n     \u003cdiv class=\"grid gap-6 md:grid-cols-2\" transition:fly\u003e\n       \u003c!-- Repository Details --\u003e\n       \u003cCard class=\"p-6\"\u003e\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-4t9serfl","title":"From 0ba2cdd0a8667b5bbdbf1cc4eb36e2ec8cbc314c Mon Sep 17 00:00:00 2001","description":"From 0ba2cdd0a8667b5bbdbf1cc4eb36e2ec8cbc314c Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Thu, 5 Jun 2025 08:35:17 -0700\nSubject: [PATCH 21/67] Move space quick links to its own file\n\n---\n src/app/components/ProfileLink.svelte           |   4 ++--\n src/app/components/SpaceQuickLinks.svelte       | 109 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/lib/components/SocketStatusIndicator.svelte |  38 ++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/+page.svelte          | 136 +++++++---------------------------------------------------------------------------------------------------------------------------------\n 4 files changed, 156 insertions(+), 131 deletions(-)\n create mode 100644 src/app/components/SpaceQuickLinks.svelte\n create mode 100644 src/lib/components/SocketStatusIndicator.svelte\n\ndiff --git a/src/app/components/ProfileLink.svelte b/src/app/components/ProfileLink.svelte\nindex a63ff15..5279aba 100644\n--- a/src/app/components/ProfileLink.svelte\n+++ b/src/app/components/ProfileLink.svelte\n@@ -1,5 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n-  import cx from 'classnames'\n+  import cx from \"classnames\"\n   import {preventDefault} from \"@lib/html\"\n   import Button from \"@lib/components/Button.svelte\"\n   import ProfileName from \"@app/components/ProfileName.svelte\"\n@@ -17,6 +17,6 @@\n   const openProfile = () =\u003e pushModal(ProfileDetail, {pubkey, url})\n \u003c/script\u003e\n \n-\u003cButton onclick={preventDefault(openProfile)} class={cx({'link-content': !unstyled})}\u003e\n+\u003cButton onclick={preventDefault(openProfile)} class={cx({\"link-content\": !unstyled})}\u003e\n   @\u003cProfileName {pubkey} {url} /\u003e\n \u003c/Button\u003e\ndiff --git a/src/app/components/SpaceQuickLinks.svelte b/src/app/components/SpaceQuickLinks.svelte\nnew file mode 100644\nindex 0000000..87b8db6\n--- /dev/null\n+++ b/src/app/components/SpaceQuickLinks.svelte\n@@ -0,0 +1,109 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {deriveRelay} from \"@welshman/app\"\n+  import {fade} from \"@lib/transition\"\n+  import Icon from \"@lib/components/Icon.svelte\"\n+  import Link from \"@lib/components/Link.svelte\"\n+  import Button from \"@lib/components/Button.svelte\"\n+  import RoomCreate from \"@app/components/RoomCreate.svelte\"\n+  import ChannelName from \"@app/components/ChannelName.svelte\"\n+  import {makeThreadPath, makeCalendarPath, makeRoomPath} from \"@app/routes\"\n+  import {\n+    hasNip29,\n+    deriveUserRooms,\n+    deriveOtherRooms,\n+    makeChannelId,\n+    channelsById,\n+  } from \"@app/state\"\n+  import {notifications} from \"@app/notifications\"\n+  import {pushModal} from \"@app/modal\"\n+\n+  type Props = {\n+    url: string\n+  }\n+\n+  const {url}: Props = $props()\n+  const relay = deriveRelay(url)\n+  const userRooms = deriveUserRooms(url)\n+  const otherRooms = deriveOtherRooms(url)\n+  const threadsPath = makeThreadPath(url)\n+  const calendarPath = makeCalendarPath(url)\n+\n+  const addRoom = () =\u003e pushModal(RoomCreate, {url})\n+\n+  const filteredRooms = $derived(() =\u003e {\n+    if (!term) return [...$userRooms, ...$otherRooms]\n+\n+    const query = term.toLowerCase()\n+    const allRooms = [...$userRooms, ...$otherRooms]\n+\n+    return allRooms.filter(room =\u003e {\n+      const channel = $channelsById.get(makeChannelId(url, room))\n+      const roomName = channel?.name || room\n+      return roomName.toLowerCase().includes(query)\n+    })\n+  })\n+\n+  let term = $state(\"\")\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"card2 bg-alt md:hidden\"\u003e\n+  \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+    \u003cIcon icon=\"compass-big\" /\u003e\n+    Quick Links\n+  \u003c/h3\u003e\n+  \u003cdiv class=\"flex flex-col gap-2\"\u003e\n+    \u003cLink href={threadsPath} class=\"btn btn-primary w-full justify-start\"\u003e\n+      \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n+        \u003cIcon icon=\"notes-minimalistic\" /\u003e\n+        Threads\n+        {#if $notifications.has(threadsPath)}\n+          \u003cdiv\n+            class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n+            transition:fade\u003e\n+          \u003c/div\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    \u003c/Link\u003e\n+    \u003cLink href={calendarPath} class=\"btn btn-secondary w-full justify-start\"\u003e\n+      \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n+        \u003cIcon icon=\"calendar-minimalistic\" /\u003e\n+        Calendar\n+        {#if $notifications.has(calendarPath)}\n+          \u003cdiv\n+            class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n+            transition:fade\u003e\n+          \u003c/div\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    \u003c/Link\u003e\n+    {#if $userRooms.length + $otherRooms.length \u003e 10}\n+      \u003clabel class=\"input input-sm input-bordered flex flex-grow items-center gap-2\"\u003e\n+        \u003cIcon icon=\"magnifer\" size={4} /\u003e\n+        \u003cinput bind:value={term} class=\"grow\" type=\"text\" placeholder=\"Search rooms...\" /\u003e\n+      \u003c/label\u003e\n+    {/if}\n+    {#each filteredRooms() as room (room)}\n+      {@const roomPath = makeRoomPath(url, room)}\n+      {@const channel = $channelsById.get(makeChannelId(url, room))}\n+      \u003cLink href={roomPath} class=\"btn btn-neutral btn-sm relative w-full justify-start\"\u003e\n+        \u003cdiv class=\"flex min-w-0 items-center gap-2 overflow-hidden text-nowrap\"\u003e\n+          {#if channel?.closed || channel?.private}\n+            \u003cIcon icon=\"lock\" size={4} /\u003e\n+          {:else}\n+            \u003cIcon icon=\"hashtag\" /\u003e\n+          {/if}\n+          \u003cChannelName {url} {room} /\u003e\n+        \u003c/div\u003e\n+        {#if $notifications.has(roomPath)}\n+          \u003cdiv class=\"absolute right-1 top-1 h-2 w-2 rounded-full bg-primary\" transition:fade\u003e\u003c/div\u003e\n+        {/if}\n+      \u003c/Link\u003e\n+    {/each}\n+    {#if hasNip29($relay)}\n+      \u003cButton onclick={addRoom} class=\"btn btn-neutral btn-sm w-full justify-start\"\u003e\n+        \u003cIcon icon=\"add-circle\" /\u003e\n+        Create Room\n+      \u003c/Button\u003e\n+    {/if}\n+  \u003c/div\u003e\n+\u003c/div\u003e\ndiff --git a/src/lib/components/SocketStatusIndicator.svelte b/src/lib/components/SocketStatusIndicator.svelte\nnew file mode 100644\nindex 0000000..c2c11d7\n--- /dev/null\n+++ b/src/lib/components/SocketStatusIndicator.svelte\n@@ -0,0 +1,38 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {AuthStatus, SocketStatus} from \"@welshman/net\"\n+  import {deriveSocket} from \"@app/state\"\n+  import StatusIndicator from \"@lib/components/StatusIndicator.svelte\"\n+\n+  type Props = {\n+    url: string\n+  }\n+\n+  const {url}: Props = $props()\n+  const socket = deriveSocket(url)\n+\u003c/script\u003e\n+\n+{#if $socket.status === SocketStatus.Open}\n+  {#if $socket.auth.status === AuthStatus.None}\n+    \u003cStatusIndicator class=\"bg-green-500\"\u003eConnected\u003c/StatusIndicator\u003e\n+  {:else if $socket.auth.status === AuthStatus.Requested}\n+    \u003cStatusIndicator class=\"bg-yellow-500\"\u003eAuthenticating\u003c/StatusIndicator\u003e\n+  {:else if $socket.auth.status === AuthStatus.PendingSignature}\n+    \u003cStatusIndicator class=\"bg-yellow-500\"\u003eAuthenticating\u003c/StatusIndicator\u003e\n+  {:else if $socket.auth.status === AuthStatus.DeniedSignature}\n+    \u003cStatusIndicator class=\"bg-red-500\"\u003eFailed to Authenticate\u003c/StatusIndicator\u003e\n+  {:else if $socket.auth.status === AuthStatus.PendingResponse}\n+    \u003cStatusIndicator class=\"bg-yellow-500\"\u003eAuthenticating\u003c/StatusIndicator\u003e\n+  {:else if $socket.auth.status === AuthStatus.Forbidden}\n+    \u003cStatusIndicator class=\"bg-red-500\"\u003eAccess Denied\u003c/StatusIndicator\u003e\n+  {:else if $socket.auth.status === AuthStatus.Ok}\n+    \u003cStatusIndicator class=\"bg-green-500\"\u003eConnected\u003c/StatusIndicator\u003e\n+  {/if}\n+{:else if $socket.status === SocketStatus.Opening}\n+  \u003cStatusIndicator class=\"bg-yellow-500\"\u003eConnecting\u003c/StatusIndicator\u003e\n+{:else if $socket.status === SocketStatus.Closing}\n+  \u003cStatusIndicator class=\"bg-gray-500\"\u003eNot Connected\u003c/StatusIndicator\u003e\n+{:else if $socket.status === SocketStatus.Closed}\n+  \u003cStatusIndicator class=\"bg-gray-500\"\u003eNot Connected\u003c/StatusIndicator\u003e\n+{:else if $socket.status === SocketStatus.Error}\n+  \u003cStatusIndicator class=\"bg-red-500\"\u003eFailed to Connect\u003c/StatusIndicator\u003e\n+{/if}\ndiff --git a/src/routes/spaces/[relay]/+page.svelte b/src/routes/spaces/[relay]/+page.svelte\nindex dfcc950..6dc5103 100644\n--- a/src/routes/spaces/[relay]/+page.svelte\n+++ b/src/routes/spaces/[relay]/+page.svelte\n@@ -1,33 +1,27 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n-  import {displayRelayUrl, MESSAGE, THREAD} from \"@welshman/util\"\n-  import {deriveRelay, pubkey} from \"@welshman/app\"\n-  import {AuthStatus, SocketStatus} from \"@welshman/net\"\n-  import {fade} from \"@lib/transition\"\n+  import {displayRelayUrl} from \"@welshman/util\"\n+  import {deriveRelay} from \"@welshman/app\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Link from \"@lib/components/Link.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n   import PageBar from \"@lib/components/PageBar.svelte\"\n   import PageContent from \"@lib/components/PageContent.svelte\"\n-  import StatusIndicator from \"@lib/components/StatusIndicator.svelte\"\n+  import SocketStatusIndicator from \"@lib/components/SocketStatusIndicator.svelte\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n   import ProfileLatest from \"@app/components/ProfileLatest.svelte\"\n   import ChannelName from \"@app/components/ChannelName.svelte\"\n   import SpaceJoin from \"@app/components/SpaceJoin.svelte\"\n   import RelayName from \"@app/components/RelayName.svelte\"\n-  import RoomCreate from \"@app/components/RoomCreate.svelte\"\n   import RelayDescription from \"@app/components/RelayDescription.svelte\"\n+  import SpaceQuickLinks from \"@app/components/SpaceQuickLinks.svelte\"\n   import {\n-    hasNip29,\n     decodeRelay,\n     makeChannelId,\n     channelsById,\n     deriveUserRooms,\n-    deriveOtherRooms,\n     userRoomsByUrl,\n-    deriveSocket,\n-    deriveEventsForUrl,\n   } from \"@app/state\"\n   import {\n     makeChatPath,\n@@ -41,7 +35,6 @@\n \n   const url = decodeRelay($page.params.relay)\n   const relay = deriveRelay(url)\n-  const socket = deriveSocket(url)\n   const userRooms = deriveUserRooms(url)\n   const otherRooms = deriveOtherRooms(url)\n   const threadsPath = makeThreadPath(url)\n@@ -51,24 +44,7 @@\n \n   const joinSpace = () =\u003e pushModal(SpaceJoin, {url})\n \n-  const addRoom = () =\u003e pushModal(RoomCreate, {url})\n-\n-  let roomSearchQuery = $state(\"\")\n-\n   const owner = $derived($relay?.profile?.pubkey)\n-\n-  const filteredRooms = $derived(() =\u003e {\n-    if (!roomSearchQuery) return [...$userRooms, ...$otherRooms]\n-\n-    const query = roomSearchQuery.toLowerCase()\n-    const allRooms = [...$userRooms, ...$otherRooms]\n-\n-    return allRooms.filter(room =\u003e {\n-      const channel = $channelsById.get(makeChannelId(url, room))\n-      const roomName = channel?.name || room\n-      return roomName.toLowerCase().includes(query)\n-    })\n-  })\n \u003c/script\u003e\n \n \u003cdiv class=\"relative flex flex-col\"\u003e\n@@ -152,81 +128,6 @@\n           \u003c/div\u003e\n         {/if}\n       \u003c/div\u003e\n-      \u003cdiv class=\"grid grid-cols-3 gap-2\"\u003e\n-        \u003cLink href={threadsPath} class=\"btn btn-primary\"\u003e\n-          \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n-            \u003cIcon icon=\"notes-minimalistic\" /\u003e\n-            Threads\n-            {#if $notifications.has(threadsPath)}\n-              \u003cdiv\n-                class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n-                transition:fade\u003e\n-              \u003c/div\u003e\n-            {/if}\n-          \u003c/div\u003e\n-        \u003c/Link\u003e\n-        \u003cLink href={calendarPath} class=\"btn btn-secondary\"\u003e\n-          \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n-            \u003cIcon icon=\"notes-minimalistic\" /\u003e\n-            Calendar\n-            {#if $notifications.has(calendarPath)}\n-              \u003cdiv\n-                class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n-                transition:fade\u003e\n-              \u003c/div\u003e\n-            {/if}\n-          \u003c/div\u003e\n-        \u003c/Link\u003e\n-        \u003c!-- \u003cLink href={jobsPath} class=\"btn btn-success\"\u003e --\u003e\n-        \u003c!--   \u003cdiv class=\"relative flex items-center gap-2\"\u003e --\u003e\n-        \u003c!--     \u003cIcon icon=\"jobs\" /\u003e --\u003e\n-        \u003c!--     Jobs --\u003e\n-        \u003c!--     {#if $notifications.has(jobsPath)} --\u003e\n-        \u003c!--       \u003cdiv --\u003e\n-        \u003c!--         class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\" --\u003e\n-        \u003c!--         transition:fade\u003e --\u003e\n-        \u003c!--       \u003c/div\u003e --\u003e\n-        \u003c!--     {/if} --\u003e\n-        \u003c!--   \u003c/div\u003e --\u003e\n-        \u003c!-- \u003c/Link\u003e --\u003e\n-        \u003cLink href={gitPath} class=\"btn btn-info\"\u003e\n-          \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n-            \u003cIcon icon=\"git\" /\u003e\n-            Git\n-            {#if $notifications.has(gitPath)}\n-              \u003cdiv\n-                class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n-                transition:fade\u003e\n-              \u003c/div\u003e\n-            {/if}\n-          \u003c/div\u003e\n-        \u003c/Link\u003e\n-        {#each $userRooms as room (room)}\n-          {@const roomPath = makeRoomPath(url, room)}\n-          \u003cLink href={roomPath} class=\"btn btn-neutral relative\"\u003e\n-            \u003cdiv class=\"flex min-w-0 items-center gap-2 overflow-hidden text-nowrap\"\u003e\n-              {#if channelIsLocked($channelsById.get(makeChannelId(url, room)))}\n-                \u003cIcon icon=\"lock\" size={4} /\u003e\n-              {:else}\n-                \u003cIcon icon=\"hashtag\" /\u003e\n-              {/if}\n-              \u003cChannelName {url} {room} /\u003e\n-            \u003c/div\u003e\n-            {#if $notifications.has(roomPath)}\n-              \u003cdiv class=\"absolute right-1 top-1 h-2 w-2 rounded-full bg-primary\" transition:fade\u003e\n-              \u003c/div\u003e\n-            {/if}\n-          \u003c/Link\u003e\n-        {/each}\n-        {#each $otherRooms as room (room)}\n-          \u003cLink href={makeRoomPath(url, room)} class=\"btn btn-neutral\"\u003e\n-            \u003cdiv class=\"relative flex min-w-0 items-center gap-2 overflow-hidden text-nowrap\"\u003e\n-              {#if channelIsLocked($channelsById.get(makeChannelId(url, room)))}\n-                \u003cIcon icon=\"lock\" size={4} /\u003e\n-              {:else}\n-                \u003cIcon icon=\"hashtag\" /\u003e\n-              {/if}\n-              \u003cChannelName {url} {room} /\u003e\n     \u003c/div\u003e\n     \u003cRelayDescription {url} /\u003e\n   \u003c/div\u003e\n@@ -334,37 +235,14 @@\n           Relay Status\n         \u003c/h3\u003e\n         \u003cdiv class=\"flex flex-col gap-3\"\u003e\n-          {#if $socket.status === SocketStatus.Open}\n-            {#if $socket.auth.status === AuthStatus.None}\n-              \u003cStatusIndicator class=\"bg-green-500\"\u003eConnected\u003c/StatusIndicator\u003e\n-            {:else if $socket.auth.status === AuthStatus.Requested}\n-              \u003cStatusIndicator class=\"bg-yellow-500\"\u003eAuthenticating\u003c/StatusIndicator\u003e\n-            {:else if $socket.auth.status === AuthStatus.PendingSignature}\n-              \u003cStatusIndicator class=\"bg-yellow-500\"\u003eAuthenticating\u003c/StatusIndicator\u003e\n-            {:else if $socket.auth.status === AuthStatus.DeniedSignature}\n-              \u003cStatusIndicator class=\"bg-red-500\"\u003eFailed to Authenticate\u003c/StatusIndicator\u003e\n-            {:else if $socket.auth.status === AuthStatus.PendingResponse}\n-              \u003cStatusIndicator class=\"bg-yellow-500\"\u003eAuthenticating\u003c/StatusIndicator\u003e\n-            {:else if $socket.auth.status === AuthStatus.Forbidden}\n-              \u003cStatusIndicator class=\"bg-red-500\"\u003eAccess Denied\u003c/StatusIndicator\u003e\n-            {:else if $socket.auth.status === AuthStatus.Ok}\n-              \u003cStatusIndicator class=\"bg-green-500\"\u003eConnected\u003c/StatusIndicator\u003e\n-            {/if}\n-          {:else if $socket.status === SocketStatus.Opening}\n-            \u003cStatusIndicator class=\"bg-yellow-500\"\u003eConnecting\u003c/StatusIndicator\u003e\n-          {:else if $socket.status === SocketStatus.Closing}\n-            \u003cStatusIndicator class=\"bg-gray-500\"\u003eNot Connected\u003c/StatusIndicator\u003e\n-          {:else if $socket.status === SocketStatus.Closed}\n-            \u003cStatusIndicator class=\"bg-gray-500\"\u003eNot Connected\u003c/StatusIndicator\u003e\n-          {:else if $socket.status === SocketStatus.Error}\n-            \u003cStatusIndicator class=\"bg-red-500\"\u003eFailed to Connect\u003c/StatusIndicator\u003e\n-          {/if}\n+          \u003cSocketStatusIndicator {url} /\u003e\n           {#if $relay?.profile}\n             {@const {software, version, supported_nips, limitation} = $relay.profile}\n             \u003cdiv class=\"flex flex-wrap gap-1\"\u003e\n               {#if owner}\n                 \u003cdiv class=\"badge badge-neutral\"\u003e\n-                  \u003cspan class=\"ellipsize\"\u003eAdministrator: \u003cProfileLink unstyled pubkey={owner} /\u003e\u003c/span\u003e\n+                  \u003cspan class=\"ellipsize\"\n+                    \u003eAdministrator: \u003cProfileLink unstyled pubkey={owner} /\u003e\u003c/span\u003e\n                 \u003c/div\u003e\n               {/if}\n               {#if $relay?.profile?.contact}\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-4uga2r8w","title":"From 8cc1248b42ff404057b0159d3a10af1fd1711e68 Mon Sep 17 00:00:00 2001","description":"From 8cc1248b42ff404057b0159d3a10af1fd1711e68 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Thu, 1 Jan 2026 23:36:47 +0500\nSubject: [PATCH] feat: update repo refresh to use smartInitializeRepo with extended timeout\n\n- Replace syncWithRemote call with smartInitializeRepo in repo refresh handler\n  - Use smartInitializeRepo which fetches all branches (not just single branch)\n  - Set forceUpdate: true to ensure fresh data is fetched\n  - Configure 2-minute timeout for large repositories with many branches\n\n- Update submodule to latest commit with enhanced branch loading\n  - Includes improvements to fetch all remote branches\n  - Better progress reporting and error handling\n  - Background branch syncing capabilities\n---\n packages/nostr-git                                      | 2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte | 5 +++--\n 2 files changed, 4 insertions(+), 3 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 70fa873..4265946 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 70fa873ac7ca689ae0e65126cfdf4c4c0c6ccb92\n+Subproject commit 4265946c2fc5dc627f23509aea4637053748c90c\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex d0767ba..e5d4f6f 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -582,10 +582,11 @@\n       }\n \n       // Call syncWithRemote through the repo's worker manager\n-      const result = await repoClass.workerManager.syncWithRemote({\n+      const result = await repoClass.workerManager.smartInitializeRepo({\n         repoId: repoClass.key,\n         cloneUrls,\n-        branch: repoClass.mainBranch,\n+        forceUpdate: true,\n+        timeoutMs: 2 * 60 * 1000, // 2 minutes\n       })\n \n       if (result.success) {\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-5213kfqo","title":"From 4656cc6d0bed9f354d7b49d42ac91c2d664b36ee Mon Sep 17 00:00:00 2001","description":"From 4656cc6d0bed9f354d7b49d42ac91c2d664b36ee Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Thu, 29 May 2025 10:42:43 -0700\nSubject: [PATCH 7/67] Add non-nip29 chat, add leave room\n\n---\n src/app/commands.ts                                 |   9 +++++----\n src/app/components/ChannelMessage.svelte            |   5 ++---\n src/app/components/ChannelMessageEmojiButton.svelte |   6 +-----\n src/app/components/MenuSpace.svelte                 |  52 ++++++++++++++++++++++++++++------------------------\n src/app/state.ts                                    |   9 +++++++--\n src/routes/spaces/[relay]/[room]/+page.svelte       |  48 +++++++++++++++++++++++++++++++-----------------\n src/routes/spaces/[relay]/chat/+page.svelte         | 279 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n 7 files changed, 353 insertions(+), 55 deletions(-)\n create mode 100644 src/routes/spaces/[relay]/chat/+page.svelte\n\ndiff --git a/src/app/commands.ts b/src/app/commands.ts\nindex 8a086c6..4f192e5 100644\n--- a/src/app/commands.ts\n+++ b/src/app/commands.ts\n@@ -33,7 +33,7 @@ import {\n   getRelaysFromList,\n   RelayMode,\n } from \"@welshman/util\"\n-import {Pool, PublishStatus, AuthStatus, SocketStatus} from \"@welshman/net\"\n+import {Pool, AuthStatus, SocketStatus} from \"@welshman/net\"\n import {Router} from \"@welshman/router\"\n import {\n   pubkey,\n@@ -52,10 +52,8 @@ import {\n   dropSession,\n   tagEventForComment,\n   tagEventForQuote,\n-  thunkIsComplete,\n   getThunkError,\n } from \"@welshman/app\"\n-import type {Thunk} from \"@welshman/app\"\n import {\n   tagRoom,\n   PROTECTED,\n@@ -178,7 +176,10 @@ export const removeSpaceMembership = async (url: string) =\u003e {\n \n export const addRoomMembership = async (url: string, room: string) =\u003e {\n   const list = get(userMembership) || makeList({kind: GROUPS})\n-  const newTags = [[\"r\", url], [\"group\", room, url]]\n+  const newTags = [\n+    [\"r\", url],\n+    [\"group\", room, url],\n+  ]\n   const event = await addToListPublicly(list, ...newTags).reconcile(nip44EncryptToSelf)\n   const relays = uniq([...Router.get().FromUser().getUrls(), ...getRelayTagValues(event.tags)])\n \ndiff --git a/src/app/components/ChannelMessage.svelte b/src/app/components/ChannelMessage.svelte\nindex 9a97640..98008e2 100644\n--- a/src/app/components/ChannelMessage.svelte\n+++ b/src/app/components/ChannelMessage.svelte\n@@ -20,14 +20,13 @@\n \n   interface Props {\n     url: string\n-    room: string\n     event: TrustedEvent\n     replyTo?: (event: TrustedEvent) =\u003e void\n     showPubkey?: boolean\n     inert?: boolean\n   }\n \n-  const {url, room, event, replyTo = undefined, showPubkey = false, inert = false}: Props = $props()\n+  const {url, event, replyTo = undefined, showPubkey = false, inert = false}: Props = $props()\n \n   const thunk = $thunks[event.id]\n   const today = formatTimestampAsDate(now())\n@@ -95,7 +94,7 @@\n     \u003cbutton\n       class=\"join absolute right-1 top-1 border border-solid border-neutral text-xs opacity-0 transition-all\"\n       class:group-hover:opacity-100={!isMobile}\u003e\n-      \u003cChannelMessageEmojiButton {url} {room} {event} /\u003e\n+      \u003cChannelMessageEmojiButton {url} {event} /\u003e\n       {#if replyTo}\n         \u003cButton class=\"btn join-item btn-xs\" onclick={reply}\u003e\n           \u003cIcon icon=\"reply\" size={4} /\u003e\ndiff --git a/src/app/components/ChannelMessageEmojiButton.svelte b/src/app/components/ChannelMessageEmojiButton.svelte\nindex a72ca18..64137d1 100644\n--- a/src/app/components/ChannelMessageEmojiButton.svelte\n+++ b/src/app/components/ChannelMessageEmojiButton.svelte\n@@ -1,14 +1,10 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {noop} from \"@welshman/lib\"\n   import type {NativeEmoji} from \"emoji-picker-element/shared\"\n   import EmojiButton from \"@lib/components/EmojiButton.svelte\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import {publishReaction} from \"@app/commands\"\n \n-  const {url, room, event} = $props()\n-\n-  // Tell svelte-check to shut up\n-  noop(room)\n+  const {url, event} = $props()\n \n   const onEmoji = (emoji: NativeEmoji) =\u003e\n     publishReaction({event, relays: [url], content: emoji.unicode})\ndiff --git a/src/app/components/MenuSpace.svelte b/src/app/components/MenuSpace.svelte\nindex bd0d622..223ef34 100644\n--- a/src/app/components/MenuSpace.svelte\n+++ b/src/app/components/MenuSpace.svelte\n@@ -30,6 +30,7 @@\n   const {url} = $props()\n \n   const relay = deriveRelay(url)\n+  const chatPath = makeSpacePath(url, \"chat\")\n   const threadsPath = makeSpacePath(url, \"threads\")\n   const calendarPath = makeSpacePath(url, \"calendar\")\n   const jobsPath = makeSpacePath(url, \"jobs\")\n@@ -130,35 +131,38 @@\n         notification={$notifications.has(calendarPath)}\u003e\n         \u003cIcon icon=\"calendar-minimalistic\" /\u003e Calendar\n       \u003c/SecondaryNavItem\u003e\n-      \u003c!-- \u003cSecondaryNavItem href={jobsPath} notification={$notifications.has(jobsPath)}\u003e --\u003e\n-      \u003c!--   \u003cIcon icon=\"jobs\" /\u003e Jobs --\u003e\n-      \u003c!-- \u003c/SecondaryNavItem\u003e --\u003e\n-      \u003cSecondaryNavItem href={gitPath} notification={$notifications.has(gitPath)}\u003e\n-        \u003cIcon icon=\"git\" /\u003e Git\n-      \u003c/SecondaryNavItem\u003e\n-      \u003cdiv class=\"h-2\"\u003e\u003c/div\u003e\n-      \u003cSecondaryNavHeader\u003eYour Rooms\u003c/SecondaryNavHeader\u003e\n-      {#each $userRooms as room, i (room)}\n-        \u003cMenuSpaceRoomItem {replaceState} notify {url} {room} /\u003e\n-      {/each}\n-      {#if $otherRooms.length \u003e 0}\n-        \u003cdiv class=\"h-2\"\u003e\u003c/div\u003e\n-        \u003cSecondaryNavHeader\u003e\n-          {#if $userRooms.length \u003e 0}\n-            Other Rooms\n-          {:else}\n-            Rooms\n-          {/if}\n-        \u003c/SecondaryNavHeader\u003e\n-      {/if}\n-      {#each $otherRooms as room, i (room)}\n-        \u003cMenuSpaceRoomItem {replaceState} {url} {room} /\u003e\n-      {/each}\n       {#if hasNip29($relay)}\n+        {#if $userRooms.length \u003e 0}\n+          \u003cdiv class=\"h-2\"\u003e\u003c/div\u003e\n+          \u003cSecondaryNavHeader\u003eYour Rooms\u003c/SecondaryNavHeader\u003e\n+        {/if}\n+        {#each $userRooms as room, i (room)}\n+          \u003cMenuSpaceRoomItem {replaceState} notify {url} {room} /\u003e\n+        {/each}\n+        {#if $otherRooms.length \u003e 0}\n+          \u003cdiv class=\"h-2\"\u003e\u003c/div\u003e\n+          \u003cSecondaryNavHeader\u003e\n+            {#if $userRooms.length \u003e 0}\n+              Other Rooms\n+            {:else}\n+              Rooms\n+            {/if}\n+          \u003c/SecondaryNavHeader\u003e\n+        {/if}\n+        {#each $otherRooms as room, i (room)}\n+          \u003cMenuSpaceRoomItem {replaceState} {url} {room} /\u003e\n+        {/each}\n         \u003cSecondaryNavItem {replaceState} onclick={addRoom}\u003e\n           \u003cIcon icon=\"add-circle\" /\u003e\n           Create room\n         \u003c/SecondaryNavItem\u003e\n+      {:else}\n+        \u003cSecondaryNavItem\n+          {replaceState}\n+          href={chatPath}\n+          notification={$notifications.has(chatPath)}\u003e\n+          \u003cIcon icon=\"chat-round\" /\u003e Chat\n+        \u003c/SecondaryNavItem\u003e\n       {/if}\n     \u003c/div\u003e\n   \u003c/SecondaryNavSection\u003e\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 7ea4047..8f45b90 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -667,7 +667,12 @@ export enum MembershipStatus {\n \n export const deriveUserMembershipStatus = (url: string, room: string) =\u003e\n   derived(\n-    [pubkey, deriveEventsForUrl(url, [{kinds: [GROUP_JOIN, GROUP_ADD_USER, GROUP_REMOVE_USER], '#h': [room]}])],\n+    [\n+      pubkey,\n+      deriveEventsForUrl(url, [\n+        {kinds: [GROUP_JOIN, GROUP_ADD_USER, GROUP_REMOVE_USER], \"#h\": [room]},\n+      ]),\n+    ],\n     ([$pubkey, $events]) =\u003e {\n       let status = MembershipStatus.Initial\n \n@@ -686,7 +691,7 @@ export const deriveUserMembershipStatus = (url: string, room: string) =\u003e\n       }\n \n       return status\n-    }\n+    },\n   )\n \n // Other utils\ndiff --git a/src/routes/spaces/[relay]/[room]/+page.svelte b/src/routes/spaces/[relay]/[room]/+page.svelte\nindex 96c48b9..fc6c639 100644\n--- a/src/routes/spaces/[relay]/[room]/+page.svelte\n+++ b/src/routes/spaces/[relay]/[room]/+page.svelte\n@@ -1,5 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n-  import cx from 'classnames'\n+  import cx from \"classnames\"\n   import {readable} from \"svelte/store\"\n   import {onMount, onDestroy} from \"svelte\"\n   import {page} from \"$app/stores\"\n@@ -7,8 +7,15 @@\n   import {now, formatTimestampAsDate} from \"@welshman/lib\"\n   import {request} from \"@welshman/net\"\n   import type {TrustedEvent, EventContent} from \"@welshman/util\"\n-  import {createEvent, MESSAGE, DELETE, REACTION, GROUP_ADD_USER, GROUP_REMOVE_USER} from \"@welshman/util\"\n-  import {pubkey, publishThunk, deriveRelay, getThunkError, waitForThunkCompletion} from \"@welshman/app\"\n+  import {\n+    createEvent,\n+    MESSAGE,\n+    DELETE,\n+    REACTION,\n+    GROUP_ADD_USER,\n+    GROUP_REMOVE_USER,\n+  } from \"@welshman/util\"\n+  import {pubkey, publishThunk, getThunkError} from \"@welshman/app\"\n   import {slide, fade, fly} from \"@lib/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n@@ -26,7 +33,6 @@\n     userSettingValues,\n     decodeRelay,\n     tagRoom,\n-    displayChannel,\n     getEventsForUrl,\n     deriveUserMembershipStatus,\n     deriveChannel,\n@@ -245,15 +251,17 @@\n   onMount(() =\u003e {\n     const controller = new AbortController()\n \n-    const req = request({\n+    request({\n       signal: controller.signal,\n       relays: [url],\n-      filters: [{\n-        kinds: [GROUP_ADD_USER, GROUP_REMOVE_USER],\n-        '#p': [$pubkey!],\n-        '#h': [room],\n-        limit: 10,\n-      }],\n+      filters: [\n+        {\n+          kinds: [GROUP_ADD_USER, GROUP_REMOVE_USER],\n+          \"#p\": [$pubkey!],\n+          \"#h\": [room],\n+          limit: 10,\n+        },\n+      ],\n     })\n \n     const observer = new ResizeObserver(() =\u003e {\n@@ -296,11 +304,20 @@\n   {/snippet}\n   {#snippet action()}\n     \u003cdiv class=\"row-2\"\u003e\n+      {#if $membershipStatus !== MembershipStatus.Initial}\n+        \u003cButton\n+          class=\"btn btn-neutral btn-sm tooltip tooltip-left\"\n+          data-tip=\"Request to be removed from member list\"\n+          disabled={leaving}\n+          onclick={leave}\u003e\n+          \u003cIcon size={4} icon=\"arrows-a-logout-2\" /\u003e\n+        \u003c/Button\u003e\n+      {/if}\n       \u003cButton\n         class=\"btn btn-neutral btn-sm tooltip tooltip-left\"\n         data-tip={isFavorite ? \"Remove Favorite\" : \"Add Favorite\"}\n         onclick={isFavorite ? removeFavorite : addFavorite}\u003e\n-        \u003cIcon size={4} icon=\"bookmark\" class={cx({'text-primary': isFavorite})} /\u003e\n+        \u003cIcon size={4} icon=\"bookmark\" class={cx({\"text-primary\": isFavorite})} /\u003e\n       \u003c/Button\u003e\n       \u003cMenuSpaceButton {url} /\u003e\n     \u003c/div\u003e\n@@ -312,9 +329,7 @@\n   {#if $channel?.private \u0026\u0026 $membershipStatus !== MembershipStatus.Granted}\n     \u003cdiv class=\"py-20\"\u003e\n       \u003cdiv class=\"card2 col-8 m-auto max-w-md items-center text-center\"\u003e\n-        \u003cp class=\"row-2\"\u003e\n-          You aren't currently a member of this room.\n-        \u003c/p\u003e\n+        \u003cp class=\"row-2\"\u003eYou aren't currently a member of this room.\u003c/p\u003e\n         {#if $membershipStatus === MembershipStatus.Pending}\n           \u003cButton class=\"btn btn-neutral btn-sm\" disabled={leaving} onclick={leave}\u003e\n             \u003cIcon icon=\"clock-circle\" /\u003e\n@@ -349,7 +364,6 @@\n         \u003cdiv in:slide class:-mt-1={!showPubkey}\u003e\n           \u003cChannelMessage\n             {url}\n-            {room}\n             {replyTo}\n             event={$state.snapshot(value as TrustedEvent)}\n             {showPubkey} /\u003e\n@@ -370,7 +384,7 @@\n   {#if $channel?.private \u0026\u0026 $membershipStatus !== MembershipStatus.Granted}\n     \u003c!-- pass --\u003e\n   {:else if $channel?.closed \u0026\u0026 $membershipStatus !== MembershipStatus.Granted}\n-    \u003cdiv class=\"flex flex-row items-center justify-between m-4 px-4 py-3 card bg-alt\"\u003e\n+    \u003cdiv class=\"bg-alt card m-4 flex flex-row items-center justify-between px-4 py-3\"\u003e\n       \u003cp\u003eOnly members are allowed to post to this room.\u003c/p\u003e\n       {#if $membershipStatus === MembershipStatus.Pending}\n         \u003cButton class=\"btn btn-neutral btn-sm\" disabled={leaving} onclick={leave}\u003e\ndiff --git a/src/routes/spaces/[relay]/chat/+page.svelte b/src/routes/spaces/[relay]/chat/+page.svelte\nnew file mode 100644\nindex 0000000..11c6d38\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/chat/+page.svelte\n@@ -0,0 +1,279 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {readable} from \"svelte/store\"\n+  import {onMount, onDestroy} from \"svelte\"\n+  import {page} from \"$app/stores\"\n+  import type {Readable} from \"svelte/store\"\n+  import {now, formatTimestampAsDate} from \"@welshman/lib\"\n+  import type {TrustedEvent, EventContent} from \"@welshman/util\"\n+  import {createEvent, MESSAGE, DELETE, REACTION} from \"@welshman/util\"\n+  import {pubkey, publishThunk} from \"@welshman/app\"\n+  import {slide, fade, fly} from \"@lib/transition\"\n+  import Icon from \"@lib/components/Icon.svelte\"\n+  import Button from \"@lib/components/Button.svelte\"\n+  import Spinner from \"@lib/components/Spinner.svelte\"\n+  import PageBar from \"@lib/components/PageBar.svelte\"\n+  import PageContent from \"@lib/components/PageContent.svelte\"\n+  import Divider from \"@lib/components/Divider.svelte\"\n+  import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n+  import ChannelMessage from \"@app/components/ChannelMessage.svelte\"\n+  import ChannelCompose from \"@app/components/ChannelCompose.svelte\"\n+  import ChannelComposeParent from \"@app/components/ChannelComposeParent.svelte\"\n+  import {userSettingValues, decodeRelay, getEventsForUrl} from \"@app/state\"\n+  import {setChecked, checked} from \"@app/notifications\"\n+  import {prependParent} from \"@app/commands\"\n+  import {PROTECTED} from \"@app/state\"\n+  import {makeFeed} from \"@app/requests\"\n+  import {popKey} from \"@app/implicit\"\n+\n+  const mounted = now()\n+  const lastChecked = $checked[$page.url.pathname]\n+  const url = decodeRelay($page.params.relay)\n+  const filter = {kinds: [MESSAGE]}\n+\n+  const replyTo = (event: TrustedEvent) =\u003e {\n+    parent = event\n+    compose?.focus()\n+  }\n+\n+  const clearParent = () =\u003e {\n+    parent = undefined\n+  }\n+\n+  const clearShare = () =\u003e {\n+    share = undefined\n+  }\n+\n+  const onSubmit = ({content, tags}: EventContent) =\u003e {\n+    tags.push(PROTECTED)\n+\n+    let template = {content, tags}\n+\n+    if (share) {\n+      template = prependParent(share, template)\n+    }\n+\n+    if (parent) {\n+      template = prependParent(parent, template)\n+    }\n+\n+    publishThunk({\n+      relays: [url],\n+      event: createEvent(MESSAGE, template),\n+      delay: $userSettingValues.send_delay,\n+    })\n+\n+    clearParent()\n+    clearShare()\n+  }\n+\n+  const onScroll = () =\u003e {\n+    showScrollButton = Math.abs(element?.scrollTop || 0) \u003e 1500\n+\n+    if (!newMessages || newMessagesSeen) {\n+      showFixedNewMessages = false\n+    } else {\n+      const {y} = newMessages.getBoundingClientRect()\n+\n+      if (y \u003e 300) {\n+        newMessagesSeen = true\n+      } else {\n+        showFixedNewMessages = y \u003c 0\n+      }\n+    }\n+  }\n+\n+  const scrollToNewMessages = () =\u003e\n+    newMessages?.scrollIntoView({behavior: \"smooth\", block: \"center\"})\n+\n+  const scrollToBottom = () =\u003e element?.scrollTo({top: 0, behavior: \"smooth\"})\n+\n+  let loadingEvents = $state(true)\n+  let share = $state(popKey\u003cTrustedEvent | undefined\u003e(\"share\"))\n+  let parent: TrustedEvent | undefined = $state()\n+  let element: HTMLElement | undefined = $state()\n+  let newMessages: HTMLElement | undefined = $state()\n+  let chatCompose: HTMLElement | undefined = $state()\n+  let dynamicPadding: HTMLElement | undefined = $state()\n+  let newMessagesSeen = false\n+  let showFixedNewMessages = $state(false)\n+  let showScrollButton = $state(false)\n+  let cleanup: () =\u003e void\n+  let events: Readable\u003cTrustedEvent[]\u003e = $state(readable([]))\n+  let compose: ChannelCompose | undefined = $state()\n+\n+  const elements = $derived.by(() =\u003e {\n+    const elements = []\n+    const seen = new Set()\n+\n+    let previousDate\n+    let previousPubkey\n+    let newMessagesSeen = false\n+\n+    if (events) {\n+      const lastUserEvent = $events.find(e =\u003e e.pubkey === $pubkey)\n+\n+      // Adjust last checked to account for messages that came from a different device\n+      const adjustedLastChecked =\n+        lastChecked \u0026\u0026 lastUserEvent ? Math.max(lastUserEvent.created_at, lastChecked) : lastChecked\n+\n+      for (const event of $events.toReversed()) {\n+        if (seen.has(event.id)) {\n+          continue\n+        }\n+\n+        const date = formatTimestampAsDate(event.created_at)\n+\n+        if (\n+          !newMessagesSeen \u0026\u0026\n+          adjustedLastChecked \u0026\u0026\n+          event.pubkey !== $pubkey \u0026\u0026\n+          event.created_at \u003e adjustedLastChecked \u0026\u0026\n+          event.created_at \u003c mounted\n+        ) {\n+          elements.push({type: \"new-messages\", id: \"new-messages\"})\n+          newMessagesSeen = true\n+        }\n+\n+        if (date !== previousDate) {\n+          elements.push({type: \"date\", value: date, id: date, showPubkey: false})\n+        }\n+\n+        elements.push({\n+          id: event.id,\n+          type: \"note\",\n+          value: event,\n+          showPubkey: date !== previousDate || previousPubkey !== event.pubkey,\n+        })\n+\n+        previousDate = date\n+        previousPubkey = event.pubkey\n+        seen.add(event.id)\n+      }\n+    }\n+\n+    elements.reverse()\n+\n+    setTimeout(onScroll, 100)\n+\n+    return elements\n+  })\n+\n+  onMount(() =\u003e {\n+    const controller = new AbortController()\n+\n+    const observer = new ResizeObserver(() =\u003e {\n+      if (dynamicPadding \u0026\u0026 chatCompose) {\n+        dynamicPadding!.style.minHeight = `${chatCompose!.offsetHeight}px`\n+      }\n+    })\n+\n+    observer.observe(chatCompose!)\n+    observer.observe(dynamicPadding!)\n+\n+    const feed = makeFeed({\n+      element: element!,\n+      relays: [url],\n+      feedFilters: [filter],\n+      subscriptionFilters: [{kinds: [DELETE, REACTION, MESSAGE], since: now()}],\n+      initialEvents: getEventsForUrl(url, [{...filter, limit: 20}]),\n+      onExhausted: () =\u003e {\n+        loadingEvents = false\n+      },\n+    })\n+\n+    events = feed.events\n+    cleanup = feed.cleanup\n+\n+    return () =\u003e {\n+      controller.abort()\n+      observer.unobserve(chatCompose!)\n+      observer.unobserve(dynamicPadding!)\n+    }\n+  })\n+\n+  onDestroy(() =\u003e {\n+    cleanup()\n+\n+    // Sveltekit calls onDestroy at the beginning of the page load for some reason\n+    setTimeout(() =\u003e {\n+      setChecked($page.url.pathname)\n+    }, 800)\n+  })\n+\u003c/script\u003e\n+\n+\u003cPageBar\u003e\n+  {#snippet icon()}\n+    \u003cdiv class=\"center\"\u003e\n+      \u003cIcon icon=\"chat-round\" /\u003e\n+    \u003c/div\u003e\n+  {/snippet}\n+  {#snippet title()}\n+    \u003cstrong\u003eChat\u003c/strong\u003e\n+  {/snippet}\n+  {#snippet action()}\n+    \u003cMenuSpaceButton {url} /\u003e\n+  {/snippet}\n+\u003c/PageBar\u003e\n+\n+\u003cPageContent bind:element onscroll={onScroll} class=\"flex flex-col-reverse pt-4\"\u003e\n+  \u003cdiv bind:this={dynamicPadding}\u003e\u003c/div\u003e\n+  {#each elements as { type, id, value, showPubkey } (id)}\n+    {#if type === \"new-messages\"}\n+      \u003cdiv\n+        bind:this={newMessages}\n+        class=\"flex items-center py-2 text-xs transition-colors\"\n+        class:opacity-0={showFixedNewMessages}\u003e\n+        \u003cdiv class=\"h-px flex-grow bg-primary\"\u003e\u003c/div\u003e\n+        \u003cp class=\"rounded-full bg-primary px-2 py-1 text-primary-content\"\u003eNew Messages\u003c/p\u003e\n+        \u003cdiv class=\"h-px flex-grow bg-primary\"\u003e\u003c/div\u003e\n+      \u003c/div\u003e\n+    {:else if type === \"date\"}\n+      \u003cDivider\u003e{value}\u003c/Divider\u003e\n+    {:else}\n+      \u003cdiv in:slide class:-mt-1={!showPubkey}\u003e\n+        \u003cChannelMessage\n+          {url}\n+          {replyTo}\n+          event={$state.snapshot(value as TrustedEvent)}\n+          {showPubkey} /\u003e\n+      \u003c/div\u003e\n+    {/if}\n+  {/each}\n+  \u003cp class=\"flex h-10 items-center justify-center py-20\"\u003e\n+    {#if loadingEvents}\n+      \u003cSpinner loading={loadingEvents}\u003eLooking for messages...\u003c/Spinner\u003e\n+    {:else}\n+      \u003cSpinner\u003eEnd of message history\u003c/Spinner\u003e\n+    {/if}\n+  \u003c/p\u003e\n+\u003c/PageContent\u003e\n+\n+\u003cdiv class=\"chat__compose bg-base-200\" bind:this={chatCompose}\u003e\n+  \u003cdiv\u003e\n+    {#if parent}\n+      \u003cChannelComposeParent event={parent} clear={clearParent} verb=\"Replying to\" /\u003e\n+    {/if}\n+    {#if share}\n+      \u003cChannelComposeParent event={share} clear={clearShare} verb=\"Sharing\" /\u003e\n+    {/if}\n+  \u003c/div\u003e\n+  \u003cChannelCompose bind:this={compose} {onSubmit} {url} /\u003e\n+\u003c/div\u003e\n+\n+{#if showScrollButton}\n+  \u003cdiv in:fade class=\"chat__scroll-down\"\u003e\n+    \u003cButton class=\"btn btn-circle btn-neutral\" onclick={scrollToBottom}\u003e\n+      \u003cIcon icon=\"alt-arrow-down\" /\u003e\n+    \u003c/Button\u003e\n+  \u003c/div\u003e\n+{/if}\n+\n+{#if showFixedNewMessages}\n+  \u003cdiv class=\"relative z-feature flex justify-center\"\u003e\n+    \u003cdiv transition:fly={{duration: 200}} class=\"fixed top-12\"\u003e\n+      \u003cButton class=\"btn btn-primary btn-xs rounded-full\" onclick={scrollToNewMessages}\u003e\n+        New Messages\n+      \u003c/Button\u003e\n+    \u003c/div\u003e\n+  \u003c/div\u003e\n+{/if}\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-5751xiyi","title":"From 8a91aab3db87dcbb7b4c5f61c11f7301b5f7d499 Mon Sep 17 00:00:00 2001","description":"From 8a91aab3db87dcbb7b4c5f61c11f7301b5f7d499 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Wed, 9 Jul 2025 17:44:40 -0700\nSubject: [PATCH 1/3] refactor: simplify tag filtering logic and improve patch thread handling\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           | 12 ++++--------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts               | 10 +++++-----\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 26 ++++++++++++++++++--------\n 3 files changed, 27 insertions(+), 21 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex fe914a5..afe36df 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -40,26 +40,22 @@\n       // First get all root patches\n       let filteredPatches = repoClass.patches\n         .filter((patch: PatchEvent) =\u003e {\n-          const tags = getTags(patch, \"t\")\n-          return tags.length \u003e 0 \u0026\u0026 tags[0][1] === \"root\"\n+          return getTags(patch, \"t\").find((tag: string[]) =\u003e tag[1] === \"root\")\n         })\n         .map((patch: PatchEvent) =\u003e {\n           const status = $statusEvents\n             ?.filter((s: any) =\u003e {\n-              let [_, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n-              return eventId === patch.id\n+              return getTags(s, \"e\").find((tag: string[]) =\u003e tag[1] === patch.id)\n             })\n             .sort((a: any, b: any) =\u003e b.created_at - a.created_at)[0]\n \n           const patches = repoClass.patches.filter(issue =\u003e {\n-            const tags = getTags(issue, \"e\")\n-            return tags.length \u003e 0 \u0026\u0026 tags[0][1] === patch.id\n+            return getTags(issue, \"e\").find((tag: string[]) =\u003e tag[1] === patch.id)\n           })\n           const parsedPatch = parseGitPatchFromEvent(patch)\n \n           const commentEvents = $comments?.filter((comment: any) =\u003e {\n-            const tags = getTags(comment, \"E\")\n-            return tags.length \u003e 0 \u0026\u0026 tags[0][1] === patch.id\n+            return getTags(comment, \"E\").find((tag: string[]) =\u003e tag[1] === patch.id)\n           })\n \n           return {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\nindex de13afa..9a18b65 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\n@@ -34,6 +34,11 @@ export const load = async ({parent}) =\u003e {\n     \"#t\": [\"root\"],\n   }\n \n+  await load({\n+    relays: repoClass.relays,\n+    filters: [commentFilter, statusEventFilter, patchFilter],\n+  })\n+\n   const statusEvents = deriveEvents(repository, {filters: [statusEventFilter]})\n \n   const comments = derived(\n@@ -43,11 +48,6 @@ export const load = async ({parent}) =\u003e {\n \n   const uniqueAuthors = new Set(repoClass.patches.map((patch: PatchEvent) =\u003e patch.pubkey))\n \n-  await load({\n-    relays: repoClass.relays,\n-    filters: [commentFilter, statusEventFilter, patchFilter],\n-  })\n-\n   return {\n     comments,\n     statusEvents,\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 3765238..0eaf1f6 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -1,6 +1,14 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n-  import {Check, ChevronLeft, ChevronRight, GitCommit, GitMerge, MessageSquare, X} from \"@lucide/svelte\"\n+  import {\n+    Check,\n+    ChevronLeft,\n+    ChevronRight,\n+    GitCommit,\n+    GitMerge,\n+    MessageSquare,\n+    X,\n+  } from \"@lucide/svelte\"\n   import {Button, Profile} from \"@nostr-git/ui\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import {DiffViewer, IssueThread} from \"@nostr-git/ui\"\n@@ -58,10 +66,13 @@\n     .filter((p): p is PatchEvent =\u003e {\n       if (p.id === patchId) return true\n       const directReplyToThis = getTags(p, \"e\").some(tag =\u003e tag[1] === patchId)\n-      if (directReplyToThis) return true\n+      if (directReplyToThis) {\n+        console.log(\"direct reply to this:\", p)\n+        return true\n+      }\n       if (rootPatchId !== patchId) {\n         const replyTags = getTags(p, \"e\")\n-        if (replyTags.length \u003e 0) {\n+        if (replyTags.length === 0) {\n           let checkPatch: PatchEvent | undefined = p\n           let foundRoot = false\n \n@@ -87,6 +98,8 @@\n     .sort((a, b) =\u003e (a.id === rootPatchId ? -1 : 1))\n     .map(p =\u003e parseGitPatchFromEvent(p))\n \n+console.log(\"patchSet:\", patchSet)\n+\n   let selectedPatch = $state(patch)\n \n   const threadComments = $derived.by(() =\u003e {\n@@ -125,10 +138,7 @@\n     typographer: true,\n   })\n \n-  const applyPatch = () =\u003e {\n-    \n-  }\n-\n+  const applyPatch = () =\u003e {}\n \u003c/script\u003e\n \n {#if patch}\n@@ -254,7 +264,7 @@\n                       \u003cspan\u003e{new Date(selectedPatch.createdAt).toLocaleString()}\u003c/span\u003e\n                       {#if selectedPatch.commitHash}\n                         \u003cspan\u003e•\u003c/span\u003e\n-                        \u003cspan\u003e{selectedPatch.commitHash}\u003c/span\u003e\n+                        \u003cspan\u003e{selectedPatch.commitHash.slice(0, 8)}\u003c/span\u003e\n                       {/if}\n                     \u003c/div\u003e\n                   \u003c/div\u003e\n--\nlibgit2 1.9.0\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-5e3qfjp2","title":"From 8a91aab3db87dcbb7b4c5f61c11f7301b5f7d499 Mon Sep 17 00:00:00 2001","description":"From 8a91aab3db87dcbb7b4c5f61c11f7301b5f7d499 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Wed, 9 Jul 2025 17:44:40 -0700\nSubject: [PATCH 1/9] refactor: simplify tag filtering logic and improve patch thread handling\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           | 12 ++++--------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts               | 10 +++++-----\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 26 ++++++++++++++++++--------\n 3 files changed, 27 insertions(+), 21 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex fe914a5..afe36df 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -40,26 +40,22 @@\n       // First get all root patches\n       let filteredPatches = repoClass.patches\n         .filter((patch: PatchEvent) =\u003e {\n-          const tags = getTags(patch, \"t\")\n-          return tags.length \u003e 0 \u0026\u0026 tags[0][1] === \"root\"\n+          return getTags(patch, \"t\").find((tag: string[]) =\u003e tag[1] === \"root\")\n         })\n         .map((patch: PatchEvent) =\u003e {\n           const status = $statusEvents\n             ?.filter((s: any) =\u003e {\n-              let [_, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n-              return eventId === patch.id\n+              return getTags(s, \"e\").find((tag: string[]) =\u003e tag[1] === patch.id)\n             })\n             .sort((a: any, b: any) =\u003e b.created_at - a.created_at)[0]\n \n           const patches = repoClass.patches.filter(issue =\u003e {\n-            const tags = getTags(issue, \"e\")\n-            return tags.length \u003e 0 \u0026\u0026 tags[0][1] === patch.id\n+            return getTags(issue, \"e\").find((tag: string[]) =\u003e tag[1] === patch.id)\n           })\n           const parsedPatch = parseGitPatchFromEvent(patch)\n \n           const commentEvents = $comments?.filter((comment: any) =\u003e {\n-            const tags = getTags(comment, \"E\")\n-            return tags.length \u003e 0 \u0026\u0026 tags[0][1] === patch.id\n+            return getTags(comment, \"E\").find((tag: string[]) =\u003e tag[1] === patch.id)\n           })\n \n           return {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\nindex de13afa..9a18b65 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\n@@ -34,6 +34,11 @@ export const load = async ({parent}) =\u003e {\n     \"#t\": [\"root\"],\n   }\n \n+  await load({\n+    relays: repoClass.relays,\n+    filters: [commentFilter, statusEventFilter, patchFilter],\n+  })\n+\n   const statusEvents = deriveEvents(repository, {filters: [statusEventFilter]})\n \n   const comments = derived(\n@@ -43,11 +48,6 @@ export const load = async ({parent}) =\u003e {\n \n   const uniqueAuthors = new Set(repoClass.patches.map((patch: PatchEvent) =\u003e patch.pubkey))\n \n-  await load({\n-    relays: repoClass.relays,\n-    filters: [commentFilter, statusEventFilter, patchFilter],\n-  })\n-\n   return {\n     comments,\n     statusEvents,\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 3765238..0eaf1f6 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -1,6 +1,14 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n-  import {Check, ChevronLeft, ChevronRight, GitCommit, GitMerge, MessageSquare, X} from \"@lucide/svelte\"\n+  import {\n+    Check,\n+    ChevronLeft,\n+    ChevronRight,\n+    GitCommit,\n+    GitMerge,\n+    MessageSquare,\n+    X,\n+  } from \"@lucide/svelte\"\n   import {Button, Profile} from \"@nostr-git/ui\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import {DiffViewer, IssueThread} from \"@nostr-git/ui\"\n@@ -58,10 +66,13 @@\n     .filter((p): p is PatchEvent =\u003e {\n       if (p.id === patchId) return true\n       const directReplyToThis = getTags(p, \"e\").some(tag =\u003e tag[1] === patchId)\n-      if (directReplyToThis) return true\n+      if (directReplyToThis) {\n+        console.log(\"direct reply to this:\", p)\n+        return true\n+      }\n       if (rootPatchId !== patchId) {\n         const replyTags = getTags(p, \"e\")\n-        if (replyTags.length \u003e 0) {\n+        if (replyTags.length === 0) {\n           let checkPatch: PatchEvent | undefined = p\n           let foundRoot = false\n \n@@ -87,6 +98,8 @@\n     .sort((a, b) =\u003e (a.id === rootPatchId ? -1 : 1))\n     .map(p =\u003e parseGitPatchFromEvent(p))\n \n+console.log(\"patchSet:\", patchSet)\n+\n   let selectedPatch = $state(patch)\n \n   const threadComments = $derived.by(() =\u003e {\n@@ -125,10 +138,7 @@\n     typographer: true,\n   })\n \n-  const applyPatch = () =\u003e {\n-    \n-  }\n-\n+  const applyPatch = () =\u003e {}\n \u003c/script\u003e\n \n {#if patch}\n@@ -254,7 +264,7 @@\n                       \u003cspan\u003e{new Date(selectedPatch.createdAt).toLocaleString()}\u003c/span\u003e\n                       {#if selectedPatch.commitHash}\n                         \u003cspan\u003e•\u003c/span\u003e\n-                        \u003cspan\u003e{selectedPatch.commitHash}\u003c/span\u003e\n+                        \u003cspan\u003e{selectedPatch.commitHash.slice(0, 8)}\u003c/span\u003e\n                       {/if}\n                     \u003c/div\u003e\n                   \u003c/div\u003e\n--\nlibgit2 1.9.0\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-5q9snbyu","title":"Repo can be undefined under some circumstances","description":"Reproduce:\n1. Go to issues\n2. Reload page several times\n3. Most likely after a few reloads 'repoEvent' in layout.ts will be undefined causing errors down the line\nThe problem is that we are using deriveEvent for the repo event to load which is NOT guaranteed to load when 'new Repo' is created in layout.ts load function.\nThere we need to somehow handle the repo event being undefined possibly initially","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue"]}
{"id":"flotilla-62rcpfhw","title":"From 98a614ed5933227aa6ba0cc2f3b17350c3bce989 Mon Sep 17 00:00:00 2001","description":"From 98a614ed5933227aa6ba0cc2f3b17350c3bce989 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Thu, 20 Nov 2025 12:10:34 +0500\nSubject: [PATCH 3/6] feat(markdown): created a markdown component and used it in issue page\n\n---\n pnpm-lock.yaml | Bin 542998 -\u003e 549117 bytes\n 1 file changed, 0 insertions(+), 0 deletions(-)\n\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 8939b762a97d4e4f6730e64c7bba10fa625c5c74..85c9f3693292ddcb35ce3df50e4993c693cf2a73 100644\nGIT binary patch\ndelta 6680\nzc%1E*\u00262QsG7{;~Te\u0026n!1T6(FrV\u0026\u0026B;QPIk-Ka-eMM7L?vCNxRYrfCu((0DwFr}fu*\nz#\u003eqAyazLWzr3k|f5EpKs9IBPLaN)EPqDRD$1OEd;V%#o51!+%6x%e\u003c+\u0026%Dogo*BKr\nz(fHGk@BR71y\u003eCBTn*6eqpBV?pMt~q55P~QX`j}dw5fT(Y\u0026!xzv0`#2Kt6ts@JTrt8\nzdoF)%*s3HdSzVJQSzPTYqMC=I!fPT#ysD@=4|)m{LPG(DD8rm;zDfK-kRgMDEbd8p\nzUXplG\u0026yb*CWQZRWEJ}TnA\u00265m~Ee=Y0Qx?\u003c8BQeJ+RqbX10?h)T6hO;i7Sqc5gC4e#\nz3mlYIHqOAqyW?0x3\u00268hn3_\u003cKTEtfn\u003c5#\u003cRD5O6Z\u0026*u!Q)\u0026qCQ$C6U*1Y$8\u003cw5)Y7R\nz^1zUEH3vYBS!Pnoq\u003e7#g*{r7Wx}Gz5HHUQGkYt0`HAyq_de%@)6iY8{k6-wf^w@Wn\nzRhrgi(U\u0026ZW9Fuqhj^kbVXH#\u0026$u$z|G\u003cp%R#3OXA`(H5JBb|;(Ntji_CuN%ATHClm{\nzBJ2)JyE{Yn\u00265g{_ct{KAq#~mBBV5Oow^~vI?-VPRu?6FH`CwF*YPg~cOyonQ8h5\u0026\u0026\nzz2}*S\u003c**~`w2X(i({3G?k30;W7U\u003e?AM%{hMf=bOcx2s`Swnebr!e+Z\u003eL#H+{+\u0026$ZH\nz8-I@-V\u003c5M*cyRoz?w3i~X{oSS\u0026Q_aHu8t0rdb1\u003cfi$iQU6^H4b)JC0AtqHa2sG~Bc\nz!wxfZZE{wi+!En-WzgMj9hqD9z`z\u003cdwsgG13_#}~G-W\u0026NZs`g\u003cakQ}8Zs1-+*s=I}\nzZy\u003cW\u003erRM%_)!RPtG$}Cb{qhz|2mSbo(+C\u003cC_AJHN%mj$|p3AcOMeg$^W*r2_`Exzr\nz(z5ukjFbL5nx6RRB`FyF{LRAR\u003caGI++X;jTgb9RGfpGH2!`#f|gVp6*34{rR353\u0026v\nz@S{}1U\u00263F)-*j%GPrsjEJbPDLn!K{vNJnd*%-\u003e!YUtbwuiq\u003cqi6=ZQ`E\u0026c\u003eqbv+ZU\nz$*PbSSe\u0026AO(HSdL*1Xaax~2%Spt5H4{Hyu9lgCHD_oJ2fXK#(07ABl;hkfjF79d\u003ec\nznkeXdF5*~jxwyx?xs-zzaQlb|-0mgT9P?*#)Vg|c5C\u003ee73;lioOvF*|GGc\u003exUd})i\nza0BLvEs*PZ0T-_xyCE_;68iqE7f|8syI+eRMi-~i#f|gmV\u0026;vnlT#--b\u0026^wODyPob\nzm+vh`rQyxw_cviMVQ@MOo\u003c1AiWM!6\u003ex$|ek`B#5SU`$|4V4Ti1TvF!lL_dALFn7N5\nr_QLST|Men%_V`GO{N\u003ec0bMAhsoQk}s^K\u0026=E2;5Jl\u0026%bz(8oc%wfnAUR\n\ndelta 208\nzc%1utP;uHM#SJqg*mDa?i!#$HCr|X0U^JebXfDEPtY@reu(@Btk!f\u003cOW9H^Mxhz32\nzW16uyACzIhw0Xa~KO2ZQS)xK^^Mk-Z)yZ@1G^XFP;*g\u0026F)=pvb=kn?4(|5gQl$!3a\nzhgEQL{Bz0a9-CQtoAV#E=RaWFp8tSJeF;!|(qzXr;pqV#%pfb0+BtfdftUq|S+{fa\nsun9c@iB5NPW0l%|yO_P^7|4$8Ks)L\u003crmtAR\u003c~rFxO=SB@XO0kA0OLwfO#lD@\n\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-66ivt7fy","title":"From a42c3f2f761ac5c479dd7ae41f500f623b7aa479 Mon Sep 17 00:00:00 2001","description":"From a42c3f2f761ac5c479dd7ae41f500f623b7aa479 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 14 Aug 2025 09:27:23 -0700\nSubject: [PATCH 1/2] fix: remove hardcoded main branch fallbacks and require canonical repo key for operations\n\n---\n packages/nostr-git                                                      |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte                   |  4 ++--\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte              |  4 ++--\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte            | 12 ++++++++++--\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 30 +++++++++++++++++++++---------\n 5 files changed, 36 insertions(+), 16 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 85da9f4..261627e 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 85da9f47bffcc3d0fd51f5cd17acda8bd607fdf4\n+Subproject commit 261627e06c4be63e31ce3608a043b6b30a51ea50\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 57fe9fe..c1f6a47 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -74,7 +74,7 @@\n     relays: $repoRelays,\n     cloneUrls: repoClass.repo?.clone || [],\n     webUrls: repoClass.repo?.web || [],\n-    mainBranch: repoClass.mainBranch || \"main\",\n+    mainBranch: repoClass.mainBranch,\n     createdAt: repoClass.repoEvent?.created_at\n       ? new Date(repoClass.repoEvent.created_at * 1000)\n       : null,\n@@ -86,7 +86,7 @@\n   // Defaults for Terminal\n   const repoCloneUrls = $derived(repoMetadata.cloneUrls || [])\n   const defaultRemoteUrl = $derived(repoCloneUrls[0])\n-  const defaultBranch = $derived(repoMetadata.mainBranch || 'main')\n+  const defaultBranch = $derived(repoMetadata.mainBranch || '')\n   const detectedProvider = $derived(detectProviderFromUrl(defaultRemoteUrl || repoMetadata.relays?.[0]))\n   const defaultToken = $derived(detectedProvider === 'grasp' ? $pubkey : undefined)\n   const relayUrl = $derived(decodeRelay($page.params.relay))\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex b0d256f..9687008 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -181,11 +181,11 @@\n                             if (error instanceof Error \u0026\u0026 error.message.includes('Could not find')) {\n                               const { pushToast } = await import('@app/toast')\n                               pushToast({\n-                                message: `Branch '${ref.name}' not available locally. This branch exists in the repository state but may have been deleted, merged, or not fetched locally. Switching to main branch instead.`,\n+                                message: `Branch '${ref.name}' is not available locally. It may have been deleted, merged, or not fetched yet. Using the repository's default branch instead.`,\n                                 theme: 'error',\n                                 timeout: 8000\n                               })\n-                              selectedBranch = repoClass.mainBranch || 'main'\n+                              selectedBranch = repoClass.mainBranch || ''\n                             } else {\n                               console.error('Branch selection error:', error)\n                             }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex 3411d4c..309bc2b 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -1,5 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {IssueCard, NewIssueForm, Button} from \"@nostr-git/ui\"\n+  import {IssueCard, NewIssueForm, Button, toast} from \"@nostr-git/ui\"\n   import {\n     CalendarDays,\n     Check,\n@@ -238,8 +238,16 @@\n   }\n \n   const onNewIssue = () =\u003e {\n+    if (!repoClass.canonicalKey) {\n+      toast.push({\n+        message: \"Repository is still initializing (missing canonical key). Please try again shortly.\",\n+        timeout: 6000,\n+        variant: \"destructive\",\n+      })\n+      return\n+    }\n     pushModal(NewIssueForm, {\n-      repoId: repoClass.repoId,\n+      repoId: repoClass.canonicalKey,\n       repoOwnerPubkey: repoClass.repoEvent?.pubkey,\n       onIssueCreated,\n     })\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 3bcf456..25e90c8 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -124,8 +124,8 @@\n       return\n     }\n \n-    // Use robust branch detection: patch baseBranch, repo mainBranch, or fallback\n-    const targetBranch = sel.baseBranch || repoClass.mainBranch || \"main\"\n+    // Use robust branch detection: prefer patch baseBranch, then repo mainBranch\n+    const targetBranch = sel.baseBranch || repoClass.mainBranch\n \n     // Resolve the PatchEvent corresponding to the currently selected parsed patch\n     const selectedPatchEvent = repoClass.patches.find(p =\u003e p.id === sel.id)\n@@ -302,7 +302,7 @@\n           email: commit.author?.email || \"\",\n         },\n       })),\n-      baseBranch: selectedPatch.baseBranch || repoClass.mainBranch || \"main\",\n+      baseBranch: selectedPatch.baseBranch || repoClass.mainBranch,\n       rawContent: selectedPatch.raw?.content || \"\",\n     }\n \n@@ -368,7 +368,19 @@\n \n     // Execute merge via worker\n     // Use canonical repo ID consistently for worker operations\n-    const effectiveRepoId = repoClass.canonicalKey || repoClass.repoId || \"\"\n+    // Require canonical repo key to avoid Invalid repoId issues\n+    if (!repoClass.canonicalKey) {\n+      mergeError = \"Repository identifier is not ready (missing canonical key).\"\n+      mergeStep = \"Setup failed\"\n+      isMerging = false\n+      toast.push({\n+        message: \"Repository is still initializing. Please try again once metadata loads.\",\n+        timeout: 6000,\n+        variant: \"destructive\",\n+      })\n+      return\n+    }\n+    const effectiveRepoId = repoClass.canonicalKey\n \n     try {\n       const result = await repoClass.workerManager.applyPatchAndPush({\n@@ -598,7 +610,7 @@\n             \u003cdiv class=\"flex items-center justify-between\"\u003e\n               \u003cspan class=\"text-muted-foreground\"\u003eTarget Branch:\u003c/span\u003e\n               \u003ccode class=\"rounded bg-background px-2 py-1 text-xs\"\u003e\n-                {selectedPatch?.baseBranch || \"main\"}\n+                {selectedPatch?.baseBranch || repoClass.mainBranch || \"-\"}\n               \u003c/code\u003e\n             \u003c/div\u003e\n \n@@ -776,7 +788,7 @@\n           \u003cMergeStatus\n             result={mergeAnalysisResult}\n             loading={isAnalyzingMerge}\n-            targetBranch={selectedPatch?.baseBranch || repoClass.mainBranch || \"main\"} /\u003e\n+            targetBranch={selectedPatch?.baseBranch || repoClass.mainBranch || \"\"} /\u003e\n         \u003c/div\u003e\n \n         \u003cdiv class=\"git-separator\"\u003e\u003c/div\u003e\n@@ -869,7 +881,7 @@\n                 \u003cdiv\u003e\n                   \u003ch3 class=\"font-semibold\"\u003eMerge this patch\u003c/h3\u003e\n                   \u003cp class=\"text-sm text-muted-foreground\"\u003e\n-                    Apply the changes from this patch to the {repoClass.mainBranch || \"main\"} branch\n+                    Apply the changes from this patch to the {(selectedPatch?.baseBranch || repoClass.mainBranch) || \"-\"} branch\n                   \u003c/p\u003e\n                 \u003c/div\u003e\n               \u003c/div\u003e\n@@ -1022,14 +1034,14 @@\n                 \u003cdiv\u003e\n                   \u003cp class=\"mb-2 text-sm text-muted-foreground\"\u003e\n                     This will merge the patch into \u003ccode class=\"rounded bg-muted px-1\"\n-                      \u003e{repoClass.mainBranch || \"main\"}\u003c/code\u003e and push to all remotes.\n+                      \u003e{(selectedPatch?.baseBranch || repoClass.mainBranch) || \"-\"}\u003c/code\u003e and push to all remotes.\n                   \u003c/p\u003e\n \n                   \u003cdiv class=\"rounded-lg bg-muted/30 p-3 text-sm\"\u003e\n                     \u003cdiv class=\"mb-1 font-medium\"\u003ePatch Details:\u003c/div\u003e\n                     \u003cdiv\u003eID: \u003ccode\u003e{selectedPatch?.id.slice(0, 16)}...\u003c/code\u003e\u003c/div\u003e\n                     \u003cdiv\u003eCommits: {selectedPatch?.commits?.length || 0}\u003c/div\u003e\n-                    \u003cdiv\u003eTarget: {repoClass.mainBranch || \"main\"}\u003c/div\u003e\n+                    \u003cdiv\u003eTarget: {(selectedPatch?.baseBranch || repoClass.mainBranch) || \"-\"}\u003c/div\u003e\n                   \u003c/div\u003e\n                 \u003c/div\u003e\n \n--\nlibgit2 1.9.0\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-6au1xi83","title":"From e86339b7455e4edc121d0e7c74fa7e4fee11d742 Mon Sep 17 00:00:00 2001","description":"From e86339b7455e4edc121d0e7c74fa7e4fee11d742 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sat, 22 Nov 2025 02:13:56 +0500\nSubject: [PATCH 4/13] feat: Improve markdown rendering and update submodule\n\n---\n pnpm-lock.yaml                                                          | Bin 549117 -\u003e 548939 bytes\n src/app/components/ChannelMessage.svelte                                |   4 ++--\n src/lib/components/Markdown.svelte                                      | 336 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++----------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |   4 +++-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte |   2 +-\n 5 files changed, 272 insertions(+), 74 deletions(-)\n\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 85c9f3693292ddcb35ce3df50e4993c693cf2a73..c04570460e0c12b0745e9127f13fe320b55fd887 100644\nGIT binary patch\ndelta 80\nzc%1utQ1SEu#SMn#ljquLOuuKvAwBu6okH{H^7hZ=j6lo;#LPg\u003c0\u003erF9%(ne=IeW?\u003e\nbkm~I~)pZ=xSFB)joot{cvVEm9M~Ex{CNm^n\n\ndelta 261\nzc$_\u003cZK=JQE#SMn#(+yUz2|5{QYLsP`q\u0026k@DndliAXgHKq7Ni#I=jErQIvAPgS?B@f\nzOHzx9Q;R?\u003cOn_X7`r;A?V?8516Cii`o^5P$(-l^+iA`6q;*g\u0026F)=r^$N_qQ~az-F#\nz0%B$$W\u0026vVWAZFV\u003erJOzG5cTce4z#\u003cDV|x5jHdaQ1$%z``lOOQ%O\u003ebDi#y8nOO=S8k\nTTaK*hON}}7w@+~9*ewG9B573A\n\ndiff --git a/src/app/components/ChannelMessage.svelte b/src/app/components/ChannelMessage.svelte\nindex 9a53d3b..dfcc641 100644\n--- a/src/app/components/ChannelMessage.svelte\n+++ b/src/app/components/ChannelMessage.svelte\n@@ -8,7 +8,7 @@\n   import Reply from \"@assets/icons/reply-2.svg?dataurl\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n-  import Content from \"@lib/budabit/components/Content.svelte\"\n+  import Markdown from \"@lib/components/Markdown.svelte\"\n   import ThunkFailure from \"@app/components/ThunkFailure.svelte\"\n   import ProfileDetail from \"@app/components/ProfileDetail.svelte\"\n   import ReactionSummary from \"@app/components/ReactionSummary.svelte\"\n@@ -79,7 +79,7 @@\n         \u003c/div\u003e\n       {/if}\n       \u003cdiv class=\"text-sm\"\u003e\n-        \u003cContent minimalQuote {event} {url} /\u003e\n+        \u003cMarkdown content={event.content} {event} {url} /\u003e\n         {#if thunk}\n           \u003cThunkFailure showToastOnRetry {thunk} class=\"mt-2\" /\u003e\n         {/if}\ndiff --git a/src/lib/components/Markdown.svelte b/src/lib/components/Markdown.svelte\nindex cd9ec6d..be66649 100644\n--- a/src/lib/components/Markdown.svelte\n+++ b/src/lib/components/Markdown.svelte\n@@ -116,7 +116,7 @@\n   }\n \n   .markdown :global(img) {\n-    @apply my-4 h-auto max-w-full;\n+    @apply my-4 h-auto max-w-full rounded-lg;\n   }\n \n   /* Profile mentions - ensure proper vertical alignment */\n@@ -126,7 +126,7 @@\n \u003c/style\u003e\n \n \u003cscript lang=\"ts\"\u003e\n-  import {marked, type Token, type Tokens, type TokenizerAndRendererExtension} from \"marked\"\n+  import {Marked, type Token, type Tokens, type TokenizerAndRendererExtension} from \"marked\"\n   import DOMPurify from \"dompurify\"\n   import {nip19, nip05} from \"nostr-tools\"\n   import hljs from \"highlight.js\"\n@@ -137,13 +137,29 @@\n   import {normalizeRelayUrl} from \"@welshman/util\"\n   import Profile from \"@app/components/Profile.svelte\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n+  import ContentLinkBlock from \"@app/components/ContentLinkBlock.svelte\"\n+  import ContentQuote from \"@app/components/ContentQuote.svelte\"\n+  import type {TrustedEvent} from \"@welshman/util\"\n \n   interface Props {\n     content?: string\n     relays?: string[]\n-  }\n-\n-  let {content = \"\", relays}: Props = $props()\n+    event?: TrustedEvent\n+    url?: string\n+    minimalQuote?: boolean\n+    hideMediaAtDepth?: number\n+    depth?: number\n+  }\n+\n+  let {\n+    content = \"\",\n+    relays,\n+    event,\n+    url,\n+    minimalQuote = false,\n+    hideMediaAtDepth = 1,\n+    depth = 0,\n+  }: Props = $props()\n \n   let sanitizedContent = $state(\"\")\n   let containerElement: HTMLDivElement | undefined = $state()\n@@ -163,7 +179,6 @@\n \n   // Helper function to shorten URLs\n   function shortenUrl(url: string, text?: string): string {\n-    // If custom text is provided and it's not the same as URL, use it\n     if (text \u0026\u0026 text !== url) {\n       return text\n     }\n@@ -176,7 +191,6 @@\n       if (pathname \u0026\u0026 pathname !== \"/\") {\n         const pathParts = pathname.split(\"/\").filter(Boolean)\n         if (pathParts.length \u003e 0) {\n-          // Show first part of path, truncate if too long\n           const firstPath = pathParts[0]\n           if (firstPath.length \u003e 20) {\n             return `${domain}/${firstPath.substring(0, 15)}...`\n@@ -186,7 +200,6 @@\n       }\n       return domain\n     } catch (e) {\n-      // Fallback for invalid URLs\n       return url.length \u003e 40 ? `${url.substring(0, 20)}...${url.substring(url.length - 15)}` : url\n     }\n   }\n@@ -194,7 +207,6 @@\n   // Helper function to shorten Nostr URIs\n   function shortenNostrUri(tagType: string, content: string): string {\n     const fullUri = `${tagType}${content}`\n-    // Show first 8 and last 8 characters\n     return `${fullUri.slice(0, 8)}:${fullUri.slice(-8)}`\n   }\n \n@@ -216,7 +228,6 @@\n   // Get profile for a pubkey\n   const getPub = async (token: Token) =\u003e {\n     if (token.type === \"nostr\") {\n-      console.log(\"[markdown walkTokens getPub]\", token)\n       const fullId = token.fullId\n       if (!fullId) return\n \n@@ -224,9 +235,6 @@\n         const result: any = nip19.decode(fullId)\n         let pubkey: string | undefined\n \n-        console.log(\"[markdown walkTokens getPub result]\", result, pubkey)\n-\n-        // Narrow types properly\n         if (result.type === \"nprofile\") {\n           pubkey = result.data.pubkey\n         } else if (result.type === \"npub\") {\n@@ -244,8 +252,6 @@\n           profile = $profilesByPubkey.get(pubkey)\n         }\n \n-        console.log(\"[markdown walkTokens getPub profile]\", profile)\n-\n         if (profile) {\n           token.userName = profile.name || profile.display_name || null\n         }\n@@ -296,8 +302,6 @@\n       const match = nostrRegex.exec(src)\n       if (match) {\n         const [fullMatch, prefix, fullId] = match\n-        console.log(\"[markdown tokenizer match]\", match)\n-        // fullId is the complete npub1..., note1..., etc.\n         return {\n           type: \"nostr\",\n           raw: fullMatch,\n@@ -316,47 +320,69 @@\n \n       try {\n         const decoded = nip19.decode(fullId)\n+        const decodedType = decoded.type as string\n \n-        if (decoded.type === \"nevent\" || decoded.type === \"note\") {\n-          url = `https://coracle.social/notes/${fullId}`\n-          external = true\n-        } else if (decoded.type === \"nprofile\") {\n-          external = true\n-          url = `https://coracle.social/people/${fullId}`\n+        // For note, nevent and naddr, use ContentQuote if event is provided\n+        if (event \u0026\u0026 decodedType === \"note\") {\n+          const noteId = decoded.data as unknown as string\n+          if (noteId) {\n+            return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"note\" data-id=\"${noteId}\" data-relays=\"[]\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n+          }\n+        }\n \n-          // For npub and nprofile, create a placeholder that we'll replace with a Svelte component\n-          if (pubkey) {\n-            return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+        if (event \u0026\u0026 decodedType === \"nevent\") {\n+          const eventData = decoded.data as any\n+          const eventId = eventData?.id\n+          if (eventId) {\n+            const relaysAttr = JSON.stringify(eventData.relays || [])\n+            return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"nevent\" data-id=\"${eventId}\" data-relays=\"${relaysAttr.replace(/\"/g, \"\u0026quot;\")}\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n           }\n-        } else if (decoded.type === \"npub\") {\n-          url = `/people/${fullId}`\n+        }\n \n-          // For npub and nprofile, create a placeholder that we'll replace with a Svelte component\n-          if (pubkey) {\n-            return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+        if (event \u0026\u0026 decodedType === \"naddr\") {\n+          const addrData = decoded.data as any\n+          if (addrData?.kind \u0026\u0026 addrData?.pubkey \u0026\u0026 addrData?.identifier !== undefined) {\n+            const relaysAttr = JSON.stringify(addrData.relays || [])\n+            return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"naddr\" data-kind=\"${addrData.kind}\" data-pubkey=\"${addrData.pubkey}\" data-identifier=\"${addrData.identifier}\" data-relays=\"${relaysAttr.replace(/\"/g, \"\u0026quot;\")}\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n           }\n-        } else if (decoded.type === \"naddr\") {\n-          const data = decoded.data\n-          // For git repos, use internal routing\n-          if (data.kind === 30617) {\n-            url = `/${fullId}`\n-          } else {\n+        }\n+\n+        // Handle other Nostr entity types\n+        switch (decodedType) {\n+          case \"note\":\n+            url = `https://coracle.social/notes/${fullId}`\n+            external = true\n+            break\n+          case \"nevent\":\n+            url = `https://coracle.social/notes/${fullId}`\n+            external = true\n+            break\n+          case \"nprofile\":\n+            external = true\n+            url = `https://coracle.social/people/${fullId}`\n+            if (pubkey) {\n+              return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+            }\n+            break\n+          case \"npub\":\n+            url = `/people/${fullId}`\n+            if (pubkey) {\n+              return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+            }\n+            break\n+          case \"naddr\":\n             external = true\n             url = `https://coracle.social/${fullId}`\n-          }\n+            break\n         }\n       } catch (err) {\n         console.error(\"Failed to decode in renderer:\", err, fullId)\n-        // If decoding fails, use default URL\n         url = `/${fullId}`\n       }\n \n-      // For other types, render as simple link\n       const linkText = userName ? `@${userName}` : shortenNostrUri(\"\", fullId)\n       const externalAttributes = external ? 'target=\"_blank\" rel=\"noopener noreferrer\"' : \"\"\n-      return `\u003ca href=\"${url}\" ${externalAttributes} \n-                    class=\"link\" title=\"${fullId}\"\u003e${linkText}\n-                    \u003c/a\u003e`\n+      return `\u003ca href=\"${url}\" ${externalAttributes} class=\"link\" title=\"${fullId}\"\u003e${linkText}\u003c/a\u003e`\n     },\n   }\n \n@@ -384,7 +410,6 @@\n     },\n     renderer(token: Tokens.Generic) {\n       if (token.isNip05) {\n-        // Render as Nostr link - create placeholder for Svelte component\n         const {pubkey} = token\n         if (pubkey) {\n           return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n@@ -396,14 +421,17 @@\n     },\n   }\n \n-  marked.use({\n+  // Create a new marked instance for this component\n+  const markedInstance = new Marked({\n     extensions: [nostrTokenizer, emailTokenizer],\n     async: true,\n     breaks: true,\n     walkTokens: getPub,\n     renderer: {\n-      image() {\n-        return \"\"\n+      image(token) {\n+        const {href, title, text} = token\n+        const alt = text || title || \"\"\n+        return `\u003cimg src=\"${href}\" alt=\"${alt}\" class=\"my-4 h-auto max-w-full rounded-lg\" /\u003e`\n       },\n       link(token) {\n         const {href, text} = token\n@@ -418,7 +446,6 @@\n           try {\n             const result: any = nip19.decode(fullId)\n \n-            // For npub and nprofile, create placeholder for Profile component\n             if (result.type === \"nprofile\" || result.type === \"npub\") {\n               let pubkey = \"\"\n               if (result.type === \"nprofile\") {\n@@ -432,32 +459,69 @@\n               }\n             }\n \n-            // For other nostr types, create regular links\n-            let url = `/${fullId}`\n+            // For note, nevent and naddr, use ContentQuote if event is provided\n+            if (\n+              event \u0026\u0026\n+              (result.type === \"note\" || result.type === \"nevent\" || result.type === \"naddr\")\n+            ) {\n+              if (result.type === \"note\") {\n+                const noteId = result.data as string\n+                if (noteId) {\n+                  return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"note\" data-id=\"${noteId}\" data-relays=\"[]\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n+                }\n+              } else if (result.type === \"nevent\") {\n+                const eventData = result.data as any\n+                const eventId = eventData?.id\n+                if (eventId) {\n+                  const relaysAttr = JSON.stringify(eventData.relays || [])\n+                  return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"nevent\" data-id=\"${eventId}\" data-relays=\"${relaysAttr.replace(/\"/g, \"\u0026quot;\")}\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n+                }\n+              } else if (result.type === \"naddr\") {\n+                const addrData = result.data as any\n+                if (addrData?.kind \u0026\u0026 addrData?.pubkey \u0026\u0026 addrData?.identifier !== undefined) {\n+                  const relaysAttr = JSON.stringify(addrData.relays || [])\n+                  return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"naddr\" data-kind=\"${addrData.kind}\" data-pubkey=\"${addrData.pubkey}\" data-identifier=\"${addrData.identifier}\" data-relays=\"${relaysAttr.replace(/\"/g, \"\u0026quot;\")}\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n+                }\n+              }\n+            }\n+\n+            // Fallback to regular link if no event or not nevent/naddr\n+            let linkUrl = `/${fullId}`\n             let external = false\n \n             if (result.type === \"nevent\" || result.type === \"note\") {\n-              url = `https://coracle.social/notes/${fullId}`\n+              linkUrl = `https://coracle.social/notes/${fullId}`\n               external = true\n             } else if (result.type === \"naddr\") {\n-              const data = result.data\n+              const data = result.data as any\n               if (data.kind === 30617) {\n-                url = `/${fullId}`\n+                linkUrl = `/${fullId}`\n               } else {\n                 external = true\n-                url = `https://coracle.social/${fullId}`\n+                linkUrl = `https://coracle.social/${fullId}`\n               }\n             }\n \n             const externalAttributes = external ? 'target=\"_blank\" rel=\"noopener noreferrer\"' : \"\"\n             const linkText = text || fullId\n-            return `\u003ca href=\"${url}\" ${externalAttributes} class=\"link\" title=\"${fullId}\"\u003e${linkText}\u003c/a\u003e`\n+            return `\u003ca href=\"${linkUrl}\" ${externalAttributes} class=\"link\" title=\"${fullId}\"\u003e${linkText}\u003c/a\u003e`\n           } catch (err) {\n             console.error(\"Failed to decode nostr link:\", err, fullId)\n           }\n         }\n \n         // Regular URL handling\n+        // Check if this should be rendered as a block (media or standalone URL)\n+        const isMediaUrl = /\\.(jpe?g|png|gif|webp|svg|bmp|ico|mov|webm|mp4)(\\?.*)?$/i.test(href)\n+        // Standalone URL: when link text is the same as URL, or very similar (user just pasted URL)\n+        const isStandaloneUrl = !text || text === href || text.trim() === href.trim()\n+\n+        // Use ContentLinkBlock for media URLs or standalone URLs (when event is provided)\n+        if (event \u0026\u0026 (isMediaUrl || isStandaloneUrl)) {\n+          return `\u003cspan class=\"markdown-link-block-placeholder\" data-url=\"${href}\" data-event-id=\"${event.id}\"\u003e\u003c/span\u003e`\n+        }\n+\n+        // For inline links, render as regular link\n         const displayText = shortenUrl(href, text)\n         return `\u003ca href=\"${href}\" class=\"link\" title=\"${href}\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e${displayText}\u003c/a\u003e`\n       },\n@@ -481,9 +545,7 @@\n           language: validLang,\n         }).value\n \n-        return `\n-                    \u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-${validLang}\"\u003e${highlightedCode}\u003c/code\u003e\u003c/pre\u003e\n-                `\n+        return `\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-${validLang}\"\u003e${highlightedCode}\u003c/code\u003e\u003c/pre\u003e`\n       },\n     },\n   })\n@@ -491,9 +553,23 @@\n   $effect(() =\u003e {\n     if (content) {\n       ;(async () =\u003e {\n-        const parsed = await marked(content)\n+        const parsed = await markedInstance.parse(content)\n         sanitizedContent = DOMPurify.sanitize(parsed, {\n-          ADD_ATTR: [\"target\", \"title\", \"data-pubkey\", \"data-url\"],\n+          ADD_ATTR: [\n+            \"target\",\n+            \"title\",\n+            \"data-pubkey\",\n+            \"data-url\",\n+            \"data-event-id\",\n+            \"data-type\",\n+            \"data-id\",\n+            \"data-relays\",\n+            \"data-kind\",\n+            \"data-identifier\",\n+            \"data-minimal\",\n+            \"data-depth\",\n+            \"data-hide-media\",\n+          ],\n           ADD_TAGS: [\"span\"],\n         })\n       })()\n@@ -519,45 +595,41 @@\n       setTimeout(() =\u003e {\n         if (!containerElement) return\n \n-        const placeholders = containerElement.querySelectorAll(\".nostr-profile-placeholder\")\n-        placeholders.forEach(placeholder =\u003e {\n+        // Mount profile placeholders\n+        const profilePlaceholders = containerElement.querySelectorAll(\".nostr-profile-placeholder\")\n+        profilePlaceholders.forEach(placeholder =\u003e {\n           const pubkey = placeholder.getAttribute(\"data-pubkey\")\n-          const url = placeholder.getAttribute(\"data-url\")\n+          const profileUrl = placeholder.getAttribute(\"data-url\")\n \n           if (pubkey) {\n             try {\n-              // Create a wrapper div to hold both components\n               const wrapper = document.createElement(\"div\")\n               wrapper.className = \"inline-flex items-center gap-1 align-middle\"\n               wrapper.style.verticalAlign = \"middle\"\n \n-              // Create containers for each component\n               const avatarContainer = document.createElement(\"span\")\n               const linkContainer = document.createElement(\"span\")\n \n               wrapper.appendChild(avatarContainer)\n               wrapper.appendChild(linkContainer)\n \n-              // Replace placeholder with wrapper\n               placeholder.replaceWith(wrapper)\n \n-              // Mount Profile component (avatar only, hideDetails=true)\n               const profileComponent = mount(Profile, {\n                 target: avatarContainer,\n                 props: {\n                   pubkey,\n-                  url: url || undefined,\n+                  url: profileUrl || undefined,\n                   avatarSize: 6,\n                   hideDetails: true,\n                 },\n               })\n \n-              // Mount ProfileLink component (name only)\n               const linkComponent = mount(ProfileLink, {\n                 target: linkContainer,\n                 props: {\n                   pubkey,\n-                  url: url || undefined,\n+                  url: profileUrl || undefined,\n                 },\n               })\n \n@@ -570,6 +642,130 @@\n             }\n           }\n         })\n+\n+        // Mount ContentLinkBlock for media/standalone links\n+        if (event) {\n+          const linkBlockPlaceholders = containerElement.querySelectorAll(\n+            \".markdown-link-block-placeholder\",\n+          )\n+          linkBlockPlaceholders.forEach(placeholder =\u003e {\n+            const linkUrl = placeholder.getAttribute(\"data-url\")\n+            const eventId = placeholder.getAttribute(\"data-event-id\")\n+\n+            if (linkUrl \u0026\u0026 eventId \u0026\u0026 event.id === eventId) {\n+              try {\n+                const container = document.createElement(\"div\")\n+                placeholder.replaceWith(container)\n+\n+                const linkBlockComponent = mount(ContentLinkBlock, {\n+                  target: container,\n+                  props: {\n+                    value: {url: new URL(linkUrl)},\n+                    event,\n+                  },\n+                })\n+                mountedComponents.push({target: container, component: linkBlockComponent})\n+              } catch (e) {\n+                console.error(\"Failed to mount ContentLinkBlock:\", e)\n+                // Fallback to regular link\n+                const link = document.createElement(\"a\")\n+                link.href = linkUrl\n+                link.textContent = linkUrl\n+                link.className = \"link\"\n+                link.target = \"_blank\"\n+                link.rel = \"noopener noreferrer\"\n+                placeholder.replaceWith(link)\n+              }\n+            }\n+          })\n+\n+          // Mount ContentQuote for note, nevent and naddr\n+          const quotePlaceholders = containerElement.querySelectorAll(\".markdown-quote-placeholder\")\n+          quotePlaceholders.forEach(placeholder =\u003e {\n+            const quoteType = placeholder.getAttribute(\"data-type\")\n+            const eventId = placeholder.getAttribute(\"data-event-id\")\n+            const quoteUrl = placeholder.getAttribute(\"data-url\") || url\n+            const minimal = placeholder.getAttribute(\"data-minimal\") === \"true\"\n+            const quoteDepth = parseInt(placeholder.getAttribute(\"data-depth\") || \"0\")\n+            const hideMedia = parseInt(placeholder.getAttribute(\"data-hide-media\") || \"1\")\n+\n+            if (eventId \u0026\u0026 event.id === eventId) {\n+              try {\n+                let quoteValue: any = null\n+\n+                if (quoteType === \"note\" || quoteType === \"nevent\") {\n+                  const id = placeholder.getAttribute(\"data-id\")\n+                  if (!id) {\n+                    console.error(`Missing id for ${quoteType} quote`)\n+                    return\n+                  }\n+                  const relaysAttr = placeholder.getAttribute(\"data-relays\") || \"[]\"\n+                  let relays: string[] = []\n+                  try {\n+                    relays = JSON.parse(relaysAttr.replace(/\u0026quot;/g, '\"'))\n+                  } catch (e) {\n+                    console.error(`Failed to parse relays for ${quoteType}:`, e)\n+                    relays = []\n+                  }\n+                  quoteValue = {id, relays}\n+                } else if (quoteType === \"naddr\") {\n+                  const kindAttr = placeholder.getAttribute(\"data-kind\")\n+                  const pubkeyAttr = placeholder.getAttribute(\"data-pubkey\")\n+                  const identifierAttr = placeholder.getAttribute(\"data-identifier\")\n+\n+                  if (!kindAttr || !pubkeyAttr || identifierAttr === null) {\n+                    console.error(\"Missing required fields for naddr quote\", {\n+                      kindAttr,\n+                      pubkeyAttr,\n+                      identifierAttr,\n+                    })\n+                    return\n+                  }\n+\n+                  const kind = parseInt(kindAttr)\n+                  if (isNaN(kind)) {\n+                    console.error(\"Invalid kind for naddr quote:\", kindAttr)\n+                    return\n+                  }\n+\n+                  const relaysAttr = placeholder.getAttribute(\"data-relays\") || \"[]\"\n+                  let relays: string[] = []\n+                  try {\n+                    relays = JSON.parse(relaysAttr.replace(/\u0026quot;/g, '\"'))\n+                  } catch (e) {\n+                    console.error(\"Failed to parse relays for naddr:\", e)\n+                    relays = []\n+                  }\n+                  quoteValue = {kind, pubkey: pubkeyAttr, identifier: identifierAttr, relays}\n+                }\n+\n+                if (quoteValue) {\n+                  const container = document.createElement(\"div\")\n+                  placeholder.replaceWith(container)\n+\n+                  const quoteComponent = mount(ContentQuote, {\n+                    target: container,\n+                    props: {\n+                      value: quoteValue,\n+                      event,\n+                      url: quoteUrl || undefined,\n+                      minimal,\n+                      depth: quoteDepth,\n+                      hideMediaAtDepth: hideMedia,\n+                    },\n+                  })\n+                  mountedComponents.push({target: container, component: quoteComponent})\n+                }\n+              } catch (e) {\n+                console.error(\"Failed to mount ContentQuote:\", e, {\n+                  quoteType,\n+                  eventId,\n+                  placeholder: placeholder.outerHTML,\n+                })\n+              }\n+            }\n+          })\n+        }\n       }, 0)\n     }\n \ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 1de98e3..7b1f356 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -13,6 +13,7 @@\n   import {pushToast} from \"@src/app/util/toast\"\n   import EventActions from \"@src/app/components/EventActions.svelte\"\n   import ReactionSummary from \"@src/app/components/ReactionSummary.svelte\"\n+  import Markdown from \"@src/lib/components/Markdown.svelte\"\n   import {pushModal} from \"@app/util/modal\"\n   import {EditRepoPanel, ForkRepoDialog} from \"@nostr-git/ui\"\n   import {postRepoAnnouncement} from \"@lib/budabit/commands.js\"\n@@ -618,7 +619,8 @@\n         ProfileLink: ProfileLink as typeof import(\"@nostr-git/ui\").ProfileLink,\n         EventActions: EventActions as typeof import(\"@nostr-git/ui\").EventActions,\n         ReactionSummary: ReactionSummary as typeof import(\"@nostr-git/ui\").ReactionSummary,\n-      }}\u003e\n+        Markdown: Markdown as any,\n+      } as any}\u003e\n       {@render children()}\n     \u003c/ConfigProvider\u003e\n   {/if}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 43bf1e9..2513509 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -1274,7 +1274,7 @@\n           showNavigation={true}\n           showFileStats={true}\n           showPatchInfo={true}\n-          comments={$threadComments as CommentEvent[]}\n+          comments={diffComments}\n           rootEvent={selectedPatch?.raw}\n           onComment={handleCommentSubmit}\n           currentPubkey={$pubkey}\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-6biavqv9","title":"Switching branch results in Error","description":"isomorphic-git.js?v=80791dee:7314\nUncaught (in promise) NotFoundError: Could not find \u003cBranch name\u003e.\n    at async listRepoFilesFromEvent (files.ts:76:11)\n    at async Repo.listRepoFiles (Repo.svelte.js:308:20)\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue"]}
{"id":"flotilla-6eclxpfw","title":"From 8d2646dd7bdcbd1745ef6f500915891a76a86b54 Mon Sep 17 00:00:00 2001","description":"From 8d2646dd7bdcbd1745ef6f500915891a76a86b54 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Wed, 12 Nov 2025 14:23:29 +0500\nSubject: [PATCH 1/1] feat(ui): Expose repo address on repo page and sync submodule UI tweaks\n\n---\n packages/nostr-git                                    |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte | 12 ++++++++++++\n 2 files changed, 13 insertions(+), 1 deletion(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 9d7ef6b..354f97e 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 9d7ef6b2647634dca8a1f095d673da82c1284908\n+Subproject commit 354f97ef399bbab7a0d40603e6288b1a1ee9aec7\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 0d7472b..424e4ed 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -414,6 +414,18 @@\n               \u003c/div\u003e\n             {/if}\n \n+            \u003cdiv class=\"border-t pt-3\"\u003e\n+              \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eRepo Address\u003c/span\u003e\n+              \u003cbutton\n+                type=\"button\"\n+                class=\"flex w-full items-start gap-2 text-left text-sm hover:opacity-80\"\n+                title=\"Click to copy\"\n+                onclick={() =\u003e clip(naddr)}\u003e\n+                \u003cLink class=\"mt-0.5 h-3 w-3 flex-shrink-0\" /\u003e\n+                \u003cspan class=\"break-all font-mono text-xs\"\u003e{naddr}\u003c/span\u003e\n+              \u003c/button\u003e\n+            \u003c/div\u003e\n+\n             {#if repoMetadata.relays.length \u003e 0}\n               \u003cdiv class=\"border-t pt-3\"\u003e\n                 \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eRelays\u003c/span\u003e\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-6ifd598t","title":"From b66ee36dacdd1c95b063a005bb8c7dff29fac41b Mon Sep 17 00:00:00 2001","description":"From b66ee36dacdd1c95b063a005bb8c7dff29fac41b Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Thu, 20 Nov 2025 12:10:34 +0500\nSubject: [PATCH] feat(markdown): created a markdown component and used it in issue page\n\n---\n package.json                                                           |   4 ++++\n pnpm-lock.yaml                                                         | Bin 540267 -\u003e 547717 bytes\n src/lib/components/Markdown.svelte                                     | 591 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte | 173 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------------------------------\n 4 files changed, 683 insertions(+), 85 deletions(-)\n create mode 100644 src/lib/components/Markdown.svelte\n\ndiff --git a/package.json b/package.json\nindex 5b21328..ef9c385 100644\n--- a/package.json\n+++ b/package.json\n@@ -24,6 +24,7 @@\n     \"@sveltejs/vite-plugin-svelte\": \"^4.0.4\",\n     \"@types/eslint\": \"^9.6.1\",\n     \"@types/markdown-it\": \"^14.1.2\",\n+    \"@types/marked\": \"^6.0.0\",\n     \"@types/mustache\": \"^4.2.6\",\n     \"@types/throttle-debounce\": \"^5.0.2\",\n     \"@vitest/coverage-v8\": \"^3.2.4\",\n@@ -102,13 +103,16 @@\n     \"daisyui\": \"^4.12.24\",\n     \"date-fns\": \"^4.1.0\",\n     \"date-picker-svelte\": \"^2.16.0\",\n+    \"dompurify\": \"^3.3.0\",\n     \"dotenv\": \"^16.6.1\",\n     \"emoji-picker-element\": \"^1.27.0\",\n     \"fuse.js\": \"^7.1.0\",\n+    \"highlight.js\": \"^11.11.1\",\n     \"husky\": \"^9.1.7\",\n     \"idb\": \"^8.0.3\",\n     \"isomorphic-git\": \"https://github.com/chebizarro/isomorphic-git/releases/download/v2.0.0-alpha/isomorphic-git-2.0.0-alpha.tgz\",\n     \"markdown-it\": \"^14.1.0\",\n+    \"marked\": \"^17.0.0\",\n     \"mustache\": \"^4.2.0\",\n     \"nostr-signer-capacitor-plugin\": \"^0.0.4\",\n     \"nostr-tools\": \"^2.17.0\",\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 68426070bad276440d15c4b886045ff55bc982e1..676941e81284c01962ed3db118e68e6a8930d32c 100644\nGIT binary patch\ndelta 7411\nzc%1E7ON=8\u00268P\u003ecfn@ytCCc86nHtHdaA@R1|FF$\u0026aVaE3O{T|z6kCa1qb=zHbzuZ-A\nz\u0026lsUm6dn\u003e\u003eLM)}l4G9*31c+sjd\u003c7\u0026FAt98_0U;3}xq\u003e)HNF3\u003c)3\u003c^t7j?4jDUES^a\nz|LXec@BjPjuj;@4gZRp9=O^FT+R#kfg59\u0026}qt9\u003cGvC~K0ttD#uYQjJL{?\u003c=#z@DPI\nz1qb`n4}5pmXgWyK(}VlZ-k#qD=^MoSr`Tw4HoX\u003cxz8G(\u003eES+1jDho\u0026^1%zabf\u003c1^8\nzTeOjE0Yk^Kj)TC^LYK9qX\u0026I6YFf?@Xv1TEfVk3N*p\u00262UFWhpKOD3%OUKqfhs\u003c4K{*\nzx{5$#1(9Mvl#{-I%(\u0026%8qc}s==@?1VB*puY6\u0026L-;wBicJCh{ZMl`\u003e\u0026ZNb?Pb+GP)@\nzsC(kL6TgLk6c;cSfTFn\u0026ciBXs3sqScG\u003clazP2Whqc\u003c$-oxL}$p1cHZnmq{A{%a}yi\nzk_F9=1_qSkd;~BOM^j`t\u003eUPAj0!\u003c3CB$0wh^ITLAqAp}t6}ze|9}^;xFh}xyR3y2m\nz%#$L`h$J7T!(xn\u0026h@2#Qs\u0026m-qSGZ~3!yR!?;qZwo{e(fG0rCtm@T~HYQD84#-DMI?\nz\u0026BdR#Iw\u003e)!QjKG^6NwyFn6zkC#A\u003e39^B|uDC*yRrICh_z^7qfjI4+;%DY\u003c\u003cBD==SZ\nz(KT31\u003c`ppmy#Kl8BuAHFo)5Z8CSXfmr7pDVhIE{\u003eI}DF=a11-`)*#n6AkbRq\u003cTyP!\nzIieN7mQ^WRvQHS560$8QwaY5d$|F\u0026)tD;`}SKD(aFs-oH*t?dFaww;@IFQUmN)5o2\nzCQY`|=rEP!7\u003eZh6bM;Qklg^~v0O8W4!?{Su9T\u0026`Fox24vEed4wqmyi_FJ;t`2*Xg!\nz@UZ9t09w\u003cQ7}Y+\u003e@GLmf!uCnK2D`OjQ6Vec5oILOjiYMG$etNt+7i{HT*h?=esHSQ\nzteOH1g%uC|mW)h8cfI\u003c`_elx56$pC%^SHn5GSq)~9R2au_{@|)!3C%9JzriEtbr^|\nzml}6hqCsjp\u003e_6vSF9=_B{YrGJ?VJAc=Iymeka7i?9sS0FvJ1*CD0?lGz4-NBbortj\nz+`hRW;evz\u003c5?\u0026VxU*BBtZ^6F\u003e|E?!*eaH9ecb-h`I^X{K`nL1AH`ZgzFMrnA`PTZ2\nz(}(FhPGM`)=j`9zT%G=T|Ah-3zSVQu#nqeV4Fw{?RP7$r2}MAJtxK}iGjy47okfRT\nzw=*3RKoRtwjDkdU\u0026QrqeP$IB$d85gMpi6{p_AEh?32e+Is(@vL2~oxZF_JChA||?q\nzMR\u003e!3x-CltvQ2Z\u003cuyAlX{9W$#?4w!s(bD_78}kHvKjJ(jmtJZ1wZ18EiE$HY$|\u003elg\nzUK8R_^nfpjR+5X=s9~%y(mOO2HF}_*={3?RHCJToCREDiDO0j(rNn7cy4E*ZfU89E\nzMy8NOPNlf|+~vsKLm\u0026{gMZz;LA|$yB_4ykL651RI;fARZlw29ah%m\u003cbT=U-)(R~6L\nz#F=3el0oPOCUjZ$jN?6BM_5o*Sqk28m-(OBpZ5{cB-\u003eK=XXJ-Vvv\u003c}ncMhBnezhEE\nzTY+w*)Tz_GOqrJRBdXD=iON9~c0\u003ci*H5LU@Rb{i~umuN0A#s#AEyAQ268TDikuwxH\nzolrgHtQpXnbZsD_%J{He\u003eZr%HczpKW+sm(+Pkpo#f%a+V{lBf;Z;ZzV$BmUjqLu6z\nzDooVILUn|t5Q97ELA{3CspCGa3t%9$n0\u0026Q;$`+|Wek8?0!(^T@1EnGra#@{chJlh5\nzXtpFXUkFcc{qdf\u0026|I+f4\u0026d=f-ccyO+KRtUZwz3{u%nggVVKFyc\u0026)o3M;q7xQSfU$@\nz_K3OH?}bADTRwu15pu!D1t0%E`8fOXaHYy^%o80t\u003eeSv`ex)%;bq\u003cdY4`C-i4i%Dt\nzR7;~L6V)u$j!HQ@(y6O\u003e0FtAzA}7sQ_PE+k4*2}IqGj`igqrD2fH?s\u003c964oCNpGOK\nz77Eiw%As4!_m\u0026vv7f\u0026y5eeK-`D{fhxz58J8@HbCfWm!SWdHCJ6drx2HI(q~i^)@se\nz--k=vvzM\u0026(-+%R~%LHYg4YEOM\u0026#4icFFW7kHt#rpdVBfq?B?Ise~`NUSYmPcRb%$U\nz_{P0w7gPQs#4JM0wS*XF=MU??S-QUA+j{0I\u0026Unn;Bfj`0=eG}5o}bzMjUWH$zb_VN\nc?qU\u0026dde!mi6Q6p\u003c`MGbiKYMLw^Di\u0026_6W2$IZ2$lO\n\ndelta 280\nzc${n9uK4\u003co!iH{%$)3KllV3?}+Wb^ffpK!DROaN(a_*b0\u003c#pLMZ%~cn0*P$i\u003e}tTY\nz`HiV050qEK0ao}zK5TM9h2-=J8`#*V+X}J@O_tT=-dqrLSY`72FpbT-$}gr*f3\u003c~C\nzVtT+%R^iDB\u0026n26aA8b#4!1zFQdjvbvo(tQT-e9UM*nY*6+1\u003e(ZVAABkTH)zuTbTtx\nzob9ch%mF6tllCzKG0XNz`\u0026gaNOb2S?nSQL3jeq)Eb|\u00268KcHL}y+NJ|d5!@at#J\u003cvH\nzI?yQ5?dIX^|Aj$DOfPg{m7d\u003cPhMi^mpFDPPiRnPYM7G\u003csv#(nVa^U1$\u003c\u003ci@GOgSPs\nQrtetH=CWPZjw3@B0P-VpE\u0026u=k\n\ndiff --git a/src/lib/components/Markdown.svelte b/src/lib/components/Markdown.svelte\nnew file mode 100644\nindex 0000000..cd9ec6d\n--- /dev/null\n+++ b/src/lib/components/Markdown.svelte\n@@ -0,0 +1,591 @@\n+\u003cstyle\u003e\n+  .markdown {\n+    @apply text-base leading-relaxed;\n+  }\n+\n+  .markdown :global(h1) {\n+    @apply mb-4 mt-6 text-3xl font-bold;\n+  }\n+\n+  .markdown :global(h2) {\n+    @apply mb-3 mt-5 text-2xl font-bold;\n+  }\n+\n+  .markdown :global(h3) {\n+    @apply mb-2 mt-4 text-xl font-semibold;\n+  }\n+\n+  .markdown :global(h4) {\n+    @apply mb-2 mt-3 text-lg font-semibold;\n+  }\n+\n+  .markdown :global(h5) {\n+    @apply mb-1 mt-2 text-base font-semibold;\n+  }\n+\n+  .markdown :global(h6) {\n+    @apply mb-1 mt-2 text-sm font-semibold;\n+  }\n+\n+  .markdown :global(p) {\n+    @apply my-3;\n+  }\n+\n+  .markdown :global(a) {\n+    @apply text-primary hover:underline;\n+  }\n+\n+  .markdown :global(strong) {\n+    @apply font-bold;\n+  }\n+\n+  .markdown :global(em) {\n+    @apply italic;\n+  }\n+\n+  .markdown :global(code) {\n+    @apply rounded bg-base-200 px-1.5 py-0.5 font-mono text-sm;\n+    color: hsl(var(--bc) / 0.9);\n+  }\n+\n+  .markdown :global(pre) {\n+    @apply my-4 overflow-x-auto rounded-lg border border-base-300 bg-base-300/50 p-4;\n+    box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);\n+  }\n+\n+  .markdown :global(pre code) {\n+    @apply bg-transparent p-0 text-sm;\n+    font-family: \"Menlo\", \"Monaco\", \"Courier New\", monospace;\n+    line-height: 1.5;\n+  }\n+\n+  .markdown :global(blockquote) {\n+    @apply my-4 border-l-4 border-primary pl-4 italic;\n+  }\n+\n+  .markdown :global(ul) {\n+    @apply my-3 list-disc pl-6;\n+  }\n+\n+  .markdown :global(ol) {\n+    @apply my-3 list-decimal pl-6;\n+  }\n+\n+  .markdown :global(li) {\n+    @apply my-1;\n+  }\n+\n+  .markdown :global(hr) {\n+    @apply my-6 border-t border-base-300;\n+  }\n+\n+  /* Table wrapper for horizontal scroll on mobile */\n+  .markdown :global(table) {\n+    @apply my-4 w-full border-collapse;\n+    display: block;\n+    overflow-x: auto;\n+    -webkit-overflow-scrolling: touch;\n+  }\n+\n+  @media (min-width: 768px) {\n+    .markdown :global(table) {\n+      display: table;\n+    }\n+  }\n+\n+  .markdown :global(th) {\n+    @apply border border-base-300 bg-base-200 p-2 font-semibold;\n+    white-space: nowrap;\n+  }\n+\n+  @media (min-width: 768px) {\n+    .markdown :global(th) {\n+      white-space: normal;\n+    }\n+  }\n+\n+  .markdown :global(td) {\n+    @apply border border-base-300 p-2;\n+    white-space: nowrap;\n+  }\n+\n+  @media (min-width: 768px) {\n+    .markdown :global(td) {\n+      white-space: normal;\n+    }\n+  }\n+\n+  .markdown :global(img) {\n+    @apply my-4 h-auto max-w-full;\n+  }\n+\n+  /* Profile mentions - ensure proper vertical alignment */\n+  .markdown :global(.inline-flex) {\n+    vertical-align: middle;\n+  }\n+\u003c/style\u003e\n+\n+\u003cscript lang=\"ts\"\u003e\n+  import {marked, type Token, type Tokens, type TokenizerAndRendererExtension} from \"marked\"\n+  import DOMPurify from \"dompurify\"\n+  import {nip19, nip05} from \"nostr-tools\"\n+  import hljs from \"highlight.js\"\n+  import \"highlight.js/styles/github-dark.css\"\n+  import {profilesByPubkey, loadProfile} from \"@welshman/app\"\n+  import {getContext, mount} from \"svelte\"\n+  import {REPO_RELAYS_KEY} from \"@lib/budabit\"\n+  import {normalizeRelayUrl} from \"@welshman/util\"\n+  import Profile from \"@app/components/Profile.svelte\"\n+  import ProfileLink from \"@app/components/ProfileLink.svelte\"\n+\n+  interface Props {\n+    content?: string\n+    relays?: string[]\n+  }\n+\n+  let {content = \"\", relays}: Props = $props()\n+\n+  let sanitizedContent = $state(\"\")\n+  let containerElement: HTMLDivElement | undefined = $state()\n+  let mountedComponents: Array\u003c{target: Element; component: any}\u003e = []\n+\n+  // Get relays from context if not provided\n+  const contextRelays = getContext\u003cstring[]\u003e(REPO_RELAYS_KEY)\n+  const defaultRelays = $derived.by(() =\u003e {\n+    if (relays \u0026\u0026 relays.length \u003e 0) {\n+      return relays.map((u: string) =\u003e normalizeRelayUrl(u)).filter(Boolean) as string[]\n+    }\n+    if (contextRelays \u0026\u0026 contextRelays.length \u003e 0) {\n+      return contextRelays.map((u: string) =\u003e normalizeRelayUrl(u)).filter(Boolean) as string[]\n+    }\n+    return []\n+  })\n+\n+  // Helper function to shorten URLs\n+  function shortenUrl(url: string, text?: string): string {\n+    // If custom text is provided and it's not the same as URL, use it\n+    if (text \u0026\u0026 text !== url) {\n+      return text\n+    }\n+\n+    try {\n+      const urlObj = new URL(url)\n+      const domain = urlObj.hostname.replace(\"www.\", \"\")\n+      const pathname = urlObj.pathname\n+\n+      if (pathname \u0026\u0026 pathname !== \"/\") {\n+        const pathParts = pathname.split(\"/\").filter(Boolean)\n+        if (pathParts.length \u003e 0) {\n+          // Show first part of path, truncate if too long\n+          const firstPath = pathParts[0]\n+          if (firstPath.length \u003e 20) {\n+            return `${domain}/${firstPath.substring(0, 15)}...`\n+          }\n+          return `${domain}/${firstPath}${pathParts.length \u003e 1 ? \"/...\" : \"\"}`\n+        }\n+      }\n+      return domain\n+    } catch (e) {\n+      // Fallback for invalid URLs\n+      return url.length \u003e 40 ? `${url.substring(0, 20)}...${url.substring(url.length - 15)}` : url\n+    }\n+  }\n+\n+  // Helper function to shorten Nostr URIs\n+  function shortenNostrUri(tagType: string, content: string): string {\n+    const fullUri = `${tagType}${content}`\n+    // Show first 8 and last 8 characters\n+    return `${fullUri.slice(0, 8)}:${fullUri.slice(-8)}`\n+  }\n+\n+  // Resolve NIP-05 identifier to pubkey using nostr-tools\n+  async function resolveNip05(identifier: string): Promise\u003cstring | null\u003e {\n+    if (!identifier.includes(\"@\")) {\n+      return null\n+    }\n+\n+    try {\n+      const profile = await nip05.queryProfile(identifier)\n+      return profile?.pubkey || null\n+    } catch (e) {\n+      console.error(`Failed to resolve NIP-05 ${identifier}:`, e)\n+      return null\n+    }\n+  }\n+\n+  // Get profile for a pubkey\n+  const getPub = async (token: Token) =\u003e {\n+    if (token.type === \"nostr\") {\n+      console.log(\"[markdown walkTokens getPub]\", token)\n+      const fullId = token.fullId\n+      if (!fullId) return\n+\n+      try {\n+        const result: any = nip19.decode(fullId)\n+        let pubkey: string | undefined\n+\n+        console.log(\"[markdown walkTokens getPub result]\", result, pubkey)\n+\n+        // Narrow types properly\n+        if (result.type === \"nprofile\") {\n+          pubkey = result.data.pubkey\n+        } else if (result.type === \"npub\") {\n+          pubkey = result.data\n+        }\n+\n+        if (!pubkey) return\n+\n+        token.pubkey = pubkey\n+\n+        // Get or load profile\n+        let profile = $profilesByPubkey.get(pubkey)\n+        if (!profile \u0026\u0026 defaultRelays.length \u003e 0) {\n+          await loadProfile(pubkey, defaultRelays)\n+          profile = $profilesByPubkey.get(pubkey)\n+        }\n+\n+        console.log(\"[markdown walkTokens getPub profile]\", profile)\n+\n+        if (profile) {\n+          token.userName = profile.name || profile.display_name || null\n+        }\n+      } catch (e) {\n+        console.error(\"Failed to decode nostr token:\", e, fullId)\n+      }\n+    } else if (token.type === \"email\") {\n+      try {\n+        const pubkey = await resolveNip05(token.text)\n+        if (pubkey) {\n+          token.isNip05 = true\n+          token.tagType = \"npub\"\n+          token.content = pubkey\n+          token.pubkey = pubkey\n+\n+          // Get or load profile\n+          let profile = $profilesByPubkey.get(pubkey)\n+          if (!profile \u0026\u0026 defaultRelays.length \u003e 0) {\n+            await loadProfile(pubkey, defaultRelays)\n+            profile = $profilesByPubkey.get(pubkey)\n+          }\n+\n+          if (profile) {\n+            token.userName = profile.name || profile.display_name || token.text\n+          } else {\n+            token.userName = token.text\n+          }\n+        } else {\n+          token.isNip05 = false\n+        }\n+      } catch (e) {\n+        console.error(`Failed to fetch NIP-05 user for ${token.text}:`, e)\n+        token.isNip05 = false\n+      }\n+    }\n+  }\n+\n+  // Bech32 characters are alphanumeric excluding '1', 'b', 'i', 'o'\n+  const nostrRegex = /^(nostr:)?(n(?:event|ote|pub|profile|addr)1[ac-hj-np-z02-9]{6,})/\n+  const nostrTokenizer: TokenizerAndRendererExtension = {\n+    name: \"nostr\",\n+    level: \"inline\",\n+    start(src: string) {\n+      const match = src.match(/(nostr:)?n(?:event|ote|pub|profile|addr)1/)\n+      return match ? match.index! : -1\n+    },\n+    tokenizer(src: string) {\n+      const match = nostrRegex.exec(src)\n+      if (match) {\n+        const [fullMatch, prefix, fullId] = match\n+        console.log(\"[markdown tokenizer match]\", match)\n+        // fullId is the complete npub1..., note1..., etc.\n+        return {\n+          type: \"nostr\",\n+          raw: fullMatch,\n+          text: fullMatch,\n+          fullId: fullId,\n+          prefix: prefix || \"\",\n+          userName: null,\n+          tokens: [],\n+        }\n+      }\n+    },\n+    renderer(token: Tokens.Generic) {\n+      const {fullId, userName, pubkey} = token\n+      let url = `/${fullId}`\n+      let external = false\n+\n+      try {\n+        const decoded = nip19.decode(fullId)\n+\n+        if (decoded.type === \"nevent\" || decoded.type === \"note\") {\n+          url = `https://coracle.social/notes/${fullId}`\n+          external = true\n+        } else if (decoded.type === \"nprofile\") {\n+          external = true\n+          url = `https://coracle.social/people/${fullId}`\n+\n+          // For npub and nprofile, create a placeholder that we'll replace with a Svelte component\n+          if (pubkey) {\n+            return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+          }\n+        } else if (decoded.type === \"npub\") {\n+          url = `/people/${fullId}`\n+\n+          // For npub and nprofile, create a placeholder that we'll replace with a Svelte component\n+          if (pubkey) {\n+            return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+          }\n+        } else if (decoded.type === \"naddr\") {\n+          const data = decoded.data\n+          // For git repos, use internal routing\n+          if (data.kind === 30617) {\n+            url = `/${fullId}`\n+          } else {\n+            external = true\n+            url = `https://coracle.social/${fullId}`\n+          }\n+        }\n+      } catch (err) {\n+        console.error(\"Failed to decode in renderer:\", err, fullId)\n+        // If decoding fails, use default URL\n+        url = `/${fullId}`\n+      }\n+\n+      // For other types, render as simple link\n+      const linkText = userName ? `@${userName}` : shortenNostrUri(\"\", fullId)\n+      const externalAttributes = external ? 'target=\"_blank\" rel=\"noopener noreferrer\"' : \"\"\n+      return `\u003ca href=\"${url}\" ${externalAttributes} \n+                    class=\"link\" title=\"${fullId}\"\u003e${linkText}\n+                    \u003c/a\u003e`\n+    },\n+  }\n+\n+  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+/\n+  const emailTokenizer: TokenizerAndRendererExtension = {\n+    name: \"email\",\n+    level: \"inline\",\n+    start(src: string) {\n+      const match = src.match(emailRegex)\n+      return match ? match.index! : -1\n+    },\n+    tokenizer(src: string) {\n+      const match = emailRegex.exec(src)\n+      if (match) {\n+        const [fullMatch] = match\n+        return {\n+          type: \"email\",\n+          raw: fullMatch,\n+          text: fullMatch,\n+          href: `mailto:${fullMatch}`,\n+          isNip05: false,\n+          tokens: [],\n+        }\n+      }\n+    },\n+    renderer(token: Tokens.Generic) {\n+      if (token.isNip05) {\n+        // Render as Nostr link - create placeholder for Svelte component\n+        const {pubkey} = token\n+        if (pubkey) {\n+          return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+        }\n+        return `\u003ca href=\"mailto:${token.text}\" class=\"link\"\u003e${token.text}\u003c/a\u003e`\n+      } else {\n+        return `\u003ca href=\"${token.href}\" class=\"link\"\u003e${token.text}\u003c/a\u003e`\n+      }\n+    },\n+  }\n+\n+  marked.use({\n+    extensions: [nostrTokenizer, emailTokenizer],\n+    async: true,\n+    breaks: true,\n+    walkTokens: getPub,\n+    renderer: {\n+      image() {\n+        return \"\"\n+      },\n+      link(token) {\n+        const {href, text} = token\n+\n+        // Check if href is a nostr URI\n+        const nostrMatch = href.match(\n+          /^(nostr:)?(n(?:event|ote|pub|profile|addr)1[ac-hj-np-z02-9]{6,})$/,\n+        )\n+        if (nostrMatch) {\n+          const fullId = nostrMatch[2]\n+\n+          try {\n+            const result: any = nip19.decode(fullId)\n+\n+            // For npub and nprofile, create placeholder for Profile component\n+            if (result.type === \"nprofile\" || result.type === \"npub\") {\n+              let pubkey = \"\"\n+              if (result.type === \"nprofile\") {\n+                pubkey = result.data.pubkey\n+              } else if (result.type === \"npub\") {\n+                pubkey = result.data\n+              }\n+\n+              if (pubkey) {\n+                return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+              }\n+            }\n+\n+            // For other nostr types, create regular links\n+            let url = `/${fullId}`\n+            let external = false\n+\n+            if (result.type === \"nevent\" || result.type === \"note\") {\n+              url = `https://coracle.social/notes/${fullId}`\n+              external = true\n+            } else if (result.type === \"naddr\") {\n+              const data = result.data\n+              if (data.kind === 30617) {\n+                url = `/${fullId}`\n+              } else {\n+                external = true\n+                url = `https://coracle.social/${fullId}`\n+              }\n+            }\n+\n+            const externalAttributes = external ? 'target=\"_blank\" rel=\"noopener noreferrer\"' : \"\"\n+            const linkText = text || fullId\n+            return `\u003ca href=\"${url}\" ${externalAttributes} class=\"link\" title=\"${fullId}\"\u003e${linkText}\u003c/a\u003e`\n+          } catch (err) {\n+            console.error(\"Failed to decode nostr link:\", err, fullId)\n+          }\n+        }\n+\n+        // Regular URL handling\n+        const displayText = shortenUrl(href, text)\n+        return `\u003ca href=\"${href}\" class=\"link\" title=\"${href}\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e${displayText}\u003c/a\u003e`\n+      },\n+      list(token) {\n+        const listItems = token.items\n+          .map(item =\u003e {\n+            const itemContent = this.parser.parseInline(item.tokens)\n+            return `\u003cli\u003e${itemContent}\u003c/li\u003e`\n+          })\n+          .join(\"\\n\")\n+\n+        const listClass = token.ordered ? \"list-decimal list-inside\" : \"list-disc list-inside\"\n+\n+        return token.ordered\n+          ? `\u003col class=\"${listClass}\"\u003e${listItems}\u003c/ol\u003e`\n+          : `\u003cul class=\"${listClass}\"\u003e${listItems}\u003c/ul\u003e`\n+      },\n+      code(token) {\n+        const validLang = token.lang || \"plaintext\"\n+        const highlightedCode = hljs.highlight(token.text, {\n+          language: validLang,\n+        }).value\n+\n+        return `\n+                    \u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-${validLang}\"\u003e${highlightedCode}\u003c/code\u003e\u003c/pre\u003e\n+                `\n+      },\n+    },\n+  })\n+\n+  $effect(() =\u003e {\n+    if (content) {\n+      ;(async () =\u003e {\n+        const parsed = await marked(content)\n+        sanitizedContent = DOMPurify.sanitize(parsed, {\n+          ADD_ATTR: [\"target\", \"title\", \"data-pubkey\", \"data-url\"],\n+          ADD_TAGS: [\"span\"],\n+        })\n+      })()\n+    } else {\n+      sanitizedContent = \"\"\n+    }\n+  })\n+\n+  // Mount ProfileLink components after content is rendered\n+  $effect(() =\u003e {\n+    if (containerElement \u0026\u0026 sanitizedContent) {\n+      // Clean up previously mounted components\n+      mountedComponents.forEach(({component}) =\u003e {\n+        try {\n+          component.$destroy?.()\n+        } catch (e) {\n+          // Ignore errors during cleanup\n+        }\n+      })\n+      mountedComponents = []\n+\n+      // Find all profile placeholders and mount components\n+      setTimeout(() =\u003e {\n+        if (!containerElement) return\n+\n+        const placeholders = containerElement.querySelectorAll(\".nostr-profile-placeholder\")\n+        placeholders.forEach(placeholder =\u003e {\n+          const pubkey = placeholder.getAttribute(\"data-pubkey\")\n+          const url = placeholder.getAttribute(\"data-url\")\n+\n+          if (pubkey) {\n+            try {\n+              // Create a wrapper div to hold both components\n+              const wrapper = document.createElement(\"div\")\n+              wrapper.className = \"inline-flex items-center gap-1 align-middle\"\n+              wrapper.style.verticalAlign = \"middle\"\n+\n+              // Create containers for each component\n+              const avatarContainer = document.createElement(\"span\")\n+              const linkContainer = document.createElement(\"span\")\n+\n+              wrapper.appendChild(avatarContainer)\n+              wrapper.appendChild(linkContainer)\n+\n+              // Replace placeholder with wrapper\n+              placeholder.replaceWith(wrapper)\n+\n+              // Mount Profile component (avatar only, hideDetails=true)\n+              const profileComponent = mount(Profile, {\n+                target: avatarContainer,\n+                props: {\n+                  pubkey,\n+                  url: url || undefined,\n+                  avatarSize: 6,\n+                  hideDetails: true,\n+                },\n+              })\n+\n+              // Mount ProfileLink component (name only)\n+              const linkComponent = mount(ProfileLink, {\n+                target: linkContainer,\n+                props: {\n+                  pubkey,\n+                  url: url || undefined,\n+                },\n+              })\n+\n+              mountedComponents.push(\n+                {target: avatarContainer, component: profileComponent},\n+                {target: linkContainer, component: linkComponent},\n+              )\n+            } catch (e) {\n+              console.error(\"Failed to mount Profile components:\", e)\n+            }\n+          }\n+        })\n+      }, 0)\n+    }\n+\n+    return () =\u003e {\n+      // Cleanup on component unmount\n+      mountedComponents.forEach(({component}) =\u003e {\n+        try {\n+          component.$destroy?.()\n+        } catch (e) {\n+          // Ignore errors\n+        }\n+      })\n+    }\n+  })\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"markdown max-w-full overflow-hidden\" bind:this={containerElement}\u003e\n+  {@html sanitizedContent}\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte\nindex 217534d..60d0539 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte\n@@ -27,10 +27,10 @@\n   import {slide} from \"svelte/transition\"\n   import {getContext, onMount} from \"svelte\"\n   import {postComment, postStatus, postLabel, postRoleLabel} from \"@lib/budabit\"\n-  import { PeoplePicker } from \"@nostr-git/ui\"\n-  import { createLabelEvent, type LabelEvent } from \"@nostr-git/shared-types\"\n-  import { publishDelete } from \"@app/core/commands\"\n-  import { ROLE_NS } from \"@lib/budabit/labels\"\n+  import {PeoplePicker} from \"@nostr-git/ui\"\n+  import {createLabelEvent, type LabelEvent} from \"@nostr-git/shared-types\"\n+  import {publishDelete} from \"@app/core/commands\"\n+  import {ROLE_NS} from \"@lib/budabit/labels\"\n   import {\n     REPO_RELAYS_KEY,\n     deriveEffectiveLabels,\n@@ -39,7 +39,8 @@\n     loadRepoAnnouncements,\n     deriveRoleAssignments,\n   } from \"@lib/budabit\"\n-  import { normalizeEffectiveLabels, toNaturalArray } from \"@lib/budabit/labels\"\n+  import {normalizeEffectiveLabels, toNaturalArray} from \"@lib/budabit/labels\"\n+  import Markdown from \"@src/lib/components/Markdown.svelte\"\n \n   const markdown = markdownit({\n     html: true,\n@@ -121,7 +122,7 @@\n         content: \"\",\n         e: [issue.id],\n         namespaces: [value],\n-        labels: [{ value }],\n+        labels: [{value}],\n       }) as any\n       console.debug(\"[IssueDetail] addLabel event payload\", labelEvent)\n       postLabel(labelEvent as any, relays)\n@@ -170,16 +171,13 @@\n     return toNaturalArray(norm.flat)\n   })\n \n-  const roleAssignments = $derived.by(() =\u003e\n-    issue ? deriveRoleAssignments(issue.id) : undefined\n-  )\n+  const roleAssignments = $derived.by(() =\u003e (issue ? deriveRoleAssignments(issue.id) : undefined))\n   const assignees = $derived.by(() =\u003e\n-    Array.from((roleAssignments?.get()?.assignees || new Set()) as Set\u003cstring\u003e)\n+    Array.from((roleAssignments?.get()?.assignees || new Set()) as Set\u003cstring\u003e),\n   )\n \n   // PeoplePicker will render from LabelEvent[] directly\n \n-\n   // Resolve effective status using precedence rules (maintainers \u003e author \u003e others; kind; recency)\n   const resolved = $derived.by(() =\u003e {\n     if (!$statusEvents || !issue) return undefined\n@@ -258,49 +256,49 @@\n     return thunk\n   }\n \n-    // Profile functions for PeoplePicker\n-    const getProfile = async (pubkey: string) =\u003e {\n-        const profile = $profilesByPubkey.get(pubkey)\n-        if (profile) {\n-            return {\n-                name: profile.name,\n-                picture: profile.picture,\n-                nip05: profile.nip05,\n-                display_name: profile.display_name,\n-            }\n-        }\n-        // Try to load profile if not in cache\n-        // Filter out invalid relay URLs to prevent errors\n-        const validRelays = (repoClass.relays || []).filter((relay: string) =\u003e {\n-            try {\n-                const url = new URL(relay)\n-                return url.protocol === 'ws:' || url.protocol === 'wss:'\n-            } catch {\n-                console.warn(`Invalid relay URL filtered out: ${relay}`)\n-                return false\n-            }\n-        })\n-        \n-        if (validRelays.length \u003e 0) {\n-            await loadProfile(pubkey, validRelays)\n-        }\n-        \n-        const loadedProfile = $profilesByPubkey.get(pubkey)\n-        if (loadedProfile) {\n-            return {\n-                name: loadedProfile.name,\n-                picture: loadedProfile.picture,\n-                nip05: loadedProfile.nip05,\n-                display_name: loadedProfile.display_name,\n-            }\n-        }\n-        return null\n+  // Profile functions for PeoplePicker\n+  const getProfile = async (pubkey: string) =\u003e {\n+    const profile = $profilesByPubkey.get(pubkey)\n+    if (profile) {\n+      return {\n+        name: profile.name,\n+        picture: profile.picture,\n+        nip05: profile.nip05,\n+        display_name: profile.display_name,\n+      }\n+    }\n+    // Try to load profile if not in cache\n+    // Filter out invalid relay URLs to prevent errors\n+    const validRelays = (repoClass.relays || []).filter((relay: string) =\u003e {\n+      try {\n+        const url = new URL(relay)\n+        return url.protocol === \"ws:\" || url.protocol === \"wss:\"\n+      } catch {\n+        console.warn(`Invalid relay URL filtered out: ${relay}`)\n+        return false\n+      }\n+    })\n+\n+    if (validRelays.length \u003e 0) {\n+      await loadProfile(pubkey, validRelays)\n     }\n \n+    const loadedProfile = $profilesByPubkey.get(pubkey)\n+    if (loadedProfile) {\n+      return {\n+        name: loadedProfile.name,\n+        picture: loadedProfile.picture,\n+        nip05: loadedProfile.nip05,\n+        display_name: loadedProfile.display_name,\n+      }\n+    }\n+    return null\n+  }\n+\n   const searchProfiles = async (query: string) =\u003e {\n     // profileSearch.searchValues returns an array of pubkeys (strings)\n     const pubkeys = $profileSearch.searchValues(query)\n-    \n+\n     // Map each pubkey to a profile object by looking it up in profilesByPubkey\n     return pubkeys.map((pubkey: string) =\u003e {\n       const profile = $profilesByPubkey.get(pubkey)\n@@ -320,20 +318,23 @@\n \u003c/svelte:head\u003e\n \n {#if issue}\n-  \u003cdiv class=\"z-10 sticky top-0 items-center justify-between py-2 sm:py-4 backdrop-blur px-2 sm:px-0\" transition:slide\u003e\n-    \u003cCard class=\"git-card transition-colors p-4 sm:p-6\"\u003e\n+  \u003cdiv\n+    class=\"z-10 sticky top-0 items-center justify-between px-2 py-2 backdrop-blur sm:px-0 sm:py-4\"\n+    transition:slide\u003e\n+    \u003cCard class=\"git-card p-4 transition-colors sm:p-6\"\u003e\n       \u003cdiv class=\"flex items-start gap-2 sm:gap-4\"\u003e\n         {#if statusIcon}\n           {@const {icon: Icon, color} = statusIcon()}\n           \u003cdiv class=\"mt-1 flex-shrink-0\"\u003e\n-            \u003cdiv class=\"flex h-8 w-8 sm:h-10 sm:w-10 items-center justify-center rounded-full bg-amber-500/10\"\u003e\n+            \u003cdiv\n+              class=\"flex h-8 w-8 items-center justify-center rounded-full bg-amber-500/10 sm:h-10 sm:w-10\"\u003e\n               \u003cIcon class={`h-4 w-4 sm:h-6 sm:w-6 ${color}`} /\u003e\n             \u003c/div\u003e\n           \u003c/div\u003e\n         {/if}\n         \u003cdiv class=\"min-w-0 flex-1\"\u003e\n-          \u003ch1 class=\"break-words text-lg sm:text-xl font-semibold\"\u003e{issue.subject || \"Issue\"}\u003c/h1\u003e\n-          \u003cdiv class=\"mt-2 flex flex-col sm:flex-row sm:items-center gap-2\"\u003e\n+          \u003ch1 class=\"break-words text-lg font-semibold sm:text-xl\"\u003e{issue.subject || \"Issue\"}\u003c/h1\u003e\n+          \u003cdiv class=\"mt-2 flex flex-col gap-2 sm:flex-row sm:items-center\"\u003e\n             \u003cStatus\n               repo={repoClass}\n               rootId={issue.id}\n@@ -343,18 +344,22 @@\n               actorPubkey={$pubkey}\n               compact={true}\n               ProfileComponent={ProfileLink} /\u003e\n-            \u003cspan class=\"text-xs sm:text-sm text-muted-foreground flex flex-wrap items-center gap-1\"\u003e\n+            \u003cspan\n+              class=\"flex flex-wrap items-center gap-1 text-xs text-muted-foreground sm:text-sm\"\u003e\n               \u003cProfileLink pubkey={issue?.author.pubkey}\u003e\u003c/ProfileLink\u003e\n               \u003cspan class=\"hidden sm:inline\"\u003eopened this issue •\u003c/span\u003e\n               \u003cspan class=\"sm:hidden\"\u003eopened\u003c/span\u003e\n-              \u003cspan class=\"text-xs break-all sm:break-normal\"\u003e{new Date(issue?.createdAt).toLocaleString()}\u003c/span\u003e\n+              \u003cspan class=\"break-all text-xs sm:break-normal\"\n+                \u003e{new Date(issue?.createdAt).toLocaleString()}\u003c/span\u003e\n             \u003c/span\u003e\n           \u003c/div\u003e\n         \u003c/div\u003e\n       \u003c/div\u003e\n \n-      \u003cdiv class=\"prose-sm dark:prose-invert prose mt-6 sm:mt-8 max-w-none break-words [\u0026_*]:break-words [\u0026_pre]:overflow-x-auto [\u0026_code]:break-words\"\u003e\n-        {@html markdown.render(issue.content)}\n+      \u003cdiv\n+        class=\"prose-sm dark:prose-invert prose mt-6 max-w-none break-words sm:mt-8 [\u0026_*]:break-words [\u0026_code]:break-words [\u0026_pre]:overflow-x-auto\"\u003e\n+        \u003c!-- {@html markdown.render(issue.content)} --\u003e\n+        \u003cMarkdown content={issue.content} /\u003e\n       \u003c/div\u003e\n \n       \u003cdiv class=\"git-separator my-4 sm:my-6\"\u003e\u003c/div\u003e\n@@ -369,16 +374,17 @@\n           \u003c/div\u003e\n         {/if}\n         {#if isMaintainerOrAuthor}\n-          \u003cdiv class=\"flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full max-w-full\"\u003e\n+          \u003cdiv\n+            class=\"flex w-full max-w-full flex-col items-stretch gap-2 sm:flex-row sm:items-center\"\u003e\n             \u003cinput\n-              class=\"flex-1 min-w-0 rounded-md border border-border bg-background px-3 py-2 sm:px-2 sm:py-1 text-sm min-h-[44px] sm:min-h-0\"\n+              class=\"min-h-[44px] min-w-0 flex-1 rounded-md border border-border bg-background px-3 py-2 text-sm sm:min-h-0 sm:px-2 sm:py-1\"\n               placeholder=\"Add tag...\"\n               bind:value={newLabel}\n               onkeydown={e =\u003e {\n                 if (e.key === \"Enter\") addLabel()\n               }} /\u003e\n             \u003cbutton\n-              class=\"flex-shrink-0 rounded-md border border-border px-3 py-2 sm:px-3 sm:py-1 text-sm min-h-[44px] sm:min-h-0\"\n+              class=\"min-h-[44px] flex-shrink-0 rounded-md border border-border px-3 py-2 text-sm sm:min-h-0 sm:px-3 sm:py-1\"\n               onclick={addLabel}\n               disabled={addingLabel || !newLabel.trim()}\u003e\n               \u003cspan class=\"whitespace-nowrap\"\u003e{addingLabel ? \"Adding...\" : \"Add Tag\"}\u003c/span\u003e\n@@ -400,24 +406,24 @@\n             {getProfile}\n             {searchProfiles}\n             add={async (pubkey: string) =\u003e {\n-              if (!issue) return;\n+              if (!issue) return\n               try {\n                 const relays = (repoClass.relays || repoRelays || []).map((u: string) =\u003e\n-                  normalizeRelayUrl(u)\n-                );\n+                  normalizeRelayUrl(u),\n+                )\n                 postRoleLabel({\n                   rootId: issue.id,\n                   role: \"assignee\",\n                   pubkeys: [pubkey],\n                   repoAddr: (repoClass as any)?.repoEvent?.id,\n                   relays,\n-                });\n+                })\n                 await load({\n                   relays,\n-                  filters: [{ kinds: [1985], \"#e\": [issue.id] }],\n-                });\n+                  filters: [{kinds: [1985], \"#e\": [issue.id]}],\n+                })\n               } catch (err) {\n-                console.error(\"[IssueDetail] Failed to add assignee\", err);\n+                console.error(\"[IssueDetail] Failed to add assignee\", err)\n               }\n             }}\n             onDeleteLabel={async (evt: LabelEvent) =\u003e {\n@@ -426,23 +432,20 @@\n                 const relays = (repoClass.relays || repoRelays || [])\n                   .map((u: string) =\u003e normalizeRelayUrl(u))\n                   .filter(Boolean)\n-                publishDelete({ event: evt as any, relays, protect: false })\n-                await load({ relays, filters: [{ kinds: [1985], \"#e\": [issue.id] }] })\n+                publishDelete({event: evt as any, relays, protect: false})\n+                await load({relays, filters: [{kinds: [1985], \"#e\": [issue.id]}]})\n               } catch (err) {\n                 console.error(\"[IssueDetail] Failed to delete assignee label\", err)\n               }\n-            }}\n-          /\u003e\n+            }} /\u003e\n+        {:else if assignees.length}\n+          \u003cdiv class=\"flex flex-wrap gap-2\"\u003e\n+            {#each assignees as pk (pk)}\n+              \u003cProfileLink pubkey={pk} /\u003e\n+            {/each}\n+          \u003c/div\u003e\n         {:else}\n-          {#if assignees.length}\n-            \u003cdiv class=\"flex flex-wrap gap-2\"\u003e\n-              {#each assignees as pk (pk)}\n-                \u003cProfileLink pubkey={pk} /\u003e\n-              {/each}\n-            \u003c/div\u003e\n-          {:else}\n-            \u003cdiv class=\"text-xs sm:text-sm text-muted-foreground\"\u003eNo assignees yet.\u003c/div\u003e\n-          {/if}\n+          \u003cdiv class=\"text-xs text-muted-foreground sm:text-sm\"\u003eNo assignees yet.\u003c/div\u003e\n         {/if}\n       \u003c/div\u003e\n \n@@ -462,8 +465,8 @@\n \n       \u003cdiv class=\"git-separator my-4 sm:my-6\"\u003e\u003c/div\u003e\n \n-      \u003ch2 class=\"my-2 flex items-center gap-2 text-base sm:text-lg font-medium\"\u003e\n-        \u003cMessageSquare class=\"h-4 w-4 sm:h-5 sm:w-5 flex-shrink-0\" /\u003e\n+      \u003ch2 class=\"my-2 flex items-center gap-2 text-base font-medium sm:text-lg\"\u003e\n+        \u003cMessageSquare class=\"h-4 w-4 flex-shrink-0 sm:h-5 sm:w-5\" /\u003e\n         \u003cspan class=\"break-words\"\u003eDiscussion ({$threadComments?.length})\u003c/span\u003e\n       \u003c/h2\u003e\n \n@@ -476,8 +479,8 @@\n     \u003c/Card\u003e\n   \u003c/div\u003e\n {:else}\n-  \u003cdiv class=\"flex flex-col items-center justify-center py-8 sm:py-12 px-4\"\u003e\n+  \u003cdiv class=\"flex flex-col items-center justify-center px-4 py-8 sm:py-12\"\u003e\n     \u003cSearchX class=\"mb-2 h-6 w-6 sm:h-8 sm:w-8\" /\u003e\n-    \u003cp class=\"text-sm sm:text-base text-center\"\u003eNo issue found.\u003c/p\u003e\n+    \u003cp class=\"text-center text-sm sm:text-base\"\u003eNo issue found.\u003c/p\u003e\n   \u003c/div\u003e\n {/if}\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-6iyjuien","title":"Valid Github access token not recognized","description":"Gave permission to access repo on GitHub but BudaBit UI says \"has token, not maintainer\", and it will hang for ever if I try to push a merge, without an error message or timeout.\nTried to add \"classic\" as well as \"fine-grained\" token, neither worked.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue","question"]}
{"id":"flotilla-6j3ujh0m","title":"From e62f7b5fcff92f8d31525ee4c6bde0f8e0c51131 Mon Sep 17 00:00:00 2001","description":"From e62f7b5fcff92f8d31525ee4c6bde0f8e0c51131 Mon Sep 17 00:00:00 2001\nFrom: Five \u003cco22rkn@protonmail.com\u003e\nDate: Fri, 20 Jun 2025 12:24:38 +0200\nSubject: [PATCH 4/9] Deleted unused repo.ts\n\n---\n src/lib/repo.ts | 81 ---------------------------------------------------------------------------------\n 1 file changed, 81 deletions(-)\n delete mode 100644 src/lib/repo.ts\n\ndiff --git a/src/lib/repo.ts b/src/lib/repo.ts\ndeleted file mode 100644\nindex 477fe7e..0000000\n--- a/src/lib/repo.ts\n+++ /dev/null\n@@ -1,81 +0,0 @@\n-import { derived, get } from 'svelte/store';\n-import { parseRepoAnnouncementEvent, type CommentEvent, type IssueEvent, type RepoAnnouncementEvent } from '@nostr-git/shared-types';\n-import { deriveNaddrEvent } from '@src/app/state';\n-import { deriveEvents } from '@welshman/store';\n-import { publishThunk, repository } from '@welshman/app';\n-import { GIT_ISSUE, GIT_PATCH, type Filter } from '@welshman/util';\n-import { Address } from '@welshman/util';\n-import { GIT_REPO_STATE } from '@src/lib/util';\n-import { nthEq } from '@welshman/lib';\n-\n-\n-export function createRepoModel({ id, relay }: { id: string; relay: string }) {\n-    const repoEvent = deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay]);\n-\n-    const issues = derived(repoEvent, $repoEvent =\u003e {\n-        if (!$repoEvent) return [];\n-        const address = Address.fromEvent($repoEvent).toString();\n-        const issueFilter = [{ kinds: [GIT_ISSUE], \"#a\": [address] }];\n-        return deriveEvents(repository, { filters: issueFilter });\n-    });\n-\n-    const patches = derived(repoEvent, $repoEvent =\u003e {\n-        if (!$repoEvent) return [];\n-        const address = Address.fromEvent($repoEvent).toString();\n-        const patchFilter = [{ kinds: [GIT_PATCH], \"#a\": [address], \"#t\": [\"root\"] }];\n-        return deriveEvents(repository, { filters: patchFilter });\n-    });\n-\n-    const repoState = derived(repoEvent, $repoEvent =\u003e {\n-        if (!$repoEvent) return null;\n-        const repoAnn = parseRepoAnnouncementEvent($repoEvent as RepoAnnouncementEvent);\n-        const address = repoAnn.repoId;\n-        const repoStateFilter: Filter[] = [\n-            { kinds: [GIT_REPO_STATE], \"#d\": [address!] },\n-        ];\n-        return deriveEvents(repository, { filters: repoStateFilter });\n-    });\n-\n-    const relays = derived(repoEvent, $repoEvent =\u003e {\n-        if ($repoEvent) {\n-            const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || [];\n-            return relays;\n-        }\n-    });\n-\n-    function postComment(comment: CommentEvent) {\n-        const currentRelays = get(relays);\n-        if (!currentRelays?.length) {\n-            console.error('No relays available for posting comment');\n-            return Promise.reject('No relays available');\n-        }\n-\n-        return publishThunk({\n-            relays: currentRelays,\n-            event: comment,\n-        });\n-    }\n-\n-    function postIssue(issue: IssueEvent) {\n-        const currentRelays = get(relays);\n-        if (!currentRelays?.length) {\n-            console.error('No relays available for posting issue');\n-            return Promise.reject('No relays available');\n-        }\n-\n-        return publishThunk({\n-            relays: currentRelays,\n-            event: issue,\n-        });\n-    }\n-\n-    return {\n-        repoEvent,\n-        issues,\n-        patches,\n-        repoState,\n-        relays,\n-        postComment,\n-        postIssue,\n-    }\n-}\n\\ No newline at end of file\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-6nu5ubw1","title":"From 643f2b706b64acfea7fbeb978c48102c219d28db Mon Sep 17 00:00:00 2001","description":"From 643f2b706b64acfea7fbeb978c48102c219d28db Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 20 May 2025 21:33:33 -0700\nSubject: [PATCH 1/2] refactoring of git feed code\n\n---\n .env                                                         |   9 ++++++---\n packages/nostr-git                                           |   2 +-\n pnpm-lock.yaml                                               | 203 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--\n src/app/components/GitActions.svelte                         |  57 +++++++++++----------------------------------------------\n src/app/components/RepoPicker.svelte                         | 186 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------------------------------------------------------------------------------------\n src/routes/spaces/[relay]/git/+page.svelte                   |  26 +++++++++++---------------\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte | 115 ++++++++++++++++++++++++++++++++++++++++++++++++++-----------------------------------------------------------------\n vite.config.ts                                               |   8 ++++++++\n 8 files changed, 364 insertions(+), 242 deletions(-)\n\ndiff --git a/.env b/.env\nindex 3e77ae5..1bbf3e0 100644\n--- a/.env\n+++ b/.env\n@@ -5,10 +5,13 @@ VITE_PLATFORM_TERMS=\n VITE_PLATFORM_PRIVACY=\n VITE_PLATFORM_NAME=Budabit\n VITE_PLATFORM_LOGO=static/budabit.png\n-VITE_PLATFORM_RELAY=ws://192.168.1.101:7000\n+VITE_PLATFORM_RELAY=wss://budabit.nostr1.com\n VITE_PLATFORM_ACCENT=\"#D4AF37\"\n+VITE_PLATFORM_SECONDARY=\"#EB5E28\"\n VITE_PLATFORM_DESCRIPTION=\"The Club for Builders in Freedom Tech.\"\n-VITE_GLITCHTIP_API_KEY=\n-GLITCHTIP_AUTH_TOKEN=\n VITE_INDEXER_RELAYS=wss://purplepag.es/,wss://relay.damus.io/,wss://relay.nostr.band/\n VITE_SIGNER_RELAYS=wss://relay.nsec.app/,wss://bucket.coracle.social/\n+VITE_NOTIFIER_PUBKEY=27b7c2ed89ef78322114225ea3ebf5f72c7767c2528d4d0c1854d039c00085df\n+VITE_NOTIFIER_RELAY=wss://anchor.coracle.social/\n+VITE_GLITCHTIP_API_KEY=\n+GLITCHTIP_AUTH_TOKEN=\n\\ No newline at end of file\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex ba20964..b536fcc 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit ba20964c0fcab077d9c0c76d95241e8e980c4d81\n+Subproject commit b536fcc8a64b876ad9bed5615f3a62bf77888c85\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 9ddf517..fd252da 100644\n--- a/pnpm-lock.yaml\n+++ b/pnpm-lock.yaml\n@@ -213,6 +213,9 @@ importers:\n       '@nostr-git/ui':\n         specifier: link:packages/ui\n         version: link:packages/ui\n+      svelte-routing:\n+        specifier: ^2.13.0\n+        version: 2.13.0\n     devDependencies:\n       '@storybook/addon-svelte-csf':\n         specifier: 5.0.0-next.28\n@@ -221,12 +224,26 @@ importers:\n         specifier: ^5.3.3\n         version: 5.8.3\n \n+  packages/nostr-git/packages/actions/generate-repo-announcement: {}\n+\n   packages/nostr-git/packages/actions/nostr-post-event:\n     dependencies:\n+      '@actions/core':\n+        specifier: ^1.11.1\n+        version: 1.11.1\n+      '@actions/github':\n+        specifier: ^6.0.1\n+        version: 6.0.1\n+      '@nostr-git/core':\n+        specifier: workspace:*\n+        version: link:../../core\n       nostr-tools:\n         specifier: ^2.12.0\n         version: 2.12.0(typescript@5.8.3)\n     devDependencies:\n+      '@types/node':\n+        specifier: ^22.15.19\n+        version: 22.15.19\n       typescript:\n         specifier: 5.8.3\n         version: 5.8.3\n@@ -530,6 +547,21 @@ importers:\n \n packages:\n \n+  '@actions/core@1.11.1':\n+    resolution: {integrity: sha512-hXJCSrkwfA46Vd9Z3q4cpEpHB1rL5NG04+/rbqW9d3+CSvtB1tYe8UTpAlixa1vj0m/ULglfEK2UKxMGxCxv5A==}\n+\n+  '@actions/exec@1.1.1':\n+    resolution: {integrity: sha512-+sCcHHbVdk93a0XT19ECtO/gIXoxvdsgQLzb2fE2/5sIZmWQuluYyjPQtrtTHdU1YzTZ7bAPN4sITq2xi1679w==}\n+\n+  '@actions/github@6.0.1':\n+    resolution: {integrity: sha512-xbZVcaqD4XnQAe35qSQqskb3SqIAfRyLBrHMd/8TuL7hJSz2QtbDwnNM8zWx4zO5l2fnGtseNE3MbEvD7BxVMw==}\n+\n+  '@actions/http-client@2.2.3':\n+    resolution: {integrity: sha512-mx8hyJi/hjFvbPokCg4uRd4ZX78t+YyRPtnKWwIl+RzNaVuFpQHfmlGVfsKEJN8LwTCvL+DfVgAM04XaHkm6bA==}\n+\n+  '@actions/io@1.1.3':\n+    resolution: {integrity: sha512-wi9JjgKLYS7U/z8PPbco+PvTb/nRWjeoFlJ1Qer83k/3C5PHQi28hiVdeE2kHXmIL99mQFawx8qt/JPjZilJ8Q==}\n+\n   '@adobe/css-tools@4.4.2':\n     resolution: {integrity: sha512-baYZExFpsdkBNuvGKTKWCwKH57HRZLVtycZS05WTQNVOiXVSeAki3nU35zlRbToeMW8aHlJfyS+1C4BOv27q0A==}\n \n@@ -1599,6 +1631,10 @@ packages:\n     resolution: {integrity: sha512-ZAoA40rNMPwSm+AeHpCq8STiNAwzWLJuP8Xv4CHIc9wv/PSuExjMrmjfYNj682vW0OOiZ1HKxzvjQr9XZIisQA==}\n     engines: {node: ^18.18.0 || ^20.9.0 || \u003e=21.1.0}\n \n+  '@fastify/busboy@2.1.1':\n+    resolution: {integrity: sha512-vBZP4NlzfOlerQTnba4aqZoMhE/a9HY7HRqoOPaETQcSQuWEIyZMHGfVu6w9wGtGK5fED5qRs2DteVCjOH60sA==}\n+    engines: {node: '\u003e=14'}\n+\n   '@floating-ui/core@1.7.0':\n     resolution: {integrity: sha512-FRdBLykrPPA6P76GGGqlex/e7fbe0F1ykgxHYNXQsH/iTEtjMj/f9bpY5oQqbjt5VgZvgz/uKXbGuROijh3VLA==}\n \n@@ -1890,6 +1926,54 @@ packages:\n     resolution: {integrity: sha512-oGB+UxlgWcgQkgwo8GcEGwemoTFt3FIO9ababBmaGwXIoBKZ+GTy0pP185beGg7Llih/NSHSV2XAs1lnznocSg==}\n     engines: {node: '\u003e= 8'}\n \n+  '@octokit/auth-token@4.0.0':\n+    resolution: {integrity: sha512-tY/msAuJo6ARbK6SPIxZrPBms3xPbfwBrulZe0Wtr/DIY9lje2HeV1uoebShn6mx7SjCHif6EjMvoREj+gZ+SA==}\n+    engines: {node: '\u003e= 18'}\n+\n+  '@octokit/core@5.2.1':\n+    resolution: {integrity: sha512-dKYCMuPO1bmrpuogcjQ8z7ICCH3FP6WmxpwC03yjzGfZhj9fTJg6+bS1+UAplekbN2C+M61UNllGOOoAfGCrdQ==}\n+    engines: {node: '\u003e= 18'}\n+\n+  '@octokit/endpoint@9.0.6':\n+    resolution: {integrity: sha512-H1fNTMA57HbkFESSt3Y9+FBICv+0jFceJFPWDePYlR/iMGrwM5ph+Dd4XRQs+8X+PUFURLQgX9ChPfhJ/1uNQw==}\n+    engines: {node: '\u003e= 18'}\n+\n+  '@octokit/graphql@7.1.1':\n+    resolution: {integrity: sha512-3mkDltSfcDUoa176nlGoA32RGjeWjl3K7F/BwHwRMJUW/IteSa4bnSV8p2ThNkcIcZU2umkZWxwETSSCJf2Q7g==}\n+    engines: {node: '\u003e= 18'}\n+\n+  '@octokit/openapi-types@20.0.0':\n+    resolution: {integrity: sha512-EtqRBEjp1dL/15V7WiX5LJMIxxkdiGJnabzYx5Apx4FkQIFgAfKumXeYAqqJCj1s+BMX4cPFIFC4OLCR6stlnA==}\n+\n+  '@octokit/openapi-types@24.2.0':\n+    resolution: {integrity: sha512-9sIH3nSUttelJSXUrmGzl7QUBFul0/mB8HRYl3fOlgHbIWG+WnYDXU3v/2zMtAvuzZ/ed00Ei6on975FhBfzrg==}\n+\n+  '@octokit/plugin-paginate-rest@9.2.2':\n+    resolution: {integrity: sha512-u3KYkGF7GcZnSD/3UP0S7K5XUFT2FkOQdcfXZGZQPGv3lm4F2Xbf71lvjldr8c1H3nNbF+33cLEkWYbokGWqiQ==}\n+    engines: {node: '\u003e= 18'}\n+    peerDependencies:\n+      '@octokit/core': '5'\n+\n+  '@octokit/plugin-rest-endpoint-methods@10.4.1':\n+    resolution: {integrity: sha512-xV1b+ceKV9KytQe3zCVqjg+8GTGfDYwaT1ATU5isiUyVtlVAO3HNdzpS4sr4GBx4hxQ46s7ITtZrAsxG22+rVg==}\n+    engines: {node: '\u003e= 18'}\n+    peerDependencies:\n+      '@octokit/core': '5'\n+\n+  '@octokit/request-error@5.1.1':\n+    resolution: {integrity: sha512-v9iyEQJH6ZntoENr9/yXxjuezh4My67CBSu9r6Ve/05Iu5gNgnisNWOsoJHTP6k0Rr0+HQIpnH+kyammu90q/g==}\n+    engines: {node: '\u003e= 18'}\n+\n+  '@octokit/request@8.4.1':\n+    resolution: {integrity: sha512-qnB2+SY3hkCmBxZsR/MPCybNmbJe4KAlfWErXq+rBKkQJlbjdJeS85VI9r8UqeLYLvnAenU8Q1okM/0MBsAGXw==}\n+    engines: {node: '\u003e= 18'}\n+\n+  '@octokit/types@12.6.0':\n+    resolution: {integrity: sha512-1rhSOfRa6H9w4YwK0yrf5faDaDTb+yLyBUKOCV4xtCDB5VmIPqd/v9yr9o6SAzOAlRxMiRiCic6JVM1/kunVkw==}\n+\n+  '@octokit/types@13.10.0':\n+    resolution: {integrity: sha512-ifLaO34EbbPj0Xgro4G5lP5asESjwHracYJvVaPIyXMuiuXLlhic3S47cBdTb+jfODkTE5YtGCLt3Ay3+J97sA==}\n+\n   '@pkgjs/parseargs@0.11.0':\n     resolution: {integrity: sha512-+1VkjdD0QBLPodGrJUeqarH8VAIvQODIbwh9XpP5Syisf7YoQgsJKPNFoqqLQlu+VQ/tVSshMR6loPMn8U+dPg==}\n     engines: {node: '\u003e=14'}\n@@ -3087,6 +3171,9 @@ packages:\n   base64-js@1.5.1:\n     resolution: {integrity: sha512-AKpaYlHn8t4SVbOHCy+b5+KKgvR4vrsD8vbvrbiQJps7fKDTkjkDry6ji0rUJjC0kzbNePLwzxq8iypo41qeWA==}\n \n+  before-after-hook@2.2.3:\n+    resolution: {integrity: sha512-NzUnlZexiaH/46WDhANlyR2bXRopNg4F/zuSA3OpZnllCUgRaOF2znDioDWrmbNVsuZk6l9pMquQB38cfBZwkQ==}\n+\n   better-opn@3.0.2:\n     resolution: {integrity: sha512-aVNobHnJqLiUelTaHat9DZ1qM2w0C0Eym4LPI/3JxOnSokGVdsl1T1kN7TFvsEAD8G47A6VKQ0TVHqbBnYMJlQ==}\n     engines: {node: '\u003e=12.0.0'}\n@@ -3627,6 +3714,9 @@ packages:\n     resolution: {integrity: sha512-ZySD7Nf91aLB0RxL4KGrKHBXl7Eds1DAmEdcoVawXnLD7SDhpNgtuII2aAkg7a7QS41jxPSZ17p4VdGnMHk3MQ==}\n     engines: {node: '\u003e=0.4.0'}\n \n+  deprecation@2.3.1:\n+    resolution: {integrity: sha512-xmHIy4F3scKVwMsQ4WnVaS8bHOx0DmVwRywosKhaILI0ywMDWPtBSku2HNxRvF7jtwDRsoEwYQSfbxj8b7RlJQ==}\n+\n   dequal@2.0.3:\n     resolution: {integrity: sha512-0je+qPKHEMohvfRTCEo3CrPG6cAzAYgmzKyxRiYSSDkS6eGJdyVJm7WaYA5ECaAD9wLB2T4EEeymA5aFVcYXCA==}\n     engines: {node: '\u003e=6'}\n@@ -6451,6 +6541,10 @@ packages:\n   tunnel-agent@0.6.0:\n     resolution: {integrity: sha512-McnNiV1l8RYeY8tBgEpuodCC1mLUdbSN+CYBL7kJsJNInOP8UjDDEwdk6Mw60vdLLrr5NHKZhMAOSrR2NZuQ+w==}\n \n+  tunnel@0.0.6:\n+    resolution: {integrity: sha512-1h/Lnq9yajKY2PEbBadPXj3VxsDDu844OnaAo52UVmIzIvwwtBPIuNvkjuzBlTWpfJyUbG3ez0KSBibQkj4ojg==}\n+    engines: {node: '\u003e=0.6.11 \u003c=0.7.0 || \u003e=0.7.3'}\n+\n   tw-animate-css@1.3.0:\n     resolution: {integrity: sha512-jrJ0XenzS9KVuDThJDvnhalbl4IYiMQ/XvpA0a2FL8KmlK+6CSMviO7ROY/I7z1NnUs5NnDhlM6fXmF40xPxzw==}\n \n@@ -6541,6 +6635,10 @@ packages:\n   undici-types@6.21.0:\n     resolution: {integrity: sha512-iwDZqg0QAGrg9Rav5H4n0M64c3mkR59cJ6wQp+7C4nI0gsmExaedaYLNO44eT4AtBBwjbTiGPMlt2Md0T9H9JQ==}\n \n+  undici@5.29.0:\n+    resolution: {integrity: sha512-raqeBD6NQK4SkWhQzeYKd1KmIG6dllBOTt55Rmkt4HtI9mwdWtJljnrXjAFUBLTSN67HWrOIZ3EPF4kjUw80Bg==}\n+    engines: {node: '\u003e=14.0'}\n+\n   unicode-canonical-property-names-ecmascript@2.0.1:\n     resolution: {integrity: sha512-dA8WbNeb2a6oQzAQ55YlT5vQAWGV9WXOsi3SskE3bcCdM0P4SDd+24zS/OCacdRq5BkdsRj9q3Pg6YyQoxIGqg==}\n     engines: {node: '\u003e=4'}\n@@ -6565,6 +6663,9 @@ packages:\n     resolution: {integrity: sha512-uNaeirEPvpZWSgzwsPGtU2zVSTrn/8L5q/IexZmH0eH6SA73CmAA5U4GwORTxQAZs95TAXLNqeLoPPNO5gZfWg==}\n     engines: {node: '\u003e=8'}\n \n+  universal-user-agent@6.0.1:\n+    resolution: {integrity: sha512-yCzhz6FN2wU1NiiQRogkTQszlQSlpWaw8SvVegAc+bDxbzHgh1vX8uIe8OYyMH6DwH+sdTJsgMl36+mSMdRJIQ==}\n+\n   universalify@2.0.1:\n     resolution: {integrity: sha512-gptHNQghINnc/vTGIk0SOFGFNXw7JVrlRUtConJRlvaw6DuX0wO5Jeko9sWrMBhh+PsYAZ7oXAiOnf/UKogyiw==}\n     engines: {node: '\u003e= 10.0.0'}\n@@ -6971,6 +7072,32 @@ packages:\n \n snapshots:\n \n+  '@actions/core@1.11.1':\n+    dependencies:\n+      '@actions/exec': 1.1.1\n+      '@actions/http-client': 2.2.3\n+\n+  '@actions/exec@1.1.1':\n+    dependencies:\n+      '@actions/io': 1.1.3\n+\n+  '@actions/github@6.0.1':\n+    dependencies:\n+      '@actions/http-client': 2.2.3\n+      '@octokit/core': 5.2.1\n+      '@octokit/plugin-paginate-rest': 9.2.2(@octokit/core@5.2.1)\n+      '@octokit/plugin-rest-endpoint-methods': 10.4.1(@octokit/core@5.2.1)\n+      '@octokit/request': 8.4.1\n+      '@octokit/request-error': 5.1.1\n+      undici: 5.29.0\n+\n+  '@actions/http-client@2.2.3':\n+    dependencies:\n+      tunnel: 0.0.6\n+      undici: 5.29.0\n+\n+  '@actions/io@1.1.3': {}\n+\n   '@adobe/css-tools@4.4.2': {}\n \n   '@alloc/quick-lru@5.2.0': {}\n@@ -8155,6 +8282,8 @@ snapshots:\n       '@eslint/core': 0.13.0\n       levn: 0.4.1\n \n+  '@fastify/busboy@2.1.1': {}\n+\n   '@floating-ui/core@1.7.0':\n     dependencies:\n       '@floating-ui/utils': 0.2.9\n@@ -8485,6 +8614,64 @@ snapshots:\n       '@nodelib/fs.scandir': 2.1.5\n       fastq: 1.19.1\n \n+  '@octokit/auth-token@4.0.0': {}\n+\n+  '@octokit/core@5.2.1':\n+    dependencies:\n+      '@octokit/auth-token': 4.0.0\n+      '@octokit/graphql': 7.1.1\n+      '@octokit/request': 8.4.1\n+      '@octokit/request-error': 5.1.1\n+      '@octokit/types': 13.10.0\n+      before-after-hook: 2.2.3\n+      universal-user-agent: 6.0.1\n+\n+  '@octokit/endpoint@9.0.6':\n+    dependencies:\n+      '@octokit/types': 13.10.0\n+      universal-user-agent: 6.0.1\n+\n+  '@octokit/graphql@7.1.1':\n+    dependencies:\n+      '@octokit/request': 8.4.1\n+      '@octokit/types': 13.10.0\n+      universal-user-agent: 6.0.1\n+\n+  '@octokit/openapi-types@20.0.0': {}\n+\n+  '@octokit/openapi-types@24.2.0': {}\n+\n+  '@octokit/plugin-paginate-rest@9.2.2(@octokit/core@5.2.1)':\n+    dependencies:\n+      '@octokit/core': 5.2.1\n+      '@octokit/types': 12.6.0\n+\n+  '@octokit/plugin-rest-endpoint-methods@10.4.1(@octokit/core@5.2.1)':\n+    dependencies:\n+      '@octokit/core': 5.2.1\n+      '@octokit/types': 12.6.0\n+\n+  '@octokit/request-error@5.1.1':\n+    dependencies:\n+      '@octokit/types': 13.10.0\n+      deprecation: 2.3.1\n+      once: 1.4.0\n+\n+  '@octokit/request@8.4.1':\n+    dependencies:\n+      '@octokit/endpoint': 9.0.6\n+      '@octokit/request-error': 5.1.1\n+      '@octokit/types': 13.10.0\n+      universal-user-agent: 6.0.1\n+\n+  '@octokit/types@12.6.0':\n+    dependencies:\n+      '@octokit/openapi-types': 20.0.0\n+\n+  '@octokit/types@13.10.0':\n+    dependencies:\n+      '@octokit/openapi-types': 24.2.0\n+\n   '@pkgjs/parseargs@0.11.0':\n     optional: true\n \n@@ -8513,7 +8700,7 @@ snapshots:\n   '@rollup/plugin-babel@5.3.1(@babel/core@7.26.10)(rollup@2.79.2)':\n     dependencies:\n       '@babel/core': 7.26.10\n-      '@babel/helper-module-imports': 7.25.9\n+      '@babel/helper-module-imports': 7.27.1\n       '@rollup/pluginutils': 3.1.0(rollup@2.79.2)\n       rollup: 2.79.2\n     transitivePeerDependencies:\n@@ -10026,6 +10213,8 @@ snapshots:\n \n   base64-js@1.5.1: {}\n \n+  before-after-hook@2.2.3: {}\n+\n   better-opn@3.0.2:\n     dependencies:\n       open: 8.4.2\n@@ -10605,6 +10794,8 @@ snapshots:\n \n   delayed-stream@1.0.0: {}\n \n+  deprecation@2.3.1: {}\n+\n   dequal@2.0.3: {}\n \n   detect-indent@6.1.0: {}\n@@ -13728,6 +13919,8 @@ snapshots:\n     dependencies:\n       safe-buffer: 5.2.1\n \n+  tunnel@0.0.6: {}\n+\n   tw-animate-css@1.3.0: {}\n \n   tween-functions@1.2.0: {}\n@@ -13821,6 +14014,10 @@ snapshots:\n \n   undici-types@6.21.0: {}\n \n+  undici@5.29.0:\n+    dependencies:\n+      '@fastify/busboy': 2.1.1\n+\n   unicode-canonical-property-names-ecmascript@2.0.1: {}\n \n   unicode-match-property-ecmascript@2.0.0:\n@@ -13838,6 +14035,8 @@ snapshots:\n     dependencies:\n       crypto-random-string: 2.0.0\n \n+  universal-user-agent@6.0.1: {}\n+\n   universalify@2.0.1: {}\n \n   unplugin@1.16.1:\n@@ -13886,7 +14085,7 @@ snapshots:\n     dependencies:\n       debug: 4.4.0\n       pretty-bytes: 6.1.1\n-      tinyglobby: 0.2.12\n+      tinyglobby: 0.2.13\n       vite: 5.4.17(@types/node@22.15.19)(terser@5.39.0)\n       workbox-build: 7.3.0\n       workbox-window: 7.3.0\ndiff --git a/src/app/components/GitActions.svelte b/src/app/components/GitActions.svelte\nindex d4ab776..9fce7d5 100644\n--- a/src/app/components/GitActions.svelte\n+++ b/src/app/components/GitActions.svelte\n@@ -3,14 +3,9 @@\n   import {\n     Address,\n     GIT_ISSUE,\n-    GIT_STATUS_CLOSED,\n-    GIT_STATUS_COMPLETE,\n-    GIT_STATUS_DRAFT,\n-    GIT_STATUS_OPEN,\n-    type Filter,\n     type TrustedEvent,\n   } from \"@welshman/util\"\n-  import {pubkey} from \"@welshman/app\"\n+  import {pubkey, repository} from \"@welshman/app\"\n   import ReactionSummary from \"@app/components/ReactionSummary.svelte\"\n   import ThunkStatusOrDeleted from \"@app/components/ThunkStatusOrDeleted.svelte\"\n   import EventActions from \"@app/components/EventActions.svelte\"\n@@ -18,10 +13,9 @@\n   import {makeGitPath} from \"@app/routes\"\n   import Button from \"@src/lib/components/Button.svelte\"\n   import Link from \"@src/lib/components/Link.svelte\"\n-  import {nthEq} from \"@welshman/lib\"\n-  import {onMount, tick} from \"svelte\"\n-  import {nip19} from \"nostr-tools\"\n+  import {onMount} from \"svelte\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n+  import {deriveEvents} from \"@welshman/store\"\n \n   interface Props {\n     url: any\n@@ -32,14 +26,13 @@\n \n   const {url, event, showIssues = true, showActivity}: Props = $props()\n \n-  const repoNpub = $derived(nip19.npubEncode(event.pubkey))\n-  const repoDtag = $derived(event.tags.find(nthEq(0, \"d\"))?.[1])\n-\n-  const gitworkshopLink = $derived(`https://gitworkshop.dev/${repoNpub}/${repoDtag}`)\n+  const issueFilter = {\n+    kinds: [GIT_ISSUE],\n+    \"#a\": [Address.fromEvent(event).toString()],\n+  }\n \n-  let issues: TrustedEvent[] = []\n-  const issueFilter: Filter = {kinds: [GIT_ISSUE]}\n-  let issueCount = $state(0)\n+  const issues = deriveEvents(repository, {filters: [issueFilter]})\n+  const issueCount = $derived($issues.length)\n \n   const onReactionClick = (content: string, events: TrustedEvent[]) =\u003e {\n     const reaction = events.find(e =\u003e e.pubkey === $pubkey)\n@@ -51,39 +44,11 @@\n   }\n \n   let loadingIssues = $state(false)\n-  const loadIssuesAndStatuses = async () =\u003e {\n-    loadingIssues = true\n-    await tick()\n-    const address = Address.fromEvent(event)\n-    issueFilter[\"#a\"] = [address.toString()]\n-    const [tagId, ...relays] = event.tags.find(nthEq(0, \"relays\")) || []\n-\n-    issues = await load({\n-      relays: relays,\n-      filters: [issueFilter],\n-    })\n-\n-    loadingIssues = false\n \n-    const statusFilter = [\n-      {\n-        kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n-        \"#e\": issues.map(issue =\u003e issue.id),\n-      },\n-    ]\n-\n-    issueCount = issues.length\n-\n-    // No need to await this one, justawait pre-loading\n-    const statuses = load({\n-      relays: relays,\n-      filters: statusFilter,\n-    })\n-  }\n \n   onMount(() =\u003e {\n     if (showIssues) {\n-      loadIssuesAndStatuses()\n+      load({relays: [url], filters: [issueFilter]})\n     }\n   })\n \n@@ -107,7 +72,7 @@\n           class=\"flex h-full w-full cursor-pointer items-center\"\n           href={makeGitPath(url, Address.fromEvent(event).toNaddr()) + \"/issues\"}\u003e\n           \u003cSpinner loading={loadingIssues} minHeight={\"min-h-6\"}\u003e\n-            \u003cspan class=\"\"\u003e{\"Issues (\" + issueCount + \")\"}\u003c/span\u003e\n+            {\"Issues (\" + issueCount + \")\"}\n           \u003c/Spinner\u003e\n         \u003c/Link\u003e\n       \u003c/Button\u003e\ndiff --git a/src/app/components/RepoPicker.svelte b/src/app/components/RepoPicker.svelte\nindex e19dc6a..fb344eb 100644\n--- a/src/app/components/RepoPicker.svelte\n+++ b/src/app/components/RepoPicker.svelte\n@@ -1,7 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n   import {debounce} from \"throttle-debounce\"\n   import {onMount} from \"svelte\"\n-  import { GIT_REPO_BOOKMARK_DTAG } from \"@src/lib/util\"\n+  import {GIT_REPO_BOOKMARK_DTAG} from \"@src/lib/util\"\n   import {page} from \"$app/stores\"\n   import {writable} from \"svelte/store\"\n   import {\n@@ -10,47 +10,39 @@\n     getTagValue,\n     NAMED_BOOKMARKS,\n     type Filter,\n-    type TrustedEvent\n+    type TrustedEvent,\n   } from \"@welshman/util\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n   import ModalHeader from \"@lib/components/ModalHeader.svelte\"\n   import ModalFooter from \"@lib/components/ModalFooter.svelte\"\n   import FieldInline from \"@src/lib/components/FieldInline.svelte\"\n-  import {\n-    makeFeedController,\n-    createSearch,\n-    publishThunk,\n-    repository,\n-    tracker\n-  } from \"@welshman/app\"\n-  import {\n-    feedFromFilter,\n-    makeIntersectionFeed,\n-    makeWOTFeed,\n-  } from \"@welshman/feeds\"\n+  import {makeFeedController, createSearch, publishThunk, repository, tracker} from \"@welshman/app\"\n+  import {feedFromFilter, makeIntersectionFeed, makeWOTFeed} from \"@welshman/feeds\"\n   import {sleep} from \"@welshman/lib\"\n   import {createScroller, isMobile, type Scroller} from \"@src/lib/html\"\n   import {deriveEvents} from \"@welshman/store\"\n-  import { GIT_REPO } from \"@src/lib/util\"\n-  import { preventDefault } from \"svelte/legacy\"\n-  import { decodeRelay, shouldReloadRepos } from \"../state\"\n+  import {GIT_REPO} from \"@src/lib/util\"\n+  import {preventDefault} from \"svelte/legacy\"\n+  import {decodeRelay, shouldReloadRepos} from \"../state\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n-  import { fly } from \"svelte/transition\"\n+  import {fly} from \"svelte/transition\"\n   import GitItem from \"./GitItem.svelte\"\n   import Divider from \"@src/lib/components/Divider.svelte\"\n-  import { makeGitPath } from \"../routes\"\n-  import { goto } from \"$app/navigation\"\n-    import { Router } from \"@welshman/router\"\n-\n+  import {makeGitPath} from \"../routes\"\n+  import {goto} from \"$app/navigation\"\n+  import {Router} from \"@welshman/router\"\n+  import {load} from \"@welshman/net\"\n \n   const url = decodeRelay($page.params.relay)\n-  const {selectedRepos}: {\n-    selectedRepos: Array\u003c{address: string, event: TrustedEvent, relayHint: string}\u003e\n+  const {\n+    selectedRepos,\n+  }: {\n+    selectedRepos: Array\u003c{address: string; event: TrustedEvent; relayHint: string}\u003e\n   } = $props()\n \n   let localSelectedReposState = $state([...selectedRepos])\n-  $effect(() =\u003e{\n+  $effect(() =\u003e {\n     localSelectedReposState = [...selectedRepos]\n   })\n \n@@ -71,7 +63,7 @@\n         repo: event,\n         relay: relayHint,\n         address: address,\n-        selected: true\n+        selected: true,\n       })\n     }\n \n@@ -79,23 +71,20 @@\n       const address = Address.fromEvent(event)\n       const addressStr = address.toString()\n       // Need to keep selected and unselected repos as distinct sets\n-      if (!localSelectedReposState.find(r=\u003er.address===addressStr)) {\n+      if (!localSelectedReposState.find(r =\u003e r.address === addressStr)) {\n         const relayHints = tracker.getRelays(event.id)\n-        const repoEventRelayHint = getTagValue('relays', event.tags)\n+        const repoEventRelayHint = getTagValue(\"relays\", event.tags)\n \n-        const relaysFromRepoPubkey = \n-        Router.get().getRelaysForPubkey(event.pubkey)?.[0] ?? ''\n+        const relaysFromRepoPubkey = Router.get().getRelaysForPubkey(event.pubkey)?.[0] ?? \"\"\n \n-        const firstHint = \n-          relayHints.values().next().value ??\n-            repoEventRelayHint ??\n-            relaysFromRepoPubkey\n+        const firstHint =\n+          relayHints.values().next().value ?? repoEventRelayHint ?? relaysFromRepoPubkey\n \n         elements.push({\n           repo: event,\n           relay: firstHint,\n           address: addressStr,\n-          selected: false\n+          selected: false,\n         })\n       }\n     }\n@@ -104,53 +93,44 @@\n   })\n \n   let searchTerm = $state(\"\")\n-  let debouncedTerm = $state('');\n+  let debouncedTerm = $state(\"\")\n \n   // Set up the debounced update\n-  const updateDebouncedTerm = debounce(500, (term) =\u003e {\n-    debouncedTerm = term;\n-  });\n+  const updateDebouncedTerm = debounce(500, term =\u003e {\n+    debouncedTerm = term\n+  })\n \n   // Watch searchTerm changes\n   $effect(() =\u003e {\n-    updateDebouncedTerm(searchTerm);\n-  });\n-\n+    updateDebouncedTerm(searchTerm)\n+  })\n \n-  const searchedRepos = $derived.by(()=\u003e{\n-    const reposToSearch = repos.map((r) =\u003e {\n+  const searchedRepos = $derived.by(() =\u003e {\n+    const reposToSearch = repos.map(r =\u003e {\n       return {\n         id: r.repo.id,\n-        name: getTagValue('name', r.repo.tags) ?? '',\n-        desc: getTagValue('description', r.repo.tags) ?? ''\n+        name: getTagValue(\"name\", r.repo.tags) ?? \"\",\n+        desc: getTagValue(\"description\", r.repo.tags) ?? \"\",\n       }\n     })\n     if (debouncedTerm.length \u003e 2) {\n-      const repoSearch = createSearch(\n-        reposToSearch,\n-        {\n-          getValue: (repo: {\n-            id: string,\n-            name: string,\n-            desc: string\n-          }) =\u003e repo.id,\n-          fuseOptions: {\n-            keys: [\n-              {name: \"name\", weight: 0.8}, {name: 'desc', weight: 0.2}\n-            ],\n-            includeScore: true,\n-            threshold: 0.3\n-          },\n-          sortFn: ({score, item}) =\u003e {\n-            if (score \u0026\u0026 score \u003e 0.3) return -score!\n-            return item.name\n-          }\n-        }\n-      )\n+      const repoSearch = createSearch(reposToSearch, {\n+        getValue: (repo: {id: string; name: string; desc: string}) =\u003e repo.id,\n+        fuseOptions: {\n+          keys: [\n+            {name: \"name\", weight: 0.8},\n+            {name: \"desc\", weight: 0.2},\n+          ],\n+          includeScore: true,\n+          threshold: 0.3,\n+        },\n+        sortFn: ({score, item}) =\u003e {\n+          if (score \u0026\u0026 score \u003e 0.3) return -score!\n+          return item.name\n+        },\n+      })\n       const searchResults = repoSearch.searchOptions(searchTerm)\n-      const result = repos.filter(\n-        r =\u003e searchResults.find(res =\u003e res.id === r.repo.id)\n-      )\n+      const result = repos.filter(r =\u003e searchResults.find(res =\u003e res.id === r.repo.id))\n       return result\n     } else {\n       return repos\n@@ -159,10 +139,7 @@\n \n   const ctrl = makeFeedController({\n     useWindowing: true,\n-    feed: makeIntersectionFeed(\n-      makeWOTFeed({min: 0.1}),\n-      feedFromFilter({kinds: [GIT_REPO]}),\n-    ),\n+    feed: makeIntersectionFeed(makeWOTFeed({min: 0.1}), feedFromFilter({kinds: [GIT_REPO]})),\n     onExhausted: () =\u003e {\n       loading = false\n     },\n@@ -174,21 +151,15 @@\n \n   const submit = () =\u003e {\n     if ($uploading) return\n-    const atagList:string[][] = [];\n+    const atagList: string[][] = []\n \n     for (const {address, relayHint} of localSelectedReposState) {\n-      atagList.push(['a', address, relayHint])\n+      atagList.push([\"a\", address, relayHint])\n     }\n \n-    const eventToPublish = createEvent(\n-      NAMED_BOOKMARKS,\n-      { \n-        tags: [ \n-          [\"d\", GIT_REPO_BOOKMARK_DTAG],\n-          ...atagList\n-        ] \n-      }\n-    )\n+    const eventToPublish = createEvent(NAMED_BOOKMARKS, {\n+      tags: [[\"d\", GIT_REPO_BOOKMARK_DTAG], ...atagList],\n+    })\n     console.log(\"eventToPublish\", eventToPublish)\n \n     publishThunk({\n@@ -196,12 +167,17 @@\n       relays: [url, ...Router.get().FromUser().getUrls()],\n     })\n \n-    $shouldReloadRepos = true;\n+    $shouldReloadRepos = true\n \n     goto(makeGitPath(url))\n   }\n \n   onMount(() =\u003e {\n+    const relays = [url, ...Router.get().FromUser().getUrls()];\n+    load({\n+      relays,\n+      filters,\n+    })\n     // Element is frequently not defined. I don't know why\n     sleep(1000).then(() =\u003e {\n       if (!unmounted) {\n@@ -226,12 +202,7 @@\n     }\n   })\n \n-  const onRepoChecked = (\n-    relay: string,\n-    address: string,\n-    event:TrustedEvent,\n-    checked: boolean\n-  ) =\u003e {\n+  const onRepoChecked = (relay: string, address: string, event: TrustedEvent, checked: boolean) =\u003e {\n     if (checked) {\n       localSelectedReposState.push({address, event, relayHint: relay})\n     } else {\n@@ -240,19 +211,14 @@\n   }\n \u003c/script\u003e\n \n-{#snippet repoSelectCheckBox(relay: string, address:string, repo:TrustedEvent, selected: boolean)}\n+{#snippet repoSelectCheckBox(relay: string, address: string, repo: TrustedEvent, selected: boolean)}\n   \u003cinput\n     slot=\"input\"\n     type=\"checkbox\"\n     class=\"toggle toggle-primary\"\n     checked={selected}\n-    onchange={event =\u003e onRepoChecked(\n-      relay,\n-      address,\n-      repo,\n-      (event.target as HTMLInputElement).checked\n-    )}\n-  /\u003e\n+    onchange={event =\u003e\n+      onRepoChecked(relay, address, repo, (event.target as HTMLInputElement).checked)} /\u003e\n {/snippet}\n \n \u003cform class=\"column gap-4\" onsubmit={preventDefault(submit)}\u003e\n@@ -275,18 +241,18 @@\n       placeholder=\"Search repos...\" /\u003e\n   \u003c/label\u003e\n   \u003cdiv\n-    class=\"scroll-container -mt-2 h-96 flex flex-grow flex-col overflow-auto py-2\"\n+    class=\"scroll-container -mt-2 flex h-96 flex-grow flex-col overflow-auto py-2\"\n     bind:this={element}\u003e\n     \u003cDivider\u003e\n       \u003cp\u003eSelected\u003c/p\u003e\n     \u003c/Divider\u003e\n-    {#each searchedRepos.filter((r)=\u003er.selected) as {repo, relay, address} (repo.id)}\n-      \u003cdiv out:fly=\"{{ duration: 200 }}\"\u003e\n-        \u003cGitItem {url} event={repo} showActivity={false} showActions={false}/\u003e\n+    {#each searchedRepos.filter(r =\u003e r.selected) as { repo, relay, address } (repo.id)}\n+      \u003cdiv out:fly={{duration: 200}}\u003e\n+        \u003cGitItem {url} event={repo} showActivity={false} showActions={false} /\u003e\n         \u003cdiv class=\"flex w-full justify-end\"\u003e\n           \u003cFieldInline\u003e\n             {#snippet input()}\n-              {@render repoSelectCheckBox(relay, address,repo, true)}\n+              {@render repoSelectCheckBox(relay, address, repo, true)}\n             {/snippet}\n           \u003c/FieldInline\u003e\n         \u003c/div\u003e\n@@ -295,9 +261,9 @@\n     \u003cDivider\u003e\n       \u003cp\u003eOther\u003c/p\u003e\n     \u003c/Divider\u003e\n-    {#each searchedRepos.filter((r)=\u003e!r.selected) as {repo, relay, address} (repo.id)}\n-      \u003cdiv out:fly=\"{{ duration: 200 }}\"\u003e\n-        \u003cGitItem {url} event={repo} showActivity={false} showActions={false}/\u003e\n+    {#each searchedRepos.filter(r =\u003e !r.selected) as { repo, relay, address } (repo.id)}\n+      \u003cdiv out:fly={{duration: 200}}\u003e\n+        \u003cGitItem {url} event={repo} showActivity={false} showActions={false} /\u003e\n         \u003cdiv class=\"flex w-full justify-end\"\u003e\n           \u003cFieldInline\u003e\n             {#snippet input()}\n@@ -307,12 +273,12 @@\n         \u003c/div\u003e\n       \u003c/div\u003e\n     {/each}\n-    {#if loading || $repoEvents.length === 0}\n+    {#if loading || searchedRepos.length === 0}\n       \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n         \u003cSpinner {loading}\u003e\n           {#if loading}\n             Looking for repos...\n-          {:else if $repoEvents.length === 0}\n+          {:else if searchedRepos.length === 0}\n             No Repos found.\n           {/if}\n         \u003c/Spinner\u003e\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex d064661..7b6604d 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -28,6 +28,7 @@\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n \n   const url = decodeRelay($page.params.relay)\n+\n   const mutedPubkeys = getPubkeyTagValues(getListTags($userMutes))\n   const repos: TrustedEvent[] = $state([])\n \n@@ -40,16 +41,13 @@\n     // --- Logging bookmark filter and relays ---\n     const bookmarkFilter = { kinds: [NAMED_BOOKMARKS], authors: [pubkey.get()!] };\n     const bookmarkRelays = [url, ...Router.get().FromUser().getUrls()];\n-    console.log(\"[RepoLoad] Bookmark filter:\", bookmarkFilter, \"Relays:\", bookmarkRelays);\n     let bookmark = [];\n     try {\n       bookmark = await load({\n         relays: bookmarkRelays,\n         filters: [bookmarkFilter],\n       });\n-      console.log(\"[RepoLoad] Bookmark result:\", bookmark);\n     } catch (e) {\n-      console.error(\"[RepoLoad] Bookmark load() error:\", e, \"Relays:\", bookmarkRelays, \"Filter:\", bookmarkFilter);\n       loading = false;\n       return;\n     }\n@@ -66,28 +64,25 @@\n         if (relayHint \u0026\u0026 !relayHints.includes(relayHint)) relayHints.push(relayHint)\n       })\n       const repoFilter = { kinds: [GIT_REPO], authors, \"#d\": dTagValues };\n-      console.log(\"[RepoLoad] Repo filter:\", repoFilter, \"Relay hints:\", relayHints);\n-      let loadedRepos = [];\n       try {\n-        loadedRepos = await load({\n+        await load({\n           relays: relayHints,\n           filters: [repoFilter],\n+          onEvent(event, url) {\n+            repos.push(event);\n+          },\n         });\n-        console.log(\"[RepoLoad] Loaded repos result:\", loadedRepos);\n       } catch (e) {\n-        console.error(\"[RepoLoad] Repo load() error:\", e, \"Relays:\", relayHints, \"Filter:\", repoFilter);\n         loading = false;\n         return;\n       }\n-      loadedBookmarkedRepos = loadedRepos.map(repo =\u003e {\n+      loadedBookmarkedRepos = repos.map(repo =\u003e {\n         const address = Address.fromEvent(repo)\n         const addressString = address.toString()\n         const relayHintFromEvent = Router.get().getRelaysForPubkey(repo.pubkey)?.[0]\n         const hint = relaysOfAddresses.get(addressString) ?? relayHintFromEvent\n         return {address: addressString, event: repo, relayHint: hint}\n       })\n-      loadedRepos.filter(e =\u003e !mutedPubkeys.includes(e.pubkey)).forEach(e =\u003e repos.push(e))\n-      console.log(loadedRepos)\n     }\n     loading = false\n   }\n@@ -118,12 +113,13 @@\n     \u003cdiv class=\"row-2\"\u003e\n       \u003cButton class=\"btn btn-primary btn-sm\" disabled={loading} onclick={onAddRepo}\u003e\n         \u003cIcon icon=\"git\" /\u003e\n-        \u003cspan\u003eAdd Repo\u003c/span\u003e\n+        Add Repo\n       \u003c/Button\u003e\n       \u003cMenuSpaceButton {url} /\u003e\n     \u003c/div\u003e\n   {/snippet}\n \u003c/PageBar\u003e\n+\n \u003cPageContent\u003e\n   \u003cdiv class=\"flex flex-grow flex-col gap-2 overflow-auto p-2\"\u003e\n     {#if loading || repos.length === 0}\n@@ -137,9 +133,9 @@\n         \u003c/Spinner\u003e\n       \u003c/p\u003e\n     {:else}\n-      {#each repos as event (event.id)}\n-        \u003cdiv in:fly class=\"\"\u003e\n-          \u003cGitItem {url} {event} /\u003e\n+      {#each repos as repo (repo.id)}\n+        \u003cdiv in:fly\u003e\n+          \u003cGitItem {url} event={repo} /\u003e\n         \u003c/div\u003e\n       {/each}\n     {/if}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex 5ca7d94..6751668 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -1,71 +1,69 @@\n \u003cscript lang=\"ts\"\u003e\n   import {Button, IssueCard} from \"@nostr-git/ui\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n-  import {deriveNaddrEvent} from \"@app/state\"\n   import {page} from \"$app/stores\"\n-  import {GIT_ISSUE, type TrustedEvent} from \"@welshman/util\"\n-  import {Address} from \"@welshman/util\"\n-  import {load} from \"@welshman/net\"\n-  import {onMount} from \"svelte\"\n+  import {\n+    Address,\n+    COMMENT,\n+    getListTags,\n+    getPubkeyTagValues,\n+    GIT_ISSUE,\n+    type TrustedEvent,\n+  } from \"@welshman/util\"\n+  import {getContext, onMount} from \"svelte\"\n   import {setChecked} from \"@src/app/notifications\"\n   import {nthEq} from \"@welshman/lib\"\n-  import {deriveProfile} from \"@welshman/app\"\n+  import {deriveProfile, userMutes} from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n+  import type {Readable} from \"svelte/store\"\n+  import {makeFeed} from \"@src/app/requests\"\n \n-  // Receive eventStore from layout via $props (Svelte 5 idiom)\n-  const { eventStore } = $props();\n+  const repo = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n+  const [_, ...relays] = $repo.tags.find(nthEq(0, \"relays\")) || []\n+  const mutedPubkeys = getPubkeyTagValues(getListTags($userMutes))\n \n-  const {id, relay} = $page.params\n-  const relayArray = Array.isArray(relay) ? relay : [relay]\n-  const repo = deriveNaddrEvent(id)\n-  let issues = $state([] as TrustedEvent[])\n-  let loading = $state(true)\n-  let currentPage = $state(1)\n-  const pageSize = 10\n-  const pageCount = $derived(() =\u003e Math.max(1, Math.ceil(issues.length / pageSize)))\n-  const paginatedIssues = $derived(() =\u003e\n-    issues.slice((currentPage - 1) * pageSize, currentPage * pageSize),\n-  )\n+  const issueFilter = {\n+    kinds: [GIT_ISSUE, COMMENT],\n+    \"#a\": [Address.fromEvent($repo).toString()],\n+  }\n \n-  async function loadIssues() {\n-    issues.length = 0\n-    const issueFilter = {\n-      kinds: [GIT_ISSUE],\n-      \"#a\": [Address.fromEvent($repo).toString()],\n-    }\n-    const [tagId, ...relays] = $repo.tags.find(nthEq(0, \"relays\")) || []\n+  const issues: TrustedEvent[] = $state([])\n+  const comments: TrustedEvent[] = $state([])\n+\n+  let loading = $state(true)\n+  let element: HTMLElement | undefined = $state()\n \n-    const issue = await load({\n+  onMount(() =\u003e {\n+    const {cleanup} = makeFeed({\n+      element: element!,\n       relays: relays,\n-      filters: [issueFilter],\n-    })\n-    if (issue.length \u003e 0) {\n-      issues.push(...issue)\n-    }\n-  }\n+      feedFilters: [issueFilter],\n+      subscriptionFilters: [issueFilter],\n+      initialEvents: [],\n+      onEvent: event =\u003e {\n+        if (event.kind === GIT_ISSUE \u0026\u0026 !mutedPubkeys.includes(event.pubkey)) {\n+          issues.push(event)\n+        }\n \n-  async function loadIssuesWrapper() {\n-    loading = true\n-    await loadIssues()\n-    loading = false\n-  }\n+        if (event.kind === COMMENT \u0026\u0026 !mutedPubkeys.includes(event.pubkey)) {\n+          comments.push(event)\n+        }\n+      },\n+      onExhausted: () =\u003e {\n+        loading = false\n+      },\n+    })\n \n-  onMount(() =\u003e {\n-    loadIssuesWrapper()\n-    return () =\u003e setChecked($page.url.pathname)\n+    return () =\u003e {\n+      cleanup()\n+      setChecked($page.url.pathname)\n+    }\n   })\n-\n-  function prevPage() {\n-    if (currentPage \u003e 1) currentPage = currentPage - 1\n-  }\n-  function nextPage() {\n-    if (currentPage \u003c pageCount()) currentPage = currentPage + 1\n-  }\n \u003c/script\u003e\n \n-\u003cdiv\u003e\n+\u003cdiv bind:this={element}\u003e\n   \u003cdiv\n-    class=\"z-10 sticky top-0 mb-4 flex items-center justify-between bg-background/95 py-4 backdrop-blur supports-[backdrop-filter]:bg-background/60\"\u003e\n+    class=\"z-10 sticky top-0 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003eIssues\u003c/h2\u003e\n       \u003cp class=\"text-sm text-muted-foreground\"\u003eTrack bugs and feature requests\u003c/p\u003e\n@@ -100,23 +98,10 @@\n       No issues found.\n     \u003c/div\u003e\n   {:else}\n-    \u003cdiv class=\"flex max-h-[32rem] flex-col gap-y-4 overflow-y-auto rounded-md bg-background p-2\"\u003e\n-      {#each paginatedIssues() as issue}\n+    \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n+      {#each issues as issue (issue.id)}\n         \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey, relayArray)} /\u003e\n       {/each}\n     \u003c/div\u003e\n-    \u003cdiv class=\"mt-4 flex items-center justify-center gap-4\"\u003e\n-      \u003cbutton\n-        onclick={prevPage}\n-        class=\"rounded bg-gray-100 px-3 py-1 hover:bg-gray-200 disabled:opacity-50\"\n-        disabled={currentPage === 1}\u003e\u0026larr; Prev\u003c/button\u003e\n-      \u003cspan class=\"text-gray-600\"\u003ePage {currentPage} of {pageCount()}\u003c/span\u003e\n-      \u003cbutton\n-        onclick={nextPage}\n-        class=\"rounded bg-gray-100 px-3 py-1 hover:bg-gray-200 disabled:opacity-50\"\n-        disabled={currentPage === pageCount()}\u003e\n-        Next \u0026rarr;\n-      \u003c/button\u003e\n-    \u003c/div\u003e\n   {/if}\n \u003c/div\u003e\ndiff --git a/vite.config.ts b/vite.config.ts\nindex 67ca659..b10a730 100644\n--- a/vite.config.ts\n+++ b/vite.config.ts\n@@ -1,4 +1,5 @@\n import {config} from \"dotenv\"\n+import path from \"path\"\n import {defineConfig} from \"vite\"\n import {SvelteKitPWA} from \"@vite-pwa/sveltekit\"\n import {sveltekit} from \"@sveltejs/kit/vite\"\n@@ -10,6 +11,13 @@ config({path: \".env.template\"})\n export default defineConfig({\n   server: {\n     port: 1847,\n+    // local serving of package files\n+    fs: {\n+      allow: [\n+        '.',\n+        path.resolve(__dirname, '../'),\n+      ]\n+    }\n   },\n   build: {\n     sourcemap: true,\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-6sv0ppgt","title":"From e9e842900d84be34268374b173c60c74599d4776 Mon Sep 17 00:00:00 2001","description":"From e9e842900d84be34268374b173c60c74599d4776 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 30 Nov 2025 20:32:05 +0500\nSubject: [PATCH 9/13] chore: Route Git-related Nostr URIs to BudaBit instead of Coracle\n\n---\n src/app/util/routes.ts | 91 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n 1 file changed, 91 insertions(+)\n\ndiff --git a/src/app/util/routes.ts b/src/app/util/routes.ts\nindex acc7818..018e107 100644\n--- a/src/app/util/routes.ts\n+++ b/src/app/util/routes.ts\n@@ -15,6 +15,7 @@ import {\n   ZAP_GOAL,\n   EVENT_TIME,\n   getPubkeyTagValues,\n+  Address,\n } from \"@welshman/util\"\n import {\n   ensureUnwrapped,\n@@ -25,6 +26,40 @@ import {\n   userRoomsByUrl,\n   ROOM,\n } from \"@app/core/state\"\n+import {\n+  GIT_REPO_ANNOUNCEMENT,\n+  GIT_REPO_STATE,\n+  GIT_PATCH,\n+  GIT_PULL_REQUEST,\n+  GIT_PULL_REQUEST_UPDATE,\n+  GIT_ISSUE,\n+  GIT_COMMENT,\n+  GIT_PERMALINK,\n+  GIT_STATUS_OPEN,\n+  GIT_STATUS_APPLIED,\n+  GIT_STATUS_CLOSED,\n+  GIT_STATUS_DRAFT,\n+} from \"@nostr-git/shared-types\"\n+\n+// Repository event kinds (use Address directly)\n+const GIT_REPO_KINDS = [GIT_REPO_ANNOUNCEMENT, GIT_REPO_STATE]\n+\n+// Collaboration event kinds (reference repository via 'a' tag)\n+const GIT_COLLABORATION_KINDS = [\n+  GIT_PATCH,\n+  GIT_PULL_REQUEST,\n+  GIT_PULL_REQUEST_UPDATE,\n+  GIT_ISSUE,\n+  GIT_COMMENT,\n+  GIT_PERMALINK,\n+  GIT_STATUS_OPEN,\n+  GIT_STATUS_APPLIED,\n+  GIT_STATUS_CLOSED,\n+  GIT_STATUS_DRAFT,\n+]\n+\n+// All Git event kinds handled by BudaBit\n+const GIT_EVENT_KINDS = [...GIT_REPO_KINDS, ...GIT_COLLABORATION_KINDS]\n \n export const makeSpacePath = (url: string, ...extra: (string | undefined)[]) =\u003e {\n   let path = `/spaces/${encodeRelay(url)}`\n@@ -100,6 +135,62 @@ export const getEventPath = async (event: TrustedEvent, urls: string[]) =\u003e {\n \n   const room = getTagValue(ROOM, event.tags)\n \n+  // Handle Git-related events - route them to BudaBit's internal Git pages\n+  if (GIT_EVENT_KINDS.includes(event.kind)) {\n+    // For repository announcements (30617) and state (30618), use naddr\n+    if (GIT_REPO_KINDS.includes(event.kind)) {\n+      const address = Address.fromEvent(event)\n+      const naddr = address.toNaddr()\n+      const url = urls.length \u003e 0 ? urls[0] : \"\"\n+\n+      if (url) {\n+        return `/spaces/${encodeRelay(url)}/git/${naddr}`\n+      }\n+    }\n+\n+    // For patches, pull requests, issues, comments, and status events\n+    // These reference a repository via 'a' tag\n+    if (GIT_COLLABORATION_KINDS.includes(event.kind)) {\n+      // Get the repository address from 'a' tag\n+      const repoAddress = getTagValue(\"a\", event.tags)\n+\n+      if (repoAddress) {\n+        try {\n+          // Parse the coordinate to get pubkey and identifier\n+          const [kind, pubkey, identifier] = repoAddress.split(\":\")\n+\n+          if (pubkey \u0026\u0026 identifier) {\n+            // Create naddr for the repository\n+            const address = new Address(parseInt(kind), pubkey, identifier, urls)\n+            const naddr = address.toNaddr()\n+            const url = urls.length \u003e 0 ? urls[0] : \"\"\n+\n+            if (url) {\n+              // Route to specific sub-pages based on event kind\n+              if (\n+                event.kind === GIT_PATCH ||\n+                event.kind === GIT_PULL_REQUEST ||\n+                event.kind === GIT_PULL_REQUEST_UPDATE\n+              ) {\n+                return `/spaces/${encodeRelay(url)}/git/${naddr}/patches/${event.id}`\n+              }\n+\n+              if (event.kind === GIT_ISSUE) {\n+                return `/spaces/${encodeRelay(url)}/git/${naddr}/issues/${event.id}`\n+              }\n+\n+              // Comments and status events go to the feed view of the repository\n+              return `/spaces/${encodeRelay(url)}/git/${naddr}/feed`\n+            }\n+          }\n+        } catch (e) {\n+          // If parsing fails, fall through to default handling\n+          console.error(\"Failed to parse repository address for Git event:\", e)\n+        }\n+      }\n+    }\n+  }\n+\n   if (urls.length \u003e 0) {\n     const url = urls[0]\n \n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-6wufd36j","title":"From 93943d6b3a98c65ff22400726db80fad5abb40bc Mon Sep 17 00:00:00 2001","description":"From 93943d6b3a98c65ff22400726db80fad5abb40bc Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Wed, 4 Jun 2025 20:19:29 -0700\nSubject: [PATCH 18/67] Show socket status on space dashboard\n\n---\n src/app/state.ts                          | 23 +++++++++++++++++++++--\n src/lib/components/StatusIndicator.svelte | 15 +++++++++++++++\n src/routes/spaces/[relay]/+page.svelte    |  4 ++++\n 3 files changed, 40 insertions(+), 2 deletions(-)\n create mode 100644 src/lib/components/StatusIndicator.svelte\n\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 762ffa9..68bbf38 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -2,6 +2,8 @@ import twColors from \"tailwindcss/colors\"\n import {get, derived, writable} from \"svelte/store\"\n import {nip19} from \"nostr-tools\"\n import {\n+  on,\n+  call,\n   remove,\n   uniqBy,\n   sortBy,\n@@ -19,8 +21,9 @@ import {\n   groupBy,\n   always,\n } from \"@welshman/lib\"\n-import {load} from \"@welshman/net\"\n-import {collection} from \"@welshman/store\"\n+import type {Socket} from \"@welshman/net\"\n+import {Pool, load, AuthStateEvent, SocketEvent} from \"@welshman/net\"\n+import {collection, custom} from \"@welshman/store\"\n import {\n   getIdFilters,\n   WRAP,\n@@ -715,3 +718,19 @@ export const displayReaction = (content: string) =\u003e {\n }\n \n export const shouldReloadRepos = writable(false)\n+\n+export const deriveSocket = (url: string) =\u003e\n+  custom\u003cSocket\u003e(set =\u003e {\n+    const pool = Pool.get()\n+    const socket = pool.get(url)\n+\n+    set(socket)\n+\n+    const subs = [\n+      on(socket, SocketEvent.Error, () =\u003e set(socket)),\n+      on(socket, SocketEvent.Status, () =\u003e set(socket)),\n+      on(socket.auth, AuthStateEvent.Status, () =\u003e set(socket)),\n+    ]\n+\n+    return () =\u003e subs.forEach(call)\n+  })\ndiff --git a/src/lib/components/StatusIndicator.svelte b/src/lib/components/StatusIndicator.svelte\nnew file mode 100644\nindex 0000000..7dec323\n--- /dev/null\n+++ b/src/lib/components/StatusIndicator.svelte\n@@ -0,0 +1,15 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import type {Snippet} from \"svelte\"\n+\n+  type Props = {\n+    children: Snippet\n+    class: string\n+  }\n+\n+  const {children, ...props}: Props = $props()\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"flex items-center gap-2\"\u003e\n+  \u003cdiv class=\"h-2 w-2 rounded-full {props.class}\"\u003e\u003c/div\u003e\n+  \u003cspan class=\"text-sm\"\u003e{@render children()}\u003c/span\u003e\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/+page.svelte b/src/routes/spaces/[relay]/+page.svelte\nindex 06003f5..93c9e7d 100644\n--- a/src/routes/spaces/[relay]/+page.svelte\n+++ b/src/routes/spaces/[relay]/+page.svelte\n@@ -2,12 +2,14 @@\n   import {page} from \"$app/stores\"\n   import {displayRelayUrl} from \"@welshman/util\"\n   import {deriveRelay} from \"@welshman/app\"\n+  import {AuthStatus, SocketStatus} from \"@welshman/net\"\n   import {fade} from \"@lib/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Link from \"@lib/components/Link.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n   import PageBar from \"@lib/components/PageBar.svelte\"\n   import PageContent from \"@lib/components/PageContent.svelte\"\n+  import StatusIndicator from \"@lib/components/StatusIndicator.svelte\"\n   import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n   import ChannelName from \"@app/components/ChannelName.svelte\"\n   import SpaceJoin from \"@app/components/SpaceJoin.svelte\"\n@@ -22,6 +24,7 @@\n     deriveUserRooms,\n     deriveOtherRooms,\n     userRoomsByUrl,\n+    deriveSocket,\n   } from \"@app/state\"\n   import {\n     makeChatPath,\n@@ -35,6 +38,7 @@\n \n   const url = decodeRelay($page.params.relay)\n   const relay = deriveRelay(url)\n+  const socket = deriveSocket(url)\n   const userRooms = deriveUserRooms(url)\n   const otherRooms = deriveOtherRooms(url)\n   const threadsPath = makeThreadPath(url)\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-70tj0x1p","title":"Filters don't work in issue and patch pages","description":"After the latest changes in loading issues and patches, none of the filtering or search mechanisms work in issue and patch pages","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue","issues","patches","v1"]}
{"id":"flotilla-71ay6t09","title":"From c4a629f1a0b2a11ccd58415ae5c34e08410f09af Mon Sep 17 00:00:00 2001","description":"From c4a629f1a0b2a11ccd58415ae5c34e08410f09af Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sat, 27 Dec 2025 14:39:37 +0500\nSubject: [PATCH 1/3] chore: update nostr-git submodule\n\n---\n packages/nostr-git | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 5e133cc..2d22f18 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 5e133cc7b6f9ad279d1163b5698900cff3090c64\n+Subproject commit 2d22f18c02136c8facb40bab6bde2f89f66b7792\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-71e3utsx","title":"From d97fb7557c64df986f64a5768e0dd99251f5a288 Mon Sep 17 00:00:00 2001","description":"From d97fb7557c64df986f64a5768e0dd99251f5a288 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Tue, 18 Nov 2025 12:20:34 +0500\nSubject: [PATCH] feat: improve patch detail page markdown rendering and mobile responsiveness\n\n- Add markdown preprocessing utility to handle escaped newlines\n  - Create preprocessMarkdown() function in util.ts to convert literal \\n to actual newlines\n  - Enables proper rendering of markdown content with escaped line breaks\n\n- Enhance markdown styling in app.css\n  - Add .markdown-content styles for better code block handling\n  - Implement word-break and overflow-wrap for inline code\n  - Add proper overflow handling for pre blocks\n  - Ensure code blocks maintain proper whitespace\n\n- Improve patch detail page UI/UX\n  - Enable markdown breaks option for better line break rendering\n  - Add title truncation with ellipsis for long patch titles\n  - Replace @nostr-git/ui Profile component with local Profile component\n  - Apply prose classes for better markdown typography\n\n- Enhance mobile responsiveness\n  - Convert fixed layouts to responsive flex/grid layouts\n  - Add mobile-first breakpoints (sm:) throughout the page\n  - Improve navigation controls for mobile (hide text labels, show icons)\n  - Make commit hash and branch names break properly on small screens\n  - Adjust padding and spacing for mobile devices\n  - Improve stats display with responsive text sizes\n  - Better handling of long titles and metadata on mobile\n\n- Code quality improvements\n  - Remove unused Profile import from @nostr-git/ui\n  - Add proper title attributes for truncated text\n  - Improve code block display with break-all for long hashes\n  - Better spacing and layout consistency\n\n- Update nostr-git submodule to latest version\n---\n packages/nostr-git                                                      |   2 +-\n src/app.css                                                             |  17 +++++++++++++++++\n src/lib/util.ts                                                         |  11 +++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           |   3 ++-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 131 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------------------------\n 5 files changed, 112 insertions(+), 52 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 354e1f7..0fe578d 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 354e1f77df3e063abffe5b43406afa9e432e272f\n+Subproject commit 0fe578dc69ad7b427f8f2aac15bd3b20a1d46876\ndiff --git a/src/app.css b/src/app.css\nindex 4d9a6ba..44f1bc1 100644\n--- a/src/app.css\n+++ b/src/app.css\n@@ -402,3 +402,20 @@ progress[value]::-webkit-progress-value {\n .chat__scroll-down {\n   @apply fixed bottom-28 right-4 md:bottom-16;\n }\n+\n+/* markdown content */\n+\n+.markdown-content :not(pre) \u003e code {\n+  word-break: break-all;\n+  overflow-wrap: anywhere;\n+  white-space: pre-wrap;\n+}\n+\n+.markdown-content pre {\n+  overflow-x: auto;\n+  max-width: 100%;\n+}\n+\n+.markdown-content pre code {\n+  white-space: pre;\n+}\ndiff --git a/src/lib/util.ts b/src/lib/util.ts\nindex f35952f..93a4957 100644\n--- a/src/lib/util.ts\n+++ b/src/lib/util.ts\n@@ -16,3 +16,14 @@ export const day = (seconds: number) =\u003e Math.floor(seconds / DAY)\n export const daysBetween = (start: number, end: number) =\u003e [...range(start, end, DAY)].map(day)\n \n export const ucFirst = (s: string) =\u003e s.slice(0, 1).toUpperCase() + s.slice(1)\n+\n+/**\n+ * Preprocess markdown text to convert literal \\n to actual newlines.\n+ * This is useful when markdown content contains escaped newline characters\n+ * that should be rendered as line breaks.\n+ */\n+export const preprocessMarkdown = (text: string): string =\u003e {\n+  if (!text) return \"\"\n+  // Convert literal \\n (escaped newlines) to actual newlines\n+  return text.replace(/\\\\n/g, \"\\n\")\n+}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex f8dcf60..b97bd36 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -335,7 +335,8 @@\n                 statusEvents={$statusEventsByRoot?.get(patch.id) || []}\n                 actorPubkey={$pubkey}\n                 {onCommentCreated}\n-                reviewersCount={$roleAssignments?.get(patch.id)?.reviewers?.size || 0} /\u003e\n+                reviewersCount={$roleAssignments?.get(patch.id)?.reviewers?.size || 0} \n+              /\u003e\n               {#if labelsByPatch.get(patch.id)?.length}\n                 \u003cdiv class=\"mt-2 flex flex-wrap gap-2 text-xs\"\u003e\n                   {#if patch.groups.Status.length}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex bd9cfd8..4005f8d 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -17,7 +17,7 @@\n     User,\n     X,\n   } from \"@lucide/svelte\"\n-  import {Button, Profile, MergeStatus, toast, Status} from \"@nostr-git/ui\"\n+  import {Button, MergeStatus, toast, Status} from \"@nostr-git/ui\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import {DiffViewer, IssueThread, MergeAnalyzer} from \"@nostr-git/ui\"\n   import {pubkey, repository} from \"@welshman/app\"\n@@ -55,6 +55,8 @@\n   import {normalizeRelayUrl} from \"@welshman/util\"\n   import {profilesByPubkey, profileSearch, loadProfile} from \"@welshman/app\"\n   import {deriveRoleAssignments} from \"@lib/budabit\"\n+  import Profile from \"@src/app/components/Profile.svelte\"\n+  import {preprocessMarkdown} from \"@lib/util\"\n \n   const {data}: LayoutProps = $props()\n   const {repoClass, repoRelays} = data\n@@ -120,6 +122,8 @@\n   const patchEvent = repoClass.patches.find(p =\u003e p.id === patchId)\n   const patch = patchEvent ? parseGitPatchFromEvent(patchEvent) : undefined\n \n+  console.log(\"patch\", patch)\n+\n   let rootPatchId = patchId\n   let currentPatch = patchEvent as PatchEvent | null\n   while (currentPatch) {\n@@ -407,6 +411,7 @@\n     html: true,\n     linkify: true,\n     typographer: true,\n+    breaks: true, // Convert line breaks to \u003cbr\u003e tags\n   })\n \n   // Merge state management\n@@ -659,6 +664,25 @@\n       })\n     }\n   }\n+\n+  // Limit title to a maximum number of characters\n+  const getTitleDisplay = (title: string | undefined, maxLength: number = 80): string =\u003e {\n+    if (!title) return \"\"\n+    \n+    if (title.length \u003c= maxLength) {\n+      return title\n+    }\n+    \n+    // Truncate and add ellipsis\n+    return title.substring(0, maxLength).trim() + \"...\"\n+  }\n+\n+  const displayTitle = $derived(getTitleDisplay(patch?.title))\n+  const selectedPatchDisplayTitle = $derived(\n+    selectedPatch?.title \n+      ? getTitleDisplay(selectedPatch.title) \n+      : `Patch ${selectedPatch?.id || \"\"}`\n+  )\n \u003c/script\u003e\n \n \u003csvelte:head\u003e\n@@ -668,8 +692,8 @@\n {#if patch}\n   \u003cdiv class=\"z-10 sticky top-0 items-center justify-between py-4 backdrop-blur\"\u003e\n     \u003cdiv\u003e\n-      \u003cdiv class=\"rounded-lg border border-border bg-card p-6\"\u003e\n-        \u003cdiv class=\"mb-4 flex items-start justify-between\"\u003e\n+      \u003cdiv class=\"rounded-lg border border-border bg-card p-4 sm:p-6\"\u003e\n+        \u003cdiv class=\"mb-4 flex flex-col items-start justify-between gap-2\"\u003e\n           \u003cdiv class=\"flex items-start gap-4\"\u003e\n             {#if status?.status === \"open\"}\n               \u003cdiv class=\"mt-1\"\u003e\n@@ -693,30 +717,33 @@\n               \u003c/div\u003e\n             {/if}\n \n-            \u003cdiv\u003e\n-              \u003ch1 class=\"break-words text-2xl font-bold\"\u003e{patch?.title}\u003c/h1\u003e\n+            \u003ch1 \n+              class=\"line-clamp-2 break-words text-lg md:text-2xl font-bold overflow-hidden\"\n+              title={patch?.title}\n+            \u003e\n+              {displayTitle}\n+            \u003c/h1\u003e\n+          \u003c/div\u003e\n \n-              \u003cdiv class=\"mt-1 flex items-center gap-2\"\u003e\n-                \u003cdiv class=\"git-tag bg-secondary\"\u003e\n-                  {status?.status === \"open\"\n-                    ? \"Open\"\n-                    : status?.status === \"applied\"\n-                      ? \"Applied\"\n-                      : \"Closed\"}\n-                \u003c/div\u003e\n-                \u003cspan class=\"text-sm text-muted-foreground\"\u003e\n-                  \u003cProfileLink pubkey={patch?.author.pubkey} /\u003e\n-                  opened this patch • {formatTimestamp(patch?.createdAt || \"\")}\n-                \u003c/span\u003e\n+          \u003cdiv class=\"mt-1 flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-1\"\u003e\n+              \u003cdiv class=\"git-tag bg-secondary w-fit\"\u003e\n+                {status?.status === \"open\"\n+                  ? \"Open\"\n+                  : status?.status === \"applied\"\n+                    ? \"Applied\"\n+                    : \"Closed\"}\n+              \u003c/div\u003e\n+              \u003cdiv class=\"text-xs sm:text-sm text-muted-foreground flex items-center flex-wrap gap-x-1\"\u003e\n+                \u003cProfile pubkey={patch?.author.pubkey} hideDetails={true}\u003e\u003c/Profile\u003e\n+                \u003cProfileLink pubkey={patch?.author.pubkey} /\u003e\n+                \u003cspan class=\"hidden sm:inline\"\u003e•\u003c/span\u003e\n+                \u003cspan\u003e{formatTimestamp(patch?.createdAt || \"\")}\u003c/span\u003e\n               \u003c/div\u003e\n-            \u003c/div\u003e\n           \u003c/div\u003e\n-\n-          \u003cProfile pubkey={patch.author.pubkey} hideDetails={true}\u003e\u003c/Profile\u003e\n         \u003c/div\u003e\n \n-        \u003cdiv class=\"mb-6\"\u003e\n-          \u003cp class=\"text-muted-foreground\"\u003e{@html md.render(patch?.description || \"\")}\u003c/p\u003e\n+        \u003cdiv class=\"mb-6 prose prose-sm dark:prose-invert max-w-none text-muted-foreground markdown-content\"\u003e\n+          {@html md.render(preprocessMarkdown(patch?.description || \"\"))}\n         \u003c/div\u003e\n \n         \u003c!-- Technical Metadata --\u003e\n@@ -729,16 +756,16 @@\n           \u003cdiv class=\"grid grid-cols-1 gap-4 text-sm md:grid-cols-2\"\u003e\n             \u003c!-- Commit Hash --\u003e\n             {#if selectedPatch?.commitHash}\n-              \u003cdiv class=\"flex items-center justify-between\"\u003e\n+              \u003cdiv class=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\"\u003e\n                 \u003cspan class=\"text-muted-foreground\"\u003eCommit:\u003c/span\u003e\n                 \u003cdiv class=\"flex items-center gap-2\"\u003e\n-                  \u003ccode class=\"rounded bg-background px-2 py-1 font-mono text-xs\"\u003e\n+                  \u003ccode class=\"rounded bg-background px-2 py-1 font-mono text-xs break-all\"\u003e\n                     {selectedPatch.commitHash.substring(0, 8)}\n                   \u003c/code\u003e\n                   \u003cButton\n                     variant=\"ghost\"\n                     size=\"icon\"\n-                    class=\"h-6 w-6\"\n+                    class=\"h-6 w-6 flex-shrink-0\"\n                     onclick={() =\u003e copyToClipboard(selectedPatch?.commitHash || \"\", \"Commit hash\")}\u003e\n                     \u003cCopy class=\"h-3 w-3\" /\u003e\n                   \u003c/Button\u003e\n@@ -778,9 +805,9 @@\n             {/if}\n \n             \u003c!-- Base Branch --\u003e\n-            \u003cdiv class=\"flex items-center justify-between\"\u003e\n+            \u003cdiv class=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\"\u003e\n               \u003cspan class=\"text-muted-foreground\"\u003eTarget Branch:\u003c/span\u003e\n-              \u003ccode class=\"rounded bg-background px-2 py-1 text-xs\"\u003e\n+              \u003ccode class=\"rounded bg-background px-2 py-1 text-xs break-all sm:break-normal\"\u003e\n                 {selectedPatch?.baseBranch || repoClass.mainBranch || \"-\"}\n               \u003c/code\u003e\n             \u003c/div\u003e\n@@ -795,9 +822,9 @@\n             {#if selectedPatch?.raw?.tags \u0026\u0026 selectedPatch.raw.tags.filter(t =\u003e t[0] === \"p\").length \u003e 0}\n               {@const recipients = selectedPatch.raw.tags.filter(t =\u003e t[0] === \"p\")}\n               \u003cdiv class=\"col-span-full\"\u003e\n-                \u003cdiv class=\"flex items-start justify-between\"\u003e\n+                \u003cdiv class=\"flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between\"\u003e\n                   \u003cspan class=\"text-muted-foreground\"\u003eReviewers:\u003c/span\u003e\n-                  \u003cdiv class=\"flex max-w-xs flex-wrap gap-1\"\u003e\n+                  \u003cdiv class=\"flex flex-wrap gap-1 sm:max-w-xs\"\u003e\n                     {#each recipients.slice(0, 3) as recipient}\n                       \u003cProfileLink pubkey={recipient[1]} /\u003e\n                     {/each}\n@@ -934,20 +961,20 @@\n                 {added: 0, removed: 0},\n               )}\n \n-              \u003cdiv class=\"mb-4 grid grid-cols-1 gap-4 md:grid-cols-3\"\u003e\n+              \u003cdiv class=\"mb-4 grid grid-cols-1 gap-3 sm:grid-cols-3 sm:gap-4\"\u003e\n                 \u003cdiv class=\"rounded-lg border bg-muted/20 p-3 text-center\"\u003e\n-                  \u003cdiv class=\"text-2xl font-bold text-primary\"\u003e{selectedPatch.diff.length}\u003c/div\u003e\n-                  \u003cdiv class=\"text-sm text-muted-foreground\"\u003eFiles Changed\u003c/div\u003e\n+                  \u003cdiv class=\"text-xl sm:text-2xl font-bold text-primary\"\u003e{selectedPatch.diff.length}\u003c/div\u003e\n+                  \u003cdiv class=\"text-xs sm:text-sm text-muted-foreground\"\u003eFiles Changed\u003c/div\u003e\n                 \u003c/div\u003e\n \n                 \u003cdiv class=\"rounded-lg border bg-green-50 p-3 text-center dark:bg-green-950/20\"\u003e\n-                  \u003cdiv class=\"text-2xl font-bold text-green-600\"\u003e+{stats.added}\u003c/div\u003e\n-                  \u003cdiv class=\"text-sm text-muted-foreground\"\u003eLines Added\u003c/div\u003e\n+                  \u003cdiv class=\"text-xl sm:text-2xl font-bold text-green-600\"\u003e+{stats.added}\u003c/div\u003e\n+                  \u003cdiv class=\"text-xs sm:text-sm text-muted-foreground\"\u003eLines Added\u003c/div\u003e\n                 \u003c/div\u003e\n \n                 \u003cdiv class=\"rounded-lg border bg-red-50 p-3 text-center dark:bg-red-950/20\"\u003e\n-                  \u003cdiv class=\"text-2xl font-bold text-red-600\"\u003e-{stats.removed}\u003c/div\u003e\n-                  \u003cdiv class=\"text-sm text-muted-foreground\"\u003eLines Removed\u003c/div\u003e\n+                  \u003cdiv class=\"text-xl sm:text-2xl font-bold text-red-600\"\u003e-{stats.removed}\u003c/div\u003e\n+                  \u003cdiv class=\"text-xs sm:text-sm text-muted-foreground\"\u003eLines Removed\u003c/div\u003e\n                 \u003c/div\u003e\n               \u003c/div\u003e\n             {/if}\n@@ -1055,7 +1082,7 @@\n \n         \u003cdiv class=\"git-separator\"\u003e\u003c/div\u003e\n \n-        \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n+        \u003cdiv class=\"mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\"\u003e\n           \u003ch2 class=\"text-lg font-medium\"\u003eChanges\u003c/h2\u003e\n \n           \u003c!-- Navigation Controls --\u003e\n@@ -1075,11 +1102,11 @@\n                       selectedPatch = patchSet[currentIndex - 1]\n                     }\n                   }}\u003e\n-                  \u003cChevronLeft class=\"mr-1 h-4 w-4\" /\u003e\n-                  Previous\n+                  \u003cChevronLeft class=\"h-4 w-4 sm:mr-1\" /\u003e\n+                  \u003cspan class=\"hidden sm:inline\"\u003ePrevious\u003c/span\u003e\n                 \u003c/Button\u003e\n \n-                \u003cspan class=\"text-sm text-muted-foreground\"\u003e\n+                \u003cspan class=\"text-xs sm:text-sm text-muted-foreground whitespace-nowrap\"\u003e\n                   {currentIndex + 1} of {patchSet.length}\n                 \u003c/span\u003e\n \n@@ -1092,8 +1119,8 @@\n                       selectedPatch = patchSet[currentIndex + 1]\n                     }\n                   }}\u003e\n-                  Next\n-                  \u003cChevronRight class=\"ml-1 h-4 w-4\" /\u003e\n+                  \u003cspan class=\"hidden sm:inline\"\u003eNext\u003c/span\u003e\n+                  \u003cChevronRight class=\"h-4 w-4 sm:ml-1\" /\u003e\n                 \u003c/Button\u003e\n               {/key}\n             \u003c/div\u003e\n@@ -1110,19 +1137,21 @@\n                   \u003cdiv class=\"flex-shrink-0\"\u003e\n                     \u003cGitCommit class=\"h-5 w-5 text-primary\" /\u003e\n                   \u003c/div\u003e\n-                  \u003cdiv class=\"flex-grow\"\u003e\n-                    \u003cdiv class=\"break-words font-semibold\"\u003e\n-                      {selectedPatch.title || `Patch ${selectedPatch.id}`}\n+                  \u003cdiv class=\"flex-grow min-w-0\"\u003e\n+                    \u003cdiv \n+                      class=\"line-clamp-2 break-words font-semibold overflow-hidden\"\n+                      title={selectedPatch.title || `Patch ${selectedPatch.id}`}\u003e\n+                      {selectedPatchDisplayTitle}\n                     \u003c/div\u003e\n-                    \u003cdiv class=\"flex items-center gap-2 text-sm text-muted-foreground\"\u003e\n+                    \u003cdiv class=\"flex flex-wrap items-center gap-x-2 gap-y-1 text-xs sm:text-sm text-muted-foreground\"\u003e\n                       \u003cspan\n                         \u003e{selectedPatch.author.name ||\n                           selectedPatch.author.pubkey.slice(0, 8)}\u003c/span\u003e\n-                      \u003cspan\u003e•\u003c/span\u003e\n-                      \u003cspan\u003e{new Date(selectedPatch.createdAt).toLocaleString()}\u003c/span\u003e\n+                      \u003cspan class=\"hidden sm:inline\"\u003e•\u003c/span\u003e\n+                      \u003cspan class=\"break-words\"\u003e{new Date(selectedPatch.createdAt).toLocaleString()}\u003c/span\u003e\n                       {#if selectedPatch.commitHash}\n-                        \u003cspan\u003e•\u003c/span\u003e\n-                        \u003cspan\u003e{selectedPatch.commitHash.slice(0, 8)}\u003c/span\u003e\n+                        \u003cspan class=\"hidden sm:inline\"\u003e•\u003c/span\u003e\n+                        \u003cspan class=\"font-mono\"\u003e{selectedPatch.commitHash.slice(0, 8)}\u003c/span\u003e\n                       {/if}\n                     \u003c/div\u003e\n                   \u003c/div\u003e\n@@ -1147,6 +1176,7 @@\n             \u003c/div\u003e\n           {/key}\n         \u003c/div\u003e\n+        \n         {#if repoClass.maintainers.includes($pubkey!)}\n           \u003c!-- GitHub-style Merge Section --\u003e\n           \u003cdiv class=\"rounded-lg border bg-card p-6\"\u003e\n@@ -1296,6 +1326,7 @@\n             \u003c/div\u003e\n           \u003c/div\u003e\n         {/if}\n+        \n         \u003c!-- Merge Confirmation Dialog --\u003e\n         {#if showMergeDialog}\n           \u003cdiv\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-735bgrwd","title":"Grasp: Introduce feature switch","description":"Better to handle this with care, it is very experimental yet","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T18:05:14.8085-08:00","closed_at":"2026-01-24T18:05:14.8085-08:00","close_reason":"Verified implemented via codebase triage","labels":["enhancement","grasp","issue"]}
{"id":"flotilla-74g4fd7a","title":"From 369b9dcd97ad33c92bc861cfa30850ff5fa5df98 Mon Sep 17 00:00:00 2001","description":"From 369b9dcd97ad33c92bc861cfa30850ff5fa5df98 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 16 Nov 2025 22:13:20 +0500\nSubject: [PATCH] fix(access-token): remove access token based on host and token its self not just host\n\n---\n src/app/components/GitAuth.svelte | 7 ++++---\n 1 file changed, 4 insertions(+), 3 deletions(-)\n\ndiff --git a/src/app/components/GitAuth.svelte b/src/app/components/GitAuth.svelte\nindex efa1cf7..662fcbc 100644\n--- a/src/app/components/GitAuth.svelte\n+++ b/src/app/components/GitAuth.svelte\n@@ -58,8 +58,9 @@\n     tokens = $tokensStore\n   })\n \n-  function del(h: string) {\n-    const updatedTokens = tokens.filter(t =\u003e t.host !== h)\n+  function del(tokenToDelete: TokenEntry) {\n+    // Match both host AND token to uniquely identify the token to delete\n+    const updatedTokens = tokens.filter(t =\u003e !(t.host === tokenToDelete.host \u0026\u0026 t.token === tokenToDelete.token))\n     saveTokens(updatedTokens)\n     // Update the reactive store\n     tokensStore.clear()\n@@ -107,7 +108,7 @@\n               \u003ctd class=\"p-2 text-right\"\u003e\n                 \u003cdiv class=\"flex gap-2 justify-end\"\u003e\n                   \u003cButton class=\"btn btn-primary btn-sm\" onclick={() =\u003e editToken(t)}\u003e\u003cIcon icon={Pen} /\u003e\u003c/Button\u003e\n-                  \u003cButton class=\"btn btn-error btn-sm\" onclick={() =\u003e del(t.host)}\n+                  \u003cButton class=\"btn btn-error btn-sm\" onclick={() =\u003e del(t)}\n                     \u003e\u003cIcon icon={TrashBin2} /\u003e\u003c/Button\u003e\n                 \u003c/div\u003e\n               \u003c/td\u003e\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-78xl596c","title":"From a948270392810b109dfb1fc4397cb8eb6f4aebab Mon Sep 17 00:00:00 2001","description":"From a948270392810b109dfb1fc4397cb8eb6f4aebab Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 14 Aug 2025 00:41:09 -0700\nSubject: [PATCH 4/6] feat: add GRASP server integration and improve diff stats calculation\n\n---\n packages/nostr-git                                                      |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 | 35 ++++++++++++++++++++++++++++++++++-\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte                   |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 13 +++++++++----\n 4 files changed, 45 insertions(+), 7 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 5e6761b..65972a5 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 5e6761b52cdbe71837afbc5d2445721b36c22c11\n+Subproject commit 65972a578049c176c7e1800dd612c285bbd7509c\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 550d95f..6505b3a 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -17,6 +17,12 @@\n   import {EditRepoPanel, ForkRepoDialog} from \"@nostr-git/ui\"\n   import {postRepoAnnouncement} from \"@src/app/commands.js\"\n   import type {RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n+  import { derived as _derived } from \"svelte/store\"\n+  import { repository, pubkey } from \"@welshman/app\"\n+  import { deriveEvents } from \"@welshman/store\"\n+  import { load } from \"@welshman/net\"\n+  import { Router } from \"@welshman/router\"\n+  import { GRASP_SET_KIND, DEFAULT_GRASP_SET_ID, parseGraspServersEvent } from \"@nostr-git/core\"\n \n   const {id, relay} = $page.params\n \n@@ -29,6 +35,32 @@\n   // Refresh state\n   let isRefreshing = $state(false)\n \n+  // --- GRASP servers (user profile) ---\n+  const graspServersFilter = {\n+    kinds: [GRASP_SET_KIND],\n+    authors: [pubkey.get()!],\n+    \"#d\": [DEFAULT_GRASP_SET_ID],\n+  }\n+\n+  const graspServersEvent = _derived(\n+    deriveEvents(repository, { filters: [graspServersFilter] }),\n+    (events) =\u003e {\n+      if (events.length === 0) {\n+        load({ relays: Router.get().FromUser().getUrls(), filters: [graspServersFilter] })\n+      }\n+      return events[0]\n+    }\n+  )\n+\n+  let graspServerUrls = $state\u003cstring[]\u003e([])\n+  graspServersEvent.subscribe((ev) =\u003e {\n+    try {\n+      graspServerUrls = ev ? (parseGraspServersEvent(ev as any) as string[]) : []\n+    } catch {\n+      graspServerUrls = []\n+    }\n+  })\n+\n   // Refresh repository function\n   async function refreshRepo() {\n     if (!repoClass || isRefreshing) return\n@@ -83,7 +115,8 @@\n       onPublishEvent: (event: any) =\u003e {\n         // Handle event publishing\n         postRepoAnnouncement(event, [])\n-      }\n+      },\n+      graspServerUrls: graspServerUrls\n     })\n   }\n \ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex a2286e7..57fe9fe 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -413,7 +413,7 @@\n     repoRef={repoRefObj}\n     repoEvent={repoClass.repoEvent}\n     relays={$repoRelays}\n-    theme=\"dark\"\n+    theme=\"retro\"\n     height={260}\n     initialCwd=\"/\"\n     urlAllowlist={[]}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex f29bb84..3618d24 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -718,10 +718,15 @@\n             \n             {#if selectedPatch.diff}\n               {@const stats = selectedPatch.diff.reduce((acc, file) =\u003e {\n-                // This is a simplified calculation - real implementation would parse the diff\n-                const content = file.content || ''\n-                const added = (content.match(/^\\+/gm) || []).length\n-                const removed = (content.match(/^-/gm) || []).length\n+                // Accurate calculation using parse-diff structure\n+                const added = (file.chunks ?? []).reduce((a, chunk) =\u003e {\n+                  const adds = chunk.changes?.filter((ch) =\u003e ch.type === 'add').length ?? 0\n+                  return a + adds\n+                }, 0)\n+                const removed = (file.chunks ?? []).reduce((a, chunk) =\u003e {\n+                  const dels = chunk.changes?.filter((ch) =\u003e ch.type === 'del').length ?? 0\n+                  return a + dels\n+                }, 0)\n                 return { added: acc.added + added, removed: acc.removed + removed }\n               }, { added: 0, removed: 0 })}\n               \n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-7cu1ipku","title":"From 547e4494a0088fe27ce7e09b80c695ea9d5528da Mon Sep 17 00:00:00 2001","description":"From 547e4494a0088fe27ce7e09b80c695ea9d5528da Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 30 Nov 2025 22:03:32 +0500\nSubject: [PATCH] feat(repo): add prominent clone URL section to repository overview\n\nAdd a highly visible clone URL section at the top of the repository\noverview page with one-click copy functionality.\n\nChanges:\n- Add new clone URL section positioned after stats grid\n- Display all available clone URLs with copy-to-clipboard functionality\n- Implement visual feedback (checkmark) when URL is copied\n- Make entire URL row clickable for easier copying\n- Use subtle gray theming to match overall design aesthetic\n\nTechnical improvements:\n- Fix repoMetadata to use repoClass properties directly instead of\n  accessing private repo object\n- Use repoClass.cloneUrls getter for proper clone URL retrieval\n- Use repoClass.name and repoClass.description for metadata\n- Add Copy and Check icons from lucide-svelte\n- Add copiedUrl state for tracking copy feedback\n- Implement copyUrl() function with 2-second feedback timeout\n\nUX enhancements:\n- Entire URL container is now a clickable button\n- Hover and active states provide clear interaction feedback\n- Keyboard accessible (tab navigation + Enter/Space to copy)\n- Responsive design with proper dark mode support\n- Icon changes to green checkmark after successful copy\n\nThis addresses the issue where clone URLs were buried in the\nrepository details sidebar and not immediately visible to users\nwanting to clone the repository.\n\nRelated: packages/nostr-git submodule updated to commit 74fe3465\n---\n packages/nostr-git                                    |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte | 61 +++++++++++++++++++++++++++++++++++++++++++++++++++++--------\n 2 files changed, 54 insertions(+), 9 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 4efc313..74fe346 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 4efc313fbe32818bfc24bb02e32b3ae90a5a1900\n+Subproject commit 74fe3465add4d79d825954479df096d84841844a\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 424e4ed..a97eb7f 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -12,6 +12,8 @@\n     Link,\n     Eye,\n     BookOpen,\n+    Copy,\n+    Check,\n   } from \"@lucide/svelte\"\n   import {fade, fly, slide} from \"@lib/transition\"\n   import Spinner from \"@lib/components/Spinner.svelte\"\n@@ -40,6 +42,7 @@\n   let _prevRepoKey = $state\u003cstring | undefined\u003e(undefined)\n   let _prevMain = $state\u003cstring | undefined\u003e(undefined)\n   let _prevBranchSig = $state\u003cstring | undefined\u003e(undefined)\n+  let copiedUrl = $state\u003cstring | null\u003e(null)\n \n   const stats = $derived([\n     {\n@@ -101,14 +104,14 @@\n   }\n \n   const repoMetadata = $derived({\n-    name: ((repoClass as any).repo?.name as string) || \"Unknown Repository\",\n-    description: ((repoClass as any).repo?.description as string) || \"\",\n+    name: repoClass.name || \"Unknown Repository\",\n+    description: repoClass.description || \"\",\n     repoId: repoClass.key || \"\",\n     maintainers: maintainers || [],\n     relays: $repoRelays,\n     cloneUrls: (() =\u003e {\n-      const rep: any = (repoClass as any).repo\n-      let urls = [...(rep?.clone || [])]\n+      // Get clone URLs from repoClass directly\n+      let urls = [...(repoClass.cloneUrls || [])]\n       if (!urls.find(u =\u003e u.startsWith(\"nostr://\"))) {\n         const def = buildDefaultNgitCloneUrl()\n         if (def \u0026\u0026 !urls.includes(def)) urls.push(def)\n@@ -116,8 +119,8 @@\n       return urls\n     })(),\n     webUrls: (() =\u003e {\n-      const rep: any = (repoClass as any).repo\n-      let urls = [...(rep?.web || [])]\n+      // Get web URLs from repoClass directly\n+      let urls = [...(repoClass.web || [])]\n       if (!urls.find(u =\u003e u.startsWith(\"https://gitworkshop.dev\"))) {\n         const def = buildDefaultViewRepoUrl()\n         if (def \u0026\u0026 !urls.includes(def)) urls.push(def)\n@@ -125,8 +128,8 @@\n       return urls\n     })(),\n     mainBranch: repoClass.mainBranch,\n-    createdAt: (repoClass as any).repoEvent?.created_at\n-      ? new Date(((repoClass as any).repoEvent.created_at as number) * 1000)\n+    createdAt: repoClass.repoEvent?.created_at\n+      ? new Date(repoClass.repoEvent.created_at * 1000)\n       : null,\n     updatedAt: (repoClass as any).repoStateEvent?.created_at\n       ? new Date(((repoClass as any).repoStateEvent.created_at as number) * 1000)\n@@ -287,6 +290,18 @@\n   function truncateHash(hash: string, length = 8) {\n     return hash ? hash.substring(0, length) : \"\"\n   }\n+\n+  async function copyUrl(url: string) {\n+    try {\n+      await clip(url)\n+      copiedUrl = url\n+      setTimeout(() =\u003e {\n+        copiedUrl = null\n+      }, 2000)\n+    } catch (e) {\n+      console.error(\"Failed to copy URL\", e)\n+    }\n+  }\n \u003c/script\u003e\n \n \u003csvelte:head\u003e\n@@ -316,6 +331,36 @@\n       {/each}\n     \u003c/div\u003e\n \n+    \u003c!-- Clone URL Section - Prominent Display --\u003e\n+    {#if repoMetadata.cloneUrls.length \u003e 0}\n+      \u003cdiv transition:fade\u003e\n+        \u003cCard class=\"p-6\"\u003e\n+          \u003ch3 class=\"mb-3 text-lg font-semibold flex items-center gap-2\"\u003e\n+            \u003cGitBranch class=\"h-5 w-5\" /\u003e\n+            Clone Repository\n+          \u003c/h3\u003e\n+          \u003cdiv class=\"space-y-2\"\u003e\n+            {#each repoMetadata.cloneUrls as url, index}\n+              \u003cbutton\n+                type=\"button\"\n+                class=\"flex w-full items-center gap-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 p-3 transition-all hover:border-gray-300 dark:hover:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700/50 active:scale-[0.99] cursor-pointer group\"\n+                title=\"Click to copy\"\n+                onclick={() =\u003e copyUrl(url)}\u003e\n+                \u003ccode class=\"flex-1 font-mono text-sm overflow-x-auto whitespace-nowrap text-left\"\u003e{url}\u003c/code\u003e\n+                \u003cdiv class=\"flex-shrink-0 p-1 rounded-md transition-colors group-hover:bg-gray-200 dark:group-hover:bg-gray-600\"\u003e\n+                  {#if copiedUrl === url}\n+                    \u003cCheck class=\"h-4 w-4 text-green-600 dark:text-green-400\" /\u003e\n+                  {:else}\n+                    \u003cCopy class=\"h-4 w-4 text-gray-600 dark:text-gray-400\" /\u003e\n+                  {/if}\n+                \u003c/div\u003e\n+              \u003c/button\u003e\n+            {/each}\n+          \u003c/div\u003e\n+        \u003c/Card\u003e\n+      \u003c/div\u003e\n+    {/if}\n+\n     \u003cdiv class=\"grid gap-6 md:grid-cols-2\" transition:fly\u003e\n       \u003c!-- Repository Details --\u003e\n       \u003cCard class=\"p-6\"\u003e\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-7heduc33","title":"From 596162cc2324e95c16e9fc1ce28ea4bd0e4dfb0c Mon Sep 17 00:00:00 2001","description":"From 596162cc2324e95c16e9fc1ce28ea4bd0e4dfb0c Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 23 Jun 2025 23:19:36 -0700\nSubject: [PATCH 7/9] feat: implement patch set navigation and filtering controls for git patches\n\n---\n packages/nostr-git                                                      |   2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           | 285 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 202 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------\n 3 files changed, 425 insertions(+), 64 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 97a87ad..ced0a44 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 97a87adc93387f1f5378ab7fd6a0b6bac1f17d7d\n+Subproject commit ced0a443ff4f13e5095277df8893606846885a29\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 1aa6de3..6a02a7c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -1,9 +1,9 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {Button, PatchCard, Repo} from \"@nostr-git/ui\"\n-  import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n-  import {Address, type TrustedEvent} from \"@welshman/util\"\n+  import {Button, PatchCard} from \"@nostr-git/ui\"\n+  import {CalendarDays, Check, Clock, Funnel, GitCommit, Plus, SearchX, User, X} from \"@lucide/svelte\"\n+  import {Address, COMMENT} from \"@welshman/util\"\n   import {nthEq} from \"@welshman/lib\"\n-  import {deriveProfile, repository} from \"@welshman/app\"\n+  import {repository} from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {makeFeed} from \"@src/app/requests\"\n   import {deriveEvents} from \"@welshman/store\"\n@@ -16,39 +16,129 @@\n   } from \"@welshman/util\"\n   import {fly} from \"@lib/transition\"\n   import {load} from \"@welshman/net\"\n-  import {parseStatusEvent, type Patch, type StatusEvent} from \"@nostr-git/shared-types\"\n+  import {getTags, type PatchEvent, type StatusEvent} from \"@nostr-git/shared-types\"\n+  import {parseGitPatchFromEvent} from \"@nostr-git/core\"\n \n   const {data} = $props()\n   const {repoClass} = data\n \n-  const statusFilter = {\n+  const statusEventFilter = {\n     kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n-    \"#e\": [...repoClass.patches.map((patch: Patch) =\u003e patch.id)],\n+    \"#e\": [...repoClass.patches.map((patch: PatchEvent) =\u003e patch.id)],\n   }\n-  const statusEvents = deriveEvents(repository, {filters: [statusFilter]})\n+  const statusEvents = deriveEvents(repository, {filters: [statusEventFilter]})\n \n+  // Filter and sort options\n+  let statusFilter = $state\u003cstring\u003e(\"all\") // all, open, applied, closed, draft\n+  let sortBy = $state\u003cstring\u003e(\"newest\") // newest, oldest, status, commits\n+  let authorFilter = $state\u003cstring\u003e(\"\") // empty string means all authors\n+  let showFilters = $state(false)\n+    \n+  // Get all unique authors from patches\n+  const uniqueAuthors = $derived.by(() =\u003e {\n+    if (!repoClass.patches) return []\n+    \n+    const authors = new Set\u003cstring\u003e()\n+    repoClass.patches.forEach((patch: PatchEvent) =\u003e {\n+      const pubkey = patch.pubkey\n+      if (pubkey) authors.add(pubkey)\n+    })\n+    \n+    return Array.from(authors)\n+  })\n+  \n   const patchList = $derived.by(() =\u003e {\n     if (repoClass.patches \u0026\u0026 $statusEvents.length \u003e 0) {\n-      return repoClass.patches.map((patch: Patch) =\u003e {\n-        const profile = deriveProfile(patch.author.pubkey)\n-        const statusEvent = $statusEvents\n-          ?.filter((s: any) =\u003e {\n-            let [_, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n-            return eventId === patch.id\n+      // First get all root patches\n+      let filteredPatches = repoClass.patches\n+        .filter((patch: PatchEvent) =\u003e {\n+          const tags = getTags(patch, \"t\")\n+          return tags.length \u003e 0 \u0026\u0026 tags[0][1] === \"root\"\n+        })\n+        .map((patch: PatchEvent) =\u003e {\n+          const status = $statusEvents\n+            ?.filter((s: any) =\u003e {\n+              let [_, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n+              return eventId === patch.id\n+            })\n+            .sort((a: any, b: any) =\u003e b.created_at - a.created_at)[0]\n+\n+          const patches = repoClass.patches.filter(issue =\u003e {\n+            const tags = getTags(issue, \"e\")\n+            return tags.length \u003e 0 \u0026\u0026 tags[0][1] === patch.id\n           })\n-          .sort((a: any, b: any) =\u003e b.created_at - a.created_at)[0]\n \n-        const status = statusEvent ? parseStatusEvent(statusEvent as StatusEvent) : undefined\n-        \n-        console.log($statusEvents)\n-        \n-        return {\n-          ...patch,\n-          ...patch.raw,\n-          patches: repoClass.patches.filter(issue =\u003e issue.id === patch.id),\n-          status,\n-        }\n-      })\n+          // Parse the patch to get additional metadata\n+          const parsedPatch = parseGitPatchFromEvent(patch)\n+          \n+          return {\n+            ...patch,\n+            patches,\n+            status,\n+            parsedPatch,\n+            // Add commit count directly for easier sorting\n+            commitCount: parsedPatch?.commitCount || 0,\n+          }\n+        })\n+      \n+      // Apply status filter\n+      if (statusFilter !== \"all\") {\n+        filteredPatches = filteredPatches.filter(patch =\u003e {\n+          if (!patch.status) {\n+            // If no status and filter is \"open\", show it (default is open)\n+            return statusFilter === \"open\"\n+          }\n+          \n+          switch (statusFilter) {\n+            case \"open\":\n+              return patch.status.kind === GIT_STATUS_OPEN\n+            case \"applied\":\n+              return patch.status.kind === GIT_STATUS_COMPLETE\n+            case \"closed\":\n+              return patch.status.kind === GIT_STATUS_CLOSED\n+            case \"draft\":\n+              return patch.status.kind === GIT_STATUS_DRAFT\n+            default:\n+              return true\n+          }\n+        })\n+      }\n+      \n+      // Apply author filter\n+      if (authorFilter) {\n+        filteredPatches = filteredPatches.filter(patch =\u003e patch.pubkey === authorFilter)\n+      }\n+      \n+      // Create a new array to avoid mutating the original\n+      let sortedPatches = [...filteredPatches]\n+      \n+      // Apply sorting - make a copy first to ensure reactivity\n+      const currentSortBy = sortBy // Capture the current sort value\n+      \n+      if (currentSortBy === \"newest\") {\n+        sortedPatches.sort((a, b) =\u003e b.created_at - a.created_at)\n+      } else if (currentSortBy === \"oldest\") {\n+        sortedPatches.sort((a, b) =\u003e a.created_at - b.created_at)\n+      } else if (currentSortBy === \"status\") {\n+        // Sort by status priority: open, draft, complete, closed\n+        sortedPatches.sort((a, b) =\u003e {\n+          const getStatusPriority = (status?: any) =\u003e {\n+            if (!status) return 0 // Open (default)\n+            switch (status.kind) {\n+              case GIT_STATUS_OPEN: return 0\n+              case GIT_STATUS_DRAFT: return 1\n+              case GIT_STATUS_COMPLETE: return 2\n+              case GIT_STATUS_CLOSED: return 3\n+              default: return 4\n+            }\n+          }\n+          return getStatusPriority(a.status) - getStatusPriority(b.status)\n+        })\n+      } else if (currentSortBy === \"commits\") {\n+        // Sort by commit count (highest first)\n+        sortedPatches.sort((a, b) =\u003e b.commitCount - a.commitCount)\n+      }\n+      return sortedPatches\n     }\n   })\n \n@@ -67,15 +157,15 @@\n   }\n \n   const allComments = $derived.by(() =\u003e {\n-    if(repoClass.patches) {\n-      return deriveEvents(repository, {filters:[commentFilter]})\n+    if (repoClass.patches) {\n+      return deriveEvents(repository, {filters: [commentFilter]})\n     }\n   })\n \n   $effect(() =\u003e {\n     if (repoClass.patches) {\n-      load({relays: repoClass.relays, filters: [patchFilter, statusFilter, commentFilter]})\n- \n+      load({relays: repoClass.relays, filters: [patchFilter, statusEventFilter, commentFilter]})\n+\n       makeFeed({\n         element: element!,\n         relays: repoClass.relays,\n@@ -92,16 +182,21 @@\n \u003c/script\u003e\n \n \u003cdiv bind:this={element}\u003e\n-  \u003cdiv class=\"z-10 sticky z-nav -top-8 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n+  \u003cdiv class=\"z-10 sticky -top-8 z-nav mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003ePatches\u003c/h2\u003e\n       \u003cp class=\"text-sm text-muted-foreground\"\u003eReview and merge code changes\u003c/p\u003e\n     \u003c/div\u003e\n \n     \u003cdiv class=\"flex items-center gap-2\"\u003e\n-      \u003cButton variant=\"outline\" size=\"sm\" class=\"gap-2\"\u003e\n+      \u003cButton \n+        variant=\"outline\" \n+        size=\"sm\" \n+        class=\"gap-2\" \n+        onclick={() =\u003e showFilters = !showFilters}\n+      \u003e\n         \u003cFunnel class=\"h-4 w-4\" /\u003e\n-        Filter\n+        {showFilters ? 'Hide Filters' : 'Filter'}\n       \u003c/Button\u003e\n \n       \u003cButton size=\"sm\" class=\"gap-2 bg-git hover:bg-git-hover\"\u003e\n@@ -111,6 +206,125 @@\n     \u003c/div\u003e\n   \u003c/div\u003e\n \n+  {#if showFilters}\n+    \u003cdiv class=\"mb-6 p-4 border border-border rounded-md bg-card\"\u003e\n+      \u003cdiv class=\"grid grid-cols-1 md:grid-cols-2 gap-4\"\u003e\n+        \u003c!-- Status Filter --\u003e\n+        \u003cdiv\u003e\n+          \u003ch3 class=\"text-sm font-medium mb-2\"\u003eStatus\u003c/h3\u003e\n+          \u003cdiv class=\"flex flex-wrap gap-2\"\u003e\n+            \u003cButton \n+              variant={statusFilter === \"all\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e statusFilter = \"all\"}\n+            \u003e\n+              All\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={statusFilter === \"open\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e statusFilter = \"open\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cGitCommit class=\"h-3 w-3\" /\u003e Open\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={statusFilter === \"applied\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e statusFilter = \"applied\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cCheck class=\"h-3 w-3\" /\u003e Applied\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={statusFilter === \"closed\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e statusFilter = \"closed\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cX class=\"h-3 w-3\" /\u003e Closed\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={statusFilter === \"draft\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e statusFilter = \"draft\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cClock class=\"h-3 w-3\" /\u003e Draft\n+            \u003c/Button\u003e\n+          \u003c/div\u003e\n+        \u003c/div\u003e\n+        \n+        \u003c!-- Sort Options --\u003e\n+        \u003cdiv\u003e\n+          \u003ch3 class=\"text-sm font-medium mb-2\"\u003eSort By\u003c/h3\u003e\n+          \u003cdiv class=\"flex flex-wrap gap-2\"\u003e\n+            \u003cButton \n+              variant={sortBy === \"newest\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e sortBy = \"newest\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cCalendarDays class=\"h-3 w-3\" /\u003e Newest\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={sortBy === \"oldest\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e sortBy = \"oldest\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cCalendarDays class=\"h-3 w-3\" /\u003e Oldest\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={sortBy === \"status\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e sortBy = \"status\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cCheck class=\"h-3 w-3\" /\u003e Status\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={sortBy === \"commits\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e sortBy = \"commits\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cGitCommit class=\"h-3 w-3\" /\u003e Commits\n+            \u003c/Button\u003e\n+          \u003c/div\u003e\n+        \u003c/div\u003e\n+        \n+        \u003c!-- Author Filter --\u003e\n+        {#if uniqueAuthors.length \u003e 1}\n+          \u003cdiv class=\"md:col-span-2\"\u003e\n+            \u003ch3 class=\"text-sm font-medium mb-2\"\u003eAuthor\u003c/h3\u003e\n+            \u003cdiv class=\"flex flex-wrap gap-2\"\u003e\n+              \u003cButton \n+                variant={authorFilter === \"\" ? \"default\" : \"outline\"} \n+                size=\"sm\"\n+                onclick={() =\u003e authorFilter = \"\"}\n+              \u003e\n+                All Authors\n+              \u003c/Button\u003e\n+              \n+              {#each uniqueAuthors as author}\n+                \u003cButton \n+                  variant={authorFilter === author ? \"default\" : \"outline\"} \n+                  size=\"sm\"\n+                  onclick={() =\u003e authorFilter = author}\n+                  class=\"gap-1\"\n+                \u003e\n+                  \u003cUser class=\"h-3 w-3\" /\u003e\n+                  \u003cspan class=\"text-sm\"\u003e{author.slice(0, 8)}...\u003c/span\u003e\n+                \u003c/Button\u003e\n+              {/each}\n+            \u003c/div\u003e\n+          \u003c/div\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  {/if}\n+\n   {#if loading}\n     \u003cdiv class=\"flex flex-col items-center justify-center py-12\"\u003e\n       \u003cSpinner {loading}\u003e\n@@ -129,11 +343,8 @@\n   {:else}\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each patchList! as patch}\n-        {@const count = $allComments\n-          ?.filter((c)=\u003egetTagValue(\"E\", c.tags) === patch.id).length ?? 0\n-        }\n         \u003cdiv in:fly\u003e\n-          \u003cPatchCard event={patch} status={patch.status} commentCount={count} /\u003e\n+          \u003cPatchCard event={patch} patches={patch.patches} status={patch.status as StatusEvent} /\u003e\n         \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 1aa1123..e97c793 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -1,34 +1,106 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n-  import {GitCommit, MessageSquare, Check, X} from \"@lucide/svelte\"\n-  import {Button} from \"@nostr-git/ui\"\n-  import {Avatar, AvatarFallback, AvatarImage, DiffViewer, IssueThread} from \"@nostr-git/ui\"\n-  import {deriveProfile, repository} from \"@welshman/app\"\n+  import {Check, ChevronLeft, ChevronRight, GitCommit, MessageSquare, X} from \"@lucide/svelte\"\n+  import {Button, Profile} from \"@nostr-git/ui\"\n+  import {DiffViewer, IssueThread} from \"@nostr-git/ui\"\n+  import {pubkey, repository} from \"@welshman/app\"\n   import markdownit from \"markdown-it\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {load} from \"@welshman/net\"\n-  import {COMMENT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE, GIT_STATUS_DRAFT, GIT_STATUS_OPEN, type Filter} from \"@welshman/util\"\n-  import {isStatusEvent, parseStatusEvent, type CommentEvent, type StatusEvent} from \"@nostr-git/shared-types\"\n+  import {\n+    COMMENT,\n+    GIT_PATCH,\n+    GIT_STATUS_CLOSED,\n+    GIT_STATUS_COMPLETE,\n+    GIT_STATUS_DRAFT,\n+    GIT_STATUS_OPEN,\n+    type Filter,\n+  } from \"@welshman/util\"\n+  import {\n+    getTags,\n+    parseStatusEvent,\n+    type CommentEvent,\n+    type StatusEvent,\n+    type PatchEvent,\n+  } from \"@nostr-git/shared-types\"\n+  import {getContext} from \"svelte\"\n+  import {REPO_RELAYS_KEY} from \"@src/app/state.js\"\n+  import {postComment} from \"@src/app/commands.js\"\n+  import {parseGitPatchFromEvent} from \"@nostr-git/core\"\n \n   const {data} = $props()\n   const {repoClass} = data\n \n-  const patch = repoClass.patches.find(p =\u003e p.id === $page.params.patchid)\n+  const patchId = $page.params.patchid\n+\n+  const patchEvent = repoClass.patches.find(p =\u003e p.id === patchId)\n+  const patch = patchEvent ? parseGitPatchFromEvent(patchEvent) : undefined\n+\n+  let rootPatchId = patchId\n+  let currentPatch = patchEvent as PatchEvent | null\n+  while (currentPatch) {\n+    const replyTags = getTags(currentPatch, \"e\")\n+    if (replyTags.length === 0) break\n+    \n+    const parentId = replyTags[0][1]\n+    const parentPatch = repoClass.patches.find(p =\u003e p.id === parentId)\n+    if (!parentPatch) break\n+    \n+    rootPatchId = parentId\n+    currentPatch = parentPatch\n+  }\n+  \n+  const patchSet = repoClass.patches\n+    .filter((p): p is PatchEvent =\u003e {\n+      if (p.id === patchId) return true\n+      const directReplyToThis = getTags(p, \"e\").some(tag =\u003e tag[1] === patchId)\n+      if (directReplyToThis) return true\n+      if (rootPatchId !== patchId) {\n+        const replyTags = getTags(p, \"e\")\n+        if (replyTags.length \u003e 0) {\n+          let checkPatch: PatchEvent | undefined = p\n+          let foundRoot = false\n+          \n+          while (checkPatch) {\n+            if (checkPatch.id === rootPatchId) {\n+              foundRoot = true\n+              break\n+            }\n+            \n+            const checkReplyTags: [string, ...string[]][] = getTags(checkPatch, \"e\")\n+            if (checkReplyTags.length === 0) break\n+            \n+            const checkParentId: string = checkReplyTags[0][1]\n+            checkPatch = repoClass.patches.find((p): p is PatchEvent =\u003e p.id === checkParentId)\n+            if (!checkPatch) break\n+          }   \n+          return foundRoot\n+        }\n+      }\n+      return false\n+    })\n+    .sort((a, b) =\u003e a.created_at - b.created_at)\n+    .sort((a,b) =\u003e a.id === rootPatchId ? -1 : 1)\n+    .map(p =\u003e parseGitPatchFromEvent(p))\n+    \n+  let selectedPatch = $state(patch)\n \n   const threadComments = $derived.by(() =\u003e {\n-    if (repoClass.patches) {\n-      const filters: Filter[] = [{kinds: [COMMENT], \"#E\": [patch?.id!]}]\n+    if (repoClass.patches \u0026\u0026 selectedPatch) {\n+      const filters: Filter[] = [{kinds: [COMMENT], \"#E\": [selectedPatch.id]}]\n       load({relays: repoClass.relays, filters})\n       return deriveEvents(repository, {filters})\n     }\n   })\n \n-  const statusFilter = {\n+  const getStatusFilter = () =\u003e ({\n     kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n-    \"#e\": [patch?.id!],\n-  }\n+    \"#e\": [selectedPatch?.id ?? \"\"],\n+  })\n \n-  const statusEvents = deriveEvents(repository, {filters: [statusFilter]})\n+  const statusEvents = $derived.by(() =\u003e {\n+    return deriveEvents(repository, {filters: [getStatusFilter()]})\n+  })\n \n   const repoRelays = getContext\u003cstring[]\u003e(REPO_RELAYS_KEY)\n   const onCommentCreated = async (comment: CommentEvent) =\u003e {\n@@ -37,7 +109,7 @@\n \n   const status = $derived.by(() =\u003e {\n     if ($statusEvents) {\n-      const statusEvent = $statusEvents.filter(isStatusEvent).sort((a, b) =\u003e b.created_at - a.created_at)[0]\n+      const statusEvent = $statusEvents.sort((a, b) =\u003e b.created_at - a.created_at)[0]\n       return statusEvent ? parseStatusEvent(statusEvent as StatusEvent) : undefined\n     }\n   })\n@@ -78,7 +150,7 @@\n             {/if}\n \n             \u003cdiv\u003e\n-              \u003ch1 class=\"text-2xl font-bold\"\u003e{patch?.title}\u003c/h1\u003e\n+              \u003ch1 class=\"text-2xl font-bold break-words\"\u003e{patch?.title}\u003c/h1\u003e\n \n               \u003cdiv class=\"mt-1 flex items-center gap-2\"\u003e\n                 \u003cdiv class=\"git-tag bg-secondary\"\u003e\n@@ -105,7 +177,7 @@\n         \u003cdiv class=\"git-separator\"\u003e\u003c/div\u003e\n \n         \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n-          \u003ch2 class=\"text-lg font-medium\"\u003e{patch?.commitCount} Commits\u003c/h2\u003e\n+          \u003ch2 class=\"text-lg font-medium\"\u003e{patchSet.length} Patches in Set\u003c/h2\u003e\n \n           \u003cdiv class=\"flex items-center gap-2\"\u003e\n             {#if status?.status === \"open\"}\n@@ -116,11 +188,90 @@\n           \u003c/div\u003e\n         \u003c/div\u003e\n \n-        \u003cdiv class=\"mb-6 space-y-3\"\u003e\u003c/div\u003e\n+        \u003c!-- Patch Set --\u003e\n+        \u003cdiv class=\"mb-6 border border-border rounded-md overflow-hidden\"\u003e\n+          {#each patchSet as patchItem, index}\n+            {@const isSelected = selectedPatch?.id === patchItem.id}\n+            {@const isRoot = patchSet.some(p =\u003e {\n+              const tags = getTags(p.raw, \"e\")\n+              return tags.length \u003e 0 \u0026\u0026 tags[0][1] === patchItem.id\n+            })}\n+            \n+            \u003cbutton \n+              class=\"w-full text-left p-3 hover:bg-secondary/20 border-b border-border last:border-b-0 flex items-center gap-3 {isSelected ? 'bg-secondary/30' : ''}\" \n+              onclick={() =\u003e selectedPatch = patchItem}\n+            \u003e\n+              \u003cdiv class=\"flex-shrink-0\"\u003e\n+                \u003cGitCommit class=\"h-5 w-5 {isSelected ? 'text-primary' : 'text-muted-foreground'}\" /\u003e\n+              \u003c/div\u003e\n+              \u003cdiv class=\"flex-grow\"\u003e\n+                \u003cdiv class=\"font-semibold break-words\"\u003e{patchItem.title || `Patch ${index + 1}`}\u003c/div\u003e\n+                \u003cdiv class=\"text-sm text-muted-foreground flex items-center gap-2\"\u003e\n+                  \u003cspan\u003e{patchItem.author.name || patchItem.author.pubkey.slice(0, 8)}\u003c/span\u003e\n+                  \u003cspan\u003e•\u003c/span\u003e\n+                  \u003cspan\u003e{new Date(patchItem.createdAt).toLocaleString()}\u003c/span\u003e\n+                  {#if patchItem.commitHash}\n+                    \u003cspan\u003e•\u003c/span\u003e\n+                    \u003cspan\u003e{patchItem.commitHash}\u003c/span\u003e\n+                  {/if}\n+                  {#if isRoot}\n+                    \u003cspan class=\"ml-1 px-1.5 py-0.5 text-xs rounded bg-blue-500/20 text-blue-500\"\u003eroot\u003c/span\u003e\n+                  {/if}\n+                \u003c/div\u003e\n+              \u003c/div\u003e\n+            \u003c/button\u003e\n+          {/each}\n+        \u003c/div\u003e\n \n-        \u003ch2 class=\"mb-4 text-lg font-medium\"\u003eChanges\u003c/h2\u003e\n-        {#if patch?.diff}\n-          \u003cDiffViewer diff={patch.diff} /\u003e\n+        \u003cdiv class=\"flex items-center justify-between mb-4\"\u003e\n+          \u003ch2 class=\"text-lg font-medium\"\u003eChanges\u003c/h2\u003e\n+          \n+          \u003c!-- Navigation Controls --\u003e\n+          {#if patchSet.length \u003e 1}\n+            \u003cdiv class=\"flex items-center gap-2\"\u003e\n+              {#key selectedPatch?.id}\n+                {@const currentIndex = patchSet.findIndex(p =\u003e p.id === selectedPatch?.id)}\n+                {@const hasPrevious = currentIndex \u003e 0}\n+                {@const hasNext = currentIndex \u003c patchSet.length - 1}\n+                \n+                \u003cButton \n+                  variant=\"outline\" \n+                  size=\"sm\" \n+                  disabled={!hasPrevious}\n+                  onclick={() =\u003e {\n+                    if (hasPrevious) {\n+                      selectedPatch = patchSet[currentIndex - 1];\n+                    }\n+                  }}\n+                \u003e\n+                  \u003cChevronLeft class=\"h-4 w-4 mr-1\" /\u003e\n+                  Previous\n+                \u003c/Button\u003e\n+                \n+                \u003cspan class=\"text-sm text-muted-foreground\"\u003e\n+                  {currentIndex + 1} of {patchSet.length}\n+                \u003c/span\u003e\n+                \n+                \u003cButton \n+                  variant=\"outline\" \n+                  size=\"sm\" \n+                  disabled={!hasNext}\n+                  onclick={() =\u003e {\n+                    if (hasNext) {\n+                      selectedPatch = patchSet[currentIndex + 1];\n+                    }\n+                  }}\n+                \u003e\n+                  Next\n+                  \u003cChevronRight class=\"h-4 w-4 ml-1\" /\u003e\n+                \u003c/Button\u003e\n+              {/key}\n+            \u003c/div\u003e\n+          {/if}\n+        \u003c/div\u003e\n+        \n+        {#if selectedPatch?.diff}\n+          \u003cDiffViewer diff={selectedPatch.diff} /\u003e\n         {/if}\n \n         \u003cdiv class=\"git-separator my-6\"\u003e\u003c/div\u003e\n@@ -132,12 +283,11 @@\n           \u003c/h2\u003e\n \n           \u003cIssueThread\n-            issueId = {patch?.id}\n-            issueKind={GIT_PATCH.toString() as '1617'}\n-            comments = {$threadComments}\n-            currentCommenter = {$pubkey!}\n-            onCommentCreated={onCommentCreated}\n-          /\u003e\n+            issueId={selectedPatch?.id ?? \"\"}\n+            issueKind={GIT_PATCH.toString() as \"1617\"}\n+            comments={$threadComments as CommentEvent[]}\n+            currentCommenter={$pubkey!}\n+            {onCommentCreated} /\u003e\n         \u003c/div\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-7hjl23hq","title":"From b11a73aa6ebf2835f453f3d5c15d795646fd07e9 Mon Sep 17 00:00:00 2001","description":"From b11a73aa6ebf2835f453f3d5c15d795646fd07e9 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Fri, 12 Dec 2025 01:20:47 +0500\nSubject: [PATCH 12/13] chore: update nostr-git submodule\n\nUpdate submodule to include:\n- Improved __GRASP__ undefined checks\n- Component registry updates (AlertDescription, Markdown removal)\n---\n packages/nostr-git | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 7ed3590..80f6507 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 7ed35909df81c287fe7507775b3695e926bf2713\n+Subproject commit 80f6507aef29ac32eaf421aeb039fb34cb5a8167\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-7obie06v","title":"Unable to set issues as 'resolved' or 'closed'","description":"Should be able to set this in budabit","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["draft","enhancement","issue"]}
{"id":"flotilla-81uxv849","title":"From a7fd91fde3b8807bd51b1a4b9b387a808d91a953 Mon Sep 17 00:00:00 2001","description":"From a7fd91fde3b8807bd51b1a4b9b387a808d91a953 Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/8] Standardize repo path to canonical form\n\nWe fixed canonical repo ID handling by standardizing on Repo.canonicalKey across worker calls, caching, and background tasks. The Repo constructor now derives a stable key via canonicalRepoKey(repoId) when the repo event arrives, and passes this canonical ID consistently to WorkerManager APIs, MergeAnalysisCacheManager, and PatchManager (including background batch analysis). This removes mismatches between transient event IDs and the UI’s cache keys, ensures merge analysis results are keyed and retrieved deterministically, and aligns branch resolution (main branch fallback) and commit operations with a single authoritative repo identifier.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-861coag9","title":"From d1ade02b6e2a3ada30aced14d9f8af9073f760ea Mon Sep 17 00:00:00 2001","description":"From d1ade02b6e2a3ada30aced14d9f8af9073f760ea Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 30 Nov 2025 19:22:44 +0500\nSubject: [PATCH 8/13] refactor: migrate from INDEXER_RELAYS to GIT_RELAYS for git-related operations\n\nReplace INDEXER_RELAYS with GIT_RELAYS throughout the budabit module to\nbetter separate concerns between general indexing and git-specific relay\noperations.\n\nChanges:\n- Updated GIT_RELAYS initialization to use fromCsv() helper for proper\n  string array conversion from environment variable\n- Replaced all INDEXER_RELAYS references with GIT_RELAYS in:\n  * commands.ts: All publish operations (issues, patches, comments,\n    statuses, repo announcements, repo state events, labels, permalinks,\n    GRASP servers list, and role labels)\n  * requests.ts: User git data loading operations\n  * state.ts: Repo announcements loading, repo context loading, and\n    naddr event derivation\n  * +layout.ts: Repository layout loading with proper import from\n    budabit state module\n\n- Added purplepag.es relay to VITE_INDEXER_RELAYS in .env for improved\n  relay diversity\n\nThis change improves code organization by using dedicated git-specific\nrelays (configured via VITE_GIT_RELAYS) instead of general indexer\nrelays, allowing for better control over where git-related events are\npublished and queried.\n---\n .env                                                |  2 +-\n src/lib/budabit/commands.ts                         | 22 +++++++++++-----------\n src/lib/budabit/requests.ts                         |  4 ++--\n src/lib/budabit/state.ts                            | 10 +++++-----\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts |  7 ++++---\n 5 files changed, 23 insertions(+), 22 deletions(-)\n\ndiff --git a/.env b/.env\nindex 2589753..f71b2f2 100644\n--- a/.env\n+++ b/.env\n@@ -10,7 +10,7 @@ VITE_PLATFORM_RELAYS=wss://budabit.nostr1.com/\n VITE_PLATFORM_ACCENT=\"#D4AF37\"\n VITE_PLATFORM_SECONDARY=\"#EB5E28\"\n VITE_PLATFORM_DESCRIPTION=\"The Club for Builders in Freedom Tech.\"\n-VITE_INDEXER_RELAYS=wss://relay.damus.io/,wss://relay.nostr.band/\n+VITE_INDEXER_RELAYS=wss://purplepag.es/,wss://relay.damus.io/,wss://relay.nostr.band/\n VITE_SIGNER_RELAYS=wss://relay.nsec.app/,wss://bucket.coracle.social/\n VITE_NOTIFIER_PUBKEY=27b7c2ed89ef78322114225ea3ebf5f72c7767c2528d4d0c1854d039c00085df\n VITE_NOTIFIER_RELAY=wss://anchor.coracle.social/\ndiff --git a/src/lib/budabit/commands.ts b/src/lib/budabit/commands.ts\nindex be26598..caa7bbb 100644\n--- a/src/lib/budabit/commands.ts\n+++ b/src/lib/budabit/commands.ts\n@@ -1,12 +1,12 @@\n import type { CommentEvent, IssueEvent, RepoAnnouncementEvent, StatusEvent, PermalinkEvent, RepoStateEvent, GraspSetEvent, NostrEvent, TrustedEvent } from \"@nostr-git/shared-types\"\n import { buildRoleLabelEvent } from \"./labels\"\n import { publishThunk } from \"@welshman/app\"\n-import { INDEXER_RELAYS } from \"@app/core/state\"\n+import { GIT_RELAYS } from \"./state\"\n import { Router } from \"@welshman/router\"\n import { publishDelete } from \"@src/app/core/commands\"\n \n export const publishEvent = \u003cT extends NostrEvent\u003e(event: T, relays?: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays ?? []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays ?? []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     relays: merged,\n     event: event,\n@@ -15,13 +15,13 @@ export const publishEvent = \u003cT extends NostrEvent\u003e(event: T, relays?: string[]) \n \n export const postComment = (comment: CommentEvent, relays: string[]) =\u003e {\n   return publishThunk({\n-    relays: relays ?? [...INDEXER_RELAYS, ...Router.get().FromUser().getUrls()],\n+    relays: relays ?? [...GIT_RELAYS, ...Router.get().FromUser().getUrls()],\n     event: comment,\n   })\n }\n \n export const postIssue = (issue: IssueEvent, relays: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     event: issue,\n     relays: merged,\n@@ -29,7 +29,7 @@ export const postIssue = (issue: IssueEvent, relays: string[]) =\u003e {\n }\n \n export const postStatus = (status: StatusEvent, relays: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     relays: merged,\n     event: status,\n@@ -37,7 +37,7 @@ export const postStatus = (status: StatusEvent, relays: string[]) =\u003e {\n }\n \n export const postRepoAnnouncement = (repo: RepoAnnouncementEvent, relays: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     relays: merged,\n     event: repo,\n@@ -45,7 +45,7 @@ export const postRepoAnnouncement = (repo: RepoAnnouncementEvent, relays: string\n }\n \n export const postRepoStateEvent = (repoEvent: RepoStateEvent, relays: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     relays: merged,\n     event: repoEvent,\n@@ -54,7 +54,7 @@ export const postRepoStateEvent = (repoEvent: RepoStateEvent, relays: string[]) \n \n // Publish a NIP-32 label event (kind 1985)\n export const postLabel = (labelEvent: any, relays: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     relays: merged,\n     event: labelEvent,\n@@ -62,7 +62,7 @@ export const postLabel = (labelEvent: any, relays: string[]) =\u003e {\n }\n \n export const postPermalink = (permalink: PermalinkEvent, relays: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     event: permalink,\n     relays: merged,\n@@ -70,7 +70,7 @@ export const postPermalink = (permalink: PermalinkEvent, relays: string[]) =\u003e {\n }\n \n export const postGraspServersList = (graspServersList: GraspSetEvent) =\u003e {\n-  const merged = Array.from(new Set([...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     event: graspServersList,\n     relays: merged,\n@@ -94,7 +94,7 @@ export const postRoleLabel = (params: {\n     repoAddr,\n     created_at\n   })\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     relays: merged,\n     event: event,\ndiff --git a/src/lib/budabit/requests.ts b/src/lib/budabit/requests.ts\nindex 58c3365..cc6a517 100644\n--- a/src/lib/budabit/requests.ts\n+++ b/src/lib/budabit/requests.ts\n@@ -7,9 +7,9 @@ import { load } from \"@welshman/net\"\n import { deriveEvents } from \"@welshman/store\"\n import { NAMED_BOOKMARKS, getAddressTags, normalizeRelayUrl } from \"@welshman/util\"\n import { validateGraspServerUrl } from \"@nostr-git/shared-types\"\n-import { INDEXER_RELAYS } from \"@app/core/state\"\n+import { GIT_RELAYS } from \"./state\"\n \n-export const loadUserGitData = async (pubkey: string, relays: string[] = INDEXER_RELAYS) =\u003e {\n+export const loadUserGitData = async (pubkey: string, relays: string[] = GIT_RELAYS) =\u003e {\n     await Promise.race([sleep(3000), loadRelaySelections(pubkey, relays)])\n \n     // Start centralized syncs (idempotent)\ndiff --git a/src/lib/budabit/state.ts b/src/lib/budabit/state.ts\nindex 546f2c3..3868936 100644\n--- a/src/lib/budabit/state.ts\n+++ b/src/lib/budabit/state.ts\n@@ -16,7 +16,7 @@ import {\n } from \"@nostr-git/core\"\n import { repository } from \"@welshman/app\"\n import { collection, deriveEvents, withGetter } from \"@welshman/store\"\n-import { INDEXER_RELAYS, PLATFORM_RELAYS, channelEvents, deriveEvent, getUrlsForEvent, roomComparator, splitChannelId, userRoomsByUrl, type Channel} from \"@app/core/state\"\n+import { PLATFORM_RELAYS, channelEvents, deriveEvent, messages, getUrlsForEvent, memberships, roomComparator, splitChannelId, userRoomsByUrl, type Channel, getMembershipRooms, ROOM, fromCsv } from \"@app/core/state\"\n import { normalizeRelayUrl, type TrustedEvent, ROOM_META, getTag } from \"@welshman/util\"\n import { nip19 } from \"nostr-tools\"\n import { fromPairs, pushToMapKey, sortBy, uniq, uniqBy } from \"@welshman/lib\"\n@@ -32,7 +32,7 @@ export const GIT_CLIENT_ID = import.meta.env.VITE_GH_CLIENT_ID\n \n export const FREELANCE_JOB = 32767\n \n-export const GIT_RELAYS = import.meta.env.VITE_GIT_RELAYS\n+export const GIT_RELAYS = fromCsv(import.meta.env.VITE_GIT_RELAYS)\n \n export const ROOMS = 10009\n \n@@ -82,7 +82,7 @@ export const deriveRepoGroup = (euc: string) =\u003e\n export const deriveMaintainersForEuc = (euc: string) =\u003e\n   withGetter(derived(deriveRepoGroup(euc), g =\u003e (g ? deriveMaintainers(g) : new Set\u003cstring\u003e())))\n \n-export const loadRepoAnnouncements = (relays: string[] = INDEXER_RELAYS) =\u003e\n+export const loadRepoAnnouncements = (relays: string[] = GIT_RELAYS) =\u003e\n   load({\n     relays: relays.map(u =\u003e normalizeRelayUrl(u)).filter(Boolean) as string[],\n     filters: [{ kinds: [30617] }],\n@@ -244,7 +244,7 @@ export const loadRepoContext = (args: {\n     rootEventId: args.rootId,\n     euc: args.euc,\n   })\n-  const defaults = GIT_RELAYS \u0026\u0026 GIT_RELAYS.length \u003e 0 ? GIT_RELAYS : INDEXER_RELAYS\n+  const defaults = GIT_RELAYS\n   const relays = (args.relays || defaults)\n     .map((u: string) =\u003e normalizeRelayUrl(u))\n     .filter(Boolean) as string[]\n@@ -254,7 +254,7 @@ export const loadRepoContext = (args: {\n export const deriveNaddrEvent = (naddr: string, hints: string[] = []) =\u003e {\n   let attempted = false\n   const decoded = nip19.decode(naddr).data as nip19.AddressPointer\n-  const fallbackRelays = [...hints, ...INDEXER_RELAYS]\n+  const fallbackRelays = [...hints, ...GIT_RELAYS]\n   const relays = (decoded.relays \u0026\u0026 decoded.relays.length \u003e 0 ? decoded.relays : fallbackRelays)\n     .map(u =\u003e normalizeRelayUrl(u))\n     .filter(Boolean)\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nindex 2dae8c2..9dc7d8c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -22,7 +22,8 @@ import type {LayoutLoad} from \"./$types\"\n export const load: LayoutLoad = async ({params}) =\u003e {\n   const {id, relay} = params\n   // Dynamic imports to avoid SSR issues\n-  const {decodeRelay, INDEXER_RELAYS} = await import(\"@app/core/state\")\n+  const {decodeRelay} = await import(\"@app/core/state\")\n+  const {GIT_RELAYS} = await import(\"@src/lib/budabit/state\")\n   const {deriveEvents} = await import(\"@welshman/store\")\n   const {repository} = await import(\"@welshman/app\")\n   const {load} = await import(\"@welshman/net\")\n@@ -42,11 +43,11 @@ export const load: LayoutLoad = async ({params}) =\u003e {\n   }\n   const url = decodeRelay(relay)\n \n-  const fallbackRelays = INDEXER_RELAYS\n+  const fallbackRelays = GIT_RELAYS\n   const relayListFromUrl = (\n     (decoded.relays?.length ?? 0) \u003e 0 ? (decoded.relays as string[]) : fallbackRelays\n   )\n-    .map(u =\u003e normalizeRelayUrl(u))\n+    .map((u: string) =\u003e normalizeRelayUrl(u))\n     .filter(Boolean) as string[]\n \n   const filters = [\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-862sqwwv","title":"From 6eecb641e56c00a315a0defc32cb937006b1439e Mon Sep 17 00:00:00 2001","description":"From 6eecb641e56c00a315a0defc32cb937006b1439e Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 14 Dec 2025 16:33:43 +0500\nSubject: [PATCH 13/13] refactor: optimize git repository navigation with non-blocking data loading\n\nRefactor git repository layout and page components to improve performance\nby making data loading non-blocking and using reactive stores instead of\nblocking await calls. This significantly reduces initial page load time\nand improves navigation responsiveness.\n\nKey improvements:\n\nLayout Loader (+layout.ts):\n- Convert blocking repo event loading to non-blocking promise that starts\n  in background (repoLoadPromise)\n- Replace synchronous maintainer extraction with reactive derived store\n  (repoAuthors) that updates when repo event loads\n- Create reactive event stores (allIssueEvents, allPatchEvents, etc.)\n  that watch repository and filter based on current authors\n- Remove blocking filter loads - stores update reactively as data arrives\n- Add support for StatusEvent, CommentEvent, and LabelEvent types\n- Improve maintainer extraction to handle cases where repo event hasn't\n  loaded yet\n\nLayout Component (+layout.svelte):\n- Remove onMount refresh call that was causing unnecessary repo updates\n- Remove navigation-based refresh calls (afterNavigate/beforeNavigate)\n  that were triggering redundant data fetches\n- Simplify navigation handling to only manage scroll position for issues\n  page\n\nRepository Overview Page (+page.svelte):\n- Optimize commit history loading to use main branch directly instead of\n  trying multiple branch candidates\n- Add graceful error handling for non-cloned repositories - commit history\n  and README are now optional and won't block page load\n- Improve README loading with better error handling that doesn't fail\n  silently but also doesn't block rendering\n- Simplify commit history depth strategy (5 -\u003e 10 -\u003e 25) with early exit\n  on success\n\nCode Page (+code/+page.svelte):\n- Add better error handling and loading states\n\nIssues Page (issues/+page.ts):\n- Refactor to use reactive stores instead of blocking filter loads\n- Improve maintainer-based filtering logic\n\nPatches Page (patches/+page.ts, patches/+page.svelte):\n- Remove blocking load() calls for comments, status events, patches, and\n  pull requests\n- Convert to reactive stores that update as data arrives\n- Pass repoRelays to page component for incremental loading support\n- Simplify filter creation by moving to return object\n\nPatch Detail Page (patches/[patchid]/+page.svelte):\n- Improve error handling and loading states\n\nPerformance Impact:\n- Initial page load no longer blocked by network requests\n- Navigation between repo pages is now instant\n- Reactive stores update UI as data arrives from relays\n- Better user experience with progressive data loading\n- Reduced unnecessary network requests from removed refresh calls\n\nThis change maintains all existing functionality while significantly\nimproving perceived performance and reducing blocking operations.\n---\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |  23 -----------------------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts                     | 284 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte                   |  72 +++++++++++++++++++++++++++++++++++++-----------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte              |  84 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.ts                |  34 +++++++++-------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           |   9 ++++++++-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts               |  40 ++++++++++++++++++----------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte |  27 ++++++++++++++++++++++++++-\n 8 files changed, 396 insertions(+), 177 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 7b1f356..82f9908 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -25,7 +25,6 @@\n   import {load} from \"@welshman/net\"\n   import {Router} from \"@welshman/router\"\n   import {goto, afterNavigate, beforeNavigate} from \"$app/navigation\"\n-  import {onMount} from \"svelte\"\n   import {normalizeRelayUrl, NAMED_BOOKMARKS, makeEvent, Address} from \"@welshman/util\"\n   import PageBar from \"@src/lib/components/PageBar.svelte\"\n   import Button from \"@src/lib/components/Button.svelte\"\n@@ -86,25 +85,14 @@\n     \"#d\": [DEFAULT_GRASP_SET_ID],\n   }\n \n-  // Initial refresh on mount\n-  onMount(() =\u003e {\n-    // Fire and forget; guard prevents overlap\n-    updateRepo()\n-  })\n-\n   // Helper to compute base path for this repo scope\n   function repoBasePath() {\n     return `/spaces/${encodeURIComponent(relay)}/git/${id}`\n   }\n \n-  // Refresh after navigation into any sub-route under this layout\n   afterNavigate(({to}) =\u003e {\n     try {\n       if (!to) return\n-      const base = repoBasePath()\n-      if (to.url.pathname.startsWith(base)) {\n-        updateRepo()\n-      }\n \n       if (to.route.id === \"/spaces/[relay]/git/[id=naddr]/issues\") {\n         // Restore scroll position for issues page\n@@ -127,9 +115,7 @@\n     } catch {}\n   })\n \n-  // Pre-emptive refresh when navigating within the same repo scope\n   beforeNavigate(({from, to}) =\u003e {\n-\n     if (from?.route.id === \"/spaces/[relay]/git/[id=naddr]/issues\") {\n       // Save scroll position when leaving issues page\n       if (pageContentElement) {\n@@ -137,15 +123,6 @@\n         sessionStorage.setItem(scrollStorageKey, scrollPosition.toString())\n       }\n     }\n-\n-    try {\n-      if (!to) return\n-      const base = repoBasePath()\n-      if (to.url.pathname.startsWith(base)) {\n-        // Kick off without awaiting to avoid blocking navigation\n-        Promise.resolve().then(() =\u003e updateRepo())\n-      }\n-    } catch {}\n   })\n \n   const graspServersEvent = _derived(\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nindex 9dc7d8c..ada41f0 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -6,6 +6,10 @@ import {\n   type RepoAnnouncementEvent,\n   type RepoStateEvent,\n   type PullRequestEvent,\n+  type StatusEvent,\n+  type CommentEvent,\n+  type LabelEvent,\n+  isCommentEvent,\n } from \"@nostr-git/shared-types\"\n import {\n   GIT_REPO_ANNOUNCEMENT,\n@@ -13,7 +17,7 @@ import {\n   GIT_PULL_REQUEST,\n   normalizeRelayUrl,\n } from \"@nostr-git/shared-types\"\n-import {GIT_ISSUE, GIT_PATCH, GIT_STATUS_OPEN, GIT_STATUS_DRAFT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE, getTagValue} from \"@welshman/util\"\n+import {GIT_ISSUE, GIT_PATCH, GIT_STATUS_OPEN, GIT_STATUS_DRAFT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE, getTagValue, COMMENT, type TrustedEvent} from \"@welshman/util\"\n import {nthEq} from \"@welshman/lib\"\n import {nip19} from \"nostr-tools\"\n import type {AddressPointer} from \"nostr-tools/nip19\"\n@@ -50,14 +54,15 @@ export const load: LayoutLoad = async ({params}) =\u003e {\n     .map((u: string) =\u003e normalizeRelayUrl(u))\n     .filter(Boolean) as string[]\n \n-  const filters = [\n+  const repoFilters = [\n     {\n       authors: [decoded.pubkey],\n       kinds: [GIT_REPO_STATE, GIT_REPO_ANNOUNCEMENT],\n     },\n   ]\n \n-  await load({relays: relayListFromUrl as string[], filters})\n+  // Start loading repo events immediately (will be used later)\n+  const repoLoadPromise = load({relays: relayListFromUrl as string[], filters: repoFilters})\n \n   const repoEvent = derived(\n     deriveEvents(repository, {\n@@ -122,96 +127,182 @@ export const load: LayoutLoad = async ({params}) =\u003e {\n     return relayListFromUrl\n   })\n \n-  // First, load all repo announcements with the same name to get all related repos\n-  const allReposFilter = {\n-    kinds: [GIT_REPO_ANNOUNCEMENT],\n-    \"#d\": [repoName],\n-  }\n-\n-  await load({\n-    relays: relayListFromUrl as string[],\n-    filters: [allReposFilter],\n-  })\n-\n-  // Extract maintainers and author from repo event for filtering\n+  // Don't block on repo load - start loading in background and return immediately\n+  // The page will render with what we have, and reactive stores will update as data arrives\n+  \n+  // Extract maintainers reactively (non-blocking)\n   const {parseRepoAnnouncementEvent} = await import(\"@nostr-git/shared-types\")\n-\n-  // Wait for repo event to be available\n-  let repoAuthors: string[] = [decoded.pubkey]\n-  const unsubscribe = repoEvent.subscribe(repo =\u003e {\n-    if (repo) {\n+  \n+  // Create reactive repoAuthors that updates when repo event loads\n+  const repoAuthors = derived(repoEvent, (repo) =\u003e {\n+    if (!repo) {\n+      // Fallback to just the pubkey if repo event not loaded yet\n+      return [decoded.pubkey]\n+    }\n+    try {\n       const parsed = parseRepoAnnouncementEvent(repo)\n       const authors = new Set\u003cstring\u003e()\n       authors.add(repo.pubkey) // Author of the repo announcement\n       if (parsed.maintainers) {\n         parsed.maintainers.forEach(m =\u003e authors.add(m))\n       }\n-      repoAuthors = Array.from(authors)\n+      return Array.from(authors)\n+    } catch {\n+      return [decoded.pubkey]\n     }\n   })\n-  unsubscribe()\n \n-  // Filter issues and patches by authors (maintainers + repo author)\n-  const issueFilters = {\n-    kinds: [GIT_ISSUE],\n-    \"#a\": repoAuthors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n-  }\n+  // Create event stores that watch the repository\n+  // These stores watch for events matching the repo address pattern\n+  // When maintainer events are loaded (via the load() call below), they're added to the repository\n+  // The derived stores (issues, patches, etc.) then filter these events based on current authors\n+  const allIssueEvents = deriveEvents(repository, {\n+    filters: [{\n+      kinds: [GIT_ISSUE],\n+      // Note: We filter by repo address in the derived store below, not here\n+      // This allows us to see all events loaded for this repo (owner + maintainers)\n+    }],\n+  })\n \n-  const patchFilters = {\n-    kinds: [GIT_PATCH],\n-    \"#a\": repoAuthors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n-  }\n+  const allPatchEvents = deriveEvents(repository, {\n+    filters: [{\n+      kinds: [GIT_PATCH],\n+    }],\n+  })\n \n-  const pullRequestFilters = {\n-    kinds: [GIT_PULL_REQUEST],\n-    \"#a\": repoAuthors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n-  }\n+  const allPullRequestEvents = deriveEvents(repository, {\n+    filters: [{\n+      kinds: [GIT_PULL_REQUEST],\n+    }],\n+  })\n \n-  const statusFilters = {\n-    kinds: [GIT_STATUS_OPEN, GIT_STATUS_DRAFT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE],\n-    \"#a\": repoAuthors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n-  }\n-  // Load issues and patches\n-  await load({\n-    relays: relayListFromUrl as string[],\n-    filters: [issueFilters, patchFilters, pullRequestFilters, statusFilters],\n+  const allStatusEvents = deriveEvents(repository, {\n+    filters: [{\n+      kinds: [GIT_STATUS_OPEN, GIT_STATUS_DRAFT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE],\n+    }],\n   })\n \n-  // Create derived stores that will include all issues/patches\n-  // The Repo class will filter to only those matching its canonical identity\n-  const issues: Readable\u003cIssueEvent[]\u003e = derived(\n-    deriveEvents(repository, {\n-      filters: [issueFilters],\n+  // Load initial data in background (don't await - let it load asynchronously)\n+  const allReposFilter = {\n+    kinds: [GIT_REPO_ANNOUNCEMENT],\n+    \"#d\": [repoName],\n+  }\n+\n+  // Start loading with initial authors\n+  Promise.all([\n+    repoLoadPromise,\n+    load({\n+      relays: relayListFromUrl as string[],\n+      filters: [allReposFilter],\n+    }),\n+    load({\n+      relays: relayListFromUrl as string[],\n+      filters: [\n+        {\n+          kinds: [GIT_ISSUE],\n+          \"#a\": [`${GIT_REPO_ANNOUNCEMENT}:${decoded.pubkey}:${repoName}`],\n+        },\n+        {\n+          kinds: [GIT_PATCH],\n+          \"#a\": [`${GIT_REPO_ANNOUNCEMENT}:${decoded.pubkey}:${repoName}`],\n+        },\n+        {\n+          kinds: [GIT_PULL_REQUEST],\n+          \"#a\": [`${GIT_REPO_ANNOUNCEMENT}:${decoded.pubkey}:${repoName}`],\n+        },\n+        {\n+          kinds: [GIT_STATUS_OPEN, GIT_STATUS_DRAFT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE],\n+          \"#a\": [`${GIT_REPO_ANNOUNCEMENT}:${decoded.pubkey}:${repoName}`],\n+        },\n+      ],\n     }),\n-    events =\u003e (events || []) as IssueEvent[],\n+  ]).then(() =\u003e {\n+    // Reactively load data when authors change (including when maintainers are discovered)\n+    // This subscription will be cleaned up automatically when the route changes\n+    repoAuthors.subscribe((authors) =\u003e {\n+      // Only load if we have more than just the initial pubkey\n+      if (authors.length \u003e 1) {\n+        // Maintainers loaded, load with full author list\n+        load({\n+          relays: relayListFromUrl as string[],\n+          filters: [\n+            {\n+              kinds: [GIT_ISSUE],\n+              \"#a\": authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n+            },\n+            {\n+              kinds: [GIT_PATCH],\n+              \"#a\": authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n+            },\n+            {\n+              kinds: [GIT_PULL_REQUEST],\n+              \"#a\": authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n+            },\n+            {\n+              kinds: [GIT_STATUS_OPEN, GIT_STATUS_DRAFT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE],\n+              \"#a\": authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n+            },\n+          ],\n+        }).catch(() =\u003e {}) // Ignore errors - this is background loading\n+      }\n+    })\n+  }).catch(() =\u003e {}) // Don't block on errors\n+\n+  // Create derived stores that filter events reactively based on current authors\n+  // This ensures we include events from maintainers when they're discovered\n+  // Layer 2: Filter events by repo address (owner + maintainers)\n+  // The address tag format is: [\"a\", \"kind:pubkey:identifier\"]\n+  // So we check if the event's address matches any of our current authors' addresses\n+  const issues: Readable\u003cIssueEvent[]\u003e = derived(\n+    [allIssueEvents, repoAuthors],\n+    ([events, authors]) =\u003e {\n+      const authorAddresses = new Set(authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`))\n+      return (events || []).filter((event: TrustedEvent) =\u003e {\n+        const addressTag = event.tags.find((t: string[]) =\u003e t[0] === \"a\")\n+        // Check if event's address matches any of our current authors (owner + maintainers)\n+        return addressTag \u0026\u0026 authorAddresses.has(addressTag[1])\n+      }) as IssueEvent[]\n+    },\n   )\n \n   const patches: Readable\u003cPatchEvent[]\u003e = derived(\n-    deriveEvents(repository, {\n-      filters: [patchFilters],\n-    }),\n-    events =\u003e (events || []) as PatchEvent[],\n+    [allPatchEvents, repoAuthors],\n+    ([events, authors]) =\u003e {\n+      const authorAddresses = new Set(authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`))\n+      return (events || []).filter((event: TrustedEvent) =\u003e {\n+        const addressTag = event.tags.find((t: string[]) =\u003e t[0] === \"a\")\n+        return addressTag \u0026\u0026 authorAddresses.has(addressTag[1])\n+      }) as PatchEvent[]\n+    },\n   )\n \n   const pullRequests: Readable\u003cPullRequestEvent[]\u003e = derived(\n-    deriveEvents(repository, {\n-      filters: [pullRequestFilters],\n-    }),\n-    events =\u003e (events || []) as PullRequestEvent[],\n+    [allPullRequestEvents, repoAuthors],\n+    ([events, authors]) =\u003e {\n+      const authorAddresses = new Set(authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`))\n+      return (events || []).filter((event: TrustedEvent) =\u003e {\n+        const addressTag = event.tags.find((t: string[]) =\u003e t[0] === \"a\")\n+        return addressTag \u0026\u0026 authorAddresses.has(addressTag[1])\n+      }) as PullRequestEvent[]\n+    },\n   )\n \n-  const statusEvents: Readable\u003cany[]\u003e = derived(\n-    deriveEvents(repository, {\n-      filters: [statusFilters],\n-    }),\n-    events =\u003e events || [],\n+  const statusEvents: Readable\u003cStatusEvent[]\u003e = derived(\n+    [allStatusEvents, repoAuthors],\n+    ([events, authors]) =\u003e {\n+      const authorAddresses = new Set(authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`))\n+      return (events || []).filter((event: TrustedEvent) =\u003e {\n+        const addressTag = event.tags.find((t: string[]) =\u003e t[0] === \"a\")\n+        return addressTag \u0026\u0026 authorAddresses.has(addressTag[1])\n+      }) as StatusEvent[]\n+    },\n   )\n \n   // Create statusEventsByRoot map\n-  const statusEventsByRoot: Readable\u003cMap\u003cstring, any[]\u003e\u003e = derived(\n+  const statusEventsByRoot: Readable\u003cMap\u003cstring, StatusEvent[]\u003e\u003e = derived(\n     statusEvents,\n     events =\u003e {\n-      const map = new Map\u003cstring, any[]\u003e()\n+      const map = new Map\u003cstring, StatusEvent[]\u003e()\n       for (const event of events) {\n         const rootId = getTagValue(\"e\", event.tags)\n         if (rootId) {\n@@ -225,16 +316,73 @@ export const load: LayoutLoad = async ({params}) =\u003e {\n     }\n   )\n \n-  const emptyArr = derived([], () =\u003e [] as any[])\n+  // Get all root IDs from issues, patches, and PRs reactively\n+  const allRootIds = derived([issues, patches, pullRequests], ([issueEvents, patchEvents, prEvents]) =\u003e {\n+    const ids: string[] = []\n+    if (issueEvents) ids.push(...issueEvents.map((issue: IssueEvent) =\u003e issue.id))\n+    if (patchEvents) ids.push(...patchEvents.map((patch: PatchEvent) =\u003e patch.id))\n+    if (prEvents) ids.push(...prEvents.map((pr: PullRequestEvent) =\u003e pr.id))\n+    return ids\n+  })\n+\n+  // Create comment events store that filters comments by root IDs\n+  // We use a broad filter and then filter reactively based on root IDs\n+  const allCommentEvents = deriveEvents(repository, {\n+    filters: [{\n+      kinds: [COMMENT],\n+    }],\n+  })\n+\n+  const commentEvents: Readable\u003cCommentEvent[]\u003e = derived(\n+    [allCommentEvents, allRootIds],\n+    ([events, rootIds]) =\u003e {\n+      if (rootIds.length === 0) return []\n+      // Filter to only comments that reference our root IDs\n+      return (events || []).filter((event) =\u003e {\n+        const eTags = event.tags.filter((t: string[]) =\u003e t[0] === \"E\" || t[0] === \"e\")\n+        return eTags.some((tag: string[]) =\u003e rootIds.includes(tag[1]))\n+      }).filter(isCommentEvent) as CommentEvent[]\n+    },\n+  )\n+\n+  // Load comments reactively when root IDs are available\n+  // Use a derived store with a side effect to trigger loading\n+  let lastLoadedIds = new Set\u003cstring\u003e()\n+  const commentLoadTrigger = derived(allRootIds, (rootIds) =\u003e {\n+    if (rootIds.length \u003e 0) {\n+      const idsKey = rootIds.sort().join(',')\n+      if (!lastLoadedIds.has(idsKey)) {\n+        lastLoadedIds.add(idsKey)\n+        // Trigger load in background (non-blocking)\n+        load({\n+          relays: relayListFromUrl as string[],\n+          filters: [{\n+            kinds: [COMMENT],\n+            \"#E\": rootIds,\n+          }],\n+        }).catch(() =\u003e {}) // Ignore errors - this is background loading\n+      }\n+    }\n+    return rootIds\n+  })\n+\n+  // Subscribe to trigger the load (this is necessary to trigger the derived store)\n+  // This subscription will be cleaned up automatically when the route changes\n+  commentLoadTrigger.subscribe(() =\u003e {\n+    // The actual loading is handled in the derived store above\n+  })\n+\n+  const emptyRepoStateEvents = derived([], () =\u003e [] as RepoStateEvent[])\n+  const emptyLabelEvents = derived([], () =\u003e [] as LabelEvent[])\n   const repoClass = new Repo({\n     repoEvent,\n     repoStateEvent,\n     issues,\n     patches,\n-    repoStateEvents: emptyArr as unknown as Readable\u003cany[]\u003e,\n+    repoStateEvents: emptyRepoStateEvents as unknown as Readable\u003cRepoStateEvent[]\u003e,\n     statusEvents,\n-    commentEvents: emptyArr as unknown as Readable\u003cany[]\u003e,\n-    labelEvents: emptyArr as unknown as Readable\u003cany[]\u003e,\n+    commentEvents,\n+    labelEvents: emptyLabelEvents as unknown as Readable\u003cLabelEvent[]\u003e,\n   })\n \n   return {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 855343d..c7e7971 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -184,7 +184,7 @@\n   $effect(() =\u003e {\n     if (repoClass) {\n       // Load async data in parallel\n-      loadRepoInfo()\n+        loadRepoInfo()\n     }\n   })\n \n@@ -228,6 +228,8 @@\n \n   async function loadReadme() {\n     try {\n+      // Try to get README - if repo not cloned, that's okay (overview doesn't need clone)\n+      // The getFileContent will attempt to fetch, but won't block if it fails\n       const readmeContent = await repoClass.getFileContent({\n         path: \"README.md\",\n         branch: repoClass.mainBranch?.split(\"/\").pop() || \"master\",\n@@ -236,6 +238,9 @@\n       readme = readmeContent.content\n       renderedReadme = readme ? md.render(readme) : \"\"\n     } catch (e) {\n+      // Silently fail - README is optional and shouldn't block page load\n+      // If repo not cloned, user can still see overview without README\n+      console.debug(\"README: Failed to load (repo may not be cloned, which is fine for overview)\", e)\n     } finally {\n       readmeLoading = false\n     }\n@@ -243,45 +248,41 @@\n \n   async function loadLastCommit() {\n     try {\n-      // Assume Repo already initialized; avoid triggering repo updates here\n-      // Build candidate branches to try in order\n-      const shortMain = repoClass.mainBranch\n-        ? repoClass.mainBranch.split(\"/\").pop() || repoClass.mainBranch\n-        : undefined\n-      const fullMain = repoClass.mainBranch || undefined\n-      const firstBranch = repoClass.branches?.[0]?.name\n-      const candidates = Array.from(new Set([shortMain, fullMain, firstBranch].filter(Boolean))) as string[]\n-      console.debug(\"LatestCommit candidates\", { shortMain, fullMain, firstBranch, candidates })\n-\n-      // Try a few depths to accommodate shallow clones\n-      const depths = [5, 10, 25]\n+      // Use main branch directly - no need to try multiple branches\n+      // Start with small depth (5) for faster loading, only increase if needed\n+      const mainBranch = repoClass.mainBranch\n+      if (!mainBranch) {\n+        commitLoading = false\n+        return\n+      }\n \n-      for (const branchName of candidates) {\n-        for (const depth of depths) {\n-          try {\n-            const res = await repoClass.getCommitHistory({ branch: branchName, depth })\n-            const list = Array.isArray(res) ? res : res?.commits\n-            console.debug(\"LatestCommit attempt\", { branchName, depth, count: list?.length })\n-            if (Array.isArray(list) \u0026\u0026 list.length \u003e 0) {\n-              lastCommit = list[0]\n-              return\n-            }\n-          } catch (e) {\n-            console.debug(\"LatestCommit attempt failed\", { branchName, depth, error: String(e) })\n+      // Try depth 5 first (fast), then 10 if needed, then 25 as fallback\n+      const depths = [5, 10, 25]\n+      \n+      for (const depth of depths) {\n+        try {\n+          const res = await repoClass.getCommitHistory({ branch: mainBranch, depth })\n+          const list = Array.isArray(res) ? res : res?.commits\n+          if (Array.isArray(list) \u0026\u0026 list.length \u003e 0) {\n+            lastCommit = list[0]\n+            commitLoading = false\n+            return\n           }\n+        } catch (e) {\n+          // If repo not cloned, that's okay - commit history is optional for overview\n+          // Don't trigger clone just for commit history\n+          if (String(e).includes(\"not cloned\") || String(e).includes(\"Repository not\")) {\n+            console.debug(\"LatestCommit: Repository not cloned, skipping (overview page doesn't need clone)\")\n+            commitLoading = false\n+            return\n+          }\n+          // Try next depth on other errors\n+          console.debug(\"LatestCommit attempt failed\", { depth, error: String(e) })\n         }\n       }\n-      // Final fallback: let Repo resolve the branch internally\n-      try {\n-        const res = await repoClass.getCommitHistory({ depth: 25 } as any)\n-        const list = Array.isArray(res) ? res : res?.commits\n-        console.debug(\"LatestCommit final fallback\", { count: list?.length })\n-        if (Array.isArray(list) \u0026\u0026 list.length \u003e 0) {\n-          lastCommit = list[0]\n-          return\n-        }\n-      } catch {}\n     } catch (e) {\n+      // Silently fail - commit history is optional\n+      console.debug(\"LatestCommit: Failed to load\", e)\n     } finally {\n       commitLoading = false\n     }\n@@ -734,3 +735,4 @@\n     {/if}\n   {/if}\n \u003c/div\u003e\n+\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex f791a9c..e668727 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -14,6 +14,11 @@\n   let error: string | null = $state(null)\n   let files: Promise\u003cFileEntry[]\u003e = $state(Promise.resolve([]))\n   let path = $state\u003cstring | undefined\u003e(undefined)\n+  \n+  // Clone progress state - only show when actually cloning\n+  let isCloning = $state(false)\n+  let cloneProgress = $state\u003cstring\u003e(\"\")\n+  let cloneProgressPercent = $state\u003cnumber | undefined\u003e(undefined)\n \n   const rootDir: FileEntry = $state({\n     name: \".\",\n@@ -45,9 +50,68 @@\n     $state([])\n   let loadingRefs = $state(true)\n \n+  // Check if repo is cloned and clone if needed (only on code tab)\n+  $effect(() =\u003e {\n+    if (!repoClass || !repoClass.workerManager?.isReady) return\n+    \n+    ;(async () =\u003e {\n+      try {\n+        const isCloned = await repoClass.workerManager.isRepoCloned({\n+          repoId: repoClass.key\n+        })\n+        \n+        if (!isCloned) {\n+          // Show clone progress\n+          isCloning = true\n+          cloneProgress = \"Initializing repository...\"\n+          \n+          // Set up progress callback using WorkerManager's API\n+          const originalCallback = repoClass.workerManager.setProgressCallback.bind(repoClass.workerManager)\n+          repoClass.workerManager.setProgressCallback((progressEvent) =\u003e {\n+            if (progressEvent.repoId === repoClass.key) {\n+              cloneProgress = progressEvent.phase || \"Cloning repository...\"\n+              cloneProgressPercent = progressEvent.progress\n+            }\n+          })\n+          \n+          try {\n+            const cloneUrls = repoClass.cloneUrls\n+            if (cloneUrls.length === 0) {\n+              throw new Error(\"No clone URLs found for repository\")\n+            }\n+            \n+            const result = await repoClass.workerManager.smartInitializeRepo({\n+              repoId: repoClass.key,\n+              cloneUrls,\n+              forceUpdate: false\n+            })\n+            \n+            if (!result.success) {\n+              throw new Error(result.error || \"Repository initialization failed\")\n+            }\n+          } finally {\n+            // Restore original callback (or clear it)\n+            repoClass.workerManager.setProgressCallback(() =\u003e {})\n+            isCloning = false\n+            cloneProgress = \"\"\n+            cloneProgressPercent = undefined\n+          }\n+        }\n+      } catch (error) {\n+        console.error(\"Failed to initialize repository:\", error)\n+        pushToast({\n+          message: `Failed to initialize repository: ${error instanceof Error ? error.message : \"Unknown error\"}`,\n+          theme: \"error\",\n+        })\n+        isCloning = false\n+        error = error instanceof Error ? error.message : \"Failed to initialize repository\"\n+      }\n+    })()\n+  })\n+\n   // Load refs using the unified API\n   $effect(() =\u003e {\n-    if (repoClass) {\n+    if (repoClass \u0026\u0026 !isCloning) {\n       loadingRefs = true\n       repoClass\n         .getAllRefsWithFallback()\n@@ -161,7 +225,23 @@\n \n \u003cdiv class=\"mt-2 rounded-lg border border-border bg-card\"\u003e\n   \u003cdiv class=\"p-4\"\u003e\n-    {#if loading}\n+    {#if isCloning}\n+      \u003cdiv class=\"flex flex-col items-center justify-center py-12 space-y-4\"\u003e\n+        \u003cSpinner\u003eCloning repository...\u003c/Spinner\u003e\n+        \u003cdiv class=\"text-center space-y-2\"\u003e\n+          \u003cp class=\"text-lg font-medium\"\u003e{cloneProgress}\u003c/p\u003e\n+          {#if cloneProgressPercent !== undefined}\n+            \u003cdiv class=\"w-64 bg-gray-200 rounded-full h-2.5 dark:bg-gray-700\"\u003e\n+              \u003cdiv \n+                class=\"bg-blue-600 h-2.5 rounded-full transition-all duration-300\" \n+                style=\"width: {Math.round(cloneProgressPercent * 100)}%\"\n+              \u003e\u003c/div\u003e\n+            \u003c/div\u003e\n+            \u003cp class=\"text-sm text-muted-foreground\"\u003e{Math.round(cloneProgressPercent * 100)}%\u003c/p\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    {:else if loading}\n       \u003cSpinner {loading}\u003eLoading files...\u003c/Spinner\u003e\n     {:else if error}\n       \u003cdiv class=\"text-red-500\"\u003e{error}\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.ts b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.ts\nindex eb35dcb..e70dffd 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.ts\n@@ -17,12 +17,6 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n   const {repoClass} = await parent()\n   const {deriveEvents} = await import(\"@welshman/store\")\n   const {repository} = await import(\"@welshman/app\")\n-  const {load} = await import(\"@welshman/net\")\n-\n-  const commentFilter = {\n-    kinds: [COMMENT],\n-    \"#E\": [...repoClass.issues.map((issue: IssueEvent) =\u003e issue.id)],\n-  }\n \n   const statusEventFilter = {\n     kinds: [\n@@ -34,22 +28,20 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n     \"#e\": [...repoClass.issues.map((issue: IssueEvent) =\u003e issue.id)],\n   }\n \n-\n-  console.log(repoClass.repoEvent)\n-  const issueFilter = {\n-    kinds: [GIT_ISSUE],\n-    \"#a\": [Address.fromEvent(repoClass.repoEvent!).toString()],\n-  }\n-\n   const statusEvents = deriveEvents(repository, {filters: [statusEventFilter]})\n \n   const comments = derived(\n-    deriveEvents(repository, {filters: [commentFilter]}),\n+    deriveEvents(repository, {\n+      filters: [{\n+        kinds: [COMMENT],\n+        \"#E\": [...repoClass.issues.map((issue: IssueEvent) =\u003e issue.id)],\n+      }],\n+    }),\n     events =\u003e events.filter(isCommentEvent) as CommentEvent[],\n   )\n \n-  // Group status events by root ID for easier lookup\n-  const statusEventsByRoot = derived(statusEvents, events =\u003e {\n+  // Group status events by root ID for easier lookup (reactive, loads as events arrive)\n+  const localStatusEventsByRoot = derived(statusEvents, events =\u003e {\n     const map = new Map\u003cstring, any[]\u003e()\n     for (const event of events) {\n       const rootTag = event.tags.find((t: string[]) =\u003e t[0] === \"e\" \u0026\u0026 t[3] === \"root\")\n@@ -64,18 +56,10 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n     return map\n   })\n \n-  await load({\n-    relays: repoClass.relays,\n-    filters: [commentFilter, statusEventFilter, issueFilter],\n-  })\n-\n   return {\n     comments,\n     statusEvents,\n-    statusEventsByRoot,\n-    issueFilter,\n-    commentFilter,\n-    statusEventFilter,\n+    statusEventsByRoot: localStatusEventsByRoot, // Reactive store that loads as events arrive\n     repoRelays: repoClass.relays,\n   }\n }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 2aa05f2..a5edd0c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -229,7 +229,7 @@\n   }\n \n   $effect(() =\u003e {\n-    if (repoClass.patches) {\n+    if (repoClass.patches \u0026\u0026 patchFilter \u0026\u0026 pullRequestFilter) {\n       const tryStart = () =\u003e {\n         if (element) {\n           makeFeed({\n@@ -247,6 +247,13 @@\n         }\n       }\n       tryStart()\n+      // Set loading to false immediately if we have patches already\n+      // makeFeed will handle incremental loading\n+      if (patchList.length \u003e 0) {\n+        loading = false\n+      }\n+    } else if (repoClass.patches \u0026\u0026 repoClass.patches.length === 0) {\n+      // No patches, so we're done loading\n       loading = false\n     }\n   })\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\nindex fe52436..b4ee3ba 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\n@@ -22,12 +22,6 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n   const {repoClass, pullRequests} = await parent()\n   const {deriveEvents} = await import(\"@welshman/store\")\n   const {repository} = await import(\"@welshman/app\")\n-  const {load} = await import(\"@welshman/net\")\n-\n-  const commentFilter = {\n-    kinds: [COMMENT],\n-    \"#E\": [...repoClass.patches.map((patch: PatchEvent) =\u003e patch.id)],\n-  }\n \n   const statusEventFilter = {\n     kinds: [\n@@ -39,25 +33,15 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n     \"#e\": [...repoClass.patches.map((patch: PatchEvent) =\u003e patch.id)],\n   }\n \n-  const patchFilter = {\n-    kinds: [GIT_PATCH],\n-    \"#a\": [Address.fromEvent(repoClass.repoEvent!).toString()],\n-  }\n-\n-  const pullRequestFilter = {\n-    kinds: [GIT_PULL_REQUEST],\n-    \"#a\": [Address.fromEvent(repoClass.repoEvent!).toString()],\n-  }\n-\n-  await load({\n-    relays: repoClass.relays,\n-    filters: [commentFilter, statusEventFilter, patchFilter, pullRequestFilter],\n-  })\n-\n   const statusEvents = deriveEvents(repository, {filters: [statusEventFilter]})\n \n   const comments = derived(\n-    deriveEvents(repository, {filters: [commentFilter]}),\n+    deriveEvents(repository, {\n+      filters: [{\n+        kinds: [COMMENT],\n+        \"#E\": [...repoClass.patches.map((patch: PatchEvent) =\u003e patch.id)],\n+      }],\n+    }),\n     events =\u003e events.filter(isCommentEvent) as CommentEvent[],\n   )\n \n@@ -79,6 +63,17 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n \n   const uniqueAuthors = new Set(repoClass.patches.map((patch: PatchEvent) =\u003e patch.pubkey))\n \n+  // Create filters for makeFeed (needed for incremental loading)\n+  const patchFilter = {\n+    kinds: [GIT_PATCH],\n+    \"#a\": [Address.fromEvent(repoClass.repoEvent!).toString()],\n+  }\n+\n+  const pullRequestFilter = {\n+    kinds: [GIT_PULL_REQUEST],\n+    \"#a\": [Address.fromEvent(repoClass.repoEvent!).toString()],\n+  }\n+\n   return {\n     comments,\n     statusEvents,\n@@ -86,5 +81,6 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n     patchFilter,\n     pullRequestFilter,\n     uniqueAuthors,\n+    repoRelays: repoClass.relays,\n   }\n }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 2513509..779274c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -499,10 +499,35 @@\n     showMergeDialog = false\n     isMerging = true\n     mergeProgress = 0\n-    mergeStep = \"Preparing merge...\"\n+    mergeStep = \"Ensuring latest repository state...\"\n     mergeError = null\n     mergeSuccess = false\n \n+    // Strategic sync point: Ensure we have latest state before merging\n+    try {\n+      const cloneUrls = repoClass.cloneUrls\n+      if (cloneUrls.length \u003e 0) {\n+        mergeStep = \"Syncing with remote...\"\n+        mergeProgress = 5\n+        const syncResult = await repoClass.workerManager.syncWithRemote({\n+          repoId: repoClass.key,\n+          cloneUrls,\n+          branch: repoClass.mainBranch,\n+        })\n+        \n+        if (!syncResult.success \u0026\u0026 !syncResult.error?.includes(\"Repository not cloned\")) {\n+          console.warn(\"Sync before merge had issues, but continuing:\", syncResult.error)\n+          // Don't fail merge if sync has issues - continue with current state\n+        }\n+      }\n+    } catch (syncError) {\n+      console.warn(\"Failed to sync before merge, but continuing:\", syncError)\n+      // Don't fail merge if sync fails - continue with current state\n+    }\n+\n+    mergeStep = \"Preparing merge...\"\n+    mergeProgress = 10\n+\n     // Get user profile for commit author\n     const authorName = \"Repository Maintainer\" // You might want to get this from user profile\n     const authorEmail = \"maintainer@nostr-git.local\" // You might want to get this from user profile\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-8brp6c03","title":"From 2601de9c443801b847caa4e1aafd78227dc0f2a5 Mon Sep 17 00:00:00 2001","description":"From 2601de9c443801b847caa4e1aafd78227dc0f2a5 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Tue, 4 Nov 2025 16:19:01 +0500\nSubject: [PATCH] feat(ui): add responsive avatars and scroll position persistence\n\n- Update nostr-git submodule to latest commit (72d1024)\n  * Includes BaseItemCard and IssueCard layout improvements\n\n- Avatar.svelte:\n  * Add responsive prop to enable mobile/desktop size variants\n  * Implement responsive sizing with CSS custom properties\n  * Mobile size defaults to 60% of base size (minimum 6)\n  * Use Tailwind responsive classes (sm:) for desktop breakpoint\n  * Maintain backward compatibility - non-responsive avatars unchanged\n\n- Profile.svelte:\n  * Add hideDetails prop to conditionally show/hide profile information\n  * Enable responsive avatar rendering\n  * Wrap profile details section in conditional block\n  * Allows avatar-only display when details are not needed\n\n- +layout.svelte (git repo):\n  * Add scroll position persistence for issues page\n  * Save scroll position to sessionStorage when navigating away\n  * Restore scroll position when returning to issues page\n  * Use double requestAnimationFrame for proper timing after content render\n  * Bind pageContentElement to PageContent for scroll management\n  * Improve UX by maintaining user's scroll position across navigation\n\nThese changes improve mobile responsiveness and user experience by preserving\nscroll context during navigation.\n---\n packages/nostr-git                                      |  2 +-\n src/app/components/Profile.svelte                       | 45 ++++++++++++++++++++++++---------------------\n src/lib/components/Avatar.svelte                        | 32 +++++++++++++++++++++++++++++---\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte | 36 ++++++++++++++++++++++++++++++++++--\n 4 files changed, 88 insertions(+), 27 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex a1859c4..72d1024 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit a1859c423f0420fa8ca1f618d20e1b51c6eed02a\n+Subproject commit 72d1024d12f27d399a2329cdf3e0e53a61359d64\ndiff --git a/src/app/components/Profile.svelte b/src/app/components/Profile.svelte\nindex 6adc0e6..d9bbb3e 100644\n--- a/src/app/components/Profile.svelte\n+++ b/src/app/components/Profile.svelte\n@@ -22,9 +22,10 @@\n     url?: string\n     showPubkey?: boolean\n     avatarSize?: number\n+    hideDetails?: boolean\n   }\n \n-  const {pubkey, url, showPubkey, avatarSize = 10}: Props = $props()\n+  const {pubkey, url, showPubkey, avatarSize = 10, hideDetails = false}: Props = $props()\n \n   const relays = removeNil([url])\n   const profile = deriveProfile(pubkey, relays)\n@@ -38,27 +39,29 @@\n \n \u003cdiv class=\"flex max-w-full items-start gap-3\"\u003e\n   \u003cButton onclick={openProfile} class=\"py-1\"\u003e\n-    \u003cAvatar src={$profile?.picture} size={avatarSize} /\u003e\n+    \u003cAvatar src={$profile?.picture} size={avatarSize} responsive={true} /\u003e\n   \u003c/Button\u003e\n-  \u003cdiv class=\"flex min-w-0 flex-col\"\u003e\n-    \u003cdiv class=\"flex items-center gap-2\"\u003e\n-      \u003cButton onclick={openProfile} class=\"text-bold overflow-hidden text-ellipsis\"\u003e\n-        {$profileDisplay}\n-      \u003c/Button\u003e\n-      \u003cWotScore {pubkey} /\u003e\n-    \u003c/div\u003e\n-    {#if $handle}\n-      \u003cdiv class=\"overflow-hidden text-ellipsis text-sm opacity-75\"\u003e\n-        {displayHandle($handle)}\n-      \u003c/div\u003e\n-    {/if}\n-    {#if showPubkey}\n-      \u003cdiv class=\"flex items-center gap-1 overflow-hidden text-ellipsis text-xs opacity-60\"\u003e\n-        {displayPubkey(pubkey)}\n-        \u003cButton onclick={copyPubkey} class=\"pt-1\"\u003e\n-          \u003cIcon size={3} icon={Copy} /\u003e\n+  {#if !hideDetails}\n+    \u003cdiv class=\"flex min-w-0 flex-col\"\u003e\n+      \u003cdiv class=\"flex items-center gap-2\"\u003e\n+        \u003cButton onclick={openProfile} class=\"text-bold overflow-hidden text-ellipsis\"\u003e\n+          {$profileDisplay}\n         \u003c/Button\u003e\n+        \u003cWotScore {pubkey} /\u003e\n       \u003c/div\u003e\n-    {/if}\n-  \u003c/div\u003e\n+      {#if $handle}\n+        \u003cdiv class=\"overflow-hidden text-ellipsis text-sm opacity-75\"\u003e\n+          {displayHandle($handle)}\n+        \u003c/div\u003e\n+      {/if}\n+      {#if showPubkey}\n+        \u003cdiv class=\"flex items-center gap-1 overflow-hidden text-ellipsis text-xs opacity-60\"\u003e\n+          {displayPubkey(pubkey)}\n+          \u003cButton onclick={copyPubkey} class=\"pt-1\"\u003e\n+            \u003cIcon size={3} icon={Copy} /\u003e\n+          \u003c/Button\u003e\n+        \u003c/div\u003e\n+      {/if}\n+    \u003c/div\u003e\n+  {/if}\n \u003c/div\u003e\ndiff --git a/src/lib/components/Avatar.svelte b/src/lib/components/Avatar.svelte\nindex 74e69a4..8960225 100644\n--- a/src/lib/components/Avatar.svelte\n+++ b/src/lib/components/Avatar.svelte\n@@ -3,11 +3,37 @@\n   import Icon from \"@lib/components/Icon.svelte\"\n   import UserRounded from \"@assets/icons/user-rounded.svg?dataurl\"\n \n-  const {src = \"\", size = 7, icon = UserRounded, style = \"\", ...restProps} = $props()\n+  const {src = \"\", size = 7, icon = UserRounded, style = \"\", responsive = false, ...restProps} = $props()\n \n   let element: HTMLElement\n \n   const rem = $derived(size * 4)\n+  \n+  // Calculate responsive sizes if responsive prop is true\n+  const mobileSize = $derived(responsive ? Math.max(6, Math.round(size * 0.6)) : size)\n+  const mobileSizePx = $derived(mobileSize * 4)\n+  const desktopSizePx = $derived(size * 4)\n+  \n+  // Responsive classes for Tailwind using CSS custom properties\n+  const responsiveClasses = $derived(\n+    responsive\n+      ? \"!w-[var(--avatar-size-mobile)] !h-[var(--avatar-size-mobile)] !min-w-[var(--avatar-size-mobile)] sm:!w-[var(--avatar-size-desktop)] sm:!h-[var(--avatar-size-desktop)] sm:!min-w-[var(--avatar-size-desktop)]\"\n+      : \"\"\n+  )\n+  \n+  // Responsive style with CSS custom properties\n+  const responsiveStyle = $derived(\n+    responsive\n+      ? `--avatar-size-mobile: ${mobileSizePx}px; --avatar-size-desktop: ${desktopSizePx}px;`\n+      : \"\"\n+  )\n+  \n+  // Inline size styles - only needed when not responsive (responsive uses Tailwind classes)\n+  const sizeStyle = $derived(\n+    responsive\n+      ? \"\"\n+      : `width: ${rem}px; height: ${rem}px; min-width: ${rem}px;`\n+  )\n \n   onMount(() =\u003e {\n     if (src) {\n@@ -24,7 +50,7 @@\n \n \u003cdiv\n   bind:this={element}\n-  class=\"{restProps.class} relative !flex shrink-0 items-center justify-center overflow-hidden rounded-full bg-cover bg-center\"\n-  style=\"width: {rem}px; height: {rem}px; min-width: {rem}px; background-image: url({src}); {style}\"\u003e\n+  class=\"{restProps.class} {responsiveClasses} relative !flex shrink-0 items-center justify-center overflow-hidden rounded-full bg-cover bg-center\"\n+  style=\"{sizeStyle} background-image: url({src}); {responsiveStyle} {style}\"\u003e\n   \u003cIcon {icon} class={src ? \"hidden\" : \"\"} size={Math.round(size * 0.8)} /\u003e\n \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 451f59f..5cb6b16 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -42,6 +42,10 @@\n \n   // Refresh state\n   let isRefreshing = $state(false)\n+  \n+  // Scroll position management\n+  let pageContentElement = $state\u003cElement | undefined\u003e()\n+  const scrollStorageKey = `repoScroll:${id}`\n \n   // --- GRASP servers (user profile) ---\n   const graspServersFilter = {\n@@ -69,11 +73,39 @@\n       if (to.url.pathname.startsWith(base)) {\n         updateRepo()\n       }\n+\n+      if (to.route.id === \"/spaces/[relay]/git/[id=naddr]/issues\") {\n+        // Restore scroll position for issues page\n+        const savedScroll = sessionStorage.getItem(scrollStorageKey)\n+        if (savedScroll \u0026\u0026 pageContentElement) {\n+          const scrollPosition = parseInt(savedScroll, 10)\n+          // Double requestAnimationFrame ensures the scroll restoration happens after:\n+          // 1. First RAF: Schedule callback for next paint cycle\n+          // 2. Second RAF: Execute after that paint has completed and content is fully rendered\n+          // This prevents scroll jumping and ensures all issue cards are in the DOM\n+          requestAnimationFrame(() =\u003e {\n+            requestAnimationFrame(() =\u003e {\n+              if (pageContentElement) {\n+                pageContentElement.scrollTop = scrollPosition\n+              }\n+            })\n+          })\n+        }\n+      }\n     } catch {}\n   })\n \n   // Pre-emptive refresh when navigating within the same repo scope\n-  beforeNavigate(({to}) =\u003e {\n+  beforeNavigate(({from, to}) =\u003e {\n+\n+    if (from?.route.id === \"/spaces/[relay]/git/[id=naddr]/issues\") {\n+      // Save scroll position when leaving issues page\n+      if (pageContentElement) {\n+        const scrollPosition = pageContentElement.scrollTop\n+        sessionStorage.setItem(scrollStorageKey, scrollPosition.toString())\n+      }\n+    }\n+\n     try {\n       if (!to) return\n       const base = repoBasePath()\n@@ -299,7 +331,7 @@\n   {/snippet}\n \u003c/PageBar\u003e\n \n-\u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n+\u003cPageContent bind:element={pageContentElement} class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n   {#if repoClass === undefined}\n     \u003cdiv class=\"p-4 text-center\"\u003eLoading repository...\u003c/div\u003e\n   {:else if !repoClass}\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-8crh3clz","title":"From 019e03f15b71eeb74751ee8311982a5876363de7 Mon Sep 17 00:00:00 2001","description":"From 019e03f15b71eeb74751ee8311982a5876363de7 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 16 Jun 2025 17:52:30 -0700\nSubject: [PATCH 1/1] feat: implement directory navigation and error handling in git repository viewer\n\n---\n packages/nostr-git                                         |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte    | 18 +++++++++---------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts        | 50 +++++++++++++++-----------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte      |  7 ++++++-\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte | 55 ++++++++++++++++++++++++++++++++++++++++++++++++++-----\n 5 files changed, 81 insertions(+), 51 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex b936f21..9518809 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit b936f2148a5391d625d7a7aa1dd8f0424379c486\n+Subproject commit 95188095ac3ae7ee64691f95e2692dc106076f30\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex e88a9a1..62bb304 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -1,10 +1,9 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {FunctionProvider, Repo, RepoHeader, RepoTab, toast} from \"@nostr-git/ui\"\n+  import {FunctionProvider, RepoHeader, RepoTab, toast} from \"@nostr-git/ui\"\n   import {ConfigProvider} from \"@nostr-git/ui\"\n   import {FileCode, GitBranch, CircleAlert, GitPullRequest} from \"@lucide/svelte\"\n   import {page} from \"$app/stores\"\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n-  import Button from \"@lib/components/Button.svelte\"\n   import Avatar from \"@lib/components/Avatar.svelte\"\n   import Divider from \"@lib/components/Divider.svelte\"\n   import Input from \"@lib/components/Field.svelte\"\n@@ -14,8 +13,7 @@\n \n   const {id, relay} = $page.params\n   let {data, children} = $props()\n-\n-  const {repoClass, eventStore, functionRegistry} = data\n+  const {repoClass, functionRegistry} = data\n \n   let activeTab: string | undefined = $page.url.pathname.split(\"/\").pop()\n   const encodedRelay = encodeURIComponent(relay)\n@@ -24,7 +22,10 @@\n   $effect(() =\u003e {\n     if ($toast.length \u003e 0) {\n       $toast.forEach(t =\u003e {\n-        pushToast({message: t.description!, theme: t.variant === \"error\" ? \"error\" : undefined})\n+        pushToast({\n+          message: t.description!,\n+          theme: t.variant === \"error\" ? \"error\" : undefined,\n+        })\n       })\n       toast.clear()\n     }\n@@ -35,12 +36,12 @@\n \u003c/script\u003e\n \n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n-  {#if $eventStore === undefined}\n+  {#if repoClass === undefined}\n     \u003cdiv class=\"p-4 text-center\"\u003eLoading repository...\u003c/div\u003e\n-  {:else if !$eventStore}\n+  {:else if !repoClass}\n     \u003cdiv class=\"p-4 text-center text-red-500\"\u003eRepository not found.\u003c/div\u003e\n   {:else}\n-    \u003cRepoHeader event={$eventStore as any} {activeTab} isRepoWatched={false}\u003e\n+    \u003cRepoHeader event={repoClass.repoEvent} {activeTab} isRepoWatched={false}\u003e\n       {#snippet children(activeTab: string)}\n         \u003cRepoTab\n           tabValue={id}\n@@ -92,7 +93,6 @@\n     \u003cFunctionProvider functions={functionRegistry}\u003e\n       \u003cConfigProvider\n         components={{\n-          Button: Button as typeof import(\"@nostr-git/ui\").Button,\n           AvatarImage: Avatar as typeof import(\"@nostr-git/ui\").AvatarImage,\n           Separator: Divider as typeof import(\"@nostr-git/ui\").Separator,\n           Input: Input as typeof import(\"@nostr-git/ui\").Input,\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nindex 89a06cb..b5a3c26 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -1,49 +1,34 @@\n+export const ssr = false;\n import { derived, get, type Readable } from 'svelte/store';\n import {\n     type CommentEvent,\n     type IssueEvent,\n     type PatchEvent,\n+    type RepoAnnouncementEvent,\n+    type RepoStateEvent,\n } from '@nostr-git/shared-types';\n import { GIT_ISSUE, GIT_PATCH } from '@welshman/util';\n import { nip19 } from 'nostr-tools';\n import type { AddressPointer } from 'nostr-tools/nip19';\n import { nthEq } from '@welshman/lib';\n import { GIT_REPO, GIT_REPO_STATE } from '@src/lib/util.js';\n-import { browser } from '$app/environment';\n-\n-export const ssr = false;\n \n export async function load({ params }) {\n     const { id, relay } = params;\n \n-    // Only import and use browser-specific modules when in browser context\n-    if (!browser) {\n-        // Return minimal data for SSR\n-        return {\n-            repoClass: null,\n-            eventStore: null,\n-            relays: null,\n-            url: null,\n-            repoId: null,\n-            functionRegistry: undefined,\n-        };\n-    }\n-\n     // Dynamic imports to avoid SSR issues\n-    const { deriveNaddrEvent, decodeRelay, INDEXER_RELAYS } = await import('@app/state');\n+    const { decodeRelay, INDEXER_RELAYS } = await import('@app/state');\n     const { deriveEvents } = await import('@welshman/store');\n     const { publishThunk, repository } = await import('@welshman/app');\n     const { load } = await import(\"@welshman/net\");\n-    const { Repo } = await import('@nostr-git/ui'); // Make Repo import dynamic\n+    const { Repo } = await import('@nostr-git/ui');\n \n     const decoded = nip19.decode(id).data as AddressPointer;\n     const repoId = decoded.identifier;\n     const url = decodeRelay(relay);\n \n-    const eventStore = deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay]);\n-\n     const fallbackRelays = INDEXER_RELAYS\n-    const relayList = decoded.relays?.length! \u003e 0 ? decoded.relays : fallbackRelays\n+    const relayList = (decoded.relays?.length ?? 0) \u003e 0 ? decoded.relays : fallbackRelays\n \n     const filters = [{\n         authors: [decoded.pubkey],\n@@ -54,31 +39,26 @@ export async function load({ params }) {\n     await load({ relays: relayList as string[], filters })\n \n     // Combine the separate event stores\n-    const repoAnnouncementEvents = deriveEvents(repository, {\n+    const repoEvent = derived(deriveEvents(repository, {\n         filters: [{\n             authors: [decoded.pubkey],\n             kinds: [GIT_REPO],\n             \"#d\": [decoded.identifier],\n         }]\n-    });\n+    }), (events) =\u003e events[0]) as Readable\u003cRepoAnnouncementEvent\u003e;\n \n-    const repoStateEvents = deriveEvents(repository, {\n+    const repoStateEvent = derived(deriveEvents(repository, {\n         filters: [{\n             authors: [decoded.pubkey],\n             kinds: [GIT_REPO_STATE],\n             \"#d\": [decoded.identifier],\n         }]\n-    });\n-\n-    const repoEvents = derived([repoAnnouncementEvents, repoStateEvents], ([announcements, states]) =\u003e {\n-        const combined = [...(announcements || []), ...(states || [])];\n-        return combined;\n-    });\n+    }), (events) =\u003e events[0]) as Readable\u003cRepoStateEvent\u003e;\n \n     // Get relays from event tags\n-    const relays = derived(eventStore, $eventStore =\u003e {\n-        if ($eventStore) {\n-            const [_, ...relaysList] = $eventStore.tags.find(nthEq(0, \"relays\")) || [];\n+    const relays = derived(repoEvent, re =\u003e {\n+        if (re) {\n+            const [_, ...relaysList] = re.tags.find(nthEq(0, \"relays\")) || [];\n             return relaysList;\n         }\n         return undefined;\n@@ -131,14 +111,14 @@ export async function load({ params }) {\n     };\n \n     const repoClass = new Repo({\n-        repoEvents,\n+        repoEvent,\n+        repoStateEvent,\n         issues,\n         patches,\n     });\n \n     return {\n         repoClass,\n-        eventStore,\n         relays,\n         url,\n         repoId,\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex e93ecc0..109772e 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -5,6 +5,7 @@\n   import {CircleAlert, GitBranch, GitPullRequest, Users} from \"@lucide/svelte\"\n   import {fly} from \"@lib/transition\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n+    import { pushToast } from \"@src/app/toast\"\n \n   let loading = $state(true)\n \n@@ -44,7 +45,6 @@\n     if (repoClass.repoEvent) {\n       repoClass\n         .getFileContent({\n-          branch: repoClass.mainBranch?.split(\"/\").pop() || \"master\",\n           path: \"README.md\",\n         })\n         .then(content =\u003e {\n@@ -52,6 +52,11 @@\n           renderedReadme = readme ? md.render(readme) : \"\"\n           loading = false\n         })\n+        .catch((e) =\u003e {\n+          console.error(e)\n+          pushToast({message: \"Failed to load README.md: \" + e, theme: \"error\"})\n+          loading = false\n+        })\n     }\n   })\n \u003c/script\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex 038857d..5396962 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -8,11 +8,25 @@\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {type FileEntry} from \"@nostr-git/core\"\n+  import {pushToast} from \"@src/app/toast\"\n   const repoClass = getContext\u003cRepo\u003e(\"repoClass\")\n \n   let loading = $state(true)\n   let error: string | null = $state(null)\n   let files: Promise\u003cFileEntry[]\u003e = $state(Promise.resolve([]))\n+  let path = $state\u003cstring | undefined\u003e(undefined)\n+\n+  const rootDir: FileEntry = $state({\n+    name: \".\",\n+    path: \"\",\n+    type: \"directory\",\n+  })\n+\n+  let curDir: FileEntry = $state({\n+    name: \"..\",\n+    path: \"\",\n+    type: \"directory\",\n+  })\n \n   let selectedBranch = $derived.by(() =\u003e {\n     return repoClass.mainBranch\n@@ -22,11 +36,22 @@\n     if (selectedBranch) {\n       files = repoClass.listRepoFiles({\n         branch: selectedBranch?.split(\"/\").pop() || \"master\",\n+        path,\n       })\n       loading = false\n     }\n   })\n \n+  $effect(() =\u003e {\n+    if (path) {\n+      curDir.path = path.split(\"/\").slice(0, -1).join(\"/\")\n+      files = repoClass.listRepoFiles({\n+        branch: selectedBranch?.split(\"/\").pop() || \"master\",\n+        path,\n+      })\n+    }\n+  })\n+\n   let showMenu = $state(false)\n \n   const toggleMenu = () =\u003e {\n@@ -38,10 +63,26 @@\n   }\n \n   const getFileContent = async (path: string) =\u003e {\n-    return await repoClass.getFileContent({\n-      branch: selectedBranch?.split(\"/\").pop() || \"master\",\n-      path,\n-    })\n+    try {\n+      return await repoClass.getFileContent({\n+        branch: selectedBranch?.split(\"/\").pop() || \"master\",\n+        path,\n+      })\n+    } catch (e) {\n+      console.error(e)\n+      pushToast({\n+        message: \"Failed to load file: \" + e,\n+        theme: \"error\",\n+      })\n+      return \"\"\n+    }\n+  }\n+\n+  const setDirectory = (p: string) =\u003e {\n+    if (p !== path) {\n+      console.log(\"setDirectory\", p)\n+      path = p\n+    }\n   }\n \u003c/script\u003e\n \n@@ -82,8 +123,12 @@\n             {#if files.length === 0}\n               \u003cdiv class=\"text-muted-foreground\"\u003eNo files found in this branch.\u003c/div\u003e\n             {:else}\n+              {#if path}\n+              \u003cFileView file={rootDir} {getFileContent} {setDirectory} /\u003e\n+                \u003cFileView file={curDir} {getFileContent} {setDirectory} /\u003e\n+              {/if}\n               {#each files as file}\n-                \u003cFileView {file} {getFileContent} /\u003e\n+                \u003cFileView {file} {getFileContent} {setDirectory} /\u003e\n               {/each}\n             {/if}\n           {/await}\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-8gl6zly3","title":"From 5aa2f4cc2d2c091686f4a1033ca66ec5ed0920d8 Mon Sep 17 00:00:00 2001","description":"From 5aa2f4cc2d2c091686f4a1033ca66ec5ed0920d8 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Wed, 30 Jul 2025 13:32:22 -0700\nSubject: [PATCH 4/4] feat: add default relay publishing and repo settings functionality\n\n---\n packages/nostr-git                                      |  2 +-\n src/app/commands.ts                                     |  8 ++++----\n src/app/components/SignUpKeyConfirm.svelte              |  6 +++++-\n src/app/components/SignUpProfile.svelte                 |  5 +++--\n src/routes/settings/profile/+page.svelte                |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte | 76 +++++++++++++++++++++++++++++++++++++++++++++++-----------------------------\n 6 files changed, 61 insertions(+), 38 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex d6f2fd1..42161e5 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit d6f2fd17cddc608bc6d0e1e981b6e5a85f101ca9\n+Subproject commit 42161e542071106536b5db70d436f799bd3fbc63\ndiff --git a/src/app/commands.ts b/src/app/commands.ts\nindex e932183..ac6ed52 100644\n--- a/src/app/commands.ts\n+++ b/src/app/commands.ts\n@@ -449,7 +449,7 @@ export const publishAlert = async (params: AlertParams) =\u003e\n \n export const postComment = (comment: CommentEvent, relays: string[]) =\u003e {\n   return publishThunk({\n-    relays: relays ?? [],\n+    relays: relays ?? [...INDEXER_RELAYS, ...Router.get().FromUser().getUrls()],\n     event: comment,\n   })\n }\n@@ -457,20 +457,20 @@ export const postComment = (comment: CommentEvent, relays: string[]) =\u003e {\n export const postIssue = (issue: IssueEvent, relays: string[]) =\u003e {\n   return publishThunk({\n     event: issue,\n-    relays: relays ?? [],\n+    relays: relays ?? [...INDEXER_RELAYS, ...Router.get().FromUser().getUrls()],\n   })\n }\n \n export const postStatus = (status: StatusEvent, relays: string[]) =\u003e {\n   return publishThunk({\n-    relays: relays ?? [],\n+    relays: relays ?? [...INDEXER_RELAYS, ...Router.get().FromUser().getUrls()],\n     event: status,\n   })\n }\n \n export const postRepoAnnouncement = (repo: RepoAnnouncementEvent, relays: string[]) =\u003e {\n   return publishThunk({\n-    relays: relays ?? [],\n+    relays: relays ?? [...INDEXER_RELAYS, ...Router.get().FromUser().getUrls()],\n     event: repo,\n   })\n }\n\\ No newline at end of file\ndiff --git a/src/app/components/SignUpKeyConfirm.svelte b/src/app/components/SignUpKeyConfirm.svelte\nindex ee63d5f..23978e8 100644\n--- a/src/app/components/SignUpKeyConfirm.svelte\n+++ b/src/app/components/SignUpKeyConfirm.svelte\n@@ -8,6 +8,8 @@\n   import SignUpProfile from \"@app/components/SignUpProfile.svelte\"\n   import {pushToast} from \"@app/toast\"\n   import {pushModal} from \"@app/modal\"\n+  import {getPublicKey} from \"nostr-tools\"\n+  import {hexToBytes} from \"nostr-tools/utils\"\n \n   type Props = {\n     secret: string\n@@ -15,6 +17,8 @@\n   }\n \n   const {secret, ncryptsec}: Props = $props()\n+  const secretKey = hexToBytes(ncryptsec)\n+  const pubkey = getPublicKey(secretKey)\n \n   const back = () =\u003e history.back()\n \n@@ -24,7 +28,7 @@\n   }\n \n   const next = () =\u003e {\n-    pushModal(SignUpProfile, {secret})\n+    pushModal(SignUpProfile, {secret, pubkey})\n   }\n \u003c/script\u003e\n \ndiff --git a/src/app/components/SignUpProfile.svelte b/src/app/components/SignUpProfile.svelte\nindex 238d5db..a8f74ec 100644\n--- a/src/app/components/SignUpProfile.svelte\n+++ b/src/app/components/SignUpProfile.svelte\n@@ -8,9 +8,10 @@\n \n   type Props = {\n     secret: string\n+    pubkey: string\n   }\n \n-  const {secret}: Props = $props()\n+  const {secret, pubkey}: Props = $props()\n \n   const initialValues = {\n     profile: makeProfile(),\n@@ -34,7 +35,7 @@\n   }\n \u003c/script\u003e\n \n-\u003cProfileEditForm hideAddress {initialValues} {onsubmit}\u003e\n+\u003cProfileEditForm pubkey={pubkey} hideAddress {initialValues} {onsubmit}\u003e\n   {#snippet footer()}\n     \u003cButton type=\"submit\" class=\"btn btn-primary\"\u003eCreate Account\u003c/Button\u003e\n   {/snippet}\ndiff --git a/src/routes/settings/profile/+page.svelte b/src/routes/settings/profile/+page.svelte\nindex 2e872dd..12ac6df 100644\n--- a/src/routes/settings/profile/+page.svelte\n+++ b/src/routes/settings/profile/+page.svelte\n@@ -13,7 +13,7 @@\n   import ProfileDelete from \"@app/components/ProfileDelete.svelte\"\n   import InfoKeys from \"@app/components/InfoKeys.svelte\"\n   import Alerts from \"@app/components/Alerts.svelte\"\n-  import {GIT_CLIENT_ID, PLATFORM_NAME} from \"@app/state\"\n+  import {PLATFORM_NAME} from \"@app/state\"\n   import {pushModal} from \"@app/modal\"\n   import {clip} from \"@app/toast\"\n   import GitAuth from \"@src/app/components/GitAuth.svelte\"\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 462d5a1..29f677c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -1,5 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n-  import { RepoHeader, RepoTab, toast} from \"@nostr-git/ui\"\n+  import {RepoHeader, RepoTab, toast} from \"@nostr-git/ui\"\n   import {ConfigProvider} from \"@nostr-git/ui\"\n   import {FileCode, GitBranch, CircleAlert, GitPullRequest, GitCommit, Layers} from \"@lucide/svelte\"\n   import {page} from \"$app/stores\"\n@@ -13,6 +13,10 @@\n   import {pushToast} from \"@src/app/toast\"\n   import EventActions from \"@src/app/components/EventActions.svelte\"\n   import ReactionSummary from \"@src/app/components/ReactionSummary.svelte\"\n+  import {pushModal} from \"@src/app/modal.js\"\n+  import {EditRepoPanel} from \"@nostr-git/ui\"\n+  import {postRepoAnnouncement} from \"@src/app/commands.js\"\n+  import type {RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n \n   const {id, relay} = $page.params\n \n@@ -21,50 +25,50 @@\n \n   let activeTab: string | undefined = $page.url.pathname.split(\"/\").pop()\n   const encodedRelay = encodeURIComponent(relay)\n-  \n+\n   // Refresh state\n   let isRefreshing = $state(false)\n \n   // Refresh repository function\n   async function refreshRepo() {\n     if (!repoClass || isRefreshing) return\n-    \n+\n     isRefreshing = true\n-    \n+\n     try {\n       // Get clone URLs from the repo event\n       const cloneUrls = repoClass.repoEvent.tags\n-        .filter((tag: string[]) =\u003e tag[0] === 'clone')\n+        .filter((tag: string[]) =\u003e tag[0] === \"clone\")\n         .map((tag: string[]) =\u003e tag[1])\n         .filter(Boolean)\n-      \n+\n       if (cloneUrls.length === 0) {\n-        throw new Error('No clone URLs found for repository')\n+        throw new Error(\"No clone URLs found for repository\")\n       }\n-      \n+\n       // Call syncWithRemote through the repo's worker manager\n       const result = await repoClass.workerManager.syncWithRemote({\n         repoId: repoClass.repoEvent.id,\n         cloneUrls,\n-        branch: repoClass.mainBranch\n+        branch: repoClass.mainBranch,\n       })\n-      \n+\n       if (result.success) {\n         // Show success toast\n         pushToast({\n-          message: `Repository synced with remote (${result.headCommit?.slice(0, 8)})`\n+          message: `Repository synced with remote (${result.headCommit?.slice(0, 8)})`,\n         })\n-        \n+\n         // Reset the repo to refresh all cached data\n         await repoClass.reset()\n       } else {\n-        throw new Error(result.error || 'Sync failed')\n+        throw new Error(result.error || \"Sync failed\")\n       }\n     } catch (error) {\n-      console.error('Failed to refresh repository:', error)\n+      console.error(\"Failed to refresh repository:\", error)\n       pushToast({\n-        message: `Failed to sync repository: ${error instanceof Error ? error.message : 'Unknown error'}`,\n-        theme: 'error'\n+        message: `Failed to sync repository: ${error instanceof Error ? error.message : \"Unknown error\"}`,\n+        theme: \"error\",\n       })\n     } finally {\n       isRefreshing = false\n@@ -73,9 +77,18 @@\n \n   function forkRepo() {\n     if (!repoClass) return\n-    \n     // Fork the repository\n-    repoClass.workerManager.forkAndCloneRepo()\n+    repoClass.workerManager.apiInstance.forkAndCloneRepo()\n+  }\n+\n+  function settingsRepo() {\n+    if (!repoClass) return\n+    pushModal(EditRepoPanel, {\n+      repo: repoClass,\n+      onPublishEvent: (event: RepoAnnouncementEvent) =\u003e {\n+        postRepoAnnouncement(event, [])\n+      },\n+    })\n   }\n \n   // Connect the nostr-git toast store to the toast component\n@@ -84,15 +97,19 @@\n       $toast.forEach(t =\u003e {\n         // The toast store now handles format conversion internally\n         pushToast({\n-          message: t.message || (t.title \u0026\u0026 t.description ? `${t.title}: ${t.description}` : t.title || t.description || ''),\n+          message:\n+            t.message ||\n+            (t.title \u0026\u0026 t.description\n+              ? `${t.title}: ${t.description}`\n+              : t.title || t.description || \"\"),\n           timeout: t.timeout || t.duration,\n-          theme: t.theme || (t.variant === 'destructive' ? 'error' : undefined),\n+          theme: t.theme || (t.variant === \"destructive\" ? \"error\" : undefined),\n         })\n       })\n       toast.clear()\n     }\n   })\n-\n+  \n \u003c/script\u003e\n \n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n@@ -108,7 +125,8 @@\n       {refreshRepo}\n       {isRefreshing}\n       {forkRepo}\n-    \u003e\n+      {settingsRepo}\n+      \u003e\n       {#snippet children(activeTab: string)}\n         \u003cRepoTab\n           tabValue=\"feed\"\n@@ -169,13 +187,13 @@\n     \u003cConfigProvider\n       components={{\n         AvatarImage: Avatar as typeof import(\"@nostr-git/ui\").AvatarImage,\n-          Separator: Divider as typeof import(\"@nostr-git/ui\").Separator,\n-          Input: Input as typeof import(\"@nostr-git/ui\").Input,\n-          Alert: Dialog as typeof import(\"@nostr-git/ui\").Alert,\n-          ProfileComponent: Profile as typeof import(\"@nostr-git/ui\").Profile,\n-          ProfileLink: ProfileLink as typeof import(\"@nostr-git/ui\").ProfileLink,\n-          EventActions: EventActions as typeof import(\"@nostr-git/ui\").EventActions,\n-          ReactionSummary: ReactionSummary as typeof import(\"@nostr-git/ui\").ReactionSummary,\n+        Separator: Divider as typeof import(\"@nostr-git/ui\").Separator,\n+        Input: Input as typeof import(\"@nostr-git/ui\").Input,\n+        Alert: Dialog as typeof import(\"@nostr-git/ui\").Alert,\n+        ProfileComponent: Profile as typeof import(\"@nostr-git/ui\").Profile,\n+        ProfileLink: ProfileLink as typeof import(\"@nostr-git/ui\").ProfileLink,\n+        EventActions: EventActions as typeof import(\"@nostr-git/ui\").EventActions,\n+        ReactionSummary: ReactionSummary as typeof import(\"@nostr-git/ui\").ReactionSummary,\n       }}\u003e\n       {@render children()}\n     \u003c/ConfigProvider\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-8ha92wqa","title":"From 596162cc2324e95c16e9fc1ce28ea4bd0e4dfb0c Mon Sep 17 00:00:00 2001","description":"From 596162cc2324e95c16e9fc1ce28ea4bd0e4dfb0c Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 23 Jun 2025 23:19:36 -0700\nSubject: [PATCH 7/8] feat: implement patch set navigation and filtering controls for git patches\n\n---\n packages/nostr-git                                                      |   2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           | 285 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 202 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------\n 3 files changed, 425 insertions(+), 64 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 97a87ad..ced0a44 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 97a87adc93387f1f5378ab7fd6a0b6bac1f17d7d\n+Subproject commit ced0a443ff4f13e5095277df8893606846885a29\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 1aa6de3..6a02a7c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -1,9 +1,9 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {Button, PatchCard, Repo} from \"@nostr-git/ui\"\n-  import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n-  import {Address, type TrustedEvent} from \"@welshman/util\"\n+  import {Button, PatchCard} from \"@nostr-git/ui\"\n+  import {CalendarDays, Check, Clock, Funnel, GitCommit, Plus, SearchX, User, X} from \"@lucide/svelte\"\n+  import {Address, COMMENT} from \"@welshman/util\"\n   import {nthEq} from \"@welshman/lib\"\n-  import {deriveProfile, repository} from \"@welshman/app\"\n+  import {repository} from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {makeFeed} from \"@src/app/requests\"\n   import {deriveEvents} from \"@welshman/store\"\n@@ -16,39 +16,129 @@\n   } from \"@welshman/util\"\n   import {fly} from \"@lib/transition\"\n   import {load} from \"@welshman/net\"\n-  import {parseStatusEvent, type Patch, type StatusEvent} from \"@nostr-git/shared-types\"\n+  import {getTags, type PatchEvent, type StatusEvent} from \"@nostr-git/shared-types\"\n+  import {parseGitPatchFromEvent} from \"@nostr-git/core\"\n \n   const {data} = $props()\n   const {repoClass} = data\n \n-  const statusFilter = {\n+  const statusEventFilter = {\n     kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n-    \"#e\": [...repoClass.patches.map((patch: Patch) =\u003e patch.id)],\n+    \"#e\": [...repoClass.patches.map((patch: PatchEvent) =\u003e patch.id)],\n   }\n-  const statusEvents = deriveEvents(repository, {filters: [statusFilter]})\n+  const statusEvents = deriveEvents(repository, {filters: [statusEventFilter]})\n \n+  // Filter and sort options\n+  let statusFilter = $state\u003cstring\u003e(\"all\") // all, open, applied, closed, draft\n+  let sortBy = $state\u003cstring\u003e(\"newest\") // newest, oldest, status, commits\n+  let authorFilter = $state\u003cstring\u003e(\"\") // empty string means all authors\n+  let showFilters = $state(false)\n+    \n+  // Get all unique authors from patches\n+  const uniqueAuthors = $derived.by(() =\u003e {\n+    if (!repoClass.patches) return []\n+    \n+    const authors = new Set\u003cstring\u003e()\n+    repoClass.patches.forEach((patch: PatchEvent) =\u003e {\n+      const pubkey = patch.pubkey\n+      if (pubkey) authors.add(pubkey)\n+    })\n+    \n+    return Array.from(authors)\n+  })\n+  \n   const patchList = $derived.by(() =\u003e {\n     if (repoClass.patches \u0026\u0026 $statusEvents.length \u003e 0) {\n-      return repoClass.patches.map((patch: Patch) =\u003e {\n-        const profile = deriveProfile(patch.author.pubkey)\n-        const statusEvent = $statusEvents\n-          ?.filter((s: any) =\u003e {\n-            let [_, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n-            return eventId === patch.id\n+      // First get all root patches\n+      let filteredPatches = repoClass.patches\n+        .filter((patch: PatchEvent) =\u003e {\n+          const tags = getTags(patch, \"t\")\n+          return tags.length \u003e 0 \u0026\u0026 tags[0][1] === \"root\"\n+        })\n+        .map((patch: PatchEvent) =\u003e {\n+          const status = $statusEvents\n+            ?.filter((s: any) =\u003e {\n+              let [_, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n+              return eventId === patch.id\n+            })\n+            .sort((a: any, b: any) =\u003e b.created_at - a.created_at)[0]\n+\n+          const patches = repoClass.patches.filter(issue =\u003e {\n+            const tags = getTags(issue, \"e\")\n+            return tags.length \u003e 0 \u0026\u0026 tags[0][1] === patch.id\n           })\n-          .sort((a: any, b: any) =\u003e b.created_at - a.created_at)[0]\n \n-        const status = statusEvent ? parseStatusEvent(statusEvent as StatusEvent) : undefined\n-        \n-        console.log($statusEvents)\n-        \n-        return {\n-          ...patch,\n-          ...patch.raw,\n-          patches: repoClass.patches.filter(issue =\u003e issue.id === patch.id),\n-          status,\n-        }\n-      })\n+          // Parse the patch to get additional metadata\n+          const parsedPatch = parseGitPatchFromEvent(patch)\n+          \n+          return {\n+            ...patch,\n+            patches,\n+            status,\n+            parsedPatch,\n+            // Add commit count directly for easier sorting\n+            commitCount: parsedPatch?.commitCount || 0,\n+          }\n+        })\n+      \n+      // Apply status filter\n+      if (statusFilter !== \"all\") {\n+        filteredPatches = filteredPatches.filter(patch =\u003e {\n+          if (!patch.status) {\n+            // If no status and filter is \"open\", show it (default is open)\n+            return statusFilter === \"open\"\n+          }\n+          \n+          switch (statusFilter) {\n+            case \"open\":\n+              return patch.status.kind === GIT_STATUS_OPEN\n+            case \"applied\":\n+              return patch.status.kind === GIT_STATUS_COMPLETE\n+            case \"closed\":\n+              return patch.status.kind === GIT_STATUS_CLOSED\n+            case \"draft\":\n+              return patch.status.kind === GIT_STATUS_DRAFT\n+            default:\n+              return true\n+          }\n+        })\n+      }\n+      \n+      // Apply author filter\n+      if (authorFilter) {\n+        filteredPatches = filteredPatches.filter(patch =\u003e patch.pubkey === authorFilter)\n+      }\n+      \n+      // Create a new array to avoid mutating the original\n+      let sortedPatches = [...filteredPatches]\n+      \n+      // Apply sorting - make a copy first to ensure reactivity\n+      const currentSortBy = sortBy // Capture the current sort value\n+      \n+      if (currentSortBy === \"newest\") {\n+        sortedPatches.sort((a, b) =\u003e b.created_at - a.created_at)\n+      } else if (currentSortBy === \"oldest\") {\n+        sortedPatches.sort((a, b) =\u003e a.created_at - b.created_at)\n+      } else if (currentSortBy === \"status\") {\n+        // Sort by status priority: open, draft, complete, closed\n+        sortedPatches.sort((a, b) =\u003e {\n+          const getStatusPriority = (status?: any) =\u003e {\n+            if (!status) return 0 // Open (default)\n+            switch (status.kind) {\n+              case GIT_STATUS_OPEN: return 0\n+              case GIT_STATUS_DRAFT: return 1\n+              case GIT_STATUS_COMPLETE: return 2\n+              case GIT_STATUS_CLOSED: return 3\n+              default: return 4\n+            }\n+          }\n+          return getStatusPriority(a.status) - getStatusPriority(b.status)\n+        })\n+      } else if (currentSortBy === \"commits\") {\n+        // Sort by commit count (highest first)\n+        sortedPatches.sort((a, b) =\u003e b.commitCount - a.commitCount)\n+      }\n+      return sortedPatches\n     }\n   })\n \n@@ -67,15 +157,15 @@\n   }\n \n   const allComments = $derived.by(() =\u003e {\n-    if(repoClass.patches) {\n-      return deriveEvents(repository, {filters:[commentFilter]})\n+    if (repoClass.patches) {\n+      return deriveEvents(repository, {filters: [commentFilter]})\n     }\n   })\n \n   $effect(() =\u003e {\n     if (repoClass.patches) {\n-      load({relays: repoClass.relays, filters: [patchFilter, statusFilter, commentFilter]})\n- \n+      load({relays: repoClass.relays, filters: [patchFilter, statusEventFilter, commentFilter]})\n+\n       makeFeed({\n         element: element!,\n         relays: repoClass.relays,\n@@ -92,16 +182,21 @@\n \u003c/script\u003e\n \n \u003cdiv bind:this={element}\u003e\n-  \u003cdiv class=\"z-10 sticky z-nav -top-8 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n+  \u003cdiv class=\"z-10 sticky -top-8 z-nav mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003ePatches\u003c/h2\u003e\n       \u003cp class=\"text-sm text-muted-foreground\"\u003eReview and merge code changes\u003c/p\u003e\n     \u003c/div\u003e\n \n     \u003cdiv class=\"flex items-center gap-2\"\u003e\n-      \u003cButton variant=\"outline\" size=\"sm\" class=\"gap-2\"\u003e\n+      \u003cButton \n+        variant=\"outline\" \n+        size=\"sm\" \n+        class=\"gap-2\" \n+        onclick={() =\u003e showFilters = !showFilters}\n+      \u003e\n         \u003cFunnel class=\"h-4 w-4\" /\u003e\n-        Filter\n+        {showFilters ? 'Hide Filters' : 'Filter'}\n       \u003c/Button\u003e\n \n       \u003cButton size=\"sm\" class=\"gap-2 bg-git hover:bg-git-hover\"\u003e\n@@ -111,6 +206,125 @@\n     \u003c/div\u003e\n   \u003c/div\u003e\n \n+  {#if showFilters}\n+    \u003cdiv class=\"mb-6 p-4 border border-border rounded-md bg-card\"\u003e\n+      \u003cdiv class=\"grid grid-cols-1 md:grid-cols-2 gap-4\"\u003e\n+        \u003c!-- Status Filter --\u003e\n+        \u003cdiv\u003e\n+          \u003ch3 class=\"text-sm font-medium mb-2\"\u003eStatus\u003c/h3\u003e\n+          \u003cdiv class=\"flex flex-wrap gap-2\"\u003e\n+            \u003cButton \n+              variant={statusFilter === \"all\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e statusFilter = \"all\"}\n+            \u003e\n+              All\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={statusFilter === \"open\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e statusFilter = \"open\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cGitCommit class=\"h-3 w-3\" /\u003e Open\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={statusFilter === \"applied\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e statusFilter = \"applied\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cCheck class=\"h-3 w-3\" /\u003e Applied\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={statusFilter === \"closed\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e statusFilter = \"closed\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cX class=\"h-3 w-3\" /\u003e Closed\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={statusFilter === \"draft\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e statusFilter = \"draft\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cClock class=\"h-3 w-3\" /\u003e Draft\n+            \u003c/Button\u003e\n+          \u003c/div\u003e\n+        \u003c/div\u003e\n+        \n+        \u003c!-- Sort Options --\u003e\n+        \u003cdiv\u003e\n+          \u003ch3 class=\"text-sm font-medium mb-2\"\u003eSort By\u003c/h3\u003e\n+          \u003cdiv class=\"flex flex-wrap gap-2\"\u003e\n+            \u003cButton \n+              variant={sortBy === \"newest\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e sortBy = \"newest\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cCalendarDays class=\"h-3 w-3\" /\u003e Newest\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={sortBy === \"oldest\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e sortBy = \"oldest\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cCalendarDays class=\"h-3 w-3\" /\u003e Oldest\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={sortBy === \"status\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e sortBy = \"status\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cCheck class=\"h-3 w-3\" /\u003e Status\n+            \u003c/Button\u003e\n+            \u003cButton \n+              variant={sortBy === \"commits\" ? \"default\" : \"outline\"} \n+              size=\"sm\"\n+              onclick={() =\u003e sortBy = \"commits\"}\n+              class=\"gap-1\"\n+            \u003e\n+              \u003cGitCommit class=\"h-3 w-3\" /\u003e Commits\n+            \u003c/Button\u003e\n+          \u003c/div\u003e\n+        \u003c/div\u003e\n+        \n+        \u003c!-- Author Filter --\u003e\n+        {#if uniqueAuthors.length \u003e 1}\n+          \u003cdiv class=\"md:col-span-2\"\u003e\n+            \u003ch3 class=\"text-sm font-medium mb-2\"\u003eAuthor\u003c/h3\u003e\n+            \u003cdiv class=\"flex flex-wrap gap-2\"\u003e\n+              \u003cButton \n+                variant={authorFilter === \"\" ? \"default\" : \"outline\"} \n+                size=\"sm\"\n+                onclick={() =\u003e authorFilter = \"\"}\n+              \u003e\n+                All Authors\n+              \u003c/Button\u003e\n+              \n+              {#each uniqueAuthors as author}\n+                \u003cButton \n+                  variant={authorFilter === author ? \"default\" : \"outline\"} \n+                  size=\"sm\"\n+                  onclick={() =\u003e authorFilter = author}\n+                  class=\"gap-1\"\n+                \u003e\n+                  \u003cUser class=\"h-3 w-3\" /\u003e\n+                  \u003cspan class=\"text-sm\"\u003e{author.slice(0, 8)}...\u003c/span\u003e\n+                \u003c/Button\u003e\n+              {/each}\n+            \u003c/div\u003e\n+          \u003c/div\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  {/if}\n+\n   {#if loading}\n     \u003cdiv class=\"flex flex-col items-center justify-center py-12\"\u003e\n       \u003cSpinner {loading}\u003e\n@@ -129,11 +343,8 @@\n   {:else}\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each patchList! as patch}\n-        {@const count = $allComments\n-          ?.filter((c)=\u003egetTagValue(\"E\", c.tags) === patch.id).length ?? 0\n-        }\n         \u003cdiv in:fly\u003e\n-          \u003cPatchCard event={patch} status={patch.status} commentCount={count} /\u003e\n+          \u003cPatchCard event={patch} patches={patch.patches} status={patch.status as StatusEvent} /\u003e\n         \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 1aa1123..e97c793 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -1,34 +1,106 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n-  import {GitCommit, MessageSquare, Check, X} from \"@lucide/svelte\"\n-  import {Button} from \"@nostr-git/ui\"\n-  import {Avatar, AvatarFallback, AvatarImage, DiffViewer, IssueThread} from \"@nostr-git/ui\"\n-  import {deriveProfile, repository} from \"@welshman/app\"\n+  import {Check, ChevronLeft, ChevronRight, GitCommit, MessageSquare, X} from \"@lucide/svelte\"\n+  import {Button, Profile} from \"@nostr-git/ui\"\n+  import {DiffViewer, IssueThread} from \"@nostr-git/ui\"\n+  import {pubkey, repository} from \"@welshman/app\"\n   import markdownit from \"markdown-it\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {load} from \"@welshman/net\"\n-  import {COMMENT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE, GIT_STATUS_DRAFT, GIT_STATUS_OPEN, type Filter} from \"@welshman/util\"\n-  import {isStatusEvent, parseStatusEvent, type CommentEvent, type StatusEvent} from \"@nostr-git/shared-types\"\n+  import {\n+    COMMENT,\n+    GIT_PATCH,\n+    GIT_STATUS_CLOSED,\n+    GIT_STATUS_COMPLETE,\n+    GIT_STATUS_DRAFT,\n+    GIT_STATUS_OPEN,\n+    type Filter,\n+  } from \"@welshman/util\"\n+  import {\n+    getTags,\n+    parseStatusEvent,\n+    type CommentEvent,\n+    type StatusEvent,\n+    type PatchEvent,\n+  } from \"@nostr-git/shared-types\"\n+  import {getContext} from \"svelte\"\n+  import {REPO_RELAYS_KEY} from \"@src/app/state.js\"\n+  import {postComment} from \"@src/app/commands.js\"\n+  import {parseGitPatchFromEvent} from \"@nostr-git/core\"\n \n   const {data} = $props()\n   const {repoClass} = data\n \n-  const patch = repoClass.patches.find(p =\u003e p.id === $page.params.patchid)\n+  const patchId = $page.params.patchid\n+\n+  const patchEvent = repoClass.patches.find(p =\u003e p.id === patchId)\n+  const patch = patchEvent ? parseGitPatchFromEvent(patchEvent) : undefined\n+\n+  let rootPatchId = patchId\n+  let currentPatch = patchEvent as PatchEvent | null\n+  while (currentPatch) {\n+    const replyTags = getTags(currentPatch, \"e\")\n+    if (replyTags.length === 0) break\n+    \n+    const parentId = replyTags[0][1]\n+    const parentPatch = repoClass.patches.find(p =\u003e p.id === parentId)\n+    if (!parentPatch) break\n+    \n+    rootPatchId = parentId\n+    currentPatch = parentPatch\n+  }\n+  \n+  const patchSet = repoClass.patches\n+    .filter((p): p is PatchEvent =\u003e {\n+      if (p.id === patchId) return true\n+      const directReplyToThis = getTags(p, \"e\").some(tag =\u003e tag[1] === patchId)\n+      if (directReplyToThis) return true\n+      if (rootPatchId !== patchId) {\n+        const replyTags = getTags(p, \"e\")\n+        if (replyTags.length \u003e 0) {\n+          let checkPatch: PatchEvent | undefined = p\n+          let foundRoot = false\n+          \n+          while (checkPatch) {\n+            if (checkPatch.id === rootPatchId) {\n+              foundRoot = true\n+              break\n+            }\n+            \n+            const checkReplyTags: [string, ...string[]][] = getTags(checkPatch, \"e\")\n+            if (checkReplyTags.length === 0) break\n+            \n+            const checkParentId: string = checkReplyTags[0][1]\n+            checkPatch = repoClass.patches.find((p): p is PatchEvent =\u003e p.id === checkParentId)\n+            if (!checkPatch) break\n+          }   \n+          return foundRoot\n+        }\n+      }\n+      return false\n+    })\n+    .sort((a, b) =\u003e a.created_at - b.created_at)\n+    .sort((a,b) =\u003e a.id === rootPatchId ? -1 : 1)\n+    .map(p =\u003e parseGitPatchFromEvent(p))\n+    \n+  let selectedPatch = $state(patch)\n \n   const threadComments = $derived.by(() =\u003e {\n-    if (repoClass.patches) {\n-      const filters: Filter[] = [{kinds: [COMMENT], \"#E\": [patch?.id!]}]\n+    if (repoClass.patches \u0026\u0026 selectedPatch) {\n+      const filters: Filter[] = [{kinds: [COMMENT], \"#E\": [selectedPatch.id]}]\n       load({relays: repoClass.relays, filters})\n       return deriveEvents(repository, {filters})\n     }\n   })\n \n-  const statusFilter = {\n+  const getStatusFilter = () =\u003e ({\n     kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n-    \"#e\": [patch?.id!],\n-  }\n+    \"#e\": [selectedPatch?.id ?? \"\"],\n+  })\n \n-  const statusEvents = deriveEvents(repository, {filters: [statusFilter]})\n+  const statusEvents = $derived.by(() =\u003e {\n+    return deriveEvents(repository, {filters: [getStatusFilter()]})\n+  })\n \n   const repoRelays = getContext\u003cstring[]\u003e(REPO_RELAYS_KEY)\n   const onCommentCreated = async (comment: CommentEvent) =\u003e {\n@@ -37,7 +109,7 @@\n \n   const status = $derived.by(() =\u003e {\n     if ($statusEvents) {\n-      const statusEvent = $statusEvents.filter(isStatusEvent).sort((a, b) =\u003e b.created_at - a.created_at)[0]\n+      const statusEvent = $statusEvents.sort((a, b) =\u003e b.created_at - a.created_at)[0]\n       return statusEvent ? parseStatusEvent(statusEvent as StatusEvent) : undefined\n     }\n   })\n@@ -78,7 +150,7 @@\n             {/if}\n \n             \u003cdiv\u003e\n-              \u003ch1 class=\"text-2xl font-bold\"\u003e{patch?.title}\u003c/h1\u003e\n+              \u003ch1 class=\"text-2xl font-bold break-words\"\u003e{patch?.title}\u003c/h1\u003e\n \n               \u003cdiv class=\"mt-1 flex items-center gap-2\"\u003e\n                 \u003cdiv class=\"git-tag bg-secondary\"\u003e\n@@ -105,7 +177,7 @@\n         \u003cdiv class=\"git-separator\"\u003e\u003c/div\u003e\n \n         \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n-          \u003ch2 class=\"text-lg font-medium\"\u003e{patch?.commitCount} Commits\u003c/h2\u003e\n+          \u003ch2 class=\"text-lg font-medium\"\u003e{patchSet.length} Patches in Set\u003c/h2\u003e\n \n           \u003cdiv class=\"flex items-center gap-2\"\u003e\n             {#if status?.status === \"open\"}\n@@ -116,11 +188,90 @@\n           \u003c/div\u003e\n         \u003c/div\u003e\n \n-        \u003cdiv class=\"mb-6 space-y-3\"\u003e\u003c/div\u003e\n+        \u003c!-- Patch Set --\u003e\n+        \u003cdiv class=\"mb-6 border border-border rounded-md overflow-hidden\"\u003e\n+          {#each patchSet as patchItem, index}\n+            {@const isSelected = selectedPatch?.id === patchItem.id}\n+            {@const isRoot = patchSet.some(p =\u003e {\n+              const tags = getTags(p.raw, \"e\")\n+              return tags.length \u003e 0 \u0026\u0026 tags[0][1] === patchItem.id\n+            })}\n+            \n+            \u003cbutton \n+              class=\"w-full text-left p-3 hover:bg-secondary/20 border-b border-border last:border-b-0 flex items-center gap-3 {isSelected ? 'bg-secondary/30' : ''}\" \n+              onclick={() =\u003e selectedPatch = patchItem}\n+            \u003e\n+              \u003cdiv class=\"flex-shrink-0\"\u003e\n+                \u003cGitCommit class=\"h-5 w-5 {isSelected ? 'text-primary' : 'text-muted-foreground'}\" /\u003e\n+              \u003c/div\u003e\n+              \u003cdiv class=\"flex-grow\"\u003e\n+                \u003cdiv class=\"font-semibold break-words\"\u003e{patchItem.title || `Patch ${index + 1}`}\u003c/div\u003e\n+                \u003cdiv class=\"text-sm text-muted-foreground flex items-center gap-2\"\u003e\n+                  \u003cspan\u003e{patchItem.author.name || patchItem.author.pubkey.slice(0, 8)}\u003c/span\u003e\n+                  \u003cspan\u003e•\u003c/span\u003e\n+                  \u003cspan\u003e{new Date(patchItem.createdAt).toLocaleString()}\u003c/span\u003e\n+                  {#if patchItem.commitHash}\n+                    \u003cspan\u003e•\u003c/span\u003e\n+                    \u003cspan\u003e{patchItem.commitHash}\u003c/span\u003e\n+                  {/if}\n+                  {#if isRoot}\n+                    \u003cspan class=\"ml-1 px-1.5 py-0.5 text-xs rounded bg-blue-500/20 text-blue-500\"\u003eroot\u003c/span\u003e\n+                  {/if}\n+                \u003c/div\u003e\n+              \u003c/div\u003e\n+            \u003c/button\u003e\n+          {/each}\n+        \u003c/div\u003e\n \n-        \u003ch2 class=\"mb-4 text-lg font-medium\"\u003eChanges\u003c/h2\u003e\n-        {#if patch?.diff}\n-          \u003cDiffViewer diff={patch.diff} /\u003e\n+        \u003cdiv class=\"flex items-center justify-between mb-4\"\u003e\n+          \u003ch2 class=\"text-lg font-medium\"\u003eChanges\u003c/h2\u003e\n+          \n+          \u003c!-- Navigation Controls --\u003e\n+          {#if patchSet.length \u003e 1}\n+            \u003cdiv class=\"flex items-center gap-2\"\u003e\n+              {#key selectedPatch?.id}\n+                {@const currentIndex = patchSet.findIndex(p =\u003e p.id === selectedPatch?.id)}\n+                {@const hasPrevious = currentIndex \u003e 0}\n+                {@const hasNext = currentIndex \u003c patchSet.length - 1}\n+                \n+                \u003cButton \n+                  variant=\"outline\" \n+                  size=\"sm\" \n+                  disabled={!hasPrevious}\n+                  onclick={() =\u003e {\n+                    if (hasPrevious) {\n+                      selectedPatch = patchSet[currentIndex - 1];\n+                    }\n+                  }}\n+                \u003e\n+                  \u003cChevronLeft class=\"h-4 w-4 mr-1\" /\u003e\n+                  Previous\n+                \u003c/Button\u003e\n+                \n+                \u003cspan class=\"text-sm text-muted-foreground\"\u003e\n+                  {currentIndex + 1} of {patchSet.length}\n+                \u003c/span\u003e\n+                \n+                \u003cButton \n+                  variant=\"outline\" \n+                  size=\"sm\" \n+                  disabled={!hasNext}\n+                  onclick={() =\u003e {\n+                    if (hasNext) {\n+                      selectedPatch = patchSet[currentIndex + 1];\n+                    }\n+                  }}\n+                \u003e\n+                  Next\n+                  \u003cChevronRight class=\"h-4 w-4 ml-1\" /\u003e\n+                \u003c/Button\u003e\n+              {/key}\n+            \u003c/div\u003e\n+          {/if}\n+        \u003c/div\u003e\n+        \n+        {#if selectedPatch?.diff}\n+          \u003cDiffViewer diff={selectedPatch.diff} /\u003e\n         {/if}\n \n         \u003cdiv class=\"git-separator my-6\"\u003e\u003c/div\u003e\n@@ -132,12 +283,11 @@\n           \u003c/h2\u003e\n \n           \u003cIssueThread\n-            issueId = {patch?.id}\n-            issueKind={GIT_PATCH.toString() as '1617'}\n-            comments = {$threadComments}\n-            currentCommenter = {$pubkey!}\n-            onCommentCreated={onCommentCreated}\n-          /\u003e\n+            issueId={selectedPatch?.id ?? \"\"}\n+            issueKind={GIT_PATCH.toString() as \"1617\"}\n+            comments={$threadComments as CommentEvent[]}\n+            currentCommenter={$pubkey!}\n+            {onCommentCreated} /\u003e\n         \u003c/div\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-8zmpqoqg","title":"From 1364cf8f088285351a6ee251447de2b5a2604eec Mon Sep 17 00:00:00 2001","description":"From 1364cf8f088285351a6ee251447de2b5a2604eec Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Tue, 27 May 2025 16:22:20 -0700\nSubject: [PATCH 4/67] Detect nip29 support for create room button\n\n---\n src/app/components/MenuSpace.svelte    | 13 +++++++++----\n src/app/components/RoomCreate.svelte   | 55 ++++++++++++++++++++++++++++++-------------------------\n src/app/state.ts                       | 13 ++++++++++---\n src/routes/discover/+page.svelte       | 15 +++++++++++----\n src/routes/spaces/[relay]/+page.svelte |  1 +\n 5 files changed, 61 insertions(+), 36 deletions(-)\n\ndiff --git a/src/app/components/MenuSpace.svelte b/src/app/components/MenuSpace.svelte\nindex 432fb80..bd0d622 100644\n--- a/src/app/components/MenuSpace.svelte\n+++ b/src/app/components/MenuSpace.svelte\n@@ -1,6 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n   import {onMount} from \"svelte\"\n   import {displayRelayUrl} from \"@welshman/util\"\n+  import {deriveRelay} from \"@welshman/app\"\n   import {fly} from \"@lib/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n@@ -20,6 +21,7 @@\n     memberships,\n     deriveUserRooms,\n     deriveOtherRooms,\n+    hasNip29,\n   } from \"@app/state\"\n   import {notifications} from \"@app/notifications\"\n   import {pushModal} from \"@app/modal\"\n@@ -27,6 +29,7 @@\n \n   const {url} = $props()\n \n+  const relay = deriveRelay(url)\n   const threadsPath = makeSpacePath(url, \"threads\")\n   const calendarPath = makeSpacePath(url, \"calendar\")\n   const jobsPath = makeSpacePath(url, \"jobs\")\n@@ -151,10 +154,12 @@\n       {#each $otherRooms as room, i (room)}\n         \u003cMenuSpaceRoomItem {replaceState} {url} {room} /\u003e\n       {/each}\n-      \u003cSecondaryNavItem {replaceState} onclick={addRoom}\u003e\n-        \u003cIcon icon=\"add-circle\" /\u003e\n-        Create room\n-      \u003c/SecondaryNavItem\u003e\n+      {#if hasNip29($relay)}\n+        \u003cSecondaryNavItem {replaceState} onclick={addRoom}\u003e\n+          \u003cIcon icon=\"add-circle\" /\u003e\n+          Create room\n+        \u003c/SecondaryNavItem\u003e\n+      {/if}\n     \u003c/div\u003e\n   \u003c/SecondaryNavSection\u003e\n \u003c/div\u003e\ndiff --git a/src/app/components/RoomCreate.svelte b/src/app/components/RoomCreate.svelte\nindex 17a8120..724acca 100644\n--- a/src/app/components/RoomCreate.svelte\n+++ b/src/app/components/RoomCreate.svelte\n@@ -23,24 +23,22 @@\n   const back = () =\u003e history.back()\n \n   const tryCreate = async () =\u003e {\n-    if (hasNip29($relay)) {\n-      const createMessage = await getThunkError(nip29.createRoom(url, room))\n+    const createMessage = await getThunkError(nip29.createRoom(url, room))\n \n-      if (createMessage \u0026\u0026 !createMessage.match(/^duplicate:|already a member/)) {\n-        return pushToast({theme: \"error\", message: createMessage})\n-      }\n+    if (createMessage \u0026\u0026 !createMessage.match(/^duplicate:|already a member/)) {\n+      return pushToast({theme: \"error\", message: createMessage})\n+    }\n \n-      const editMessage = await getThunkError(nip29.editMeta(url, room, {name}))\n+    const editMessage = await getThunkError(nip29.editMeta(url, room, {name}))\n \n-      if (editMessage) {\n-        return pushToast({theme: \"error\", message: editMessage})\n-      }\n+    if (editMessage) {\n+      return pushToast({theme: \"error\", message: editMessage})\n+    }\n \n-      const joinMessage = await getThunkError(nip29.joinRoom(url, room))\n+    const joinMessage = await getThunkError(nip29.joinRoom(url, room))\n \n-      if (joinMessage \u0026\u0026 !joinMessage.includes(\"already\")) {\n-        return pushToast({theme: \"error\", message: joinMessage})\n-      }\n+    if (joinMessage \u0026\u0026 !joinMessage.includes(\"already\")) {\n+      return pushToast({theme: \"error\", message: joinMessage})\n     }\n \n     addRoomMembership(url, room, name)\n@@ -72,23 +70,30 @@\n       \u003c/div\u003e\n     {/snippet}\n   \u003c/ModalHeader\u003e\n-  \u003cField\u003e\n-    {#snippet label()}\n-      \u003cp\u003eRoom Name\u003c/p\u003e\n-    {/snippet}\n-    {#snippet input()}\n-      \u003clabel class=\"input input-bordered flex w-full items-center gap-2\"\u003e\n-        \u003cIcon icon=\"hashtag\" /\u003e\n-        \u003cinput bind:value={name} class=\"grow\" type=\"text\" /\u003e\n-      \u003c/label\u003e\n-    {/snippet}\n-  \u003c/Field\u003e\n+  {#if hasNip29($relay)}\n+    \u003cField\u003e\n+      {#snippet label()}\n+        \u003cp\u003eRoom Name\u003c/p\u003e\n+      {/snippet}\n+      {#snippet input()}\n+        \u003clabel class=\"input input-bordered flex w-full items-center gap-2\"\u003e\n+          \u003cIcon icon=\"hashtag\" /\u003e\n+          \u003cinput bind:value={name} class=\"grow\" type=\"text\" /\u003e\n+        \u003c/label\u003e\n+      {/snippet}\n+    \u003c/Field\u003e\n+  {:else}\n+    \u003cp class=\"bg-alt card2 row-2\"\u003e\n+      \u003cIcon icon=\"danger\" /\u003e\n+      This relay does not support creating rooms.\n+    \u003c/p\u003e\n+  {/if}\n   \u003cModalFooter\u003e\n     \u003cButton class=\"btn btn-link\" onclick={back}\u003e\n       \u003cIcon icon=\"alt-arrow-left\" /\u003e\n       Go back\n     \u003c/Button\u003e\n-    \u003cButton type=\"submit\" class=\"btn btn-primary\" disabled={!name || loading}\u003e\n+    \u003cButton type=\"submit\" class=\"btn btn-primary\" disabled={!name || loading || !hasNip29($relay)}\u003e\n       \u003cSpinner {loading}\u003eCreate Room\u003c/Spinner\u003e\n       \u003cIcon icon=\"alt-arrow-right\" /\u003e\n     \u003c/Button\u003e\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex c59c50d..4d2addd 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -3,6 +3,7 @@ import {get, derived, writable} from \"svelte/store\"\n import {nip19} from \"nostr-tools\"\n import {\n   remove,\n+  uniqBy,\n   sortBy,\n   sort,\n   uniq,\n@@ -559,7 +560,7 @@ export const channels = derived(\n       }\n     }\n \n-    return $channels\n+    return uniqBy(c =\u003e c.id, $channels)\n   },\n )\n \n@@ -625,12 +626,18 @@ export const userMembership = withGetter(\n )\n \n export const userRoomsByUrl = withGetter(\n-  derived(userMembership, $userMembership =\u003e {\n+  derived([userMembership, channelsById], ([$userMembership, $channelsById]) =\u003e {\n     const tags = getListTags($userMembership)\n     const $userRoomsByUrl = new Map\u003cstring, Set\u003cstring\u003e\u003e()\n \n+    for (const url of getRelayTagValues(tags)) {\n+      $userRoomsByUrl.set(normalizeRelayUrl(url), new Set())\n+    }\n+\n     for (const [_, room, url] of getGroupTags(tags)) {\n-      addToMapKey($userRoomsByUrl, normalizeRelayUrl(url), room)\n+      if ($channelsById.has(makeChannelId(url, room))) {\n+        addToMapKey($userRoomsByUrl, normalizeRelayUrl(url), room)\n+      }\n     }\n \n     return $userRoomsByUrl\ndiff --git a/src/routes/discover/+page.svelte b/src/routes/discover/+page.svelte\nindex 3ab350d..8e13447 100644\n--- a/src/routes/discover/+page.svelte\n+++ b/src/routes/discover/+page.svelte\n@@ -1,6 +1,9 @@\n \u003cscript lang=\"ts\"\u003e\n   import {onMount} from \"svelte\"\n   import {addToMapKey, dec, gt} from \"@welshman/lib\"\n+  import {GROUPS} from \"@welshman/util\"\n+  import {Router} from \"@welshman/router\"\n+  import {load} from \"@welshman/net\"\n   import type {Relay} from \"@welshman/app\"\n   import {relays, createSearch, loadRelay, loadRelaySelections} from \"@welshman/app\"\n   import {createScroller} from \"@lib/html\"\n@@ -24,8 +27,12 @@\n   import {pushModal} from \"@app/modal\"\n \n   const discoverRelays = () =\u003e\n-    Promise.all(\n-      getDefaultPubkeys().map(async pubkey =\u003e {\n+    Promise.all([\n+      load({\n+        filters: [{kinds: [GROUPS]}],\n+        relays: Router.get().Index().getUrls(),\n+      }),\n+      ...getDefaultPubkeys().map(async pubkey =\u003e {\n         await loadRelaySelections(pubkey)\n \n         const membership = await loadMembership(pubkey)\n@@ -33,7 +40,7 @@\n \n         await Promise.all(urls.map(url =\u003e loadRelay(url)))\n       }),\n-    )\n+    ])\n \n   const wotGraph = $derived.by(() =\u003e {\n     const scores = new Map\u003cstring, Set\u003cstring\u003e\u003e()\n@@ -87,7 +94,7 @@\n   })\n \u003c/script\u003e\n \n-\u003cPage\u003e\n+\u003cPage class=\"cw-full\"\u003e\n   \u003cdiv class=\"content column gap-4\" bind:this={element}\u003e\n     \u003cPageHeader\u003e\n       {#snippet title()}\ndiff --git a/src/routes/spaces/[relay]/+page.svelte b/src/routes/spaces/[relay]/+page.svelte\nindex 66f82e1..8ef26e6 100644\n--- a/src/routes/spaces/[relay]/+page.svelte\n+++ b/src/routes/spaces/[relay]/+page.svelte\n@@ -15,6 +15,7 @@\n   import RoomCreate from \"@app/components/RoomCreate.svelte\"\n   import RelayDescription from \"@app/components/RelayDescription.svelte\"\n   import {\n+    hasNip29,\n     decodeRelay,\n     channelIsLocked,\n     makeChannelId,\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-93wvbk82","title":"From fb0e354c47ff6d0bd2797cbbbc67b89835b44308 Mon Sep 17 00:00:00 2001","description":"From fb0e354c47ff6d0bd2797cbbbc67b89835b44308 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 14 Aug 2025 01:57:59 -0700\nSubject: [PATCH 5/6] feat: add Gravatar avatar support for commits and patches\n\n---\n packages/nostr-git | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 65972a5..85da9f4 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 65972a578049c176c7e1800dd612c285bbd7509c\n+Subproject commit 85da9f47bffcc3d0fd51f5cd17acda8bd607fdf4\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-99ncwpkz","title":"Research ways to integrate freelancing","description":"Explore different ideas to integrate freelancing features for dedicated rooms, the way its most appropriate","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["issue"]}
{"id":"flotilla-9apcxutf","title":"From cd49764a3f206cc538838758328a13914a8c82d3 Mon Sep 17 00:00:00 2001","description":"From cd49764a3f206cc538838758328a13914a8c82d3 Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/2] remove redundant repo intialization\n\nremoves redundant repo initialization that was causing a loop condition","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-9fp2tbjv","title":"From 67bc2fed213ef93875f124226b5150a246fb1a31 Mon Sep 17 00:00:00 2001","description":"From 67bc2fed213ef93875f124226b5150a246fb1a31 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Wed, 7 May 2025 09:18:59 -0700\nSubject: [PATCH] feat: update dependencies and refactor Git and Job components\n\n- Added pnpm workspace configuration to only build sharp dependency.\n- Refactored imports in GitActions, GitIssueItem, JobActions, JobItem, RepoPicker, and other components to use new module paths.\n- Improved code formatting and consistency across various Svelte components.\n- Enhanced job and Git issue loading mechanisms with better state management.\n- Updated job and Git links to point to the correct URLs.\n- Added support for freelance job filtering in job-related components.\n- Implemented cleanup logic in job and thread components to manage subscriptions effectively.\n---\n package.json                                          |   4 +++-\n pnpm-workspace.yaml                                   |   2 ++\n src/app/components/GitActions.svelte                  |  56 ++++++++++++++++++++++++++++++--------------------------\n src/app/components/GitIssueItem.svelte                |   9 ++++++---\n src/app/components/JobActions.svelte                  |  27 ++++++++++++++-------------\n src/app/components/JobItem.svelte                     |   2 +-\n src/app/components/RepoPicker.svelte                  |  10 +++++-----\n src/app/state.ts                                      |   3 +++\n src/routes/spaces/[relay]/+layout.svelte              |  10 +++++++---\n src/routes/spaces/[relay]/git/+page.svelte            |  80 ++++++++++++++++++++++++++++++++++++++++++--------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte | 156 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++------------------------------------------------------------------------------------------\n src/routes/spaces/[relay]/jobs/+page.svelte           | 194 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------------------------------------------------------------------------------------------------------------\n src/routes/spaces/[relay]/jobs/[id]/+page.svelte      |  44 +++++++++++++++++++++++++++++++++-----------\n src/routes/spaces/[relay]/threads/[id]/+page.svelte   |   3 ++-\n 14 files changed, 297 insertions(+), 303 deletions(-)\n create mode 100644 pnpm-workspace.yaml\n\ndiff --git a/package.json b/package.json\nindex be36708..acc9897 100644\n--- a/package.json\n+++ b/package.json\n@@ -75,6 +75,8 @@\n     \"nostr-tools\": \"^2.7.2\",\n     \"prettier-plugin-tailwindcss\": \"^0.6.5\",\n     \"qrcode\": \"^1.5.4\",\n-    \"throttle-debounce\": \"^5.0.2\"\n+    \"sharp\": \"^0.34.1\",\n+    \"throttle-debounce\": \"^5.0.2\",\n+    \"tippy.js\": \"^6.3.7\"\n   }\n }\ndiff --git a/pnpm-workspace.yaml b/pnpm-workspace.yaml\nnew file mode 100644\nindex 0000000..e6654d6\n--- /dev/null\n+++ b/pnpm-workspace.yaml\n@@ -0,0 +1,2 @@\n+onlyBuiltDependencies:\n+  - sharp\ndiff --git a/src/app/components/GitActions.svelte b/src/app/components/GitActions.svelte\nindex e9e3d24..e4401f9 100644\n--- a/src/app/components/GitActions.svelte\n+++ b/src/app/components/GitActions.svelte\n@@ -1,6 +1,15 @@\n \u003cscript lang=\"ts\"\u003e\n-  import { load } from \"@welshman/app\"\n-  import {Address, GIT_ISSUE, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE, GIT_STATUS_DRAFT, GIT_STATUS_OPEN, type Filter, type TrustedEvent} from \"@welshman/util\"\n+  import {load} from \"@welshman/net\"\n+  import {\n+    Address,\n+    GIT_ISSUE,\n+    GIT_STATUS_CLOSED,\n+    GIT_STATUS_COMPLETE,\n+    GIT_STATUS_DRAFT,\n+    GIT_STATUS_OPEN,\n+    type Filter,\n+    type TrustedEvent,\n+  } from \"@welshman/util\"\n   import {pubkey} from \"@welshman/app\"\n   import ReactionSummary from \"@app/components/ReactionSummary.svelte\"\n   import ThunkStatusOrDeleted from \"@app/components/ThunkStatusOrDeleted.svelte\"\n@@ -9,10 +18,10 @@\n   import {makeGitPath} from \"@app/routes\"\n   import Button from \"@src/lib/components/Button.svelte\"\n   import Link from \"@src/lib/components/Link.svelte\"\n-  import { nthEq } from \"@welshman/lib\"\n-  import { onMount, tick } from \"svelte\"\n-  import { nip19 } from \"nostr-tools\"\n-    import Spinner from \"@src/lib/components/Spinner.svelte\"\n+  import {nthEq} from \"@welshman/lib\"\n+  import {onMount, tick} from \"svelte\"\n+  import {nip19} from \"nostr-tools\"\n+  import Spinner from \"@src/lib/components/Spinner.svelte\"\n \n   interface Props {\n     url: any\n@@ -21,17 +30,15 @@\n     showActivity?: boolean\n   }\n \n-  const {url, event, showIssues=true, showActivity}: Props = $props()\n+  const {url, event, showIssues = true, showActivity}: Props = $props()\n \n   const repoNpub = $derived(nip19.npubEncode(event.pubkey))\n   const repoDtag = $derived(event.tags.find(nthEq(0, \"d\"))?.[1])\n \n-  const gitworkshopLink = $derived(\n-    `https://gitworkshop.dev/${repoNpub}/${repoDtag}`\n-  )\n+  const gitworkshopLink = $derived(`https://gitworkshop.dev/${repoNpub}/${repoDtag}`)\n \n   let issues: TrustedEvent[] = []\n-  const issueFilter:Filter = {kinds: [GIT_ISSUE]}\n+  const issueFilter: Filter = {kinds: [GIT_ISSUE]}\n   let issueCount = $state(0)\n \n   const onReactionClick = (content: string, events: TrustedEvent[]) =\u003e {\n@@ -48,25 +55,22 @@\n     loadingIssues = true\n     await tick()\n     const address = Address.fromEvent(event)\n-    issueFilter['#a'] = [address.toString()]\n+    issueFilter[\"#a\"] = [address.toString()]\n     const [tagId, ...relays] = event.tags.find(nthEq(0, \"relays\")) || []\n \n     issues = await load({\n       relays: relays,\n-      filters: [ issueFilter ]\n+      filters: [issueFilter],\n     })\n \n     loadingIssues = false\n \n-    const statusFilter = [{\n-      kinds: [\n-        GIT_STATUS_OPEN,\n-        GIT_STATUS_COMPLETE,\n-        GIT_STATUS_CLOSED,\n-        GIT_STATUS_DRAFT\n-      ],\n-      \"#e\": issues.map(issue=\u003eissue.id)\n-    }]\n+    const statusFilter = [\n+      {\n+        kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+        \"#e\": issues.map(issue =\u003e issue.id),\n+      },\n+    ]\n \n     issueCount = issues.length\n \n@@ -75,7 +79,7 @@\n       relays: relays,\n       filters: statusFilter,\n     })\n-  } \n+  }\n \n   onMount(() =\u003e {\n     if (showIssues) {\n@@ -97,9 +101,9 @@\n     \u003c/Button\u003e\n     {#if showIssues}\n       \u003cButton class=\"btn btn-secondary btn-sm\"\u003e\n-        \u003cLink class=\"h-full w-full cursor-pointer flex items-center\" href={makeGitPath(\n-          url,Address.fromEvent(event).toNaddr()\n-        )}\u003e\n+        \u003cLink\n+          class=\"flex h-full w-full cursor-pointer items-center\"\n+          href={makeGitPath(url, Address.fromEvent(event).toNaddr())}\u003e\n           \u003cSpinner loading={loadingIssues} minHeight={\"min-h-6\"}\u003e\n             \u003cspan class=\"\"\u003e{\"Issues(\" + issueCount + \")\"}\u003c/span\u003e\n           \u003c/Spinner\u003e\ndiff --git a/src/app/components/GitIssueItem.svelte b/src/app/components/GitIssueItem.svelte\nindex 20d26c9..5b20b8c 100644\n--- a/src/app/components/GitIssueItem.svelte\n+++ b/src/app/components/GitIssueItem.svelte\n@@ -12,8 +12,10 @@\n     type TrustedEvent\n \n   } from \"@welshman/util\"\n-  import { load, formatTimestampRelative, userMutes, subscribe } from \"@welshman/app\"\n-  import { ctx, now, nthEq, sortBy } from \"@welshman/lib\"\n+  import { userMutes } from \"@welshman/app\"\n+  import { formatTimestampRelative } from \"@welshman/lib\"\n+  import { load } from \"@welshman/net\"\n+  import { now, nthEq, sortBy } from \"@welshman/lib\"\n   import { GIT_REPO, GitIssueStatus } from \"@src/lib/util\"\n   import NoteCard from \"./NoteCard.svelte\"\n   import Content from \"./Content.svelte\"\n@@ -25,6 +27,7 @@\n   import { pushModal } from \"../modal\"\n   import ThreadCreate from \"./ThreadCreate.svelte\"\n     import { decodeRelay } from \"../state\"\n+    import { Router } from \"@welshman/router\"\n   \n   let {\n     issue,\n@@ -50,7 +53,7 @@\n   const repoLink = `https://gitworkshop.dev/${repoNpub}/${repoDtag}`\n \n   const backupRelays = [\n-    ...ctx.app.router.FromPubkey(pubkey!).getUrls()\n+    ...Router.get().FromPubkey(pubkey!).getUrls()\n   ]\n \n   let queryRelays = relayHint ? [relayHint] : backupRelays\ndiff --git a/src/app/components/JobActions.svelte b/src/app/components/JobActions.svelte\nindex 37c2f4b..29ecceb 100644\n--- a/src/app/components/JobActions.svelte\n+++ b/src/app/components/JobActions.svelte\n@@ -10,9 +10,9 @@\n   import Button from \"@src/lib/components/Button.svelte\"\n   import Link from \"@src/lib/components/Link.svelte\"\n   import {jobLink} from \"@app/state\"\n-  import { pushModal } from \"../modal\"\n+  import {pushModal} from \"../modal\"\n   import ThreadCreate from \"./ThreadCreate.svelte\"\n-  import { ctx } from \"@welshman/lib\"\n+  import {Router} from \"@welshman/router\"\n \n   interface Props {\n     url: any\n@@ -26,10 +26,10 @@\n   const {\n     url,\n     event,\n-    showComment=false,\n-    showExternal=false,\n+    showComment = false,\n+    showExternal = false,\n     showActivity = false,\n-    showThreadAction = false\n+    showThreadAction = false,\n   }: Props = $props()\n \n   const path = makeJobPath(url, event.id)\n@@ -37,17 +37,15 @@\n   const relayHint = $derived.by(() =\u003e {\n     const eventRelays = Array.from(tracker.getRelays(event.id))\n     const address = Address.fromEvent(event)\n-    const pubkeyRelays = ctx.app.router.FromPubkey(address.pubkey).getUrls()\n+    const pubkeyRelays = Router.get().FromPubkey(address.pubkey).getUrls()\n \n     if (eventRelays.length \u003e 0) return eventRelays[0]\n     if (pubkeyRelays.length \u003e 0) return pubkeyRelays[0]\n-    return ''\n+    return \"\"\n   })\n \n-  const startThread = () =\u003e pushModal(\n-    ThreadCreate, \n-    {url: url, jobOrGitIssue: event, relayHint: relayHint}\n-  )\n+  const startThread = () =\u003e\n+    pushModal(ThreadCreate, {url: url, jobOrGitIssue: event, relayHint: relayHint})\n \n   const onReactionClick = (content: string, events: TrustedEvent[]) =\u003e {\n     const reaction = events.find(e =\u003e e.pubkey === $pubkey)\n@@ -76,7 +74,10 @@\n     {/if}\n     {#if showExternal}\n       \u003cButton class=\"btn btn-info btn-sm\"\u003e\n-        \u003cLink external class=\"w-full cursor-pointer\" href={jobLink(Address.fromEvent(event).toNaddr())}\u003e\n+        \u003cLink\n+          external\n+          class=\"w-full cursor-pointer\"\n+          href={jobLink(Address.fromEvent(event).toNaddr())}\u003e\n           \u003cspan class=\"\"\u003eSatShoot\u003c/span\u003e\n         \u003c/Link\u003e\n       \u003c/Button\u003e\n@@ -86,6 +87,6 @@\n     {#if showActivity}\n       \u003cEventActivity {url} {path} {event} /\u003e\n     {/if}\n-      \u003cEventActions {url} {event} noun=\"Job\" /\u003e\n+    \u003cEventActions {url} {event} noun=\"Job\" /\u003e\n   \u003c/div\u003e\n \u003c/div\u003e\ndiff --git a/src/app/components/JobItem.svelte b/src/app/components/JobItem.svelte\nindex 10e31c3..d3ded38 100644\n--- a/src/app/components/JobItem.svelte\n+++ b/src/app/components/JobItem.svelte\n@@ -1,7 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n   import {nthEq} from \"@welshman/lib\"\n   import {type TrustedEvent} from \"@welshman/util\"\n-  import {formatTimestamp} from \"@welshman/app\"\n+  import {formatTimestamp} from \"@welshman/lib\"\n   import Content from \"@app/components/Content.svelte\"\n   import JobActions from \"./JobActions.svelte\"\n   import NoteCard from \"./NoteCard.svelte\"\ndiff --git a/src/app/components/RepoPicker.svelte b/src/app/components/RepoPicker.svelte\nindex 662527f..e19dc6a 100644\n--- a/src/app/components/RepoPicker.svelte\n+++ b/src/app/components/RepoPicker.svelte\n@@ -1,5 +1,4 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {ctx} from \"@welshman/lib\"\n   import {debounce} from \"throttle-debounce\"\n   import {onMount} from \"svelte\"\n   import { GIT_REPO_BOOKMARK_DTAG } from \"@src/lib/util\"\n@@ -19,7 +18,7 @@\n   import ModalFooter from \"@lib/components/ModalFooter.svelte\"\n   import FieldInline from \"@src/lib/components/FieldInline.svelte\"\n   import {\n-    createFeedController,\n+    makeFeedController,\n     createSearch,\n     publishThunk,\n     repository,\n@@ -42,6 +41,7 @@\n   import Divider from \"@src/lib/components/Divider.svelte\"\n   import { makeGitPath } from \"../routes\"\n   import { goto } from \"$app/navigation\"\n+    import { Router } from \"@welshman/router\"\n \n \n   const url = decodeRelay($page.params.relay)\n@@ -84,7 +84,7 @@\n         const repoEventRelayHint = getTagValue('relays', event.tags)\n \n         const relaysFromRepoPubkey = \n-          ctx.app.router.getRelaysForPubkey(event.pubkey)?.[0] ?? ''\n+        Router.get().getRelaysForPubkey(event.pubkey)?.[0] ?? ''\n \n         const firstHint = \n           relayHints.values().next().value ??\n@@ -157,7 +157,7 @@\n     }\n   })\n \n-  const ctrl = createFeedController({\n+  const ctrl = makeFeedController({\n     useWindowing: true,\n     feed: makeIntersectionFeed(\n       makeWOTFeed({min: 0.1}),\n@@ -193,7 +193,7 @@\n \n     publishThunk({\n       event: eventToPublish,\n-      relays: [url, ...ctx.app.router.FromUser().getUrls()],\n+      relays: [url, ...Router.get().FromUser().getUrls()],\n     })\n \n     $shouldReloadRepos = true;\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 2a08837..456d11c 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -162,6 +162,9 @@ export const jobLink = (naddr: string) =\u003e `https://test.satshoot.com/${naddr}`\n export const gitLink = (naddr: string) =\u003e `https://gitworkshop.dev/${naddr}`\n \n \n+export const jobLink = (naddr: string) =\u003e `https://test.satshoot.com/${naddr}`\n+export const gitLink = (naddr: string) =\u003e `https://gitworkshop.dev/${naddr}`\n+\n export const tagRoom = (room: string, url: string) =\u003e [ROOM, room]\n \n export const getDefaultPubkeys = () =\u003e {\ndiff --git a/src/routes/spaces/[relay]/+layout.svelte b/src/routes/spaces/[relay]/+layout.svelte\nindex 89ddda7..e2e65c3 100644\n--- a/src/routes/spaces/[relay]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/+layout.svelte\n@@ -15,6 +15,7 @@\n   import {decodeRelay, userRoomsByUrl} from \"@app/state\"\n   import {pullConservatively} from \"@app/requests\"\n   import {notifications} from \"@app/notifications\"\n+    import { FREELANCE_JOB } from \"@src/lib/util\"\n   interface Props {\n     children?: import(\"svelte\").Snippet\n   }\n@@ -62,9 +63,12 @@\n     pullConservatively({\n       relays,\n       filters: [\n-        {kinds: [THREAD], since},\n-        {kinds: [COMMENT], \"#K\": [String(THREAD)], since},\n-        ...rooms.map(r =\u003e ({kinds: [MESSAGE], \"#h\": [r], since})),\n+        {kinds: [GROUP_META]},\n+        {kinds: [THREAD, EVENT_TIME], since},\n+        {kinds: [COMMENT], \"#K\": [String(THREAD), String(EVENT_TIME)], since},\n+        {kinds: [FREELANCE_JOB], \"#s\": [\"0\"]},\n+        {kinds: [COMMENT], \"#K\": [String(FREELANCE_JOB)]},\n+        ...rooms.map(room =\u003e ({kinds: [MESSAGE], \"#h\": [room], since})),\n       ],\n     })\n \ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 764dcf5..85b40d9 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -1,45 +1,55 @@\n \u003cscript lang=\"ts\"\u003e\n-  import { decodeRelay, shouldReloadRepos } from \"@src/app/state\"\n-  import { load, tracker } from \"@welshman/app\"\n-  import { pubkey, userMutes } from \"@welshman/app\"\n-  import { getPubkeyTagValues, getListTags, NAMED_BOOKMARKS, getAddressTags, type TrustedEvent, type Filter, Address } from \"@welshman/util\"\n-  import { onMount, tick } from \"svelte\";\n-  import {page} from \"$app/stores\"\n+  import {decodeRelay, shouldReloadRepos} from \"@src/app/state\"\n+  import {tracker} from \"@welshman/app\"\n+  import {load} from \"@welshman/net\"\n+  import {pubkey, userMutes} from \"@welshman/app\"\n+  import {\n+    getPubkeyTagValues,\n+    getListTags,\n+    NAMED_BOOKMARKS,\n+    getAddressTags,\n+    type TrustedEvent,\n+    type Filter,\n+    Address,\n+  } from \"@welshman/util\"\n+  import {onMount, tick} from \"svelte\"\n+  import {page} from \"$app/state\"\n   import {type Writable, writable} from \"svelte/store\"\n-  import { setChecked } from \"@src/app/notifications\"\n+  import {setChecked} from \"@src/app/notifications\"\n   import PageBar from \"@src/lib/components/PageBar.svelte\"\n   import Icon from \"@src/lib/components/Icon.svelte\"\n   import MenuSpaceButton from \"@src/app/components/MenuSpaceButton.svelte\"\n   import Button from \"@src/lib/components/Button.svelte\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n-  import { ctx, sortBy } from \"@welshman/lib\"\n-  import { fly } from \"@src/lib/transition\"\n-  import { pushModal } from \"@src/app/modal\"\n+  import {sortBy} from \"@welshman/lib\"\n+  import {fly} from \"@src/lib/transition\"\n+  import {pushModal} from \"@src/app/modal\"\n   import RepoPicker from \"@src/app/components/RepoPicker.svelte\"\n-  import { GIT_REPO } from \"@src/lib/util\"\n+  import {GIT_REPO} from \"@src/lib/util\"\n   import GitItem from \"@src/app/components/GitItem.svelte\"\n+  import {Router} from \"@welshman/router\"\n \n-  const url = decodeRelay($page.params.relay)\n+  const url = decodeRelay(page.params.relay)\n \n-  const bookmarkFilter = {kinds: [NAMED_BOOKMARKS], authors: [pubkey.get()!] }\n+  const bookmarkFilter = {kinds: [NAMED_BOOKMARKS], authors: [pubkey.get()!]}\n \n   const mutedPubkeys = getPubkeyTagValues(getListTags($userMutes))\n \n-  let repoFilter:Filter\n+  let repoFilter: Filter\n \n   let loading = $state(true)\n \n-  const events: Writable\u003cTrustedEvent[]\u003e = writable([]);\n+  const events: Writable\u003cTrustedEvent[]\u003e = writable([])\n \n-  let loadedBookmarkedRepos: Array\u003c{address:string, event: TrustedEvent, relayHint: string}\u003e = []\n+  let loadedBookmarkedRepos: Array\u003c{address: string; event: TrustedEvent; relayHint: string}\u003e = []\n \n   const loadBookmarkedRepos = async () =\u003e {\n     loadedBookmarkedRepos = []\n     loading = true\n     await tick()\n     const bookmark = await load({\n-      relays: [url, ...ctx.app.router.FromUser().getUrls()],\n-      filters: [ bookmarkFilter ],\n+      relays: [url, ...Router.get().FromUser().getUrls()],\n+      filters: [bookmarkFilter],\n     })\n \n     if (bookmark.length \u003e 0) {\n@@ -53,7 +63,7 @@\n         dTagValues.push(value.split(\":\")[2])\n         authors.push(value.split(\":\")[1])\n         relaysOfAddresses.set(value, relayHint || \"\")\n-        if (relayHint){\n+        if (relayHint) {\n           relayHints.push(relayHint)\n         }\n       })\n@@ -62,23 +72,23 @@\n \n       const loadedRepos = await load({\n         relays: relayHints,\n-        filters: [ repoFilter ]\n+        filters: [repoFilter],\n       })\n-      loadedRepos.forEach((repo) =\u003e {\n+      loadedRepos.forEach(repo =\u003e {\n         const address = Address.fromEvent(repo)\n         const addressString = address.toString()\n         const relayHintFromEvent = tracker.getRelays(repo.id)\n-        const relaysFromAddressPubkey = \n-          ctx.app.router.getRelaysForPubkey(repo.pubkey)?.[0]\n+        const relaysFromAddressPubkey = Router.get().getRelaysForPubkey(repo.pubkey)?.[0]\n \n-        const hint = relaysOfAddresses.get(addressString) ??\n-                      Array.from(relayHintFromEvent)[0] ??\n-                      relaysFromAddressPubkey\n+        const hint =\n+          relaysOfAddresses.get(addressString) ??\n+          Array.from(relayHintFromEvent)[0] ??\n+          relaysFromAddressPubkey\n \n         loadedBookmarkedRepos.push({\n           address: addressString,\n           event: repo,\n-          relayHint: hint\n+          relayHint: hint,\n         })\n       })\n       events.update(() =\u003e {\n@@ -87,34 +97,28 @@\n           loadedRepos.filter(e =\u003e !mutedPubkeys.includes(e.pubkey)),\n         )\n       })\n-\n-      \n     }\n-    loading = false;\n+    loading = false\n   }\n \n   onMount(() =\u003e {\n     loadBookmarkedRepos()\n \n     return () =\u003e {\n-      setChecked($page.url.pathname)\n+      setChecked(page.url.pathname)\n     }\n   })\n \n   $effect(() =\u003e {\n     if ($shouldReloadRepos) {\n       loadBookmarkedRepos()\n-      $shouldReloadRepos = false;\n+      $shouldReloadRepos = false\n     }\n   })\n \n   const onAddRepo = () =\u003e {\n-    pushModal(\n-      RepoPicker,\n-      {selectedRepos: loadedBookmarkedRepos},\n-    )\n+    pushModal(RepoPicker, {selectedRepos: loadedBookmarkedRepos})\n   }\n-\n \u003c/script\u003e\n \n \u003cdiv class=\"relative flex h-screen flex-col\"\u003e\n@@ -151,7 +155,7 @@\n     {:else}\n       {#each $events as event (event.id)}\n         \u003cdiv in:fly class=\"\"\u003e\n-          \u003cGitItem {url} {event}/\u003e\n+          \u003cGitItem {url} {event} /\u003e\n         \u003c/div\u003e\n       {/each}\n     {/if}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 45d8a2d..1208f82 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -1,7 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n   import {onMount, tick} from \"svelte\"\n   import {page} from \"$app/stores\"\n-  import {sortBy, nthEq, now, ctx} from \"@welshman/lib\"\n+  import {sortBy, nthEq, now} from \"@welshman/lib\"\n   import {\n     Address,\n     GIT_ISSUE,\n@@ -10,9 +10,9 @@\n     GIT_STATUS_DRAFT,\n     GIT_STATUS_OPEN,\n     type Filter,\n-    type TrustedEvent}\n-  from \"@welshman/util\"\n-  import {load, repository, subscribe} from \"@welshman/app\"\n+    type TrustedEvent,\n+  } from \"@welshman/util\"\n+  import {repository} from \"@welshman/app\"\n   import {deriveEvents} from \"@welshman/store\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import PageBar from \"@lib/components/PageBar.svelte\"\n@@ -21,27 +21,28 @@\n   import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n   import {decodeRelay} from \"@app/state\"\n   import {setChecked} from \"@app/notifications\"\n-  import type { Subscription } from \"@welshman/net\"\n+  import {load} from \"@welshman/net\"\n   import GitItem from \"@src/app/components/GitItem.svelte\"\n   import GitIssueItem from \"@src/app/components/GitIssueItem.svelte\"\n-  import { nip19 } from \"nostr-tools\"\n-  import { getRootEventTagValue } from \"@src/lib/util\"\n+  import {nip19} from \"nostr-tools\"\n+  import {getRootEventTagValue} from \"@src/lib/util\"\n   import Divider from \"@src/lib/components/Divider.svelte\"\n-  import type { AddressPointer } from \"nostr-tools/nip19\"\n-  import { fly } from \"svelte/transition\"\n+  import type {AddressPointer} from \"nostr-tools/nip19\"\n+  import {fly} from \"svelte/transition\"\n+  import {Router} from \"@welshman/router\"\n \n   const {relay, id} = $page.params\n   const url = decodeRelay(relay)\n \n   let repoEvent: TrustedEvent | undefined = $state(undefined)\n \n-  let gitworkshopLink = $state(\"\") \n+  let gitworkshopLink = $state(\"\")\n \n   let statusSub: Subscription\n   let newIssuesSub: Subscription\n   const statusOfNewIssuesSubs: Subscription[] = []\n \n-  let repoRelays:string[] = $state([])\n+  let repoRelays: string[] = $state([])\n \n   const back = () =\u003e history.back()\n \n@@ -54,17 +55,14 @@\n     }\n   })\n \n-  const statuses = $derived.by(()=\u003e{\n+  const statuses = $derived.by(() =\u003e {\n     if ($issues) {\n-      const statusFilter = [{\n-        kinds: [\n-          GIT_STATUS_OPEN,\n-          GIT_STATUS_COMPLETE,\n-          GIT_STATUS_CLOSED,\n-          GIT_STATUS_DRAFT\n-        ],\n-        \"#e\": $issues.map(issue=\u003eissue.id)\n-      }]\n+      const statusFilter = [\n+        {\n+          kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+          \"#e\": $issues.map(issue =\u003e issue.id),\n+        },\n+      ]\n       return deriveEvents(repository, {filters: statusFilter})\n     }\n   })\n@@ -74,10 +72,8 @@\n       const latestStatuses = []\n       for (const issue of $issues) {\n         // Need deep copy, no mutations allowed\n-        let latestStatus: {sid: string, ts: number} | undefined\n-        const filteredStatuses = $statuses.filter(\n-          s=\u003egetRootEventTagValue(s.tags)===issue.id\n-        )\n+        let latestStatus: {sid: string; ts: number} | undefined\n+        const filteredStatuses = $statuses.filter(s =\u003e getRootEventTagValue(s.tags) === issue.id)\n         if (filteredStatuses.length \u003e 0) {\n           latestStatus = {sid: \"\", ts: 0}\n           for (const status of filteredStatuses) {\n@@ -86,18 +82,16 @@\n             }\n           }\n         }\n-        latestStatuses.push(\n-          {issue: {id: issue.id, ts: issue.created_at}, latestStatus: latestStatus}\n-        )\n+        latestStatuses.push({\n+          issue: {id: issue.id, ts: issue.created_at},\n+          latestStatus: latestStatus,\n+        })\n       }\n \n-      return sortBy(\n-        e =\u003e {\n-          const createdAt = e.latestStatus?.ts ?? e.issue.ts;\n-          return -createdAt;\n-        },\n-        latestStatuses\n-      )\n+      return sortBy(e =\u003e {\n+        const createdAt = e.latestStatus?.ts ?? e.issue.ts\n+        return -createdAt\n+      }, latestStatuses)\n     }\n   })\n \n@@ -105,42 +99,38 @@\n   let failedToLoad = $state(false)\n \n   const initialize = async () =\u003e {\n-    setTimeout(\n-      ()=\u003e{\n-        if (loading) failedToLoad = true\n-      },\n-      8000\n-    )\n+    setTimeout(() =\u003e {\n+      if (loading) failedToLoad = true\n+    }, 8000)\n     loading = true\n     await tick()\n     const naddr = nip19.decode(id).data as AddressPointer\n-    const backupRelays = [\n-      ...ctx.app.router.FromPubkey(naddr.pubkey).getUrls()\n-    ]\n+    const backupRelays = [...Router.get().FromPubkey(naddr.pubkey).getUrls()]\n     const events = await load({\n       relays: naddr.relays ?? backupRelays,\n-      filters: [{\n-        authors: [naddr.pubkey],\n-        kinds: [naddr.kind], \n-        '#d': [naddr.identifier]\n-      }]\n+      filters: [\n+        {\n+          authors: [naddr.pubkey],\n+          kinds: [naddr.kind],\n+          \"#d\": [naddr.identifier],\n+        },\n+      ],\n     })\n-    if (events.length \u003e 0){\n+    if (events.length \u003e 0) {\n       repoEvent = events[0]\n       const repoNpub = nip19.npubEncode(repoEvent.pubkey)\n       const repoDtag = repoEvent.tags.find(nthEq(0, \"d\"))?.[1]\n       gitworkshopLink = `https://gitworkshop.dev/${repoNpub}/${repoDtag}`\n       const address = Address.fromEvent(repoEvent).toString()\n \n-      const [tagId, ...relays] = repoEvent.tags.find(\n-        nthEq(0, \"relays\")\n-      ) ?? naddr.relays ?? backupRelays\n+      const [tagId, ...relays] =\n+        repoEvent.tags.find(nthEq(0, \"relays\")) ?? naddr.relays ?? backupRelays\n \n       repoRelays = relays\n \n-      const issuesFilter:Filter = {\n-          kinds: [GIT_ISSUE],\n-          \"#a\": [address],\n+      const issuesFilter: Filter = {\n+        kinds: [GIT_ISSUE],\n+        \"#a\": [address],\n       }\n \n       const issues = await load({\n@@ -151,14 +141,9 @@\n       loading = false\n       await tick()\n \n-      const statusesOfAllIssuesFilter:Filter = {\n-        kinds: [\n-          GIT_STATUS_OPEN,\n-          GIT_STATUS_COMPLETE,\n-          GIT_STATUS_CLOSED,\n-          GIT_STATUS_DRAFT\n-        ],\n-        \"#e\": issues.map(issue=\u003eissue.id),\n+      const statusesOfAllIssuesFilter: Filter = {\n+        kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+        \"#e\": issues.map(issue =\u003e issue.id),\n       }\n \n       const statuses = await load({\n@@ -179,25 +164,22 @@\n       newIssuesSub = subscribe({\n         relays: relays,\n         filters: [issuesFilter],\n-        onEvent: (issue:TrustedEvent) =\u003e {\n-          const statusFilter:Filter[] = [{\n-            kinds: [\n-              GIT_STATUS_OPEN,\n-              GIT_STATUS_COMPLETE,\n-              GIT_STATUS_CLOSED,\n-              GIT_STATUS_DRAFT\n-            ],\n-            \"#e\": [issue.id],\n-            since: now(),\n-          }]\n+        onEvent: (issue: TrustedEvent) =\u003e {\n+          const statusFilter: Filter[] = [\n+            {\n+              kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+              \"#e\": [issue.id],\n+              since: now(),\n+            },\n+          ]\n           const sub = subscribe({\n             relays: relays,\n             filters: statusFilter,\n             onEvent: (status: TrustedEvent) =\u003e {\n               // console.log(\"Received new status\",status)\n-            }\n+            },\n           })\n-          statusOfNewIssuesSubs.push(sub) \n+          statusOfNewIssuesSubs.push(sub)\n         },\n       })\n     }\n@@ -214,7 +196,7 @@\n         newIssuesSub.close()\n       }\n       if (statusOfNewIssuesSubs.length \u003e 0) {\n-        statusOfNewIssuesSubs.forEach((s) =\u003e {\n+        statusOfNewIssuesSubs.forEach(s =\u003e {\n           s.close()\n         })\n       }\n@@ -233,7 +215,7 @@\n       \u003c/div\u003e\n     {/snippet}\n     {#snippet title()}\n-      \u003ch1 class=\"text-xl text-center\"\u003eRepo Issues\u003c/h1\u003e\n+      \u003ch1 class=\"text-center text-xl\"\u003eRepo Issues\u003c/h1\u003e\n     {/snippet}\n     {#snippet action()}\n       \u003cdiv\u003e\n@@ -242,17 +224,13 @@\n     {/snippet}\n   \u003c/PageBar\u003e\n   {#if !loading \u0026\u0026 repoEvent}\n-    \u003cGitItem {url} event={repoEvent} showIssues={false}/\u003e\n+    \u003cGitItem {url} event={repoEvent} showIssues={false} /\u003e\n     \u003cDivider /\u003e\n     {#if orderedElements}\n-      {#each orderedElements as {issue:issueItem, latestStatus} (issueItem.id)}\n-        {@const foundIssue = $issues!.find(i=\u003ei.id === issueItem.id) as TrustedEvent}\n-        {@const status = $statuses?.find(s=\u003es.id === latestStatus?.sid)}\n-        \u003cGitIssueItem\n-          issue={foundIssue}\n-          latestStatus={status}\n-          showThreadAction={true}\n-        /\u003e\n+      {#each orderedElements as { issue: issueItem, latestStatus } (issueItem.id)}\n+        {@const foundIssue = $issues!.find(i =\u003e i.id === issueItem.id) as TrustedEvent}\n+        {@const status = $statuses?.find(s =\u003e s.id === latestStatus?.sid)}\n+        \u003cGitIssueItem issue={foundIssue} latestStatus={status} showThreadAction={true} /\u003e\n       {/each}\n       {#if orderedElements.length === 0}\n         \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n@@ -270,5 +248,3 @@\n     \u003c/p\u003e\n   {/if}\n \u003c/div\u003e\n-\n-\ndiff --git a/src/routes/spaces/[relay]/jobs/+page.svelte b/src/routes/spaces/[relay]/jobs/+page.svelte\nindex ac47bcd..2eb2319 100644\n--- a/src/routes/spaces/[relay]/jobs/+page.svelte\n+++ b/src/routes/spaces/[relay]/jobs/+page.svelte\n@@ -1,135 +1,107 @@\n \u003cscript lang=\"ts\"\u003e\n-  import { decodeRelay, deriveEventsForUrl } from \"@src/app/state\"\n-  import { FREELANCE_JOB } from \"@src/lib/util\"\n-  import { createFeedController, repository, userMutes } from \"@welshman/app\"\n-  import { getPubkeyTagValues, getListTags, COMMENT } from \"@welshman/util\"\n-  import { onMount } from \"svelte\";\n-  import {page} from \"$app/stores\"\n-  import { derived } from \"svelte/store\"\n-  import { setChecked } from \"@src/app/notifications\"\n+  import {decodeRelay, deriveEventsForUrl, getEventsForUrl} from \"@src/app/state\"\n+  import {FREELANCE_JOB} from \"@src/lib/util\"\n+  import {COMMENT, getListTags, getPubkeyTagValues, type TrustedEvent} from \"@welshman/util\"\n+  import {onMount} from \"svelte\"\n+  import {page} from \"$app/state\"\n+  import {derived, readable, type Readable} from \"svelte/store\"\n+  import {setChecked} from \"@src/app/notifications\"\n   import PageBar from \"@src/lib/components/PageBar.svelte\"\n   import Icon from \"@src/lib/components/Icon.svelte\"\n   import MenuSpaceButton from \"@src/app/components/MenuSpaceButton.svelte\"\n   import Button from \"@src/lib/components/Button.svelte\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n-  import { deriveEvents, throttled } from \"@welshman/store\"\n-  import { sortBy, min, nthEq} from \"@welshman/lib\"\n-  import { feedFromFilters, makeIntersectionFeed, makeRelayFeed, makeUnionFeed, makeWOTFeed } from \"@welshman/feeds\"\n-  import { createScroller, type Scroller } from \"@src/lib/html\"\n   import JobItem from \"@src/app/components/JobItem.svelte\"\n-  import { fly } from \"@src/lib/transition\"\n+  import {fly} from \"@src/lib/transition\"\n   import Link from \"@src/lib/components/Link.svelte\"\n+  import {makeFeed} from \"@src/app/requests\"\n+  import PageContent from \"@src/lib/components/PageContent.svelte\"\n+  import {userMutes} from \"@welshman/app\"\n \n-  const url = decodeRelay($page.params.relay)\n-\n-  const jobFilter = {kinds: [FREELANCE_JOB], \"#s\": [\"0\"]}\n-  const commentFilter = {kinds: [COMMENT], \"#K\": [String(FREELANCE_JOB)]}\n-  const feed = feedFromFilters([jobFilter, commentFilter])\n-\n-  const jobs = deriveEvents(repository, { filters: [jobFilter] })\n-\n-  const comments = deriveEventsForUrl(url, [commentFilter])\n+  const url = decodeRelay(page.params.relay)\n   const mutedPubkeys = getPubkeyTagValues(getListTags($userMutes))\n+  const jobs: TrustedEvent[] = $state([])\n+  const comments: TrustedEvent[] = $state([])\n \n-  const events = throttled(\n-    800,\n-    derived([jobs, comments], ([$jobs, $comments]) =\u003e {\n-      const scores = new Map\u003cstring, number\u003e()\n-\n-      for (const comment of $comments) {\n-        const id = comment.tags.find(nthEq(0, \"E\"))?.[1]\n-\n-        if (id) {\n-          scores.set(id, min([scores.get(id), -comment.created_at]))\n-        }\n-      }\n-\n-      return sortBy(\n-        e =\u003e min([scores.get(e.id), -e.created_at]),\n-        $jobs.filter(e =\u003e !mutedPubkeys.includes(e.pubkey)),\n-      )\n-    }),\n-  )\n-\n-  const ctrl = createFeedController({\n-    useWindowing: true,\n-    feed: makeIntersectionFeed(\n-      makeUnionFeed(\n-        makeWOTFeed({min: 0.1}), \n-        makeRelayFeed(url)\n-      ),\n-      feed\n-    ),\n-    onExhausted: () =\u003e {\n-      loading = false\n-    },\n-  })\n-\n-  let limit = 20\n+  let element: HTMLElement | undefined = $state()\n   let loading = $state(true)\n-  let element: Element | undefined = $state()\n-  let scroller: Scroller\n+  const limit = 20\n \n   onMount(() =\u003e {\n-    scroller = createScroller({\n+    const {cleanup} = makeFeed({\n       element: element!,\n-      delay: 300,\n-      threshold: 3000,\n-      onScroll: () =\u003e {\n-        limit += 20\n+      relays: [url],\n+      feedFilters: [{kinds: [FREELANCE_JOB]}],\n+      subscriptionFilters: [\n+        {kinds: [FREELANCE_JOB]},\n+        {kinds: [COMMENT], \"#K\": [String(FREELANCE_JOB)]},\n+      ],\n+      initialEvents: getEventsForUrl(url, [{kinds: [FREELANCE_JOB], limit}]),\n+      onEvent: event =\u003e {\n+        if (event.kind === FREELANCE_JOB) {\n+          jobs.push(event)\n+        }\n \n-        if ($events.length - limit \u003c 10) {\n-          ctrl.load(50)\n+        if (event.kind === COMMENT) {\n+          comments.push(event)\n         }\n       },\n+      onExhausted: () =\u003e {\n+        loading = false\n+      },\n     })\n \n     return () =\u003e {\n-      scroller?.stop()\n-      setChecked($page.url.pathname)\n+      cleanup()\n+      setChecked(page.url.pathname)\n     }\n-  });\n-\n+  })\n \u003c/script\u003e\n \n-\u003cdiv class=\"relative flex h-screen flex-col\" bind:this={element}\u003e\n-  \u003cPageBar\u003e\n-    {#snippet icon()}\n-      \u003cdiv class=\"center\"\u003e\n-        \u003cIcon icon=\"jobs\" /\u003e\n-      \u003c/div\u003e\n-    {/snippet}\n-    {#snippet title()}\n-      \u003cstrong\u003eJobs\u003c/strong\u003e\n-    {/snippet}\n-    {#snippet action()}\n-      \u003cdiv class=\"row-2\"\u003e\n-        \u003cButton class=\"btn btn-primary btn-sm\"\u003e\n-          \u003cLink external href=\"https://test.satshoot.com/post-job\" class=\"bg-primary flex items-center gap-x-2\"\u003e\n-            \u003cIcon icon=\"jobs\" /\u003e\n-            \u003cspan class=\"\"\u003eCreate Job\u003c/span\u003e\n-          \u003c/Link\u003e\n-        \u003c/Button\u003e\n-        \u003cMenuSpaceButton {url} /\u003e\n-      \u003c/div\u003e\n-    {/snippet}\n-  \u003c/PageBar\u003e\n-  \u003cdiv class=\"flex flex-grow flex-col gap-2 overflow-auto p-2\"\u003e\n-    {#each $events as event (event.id)}\n-      \u003cdiv in:fly\u003e\n-        \u003cJobItem {url} {event} showComment={true} showExternal={true} showThreadAction={true} showActivity={true}/\u003e\n-      \u003c/div\u003e\n-    {/each}\n-    {#if loading || $events.length === 0}\n-      \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n-        \u003cSpinner {loading}\u003e\n-          {#if loading}\n-            Looking for jobs...\n-          {:else if $events.length === 0}\n-            No Jobs found.\n-          {/if}\n-        \u003c/Spinner\u003e\n-      \u003c/p\u003e\n-    {/if}\n-  \u003c/div\u003e\n-\u003c/div\u003e\n+\u003cPageBar\u003e\n+  {#snippet icon()}\n+    \u003cdiv class=\"center\"\u003e\n+      \u003cIcon icon=\"jobs\" /\u003e\n+    \u003c/div\u003e\n+  {/snippet}\n+  {#snippet title()}\n+    \u003cstrong\u003eJobs\u003c/strong\u003e\n+  {/snippet}\n+  {#snippet action()}\n+    \u003cdiv class=\"row-2\"\u003e\n+      \u003cButton class=\"btn btn-primary btn-sm\"\u003e\n+        \u003cLink\n+          external\n+          href=\"https://test.satshoot.com/post-job\"\n+          class=\"flex items-center gap-x-2 bg-primary\"\u003e\n+          \u003cIcon icon=\"jobs\" /\u003e\n+          \u003cspan class=\"\"\u003eCreate Job\u003c/span\u003e\n+        \u003c/Link\u003e\n+      \u003c/Button\u003e\n+      \u003cMenuSpaceButton {url} /\u003e\n+    \u003c/div\u003e\n+  {/snippet}\n+\u003c/PageBar\u003e\n+\n+\u003cPageContent bind:element class=\"flex flex-col gap-2 p-2 pt-4\"\u003e\n+  {#each jobs as event (event.id)}\n+    \u003cdiv class={\"job-event\" + event.id} in:fly\u003e\n+      \u003cJobItem\n+        {url}\n+        {event}\n+        showComment={true}\n+        showExternal={true}\n+        showThreadAction={true}\n+        showActivity={true} /\u003e\n+    \u003c/div\u003e\n+  {/each}\n+  \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n+    \u003cSpinner {loading}\u003e\n+      {#if loading}\n+        Looking for jobs...\n+      {:else if jobs.length === 0}\n+        No Jobs found.\n+      {/if}\n+    \u003c/Spinner\u003e\n+  \u003c/p\u003e\n+\u003c/PageContent\u003e\ndiff --git a/src/routes/spaces/[relay]/jobs/[id]/+page.svelte b/src/routes/spaces/[relay]/jobs/[id]/+page.svelte\nindex 227f163..c67037d 100644\n--- a/src/routes/spaces/[relay]/jobs/[id]/+page.svelte\n+++ b/src/routes/spaces/[relay]/jobs/[id]/+page.svelte\n@@ -1,9 +1,9 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {onMount} from \"svelte\"\n+  import {onDestroy, onMount} from \"svelte\"\n   import {page} from \"$app/stores\"\n-  import {sortBy, sleep} from \"@welshman/lib\"\n-  import {COMMENT} from \"@welshman/util\"\n-  import {repository, subscribe} from \"@welshman/app\"\n+  import {sortBy, sleep, now} from \"@welshman/lib\"\n+  import {COMMENT, type TrustedEvent} from \"@welshman/util\"\n+  import {repository} from \"@welshman/app\"\n   import {deriveEvents} from \"@welshman/store\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import PageBar from \"@lib/components/PageBar.svelte\"\n@@ -14,10 +14,13 @@\n   import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n   import JobActions from \"@app/components/JobActions.svelte\"\n   import EventReply from \"@app/components/EventReply.svelte\"\n-  import {deriveEvent, decodeRelay} from \"@app/state\"\n+  import {deriveEvent, decodeRelay, getEventsForUrl} from \"@app/state\"\n   import {setChecked} from \"@app/notifications\"\n   import JobItem from \"@src/app/components/JobItem.svelte\"\n   import Divider from \"@src/lib/components/Divider.svelte\"\n+  import {readable, type Readable} from \"svelte/store\"\n+  import {on} from \"svelte/events\"\n+    import { makeFeed } from \"@src/app/requests\"\n \n   const {relay, id} = $page.params\n   const url = decodeRelay(relay)\n@@ -42,14 +45,34 @@\n   let showAll = $state(false)\n   let showReply = $state(false)\n \n+  let events: Readable\u003cTrustedEvent[]\u003e = $state(readable([]))\n+  let cleanup: () =\u003e void\n+  let loadingEvents = $state(true)\n+  let element: HTMLElement | undefined = $state()\n+\n   onMount(() =\u003e {\n-    const sub = subscribe({relays: [url], filters})\n+    ;({events, cleanup} = makeFeed({\n+      element: element!,\n+      relays: [url],\n+      feedFilters: filters,\n+      subscriptionFilters: [{kinds: [COMMENT], \"#E\": [id], since: now()}],\n+      initialEvents: getEventsForUrl(url, [{...filters, limit: 20}]),\n+      onExhausted: () =\u003e {\n+        loadingEvents = false\n+      },\n+    }))\n+\n \n     return () =\u003e {\n-      sub.close()\n-      setChecked($page.url.pathname)\n     }\n   })\n+\n+  onDestroy(() =\u003e {\n+    cleanup()\n+    setTimeout(() =\u003e {\n+      setChecked($page.url.pathname)\n+    }, 800)\n+  })\n \u003c/script\u003e\n \n \u003cdiv class=\"relative flex flex-col-reverse gap-3 px-2\"\u003e\n@@ -79,7 +102,7 @@\n       \u003c/div\u003e\n     {/if}\n     \u003cDivider /\u003e\n-    \u003cJobItem {url} event={$event} showActivity={true} showExternal={true} showThreadAction={true}/\u003e\n+    \u003cJobItem {url} event={$event} showActivity={true} showExternal={true} showThreadAction={true} /\u003e\n   {:else}\n     {#await sleep(5000)}\n       \u003cSpinner loading\u003eLoading comments...\u003c/Spinner\u003e\n@@ -96,7 +119,7 @@\n       \u003c/div\u003e\n     {/snippet}\n     {#snippet title()}\n-      \u003ch1 class=\"text-xl sm:text-lg text-center\"\u003eJob Discussion\u003c/h1\u003e\n+      \u003ch1 class=\"text-center text-xl sm:text-lg\"\u003eJob Discussion\u003c/h1\u003e\n     {/snippet}\n     {#snippet action()}\n       \u003cdiv\u003e\n@@ -108,4 +131,3 @@\n {#if showReply}\n   \u003cEventReply {url} event={$event} onClose={closeReply} onSubmit={closeReply} /\u003e\n {/if}\n-\ndiff --git a/src/routes/spaces/[relay]/threads/[id]/+page.svelte b/src/routes/spaces/[relay]/threads/[id]/+page.svelte\nindex febd45b..fcd6bb7 100644\n--- a/src/routes/spaces/[relay]/threads/[id]/+page.svelte\n+++ b/src/routes/spaces/[relay]/threads/[id]/+page.svelte\n@@ -3,7 +3,8 @@\n   import {page} from \"$app/stores\"\n   import {sortBy, sleep} from \"@welshman/lib\"\n   import {COMMENT, getTag, getTagValue, GIT_ISSUE, type Filter, type TrustedEvent} from \"@welshman/util\"\n-  import {load, repository, subscribe, type PartialSubscribeRequest} from \"@welshman/app\"\n+  import { repository, type PartialSubscribeRequest} from \"@welshman/app\"\n+  import {load} from \"@welshman/net\"\n   import {deriveEvents} from \"@welshman/store\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import PageBar from \"@lib/components/PageBar.svelte\"\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-9k18il6j","title":"From 932ed111a31454a2be836da718dae9af48b1a5fe Mon Sep 17 00:00:00 2001","description":"From 932ed111a31454a2be836da718dae9af48b1a5fe Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Tue, 27 May 2025 15:04:44 -0700\nSubject: [PATCH 2/67] Remove general room\n\n---\n src/app/components/AlertAdd.svelte              | 10 ++--------\n src/app/components/CalendarEventForm.svelte     |  3 +--\n src/app/components/ChannelName.svelte           |  8 ++------\n src/app/components/EventReply.svelte            |  4 ++--\n src/app/components/ThreadCreate.svelte          | 10 ++--------\n src/app/state.ts                                | 17 +++--------------\n src/routes/spaces/+layout.svelte                |  2 +-\n src/routes/spaces/[relay]/[room]/+page.svelte   | 33 +++++++++++++++------------------\n src/routes/spaces/[relay]/calendar/+page.svelte |  8 +++-----\n 9 files changed, 31 insertions(+), 64 deletions(-)\n\ndiff --git a/src/app/components/AlertAdd.svelte b/src/app/components/AlertAdd.svelte\nindex 96d4bd6..4717874 100644\n--- a/src/app/components/AlertAdd.svelte\n+++ b/src/app/components/AlertAdd.svelte\n@@ -14,13 +14,7 @@\n   import ModalFooter from \"@lib/components/ModalFooter.svelte\"\n   import InfoBunker from \"@app/components/InfoBunker.svelte\"\n   import BunkerConnect, {BunkerConnectController} from \"@app/components/BunkerConnect.svelte\"\n-  import {\n-    GENERAL,\n-    alerts,\n-    getMembershipUrls,\n-    getMembershipRoomsByUrl,\n-    userMembership,\n-  } from \"@app/state\"\n+  import {alerts, getMembershipUrls, getMembershipRoomsByUrl, userMembership} from \"@app/state\"\n   import {loadAlertStatuses} from \"@app/requests\"\n   import {publishAlert} from \"@app/commands\"\n   import {pushToast} from \"@app/toast\"\n@@ -107,7 +101,7 @@\n       display.push(\"chat\")\n       filters.push({\n         kinds: [MESSAGE],\n-        \"#h\": [GENERAL, ...getMembershipRoomsByUrl(relay, $userMembership)],\n+        \"#h\": getMembershipRoomsByUrl(relay, $userMembership),\n       })\n     }\n \ndiff --git a/src/app/components/CalendarEventForm.svelte b/src/app/components/CalendarEventForm.svelte\nindex cdbf78c..cd0725f 100644\n--- a/src/app/components/CalendarEventForm.svelte\n+++ b/src/app/components/CalendarEventForm.svelte\n@@ -13,7 +13,7 @@\n   import ModalFooter from \"@lib/components/ModalFooter.svelte\"\n   import DateTimeInput from \"@lib/components/DateTimeInput.svelte\"\n   import EditorContent from \"@app/editor/EditorContent.svelte\"\n-  import {PROTECTED, GENERAL, tagRoom} from \"@app/state\"\n+  import {PROTECTED} from \"@app/state\"\n   import {makeEditor} from \"@app/editor\"\n   import {pushToast} from \"@app/toast\"\n \n@@ -73,7 +73,6 @@\n         [\"end\", end.toString()],\n         ...daysBetween(start, end).map(D =\u003e [\"D\", D.toString()]),\n         ...ed.storage.nostr.getEditorTags(),\n-        tagRoom(GENERAL, url),\n         PROTECTED,\n       ],\n     })\ndiff --git a/src/app/components/ChannelName.svelte b/src/app/components/ChannelName.svelte\nindex 5199bb7..e6c23cb 100644\n--- a/src/app/components/ChannelName.svelte\n+++ b/src/app/components/ChannelName.svelte\n@@ -1,11 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {GENERAL, channelsById, makeChannelId} from \"@app/state\"\n+  import {channelsById, makeChannelId} from \"@app/state\"\n \n   const {url, room} = $props()\n \u003c/script\u003e\n \n-{#if room === GENERAL}\n-  general\n-{:else}\n-  {$channelsById.get(makeChannelId(url, room))?.name || room}\n-{/if}\n+{$channelsById.get(makeChannelId(url, room))?.name || room}\ndiff --git a/src/app/components/EventReply.svelte b/src/app/components/EventReply.svelte\nindex 1320721..7765c47 100644\n--- a/src/app/components/EventReply.svelte\n+++ b/src/app/components/EventReply.svelte\n@@ -8,7 +8,7 @@\n   import ModalFooter from \"@lib/components/ModalFooter.svelte\"\n   import EditorContent from \"@app/editor/EditorContent.svelte\"\n   import {publishComment} from \"@app/commands\"\n-  import {tagRoom, GENERAL, PROTECTED} from \"@app/state\"\n+  import {PROTECTED} from \"@app/state\"\n   import {makeEditor} from \"@app/editor\"\n   import {pushToast} from \"@app/toast\"\n \n@@ -23,7 +23,7 @@\n \n     const ed = await editor\n     const content = ed.getText({blockSeparator: \"\\n\"}).trim()\n-    const tags = [...ed.storage.nostr.getEditorTags(), tagRoom(GENERAL, url), PROTECTED]\n+    const tags = [...ed.storage.nostr.getEditorTags(), PROTECTED]\n \n     if (!content) {\n       return pushToast({\ndiff --git a/src/app/components/ThreadCreate.svelte b/src/app/components/ThreadCreate.svelte\nindex edac8d9..53e7c93 100644\n--- a/src/app/components/ThreadCreate.svelte\n+++ b/src/app/components/ThreadCreate.svelte\n@@ -10,7 +10,7 @@\n   import ModalFooter from \"@lib/components/ModalFooter.svelte\"\n   import EditorContent from \"@app/editor/EditorContent.svelte\"\n   import {pushToast} from \"@app/toast\"\n-  import {GENERAL, tagRoom, PROTECTED} from \"@app/state\"\n+  import {PROTECTED} from \"@app/state\"\n   import {makeEditor} from \"@app/editor\"\n   import { FREELANCE_JOB } from \"@src/lib/util\"\n     import { goto } from \"$app/navigation\"\n@@ -62,13 +62,7 @@\n       if (relayHint) jobOrGitIssueTag.push(relayHint)\n     }\n \n-    const tags = [\n-      ...ed.storage.nostr.getEditorTags(),\n-      tagRoom(GENERAL, url),\n-      [\"title\", titleToPost],\n-      PROTECTED,\n-    ]\n-    if (jobOrGitIssueTag) tags.push(jobOrGitIssueTag)\n+    const tags = [...ed.storage.nostr.getEditorTags(), [\"title\", title], PROTECTED]\n \n     publishThunk({\n       relays: [url],\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 2a4b32d..811e785 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -72,8 +72,6 @@ export const fromCsv = (s: string) =\u003e (s || \"\").split(\",\").filter(identity)\n \n export const ROOM = \"h\"\n \n-export const GENERAL = \"_\"\n-\n export const PROTECTED = [\"-\"]\n \n export const ALERT = 32830\n@@ -611,13 +609,8 @@ export const channelsByUrl = derived(channelsById, $channelsById =\u003e {\n   return $channelsByUrl\n })\n \n-export const displayChannel = (url: string, room: string) =\u003e {\n-  if (room === GENERAL) {\n-    return \"general\"\n-  }\n-\n-  return channelsById.get().get(makeChannelId(url, room))?.name || room\n-}\n+export const displayChannel = (url: string, room: string) =\u003e\n+  channelsById.get().get(makeChannelId(url, room))?.name || room\n \n export const roomComparator = (url: string) =\u003e (room: string) =\u003e\n   displayChannel(url, room).toLowerCase()\n@@ -662,17 +655,13 @@ export const userRoomsByUrl = withGetter(\n       addToMapKey($userRoomsByUrl, normalizeRelayUrl(url), room)\n     }\n \n-    for (const url of getRelayTagValues(tags)) {\n-      addToMapKey($userRoomsByUrl, normalizeRelayUrl(url), GENERAL)\n-    }\n-\n     return $userRoomsByUrl\n   }),\n )\n \n export const deriveUserRooms = (url: string) =\u003e\n   derived(userRoomsByUrl, $userRoomsByUrl =\u003e\n-    sortBy(roomComparator(url), uniq(Array.from($userRoomsByUrl.get(url) || [GENERAL]))),\n+    sortBy(roomComparator(url), uniq(Array.from($userRoomsByUrl.get(url) || []))),\n   )\n \n export const deriveOtherRooms = (url: string) =\u003e\ndiff --git a/src/routes/spaces/+layout.svelte b/src/routes/spaces/+layout.svelte\nindex 545bf88..fd03570 100644\n--- a/src/routes/spaces/+layout.svelte\n+++ b/src/routes/spaces/+layout.svelte\n@@ -1,5 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n-  import type {Snippet} from 'svelte'\n+  import type {Snippet} from \"svelte\"\n   import {page} from \"$app/stores\"\n \n   type Props = {\ndiff --git a/src/routes/spaces/[relay]/[room]/+page.svelte b/src/routes/spaces/[relay]/[room]/+page.svelte\nindex a315a4c..4bb149c 100644\n--- a/src/routes/spaces/[relay]/[room]/+page.svelte\n+++ b/src/routes/spaces/[relay]/[room]/+page.svelte\n@@ -22,7 +22,6 @@\n   import {\n     userSettingValues,\n     decodeRelay,\n-    GENERAL,\n     tagRoom,\n     userRoomsByUrl,\n     displayChannel,\n@@ -43,7 +42,7 @@\n   import {pushToast} from \"@app/toast\"\n   import {GIT_REPO} from \"@src/lib/util\"\n \n-  const {room = GENERAL} = $page.params\n+  const {room} = $page.params\n   const mounted = now()\n   const lastChecked = $checked[$page.url.pathname]\n   const url = decodeRelay($page.params.relay)\n@@ -256,22 +255,20 @@\n   {/snippet}\n   {#snippet action()}\n     \u003cdiv class=\"row-2\"\u003e\n-      {#if room !== GENERAL}\n-        {#if $userRoomsByUrl.get(url)?.has(room)}\n-          \u003cButton class=\"btn btn-neutral btn-sm\" onclick={leaveRoom}\u003e\n-            \u003cIcon icon=\"arrows-a-logout-2\" /\u003e\n-            Leave Room\n-          \u003c/Button\u003e\n-        {:else}\n-          \u003cButton class=\"btn btn-neutral btn-sm\" disabled={joiningRoom} onclick={joinRoom}\u003e\n-            {#if joiningRoom}\n-              \u003cspan class=\"loading loading-spinner loading-sm\"\u003e\u003c/span\u003e\n-            {:else}\n-              \u003cIcon icon=\"login-2\" /\u003e\n-            {/if}\n-            Join Room\n-          \u003c/Button\u003e\n-        {/if}\n+      {#if $userRoomsByUrl.get(url)?.has(room)}\n+        \u003cButton class=\"btn btn-neutral btn-sm\" onclick={leaveRoom}\u003e\n+          \u003cIcon icon=\"arrows-a-logout-2\" /\u003e\n+          Leave Room\n+        \u003c/Button\u003e\n+      {:else}\n+        \u003cButton class=\"btn btn-neutral btn-sm\" disabled={joiningRoom} onclick={joinRoom}\u003e\n+          {#if joiningRoom}\n+            \u003cspan class=\"loading loading-spinner loading-sm\"\u003e\u003c/span\u003e\n+          {:else}\n+            \u003cIcon icon=\"login-2\" /\u003e\n+          {/if}\n+          Join Room\n+        \u003c/Button\u003e\n       {/if}\n       \u003cMenuSpaceButton {url} /\u003e\n     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/calendar/+page.svelte b/src/routes/spaces/[relay]/calendar/+page.svelte\nindex 60ddb1f..e5a4a35 100644\n--- a/src/routes/spaces/[relay]/calendar/+page.svelte\n+++ b/src/routes/spaces/[relay]/calendar/+page.svelte\n@@ -17,7 +17,7 @@\n   import CalendarEventItem from \"@app/components/CalendarEventItem.svelte\"\n   import CalendarEventCreate from \"@app/components/CalendarEventCreate.svelte\"\n   import {pushModal} from \"@app/modal\"\n-  import {GENERAL, getEventsForUrl, decodeRelay} from \"@app/state\"\n+  import {getEventsForUrl, decodeRelay} from \"@app/state\"\n   import {makeCalendarFeed} from \"@app/requests\"\n   import {setChecked} from \"@app/notifications\"\n \n@@ -92,10 +92,8 @@\n   })\n \n   onMount(() =\u003e {\n-    const feedFilters = [{kinds: [EVENT_TIME], \"#h\": [GENERAL]}]\n-    const subscriptionFilters = [\n-      {kinds: [DELETE, REACTION, EVENT_TIME], \"#h\": [GENERAL], since: now()},\n-    ]\n+    const feedFilters = [{kinds: [EVENT_TIME]}]\n+    const subscriptionFilters = [{kinds: [DELETE, REACTION, EVENT_TIME], since: now()}]\n \n     ;({events, cleanup} = makeCalendarFeed({\n       element: element!,\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-9kgtkfzx","title":"From b46068a4de71bc7982963a8d0d2c4585f8bce297 Mon Sep 17 00:00:00 2001","description":"From b46068a4de71bc7982963a8d0d2c4585f8bce297 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 23 Nov 2025 17:38:44 +0500\nSubject: [PATCH 5/13] chore: update nostr-git submodule and add pubkey validation to GitItem\n\nProblem:\n- GitItem component could display invalid maintainer pubkeys\n- No validation of pubkeys before using them for display\n- Could cause rendering issues with malformed pubkey data\n- Forking was adding git username as maintainer which was causing rendering issues\n\nSolution:\n- Add pubkey validation consistent with nostr-git submodule changes\n- Filter invalid maintainers before selecting display pubkey\n- Ensure only valid 64-character hex pubkeys are used\n---\n packages/nostr-git                |  2 +-\n src/app/components/GitItem.svelte | 21 +++++++++++++++++----\n 2 files changed, 18 insertions(+), 5 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex c7b65f8..7ed3590 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit c7b65f843a5987bafb97a31e7b0d72c9f92f076a\n+Subproject commit 7ed35909df81c287fe7507775b3695e926bf2713\ndiff --git a/src/app/components/GitItem.svelte b/src/app/components/GitItem.svelte\nindex 5e824ed..8d99a97 100644\n--- a/src/app/components/GitItem.svelte\n+++ b/src/app/components/GitItem.svelte\n@@ -20,13 +20,26 @@\n \n   const name = event.tags.find(nthEq(0, \"name\"))?.[1]\n   const description = event.tags.find(nthEq(0, \"description\"))?.[1]\n-  \n+\n+  // Validate that a string is a valid hex pubkey (exactly 64 hex characters)\n+  const isValidPubkey = (pubkey: string | undefined | null): boolean =\u003e {\n+    if (!pubkey || typeof pubkey !== 'string') return false;\n+    return /^[0-9a-f]{64}$/i.test(pubkey);\n+  }\n+\n   // Get maintainers from the event, or fall back to the event author\n   const maintainersTag = event.tags.find(nthEq(0, \"maintainers\"))\n-  const maintainers = maintainersTag ? maintainersTag.slice(1) : [event.pubkey]\n+  const maintainers = maintainersTag \n+    ? maintainersTag.slice(1).filter((pk: string) =\u003e isValidPubkey(pk))\n+    : []\n+  \n+  // Use first valid maintainer, or fall back to event author if valid\n+  const displayPubkey = maintainers.length \u003e 0 \u0026\u0026 isValidPubkey(maintainers[0])\n+    ? maintainers[0]\n+    : event.pubkey\n   \n-  // Create a modified event with the first maintainer as the pubkey for display\n-  const displayEvent = {...event, pubkey: maintainers[0]}\n+  // Create a modified event with the validated pubkey for display\n+  const displayEvent = displayPubkey ? {...event, pubkey: displayPubkey} : event\n \u003c/script\u003e\n \n \u003cNoteCard event={displayEvent} class=\"card2 sm:card2-sm bg-alt\"\u003e\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-9ttpiknn","title":"From f8442ce82df1c0d1ba7a0b95718bacfd7363488b Mon Sep 17 00:00:00 2001","description":"From f8442ce82df1c0d1ba7a0b95718bacfd7363488b Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 8 May 2025 08:20:27 -0700\nSubject: [PATCH] refactor: simplify git repo loading and state management in spaces route\n\n---\n package.json                               |   1 +\n src/routes/spaces/[relay]/git/+page.svelte | 125 ++++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------------------------------\n 2 files changed, 41 insertions(+), 85 deletions(-)\n\ndiff --git a/package.json b/package.json\nindex acc9897..ac6c4c3 100644\n--- a/package.json\n+++ b/package.json\n@@ -19,6 +19,7 @@\n     \"@sveltejs/kit\": \"^2.5.27\",\n     \"@sveltejs/vite-plugin-svelte\": \"^4.0.0\",\n     \"@types/eslint\": \"^9.6.0\",\n+    \"@types/throttle-debounce\": \"^5.0.2\",\n     \"autoprefixer\": \"^10.4.19\",\n     \"classnames\": \"^2.5.1\",\n     \"eslint\": \"^9.0.0\",\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 85b40d9..9394673 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -1,123 +1,78 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {decodeRelay, shouldReloadRepos} from \"@src/app/state\"\n-  import {tracker} from \"@welshman/app\"\n-  import {load} from \"@welshman/net\"\n-  import {pubkey, userMutes} from \"@welshman/app\"\n-  import {\n-    getPubkeyTagValues,\n-    getListTags,\n-    NAMED_BOOKMARKS,\n-    getAddressTags,\n-    type TrustedEvent,\n-    type Filter,\n-    Address,\n-  } from \"@welshman/util\"\n-  import {onMount, tick} from \"svelte\"\n-  import {page} from \"$app/state\"\n-  import {type Writable, writable} from \"svelte/store\"\n-  import {setChecked} from \"@src/app/notifications\"\n-  import PageBar from \"@src/lib/components/PageBar.svelte\"\n-  import Icon from \"@src/lib/components/Icon.svelte\"\n-  import MenuSpaceButton from \"@src/app/components/MenuSpaceButton.svelte\"\n-  import Button from \"@src/lib/components/Button.svelte\"\n-  import Spinner from \"@src/lib/components/Spinner.svelte\"\n-  import {sortBy} from \"@welshman/lib\"\n-  import {fly} from \"@src/lib/transition\"\n-  import {pushModal} from \"@src/app/modal\"\n-  import RepoPicker from \"@src/app/components/RepoPicker.svelte\"\n+  import {onMount} from \"svelte\"\n+  import {page} from \"$app/stores\"\n+  import {getPubkeyTagValues, getListTags, Address, NAMED_BOOKMARKS, type TrustedEvent} from \"@welshman/util\"\n   import {GIT_REPO} from \"@src/lib/util\"\n-  import GitItem from \"@src/app/components/GitItem.svelte\"\n+  import {userMutes} from \"@welshman/app\"\n+  import {fly} from \"@lib/transition\"\n+  import Icon from \"@lib/components/Icon.svelte\"\n+  import Button from \"@lib/components/Button.svelte\"\n+  import PageBar from \"@lib/components/PageBar.svelte\"\n+  import Spinner from \"@lib/components/Spinner.svelte\"\n+  import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n+  import GitItem from \"@app/components/GitItem.svelte\"\n+  import RepoPicker from \"@app/components/RepoPicker.svelte\"\n+  import {decodeRelay} from \"@app/state\"\n+  import {setChecked} from \"@app/notifications\"\n+  import {pushModal} from \"@app/modal\"\n+  import {load} from \"@welshman/net\"\n+  import {pubkey} from \"@welshman/app\"\n+  import {getAddressTags} from \"@welshman/util\"\n   import {Router} from \"@welshman/router\"\n \n-  const url = decodeRelay(page.params.relay)\n-\n-  const bookmarkFilter = {kinds: [NAMED_BOOKMARKS], authors: [pubkey.get()!]}\n-\n+  const url = decodeRelay($page.params.relay)\n   const mutedPubkeys = getPubkeyTagValues(getListTags($userMutes))\n-\n-  let repoFilter: Filter\n-\n+  const repos: TrustedEvent[] = $state([])\n   let loading = $state(true)\n+  let loadedBookmarkedRepos: Array\u003c{address: string, event: TrustedEvent, relayHint: string}\u003e = []\n \n-  const events: Writable\u003cTrustedEvent[]\u003e = writable([])\n-\n-  let loadedBookmarkedRepos: Array\u003c{address: string; event: TrustedEvent; relayHint: string}\u003e = []\n-\n-  const loadBookmarkedRepos = async () =\u003e {\n-    loadedBookmarkedRepos = []\n+  async function loadBookmarkedRepos() {\n+    repos.length = 0\n     loading = true\n-    await tick()\n+    const bookmarkFilter = {kinds: [NAMED_BOOKMARKS], authors: [pubkey.get()!]}\n     const bookmark = await load({\n       relays: [url, ...Router.get().FromUser().getUrls()],\n       filters: [bookmarkFilter],\n     })\n-\n     if (bookmark.length \u003e 0) {\n       const aTagList = getAddressTags(bookmark[0].tags)\n       const dTagValues: string[] = []\n       const authors: string[] = []\n       const relayHints: string[] = []\n       const relaysOfAddresses: Map\u003cstring, string\u003e = new Map()\n-\n       aTagList.forEach(([letter, value, relayHint]) =\u003e {\n         dTagValues.push(value.split(\":\")[2])\n         authors.push(value.split(\":\")[1])\n         relaysOfAddresses.set(value, relayHint || \"\")\n-        if (relayHint) {\n-          relayHints.push(relayHint)\n-        }\n+        if (relayHint) relayHints.push(relayHint)\n       })\n-\n-      repoFilter = {kinds: [GIT_REPO], authors: authors, \"#d\": dTagValues}\n-\n+      const repoFilter = {kinds: [GIT_REPO], authors, \"#d\": dTagValues}\n       const loadedRepos = await load({\n         relays: relayHints,\n         filters: [repoFilter],\n       })\n-      loadedRepos.forEach(repo =\u003e {\n+      loadedBookmarkedRepos = loadedRepos.map(repo =\u003e {\n         const address = Address.fromEvent(repo)\n         const addressString = address.toString()\n-        const relayHintFromEvent = tracker.getRelays(repo.id)\n-        const relaysFromAddressPubkey = Router.get().getRelaysForPubkey(repo.pubkey)?.[0]\n-\n-        const hint =\n-          relaysOfAddresses.get(addressString) ??\n-          Array.from(relayHintFromEvent)[0] ??\n-          relaysFromAddressPubkey\n-\n-        loadedBookmarkedRepos.push({\n-          address: addressString,\n-          event: repo,\n-          relayHint: hint,\n-        })\n-      })\n-      events.update(() =\u003e {\n-        return sortBy(\n-          e =\u003e -e.created_at,\n-          loadedRepos.filter(e =\u003e !mutedPubkeys.includes(e.pubkey)),\n-        )\n+        const relayHintFromEvent = Router.get().getRelaysForPubkey(repo.pubkey)?.[0]\n+        const hint = relaysOfAddresses.get(addressString) ?? relayHintFromEvent\n+        return {address: addressString, event: repo, relayHint: hint}\n       })\n+      loadedRepos.filter(e =\u003e !mutedPubkeys.includes(e.pubkey)).forEach(e =\u003e repos.push(e))\n     }\n     loading = false\n   }\n \n   onMount(() =\u003e {\n     loadBookmarkedRepos()\n-\n-    return () =\u003e {\n-      setChecked(page.url.pathname)\n-    }\n-  })\n-\n-  $effect(() =\u003e {\n-    if ($shouldReloadRepos) {\n-      loadBookmarkedRepos()\n-      $shouldReloadRepos = false\n-    }\n+    return () =\u003e setChecked($page.url.pathname)\n   })\n \n   const onAddRepo = () =\u003e {\n-    pushModal(RepoPicker, {selectedRepos: loadedBookmarkedRepos})\n+    pushModal(RepoPicker, {\n+      selectedRepos: loadedBookmarkedRepos,\n+      onClose: loadBookmarkedRepos,\n+    })\n   }\n \u003c/script\u003e\n \n@@ -135,25 +90,25 @@\n       \u003cdiv class=\"row-2\"\u003e\n         \u003cButton class=\"btn btn-primary btn-sm\" disabled={loading} onclick={onAddRepo}\u003e\n           \u003cIcon icon=\"git\" /\u003e\n-          \u003cspan class=\"\"\u003eAdd Repo\u003c/span\u003e\n+          \u003cspan\u003eAdd Repo\u003c/span\u003e\n         \u003c/Button\u003e\n         \u003cMenuSpaceButton {url} /\u003e\n       \u003c/div\u003e\n     {/snippet}\n   \u003c/PageBar\u003e\n   \u003cdiv class=\"flex flex-grow flex-col gap-2 overflow-auto p-2\"\u003e\n-    {#if loading || $events.length === 0}\n+    {#if loading || repos.length === 0}\n       \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n         \u003cSpinner {loading}\u003e\n           {#if loading}\n             Looking for Your Git Repos...\n-          {:else if $events.length === 0}\n+          {:else if repos.length === 0}\n             No Repos found.\n           {/if}\n         \u003c/Spinner\u003e\n       \u003c/p\u003e\n     {:else}\n-      {#each $events as event (event.id)}\n+      {#each repos as event (event.id)}\n         \u003cdiv in:fly class=\"\"\u003e\n           \u003cGitItem {url} {event} /\u003e\n         \u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-9x2wnwq4","title":"From 60a9e279760f6c9532766d847e36e621c73a1720 Mon Sep 17 00:00:00 2001","description":"From 60a9e279760f6c9532766d847e36e621c73a1720 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Sat, 14 Jun 2025 18:04:52 -0700\nSubject: [PATCH 3/3] feat: optimize git event loading with shared filters\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts | 29 ++++++++++++++++++-----------\n 1 file changed, 18 insertions(+), 11 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nindex 0d62418..89a06cb 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -51,7 +51,7 @@ export async function load({ params }) {\n         \"#d\": [decoded.identifier],\n     }]\n \n-    load({ relays: relayList as string[], filters })\n+    await load({ relays: relayList as string[], filters })\n \n     // Combine the separate event stores\n     const repoAnnouncementEvents = deriveEvents(repository, {\n@@ -84,25 +84,32 @@ export async function load({ params }) {\n         return undefined;\n     });\n \n+    const issueFilters = {\n+        kinds: [GIT_ISSUE],\n+        \"#a\": [`${GIT_REPO}:${decoded.pubkey}:${decoded.identifier}`],\n+    }\n+\n+    const patchFilters = {\n+        kinds: [GIT_PATCH],\n+        \"#a\": [`${GIT_REPO}:${decoded.pubkey}:${decoded.identifier}`],\n+    }\n+\n+    await load({ \n+        relays: relayList as string[], \n+        filters: [issueFilters, patchFilters] \n+    })\n+\n     // Create derived stores for issues and patches\n     const issues: Readable\u003cIssueEvent[]\u003e = derived(\n         deriveEvents(repository, {\n-            filters: [{\n-                authors: [decoded.pubkey],\n-                kinds: [GIT_ISSUE],\n-                \"#a\": [`${GIT_REPO}:${decoded.pubkey}:${decoded.identifier}`],\n-            }],\n+            filters: [issueFilters],\n         }),\n         (events) =\u003e (events || []) as IssueEvent[]\n     );\n \n     const patches: Readable\u003cPatchEvent[]\u003e = derived(\n         deriveEvents(repository, {\n-            filters: [{\n-                authors: [decoded.pubkey],\n-                kinds: [GIT_PATCH],\n-                \"#a\": [`${GIT_REPO}:${decoded.pubkey}:${decoded.identifier}`],\n-            }]\n+            filters: [patchFilters],\n         }),\n         (events) =\u003e (events || []) as PatchEvent[]\n     );\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-9x6xs8vc","title":"From 775fb4b51eb187dbc1a968fbbc32feea890a6d61 Mon Sep 17 00:00:00 2001","description":"From 775fb4b51eb187dbc1a968fbbc32feea890a6d61 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 12 Aug 2025 09:23:29 -0700\nSubject: [PATCH 1/6] feat: enhance dialog component with fullscreen mode, a11y and cleaner class handling\n\n---\n src/lib/components/Dialog.svelte                             | 28 +++++++++++++++++++++++-----\n src/routes/spaces/[relay]/git/+page.svelte                   | 30 ++++++++++++++++++------------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte      |  6 +++---\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte |  2 +-\n 4 files changed, 45 insertions(+), 21 deletions(-)\n\ndiff --git a/src/lib/components/Dialog.svelte b/src/lib/components/Dialog.svelte\nindex 483e18e..027ec13 100644\n--- a/src/lib/components/Dialog.svelte\n+++ b/src/lib/components/Dialog.svelte\n@@ -1,6 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n   import {noop} from \"@welshman/lib\"\n   import {fade, fly} from \"@lib/transition\"\n+  import {onMount} from \"svelte\"\n \n   interface Props {\n     onClose?: any\n@@ -10,20 +11,37 @@\n \n   const {onClose = noop, fullscreen = false, children}: Props = $props()\n \n-  const extraClass = $derived(\n-    !fullscreen \u0026\u0026\n-      \"card2 bg-alt max-h-[90vh] w-[90vw] overflow-auto text-base-content sm:w-[520px] shadow-xl\",\n+  // Build container classes without leaking boolean values like \"false\" into the class attribute\n+  const containerClass = $derived.by(() =\u003e\n+    [\n+      \"scroll-container\",\n+      \"relative\",\n+      fullscreen\n+        ? \"\"\n+        : \"card2 bg-alt max-h-[90vh] w-[90vw] overflow-auto text-base-content sm:w-[520px] shadow-xl\",\n+    ]\n+      .filter(Boolean)\n+      .join(\" \"),\n   )\n+\n+  // Close on Escape key for better a11y\n+  onMount(() =\u003e {\n+    const onKey = (e: KeyboardEvent) =\u003e {\n+      if (e.key === \"Escape\") onClose()\n+    }\n+    window.addEventListener(\"keydown\", onKey)\n+    return () =\u003e window.removeEventListener(\"keydown\", onKey)\n+  })\n \u003c/script\u003e\n \n-\u003cdiv class=\"center fixed inset-0 z-modal\"\u003e\n+\u003cdiv class=\"center fixed inset-0 z-modal\" role=\"dialog\" aria-modal=\"true\"\u003e\n   \u003cbutton\n     aria-label=\"Close dialog\"\n     class=\"absolute inset-0 cursor-pointer bg-black opacity-75\"\n     transition:fade={{duration: 300}}\n     onclick={onClose}\u003e\n   \u003c/button\u003e\n-  \u003cdiv class=\"scroll-container relative {extraClass}\" transition:fly={{duration: 300}}\u003e\n+  \u003cdiv class={containerClass} transition:fly={{duration: 300}}\u003e\n     {@render children?.()}\n   \u003c/div\u003e\n \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 8a526ed..44b481b 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -101,20 +101,26 @@\n   }\n \n   const onNewRepo = () =\u003e {\n-    pushModal(NewRepoWizard, {\n-      onCancel: () =\u003e {\n-        back()\n-      },\n-      onRepoCreated: () =\u003e {\n-        back()\n+    pushModal(\n+      NewRepoWizard,\n+      {\n+        onCancel: () =\u003e {\n+          back()\n+        },\n+        onRepoCreated: () =\u003e {\n+          back()\n+        },\n+        onPublishEvent: async (event: RepoAnnouncementEvent) =\u003e {\n+          publishThunk({\n+            relays: [url],\n+            event,\n+          })\n+        },\n       },\n-      onPublishEvent: async (event: RepoAnnouncementEvent) =\u003e {\n-        publishThunk({\n-          relays: [url],\n-          event,\n-        })\n+      {\n+        fullscreen: true,\n       },\n-    })\n+    )\n   }\n \u003c/script\u003e\n \ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex f7ec02e..550d95f 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -13,7 +13,7 @@\n   import {pushToast} from \"@src/app/toast\"\n   import EventActions from \"@src/app/components/EventActions.svelte\"\n   import ReactionSummary from \"@src/app/components/ReactionSummary.svelte\"\n-  import {pushModal} from \"@src/app/modal.js\"\n+  import {pushModal} from \"@app/modal\"\n   import {EditRepoPanel, ForkRepoDialog} from \"@nostr-git/ui\"\n   import {postRepoAnnouncement} from \"@src/app/commands.js\"\n   import type {RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n@@ -80,9 +80,9 @@\n     \n     pushModal(ForkRepoDialog, {\n       repo: repoClass,\n-      onPublishEvent: async (event: any) =\u003e {\n+      onPublishEvent: (event: any) =\u003e {\n         // Handle event publishing\n-        await postRepoAnnouncement(event, [])\n+        postRepoAnnouncement(event, [])\n       }\n     })\n   }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex ec8b922..3411d4c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -25,7 +25,7 @@\n   import {makeFeed} from \"@src/app/requests\"\n   import {whenElementReady} from \"@src/lib/html\"\n   import {slide, slideAndFade} from \"@lib/transition\"\n-  import {pushModal} from \"@src/app/modal\"\n+  import {pushModal} from \"@app/modal\"\n   import {\n     createStatusEvent,\n     type CommentEvent,\n--\nlibgit2 1.9.0\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-9yx3ix57","title":"From beda279f8b549e64abaf25962c31bfaafc4d4b96 Mon Sep 17 00:00:00 2001","description":"From beda279f8b549e64abaf25962c31bfaafc4d4b96 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 15 Apr 2025 16:51:59 +1000\nSubject: [PATCH 1/3] added Permalink extension to editor\n\n---\n package.json            | 3 ++-\n src/app/editor/index.ts | 7 +++++++\n 2 files changed, 9 insertions(+), 1 deletion(-)\n\ndiff --git a/package.json b/package.json\nindex 39f341f..53dd566 100644\n--- a/package.json\n+++ b/package.json\n@@ -48,6 +48,7 @@\n     \"@sentry/browser\": \"^8.35.0\",\n     \"@sveltejs/adapter-static\": \"^3.0.4\",\n     \"@types/qrcode\": \"^1.5.5\",\n+    \"@types/throttle-debounce\": \"^5.0.2\",\n     \"@vite-pwa/assets-generator\": \"^0.2.6\",\n     \"@vite-pwa/sveltekit\": \"^0.6.6\",\n     \"@welshman/app\": \"~0.0.42\",\n@@ -60,7 +61,6 @@\n     \"@welshman/signer\": \"~0.0.20\",\n     \"@welshman/store\": \"~0.0.16\",\n     \"@welshman/util\": \"~0.0.61\",\n-    \"@types/throttle-debounce\": \"^5.0.2\",\n     \"daisyui\": \"^4.12.10\",\n     \"date-picker-svelte\": \"^2.13.0\",\n     \"dotenv\": \"^16.4.5\",\n@@ -68,6 +68,7 @@\n     \"fuse.js\": \"^7.0.0\",\n     \"husky\": \"^9.1.6\",\n     \"idb\": \"^8.0.0\",\n+    \"nostr-git\": \"github:chebizarro/nostr-git\",\n     \"nostr-signer-capacitor-plugin\": \"coracle-social/nostr-signer-capacitor-plugin#9fbe4f8\",\n     \"nostr-tools\": \"^2.7.2\",\n     \"prettier-plugin-tailwindcss\": \"^0.6.5\",\ndiff --git a/src/app/editor/index.ts b/src/app/editor/index.ts\nindex 9ba3c74..6ff8944 100644\n--- a/src/app/editor/index.ts\n+++ b/src/app/editor/index.ts\n@@ -11,6 +11,8 @@ import {MentionSuggestion, WelshmanExtension} from \"@welshman/editor\"\n import {getSetting, userSettingValues} from \"@app/state\"\n import {MentionNodeView} from \"./MentionNodeView\"\n import ProfileSuggestion from \"./ProfileSuggestion.svelte\"\n+import {PermalinkExtension} from \"nostr-git\"\n+import Spinner from \"@src/lib/components/Spinner.svelte\"\n \n export const getUploadType = () =\u003e getSetting\u003c\"nip96\" | \"blossom\"\u003e(\"upload_type\")\n \n@@ -52,6 +54,11 @@ export const makeEditor = ({\n     autofocus,\n     element: document.createElement(\"div\"),\n     extensions: [\n+      PermalinkExtension.configure({\n+\t\tsigner: async (e) =\u003e await signer.get().sign(e),\n+\t\trelays: ctx.app.router.FromUser().getUrls(),\n+\t\tspinnerComponent: Spinner,\n+\t  }),\n       WelshmanExtension.configure({\n         submit,\n         sign: signWithAssert,\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-acndnh2o","title":"From 46a7c7257fa7068072e567b6a4ba2555026b8861 Mon Sep 17 00:00:00 2001","description":"From 46a7c7257fa7068072e567b6a4ba2555026b8861 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 28 Jul 2025 22:12:36 -0700\nSubject: [PATCH 1/8] refactor: remove debug console logs across repository management code\n\n---\n packages/nostr-git                                                      |  2 +-\n src/lib/utils/tokenLoader.ts                                            | 12 ++++++------\n src/routes/+layout.svelte                                               |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts                     | 11 +++--------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte                   |  4 ++--\n src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte           | 44 +++-----------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 59 ++---------------------------------------------------------\n 7 files changed, 18 insertions(+), 116 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 71eaa7a..18c78d2 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 71eaa7a61931dbaa2f58d685947ccec7f4e6e288\n+Subproject commit 18c78d2675110698468e20fb074c0c406d96affd\ndiff --git a/src/lib/utils/tokenLoader.ts b/src/lib/utils/tokenLoader.ts\nindex 98e8b71..312d270 100644\n--- a/src/lib/utils/tokenLoader.ts\n+++ b/src/lib/utils/tokenLoader.ts\n@@ -19,7 +19,7 @@ async function waitForSignerReady(maxWaitMs: number = 10000): Promise\u003c{ signer: \n       const currentPubkey = get(pubkey);\n       \n       if (currentSigner \u0026\u0026 currentPubkey) {\n-        console.log('🔐 Signer and pubkey are ready for token decryption');\n+\n         resolve({ signer: currentSigner, pubkey: currentPubkey });\n         return;\n       }\n@@ -52,11 +52,11 @@ export async function loadTokensFromStorage(tokenKey: string): Promise\u003cTokenEntr\n \n     const encryptedTokens = localStorage.getItem(tokenKey);\n     if (!encryptedTokens) {\n-      console.log('🔐 No encrypted tokens found in localStorage');\n+\n       return [];\n     }\n \n-    console.log('🔐 Found encrypted tokens, waiting for signer to be ready...');\n+\n     \n     // Wait for signer and pubkey to be available\n     const signerInfo = await waitForSignerReady();\n@@ -65,7 +65,7 @@ export async function loadTokensFromStorage(tokenKey: string): Promise\u003cTokenEntr\n       return [];\n     }\n \n-    console.log('🔐 Signer ready, attempting to decrypt tokens...');\n+\n     \n     // Decrypt the tokens\n     const decrypted = await signerInfo.signer.nip04.decrypt(signerInfo.pubkey, encryptedTokens);\n@@ -75,7 +75,7 @@ export async function loadTokensFromStorage(tokenKey: string): Promise\u003cTokenEntr\n     }\n \n     const tokens = JSON.parse(decrypted) as TokenEntry[];\n-    console.log(`🔐 Successfully loaded ${tokens.length} tokens from localStorage`);\n+\n     return tokens;\n \n   } catch (error) {\n@@ -106,7 +106,7 @@ export async function saveTokensToStorage(tokenKey: string, tokens: TokenEntry[]\n     const encrypted = await currentSigner.nip04.encrypt(currentPubkey, JSON.stringify(tokens));\n     localStorage.setItem(tokenKey, encrypted);\n     \n-    console.log(`🔐 Successfully saved ${tokens.length} tokens to localStorage`);\n+\n \n   } catch (error) {\n     console.error('Failed to save tokens to localStorage:', error);\ndiff --git a/src/routes/+layout.svelte b/src/routes/+layout.svelte\nindex c24733c..e6a543e 100644\n--- a/src/routes/+layout.svelte\n+++ b/src/routes/+layout.svelte\n@@ -238,7 +238,7 @@\n           const loadedTokens = await loadTokensFromStorage(tokenKey)\n           tokens.clear()\n           loadedTokens.forEach(token =\u003e tokens.push(token))\n-          console.log(`🔐 Git tokens initialized at app level: ${loadedTokens.length} tokens loaded`)\n+\n         } catch (error) {\n           console.warn('🔐 Failed to initialize git tokens at app level:', error)\n         }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nindex a6e0604..24a4d40 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -55,17 +55,12 @@ export const load: LayoutLoad = async ({ params }) =\u003e {\n             \"#d\": [decoded.identifier],\n         }]\n     }), (events) =\u003e {\n-        console.log('🔍 Repository State events found:', events?.length || 0, events)\n+\n         const stateEvent = events?.[0]\n         if (stateEvent) {\n-            console.log('✅ Repository State event loaded:', stateEvent.kind, stateEvent.id)\n-            console.log('🔍 Repository State event tags:', stateEvent.tags)\n+            // Repository State event loaded successfully\n         } else {\n-            console.log('❌ No Repository State event found for:', {\n-                author: decoded.pubkey,\n-                identifier: decoded.identifier,\n-                kind: GIT_REPO_STATE\n-            })\n+            // No Repository State event found\n         }\n         return stateEvent\n     }) as Readable\u003cRepoStateEvent\u003e;\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex b91db61..2ee4c84 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -111,7 +111,7 @@\n       readme = readmeContent.content\n       renderedReadme = readme ? md.render(readme) : \"\"\n     } catch (e) {\n-      console.log(\"No README.md found\")\n+\n     } finally {\n       readmeLoading = false\n     }\n@@ -129,7 +129,7 @@\n         }\n       }\n     } catch (e) {\n-      console.log(\"Could not fetch commit info:\", e)\n+\n     } finally {\n       commitLoading = false\n     }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\nindex 0f5e78c..53595bc 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n@@ -47,35 +47,8 @@\n \n   // Set initial page size and load commits when the component mounts or when the repo changes\n   $effect(() =\u003e {\n-    console.log(\"🔍 $effect triggered:\", {\n-      repoClass: !!repoClass,\n-      repoEvent: !!repoClass?.repoEvent,\n-      mainBranch: repoClass?.mainBranch,\n-      branches: repoClass?.branches?.length || 0,\n-      selectedPageSize\n-    });\n-    \n-    if (repoClass \u0026\u0026 repoClass.repoEvent \u0026\u0026 repoClass.mainBranch) {\n-      // Set the initial page size\n-      repoClass.setCommitsPerPage(selectedPageSize)\n+    if (repoClass \u0026\u0026 repoClass.repoId \u0026\u0026 repoClass.mainBranch) {\n       loadCommits()\n-    } else if (repoClass) {\n-      console.log(\"⚠️ Repository not fully initialized yet, waiting...\");\n-      // Try again after a short delay to allow initialization to complete\n-      setTimeout(() =\u003e {\n-        if (repoClass.repoEvent \u0026\u0026 repoClass.mainBranch) {\n-          console.log(\"✅ Repository now initialized, loading commits...\");\n-          repoClass.setCommitsPerPage(selectedPageSize)\n-          loadCommits()\n-        } else {\n-          console.error(\"❌ Repository failed to initialize:\", {\n-            repoEvent: !!repoClass.repoEvent,\n-            mainBranch: repoClass.mainBranch\n-          });\n-          commitsError = \"Repository not properly initialized\";\n-          commitsLoading = false;\n-        }\n-      }, 1000);\n     }\n   })\n \n@@ -91,23 +64,12 @@\n \n   // Load commits with pagination\n   async function loadCommits() {\n-    console.log('🔍 loadCommits called with:', {\n-      currentPage,\n-      repoClass: !!repoClass,\n-      repoEvent: !!repoClass?.repoEvent,\n-      mainBranch: repoClass?.mainBranch,\n-      repoId: repoClass?.repoId,\n-      initialLoadComplete\n-    });\n-    \n     if (!initialLoadComplete) {\n       commitsLoading = true\n     }\n \n     try {\n-      console.log('🔍 About to call repoClass.loadPage with:', currentPage);\n       const result = await repoClass.loadPage(currentPage);\n-      console.log('🔍 loadPage result:', result);\n       \n       // Check if the result indicates an error\n       if (result \u0026\u0026 !result.success) {\n@@ -190,11 +152,11 @@\n   })\n \n   const handleReact = (commitId: string, type: \"heart\") =\u003e {\n-    console.log(`Reacting to commit ${commitId} with ${type}`)\n+\n   }\n \n   const handleComment = (commitId: string, comment: string) =\u003e {\n-    console.log(`Commenting on commit ${commitId}: ${comment}`)\n+\n     // TODO: Implement Nostr comments for commits\n   }\n \u003c/script\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 95234e4..0535fb6 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -116,13 +116,13 @@\n \n     // Check if repository is properly initialized before attempting merge analysis\n     if (!repoClass.repoId || !repoClass.mainBranch) {\n-      console.log('Repository not fully initialized yet, skipping merge analysis')\n+\n       return\n     }\n \n     // Check if WorkerManager is ready\n     if (!repoClass.workerManager) {\n-      console.log('WorkerManager not ready yet, skipping merge analysis')\n+\n       return\n     }\n \n@@ -140,34 +140,16 @@\n     isAnalyzingMerge = true\n     mergeAnalysisResult = null\n     try {\n-      console.log('🔍 DEBUG: Starting merge analysis with:', {\n-        patchId: patchEvent?.id,\n-        targetBranch,\n-        repoId: repoClass.repoId,\n-        mainBranch: repoClass.mainBranch,\n-        hasWorkerManager: !!repoClass.workerManager\n-      });\n-      \n       let result = await repoClass.getMergeAnalysis(patchEvent, targetBranch)\n       \n-      console.log('🔍 DEBUG: Merge analysis result:', {\n-        hasResult: !!result,\n-        analysis: result?.analysis,\n-        errorMessage: result?.errorMessage,\n-        canMerge: result?.canMerge,\n-        fullResult: result\n-      });\n-      \n       if (result) {\n         mergeAnalysisResult = result\n       } else {\n         // If still no result, try to get from cache first\n         const cachedResult = await repoClass.getMergeAnalysis(patchEvent, targetBranch)\n         if (cachedResult) {\n-          console.log('🔍 DEBUG: Using cached result:', cachedResult);\n           mergeAnalysisResult = cachedResult\n         } else {\n-          console.log('🔍 DEBUG: No merge analysis result available yet - will retry')\n           // Don't show error immediately, just return and let it retry\n           return\n         }\n@@ -320,19 +302,6 @@\n       rawContent: selectedPatch.raw?.content || ''\n     };\n     \n-    // Debug patch data before sending to worker\n-    console.log('🔍 Patch Data Debug:', {\n-      patchId: patchData.id,\n-      hasRawContent: !!patchData.rawContent,\n-      rawContentType: typeof patchData.rawContent,\n-      rawContentLength: patchData.rawContent?.length,\n-      rawContentPreview: patchData.rawContent?.substring(0, 100),\n-      baseBranch: patchData.baseBranch,\n-      commitsCount: patchData.commits.length,\n-      selectedPatchRaw: selectedPatch.raw,\n-      selectedPatchRawContent: selectedPatch.raw?.content\n-    });\n-    \n     // Validate patch data before proceeding\n     if (!patchData.rawContent || typeof patchData.rawContent !== 'string') {\n       mergeError = `Invalid patch data: rawContent is ${typeof patchData.rawContent} (${patchData.rawContent})`;\n@@ -399,30 +368,6 @@\n     const effectiveRepoId = repoClass.repoEvent?.id || repoClass.repoId || '';\n     \n     try {\n-        console.log('🚀 Starting patch merge operation...');\n-        \n-        // Debug authentication configuration\n-        const authConfig = repoClass.workerManager.getAuthConfig();\n-        console.log('🔍 Auth Debug - Available tokens:', authConfig.tokens.length);\n-        console.log('🔍 Auth Debug - Token hosts:', authConfig.tokens.map(t =\u003e t.host));\n-        console.log('🔍 Auth Debug - Repo clone URLs:', repoClass.repo?.clone || []);\n-        \n-        // Check if any tokens match the repo URLs\n-        const repoUrls = repoClass.repo?.clone || [];\n-        for (const url of repoUrls) {\n-          try {\n-            const hostname = new URL(url).hostname;\n-            const matchingToken = authConfig.tokens.find(token =\u003e \n-              hostname === token.host || hostname.endsWith('.' + token.host)\n-            );\n-            console.log(`🔍 Auth Debug - URL: ${url}, Hostname: ${hostname}, Has Token: ${!!matchingToken}`);\n-            if (matchingToken) {\n-              console.log(`🔍 Auth Debug - Token for ${hostname}: ${matchingToken.token.substring(0, 8)}...`);\n-            }\n-          } catch (e) {\n-            console.log(`🔍 Auth Debug - Invalid URL: ${url}`);\n-          }\n-        }\n         \n         const result = await repoClass.workerManager.applyPatchAndPush({\n           repoId: effectiveRepoId,\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-aep90u2u","title":"From 6f7f113b19f6897bd74c27ed6846da05571f83b5 Mon Sep 17 00:00:00 2001","description":"From 6f7f113b19f6897bd74c27ed6846da05571f83b5 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 9 Jun 2025 16:21:22 -0700\nSubject: [PATCH 3/3] implemented git file view and download\n\n---\n .env                                                                    |  2 +-\n package.json                                                            |  3 +--\n packages/nostr-git                                                      |  2 +-\n pnpm-lock.yaml                                                          | Bin 486154 -\u003e 486091 bytes\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |  9 ---------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte                   |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte              | 16 ++++++++++++----\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte |  1 -\n src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte         | 12 +++++-------\n 9 files changed, 21 insertions(+), 26 deletions(-)\n\ndiff --git a/.env b/.env\nindex 059979e..cfc0cb8 100644\n--- a/.env\n+++ b/.env\n@@ -5,7 +5,7 @@ VITE_PLATFORM_TERMS=\n VITE_PLATFORM_PRIVACY=\n VITE_PLATFORM_NAME=Budabit\n VITE_PLATFORM_LOGO=static/budabit.png\n-VITE_PLATFORM_RELAY=wss://budabit.nostr1.com/\n+VITE_PLATFORM_RELAY=ws://192.168.10.149:7000\n VITE_PLATFORM_ACCENT=\"#D4AF37\"\n VITE_PLATFORM_SECONDARY=\"#EB5E28\"\n VITE_PLATFORM_DESCRIPTION=\"The Club for Builders in Freedom Tech.\"\ndiff --git a/package.json b/package.json\nindex 1a2160a..589f8fe 100644\n--- a/package.json\n+++ b/package.json\n@@ -85,8 +85,7 @@\n     \"qrcode\": \"^1.5.4\",\n     \"sharp\": \"^0.34.1\",\n     \"throttle-debounce\": \"^5.0.2\",\n-    \"tippy.js\": \"^6.3.7\",\n-    \"buffer\": \"^6.0.3\"\n+    \"tippy.js\": \"^6.3.7\"\n   },\n   \"pnpm\": {\n     \"ignoredBuiltDependencies\": [\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 89be359..414f02c 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 89be359b3968d98d5a2d426e5c42601602469cf6\n+Subproject commit 414f02c61f2199bea76c7838a156c31d4990e963\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 89e4b99eb14cb5eec9dd5771fe4641bed7455905..6d44bbbcbe8f757c9b51b726cf2d8d3da78a4e61 100644\nGIT binary patch\ndelta 299\nzc%19HCVTp-?1mcxo5clL%$N=Ij3zfqim(D{J;Uh%TI@c}\u0026F\u003c~Z?u\u003capw7uD#dGS+5\nzqv;!6m^8xzw8Kgb3nS91Qd2TBi*h~uosBEJ-5n!Sqe=pj!z|Oy%_6ib(v93)OiCit\nzgUk(6%Y7Y\u003cO(TtqovVziGBW-2Q_54*f(pDM3@V+H)5|jr(\u003c1x=9j6QEvPewdr^_;(\nz(O~*VK_\u003c;mql(-N$25~r\u0026t\u00266(%q;)VWUl~6L!ST\u003e$E1pkf@F_U4__l^BeM!$gKP`K\nzB7@vSM}M=@{Lo;J9An3T+%k`-\u003cVe%xDCbE1q{vdQlr*\u003cQlT`Qo#L0~(WZOULu\u003edja\nh_K$jO^1oS)^vv`Ori*H^n\u003c0E(1`*wUT8rJ@0RRA!VI}|o\n\ndelta 297\nzc$_\u003cZRkrJz?1mcxlTB3ZH{TFoF=I5GY{)3aYN%(RXE0q*i`}Q$#l79doe_wcw!649\nzFMc|Gku0-TXpVW6wtr-ld2Xq(OGsgnkA+20rgxFIXQ98bUvhz~zeSk7e~N)gl3zht\nzwn28Lr(0f%yK8=7T4_~TmPuu4Mo_kgcUDlgr\u003e9Ysws)|RM_NE~aK-csIxOPTYjs\u0026\u003e\nzPIu\u0026G(h4;S4^ApGDa~\u003cptt@r\u0026\u0026d\u003eEP%_}W2Gj*{DjViAw^2iTLi_EKVPY(3U^C-*-\nzb}lf|b~2BwG78tOEb?\u003cHstC$Y@sB8RchNV@cTV\u003cp_jAe%E%Ys%o+!^K-@ZkU1\u0026CR\u003c\ngZ_#6u{mp6\u0026^sdqLYntq42%nchM7Q^7vD-TU0Fwn^r2qf`\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 224fa4b..56d37ff 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -172,15 +172,6 @@\n             \u003cGitPullRequest class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab\n-          tabValue=\"workbench\"\n-          label=\"Workbench\"\n-          href={`/spaces/${encodeddRelay}/git/${id}/workbench`}\n-          {activeTab}\u003e\n-          {#snippet icon()}\n-            \u003cLayers class=\"h-4 w-4\" /\u003e\n-          {/snippet}\n-        \u003c/RepoTab\u003e\n       {/snippet}\n     \u003c/RepoHeader\u003e\n     {@render children()}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 977bd01..6ec39f4 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -14,7 +14,7 @@\n   import {repository} from \"@welshman/app\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {getRootEventTagValue} from \"@src/lib/util\"\n-  import {Card} from \"@nostr-git/ui\"\n+  import {Card, Repo} from \"@nostr-git/ui\"\n   import {CircleAlert, GitBranch, GitPullRequest, Users} from \"@lucide/svelte\"\n   import {\n     parseRepoAnnouncementEvent,\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex 8a30724..89d147d 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -2,9 +2,8 @@\n   import {getContext} from \"svelte\"\n   import {FileView} from \"@nostr-git/ui\"\n   import {GitBranch} from \"@lucide/svelte\"\n-  import {listRepoFilesFromEvent, type FileEntry, listBranchesFromEvent} from \"@nostr-git/core\"\n+  import {listRepoFilesFromEvent, type FileEntry, listBranchesFromEvent, getRepoFileContentFromEvent} from \"@nostr-git/core\"\n   import {\n-    parseRepoAnnouncementEvent,\n     parseRepoStateEvent,\n     type RepoAnnouncementEvent,\n     type RepoStateEvent,\n@@ -27,7 +26,7 @@\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n     patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n   }\u003e(\"repo\")\n-\n+  \n   // UI state\n   let loading = $state(true)\n   let error: string | null = $state(null)\n@@ -79,6 +78,15 @@\n   const openMenu = () =\u003e {\n     showMenu = true\n   }\n+\n+const getFileContent = async (path: string) =\u003e {\n+  return await getRepoFileContentFromEvent({\n+    repoEvent: $repoEvent,\n+    branch: selectedBranchValue?.split(\"/\").pop() || \"master\",\n+    path,\n+  })\n+}\n+\n \u003c/script\u003e\n \n \u003cdiv class=\"rounded-lg border border-border bg-card\"\u003e\n@@ -143,7 +151,7 @@\n               \u003cdiv class=\"text-muted-foreground\"\u003eNo files found in this branch.\u003c/div\u003e\n             {:else}\n               {#each files as file}\n-                \u003cFileView name={file.name} type={file.type} path={file.path} /\u003e\n+                \u003cFileView {file} getFileContent={getFileContent}/\u003e\n               {/each}\n             {/if}\n           {/await}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex eb7014c..b8f52ee 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -12,7 +12,6 @@\n   import {deriveEvents} from \"@welshman/store\"\n   import {load} from \"@welshman/net\"\n   import {COMMENT, GIT_PATCH, type Filter} from \"@welshman/util\"\n-  import {nthEq} from \"@welshman/lib\"\n \n   const repo = getContext\u003c{\n     repo: Readable\u003cTrustedEvent\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\nindex 4b12723..b62575a 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n@@ -17,10 +17,7 @@\n   import {Card, CardContent, CardHeader, CardTitle} from \"@nostr-git/ui\"\n   import {Tabs, TabsContent, TabsList, TabsTrigger} from \"@nostr-git/ui\"\n   import {Badge} from \"@nostr-git/ui\"\n-  import PatchSelector from \"@nostr-git/ui\"\n-  import CommitSelector from \"@nostr-git/ui\"\n-  import MergeAnalyzer from \"@nostr-git/ui\"\n-  import ConflictVisualizer from \"@nostr-git/ui\"\n+  import {PatchSelector, CommitSelector, MergeAnalyzer, ConflictVisualizer} from \"@nostr-git/ui\"\n   import {getContext} from \"svelte\"\n   import type {Readable} from \"svelte/store\"\n   import type {RepoStateEvent} from \"@nostr-git/shared-types\"\n@@ -36,6 +33,7 @@\n     repo: Readable\u003cTrustedEvent\u003e\n     state: () =\u003e Readable\u003cRepoStateEvent\u003e\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n   }\u003e(\"repo\")\n \n   // Simulate merge analysis when both patch and commit are selected\n@@ -87,7 +85,7 @@\n   }\n \u003c/script\u003e\n \n-\u003cdiv class=\"container max-w-7xl py-6\"\u003e\n+\u003cdiv\u003e\n   \u003cdiv class=\"mt-6\"\u003e\n     \u003cdiv class=\"mb-6\"\u003e\n       \u003cdiv class=\"mb-2 flex items-center gap-3\"\u003e\n@@ -104,8 +102,8 @@\n     \u003c/div\u003e\n \n     \u003cdiv class=\"mb-6 grid grid-cols-2 gap-6\"\u003e\n-      \u003cPatchSelector selectedPatch={$selectedPatch} onPatchSelect={setSelectedPatch} /\u003e\n-      \u003cCommitSelector selectedCommit={$selectedCommit} onCommitSelect={setSelectedCommit} /\u003e\n+      \u003cPatchSelector patches={repo.patches()} selectedPatch={$selectedPatch} onPatchSelect={(patch) =\u003e selectedPatch = patch} /\u003e\n+      \u003cCommitSelector commits={[]} selectedCommit={$selectedCommit} onCommitSelect={(commit) =\u003e selectedCommit = commit} /\u003e\n     \u003c/div\u003e\n \n     {#if selectedPatch \u0026\u0026 selectedCommit}\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-ampmodz2","title":"Implement permalinks","description":"According to [this NIP](https://github.com/nostr-protocol/nips/pull/1875) .\nUser should be able to copy a permalink to any file line or diff line range, similar to the github workflow but the nostr uri will be copied.\nThis can in turn be pasted into the chat compose to mention these lines anywhere in the app. The message compose should be able to render this new kind of event in a nice way(?) .","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T18:05:14.809061-08:00","closed_at":"2026-01-24T18:05:14.809061-08:00","close_reason":"Verified implemented via codebase triage","labels":["enhancement","issue"]}
{"id":"flotilla-ar0ftnm5","title":"Rooms: Cannot scroll if rooms vertically overflow","description":"They just disappear at the bottom","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["bug","issue","rooms","social"]}
{"id":"flotilla-arch-widget-runtime-model","title":"Define Smart Widget execution environment","description":"Specify how Smart Widgets are executed, including sandbox model (iframe/worker), isolation boundaries, allowed APIs, and host–widget message passing.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-24T18:05:14.811068-08:00","closed_at":"2026-01-24T18:05:14.811068-08:00","close_reason":"Verified implemented via codebase triage"}
{"id":"flotilla-ata2pcjj","title":"From f699dfc235f22d16d78065e452ed2fcc2b2a4d45 Mon Sep 17 00:00:00 2001","description":"From f699dfc235f22d16d78065e452ed2fcc2b2a4d45 Mon Sep 17 00:00:00 2001\nFrom: Five \u003cco22rkn@protonmail.com\u003e\nDate: Mon, 23 Jun 2025 12:18:56 +0200\nSubject: [PATCH 6/9] Improvements around repoClass, Issues, Patches and Comments - Removed usage of function-registry - repoClass loaded with Symbol key from context - repo relays saved in context similarly to repoClass - Profile and ProfileLink components registered to nostr-git/ui to use them where avatar images, profile info or a name link is needed - postIssues and postComments provided as wrapped funcions for publishing events from nostr-git to be able to use welshman without type errors - Issues, Patches and comments on these work now mostly - Some reactivity issues and event ordering bugs remain\n\n---\n src/app/commands.ts                                                     | 16 ++++++++++++++++\n src/app/components/Profile.svelte                                       | 25 ++++++++++++++-----------\n src/app/state.ts                                                        |  4 ++++\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 | 13 +++++++++----\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts                     | 21 ++++-----------------\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte            | 32 ++++++++++++++++++++------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           | 23 ++++++++++++++++++-----\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 22 ++++++++++++----------\n 8 files changed, 97 insertions(+), 59 deletions(-)\n\ndiff --git a/src/app/commands.ts b/src/app/commands.ts\nindex 33d20b9..b846781 100644\n--- a/src/app/commands.ts\n+++ b/src/app/commands.ts\n@@ -65,6 +65,7 @@ import {\n   NOTIFIER_RELAY,\n   userRoomsByUrl,\n } from \"@app/state\"\n+import type { CommentEvent, IssueEvent } from \"@nostr-git/shared-types\"\n \n // Utils\n \n@@ -452,3 +453,18 @@ export const makeAlert = async ({cron, email, feed, bunker, secret, description}\n \n export const publishAlert = async (params: AlertParams) =\u003e\n   publishThunk({event: await makeAlert(params), relays: [NOTIFIER_RELAY]})\n+\n+export const postComment = (comment: CommentEvent, relays :string[]) =\u003e {\n+  return publishThunk({\n+    relays: relays ?? [],\n+    event: comment,\n+  });\n+}\n+\n+export const postIssue = (issue: IssueEvent, relays: string[]) =\u003e {\n+  return publishThunk({\n+    relays: relays ?? [],\n+    event: issue,\n+  });\n+}\n+\ndiff --git a/src/app/components/Profile.svelte b/src/app/components/Profile.svelte\nindex b19afa0..e0dd409 100644\n--- a/src/app/components/Profile.svelte\n+++ b/src/app/components/Profile.svelte\n@@ -19,9 +19,10 @@\n   type Props = {\n     pubkey: string\n     url?: string\n+    hideDetails?: boolean\n   }\n \n-  const {pubkey, url}: Props = $props()\n+  const {pubkey, url, hideDetails=false}: Props = $props()\n \n   const relays = removeNil([url])\n   const profile = deriveProfile(pubkey, relays)\n@@ -40,15 +41,17 @@\n   \u003cButton onclick={openProfile} class=\"py-1\"\u003e\n     \u003cAvatar src={$profile?.picture} size={10} /\u003e\n   \u003c/Button\u003e\n-  \u003cdiv class=\"flex min-w-0 flex-col\"\u003e\n-    \u003cdiv class=\"flex items-center gap-2\"\u003e\n-      \u003cButton onclick={openProfile} class=\"text-bold overflow-hidden text-ellipsis\"\u003e\n-        {$profileDisplay}\n-      \u003c/Button\u003e\n-      \u003cWotScore score={$score} active={following} /\u003e\n+  {#if !hideDetails}\n+    \u003cdiv class=\"flex min-w-0 flex-col\"\u003e\n+      \u003cdiv class=\"flex items-center gap-2\"\u003e\n+        \u003cButton onclick={openProfile} class=\"text-bold overflow-hidden text-ellipsis\"\u003e\n+          {$profileDisplay}\n+        \u003c/Button\u003e\n+        \u003cWotScore score={$score} active={following} /\u003e\n+      \u003c/div\u003e\n+      \u003cdiv class=\"overflow-hidden text-ellipsis text-sm opacity-75\"\u003e\n+        {$handle ? displayHandle($handle) : displayPubkey(pubkey)}\n+      \u003c/div\u003e\n     \u003c/div\u003e\n-    \u003cdiv class=\"overflow-hidden text-ellipsis text-sm opacity-75\"\u003e\n-      {$handle ? displayHandle($handle) : displayPubkey(pubkey)}\n-    \u003c/div\u003e\n-  \u003c/div\u003e\n+  {/if}\n \u003c/div\u003e\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 168bfea..2a4b32d 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -114,6 +114,10 @@ export const IMGPROXY_URL = \"https://imgproxy.coracle.social\"\n \n export const REACTION_KINDS = [REACTION, ZAP_RESPONSE]\n \n+export const REPO_KEY = Symbol(\"repo\");\n+\n+export const REPO_RELAYS_KEY = Symbol(\"repo-relays\");\n+\n export const NIP46_PERMS =\n   \"nip44_encrypt,nip44_decrypt,\" +\n   [CLIENT_AUTH, AUTH_JOIN, MESSAGE, THREAD, COMMENT, GROUPS, WRAP, REACTION]\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 62f976a..a161d4b 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -5,15 +5,19 @@\n   import {page} from \"$app/stores\"\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n   import Avatar from \"@lib/components/Avatar.svelte\"\n+  import Profile from \"@src/app/components/Profile.svelte\"\n+  import ProfileLink from \"@src/app/components/ProfileLink.svelte\"\n   import Divider from \"@lib/components/Divider.svelte\"\n   import Input from \"@lib/components/Field.svelte\"\n   import Dialog from \"@lib/components/Dialog.svelte\"\n   import {setContext} from \"svelte\"\n   import {pushToast} from \"@src/app/toast\"\n+  import { REPO_KEY, REPO_RELAYS_KEY } from \"@src/app/state.js\"\n \n   const {id, relay} = $page.params\n   let {data, children} = $props()\n-  const {repoClass, functionRegistry} = data\n+  // functionRegistry unused at the moment\n+  const {repoClass, relays, functionRegistry} = data\n \n   let activeTab: string | undefined = $page.url.pathname.split(\"/\").pop()\n   const encodedRelay = encodeURIComponent(relay)\n@@ -31,9 +35,8 @@\n     }\n   })\n \n-  setContext(\"functions\", functionRegistry)\n-  setContext(\"repoClass\", repoClass)\n-\n+  setContext(REPO_KEY, repoClass)\n+  setContext(REPO_RELAYS_KEY, relays)\n \u003c/script\u003e\n \n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n@@ -107,6 +110,8 @@\n           Separator: Divider as typeof import(\"@nostr-git/ui\").Separator,\n           Input: Input as typeof import(\"@nostr-git/ui\").Input,\n           Alert: Dialog as typeof import(\"@nostr-git/ui\").Alert,\n+          ProfileComponent: Profile as typeof import(\"@nostr-git/ui\").Profile,\n+          ProfileLink: ProfileLink as typeof import(\"@nostr-git/ui\").ProfileLink,\n         }}\u003e\n         {@render children()}\n       \u003c/ConfigProvider\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nindex fe5a0b5..8d6ab85 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -1,7 +1,6 @@\n export const ssr = false;\n-import { derived, get, type Readable } from 'svelte/store';\n+import { derived, type Readable } from 'svelte/store';\n import {\n-    type CommentEvent,\n     type IssueEvent,\n     type PatchEvent,\n     type RepoAnnouncementEvent,\n@@ -13,6 +12,7 @@ import { nip19 } from 'nostr-tools';\n import type { AddressPointer } from 'nostr-tools/nip19';\n import { nthEq } from '@welshman/lib';\n import { GIT_REPO, GIT_REPO_STATE } from '@src/lib/util.js';\n+import type { FunctionRegistry } from '@nostr-git/ui';\n \n export async function load({ params }) {\n     const { id, relay } = params;\n@@ -20,7 +20,7 @@ export async function load({ params }) {\n     // Dynamic imports to avoid SSR issues\n     const { decodeRelay, INDEXER_RELAYS } = await import('@app/state');\n     const { deriveEvents } = await import('@welshman/store');\n-    const { publishThunk, repository } = await import('@welshman/app');\n+    const { repository } = await import('@welshman/app');\n     const { load } = await import(\"@welshman/net\");\n     const { Repo } = await import('@nostr-git/ui');\n \n@@ -108,20 +108,7 @@ export async function load({ params }) {\n         (events) =\u003e (events || []) as StatusEvent[]\n     );\n \n-    const functionRegistry = {\n-        postComment: (comment: CommentEvent) =\u003e {\n-            return publishThunk({\n-                relays: get(relays) ?? [],\n-                event: comment,\n-            });\n-        },\n-\n-        postIssue: (issue: IssueEvent) =\u003e {\n-            return publishThunk({\n-                relays: get(relays) ?? [],\n-                event: issue,\n-            });\n-        },\n+    const functionRegistry:Partial\u003cFunctionRegistry\u003e = {\n     };\n \n     const repoClass = new Repo({\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex 88359dc..f0699e5 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -4,7 +4,7 @@\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Address, COMMENT, GIT_ISSUE} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n-  import {deriveProfile, repository, Thunk} from \"@welshman/app\"\n+  import { pubkey, repository } from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {makeFeed} from \"@src/app/requests\"\n   import {fly} from \"@lib/transition\"\n@@ -12,13 +12,10 @@\n   import {deriveEvents} from \"@welshman/store\"\n   import type {IssueEvent} from \"@nostr-git/shared-types\"\n   import {load} from \"@welshman/net\"\n+  import { REPO_KEY, REPO_RELAYS_KEY } from \"@src/app/state\"\n+  import { postComment, postIssue } from \"@src/app/commands\"\n \n-  interface FunctionRegistry {\n-    postComment: (comment: CommentEvent) =\u003e Thunk;\n-    postIssue: (issue: IssueEvent) =\u003e Thunk;\n-  }\n-\n-  const repoClass = getContext\u003cRepo\u003e(\"repoClass\")\n+  const repoClass = getContext\u003cRepo\u003e(REPO_KEY)\n \n   const commentFilter = {\n     kinds: [COMMENT],\n@@ -60,11 +57,9 @@\n     }\n   })\n \n-  const functions = getContext\u003cFunctionRegistry\u003e(\"functions\")\n-\n+  const repoRelays = getContext\u003cstring[]\u003e(REPO_RELAYS_KEY)\n   const onIssueCreated = async (issue: IssueEvent) =\u003e {\n-    await functions.postIssue(issue).result\n-    history.back()\n+    await postIssue(issue, repoClass.relays || repoRelays).result\n   }\n \n   const onNewIssue = () =\u003e {\n@@ -75,6 +70,14 @@\n     })\n   }\n \n+  const onCommentCreated = async (comment: CommentEvent) =\u003e {\n+    await postComment(comment, repoClass.relays || repoRelays).result\n+  }\n+\n+  $inspect(commentEvents).with((type, comments) =\u003e {\n+    console.log('comments for all issues on the repo in budabit:')\n+  })\n+\n \u003c/script\u003e\n \n \u003cdiv bind:this={element}\u003e\n@@ -117,7 +120,12 @@\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each repoClass.issues as issue (issue.id)}\n         \u003cdiv in:fly\u003e\n-          \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)} comments={commentEvents}/\u003e\n+          \u003cIssueCard\n+            event={issue}\n+            comments={commentEvents}\n+            currentCommenter={$pubkey!}\n+            onCommentCreated={onCommentCreated}\n+          /\u003e\n         \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 3ea5803..1aa6de3 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -47,7 +47,6 @@\n           ...patch.raw,\n           patches: repoClass.patches.filter(issue =\u003e issue.id === patch.id),\n           status,\n-          profile,\n         }\n       })\n     }\n@@ -62,10 +61,21 @@\n     \"#t\": [\"root\"],\n   }\n \n+  const commentFilter = {\n+    kinds: [COMMENT],\n+    \"#E\": [...repoClass.patches.map(i =\u003e i.id)],\n+  }\n+\n+  const allComments = $derived.by(() =\u003e {\n+    if(repoClass.patches) {\n+      return deriveEvents(repository, {filters:[commentFilter]})\n+    }\n+  })\n+\n   $effect(() =\u003e {\n     if (repoClass.patches) {\n-      load({relays: repoClass.relays, filters: [patchFilter, statusFilter]})\n-\n+      load({relays: repoClass.relays, filters: [patchFilter, statusFilter, commentFilter]})\n+ \n       makeFeed({\n         element: element!,\n         relays: repoClass.relays,\n@@ -82,7 +92,7 @@\n \u003c/script\u003e\n \n \u003cdiv bind:this={element}\u003e\n-  \u003cdiv class=\"z-10 sticky top-0 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n+  \u003cdiv class=\"z-10 sticky z-nav -top-8 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003ePatches\u003c/h2\u003e\n       \u003cp class=\"text-sm text-muted-foreground\"\u003eReview and merge code changes\u003c/p\u003e\n@@ -119,8 +129,11 @@\n   {:else}\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each patchList! as patch}\n+        {@const count = $allComments\n+          ?.filter((c)=\u003egetTagValue(\"E\", c.tags) === patch.id).length ?? 0\n+        }\n         \u003cdiv in:fly\u003e\n-          \u003cPatchCard event={patch} status={patch.status} author={patch.profile} /\u003e\n+          \u003cPatchCard event={patch} status={patch.status} commentCount={count} /\u003e\n         \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 24a3a23..1aa1123 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -30,11 +30,10 @@\n \n   const statusEvents = deriveEvents(repository, {filters: [statusFilter]})\n \n-  const patchProfile = $derived.by(() =\u003e {\n-    if (patch) {\n-      return deriveProfile(patch.author.pubkey)\n-    }\n-  })\n+  const repoRelays = getContext\u003cstring[]\u003e(REPO_RELAYS_KEY)\n+  const onCommentCreated = async (comment: CommentEvent) =\u003e {\n+    await postComment(comment, repoClass.relays || repoRelays).result\n+  }\n \n   const status = $derived.by(() =\u003e {\n     if ($statusEvents) {\n@@ -100,10 +99,7 @@\n             \u003c/div\u003e\n           \u003c/div\u003e\n \n-          \u003cAvatar class=\"h-10 w-10\"\u003e\n-            \u003cAvatarImage src={$patchProfile?.picture} alt={$patchProfile?.name} /\u003e\n-            \u003cAvatarFallback\u003e{$patchProfile?.name?.substring(0, 2).toUpperCase()}\u003c/AvatarFallback\u003e\n-          \u003c/Avatar\u003e\n+          \u003cProfile pubkey={patch.author.pubkey} hideDetails={true}\u003e\u003c/Profile\u003e\n         \u003c/div\u003e\n \n         \u003cdiv class=\"git-separator\"\u003e\u003c/div\u003e\n@@ -135,7 +131,13 @@\n             Discussion ({$threadComments?.length})\n           \u003c/h2\u003e\n \n-          \u003cIssueThread issueId={patch?.id} comments={$threadComments as CommentEvent[]} /\u003e\n+          \u003cIssueThread\n+            issueId = {patch?.id}\n+            issueKind={GIT_PATCH.toString() as '1617'}\n+            comments = {$threadComments}\n+            currentCommenter = {$pubkey!}\n+            onCommentCreated={onCommentCreated}\n+          /\u003e\n         \u003c/div\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-b16qw14x","title":"From 31bde729e3db220577302d467271bc9f1bacc952 Mon Sep 17 00:00:00 2001","description":"From 31bde729e3db220577302d467271bc9f1bacc952 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 2 Jun 2025 08:58:26 -0700\nSubject: [PATCH 2/4] feat: add patch view page and improve file loading in git repository browser\n\n---\n packages/nostr-git                                                      |   2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |  18 +++++++++---------\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte              |  84 ++++++++++++++++++++++++++++++++++++++++--------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 134 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n 4 files changed, 184 insertions(+), 54 deletions(-)\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 565f147..1e83572 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 565f147cd1ff1efda2516b1b9c9e421870106f7d\n+Subproject commit 1e835722f528da5f31239627ec39c70fa2dfb773\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 02c4ef9..1acffff 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -13,12 +13,17 @@\n   import {Address, GIT_ISSUE, GIT_PATCH, type Filter} from \"@welshman/util\"\n   import {load} from \"@welshman/net\"\n   import {nthEq} from \"@welshman/lib\"\n-    import PageBar from \"@src/lib/components/PageBar.svelte\"\n+  import PageBar from \"@src/lib/components/PageBar.svelte\"\n+  import {Buffer} from \"buffer\"\n \n   const {id, relay} = $page.params\n \n   let {children} = $props()\n \n+  if (typeof window !== \"undefined\" \u0026\u0026 !window.Buffer) {\n+    (window as any).Buffer = Buffer;\n+  }\n+\n   let eventStore = $state(deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay]))\n \n   const repoState = $derived.by(() =\u003e {\n@@ -65,7 +70,7 @@\n   let activeTab: string | undefined = $page.url.pathname.split(\"/\").pop()\n   const encodeddRelay = encodeURIComponent(relay)\n \n-  $effect(async () =\u003e {\n+  $effect(() =\u003e {\n     if ($eventStore) {\n       const repoEvent = parseRepoAnnouncementEvent($eventStore as RepoAnnouncementEvent)\n       const address = repoEvent.repoId\n@@ -74,18 +79,14 @@\n       const patchesFilter: Filter = {kinds: [GIT_PATCH], \"#a\": [address]}\n       const [tagId, ...relays] = $eventStore.tags.find(nthEq(0, \"relays\")) ?? []\n \n-      await load({\n+      load({\n         relays: relays,\n         filters: [issuesFilter, patchesFilter, repoStateFilter],\n       })\n-\n-      if ($repoState \u0026\u0026 $issues \u0026\u0026 $patches) {\n-        console.log(\"issues\", $issues)\n-        console.log(\"patches\", $patches)\n-      }\n     }\n   })\n \u003c/script\u003e\n+\n \u003cPageBar\u003e\n   \u003cRepoHeader event={$eventStore as RepoAnnouncementEvent} {activeTab}\u003e\n     {#snippet children(activeTab: string)}\n@@ -138,7 +139,6 @@\n   \u003c/RepoHeader\u003e\n \u003c/PageBar\u003e\n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n-\n   {#if $eventStore === undefined}\n     \u003cdiv class=\"p-4 text-center\"\u003eLoading repository...\u003c/div\u003e\n   {:else if !$eventStore}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex a03e86c..e50102a 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -2,18 +2,13 @@\n   import {getContext} from \"svelte\"\n   import {FileView} from \"@nostr-git/ui\"\n   import {GitBranch} from \"@lucide/svelte\"\n-  import {\n-    listRepoFilesFromEvent,\n-    type FileEntry,\n-    listBranchesFromEvent,\n-  } from \"@nostr-git/core\"\n+  import {listRepoFilesFromEvent, type FileEntry, listBranchesFromEvent} from \"@nostr-git/core\"\n   import {\n     parseRepoAnnouncementEvent,\n     parseRepoStateEvent,\n     type RepoAnnouncementEvent,\n     type RepoStateEvent,\n     type TrustedEvent,\n-    type RepoEvent,\n   } from \"@nostr-git/shared-types\"\n   import {page} from \"$app/stores\"\n   import type {Readable} from \"svelte/store\"\n@@ -21,6 +16,7 @@\n   import Button from \"@src/lib/components/Button.svelte\"\n   import {fly} from \"svelte/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n+    import Spinner from \"@src/lib/components/Spinner.svelte\"\n \n   const {id, relay} = $page.params\n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n@@ -35,7 +31,7 @@\n   // UI state\n   let loading = $state(true)\n   let error: string | null = $state(null)\n-  let files: FileEntry[] = $state([])\n+  let files: Promise\u003cFileEntry[]\u003e = $state(Promise.resolve([]))\n   let fallbackToBranches = $state(false)\n \n   const repoState = repo.state()\n@@ -59,28 +55,18 @@\n     }\n   })\n \n-let selectedBranchValue = $state\u003cstring | undefined\u003e(undefined)\n+  let selectedBranchValue = $state\u003cstring | undefined\u003e(undefined)\n \n   $effect(async () =\u003e {\n     if (selectedBranch) {\n       selectedBranchValue = await selectedBranch\n-      files = await listRepoFilesFromEvent({\n-        repoEvent: $repoEvent as RepoEvent,\n-        branch: selectedBranchValue,\n+      files = listRepoFilesFromEvent({\n+        repoEvent: $repoEvent as RepoAnnouncementEvent,\n+        branch: selectedBranchValue?.split(\"/\").pop() || \"master\",\n       })\n-    }\n-  })\n-\n-  $effect(async () =\u003e {\n-    if ($repoState) {\n       loading = false\n-      files = await listRepoFilesFromEvent({\n-        repoEvent: $repoEvent as RepoEvent,\n-        branch: await selectedBranch,\n-      })\n     } else {\n-      console.log($repoEvent)\n-      branches = await listBranchesFromEvent({repoEvent: $repoEvent})\n+      branches = listBranchesFromEvent({repoEvent: $repoEvent})\n       loading = false\n     }\n   })\n@@ -99,6 +85,7 @@ let selectedBranchValue = $state\u003cstring | undefined\u003e(undefined)\n \u003cdiv class=\"rounded-lg border border-border bg-card\"\u003e\n   \u003cdiv class=\"p-4\"\u003e\n     {#if loading}\n+\n       \u003cdiv class=\"text-muted-foreground\"\u003eLoading repository files...\u003c/div\u003e\n     {:else if error}\n       \u003cdiv class=\"text-red-500\"\u003e{error}\u003c/div\u003e\n@@ -112,11 +99,13 @@ let selectedBranchValue = $state\u003cstring | undefined\u003e(undefined)\n           class=\"rounded border border-border bg-secondary px-2 py-1\"\n           bind:value={selectedBranchValue}\n           disabled\u003e\n-          {#each branches as branch}\n-            \u003coption value={branch.name}\u003e\n-              {branch.name}\n-            \u003c/option\u003e\n-          {/each}\n+          {#await branches then branches}\n+            {#each branches as branch}\n+              \u003coption value={branch.name}\u003e\n+                {branch.name}\n+              \u003c/option\u003e\n+            {/each}\n+          {/await}\n         \u003c/select\u003e\n       \u003c/div\u003e\n       \u003cdiv class=\"border-t border-border pt-4\"\u003e\n@@ -133,28 +122,35 @@ let selectedBranchValue = $state\u003cstring | undefined\u003e(undefined)\n         \u003c/Button\u003e\n         {#if showMenu}\n           \u003cPopover hideOnClick onClose={toggleMenu}\u003e\n-            \u003cul transition:fly class=\"menu z-popover mt-2 rounded-box bg-base-100 p-2 shadow-xl\"\u003e\n-              {#each branches as branch}\n-                \u003cli\u003e\n-                  \u003cButton onclick={() =\u003e (selectedBranch = branch.name)}\u003e\n-                    \u003cspan\u003e{branch.name}\u003c/span\u003e\n-                  \u003c/Button\u003e\n-                \u003c/li\u003e\n-              {/each}\n+            \u003cul\n+              transition:fly\n+              class=\"menu z-popover mt-2 flex flex-col rounded-box bg-base-100 p-2 shadow-xl\"\u003e\n+              {#await branches then branches}\n+                {#each branches as branch}\n+                  \u003cli\u003e\n+                    \u003cButton onclick={() =\u003e (selectedBranchValue = branch.name)}\u003e\n+                      \u003cspan\u003e{branch.name}\u003c/span\u003e\n+                    \u003c/Button\u003e\n+                  \u003c/li\u003e\n+                {/each}\n+              {/await}\n             \u003c/ul\u003e\n           \u003c/Popover\u003e\n         {/if}\n       \u003c/div\u003e\n       \u003cdiv class=\"border-t border-border pt-4\"\u003e\n-        {#if files.length === 0}\n-          \u003cdiv class=\"text-muted-foreground\"\u003eNo files found in this branch.\u003c/div\u003e\n-        {:else}\n-          \u003cdiv class=\"space-y-2\"\u003e\n-            {#each files as file}\n-              \u003cFileView name={file.name} type={file.type} path={file.path} /\u003e\n-            {/each}\n-          \u003c/div\u003e\n-        {/if}\n+        \u003cdiv class=\"space-y-2\"\u003e\n+          \u003cSpinner loading={loading}\u003eLoading files...\u003c/Spinner\u003e\n+          {#await files then files}\n+          {#if files.length === 0}\n+              \u003cdiv class=\"text-muted-foreground\"\u003eNo files found in this branch.\u003c/div\u003e\n+            {:else}\n+              {#each files as file}\n+                \u003cFileView name={file.name} type={file.type} path={file.path} /\u003e\n+              {/each}\n+            {/if}\n+          {/await}\n+        \u003c/div\u003e\n       \u003c/div\u003e\n     {/if}\n   \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nnew file mode 100644\nindex 0000000..e3c3b09\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -0,0 +1,134 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {page} from \"$app/stores\"\n+  import {GitCommit, MessageSquare, Check, X} from \"@lucide/svelte\"\n+  import { parseGitPatchFromEvent } from \"@nostr-git/core\"\n+  import {type RepoStateEvent, type TrustedEvent} from \"@nostr-git/shared-types\"\n+  import {Button} from \"@nostr-git/ui\"\n+  import {Avatar, AvatarFallback, AvatarImage, DiffViewer, IssueThread} from \"@nostr-git/ui\"\n+  import {getContext} from \"svelte\"\n+  import type {Readable} from \"svelte/motion\"\n+\n+  const repo = getContext\u003c{\n+    repo: Readable\u003cTrustedEvent\u003e\n+    state: () =\u003e Readable\u003cRepoStateEvent\u003e\n+    issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+  }\u003e(\"repo\")\n+\n+  const patches = $derived(repo.patches())\n+\n+  const patch = $derived.by(() =\u003e {\n+    if ($patches) {\n+      const p = $patches.find(patch =\u003e patch.id === $page.params.patchid)\n+      if (p) {\n+        return parseGitPatchFromEvent(p)\n+      }\n+    }\n+  })\n+\n+  const threadComments = $derived.by(() =\u003e {\n+    if (patch) {\n+      console.log(patch)\n+      return []\n+    }\n+  })\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"container max-w-6xl py-6\"\u003e\n+  \u003cdiv class=\"mt-6\"\u003e\n+    \u003cdiv class=\"rounded-lg border border-border bg-card p-6\"\u003e\n+      \u003cdiv class=\"mb-4 flex items-start justify-between\"\u003e\n+        \u003cdiv class=\"flex items-start gap-4\"\u003e\n+          {#if patch?.status === \"open\"}\n+            \u003cdiv class=\"mt-1\"\u003e\n+              \u003cdiv class=\"flex h-10 w-10 items-center justify-center rounded-full bg-amber-500/10\"\u003e\n+                \u003cGitCommit class=\"h-5 w-5 text-amber-500\" /\u003e\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {:else if patch?.status === \"merged\"}\n+            \u003cdiv class=\"mt-1\"\u003e\n+              \u003cdiv class=\"flex h-10 w-10 items-center justify-center rounded-full bg-green-500/10\"\u003e\n+                \u003cCheck class=\"h-5 w-5 text-green-500\" /\u003e\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {:else}\n+            \u003cdiv class=\"mt-1\"\u003e\n+              \u003cdiv class=\"flex h-10 w-10 items-center justify-center rounded-full bg-red-500/10\"\u003e\n+                \u003cX class=\"h-5 w-5 text-red-500\" /\u003e\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          \u003cdiv\u003e\n+            \u003ch1 class=\"text-2xl font-bold\"\u003e{patch?.title}\u003c/h1\u003e\n+\n+            \u003cdiv class=\"mt-1 flex items-center gap-2\"\u003e\n+              \u003cdiv class=\"git-tag bg-secondary\"\u003e\n+                {patch?.status === \"open\" ? \"Open\" : patch?.status === \"merged\" ? \"Merged\" : \"Closed\"}\n+              \u003c/div\u003e\n+              \u003cspan class=\"text-sm text-muted-foreground\"\u003e\n+                {patch?.author.name} opened this patch • {new Date(patch?.createdAt).toLocaleString()}\n+              \u003c/span\u003e\n+            \u003c/div\u003e\n+\n+            \u003cp class=\"mt-4 text-muted-foreground\"\u003e{patch?.description}\u003c/p\u003e\n+          \u003c/div\u003e\n+        \u003c/div\u003e\n+\n+        \u003cAvatar class=\"h-10 w-10\"\u003e\n+          \u003cAvatarImage src={patch?.author.picture} alt={patch?.author.name} /\u003e\n+          \u003cAvatarFallback\u003e{patch?.author.name.substring(0, 2).toUpperCase()}\u003c/AvatarFallback\u003e\n+        \u003c/Avatar\u003e\n+      \u003c/div\u003e\n+\n+      \u003cdiv class=\"git-separator\"\u003e\u003c/div\u003e\n+\n+      \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n+        \u003ch2 class=\"text-lg font-medium\"\u003e{patch?.commitCount} Commits\u003c/h2\u003e\n+\n+        \u003cdiv class=\"flex items-center gap-2\"\u003e\n+          \u003cButton variant=\"outline\" size=\"sm\"\u003eView on GitHub\u003c/Button\u003e\n+\n+          {#if patch?.status === \"open\"}\n+            \u003cButton variant=\"default\" size=\"sm\" class=\"bg-git hover:bg-git-hover\"\u003e\n+              Merge Patch\n+            \u003c/Button\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+\n+      \u003cdiv class=\"mb-6 space-y-3\"\u003e\n+        {#each patch?.diff as commit (commit.id)}\n+          \u003cdiv class=\"flex items-start gap-3 rounded-md border border-border p-3\"\u003e\n+            \u003cGitCommit class=\"mt-1 h-5 w-5 text-muted-foreground\" /\u003e\n+            \u003cdiv\u003e\n+              \u003cp class=\"font-medium\"\u003e{commit.message}\u003c/p\u003e\n+              \u003cdiv class=\"mt-1 flex items-center gap-2 text-sm text-muted-foreground\"\u003e\n+                \u003cspan\u003e{commit.author}\u003c/span\u003e\n+                \u003cspan\u003e•\u003c/span\u003e\n+                \u003cspan\u003e{new Date(commit.date).toLocaleString()}\u003c/span\u003e\n+                \u003cspan\u003e•\u003c/span\u003e\n+                \u003ccode class=\"rounded bg-secondary/50 px-1.5 py-0.5 text-xs\"\n+                  \u003e{commit.id.substring(0, 7)}\u003c/code\u003e\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          \u003c/div\u003e\n+        {/each}\n+      \u003c/div\u003e\n+\n+      \u003ch2 class=\"mb-4 text-lg font-medium\"\u003eChanges\u003c/h2\u003e\n+      \u003cDiffViewer diff={patch?.raw.diff} /\u003e\n+\n+      \u003cdiv class=\"git-separator my-6\"\u003e\u003c/div\u003e\n+\n+      \u003cdiv class=\"space-y-4\"\u003e\n+        \u003ch2 class=\"flex items-center gap-2 text-lg font-medium\"\u003e\n+          \u003cMessageSquare class=\"h-5 w-5\" /\u003e\n+          Discussion ({threadComments?.length})\n+        \u003c/h2\u003e\n+\n+        \u003cIssueThread issueId={patch?.id} comments={threadComments} /\u003e\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  \u003c/div\u003e\n+\u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-b1wbm84t","title":"From e5526625941f6a80213d8e0677f8e9ec04ad3241 Mon Sep 17 00:00:00 2001","description":"From e5526625941f6a80213d8e0677f8e9ec04ad3241 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 23 Jun 2025 08:17:17 -0700\nSubject: [PATCH 3/9] refactor: migrate git patch status to separate events with improved UI handling\n\n---\n packages/nostr-git                                                      |  2 +-\n src/app/state.ts                                                        |  2 --\n src/lib/unknown-kinds.ts                                                |  8 ++++----\n src/routes/spaces/[relay]/[room]/+page.svelte                           |  1 +\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts                     | 29 ++++++++++++++++++++++-------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte                   |  4 ++--\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           | 30 +++++++++++++++++-------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 46 ++++++++++++++++++++++++++--------------------\n src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte         |  2 +-\n 9 files changed, 74 insertions(+), 50 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 7fc008d..97a87ad 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 7fc008d7736259976f22c8390c37c1f61f0a3410\n+Subproject commit 97a87adc93387f1f5378ab7fd6a0b6bac1f17d7d\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex f038616..168bfea 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -540,12 +540,10 @@ export const channelsById = withGetter(\n     [groupMeta, memberships, messages, getUrlsForEvent],\n     ([$groupMeta, $memberships, $messages, $getUrlsForEvent]) =\u003e {\n       const channelsById = new Map\u003cstring, Channel\u003e()\n-\n       // Add meta using group meta events\n       for (const event of $groupMeta) {\n         const meta = fromPairs(event.tags)\n         const room = meta.d\n-\n         if (room) {\n           for (const url of $getUrlsForEvent(event.id)) {\n             const id = makeChannelId(url, room)\ndiff --git a/src/lib/unknown-kinds.ts b/src/lib/unknown-kinds.ts\nindex 3f9eb87..c0f9210 100644\n--- a/src/lib/unknown-kinds.ts\n+++ b/src/lib/unknown-kinds.ts\n@@ -9,8 +9,8 @@ const DEFAULT_TEMPLATES: Record\u003cnumber, string\u003e = {\n   10002: \"canonical relays list for {{pubkey}}\",\n \n   1111: \"{{content}}\",\n-  30617: \"git repository {{tags.name}} hosted at {{tags.h}} by {{pubkey}}\",\n-  30618: \"git repository state {{tags.d}} hosted at {{tags.h[0]}} by {{pubkey}}\",\n+  30617: \"Git repository {{tags.name}} hosted at {{{tags.clone}}} by {{#npub}}{{pubkey}}{{/npub}}\",\n+  30618: \"## Git repository state {{tags.d}} hosted at {{tags.clone}} by {{#npub}}{{pubkey}}{{/npub}}\",\n   1617: \"```\\n{{{content}}}\\n```\",\n   1621: \"{{#tags.subject}}Subject{{tags.subject}}\\n{{/tags.subject}}{{content}} {{#npub}}{{tags.p}}{{/npub}}\",\n   1623: \"```\\n{{{content}}}\\n```\",\n@@ -53,9 +53,9 @@ export function unknownKindFallback(\n       tags: tagsToObj(params.tags),\n       nevent: () =\u003e (txt: string, render: (s: string) =\u003e string) =\u003e {\n         const hex = render(txt).trim().toLowerCase();\n-        return \"nostr:\" + nip19.neventEncode({id: hex, relays: []});\n+        return \"nostr:\" + nip19.neventEncode({ id: hex, relays: [] });\n       },\n-\t  npub: () =\u003e (txt: string, render: (s: string) =\u003e string) =\u003e {\n+      npub: () =\u003e (txt: string, render: (s: string) =\u003e string) =\u003e {\n         const hex = render(txt).trim().toLowerCase()\n         return \"nostr:\" + nip19.npubEncode(hex);\n       },\ndiff --git a/src/routes/spaces/[relay]/[room]/+page.svelte b/src/routes/spaces/[relay]/[room]/+page.svelte\nindex 9360a55..a315a4c 100644\n--- a/src/routes/spaces/[relay]/[room]/+page.svelte\n+++ b/src/routes/spaces/[relay]/[room]/+page.svelte\n@@ -27,6 +27,7 @@\n     userRoomsByUrl,\n     displayChannel,\n     getEventsForUrl,\n+    channelsById,\n   } from \"@app/state\"\n   import {setChecked, checked} from \"@app/notifications\"\n   import {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nindex b5a3c26..fe5a0b5 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -6,8 +6,9 @@ import {\n     type PatchEvent,\n     type RepoAnnouncementEvent,\n     type RepoStateEvent,\n+    type StatusEvent,\n } from '@nostr-git/shared-types';\n-import { GIT_ISSUE, GIT_PATCH } from '@welshman/util';\n+import { GIT_ISSUE, GIT_PATCH, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE, GIT_STATUS_DRAFT, GIT_STATUS_OPEN } from '@welshman/util';\n import { nip19 } from 'nostr-tools';\n import type { AddressPointer } from 'nostr-tools/nip19';\n import { nthEq } from '@welshman/lib';\n@@ -28,7 +29,7 @@ export async function load({ params }) {\n     const url = decodeRelay(relay);\n \n     const fallbackRelays = INDEXER_RELAYS\n-    const relayList = (decoded.relays?.length ?? 0) \u003e 0 ? decoded.relays : fallbackRelays\n+    const relayList: string[] = (decoded.relays?.length ?? 0) \u003e 0 ? decoded.relays ?? fallbackRelays : fallbackRelays\n \n     const filters = [{\n         authors: [decoded.pubkey],\n@@ -36,9 +37,8 @@ export async function load({ params }) {\n         \"#d\": [decoded.identifier],\n     }]\n \n-    await load({ relays: relayList as string[], filters })\n+    await load({ relays: relayList, filters })\n \n-    // Combine the separate event stores\n     const repoEvent = derived(deriveEvents(repository, {\n         filters: [{\n             authors: [decoded.pubkey],\n@@ -74,9 +74,9 @@ export async function load({ params }) {\n         \"#a\": [`${GIT_REPO}:${decoded.pubkey}:${decoded.identifier}`],\n     }\n \n-    await load({ \n-        relays: relayList as string[], \n-        filters: [issueFilters, patchFilters] \n+    await load({\n+        relays: relayList as string[],\n+        filters: [issueFilters, patchFilters]\n     })\n \n     // Create derived stores for issues and patches\n@@ -94,6 +94,20 @@ export async function load({ params }) {\n         (events) =\u003e (events || []) as PatchEvent[]\n     );\n \n+    const patchStatusFilter = derived(patches, (patches) =\u003e {\n+        return {\n+            kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+            \"#a\": patches.map((patch) =\u003e patch.id),\n+        }\n+    });\n+\n+    const patchStatusEvents: Readable\u003cStatusEvent[]\u003e = derived(\n+        deriveEvents(repository, {\n+            filters: [patchStatusFilter],\n+        }),\n+        (events) =\u003e (events || []) as StatusEvent[]\n+    );\n+\n     const functionRegistry = {\n         postComment: (comment: CommentEvent) =\u003e {\n             return publishThunk({\n@@ -115,6 +129,7 @@ export async function load({ params }) {\n         repoStateEvent,\n         issues,\n         patches,\n+        patchStatusEvents,\n     });\n \n     return {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex ef80698..31b58f4 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -324,10 +324,10 @@\n                       \u003cGitPullRequest class=\"mt-0.5 h-4 w-4 text-purple-500\" /\u003e\n                       \u003cdiv class=\"min-w-0 flex-1\"\u003e\n                         \u003cp class=\"truncate text-sm font-medium\"\u003e\n-                          {patch.tags.find(nthEq(0, \"title\"))?.[1] || \"Untitled Patch\"}\n+                          {patch.title || \"Untitled Patch\"}\n                         \u003c/p\u003e\n                         \u003cp class=\"text-xs text-muted-foreground\"\u003e\n-                          {formatDate(new Date(patch.created_at * 1000))}\n+                          {patch.createdAt}\n                         \u003c/p\u003e\n                       \u003c/div\u003e\n                     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 24ac7bd..3ea5803 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -16,32 +16,36 @@\n   } from \"@welshman/util\"\n   import {fly} from \"@lib/transition\"\n   import {load} from \"@welshman/net\"\n+  import {parseStatusEvent, type Patch, type StatusEvent} from \"@nostr-git/shared-types\"\n \n   const {data} = $props()\n   const {repoClass} = data\n \n   const statusFilter = {\n     kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n-    \"#e\": [...repoClass.patches.map((patch: TrustedEvent) =\u003e patch.id)],\n+    \"#e\": [...repoClass.patches.map((patch: Patch) =\u003e patch.id)],\n   }\n-\n-  const statuses = deriveEvents(repository, {filters: [statusFilter]})\n+  const statusEvents = deriveEvents(repository, {filters: [statusFilter]})\n \n   const patchList = $derived.by(() =\u003e {\n-    if (repoClass.patches) {\n-      return repoClass.patches.map((patch: TrustedEvent) =\u003e {\n-        const profile = deriveProfile(patch.pubkey)\n-        let status = $statuses\n-          ?.filter(s =\u003e {\n+    if (repoClass.patches \u0026\u0026 $statusEvents.length \u003e 0) {\n+      return repoClass.patches.map((patch: Patch) =\u003e {\n+        const profile = deriveProfile(patch.author.pubkey)\n+        const statusEvent = $statusEvents\n+          ?.filter((s: any) =\u003e {\n             let [_, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n             return eventId === patch.id\n           })\n-          .sort((a: TrustedEvent, b: TrustedEvent) =\u003e b.created_at - a.created_at)[0]\n+          .sort((a: any, b: any) =\u003e b.created_at - a.created_at)[0]\n+\n+        const status = statusEvent ? parseStatusEvent(statusEvent as StatusEvent) : undefined\n+        \n+        console.log($statusEvents)\n+        \n         return {\n           ...patch,\n-          patches: repoClass.patches.filter(\n-            issue =\u003e issue.tags.find(nthEq(0, \"e\"))?.[1] === patch.id,\n-          ),\n+          ...patch.raw,\n+          patches: repoClass.patches.filter(issue =\u003e issue.id === patch.id),\n           status,\n           profile,\n         }\n@@ -61,7 +65,7 @@\n   $effect(() =\u003e {\n     if (repoClass.patches) {\n       load({relays: repoClass.relays, filters: [patchFilter, statusFilter]})\n- \n+\n       makeFeed({\n         element: element!,\n         relays: repoClass.relays,\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 4868926..24a3a23 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -1,27 +1,19 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n   import {GitCommit, MessageSquare, Check, X} from \"@lucide/svelte\"\n-  import {parseGitPatchFromEvent} from \"@nostr-git/core\"\n-  import {Button, Repo} from \"@nostr-git/ui\"\n+  import {Button} from \"@nostr-git/ui\"\n   import {Avatar, AvatarFallback, AvatarImage, DiffViewer, IssueThread} from \"@nostr-git/ui\"\n   import {deriveProfile, repository} from \"@welshman/app\"\n-  import {getContext} from \"svelte\"\n   import markdownit from \"markdown-it\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {load} from \"@welshman/net\"\n-  import {COMMENT, type Filter} from \"@welshman/util\"\n-  import type {CommentEvent} from \"@nostr-git/shared-types\"\n+  import {COMMENT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE, GIT_STATUS_DRAFT, GIT_STATUS_OPEN, type Filter} from \"@welshman/util\"\n+  import {isStatusEvent, parseStatusEvent, type CommentEvent, type StatusEvent} from \"@nostr-git/shared-types\"\n \n-  const repoClass = getContext\u003cRepo\u003e(\"repoClass\")\n+  const {data} = $props()\n+  const {repoClass} = data\n \n-  const patch = $derived.by(() =\u003e {\n-    if (repoClass.patches) {\n-      const p = repoClass.patches.find(p =\u003e p.id === $page.params.patchid)\n-      if (p) {\n-        return parseGitPatchFromEvent(p)\n-      }\n-    }\n-  })\n+  const patch = repoClass.patches.find(p =\u003e p.id === $page.params.patchid)\n \n   const threadComments = $derived.by(() =\u003e {\n     if (repoClass.patches) {\n@@ -31,12 +23,26 @@\n     }\n   })\n \n+  const statusFilter = {\n+    kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+    \"#e\": [patch?.id!],\n+  }\n+\n+  const statusEvents = deriveEvents(repository, {filters: [statusFilter]})\n+\n   const patchProfile = $derived.by(() =\u003e {\n     if (patch) {\n       return deriveProfile(patch.author.pubkey)\n     }\n   })\n \n+  const status = $derived.by(() =\u003e {\n+    if ($statusEvents) {\n+      const statusEvent = $statusEvents.filter(isStatusEvent).sort((a, b) =\u003e b.created_at - a.created_at)[0]\n+      return statusEvent ? parseStatusEvent(statusEvent as StatusEvent) : undefined\n+    }\n+  })\n+\n   const md = markdownit({\n     html: true,\n     linkify: true,\n@@ -50,14 +56,14 @@\n       \u003cdiv class=\"rounded-lg border border-border bg-card p-6\"\u003e\n         \u003cdiv class=\"mb-4 flex items-start justify-between\"\u003e\n           \u003cdiv class=\"flex items-start gap-4\"\u003e\n-            {#if patch?.status === \"open\"}\n+            {#if status?.status === \"open\"}\n               \u003cdiv class=\"mt-1\"\u003e\n                 \u003cdiv\n                   class=\"flex h-10 w-10 items-center justify-center rounded-full bg-amber-500/10\"\u003e\n                   \u003cGitCommit class=\"h-5 w-5 text-amber-500\" /\u003e\n                 \u003c/div\u003e\n               \u003c/div\u003e\n-            {:else if patch?.status === \"merged\"}\n+            {:else if status?.status === \"applied\"}\n               \u003cdiv class=\"mt-1\"\u003e\n                 \u003cdiv\n                   class=\"flex h-10 w-10 items-center justify-center rounded-full bg-green-500/10\"\u003e\n@@ -77,10 +83,10 @@\n \n               \u003cdiv class=\"mt-1 flex items-center gap-2\"\u003e\n                 \u003cdiv class=\"git-tag bg-secondary\"\u003e\n-                  {patch?.status === \"open\"\n+                  {status?.status === \"open\"\n                     ? \"Open\"\n-                    : patch?.status === \"merged\"\n-                      ? \"Merged\"\n+                    : status?.status === \"applied\"\n+                      ? \"Applied\"\n                       : \"Closed\"}\n                 \u003c/div\u003e\n                 \u003cspan class=\"text-sm text-muted-foreground\"\u003e\n@@ -106,7 +112,7 @@\n           \u003ch2 class=\"text-lg font-medium\"\u003e{patch?.commitCount} Commits\u003c/h2\u003e\n \n           \u003cdiv class=\"flex items-center gap-2\"\u003e\n-            {#if patch?.status === \"open\"}\n+            {#if status?.status === \"open\"}\n               \u003cButton variant=\"default\" size=\"sm\" class=\"bg-git hover:bg-git-hover\"\u003e\n                 Merge Patch\n               \u003c/Button\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\nindex dba97a7..023f6e4 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n@@ -92,7 +92,7 @@\n     \u003c/div\u003e\n \n     \u003cdiv class=\"mb-6 grid grid-cols-2 gap-6\"\u003e\n-      \u003cPatchSelector patches={repoClass.patches} selectedPatch={$selectedPatch} onPatchSelect={(patch: any) =\u003e selectedPatch = patch} /\u003e\n+      \u003cPatchSelector patches={repoClass.patches} selectedPatch={selectedPatch} onPatchSelect={(patch: any) =\u003e selectedPatch = patch} /\u003e\n       \u003cCommitSelector commits={repoClass.commits} selectedCommit={$selectedCommit} onCommitSelect={(commit: any) =\u003e selectedCommit = commit} /\u003e\n     \u003c/div\u003e\n \n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-balxt7cx","title":"From 29d2c919c923fd711018b12a93977e20a5c772db Mon Sep 17 00:00:00 2001","description":"From 29d2c919c923fd711018b12a93977e20a5c772db Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sat, 22 Nov 2025 02:13:56 +0500\nSubject: [PATCH 4/6] feat: Improve markdown rendering and update submodule\n\n---\n pnpm-lock.yaml                                                          | Bin 549117 -\u003e 548939 bytes\n src/app/components/ChannelMessage.svelte                                |   4 ++--\n src/lib/components/Markdown.svelte                                      | 336 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++----------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |   4 +++-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte |   2 +-\n 5 files changed, 272 insertions(+), 74 deletions(-)\n\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 85c9f3693292ddcb35ce3df50e4993c693cf2a73..c04570460e0c12b0745e9127f13fe320b55fd887 100644\nGIT binary patch\ndelta 80\nzc%1utQ1SEu#SMn#ljquLOuuKvAwBu6okH{H^7hZ=j6lo;#LPg\u003c0\u003erF9%(ne=IeW?\u003e\nbkm~I~)pZ=xSFB)joot{cvVEm9M~Ex{CNm^n\n\ndelta 261\nzc$_\u003cZK=JQE#SMn#(+yUz2|5{QYLsP`q\u0026k@DndliAXgHKq7Ni#I=jErQIvAPgS?B@f\nzOHzx9Q;R?\u003cOn_X7`r;A?V?8516Cii`o^5P$(-l^+iA`6q;*g\u0026F)=r^$N_qQ~az-F#\nz0%B$$W\u0026vVWAZFV\u003erJOzG5cTce4z#\u003cDV|x5jHdaQ1$%z``lOOQ%O\u003ebDi#y8nOO=S8k\nTTaK*hON}}7w@+~9*ewG9B573A\n\ndiff --git a/src/app/components/ChannelMessage.svelte b/src/app/components/ChannelMessage.svelte\nindex 9a53d3b..dfcc641 100644\n--- a/src/app/components/ChannelMessage.svelte\n+++ b/src/app/components/ChannelMessage.svelte\n@@ -8,7 +8,7 @@\n   import Reply from \"@assets/icons/reply-2.svg?dataurl\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n-  import Content from \"@lib/budabit/components/Content.svelte\"\n+  import Markdown from \"@lib/components/Markdown.svelte\"\n   import ThunkFailure from \"@app/components/ThunkFailure.svelte\"\n   import ProfileDetail from \"@app/components/ProfileDetail.svelte\"\n   import ReactionSummary from \"@app/components/ReactionSummary.svelte\"\n@@ -79,7 +79,7 @@\n         \u003c/div\u003e\n       {/if}\n       \u003cdiv class=\"text-sm\"\u003e\n-        \u003cContent minimalQuote {event} {url} /\u003e\n+        \u003cMarkdown content={event.content} {event} {url} /\u003e\n         {#if thunk}\n           \u003cThunkFailure showToastOnRetry {thunk} class=\"mt-2\" /\u003e\n         {/if}\ndiff --git a/src/lib/components/Markdown.svelte b/src/lib/components/Markdown.svelte\nindex cd9ec6d..be66649 100644\n--- a/src/lib/components/Markdown.svelte\n+++ b/src/lib/components/Markdown.svelte\n@@ -116,7 +116,7 @@\n   }\n \n   .markdown :global(img) {\n-    @apply my-4 h-auto max-w-full;\n+    @apply my-4 h-auto max-w-full rounded-lg;\n   }\n \n   /* Profile mentions - ensure proper vertical alignment */\n@@ -126,7 +126,7 @@\n \u003c/style\u003e\n \n \u003cscript lang=\"ts\"\u003e\n-  import {marked, type Token, type Tokens, type TokenizerAndRendererExtension} from \"marked\"\n+  import {Marked, type Token, type Tokens, type TokenizerAndRendererExtension} from \"marked\"\n   import DOMPurify from \"dompurify\"\n   import {nip19, nip05} from \"nostr-tools\"\n   import hljs from \"highlight.js\"\n@@ -137,13 +137,29 @@\n   import {normalizeRelayUrl} from \"@welshman/util\"\n   import Profile from \"@app/components/Profile.svelte\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n+  import ContentLinkBlock from \"@app/components/ContentLinkBlock.svelte\"\n+  import ContentQuote from \"@app/components/ContentQuote.svelte\"\n+  import type {TrustedEvent} from \"@welshman/util\"\n \n   interface Props {\n     content?: string\n     relays?: string[]\n-  }\n-\n-  let {content = \"\", relays}: Props = $props()\n+    event?: TrustedEvent\n+    url?: string\n+    minimalQuote?: boolean\n+    hideMediaAtDepth?: number\n+    depth?: number\n+  }\n+\n+  let {\n+    content = \"\",\n+    relays,\n+    event,\n+    url,\n+    minimalQuote = false,\n+    hideMediaAtDepth = 1,\n+    depth = 0,\n+  }: Props = $props()\n \n   let sanitizedContent = $state(\"\")\n   let containerElement: HTMLDivElement | undefined = $state()\n@@ -163,7 +179,6 @@\n \n   // Helper function to shorten URLs\n   function shortenUrl(url: string, text?: string): string {\n-    // If custom text is provided and it's not the same as URL, use it\n     if (text \u0026\u0026 text !== url) {\n       return text\n     }\n@@ -176,7 +191,6 @@\n       if (pathname \u0026\u0026 pathname !== \"/\") {\n         const pathParts = pathname.split(\"/\").filter(Boolean)\n         if (pathParts.length \u003e 0) {\n-          // Show first part of path, truncate if too long\n           const firstPath = pathParts[0]\n           if (firstPath.length \u003e 20) {\n             return `${domain}/${firstPath.substring(0, 15)}...`\n@@ -186,7 +200,6 @@\n       }\n       return domain\n     } catch (e) {\n-      // Fallback for invalid URLs\n       return url.length \u003e 40 ? `${url.substring(0, 20)}...${url.substring(url.length - 15)}` : url\n     }\n   }\n@@ -194,7 +207,6 @@\n   // Helper function to shorten Nostr URIs\n   function shortenNostrUri(tagType: string, content: string): string {\n     const fullUri = `${tagType}${content}`\n-    // Show first 8 and last 8 characters\n     return `${fullUri.slice(0, 8)}:${fullUri.slice(-8)}`\n   }\n \n@@ -216,7 +228,6 @@\n   // Get profile for a pubkey\n   const getPub = async (token: Token) =\u003e {\n     if (token.type === \"nostr\") {\n-      console.log(\"[markdown walkTokens getPub]\", token)\n       const fullId = token.fullId\n       if (!fullId) return\n \n@@ -224,9 +235,6 @@\n         const result: any = nip19.decode(fullId)\n         let pubkey: string | undefined\n \n-        console.log(\"[markdown walkTokens getPub result]\", result, pubkey)\n-\n-        // Narrow types properly\n         if (result.type === \"nprofile\") {\n           pubkey = result.data.pubkey\n         } else if (result.type === \"npub\") {\n@@ -244,8 +252,6 @@\n           profile = $profilesByPubkey.get(pubkey)\n         }\n \n-        console.log(\"[markdown walkTokens getPub profile]\", profile)\n-\n         if (profile) {\n           token.userName = profile.name || profile.display_name || null\n         }\n@@ -296,8 +302,6 @@\n       const match = nostrRegex.exec(src)\n       if (match) {\n         const [fullMatch, prefix, fullId] = match\n-        console.log(\"[markdown tokenizer match]\", match)\n-        // fullId is the complete npub1..., note1..., etc.\n         return {\n           type: \"nostr\",\n           raw: fullMatch,\n@@ -316,47 +320,69 @@\n \n       try {\n         const decoded = nip19.decode(fullId)\n+        const decodedType = decoded.type as string\n \n-        if (decoded.type === \"nevent\" || decoded.type === \"note\") {\n-          url = `https://coracle.social/notes/${fullId}`\n-          external = true\n-        } else if (decoded.type === \"nprofile\") {\n-          external = true\n-          url = `https://coracle.social/people/${fullId}`\n+        // For note, nevent and naddr, use ContentQuote if event is provided\n+        if (event \u0026\u0026 decodedType === \"note\") {\n+          const noteId = decoded.data as unknown as string\n+          if (noteId) {\n+            return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"note\" data-id=\"${noteId}\" data-relays=\"[]\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n+          }\n+        }\n \n-          // For npub and nprofile, create a placeholder that we'll replace with a Svelte component\n-          if (pubkey) {\n-            return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+        if (event \u0026\u0026 decodedType === \"nevent\") {\n+          const eventData = decoded.data as any\n+          const eventId = eventData?.id\n+          if (eventId) {\n+            const relaysAttr = JSON.stringify(eventData.relays || [])\n+            return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"nevent\" data-id=\"${eventId}\" data-relays=\"${relaysAttr.replace(/\"/g, \"\u0026quot;\")}\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n           }\n-        } else if (decoded.type === \"npub\") {\n-          url = `/people/${fullId}`\n+        }\n \n-          // For npub and nprofile, create a placeholder that we'll replace with a Svelte component\n-          if (pubkey) {\n-            return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+        if (event \u0026\u0026 decodedType === \"naddr\") {\n+          const addrData = decoded.data as any\n+          if (addrData?.kind \u0026\u0026 addrData?.pubkey \u0026\u0026 addrData?.identifier !== undefined) {\n+            const relaysAttr = JSON.stringify(addrData.relays || [])\n+            return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"naddr\" data-kind=\"${addrData.kind}\" data-pubkey=\"${addrData.pubkey}\" data-identifier=\"${addrData.identifier}\" data-relays=\"${relaysAttr.replace(/\"/g, \"\u0026quot;\")}\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n           }\n-        } else if (decoded.type === \"naddr\") {\n-          const data = decoded.data\n-          // For git repos, use internal routing\n-          if (data.kind === 30617) {\n-            url = `/${fullId}`\n-          } else {\n+        }\n+\n+        // Handle other Nostr entity types\n+        switch (decodedType) {\n+          case \"note\":\n+            url = `https://coracle.social/notes/${fullId}`\n+            external = true\n+            break\n+          case \"nevent\":\n+            url = `https://coracle.social/notes/${fullId}`\n+            external = true\n+            break\n+          case \"nprofile\":\n+            external = true\n+            url = `https://coracle.social/people/${fullId}`\n+            if (pubkey) {\n+              return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+            }\n+            break\n+          case \"npub\":\n+            url = `/people/${fullId}`\n+            if (pubkey) {\n+              return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+            }\n+            break\n+          case \"naddr\":\n             external = true\n             url = `https://coracle.social/${fullId}`\n-          }\n+            break\n         }\n       } catch (err) {\n         console.error(\"Failed to decode in renderer:\", err, fullId)\n-        // If decoding fails, use default URL\n         url = `/${fullId}`\n       }\n \n-      // For other types, render as simple link\n       const linkText = userName ? `@${userName}` : shortenNostrUri(\"\", fullId)\n       const externalAttributes = external ? 'target=\"_blank\" rel=\"noopener noreferrer\"' : \"\"\n-      return `\u003ca href=\"${url}\" ${externalAttributes} \n-                    class=\"link\" title=\"${fullId}\"\u003e${linkText}\n-                    \u003c/a\u003e`\n+      return `\u003ca href=\"${url}\" ${externalAttributes} class=\"link\" title=\"${fullId}\"\u003e${linkText}\u003c/a\u003e`\n     },\n   }\n \n@@ -384,7 +410,6 @@\n     },\n     renderer(token: Tokens.Generic) {\n       if (token.isNip05) {\n-        // Render as Nostr link - create placeholder for Svelte component\n         const {pubkey} = token\n         if (pubkey) {\n           return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n@@ -396,14 +421,17 @@\n     },\n   }\n \n-  marked.use({\n+  // Create a new marked instance for this component\n+  const markedInstance = new Marked({\n     extensions: [nostrTokenizer, emailTokenizer],\n     async: true,\n     breaks: true,\n     walkTokens: getPub,\n     renderer: {\n-      image() {\n-        return \"\"\n+      image(token) {\n+        const {href, title, text} = token\n+        const alt = text || title || \"\"\n+        return `\u003cimg src=\"${href}\" alt=\"${alt}\" class=\"my-4 h-auto max-w-full rounded-lg\" /\u003e`\n       },\n       link(token) {\n         const {href, text} = token\n@@ -418,7 +446,6 @@\n           try {\n             const result: any = nip19.decode(fullId)\n \n-            // For npub and nprofile, create placeholder for Profile component\n             if (result.type === \"nprofile\" || result.type === \"npub\") {\n               let pubkey = \"\"\n               if (result.type === \"nprofile\") {\n@@ -432,32 +459,69 @@\n               }\n             }\n \n-            // For other nostr types, create regular links\n-            let url = `/${fullId}`\n+            // For note, nevent and naddr, use ContentQuote if event is provided\n+            if (\n+              event \u0026\u0026\n+              (result.type === \"note\" || result.type === \"nevent\" || result.type === \"naddr\")\n+            ) {\n+              if (result.type === \"note\") {\n+                const noteId = result.data as string\n+                if (noteId) {\n+                  return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"note\" data-id=\"${noteId}\" data-relays=\"[]\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n+                }\n+              } else if (result.type === \"nevent\") {\n+                const eventData = result.data as any\n+                const eventId = eventData?.id\n+                if (eventId) {\n+                  const relaysAttr = JSON.stringify(eventData.relays || [])\n+                  return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"nevent\" data-id=\"${eventId}\" data-relays=\"${relaysAttr.replace(/\"/g, \"\u0026quot;\")}\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n+                }\n+              } else if (result.type === \"naddr\") {\n+                const addrData = result.data as any\n+                if (addrData?.kind \u0026\u0026 addrData?.pubkey \u0026\u0026 addrData?.identifier !== undefined) {\n+                  const relaysAttr = JSON.stringify(addrData.relays || [])\n+                  return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"naddr\" data-kind=\"${addrData.kind}\" data-pubkey=\"${addrData.pubkey}\" data-identifier=\"${addrData.identifier}\" data-relays=\"${relaysAttr.replace(/\"/g, \"\u0026quot;\")}\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n+                }\n+              }\n+            }\n+\n+            // Fallback to regular link if no event or not nevent/naddr\n+            let linkUrl = `/${fullId}`\n             let external = false\n \n             if (result.type === \"nevent\" || result.type === \"note\") {\n-              url = `https://coracle.social/notes/${fullId}`\n+              linkUrl = `https://coracle.social/notes/${fullId}`\n               external = true\n             } else if (result.type === \"naddr\") {\n-              const data = result.data\n+              const data = result.data as any\n               if (data.kind === 30617) {\n-                url = `/${fullId}`\n+                linkUrl = `/${fullId}`\n               } else {\n                 external = true\n-                url = `https://coracle.social/${fullId}`\n+                linkUrl = `https://coracle.social/${fullId}`\n               }\n             }\n \n             const externalAttributes = external ? 'target=\"_blank\" rel=\"noopener noreferrer\"' : \"\"\n             const linkText = text || fullId\n-            return `\u003ca href=\"${url}\" ${externalAttributes} class=\"link\" title=\"${fullId}\"\u003e${linkText}\u003c/a\u003e`\n+            return `\u003ca href=\"${linkUrl}\" ${externalAttributes} class=\"link\" title=\"${fullId}\"\u003e${linkText}\u003c/a\u003e`\n           } catch (err) {\n             console.error(\"Failed to decode nostr link:\", err, fullId)\n           }\n         }\n \n         // Regular URL handling\n+        // Check if this should be rendered as a block (media or standalone URL)\n+        const isMediaUrl = /\\.(jpe?g|png|gif|webp|svg|bmp|ico|mov|webm|mp4)(\\?.*)?$/i.test(href)\n+        // Standalone URL: when link text is the same as URL, or very similar (user just pasted URL)\n+        const isStandaloneUrl = !text || text === href || text.trim() === href.trim()\n+\n+        // Use ContentLinkBlock for media URLs or standalone URLs (when event is provided)\n+        if (event \u0026\u0026 (isMediaUrl || isStandaloneUrl)) {\n+          return `\u003cspan class=\"markdown-link-block-placeholder\" data-url=\"${href}\" data-event-id=\"${event.id}\"\u003e\u003c/span\u003e`\n+        }\n+\n+        // For inline links, render as regular link\n         const displayText = shortenUrl(href, text)\n         return `\u003ca href=\"${href}\" class=\"link\" title=\"${href}\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e${displayText}\u003c/a\u003e`\n       },\n@@ -481,9 +545,7 @@\n           language: validLang,\n         }).value\n \n-        return `\n-                    \u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-${validLang}\"\u003e${highlightedCode}\u003c/code\u003e\u003c/pre\u003e\n-                `\n+        return `\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-${validLang}\"\u003e${highlightedCode}\u003c/code\u003e\u003c/pre\u003e`\n       },\n     },\n   })\n@@ -491,9 +553,23 @@\n   $effect(() =\u003e {\n     if (content) {\n       ;(async () =\u003e {\n-        const parsed = await marked(content)\n+        const parsed = await markedInstance.parse(content)\n         sanitizedContent = DOMPurify.sanitize(parsed, {\n-          ADD_ATTR: [\"target\", \"title\", \"data-pubkey\", \"data-url\"],\n+          ADD_ATTR: [\n+            \"target\",\n+            \"title\",\n+            \"data-pubkey\",\n+            \"data-url\",\n+            \"data-event-id\",\n+            \"data-type\",\n+            \"data-id\",\n+            \"data-relays\",\n+            \"data-kind\",\n+            \"data-identifier\",\n+            \"data-minimal\",\n+            \"data-depth\",\n+            \"data-hide-media\",\n+          ],\n           ADD_TAGS: [\"span\"],\n         })\n       })()\n@@ -519,45 +595,41 @@\n       setTimeout(() =\u003e {\n         if (!containerElement) return\n \n-        const placeholders = containerElement.querySelectorAll(\".nostr-profile-placeholder\")\n-        placeholders.forEach(placeholder =\u003e {\n+        // Mount profile placeholders\n+        const profilePlaceholders = containerElement.querySelectorAll(\".nostr-profile-placeholder\")\n+        profilePlaceholders.forEach(placeholder =\u003e {\n           const pubkey = placeholder.getAttribute(\"data-pubkey\")\n-          const url = placeholder.getAttribute(\"data-url\")\n+          const profileUrl = placeholder.getAttribute(\"data-url\")\n \n           if (pubkey) {\n             try {\n-              // Create a wrapper div to hold both components\n               const wrapper = document.createElement(\"div\")\n               wrapper.className = \"inline-flex items-center gap-1 align-middle\"\n               wrapper.style.verticalAlign = \"middle\"\n \n-              // Create containers for each component\n               const avatarContainer = document.createElement(\"span\")\n               const linkContainer = document.createElement(\"span\")\n \n               wrapper.appendChild(avatarContainer)\n               wrapper.appendChild(linkContainer)\n \n-              // Replace placeholder with wrapper\n               placeholder.replaceWith(wrapper)\n \n-              // Mount Profile component (avatar only, hideDetails=true)\n               const profileComponent = mount(Profile, {\n                 target: avatarContainer,\n                 props: {\n                   pubkey,\n-                  url: url || undefined,\n+                  url: profileUrl || undefined,\n                   avatarSize: 6,\n                   hideDetails: true,\n                 },\n               })\n \n-              // Mount ProfileLink component (name only)\n               const linkComponent = mount(ProfileLink, {\n                 target: linkContainer,\n                 props: {\n                   pubkey,\n-                  url: url || undefined,\n+                  url: profileUrl || undefined,\n                 },\n               })\n \n@@ -570,6 +642,130 @@\n             }\n           }\n         })\n+\n+        // Mount ContentLinkBlock for media/standalone links\n+        if (event) {\n+          const linkBlockPlaceholders = containerElement.querySelectorAll(\n+            \".markdown-link-block-placeholder\",\n+          )\n+          linkBlockPlaceholders.forEach(placeholder =\u003e {\n+            const linkUrl = placeholder.getAttribute(\"data-url\")\n+            const eventId = placeholder.getAttribute(\"data-event-id\")\n+\n+            if (linkUrl \u0026\u0026 eventId \u0026\u0026 event.id === eventId) {\n+              try {\n+                const container = document.createElement(\"div\")\n+                placeholder.replaceWith(container)\n+\n+                const linkBlockComponent = mount(ContentLinkBlock, {\n+                  target: container,\n+                  props: {\n+                    value: {url: new URL(linkUrl)},\n+                    event,\n+                  },\n+                })\n+                mountedComponents.push({target: container, component: linkBlockComponent})\n+              } catch (e) {\n+                console.error(\"Failed to mount ContentLinkBlock:\", e)\n+                // Fallback to regular link\n+                const link = document.createElement(\"a\")\n+                link.href = linkUrl\n+                link.textContent = linkUrl\n+                link.className = \"link\"\n+                link.target = \"_blank\"\n+                link.rel = \"noopener noreferrer\"\n+                placeholder.replaceWith(link)\n+              }\n+            }\n+          })\n+\n+          // Mount ContentQuote for note, nevent and naddr\n+          const quotePlaceholders = containerElement.querySelectorAll(\".markdown-quote-placeholder\")\n+          quotePlaceholders.forEach(placeholder =\u003e {\n+            const quoteType = placeholder.getAttribute(\"data-type\")\n+            const eventId = placeholder.getAttribute(\"data-event-id\")\n+            const quoteUrl = placeholder.getAttribute(\"data-url\") || url\n+            const minimal = placeholder.getAttribute(\"data-minimal\") === \"true\"\n+            const quoteDepth = parseInt(placeholder.getAttribute(\"data-depth\") || \"0\")\n+            const hideMedia = parseInt(placeholder.getAttribute(\"data-hide-media\") || \"1\")\n+\n+            if (eventId \u0026\u0026 event.id === eventId) {\n+              try {\n+                let quoteValue: any = null\n+\n+                if (quoteType === \"note\" || quoteType === \"nevent\") {\n+                  const id = placeholder.getAttribute(\"data-id\")\n+                  if (!id) {\n+                    console.error(`Missing id for ${quoteType} quote`)\n+                    return\n+                  }\n+                  const relaysAttr = placeholder.getAttribute(\"data-relays\") || \"[]\"\n+                  let relays: string[] = []\n+                  try {\n+                    relays = JSON.parse(relaysAttr.replace(/\u0026quot;/g, '\"'))\n+                  } catch (e) {\n+                    console.error(`Failed to parse relays for ${quoteType}:`, e)\n+                    relays = []\n+                  }\n+                  quoteValue = {id, relays}\n+                } else if (quoteType === \"naddr\") {\n+                  const kindAttr = placeholder.getAttribute(\"data-kind\")\n+                  const pubkeyAttr = placeholder.getAttribute(\"data-pubkey\")\n+                  const identifierAttr = placeholder.getAttribute(\"data-identifier\")\n+\n+                  if (!kindAttr || !pubkeyAttr || identifierAttr === null) {\n+                    console.error(\"Missing required fields for naddr quote\", {\n+                      kindAttr,\n+                      pubkeyAttr,\n+                      identifierAttr,\n+                    })\n+                    return\n+                  }\n+\n+                  const kind = parseInt(kindAttr)\n+                  if (isNaN(kind)) {\n+                    console.error(\"Invalid kind for naddr quote:\", kindAttr)\n+                    return\n+                  }\n+\n+                  const relaysAttr = placeholder.getAttribute(\"data-relays\") || \"[]\"\n+                  let relays: string[] = []\n+                  try {\n+                    relays = JSON.parse(relaysAttr.replace(/\u0026quot;/g, '\"'))\n+                  } catch (e) {\n+                    console.error(\"Failed to parse relays for naddr:\", e)\n+                    relays = []\n+                  }\n+                  quoteValue = {kind, pubkey: pubkeyAttr, identifier: identifierAttr, relays}\n+                }\n+\n+                if (quoteValue) {\n+                  const container = document.createElement(\"div\")\n+                  placeholder.replaceWith(container)\n+\n+                  const quoteComponent = mount(ContentQuote, {\n+                    target: container,\n+                    props: {\n+                      value: quoteValue,\n+                      event,\n+                      url: quoteUrl || undefined,\n+                      minimal,\n+                      depth: quoteDepth,\n+                      hideMediaAtDepth: hideMedia,\n+                    },\n+                  })\n+                  mountedComponents.push({target: container, component: quoteComponent})\n+                }\n+              } catch (e) {\n+                console.error(\"Failed to mount ContentQuote:\", e, {\n+                  quoteType,\n+                  eventId,\n+                  placeholder: placeholder.outerHTML,\n+                })\n+              }\n+            }\n+          })\n+        }\n       }, 0)\n     }\n \ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 1de98e3..7b1f356 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -13,6 +13,7 @@\n   import {pushToast} from \"@src/app/util/toast\"\n   import EventActions from \"@src/app/components/EventActions.svelte\"\n   import ReactionSummary from \"@src/app/components/ReactionSummary.svelte\"\n+  import Markdown from \"@src/lib/components/Markdown.svelte\"\n   import {pushModal} from \"@app/util/modal\"\n   import {EditRepoPanel, ForkRepoDialog} from \"@nostr-git/ui\"\n   import {postRepoAnnouncement} from \"@lib/budabit/commands.js\"\n@@ -618,7 +619,8 @@\n         ProfileLink: ProfileLink as typeof import(\"@nostr-git/ui\").ProfileLink,\n         EventActions: EventActions as typeof import(\"@nostr-git/ui\").EventActions,\n         ReactionSummary: ReactionSummary as typeof import(\"@nostr-git/ui\").ReactionSummary,\n-      }}\u003e\n+        Markdown: Markdown as any,\n+      } as any}\u003e\n       {@render children()}\n     \u003c/ConfigProvider\u003e\n   {/if}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 43bf1e9..2513509 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -1274,7 +1274,7 @@\n           showNavigation={true}\n           showFileStats={true}\n           showPatchInfo={true}\n-          comments={$threadComments as CommentEvent[]}\n+          comments={diffComments}\n           rootEvent={selectedPatch?.raw}\n           onComment={handleCommentSubmit}\n           currentPubkey={$pubkey}\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-bg4linpy","title":"Repo-feed, threads: Reverse chronological order","description":"Newest always on top, scrolling needs to be downwards.\n\"Looking for ... \" loading part must be at the bottom and mostly invisible if there are many items in the feed i.e. show under the oldest stuff.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["Repos","Threads","enhancement","good first issue","issue"]}
{"id":"flotilla-bh6iw88s","title":"From f59e25ea80b6fd953887c3dec4e20f9546073b9f Mon Sep 17 00:00:00 2001","description":"From f59e25ea80b6fd953887c3dec4e20f9546073b9f Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 9 Jun 2025 10:38:50 -0700\nSubject: [PATCH 2/4] feat: add git workbench UI for analyzing merge compatibility between patches and commits\n\n---\n packages/nostr-git                                                      |   2 +-\n src/app/state.ts                                                        |   2 +-\n src/lib/repo.ts                                                         |  81 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |  10 ++++++----\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte              |   9 +++------\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte            |  21 +++++++++++++++++----\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte |   7 +++----\n src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte         | 263 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n 8 files changed, 375 insertions(+), 20 deletions(-)\n create mode 100644 src/lib/repo.ts\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 0ce8d9f..89be359 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 0ce8d9feb98cbee9580cff8d34d0234d6ab47640\n+Subproject commit 89be359b3968d98d5a2d426e5c42601602469cf6\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 9006e8e..5784a61 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -242,7 +242,7 @@ export const deriveNaddrEvent = (naddr: string, hints: string[] = []) =\u003e {\n   let attempted = false\n   const decoded = nip19.decode(naddr).data as AddressPointer\n   const fallbackRelays = [...hints, ...INDEXER_RELAYS]\n-  const relays = decoded.relays?.length \u003e 0 ? decoded.relays : fallbackRelays\n+  const relays = decoded.relays?.length! \u003e 0 ? decoded.relays : fallbackRelays\n   const filters = [{\n     authors: [decoded.pubkey],\n     kinds: [decoded.kind],\ndiff --git a/src/lib/repo.ts b/src/lib/repo.ts\nnew file mode 100644\nindex 0000000..477fe7e\n--- /dev/null\n+++ b/src/lib/repo.ts\n@@ -0,0 +1,81 @@\n+import { derived, get } from 'svelte/store';\n+import { parseRepoAnnouncementEvent, type CommentEvent, type IssueEvent, type RepoAnnouncementEvent } from '@nostr-git/shared-types';\n+import { deriveNaddrEvent } from '@src/app/state';\n+import { deriveEvents } from '@welshman/store';\n+import { publishThunk, repository } from '@welshman/app';\n+import { GIT_ISSUE, GIT_PATCH, type Filter } from '@welshman/util';\n+import { Address } from '@welshman/util';\n+import { GIT_REPO_STATE } from '@src/lib/util';\n+import { nthEq } from '@welshman/lib';\n+\n+\n+export function createRepoModel({ id, relay }: { id: string; relay: string }) {\n+    const repoEvent = deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay]);\n+\n+    const issues = derived(repoEvent, $repoEvent =\u003e {\n+        if (!$repoEvent) return [];\n+        const address = Address.fromEvent($repoEvent).toString();\n+        const issueFilter = [{ kinds: [GIT_ISSUE], \"#a\": [address] }];\n+        return deriveEvents(repository, { filters: issueFilter });\n+    });\n+\n+    const patches = derived(repoEvent, $repoEvent =\u003e {\n+        if (!$repoEvent) return [];\n+        const address = Address.fromEvent($repoEvent).toString();\n+        const patchFilter = [{ kinds: [GIT_PATCH], \"#a\": [address], \"#t\": [\"root\"] }];\n+        return deriveEvents(repository, { filters: patchFilter });\n+    });\n+\n+    const repoState = derived(repoEvent, $repoEvent =\u003e {\n+        if (!$repoEvent) return null;\n+        const repoAnn = parseRepoAnnouncementEvent($repoEvent as RepoAnnouncementEvent);\n+        const address = repoAnn.repoId;\n+        const repoStateFilter: Filter[] = [\n+            { kinds: [GIT_REPO_STATE], \"#d\": [address!] },\n+        ];\n+        return deriveEvents(repository, { filters: repoStateFilter });\n+    });\n+\n+    const relays = derived(repoEvent, $repoEvent =\u003e {\n+        if ($repoEvent) {\n+            const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || [];\n+            return relays;\n+        }\n+    });\n+\n+    function postComment(comment: CommentEvent) {\n+        const currentRelays = get(relays);\n+        if (!currentRelays?.length) {\n+            console.error('No relays available for posting comment');\n+            return Promise.reject('No relays available');\n+        }\n+\n+        return publishThunk({\n+            relays: currentRelays,\n+            event: comment,\n+        });\n+    }\n+\n+    function postIssue(issue: IssueEvent) {\n+        const currentRelays = get(relays);\n+        if (!currentRelays?.length) {\n+            console.error('No relays available for posting issue');\n+            return Promise.reject('No relays available');\n+        }\n+\n+        return publishThunk({\n+            relays: currentRelays,\n+            event: issue,\n+        });\n+    }\n+\n+    return {\n+        repoEvent,\n+        issues,\n+        patches,\n+        repoState,\n+        relays,\n+        postComment,\n+        postIssue,\n+    }\n+}\n\\ No newline at end of file\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex db36f2e..224fa4b 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -19,6 +19,8 @@\n   import {load} from \"@welshman/net\"\n   import {nthEq} from \"@welshman/lib\"\n   import {Buffer} from \"buffer\"\n+  import {nip19} from \"nostr-tools\"\n+  import type {AddressPointer} from \"nostr-tools/nip19\"\n   const {id, relay} = $page.params\n \n   let {children} = $props()\n@@ -27,6 +29,9 @@\n     ;(window as any).Buffer = Buffer\n   }\n \n+  const decoded = nip19.decode(id).data as AddressPointer\n+  const repoId = decoded.identifier\n+\n   let eventStore = $state(deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay]))\n \n   const repoState = $derived.by(() =\u003e {\n@@ -91,14 +96,11 @@\n \n   setContext(\"postIssue\", postIssue)\n \n-  const getProfile = (pubkey: string) =\u003e {\n-    return deriveProfile(pubkey)\n-  }\n-\n   setContext(\"getProfile\", deriveProfile)\n \n   const repo = $state({\n     repo: eventStore,\n+    repoId,\n     state: () =\u003e repoState,\n     issues: () =\u003e issues,\n     patches: () =\u003e patches,\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex e50102a..8a30724 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -16,7 +16,7 @@\n   import Button from \"@src/lib/components/Button.svelte\"\n   import {fly} from \"svelte/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n-    import Spinner from \"@src/lib/components/Spinner.svelte\"\n+  import Spinner from \"@src/lib/components/Spinner.svelte\"\n \n   const {id, relay} = $page.params\n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n@@ -67,7 +67,6 @@\n       loading = false\n     } else {\n       branches = listBranchesFromEvent({repoEvent: $repoEvent})\n-      loading = false\n     }\n   })\n \n@@ -85,8 +84,7 @@\n \u003cdiv class=\"rounded-lg border border-border bg-card\"\u003e\n   \u003cdiv class=\"p-4\"\u003e\n     {#if loading}\n-\n-      \u003cdiv class=\"text-muted-foreground\"\u003eLoading repository files...\u003c/div\u003e\n+      \u003cSpinner {loading}\u003eLoading files...\u003c/Spinner\u003e\n     {:else if error}\n       \u003cdiv class=\"text-red-500\"\u003e{error}\u003c/div\u003e\n     {:else if fallbackToBranches}\n@@ -140,9 +138,8 @@\n       \u003c/div\u003e\n       \u003cdiv class=\"border-t border-border pt-4\"\u003e\n         \u003cdiv class=\"space-y-2\"\u003e\n-          \u003cSpinner loading={loading}\u003eLoading files...\u003c/Spinner\u003e\n           {#await files then files}\n-          {#if files.length === 0}\n+            {#if files.length === 0}\n               \u003cdiv class=\"text-muted-foreground\"\u003eNo files found in this branch.\u003c/div\u003e\n             {:else}\n               {#each files as file}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex 875351d..a553d76 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -3,20 +3,23 @@\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Address, COMMENT, GIT_ISSUE, type TrustedEvent} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n-  import {deriveProfile, relays, repository} from \"@welshman/app\"\n+  import {deriveProfile, publishThunk, repository} from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {makeFeed} from \"@src/app/requests\"\n   import type {Readable} from \"svelte/store\"\n-  import {type RepoStateEvent} from \"@nostr-git/shared-types\"\n+  import {type IssueEvent, type RepoStateEvent} from \"@nostr-git/shared-types\"\n   import {fly} from \"@lib/transition\"\n   import {pushModal} from \"@src/app/modal\"\n   import {load} from \"@welshman/net\"\n   import {deriveEvents} from \"@welshman/store\"\n+  import {page} from \"$app/stores\"\n+  import {decodeRelay} from \"@src/app/state\"\n \n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n   const repo = getContext\u003c{\n     repo: Readable\u003cTrustedEvent\u003e\n+    repoId: string\n     state: () =\u003e Readable\u003cRepoStateEvent\u003e\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n     relays: () =\u003e string[]\n@@ -42,7 +45,7 @@\n \n     const issueFilter = {\n       kinds: [GIT_ISSUE],\n-      \"#a\": [Address.fromEvent($repoEvent).toString()],\n+      \"#a\": [repo.repoId],\n     }\n \n     const {cleanup} = makeFeed({\n@@ -57,10 +60,20 @@\n     })\n   })\n \n+  const url = decodeRelay($page.params.relay)\n+\n+  const postIssue = (issue: IssueEvent) =\u003e {\n+    publishThunk({\n+      relays: [url],\n+      event: issue,\n+    })\n+  }\n+\n   const onNewIssue = () =\u003e {\n     pushModal(NewIssueForm, {\n-      repoId: $repoEvent.id,\n+      repoId: repo.repoId,\n       repoOwnerPubkey: $repoEvent.pubkey,\n+      postIssue,\n     })\n   }\n \u003c/script\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 7489b0f..eb7014c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -11,8 +11,8 @@\n   import markdownit from \"markdown-it\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {load} from \"@welshman/net\"\n-  import {COMMENT, GIT_PATCH} from \"@welshman/util\"\n-    import { nthEq } from \"@welshman/lib\"\n+  import {COMMENT, GIT_PATCH, type Filter} from \"@welshman/util\"\n+  import {nthEq} from \"@welshman/lib\"\n \n   const repo = getContext\u003c{\n     repo: Readable\u003cTrustedEvent\u003e\n@@ -43,8 +43,7 @@\n \n   const threadComments = $derived.by(() =\u003e {\n     if ($patchSet) {\n-      console.log($patchSet)\n-      const filters = [{kinds: [COMMENT], \"#e\": $patchSet.map(patch =\u003e patch.tags.find(nthEq(0, \"e\"))?.[1])}]\n+      const filters: Filter[] = [{kinds: [COMMENT], \"#E\": patch?.id}]\n       load({relays: repo.relays(), filters})\n       return deriveEvents(repository, {filters})\n     }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\nnew file mode 100644\nindex 0000000..4b12723\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n@@ -0,0 +1,263 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {page} from \"$app/stores\"\n+  import {\n+    GitMerge,\n+    GitPullRequest,\n+    AlertTriangle,\n+    CheckCircle,\n+    XCircle,\n+    Zap,\n+    ArrowRight,\n+    Eye,\n+    Layers,\n+    Target,\n+    GitBranch,\n+  } from \"@lucide/svelte\"\n+  import {Button} from \"@nostr-git/ui\"\n+  import {Card, CardContent, CardHeader, CardTitle} from \"@nostr-git/ui\"\n+  import {Tabs, TabsContent, TabsList, TabsTrigger} from \"@nostr-git/ui\"\n+  import {Badge} from \"@nostr-git/ui\"\n+  import PatchSelector from \"@nostr-git/ui\"\n+  import CommitSelector from \"@nostr-git/ui\"\n+  import MergeAnalyzer from \"@nostr-git/ui\"\n+  import ConflictVisualizer from \"@nostr-git/ui\"\n+  import {getContext} from \"svelte\"\n+  import type {Readable} from \"svelte/store\"\n+  import type {RepoStateEvent} from \"@nostr-git/shared-types\"\n+  import type {TrustedEvent} from \"@welshman/util\"\n+\n+  let {repoId} = $page.params\n+  let selectedPatch = $state\u003cany\u003e(null)\n+  let selectedCommit = $state\u003cany\u003e(null)\n+  let mergeAnalysis = $state\u003cany\u003e(null)\n+  let isAnalyzing = $state(false)\n+\n+  const repo = getContext\u003c{\n+    repo: Readable\u003cTrustedEvent\u003e\n+    state: () =\u003e Readable\u003cRepoStateEvent\u003e\n+    issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+  }\u003e(\"repo\")\n+\n+  // Simulate merge analysis when both patch and commit are selected\n+  $effect(() =\u003e {\n+    if ($selectedPatch \u0026\u0026 $selectedCommit) {\n+      isAnalyzing = true\n+      // Simulate analysis delay\n+      setTimeout(() =\u003e {\n+        mergeAnalysis = {\n+          compatibility: $selectedPatch.id === \"patch-002\" ? \"conflicts\" : \"clean\",\n+          conflictCount: $selectedPatch.id === \"patch-002\" ? 3 : 0,\n+          affectedFiles:\n+            selectedPatch.id === \"patch-002\"\n+              ? [\"src/components/App.tsx\", \"src/styles/main.css\", \"src/auth/login.tsx\"]\n+              : [\"src/auth/oauth.ts\", \"src/types/user.ts\"],\n+          similarity: selectedPatch.id === \"patch-002\" ? 0.65 : 0.92,\n+          autoMergeable: selectedPatch.id !== \"patch-002\",\n+          riskLevel: selectedPatch.id === \"patch-002\" ? \"high\" : \"low\",\n+        }\n+        isAnalyzing = false\n+      }, 1500)\n+    }\n+  })\n+\n+  const getCompatibilityIcon = (compatibility: string) =\u003e {\n+    switch (compatibility) {\n+      case \"clean\":\n+        return {icon: CheckCircle, color: \"text-green-500\"}\n+      case \"conflicts\":\n+        return {icon: AlertTriangle, color: \"text-orange-500\"}\n+      case \"error\":\n+        return {icon: XCircle, color: \"text-red-500\"}\n+      default:\n+        return {icon: Zap, color: \"text-blue-500\"}\n+    }\n+  }\n+\n+  const getCompatibilityColor = (compatibility: string) =\u003e {\n+    switch (compatibility) {\n+      case \"clean\":\n+        return \"border-green-200 bg-green-50\"\n+      case \"conflicts\":\n+        return \"border-orange-200 bg-orange-50\"\n+      case \"error\":\n+        return \"border-red-200 bg-red-50\"\n+      default:\n+        return \"border-blue-200 bg-blue-50\"\n+    }\n+  }\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"container max-w-7xl py-6\"\u003e\n+  \u003cdiv class=\"mt-6\"\u003e\n+    \u003cdiv class=\"mb-6\"\u003e\n+      \u003cdiv class=\"mb-2 flex items-center gap-3\"\u003e\n+        \u003cdiv class=\"rounded-lg bg-gradient-to-br from-purple-500 to-blue-600 p-2\"\u003e\n+          \u003cLayers class=\"h-5 w-5 text-white\" /\u003e\n+        \u003c/div\u003e\n+        \u003cdiv\u003e\n+          \u003ch1 class=\"text-2xl font-bold\"\u003eGit Workbench\u003c/h1\u003e\n+          \u003cp class=\"text-muted-foreground\"\u003e\n+            Compare patches to commits and analyze merge compatibility with advanced visual tools\n+          \u003c/p\u003e\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+\n+    \u003cdiv class=\"mb-6 grid grid-cols-2 gap-6\"\u003e\n+      \u003cPatchSelector selectedPatch={$selectedPatch} onPatchSelect={setSelectedPatch} /\u003e\n+      \u003cCommitSelector selectedCommit={$selectedCommit} onCommitSelect={setSelectedCommit} /\u003e\n+    \u003c/div\u003e\n+\n+    {#if selectedPatch \u0026\u0026 selectedCommit}\n+      \u003cdiv class=\"mb-6 flex justify-center\"\u003e\n+        \u003cdiv class=\"flex items-center gap-4 rounded-lg bg-secondary/30 p-4\"\u003e\n+          \u003cBadge variant=\"outline\" class=\"gap-2\"\u003e\n+            \u003cGitPullRequest class=\"h-3 w-3\" /\u003e\n+            {$selectedPatch.name}\n+          \u003c/Badge\u003e\n+          \u003cArrowRight class=\"h-6 w-6 animate-pulse text-muted-foreground\" /\u003e\n+          \u003cBadge variant=\"outline\" class=\"gap-2\"\u003e\n+            \u003cGitBranch class=\"h-3 w-3\" /\u003e\n+            {$selectedCommit.hash}\n+          \u003c/Badge\u003e\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    {/if}\n+\n+    {#if mergeAnalysis || isAnalyzing}\n+      \u003cdiv class=\"space-y-6\"\u003e\n+        \u003cCard class={mergeAnalysis ? getCompatibilityColor(mergeAnalysis.compatibility) : \"\"}\u003e\n+          \u003cCardHeader class=\"pb-3\"\u003e\n+            \u003cCardTitle class=\"flex items-center gap-2 text-lg\"\u003e\n+              {#if isAnalyzing}\n+                \u003cZap class=\"h-5 w-5 animate-spin text-blue-500\" /\u003e\n+                Analyzing Merge Compatibility...\n+              {:else}\n+                {getCompatibilityIcon(mergeAnalysis.compatibility)}\n+                Merge Analysis Complete\n+              {/if}\n+            \u003c/CardTitle\u003e\n+          \u003c/CardHeader\u003e\n+          {#if mergeAnalysis}\n+            \u003cCardContent\u003e\n+              \u003cdiv class=\"mb-4 grid grid-cols-4 gap-4\"\u003e\n+                \u003cdiv class=\"text-center\"\u003e\n+                  \u003cdiv class=\"text-2xl font-bold text-blue-600\"\u003e\n+                    {Math.round(mergeAnalysis.similarity * 100)}%\n+                  \u003c/div\u003e\n+                  \u003cdiv class=\"text-xs text-muted-foreground\"\u003eSimilarity\u003c/div\u003e\n+                \u003c/div\u003e\n+                \u003cdiv class=\"text-center\"\u003e\n+                  \u003cdiv class=\"text-2xl font-bold text-orange-600\"\u003e\n+                    {mergeAnalysis.conflictCount}\n+                  \u003c/div\u003e\n+                  \u003cdiv class=\"text-xs text-muted-foreground\"\u003eConflicts\u003c/div\u003e\n+                \u003c/div\u003e\n+                \u003cdiv class=\"text-center\"\u003e\n+                  \u003cdiv class=\"text-2xl font-bold text-purple-600\"\u003e\n+                    {mergeAnalysis.affectedFiles.length}\n+                  \u003c/div\u003e\n+                  \u003cdiv class=\"text-xs text-muted-foreground\"\u003eFiles\u003c/div\u003e\n+                \u003c/div\u003e\n+                \u003cdiv class=\"text-center\"\u003e\n+                  \u003cBadge\n+                    variant={mergeAnalysis.riskLevel === \"low\" ? \"default\" : \"destructive\"}\n+                    class=\"text-xs\"\u003e\n+                    {mergeAnalysis.riskLevel} risk\n+                  \u003c/Badge\u003e\n+                \u003c/div\u003e\n+              \u003c/div\u003e\n+\n+              \u003cdiv class=\"flex items-center justify-between\"\u003e\n+                \u003cdiv class=\"flex items-center gap-2\"\u003e\n+                  \u003cTarget class=\"h-4 w-4\" /\u003e\n+                  \u003cspan class=\"text-sm\"\u003e\n+                    {mergeAnalysis.autoMergeable\n+                      ? \"Auto-mergeable\"\n+                      : \"Manual intervention required\"}\n+                  \u003c/span\u003e\n+                \u003c/div\u003e\n+\n+                \u003cdiv class=\"flex gap-2\"\u003e\n+                  \u003cButton size=\"sm\" variant=\"outline\" class=\"gap-2\"\u003e\n+                    \u003cEye class=\"h-3 w-3\" /\u003e\n+                    Preview Merge\n+                  \u003c/Button\u003e\n+                  \u003cButton size=\"sm\" class=\"gap-2\" disabled={!mergeAnalysis.autoMergeable}\u003e\n+                    \u003cGitMerge class=\"h-3 w-3\" /\u003e\n+                    Apply Merge\n+                  \u003c/Button\u003e\n+                \u003c/div\u003e\n+              \u003c/div\u003e\n+            \u003c/CardContent\u003e\n+          {/if}\n+        \u003c/Card\u003e\n+\n+        {#if mergeAnalysis}\n+          \u003cTabs value=\"analyzer\" class=\"w-full\"\u003e\n+            \u003cTabsList class=\"grid w-full grid-cols-2\"\u003e\n+              \u003cTabsTrigger value=\"analyzer\"\u003eMerge Analyzer\u003c/TabsTrigger\u003e\n+              \u003cTabsTrigger value=\"conflicts\"\u003e\n+                Conflict Visualizer\n+                {#if mergeAnalysis.conflictCount \u003e 0}\n+                  \u003cBadge variant=\"destructive\" class=\"ml-2\"\u003e\n+                    {mergeAnalysis.conflictCount}\n+                  \u003c/Badge\u003e\n+                {/if}\n+              \u003c/TabsTrigger\u003e\n+            \u003c/TabsList\u003e\n+\n+            \u003cTabsContent value=\"analyzer\"\u003e\n+              \u003cMergeAnalyzer\n+                analysis={mergeAnalysis}\n+                patch={selectedPatch}\n+                commit={selectedCommit} /\u003e\n+            \u003c/TabsContent\u003e\n+\n+            \u003cTabsContent value=\"conflicts\"\u003e\n+              \u003cConflictVisualizer\n+                conflicts={mergeAnalysis.conflictCount \u003e 0\n+                  ? [\n+                      {\n+                        file: \"src/components/App.tsx\",\n+                        lines: \"23-31\",\n+                        type: \"content\",\n+                        severity: \"high\",\n+                      },\n+                      {\n+                        file: \"src/styles/main.css\",\n+                        lines: \"45-48\",\n+                        type: \"formatting\",\n+                        severity: \"low\",\n+                      },\n+                      {\n+                        file: \"src/auth/login.tsx\",\n+                        lines: \"15-20\",\n+                        type: \"structure\",\n+                        severity: \"medium\",\n+                      },\n+                    ]\n+                  : []}\n+                analysis={mergeAnalysis} /\u003e\n+            \u003c/TabsContent\u003e\n+          \u003c/Tabs\u003e\n+        {/if}\n+      \u003c/div\u003e\n+\n+      {#if !selectedPatch || !selectedCommit}\n+        \u003cCard class=\"h-96\"\u003e\n+          \u003cCardContent class=\"flex h-full items-center justify-center\"\u003e\n+            \u003cdiv class=\"text-center text-muted-foreground\"\u003e\n+              \u003cLayers class=\"mx-auto mb-4 h-16 w-16 opacity-50\" /\u003e\n+              \u003ch3 class=\"mb-2 text-xl font-medium\"\u003eReady for Analysis\u003c/h3\u003e\n+              \u003cp class=\"max-w-md text-sm\"\u003e\n+                Select a patch and a commit above to begin merge compatibility analysis. The\n+                workbench will show you exactly what happens when they're combined.\n+              \u003c/p\u003e\n+            \u003c/div\u003e\n+          \u003c/CardContent\u003e\n+        \u003c/Card\u003e\n+      {/if}\n+    {/if}\n+  \u003c/div\u003e\n+\u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-bjd5zz58","title":"From e3c62ba98855be7ea3626156ca4229bca36f8f9c Mon Sep 17 00:00:00 2001","description":"From e3c62ba98855be7ea3626156ca4229bca36f8f9c Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 29 Jul 2025 02:34:20 -0700\nSubject: [PATCH 2/8] feat: add timeout to NIP-04 token decryption and new repo wizard button\n\n---\n packages/nostr-git                         |  2 +-\n pnpm-lock.yaml                             | Bin 498514 -\u003e 498591 bytes\n src/lib/utils/tokenLoader.ts               | 12 ++++++++----\n src/routes/+layout.svelte                  |  1 -\n src/routes/spaces/[relay]/git/+page.svelte | 13 +++++++++++++\n 5 files changed, 22 insertions(+), 6 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 18c78d2..0336d88 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 18c78d2675110698468e20fb074c0c406d96affd\n+Subproject commit 0336d880f964d5179b4be9cbefb41989159fa1a3\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 43a0976cd90986f6f12628a7098e0e84021d9669..1d6fd1c3f9702f95cc5d744b6a18251f23bf1531 100644\nGIT binary patch\ndelta 327\nzc$~YmO\u003eX{nxeW{4rqA+Y6`X9WF3x0ZG5Mgj2%DLnv4x)DWL^\u0026c\u0026ClF4J0\u003e4$Qx6Nu\nz4e`%*HO~kNHTDk+axHWV^9%|1s4~k\u003ePIt;GGq7;aPYozec1+Ap4+~67\u0026U7\u003emc6WBo\nzHqTA6^sFimH#1E3_Rh@-De#DJH**PfH4ROw(Dro?Z0\u003cSV-gBN2h?#(xd3(=!mdVA8\nzhSL+9SmmbMIkV0{Vhc=SW!=u@!g`evBB-;S$Bk70\u0026hd0-ErN4ic(ATwf^w$s_hxN?\nzu\u003cfQ_Xke9`KHZ144JaVz3!_x0e{f@EnSRcf^)XOjeFLlF^!ZJ!tkZA!v5HO?a$(h+\nfKEab!q+QFOb-R{7n=m({VY^)v+jhGsb`eJa5yNVk\n\ndelta 309\nzc$}NRUGCC0xeW{4CW~\u003enZ8mn-?3nD_tsYic7Mz?BTJGVWQd$s^onl_$Wssj_Y?hT$\nz92}(Ysjcs\u003c9hMYnke23@\u003e0|1b864v3\u003cdWuO808+Gl;oM?l44qso)Vg!pHiuvQ=09V\nz;$IP2\u003cnNT4-hA_X`_1!=K+FWh%-e6CXPI2gXfXYOH\u003e=$AZfDjRNNj;gtgPF^U0AO\u0026\nzLIicD^SiS0Y)^G#Wr2xopXSb51m~D~vaVu+aMr-I*fp?fPk-XW+6ELT@Mjg7UhfOk\nzfnW\u003cxcW`E9nJ(?e`WPts-;dRLx\u003eGgKetu_G?\u0026\u003cc\u003ctRn5@{;b=}{n\u003e=M84cRIqu920\nJN3n}I0suC`XwU!v\n\ndiff --git a/src/lib/utils/tokenLoader.ts b/src/lib/utils/tokenLoader.ts\nindex 312d270..16432fb 100644\n--- a/src/lib/utils/tokenLoader.ts\n+++ b/src/lib/utils/tokenLoader.ts\n@@ -52,7 +52,6 @@ export async function loadTokensFromStorage(tokenKey: string): Promise\u003cTokenEntr\n \n     const encryptedTokens = localStorage.getItem(tokenKey);\n     if (!encryptedTokens) {\n-\n       return [];\n     }\n \n@@ -67,15 +66,20 @@ export async function loadTokensFromStorage(tokenKey: string): Promise\u003cTokenEntr\n \n \n     \n-    // Decrypt the tokens\n-    const decrypted = await signerInfo.signer.nip04.decrypt(signerInfo.pubkey, encryptedTokens);\n+    // Decrypt the tokens with timeout to prevent hanging\n+    const decryptPromise = signerInfo.signer.nip04.decrypt(signerInfo.pubkey, encryptedTokens);\n+    const timeoutPromise = new Promise((_, reject) =\u003e \n+      setTimeout(() =\u003e reject(new Error('NIP-04 decryption timed out after 10 seconds')), 10000)\n+    );\n+    \n+    const decrypted = await Promise.race([decryptPromise, timeoutPromise]);\n+    \n     if (!decrypted) {\n       console.warn('🔐 Failed to decrypt tokens from localStorage');\n       return [];\n     }\n \n     const tokens = JSON.parse(decrypted) as TokenEntry[];\n-\n     return tokens;\n \n   } catch (error) {\ndiff --git a/src/routes/+layout.svelte b/src/routes/+layout.svelte\nindex e6a543e..13ea0e7 100644\n--- a/src/routes/+layout.svelte\n+++ b/src/routes/+layout.svelte\n@@ -238,7 +238,6 @@\n           const loadedTokens = await loadTokensFromStorage(tokenKey)\n           tokens.clear()\n           loadedTokens.forEach(token =\u003e tokens.push(token))\n-\n         } catch (error) {\n           console.warn('🔐 Failed to initialize git tokens at app level:', error)\n         }\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 00dd81b..5a0bf46 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -20,6 +20,7 @@\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {derived as _derived} from \"svelte/store\"\n+    import { NewRepoWizard } from \"@nostr-git/ui\"\n \n   const url = decodeRelay($page.params.relay)\n \n@@ -97,6 +98,14 @@\n       },\n     })\n   }\n+\n+  const onNewRepo = () =\u003e {\n+    pushModal(NewRepoWizard, {\n+      onClose: () =\u003e {\n+        back()\n+      },\n+    })\n+  }\n \u003c/script\u003e\n \n \u003cPageBar\u003e\n@@ -110,6 +119,10 @@\n   {/snippet}\n   {#snippet action()}\n     \u003cdiv class=\"row-2\"\u003e\n+      \u003cButton class=\"btn btn-secondary btn-sm\" onclick={onNewRepo}\u003e\n+        \u003cIcon icon=\"add-circle\" /\u003e\n+        New Repo\n+      \u003c/Button\u003e\n       \u003cButton class=\"btn btn-primary btn-sm\" onclick={onAddRepo}\u003e\n         \u003cIcon icon=\"git\" /\u003e\n         Edit Repos\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-blfatge4","title":"Patch page: sticky scrolling breaks UI","description":"The topmost element sticks on top and everything scrolls underneach. This is sticky behavior is unwanted","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue","patches"]}
{"id":"flotilla-blqu6wew","title":"Breadcrumbs in Code browsing","description":"navigation in code is much harder without breadcrumbs","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["code","enhancement","good first issue","issue"]}
{"id":"flotilla-bw3mntqm","title":"From 1c931d92a7a27aaffdb5632c58f78f23d099e0d5 Mon Sep 17 00:00:00 2001","description":"From 1c931d92a7a27aaffdb5632c58f78f23d099e0d5 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Sun, 11 May 2025 10:39:47 -0700\nSubject: [PATCH 1/2] feat: add pagination and loading states to issues view\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte | 79 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------\n 1 file changed, 72 insertions(+), 7 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex 58c4a5a..c430d68 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -1,6 +1,6 @@\n \u003cscript lang=\"ts\"\u003e\n   import {Button, IssueCard} from \"@nostr-git/ui\"\n-  import {Filter, Plus} from \"@lucide/svelte\"\n+  import {Funnel, Plus} from \"@lucide/svelte\"\n   import {deriveNaddrEvent} from \"@app/state\"\n   import {page} from \"$app/stores\"\n   import {GIT_ISSUE} from \"@welshman/util\"\n@@ -10,10 +10,19 @@\n   import {setChecked} from \"@src/app/notifications\"\n   import {nthEq} from \"@welshman/lib\"\n   import {deriveProfile} from \"@welshman/app\"\n+  import Profile from \"@src/app/components/Profile.svelte\"\n+  import Spinner from \"@src/lib/components/Spinner.svelte\"\n   const {id, relay} = $page.params\n   const relayArray = Array.isArray(relay) ? relay : [relay]\n   const repo = deriveNaddrEvent(id)\n-  const issues = $state([])\n+  let issues = $state([])\n+  let loading = $state(true)\n+  let currentPage = $state(1)\n+  const pageSize = 10\n+  const pageCount = $derived(() =\u003e Math.max(1, Math.ceil(issues.length / pageSize)))\n+  const paginatedIssues = $derived(() =\u003e\n+    issues.slice((currentPage - 1) * pageSize, currentPage * pageSize),\n+  )\n \n   async function loadIssues() {\n     issues.length = 0\n@@ -32,10 +41,23 @@\n     }\n   }\n \n+  async function loadIssuesWrapper() {\n+    loading = true\n+    await loadIssues()\n+    loading = false\n+  }\n+\n   onMount(() =\u003e {\n-    loadIssues()\n+    loadIssuesWrapper()\n     return () =\u003e setChecked($page.url.pathname)\n   })\n+\n+  function prevPage() {\n+    if (currentPage \u003e 1) currentPage = currentPage - 1\n+  }\n+  function nextPage() {\n+    if (currentPage \u003c pageCount()) currentPage = currentPage + 1\n+  }\n \u003c/script\u003e\n \n \u003cdiv\u003e\n@@ -48,7 +70,7 @@\n \n     \u003cdiv class=\"flex items-center gap-2\"\u003e\n       \u003cButton variant=\"outline\" size=\"sm\" class=\"gap-2\"\u003e\n-        \u003cFilter class=\"h-4 w-4\" /\u003e\n+        \u003cFunnel class=\"h-4 w-4\" /\u003e\n         Filter\n       \u003c/Button\u003e\n \n@@ -59,7 +81,50 @@\n     \u003c/div\u003e\n   \u003c/div\u003e\n \n-  {#each issues as issue}\n-    \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)}/\u003e\n-  {/each}\n+  {#if loading}\n+    \u003cdiv class=\"flex flex-col items-center justify-center py-12\"\u003e\n+      \u003cSpinner {loading}\u003e\n+        {#if loading}\n+          Loading issues….\n+        {:else}\n+          End of message history\n+        {/if}\n+      \u003c/Spinner\u003e\n+    \u003c/div\u003e\n+  {:else if issues.length === 0}\n+    \u003cdiv class=\"flex flex-col items-center justify-center py-12 text-gray-500\"\u003e\n+      \u003csvg\n+        class=\"mb-2 h-8 w-8\"\n+        fill=\"none\"\n+        stroke=\"currentColor\"\n+        stroke-width=\"2\"\n+        viewBox=\"0 0 24 24\"\u003e\n+        \u003cpath\n+          stroke-linecap=\"round\"\n+          stroke-linejoin=\"round\"\n+          d=\"M9 17v-2a4 4 0 118 0v2m-6 4h4a2 2 0 002-2v-2a6 6 0 10-12 0v2a2 2 0 002 2z\" /\u003e\n+      \u003c/svg\u003e\n+      No issues found.\n+    \u003c/div\u003e\n+  {:else}\n+    \u003cdiv\n+      class=\"bg-background flex max-h-[32rem] flex-col gap-y-4 overflow-y-auto rounded-md p-2\"\u003e\n+      {#each paginatedIssues() as issue}\n+        \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey, relayArray)} /\u003e\n+      {/each}\n+    \u003c/div\u003e\n+    \u003cdiv class=\"mt-4 flex items-center justify-center gap-4\"\u003e\n+      \u003cbutton\n+        onclick={prevPage}\n+        class=\"rounded bg-gray-100 px-3 py-1 hover:bg-gray-200 disabled:opacity-50\"\n+        disabled={currentPage === 1}\u003e\u0026larr; Prev\u003c/button\u003e\n+      \u003cspan class=\"text-gray-600\"\u003ePage {currentPage} of {pageCount()}\u003c/span\u003e\n+      \u003cbutton\n+        onclick={nextPage}\n+        class=\"rounded bg-gray-100 px-3 py-1 hover:bg-gray-200 disabled:opacity-50\"\n+        disabled={currentPage === pageCount()}\u003e\n+        Next \u0026rarr;\n+      \u003c/button\u003e\n+    \u003c/div\u003e\n+  {/if}\n \u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-by42jvc2","title":"Fork: Branch loading for forked repos FAILS","description":"Branches never load for forked repos despite it being present on the remote host (tested with GitHub)\n\nhttps://i.nostr.build/ztmQrgfxSFT1JfR0.png","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["branches","bug","create_repo","forks","issue"]}
{"id":"flotilla-c3xf8mn8","title":"From 5aa2f4cc2d2c091686f4a1033ca66ec5ed0920d8 Mon Sep 17 00:00:00 2001","description":"From 5aa2f4cc2d2c091686f4a1033ca66ec5ed0920d8 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Wed, 30 Jul 2025 13:32:22 -0700\nSubject: [PATCH 4/8] feat: add default relay publishing and repo settings functionality\n\n---\n packages/nostr-git                                      |  2 +-\n src/app/commands.ts                                     |  8 ++++----\n src/app/components/SignUpKeyConfirm.svelte              |  6 +++++-\n src/app/components/SignUpProfile.svelte                 |  5 +++--\n src/routes/settings/profile/+page.svelte                |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte | 76 +++++++++++++++++++++++++++++++++++++++++++++++-----------------------------\n 6 files changed, 61 insertions(+), 38 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex d6f2fd1..42161e5 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit d6f2fd17cddc608bc6d0e1e981b6e5a85f101ca9\n+Subproject commit 42161e542071106536b5db70d436f799bd3fbc63\ndiff --git a/src/app/commands.ts b/src/app/commands.ts\nindex e932183..ac6ed52 100644\n--- a/src/app/commands.ts\n+++ b/src/app/commands.ts\n@@ -449,7 +449,7 @@ export const publishAlert = async (params: AlertParams) =\u003e\n \n export const postComment = (comment: CommentEvent, relays: string[]) =\u003e {\n   return publishThunk({\n-    relays: relays ?? [],\n+    relays: relays ?? [...INDEXER_RELAYS, ...Router.get().FromUser().getUrls()],\n     event: comment,\n   })\n }\n@@ -457,20 +457,20 @@ export const postComment = (comment: CommentEvent, relays: string[]) =\u003e {\n export const postIssue = (issue: IssueEvent, relays: string[]) =\u003e {\n   return publishThunk({\n     event: issue,\n-    relays: relays ?? [],\n+    relays: relays ?? [...INDEXER_RELAYS, ...Router.get().FromUser().getUrls()],\n   })\n }\n \n export const postStatus = (status: StatusEvent, relays: string[]) =\u003e {\n   return publishThunk({\n-    relays: relays ?? [],\n+    relays: relays ?? [...INDEXER_RELAYS, ...Router.get().FromUser().getUrls()],\n     event: status,\n   })\n }\n \n export const postRepoAnnouncement = (repo: RepoAnnouncementEvent, relays: string[]) =\u003e {\n   return publishThunk({\n-    relays: relays ?? [],\n+    relays: relays ?? [...INDEXER_RELAYS, ...Router.get().FromUser().getUrls()],\n     event: repo,\n   })\n }\n\\ No newline at end of file\ndiff --git a/src/app/components/SignUpKeyConfirm.svelte b/src/app/components/SignUpKeyConfirm.svelte\nindex ee63d5f..23978e8 100644\n--- a/src/app/components/SignUpKeyConfirm.svelte\n+++ b/src/app/components/SignUpKeyConfirm.svelte\n@@ -8,6 +8,8 @@\n   import SignUpProfile from \"@app/components/SignUpProfile.svelte\"\n   import {pushToast} from \"@app/toast\"\n   import {pushModal} from \"@app/modal\"\n+  import {getPublicKey} from \"nostr-tools\"\n+  import {hexToBytes} from \"nostr-tools/utils\"\n \n   type Props = {\n     secret: string\n@@ -15,6 +17,8 @@\n   }\n \n   const {secret, ncryptsec}: Props = $props()\n+  const secretKey = hexToBytes(ncryptsec)\n+  const pubkey = getPublicKey(secretKey)\n \n   const back = () =\u003e history.back()\n \n@@ -24,7 +28,7 @@\n   }\n \n   const next = () =\u003e {\n-    pushModal(SignUpProfile, {secret})\n+    pushModal(SignUpProfile, {secret, pubkey})\n   }\n \u003c/script\u003e\n \ndiff --git a/src/app/components/SignUpProfile.svelte b/src/app/components/SignUpProfile.svelte\nindex 238d5db..a8f74ec 100644\n--- a/src/app/components/SignUpProfile.svelte\n+++ b/src/app/components/SignUpProfile.svelte\n@@ -8,9 +8,10 @@\n \n   type Props = {\n     secret: string\n+    pubkey: string\n   }\n \n-  const {secret}: Props = $props()\n+  const {secret, pubkey}: Props = $props()\n \n   const initialValues = {\n     profile: makeProfile(),\n@@ -34,7 +35,7 @@\n   }\n \u003c/script\u003e\n \n-\u003cProfileEditForm hideAddress {initialValues} {onsubmit}\u003e\n+\u003cProfileEditForm pubkey={pubkey} hideAddress {initialValues} {onsubmit}\u003e\n   {#snippet footer()}\n     \u003cButton type=\"submit\" class=\"btn btn-primary\"\u003eCreate Account\u003c/Button\u003e\n   {/snippet}\ndiff --git a/src/routes/settings/profile/+page.svelte b/src/routes/settings/profile/+page.svelte\nindex 2e872dd..12ac6df 100644\n--- a/src/routes/settings/profile/+page.svelte\n+++ b/src/routes/settings/profile/+page.svelte\n@@ -13,7 +13,7 @@\n   import ProfileDelete from \"@app/components/ProfileDelete.svelte\"\n   import InfoKeys from \"@app/components/InfoKeys.svelte\"\n   import Alerts from \"@app/components/Alerts.svelte\"\n-  import {GIT_CLIENT_ID, PLATFORM_NAME} from \"@app/state\"\n+  import {PLATFORM_NAME} from \"@app/state\"\n   import {pushModal} from \"@app/modal\"\n   import {clip} from \"@app/toast\"\n   import GitAuth from \"@src/app/components/GitAuth.svelte\"\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 462d5a1..29f677c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -1,5 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n-  import { RepoHeader, RepoTab, toast} from \"@nostr-git/ui\"\n+  import {RepoHeader, RepoTab, toast} from \"@nostr-git/ui\"\n   import {ConfigProvider} from \"@nostr-git/ui\"\n   import {FileCode, GitBranch, CircleAlert, GitPullRequest, GitCommit, Layers} from \"@lucide/svelte\"\n   import {page} from \"$app/stores\"\n@@ -13,6 +13,10 @@\n   import {pushToast} from \"@src/app/toast\"\n   import EventActions from \"@src/app/components/EventActions.svelte\"\n   import ReactionSummary from \"@src/app/components/ReactionSummary.svelte\"\n+  import {pushModal} from \"@src/app/modal.js\"\n+  import {EditRepoPanel} from \"@nostr-git/ui\"\n+  import {postRepoAnnouncement} from \"@src/app/commands.js\"\n+  import type {RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n \n   const {id, relay} = $page.params\n \n@@ -21,50 +25,50 @@\n \n   let activeTab: string | undefined = $page.url.pathname.split(\"/\").pop()\n   const encodedRelay = encodeURIComponent(relay)\n-  \n+\n   // Refresh state\n   let isRefreshing = $state(false)\n \n   // Refresh repository function\n   async function refreshRepo() {\n     if (!repoClass || isRefreshing) return\n-    \n+\n     isRefreshing = true\n-    \n+\n     try {\n       // Get clone URLs from the repo event\n       const cloneUrls = repoClass.repoEvent.tags\n-        .filter((tag: string[]) =\u003e tag[0] === 'clone')\n+        .filter((tag: string[]) =\u003e tag[0] === \"clone\")\n         .map((tag: string[]) =\u003e tag[1])\n         .filter(Boolean)\n-      \n+\n       if (cloneUrls.length === 0) {\n-        throw new Error('No clone URLs found for repository')\n+        throw new Error(\"No clone URLs found for repository\")\n       }\n-      \n+\n       // Call syncWithRemote through the repo's worker manager\n       const result = await repoClass.workerManager.syncWithRemote({\n         repoId: repoClass.repoEvent.id,\n         cloneUrls,\n-        branch: repoClass.mainBranch\n+        branch: repoClass.mainBranch,\n       })\n-      \n+\n       if (result.success) {\n         // Show success toast\n         pushToast({\n-          message: `Repository synced with remote (${result.headCommit?.slice(0, 8)})`\n+          message: `Repository synced with remote (${result.headCommit?.slice(0, 8)})`,\n         })\n-        \n+\n         // Reset the repo to refresh all cached data\n         await repoClass.reset()\n       } else {\n-        throw new Error(result.error || 'Sync failed')\n+        throw new Error(result.error || \"Sync failed\")\n       }\n     } catch (error) {\n-      console.error('Failed to refresh repository:', error)\n+      console.error(\"Failed to refresh repository:\", error)\n       pushToast({\n-        message: `Failed to sync repository: ${error instanceof Error ? error.message : 'Unknown error'}`,\n-        theme: 'error'\n+        message: `Failed to sync repository: ${error instanceof Error ? error.message : \"Unknown error\"}`,\n+        theme: \"error\",\n       })\n     } finally {\n       isRefreshing = false\n@@ -73,9 +77,18 @@\n \n   function forkRepo() {\n     if (!repoClass) return\n-    \n     // Fork the repository\n-    repoClass.workerManager.forkAndCloneRepo()\n+    repoClass.workerManager.apiInstance.forkAndCloneRepo()\n+  }\n+\n+  function settingsRepo() {\n+    if (!repoClass) return\n+    pushModal(EditRepoPanel, {\n+      repo: repoClass,\n+      onPublishEvent: (event: RepoAnnouncementEvent) =\u003e {\n+        postRepoAnnouncement(event, [])\n+      },\n+    })\n   }\n \n   // Connect the nostr-git toast store to the toast component\n@@ -84,15 +97,19 @@\n       $toast.forEach(t =\u003e {\n         // The toast store now handles format conversion internally\n         pushToast({\n-          message: t.message || (t.title \u0026\u0026 t.description ? `${t.title}: ${t.description}` : t.title || t.description || ''),\n+          message:\n+            t.message ||\n+            (t.title \u0026\u0026 t.description\n+              ? `${t.title}: ${t.description}`\n+              : t.title || t.description || \"\"),\n           timeout: t.timeout || t.duration,\n-          theme: t.theme || (t.variant === 'destructive' ? 'error' : undefined),\n+          theme: t.theme || (t.variant === \"destructive\" ? \"error\" : undefined),\n         })\n       })\n       toast.clear()\n     }\n   })\n-\n+  \n \u003c/script\u003e\n \n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n@@ -108,7 +125,8 @@\n       {refreshRepo}\n       {isRefreshing}\n       {forkRepo}\n-    \u003e\n+      {settingsRepo}\n+      \u003e\n       {#snippet children(activeTab: string)}\n         \u003cRepoTab\n           tabValue=\"feed\"\n@@ -169,13 +187,13 @@\n     \u003cConfigProvider\n       components={{\n         AvatarImage: Avatar as typeof import(\"@nostr-git/ui\").AvatarImage,\n-          Separator: Divider as typeof import(\"@nostr-git/ui\").Separator,\n-          Input: Input as typeof import(\"@nostr-git/ui\").Input,\n-          Alert: Dialog as typeof import(\"@nostr-git/ui\").Alert,\n-          ProfileComponent: Profile as typeof import(\"@nostr-git/ui\").Profile,\n-          ProfileLink: ProfileLink as typeof import(\"@nostr-git/ui\").ProfileLink,\n-          EventActions: EventActions as typeof import(\"@nostr-git/ui\").EventActions,\n-          ReactionSummary: ReactionSummary as typeof import(\"@nostr-git/ui\").ReactionSummary,\n+        Separator: Divider as typeof import(\"@nostr-git/ui\").Separator,\n+        Input: Input as typeof import(\"@nostr-git/ui\").Input,\n+        Alert: Dialog as typeof import(\"@nostr-git/ui\").Alert,\n+        ProfileComponent: Profile as typeof import(\"@nostr-git/ui\").Profile,\n+        ProfileLink: ProfileLink as typeof import(\"@nostr-git/ui\").ProfileLink,\n+        EventActions: EventActions as typeof import(\"@nostr-git/ui\").EventActions,\n+        ReactionSummary: ReactionSummary as typeof import(\"@nostr-git/ui\").ReactionSummary,\n       }}\u003e\n       {@render children()}\n     \u003c/ConfigProvider\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-c8bbvmw1","title":"From 8a91aab3db87dcbb7b4c5f61c11f7301b5f7d499 Mon Sep 17 00:00:00 2001","description":"From 8a91aab3db87dcbb7b4c5f61c11f7301b5f7d499 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Wed, 9 Jul 2025 17:44:40 -0700\nSubject: [PATCH 1/4] refactor: simplify tag filtering logic and improve patch thread handling\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           | 12 ++++--------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts               | 10 +++++-----\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 26 ++++++++++++++++++--------\n 3 files changed, 27 insertions(+), 21 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex fe914a5..afe36df 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -40,26 +40,22 @@\n       // First get all root patches\n       let filteredPatches = repoClass.patches\n         .filter((patch: PatchEvent) =\u003e {\n-          const tags = getTags(patch, \"t\")\n-          return tags.length \u003e 0 \u0026\u0026 tags[0][1] === \"root\"\n+          return getTags(patch, \"t\").find((tag: string[]) =\u003e tag[1] === \"root\")\n         })\n         .map((patch: PatchEvent) =\u003e {\n           const status = $statusEvents\n             ?.filter((s: any) =\u003e {\n-              let [_, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n-              return eventId === patch.id\n+              return getTags(s, \"e\").find((tag: string[]) =\u003e tag[1] === patch.id)\n             })\n             .sort((a: any, b: any) =\u003e b.created_at - a.created_at)[0]\n \n           const patches = repoClass.patches.filter(issue =\u003e {\n-            const tags = getTags(issue, \"e\")\n-            return tags.length \u003e 0 \u0026\u0026 tags[0][1] === patch.id\n+            return getTags(issue, \"e\").find((tag: string[]) =\u003e tag[1] === patch.id)\n           })\n           const parsedPatch = parseGitPatchFromEvent(patch)\n \n           const commentEvents = $comments?.filter((comment: any) =\u003e {\n-            const tags = getTags(comment, \"E\")\n-            return tags.length \u003e 0 \u0026\u0026 tags[0][1] === patch.id\n+            return getTags(comment, \"E\").find((tag: string[]) =\u003e tag[1] === patch.id)\n           })\n \n           return {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\nindex de13afa..9a18b65 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\n@@ -34,6 +34,11 @@ export const load = async ({parent}) =\u003e {\n     \"#t\": [\"root\"],\n   }\n \n+  await load({\n+    relays: repoClass.relays,\n+    filters: [commentFilter, statusEventFilter, patchFilter],\n+  })\n+\n   const statusEvents = deriveEvents(repository, {filters: [statusEventFilter]})\n \n   const comments = derived(\n@@ -43,11 +48,6 @@ export const load = async ({parent}) =\u003e {\n \n   const uniqueAuthors = new Set(repoClass.patches.map((patch: PatchEvent) =\u003e patch.pubkey))\n \n-  await load({\n-    relays: repoClass.relays,\n-    filters: [commentFilter, statusEventFilter, patchFilter],\n-  })\n-\n   return {\n     comments,\n     statusEvents,\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 3765238..0eaf1f6 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -1,6 +1,14 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n-  import {Check, ChevronLeft, ChevronRight, GitCommit, GitMerge, MessageSquare, X} from \"@lucide/svelte\"\n+  import {\n+    Check,\n+    ChevronLeft,\n+    ChevronRight,\n+    GitCommit,\n+    GitMerge,\n+    MessageSquare,\n+    X,\n+  } from \"@lucide/svelte\"\n   import {Button, Profile} from \"@nostr-git/ui\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import {DiffViewer, IssueThread} from \"@nostr-git/ui\"\n@@ -58,10 +66,13 @@\n     .filter((p): p is PatchEvent =\u003e {\n       if (p.id === patchId) return true\n       const directReplyToThis = getTags(p, \"e\").some(tag =\u003e tag[1] === patchId)\n-      if (directReplyToThis) return true\n+      if (directReplyToThis) {\n+        console.log(\"direct reply to this:\", p)\n+        return true\n+      }\n       if (rootPatchId !== patchId) {\n         const replyTags = getTags(p, \"e\")\n-        if (replyTags.length \u003e 0) {\n+        if (replyTags.length === 0) {\n           let checkPatch: PatchEvent | undefined = p\n           let foundRoot = false\n \n@@ -87,6 +98,8 @@\n     .sort((a, b) =\u003e (a.id === rootPatchId ? -1 : 1))\n     .map(p =\u003e parseGitPatchFromEvent(p))\n \n+console.log(\"patchSet:\", patchSet)\n+\n   let selectedPatch = $state(patch)\n \n   const threadComments = $derived.by(() =\u003e {\n@@ -125,10 +138,7 @@\n     typographer: true,\n   })\n \n-  const applyPatch = () =\u003e {\n-    \n-  }\n-\n+  const applyPatch = () =\u003e {}\n \u003c/script\u003e\n \n {#if patch}\n@@ -254,7 +264,7 @@\n                       \u003cspan\u003e{new Date(selectedPatch.createdAt).toLocaleString()}\u003c/span\u003e\n                       {#if selectedPatch.commitHash}\n                         \u003cspan\u003e•\u003c/span\u003e\n-                        \u003cspan\u003e{selectedPatch.commitHash}\u003c/span\u003e\n+                        \u003cspan\u003e{selectedPatch.commitHash.slice(0, 8)}\u003c/span\u003e\n                       {/if}\n                     \u003c/div\u003e\n                   \u003c/div\u003e\n--\nlibgit2 1.9.0\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-c9089luz","title":"From a6a8e63acaf655ee0284edd0079d86f91297e5c1 Mon Sep 17 00:00:00 2001","description":"From a6a8e63acaf655ee0284edd0079d86f91297e5c1 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Tue, 3 Jun 2025 16:59:05 -0700\nSubject: [PATCH 16/67] Fix chat menu item active state\n\n---\n src/app/components/ChatItem.svelte | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/src/app/components/ChatItem.svelte b/src/app/components/ChatItem.svelte\nindex 52a2a65..400ccc1 100644\n--- a/src/app/components/ChatItem.svelte\n+++ b/src/app/components/ChatItem.svelte\n@@ -22,7 +22,7 @@\n   const {...props}: Props = $props()\n \n   const others = remove($pubkey!, props.pubkeys)\n-  const active = $page.params.chat === props.id\n+  const active = $derived($page.params.chat === props.id)\n   const path = makeChatPath(props.pubkeys)\n \n   onMount(() =\u003e {\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-cawn66ad","title":"From 5aa2f4cc2d2c091686f4a1033ca66ec5ed0920d8 Mon Sep 17 00:00:00 2001","description":"From 5aa2f4cc2d2c091686f4a1033ca66ec5ed0920d8 Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/4] Added new git features to add, update, apply patches to and fork repos\n\nAdded Flotilla-Budabit integrations for adding, updating, applying patches and forking repos","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-cektima1","title":"From 98964b286ab0206247cce6ee1a62551e58f816e7 Mon Sep 17 00:00:00 2001","description":"From 98964b286ab0206247cce6ee1a62551e58f816e7 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Thu, 18 Dec 2025 12:43:11 +0500\nSubject: [PATCH] fix: ensure reactive dependencies are tracked in setTimeout callbacks\n\n- Capture all reactive state synchronously at top of effects to ensure\n  Svelte 5 tracks them properly\n- Fix cache keys being read inside setTimeout callbacks by capturing\n  them synchronously\n- Improve comment loading effect with proper abort controller cleanup\n- Use setTimeout consistently instead of requestAnimationFrame for\n  deferred operations\n- Remove redundant re-reading of reactive values inside setTimeout\n\nThis ensures UI updates correctly when filters, search terms, or other\nreactive state changes.\n---\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte  | 184 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte | 117 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++------------------------------------------------\n 2 files changed, 187 insertions(+), 114 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex cbacc1e..996cda3 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -85,22 +85,21 @@\n   \n   // Compute labelsData asynchronously to avoid blocking render\n   $effect(() =\u003e {\n+    // Access reactive dependency synchronously to ensure it's tracked\n+    const currentIssues = issues\n+    \n     // Create cache key from issue IDs to detect changes\n-    const currentKey = issues.map(i =\u003e i.id).sort().join(\",\")\n+    const currentKey = currentIssues.map(i =\u003e i.id).sort().join(\",\")\n     \n     // Skip if already computed for this set of issues\n     if (labelsDataCacheKey === currentKey) return\n     \n     // Defer heavy computation to avoid blocking initial render\n     const timeout = setTimeout(() =\u003e {\n-      // Double-check key hasn't changed during deferral\n-      const checkKey = issues.map(i =\u003e i.id).sort().join(\",\")\n-      if (checkKey !== currentKey) return\n-      \n     const byId = new Map\u003cstring, string[]\u003e()\n     const groupsById = new Map\u003cstring, Record\u003cstring, string[]\u003e\u003e()\n       \n-    for (const issue of issues) {\n+    for (const issue of currentIssues) {\n         try {\n       // Use deriveEffectiveLabels to get proper NIP-32 labels\n           // Only get value once - don't subscribe to avoid memory leaks\n@@ -161,16 +160,20 @@\n   // NIP-32 labels are derived centrally via deriveEffectiveLabels(); proactively load 1985 for all issues\n   // Defer to avoid blocking initial render\n   $effect(() =\u003e {\n+    // Access reactive dependencies synchronously to ensure they're tracked\n+    const currentIssues = repoClass.issues || []\n+    const currentRepoRelays = repoRelays\n+    \n     // Defer label loading to avoid blocking initial render\n     const controller = new AbortController()\n     abortControllers.push(controller)\n     \n     const timeout = setTimeout(() =\u003e {\n       try {\n-        const ids = (repoClass.issues || []).map((i: any) =\u003e i.id).filter(Boolean)\n+        const ids = currentIssues.map((i: any) =\u003e i.id).filter(Boolean)\n         if (ids.length) {\n           request({\n-            relays: repoRelays,\n+            relays: currentRepoRelays,\n             signal: controller.signal,\n             filters: [{kinds: [1985], \"#e\": ids}],\n             onEvent: () =\u003e {},\n@@ -193,31 +196,38 @@\n   let statusMapCacheKey = $state\u003cstring\u003e(\"\")\n \n   $effect(() =\u003e {\n+    // Access reactive dependencies synchronously to ensure they're tracked\n+    if (!repoClass) return\n+    \n+    const currentIssues = repoClass.issues\n+    const currentStatusEventsByRoot = statusEventsByRoot\n+    const currentStatusMapCacheKey = statusMapCacheKey\n+\n     const timeout = setTimeout(() =\u003e {\n-      if (!repoClass || !repoClass.issues) {\n+      if (!currentIssues) {\n         statusMap = {}\n         return\n       }\n \n       // Create cache key from issue IDs and statusEventsByRoot to detect changes\n-      const issueIds = repoClass.issues.map(i =\u003e i.id).sort().join(\",\")\n-      const statusEventIds = statusEventsByRoot \n-        ? Array.from(statusEventsByRoot.keys()).sort().join(\",\")\n+      const issueIds = currentIssues.map(i =\u003e i.id).sort().join(\",\")\n+      const statusEventIds = currentStatusEventsByRoot \n+        ? Array.from(currentStatusEventsByRoot.keys()).sort().join(\",\")\n         : \"\"\n       const currentKey = `${issueIds}|${statusEventIds}`\n \n-      if (statusMapCacheKey === currentKey) return\n+      if (currentStatusMapCacheKey === currentKey) return\n \n       const map: Record\u003cstring, string\u003e = {}\n \n       // First, set default \"open\" status for all issues\n-      for (const issue of repoClass.issues) {\n+      for (const issue of currentIssues) {\n         map[issue.id] = \"open\"\n       }\n \n       // Then override with actual status events\n-      if (statusEventsByRoot) {\n-        for (const [rootId, events] of statusEventsByRoot) {\n+      if (currentStatusEventsByRoot) {\n+        for (const [rootId, events] of currentStatusEventsByRoot) {\n           const statusResult = repoClass.resolveStatusFor(rootId)\n           map[rootId] = statusResult?.state || \"open\"\n         }\n@@ -225,7 +235,7 @@\n \n       statusMap = map\n       statusMapCacheKey = currentKey\n-    })\n+    }, 100)\n \n     return () =\u003e {\n       clearTimeout(timeout)\n@@ -237,26 +247,34 @@\n   let issueListCacheKey = $state\u003cstring\u003e(\"\")\n \n   $effect(() =\u003e {\n+    // Access reactive dependencies synchronously to ensure they're tracked\n+    if (!repoClass) return\n+    \n+    const currentIssues = repoClass.issues\n+    const currentComments = comments\n+    const currentStatusMap = statusMap\n+    const currentIssueListCacheKey = issueListCacheKey\n+\n     const timeout = setTimeout(() =\u003e {\n-      if (!repoClass || !repoClass.issues) {\n+      if (!currentIssues) {\n         issueList = []\n         return\n       }\n \n       // Create cache key from issues, comments, and statusMap to detect changes\n-      const issueIds = repoClass.issues.map(i =\u003e i.id).sort().join(\",\")\n-      const commentIds = Object.keys(comments)\n-        .flatMap(id =\u003e comments[id].map(c =\u003e c.id))\n+      const issueIds = currentIssues.map(i =\u003e i.id).sort().join(\",\")\n+      const commentIds = Object.keys(currentComments)\n+        .flatMap(id =\u003e currentComments[id].map(c =\u003e c.id))\n         .sort()\n         .join(\",\")\n-      const statusMapKeys = Object.keys(statusMap).sort().join(\",\")\n+      const statusMapKeys = Object.keys(currentStatusMap).sort().join(\",\")\n       const currentKey = `${issueIds}|${commentIds}|${statusMapKeys}`\n \n-      if (issueListCacheKey === currentKey) return\n+      if (currentIssueListCacheKey === currentKey) return\n \n-      const processed = repoClass.issues.map((issue: IssueEvent) =\u003e {\n-        const commentEvents = comments[issue.id] || []\n-        const currentState = statusMap[issue.id] || \"open\"\n+      const processed = currentIssues.map((issue: IssueEvent) =\u003e {\n+        const commentEvents = currentComments[issue.id] || []\n+        const currentState = currentStatusMap[issue.id] || \"open\"\n \n         return {\n           ...issue,\n@@ -281,32 +299,44 @@\n   let searchedIssuesCacheKey = $state\u003cstring\u003e(\"\")\n \n   $effect(() =\u003e {\n+    // Access all reactive dependencies synchronously to ensure they're tracked\n+    const currentIssueList = issueList\n+    const currentSearchTerm = searchTerm\n+    const currentStatusFilter = statusFilter\n+    const currentAuthorFilter = authorFilter\n+    const currentSelectedLabels = selectedLabels\n+    const currentMatchAllLabels = matchAllLabels\n+    const currentSortByOrder = sortByOrder\n+    const currentLabelsByIssue = labelsByIssue\n+    const currentStatusMap = statusMap\n+    const currentCacheKey = searchedIssuesCacheKey\n+\n     const timeout = setTimeout(() =\u003e {\n-      if (!issueList || issueList.length === 0) {\n+      if (!currentIssueList || currentIssueList.length === 0) {\n         searchedIssues = []\n         return\n       }\n \n       // Create cache key from issueList, searchTerm, filters, and sort options\n-      const issueIds = issueList.map(i =\u003e i.id).sort().join(\",\")\n-      const labelsKey = Array.from(labelsByIssue.values())\n+      const issueIds = currentIssueList.map(i =\u003e i.id).sort().join(\",\")\n+      const labelsKey = Array.from(currentLabelsByIssue.values())\n         .flat()\n         .sort()\n         .join(\",\")\n       const currentKey = [\n         issueIds,\n-        searchTerm,\n-        statusFilter,\n-        authorFilter,\n-        selectedLabels.sort().join(\",\"),\n-        matchAllLabels.toString(),\n-        sortByOrder,\n+        currentSearchTerm,\n+        currentStatusFilter,\n+        currentAuthorFilter,\n+        [...currentSelectedLabels].sort().join(\",\"),\n+        currentMatchAllLabels.toString(),\n+        currentSortByOrder,\n         labelsKey,\n       ].join(\"|\")\n \n-      if (searchedIssuesCacheKey === currentKey) return\n+      if (currentCacheKey === currentKey) return\n \n-      const issuesToSearch = issueList.map(issue =\u003e {\n+      const issuesToSearch = currentIssueList.map(issue =\u003e {\n         return {\n           id: issue.id,\n           subject: getTagValue(\"subject\", issue.tags) ?? \"\",\n@@ -332,33 +362,33 @@\n           return item.subject\n         },\n       })\n-      const searchResults = issueSearch.searchOptions(searchTerm)\n-      const result = issueList\n+      const searchResults = issueSearch.searchOptions(currentSearchTerm)\n+      const result = currentIssueList\n         .filter(r =\u003e searchResults.find(res =\u003e res.id === r.id))\n         .filter(issue =\u003e {\n-          if (authorFilter) {\n-            return issue.pubkey === authorFilter\n+          if (currentAuthorFilter) {\n+            return issue.pubkey === currentAuthorFilter\n           }\n           return true\n         })\n         .filter(issue =\u003e {\n-          if (selectedLabels.length === 0) return true\n-          const labs = labelsByIssue.get(issue.id) || []\n-          return matchAllLabels\n-            ? selectedLabels.every(l =\u003e labs.includes(l))\n-            : selectedLabels.some(l =\u003e labs.includes(l))\n+          if (currentSelectedLabels.length === 0) return true\n+          const labs = currentLabelsByIssue.get(issue.id) || []\n+          return currentMatchAllLabels\n+            ? currentSelectedLabels.every(l =\u003e labs.includes(l))\n+            : currentSelectedLabels.some(l =\u003e labs.includes(l))\n         })\n         .filter(issue =\u003e {\n-          if (statusFilter === \"all\") return true\n-          const state = statusMap[issue.id] || \"open\"\n-          if (statusFilter === \"open\") return state === \"open\"\n-          if (statusFilter === \"draft\") return state === \"draft\"\n-          if (statusFilter === \"closed\") return state === \"closed\"\n-          if (statusFilter === \"resolved\") return state === \"resolved\"\n+          if (currentStatusFilter === \"all\") return true\n+          const state = currentStatusMap[issue.id] || \"open\"\n+          if (currentStatusFilter === \"open\") return state === \"open\"\n+          if (currentStatusFilter === \"draft\") return state === \"draft\"\n+          if (currentStatusFilter === \"closed\") return state === \"closed\"\n+          if (currentStatusFilter === \"resolved\") return state === \"resolved\"\n           return true\n         })\n         .sort((a, b) =\u003e\n-          sortByOrder === \"newest\" ? b.created_at - a.created_at : a.created_at - b.created_at,\n+          currentSortByOrder === \"newest\" ? b.created_at - a.created_at : a.created_at - b.created_at,\n         )\n \n       searchedIssues = result\n@@ -376,29 +406,51 @@\n   })\n \n   $effect(() =\u003e {\n+    // Access reactive dependencies synchronously to ensure they're tracked\n+    const currentIssues = issues\n+    const currentRepoRelays = repoRelays\n+    const currentComments = comments\n+    \n+    // Create abort controller for this effect run BEFORE the timeout\n+    // to ensure it can be properly cleaned up if the effect re-runs\n+    const controller = new AbortController()\n+    abortControllers.push(controller)\n+    \n     // Defer comment loading to avoid blocking initial render\n-    requestAnimationFrame(() =\u003e {\n-    for (const issue of issues) {\n-      if (!comments[issue.id]) {\n-        comments[issue.id] = []\n-        requestComments(issue)\n+    const timeout = setTimeout(() =\u003e {\n+      for (const issue of currentIssues) {\n+        // Check synchronously using captured comments state to avoid race conditions\n+        // Only request if comments haven't been loaded yet (key doesn't exist in comments)\n+        if (!(issue.id in currentComments)) {\n+          // Initialize empty array immediately to prevent duplicate requests\n+          comments[issue.id] = []\n+          requestComments(issue, currentRepoRelays, controller)\n+        }\n       }\n+    }, 100)\n+    \n+    // Cleanup: cancel timeout and abort controller when effect re-runs\n+    return () =\u003e {\n+      clearTimeout(timeout)\n+      controller.abort()\n     }\n-    })\n   })\n \n-  const requestComments = async (issue: TrustedEvent) =\u003e {\n-    const controller = new AbortController()\n-    abortControllers.push(controller)\n-    \n+  const requestComments = async (\n+    issue: TrustedEvent,\n+    relays: string[],\n+    controller: AbortController,\n+  ) =\u003e {\n     request({\n-      relays: repoRelays,\n+      relays,\n       signal: controller.signal,\n       filters: [{kinds: [COMMENT], \"#E\": [issue.id], since: issue.created_at}],\n       onEvent: e =\u003e {\n-        if (!comments[issue.id].some(c =\u003e c.id === e.id)) {\n+        // Access comments reactively - this will get the current value\n+        const currentComments = comments[issue.id] || []\n+        if (!currentComments.some(c =\u003e c.id === e.id)) {\n           // Create a new array to trigger reactivity\n-          comments[issue.id] = [...comments[issue.id], e as CommentEvent]\n+          comments[issue.id] = [...currentComments, e as CommentEvent]\n         }\n       },\n     })\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex cf1c08d..c63fead 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -65,19 +65,24 @@\n   $effect(() =\u003e {\n     if (!repoClass) return\n \n+    // Access reactive dependencies synchronously to ensure they're tracked\n+    const currentPatches = repoClass.patches\n+    const currentPullRequests = pullRequests\n+    const currentRepoRelays = repoRelays\n+\n     const controller = new AbortController()\n     abortControllers.push(controller)\n \n     // Defer comment loading to avoid blocking initial render\n     const timeout = setTimeout(() =\u003e {\n       const allRootIds = [\n-        ...repoClass.patches.map((p: PatchEvent) =\u003e p.id),\n-        ...pullRequests.map((pr: PullRequestEvent) =\u003e pr.id),\n+        ...currentPatches.map((p: PatchEvent) =\u003e p.id),\n+        ...currentPullRequests.map((pr: PullRequestEvent) =\u003e pr.id),\n       ]\n \n       if (allRootIds.length \u003e 0) {\n         request({\n-          relays: repoRelays,\n+          relays: currentRepoRelays,\n           signal: controller.signal,\n           filters: [{kinds: [COMMENT], \"#E\": allRootIds}],\n           onEvent: e =\u003e {\n@@ -147,8 +152,11 @@\n   $effect(() =\u003e {\n     if (!repoClass) return\n \n+    // Access reactive dependency synchronously to ensure it's tracked\n+    const currentPatches = repoClass.patches\n+\n     // Create cache key from patch IDs to detect changes\n-    const currentKey = repoClass.patches\n+    const currentKey = currentPatches\n       .map(p =\u003e p.id)\n       .sort()\n       .join(\",\")\n@@ -158,18 +166,10 @@\n \n     // Defer heavy computation to avoid blocking initial render\n     const timeout = setTimeout(() =\u003e {\n-      // Double-check key hasn't changed during deferral\n-      if (!repoClass) return\n-      const checkKey = repoClass.patches\n-        .map(p =\u003e p.id)\n-        .sort()\n-        .join(\",\")\n-      if (checkKey !== currentKey) return\n-\n       const byId = new Map\u003cstring, string[]\u003e()\n       const groupsById = new Map\u003cstring, Record\u003cstring, string[]\u003e\u003e()\n \n-      for (const patch of repoClass.patches) {\n+      for (const patch of currentPatches) {\n         try {\n           // Use deriveEffectiveLabels to get proper NIP-32 labels\n           // Only get value once - don't subscribe to avoid memory leaks\n@@ -276,38 +276,50 @@\n   let patchListCacheKey = $state\u003cstring\u003e(\"\")\n \n   $effect(() =\u003e {\n+    // Access all reactive dependencies synchronously to ensure they're tracked\n+    if (!repoClass) return\n+    \n+    const currentPatches = repoClass.patches\n+    const currentComments = comments\n+    const currentStatusData = statusData\n+    const currentPullRequests = pullRequests\n+    const currentStatusFilter = statusFilter\n+    const currentAuthorFilter = authorFilter\n+    const currentSortBy = sortBy\n+    const currentPatchListCacheKey = patchListCacheKey\n+\n     const timeout = setTimeout(() =\u003e {\n-      if (!repoClass || !repoClass.patches) {\n+      if (!currentPatches || currentPatches.length === 0) {\n         patchList = []\n         return\n       }\n \n       // Create cache key from patch IDs, comments, status, filters, and sort to detect changes\n       const currentKey = [\n-        repoClass.patches\n+        currentPatches\n           .map(p =\u003e p.id)\n           .sort()\n           .join(\",\"),\n-        comments\n+        currentComments\n           .map(c =\u003e c.id)\n           .sort()\n           .join(\",\"),\n-        statusData.stateById ? Object.keys(statusData.stateById).sort().join(\",\") : \"\",\n-        pullRequests\n+        currentStatusData.stateById ? Object.keys(currentStatusData.stateById).sort().join(\",\") : \"\",\n+        currentPullRequests\n           .map(pr =\u003e pr.id)\n           .sort()\n           .join(\",\"),\n-        statusFilter,\n-        authorFilter,\n-        sortBy,\n+        currentStatusFilter,\n+        currentAuthorFilter,\n+        currentSortBy,\n       ].join(\"|\")\n \n-      if (patchListCacheKey === currentKey) return\n+      if (currentPatchListCacheKey === currentKey) return\n \n       // Pre-build indexes for O(1) lookups instead of O(n) filtering per patch\n       // Map of root ID -\u003e child patches\n       const childPatchesByRoot = new Map\u003cstring, PatchEvent[]\u003e()\n-      for (const patch of repoClass.patches) {\n+      for (const patch of currentPatches) {\n         const rootTag = getTags(patch, \"e\").find((tag: string[]) =\u003e tag[1])\n         if (rootTag \u0026\u0026 rootTag[1]) {\n           const rootId = rootTag[1]\n@@ -320,7 +332,7 @@\n \n       // Map of patch ID -\u003e comments (reuse for PRs too)\n       const commentsByPatch = new Map\u003cstring, CommentEvent[]\u003e()\n-      for (const comment of comments) {\n+      for (const comment of currentComments) {\n         const patchTag = getTags(comment, \"E\").find((tag: string[]) =\u003e tag[1])\n         if (patchTag \u0026\u0026 patchTag[1]) {\n           const patchId = patchTag[1]\n@@ -332,7 +344,7 @@\n       }\n \n       // Get all root patches first\n-      const rootPatches = repoClass.patches.filter((patch: PatchEvent) =\u003e {\n+      const rootPatches = currentPatches.filter((patch: PatchEvent) =\u003e {\n         return getTags(patch, \"t\").find((tag: string[]) =\u003e tag[1] === \"root\")\n       })\n \n@@ -340,7 +352,7 @@\n       const processed: any[] = []\n       for (const patch of rootPatches) {\n         // Use manager-provided state and derive kind for UI\n-        const status = {kind: kindFromState((statusData.stateById as any)[patch.id])} as any\n+        const status = {kind: kindFromState((currentStatusData.stateById as any)[patch.id])} as any\n \n         // O(1) lookup instead of O(n) filter\n         const patches = childPatchesByRoot.get(patch.id) || []\n@@ -368,12 +380,12 @@\n         commentsByPatch: Map\u003cstring, CommentEvent[]\u003e,\n       ) =\u003e {\n         // Merge in PR roots\n-        const prEvents = pullRequests || []\n+        const prEvents = currentPullRequests || []\n         const prItems = prEvents.map((pr: PullRequestEvent) =\u003e {\n           const parsedPR: any = parsePullRequestEvent(pr)\n           // O(1) lookup instead of O(c) filter\n           const commentEvents = commentsByPatch.get(pr.id) || []\n-          const status = {kind: kindFromState((statusData.stateById as any)[pr.id])} as any\n+          const status = {kind: kindFromState((currentStatusData.stateById as any)[pr.id])} as any\n           return {\n             ...pr,\n             type: \"pr\" as const,\n@@ -397,36 +409,36 @@\n         let filteredPatches = [...allPatches, ...(prItems as any[])]\n \n         // Apply status filter\n-        if (statusFilter !== \"all\") {\n+        if (currentStatusFilter !== \"all\") {\n           filteredPatches = filteredPatches.filter(patch =\u003e {\n             const state = currentPatchStateFor(patch.id)\n-            if (statusFilter === \"open\") return state === \"open\"\n-            if (statusFilter === \"applied\") return state === \"applied\"\n-            if (statusFilter === \"closed\") return state === \"closed\"\n-            if (statusFilter === \"draft\") return state === \"draft\"\n+            if (currentStatusFilter === \"open\") return state === \"open\"\n+            if (currentStatusFilter === \"applied\") return state === \"applied\"\n+            if (currentStatusFilter === \"closed\") return state === \"closed\"\n+            if (currentStatusFilter === \"draft\") return state === \"draft\"\n             return true\n           })\n         }\n \n         // Apply author filter\n-        if (authorFilter) {\n-          filteredPatches = filteredPatches.filter(patch =\u003e patch.pubkey === authorFilter)\n+        if (currentAuthorFilter) {\n+          filteredPatches = filteredPatches.filter(patch =\u003e patch.pubkey === currentAuthorFilter)\n         }\n \n         // Apply sorting\n         const sortedPatches = [...filteredPatches]\n-        if (sortBy === \"newest\") {\n+        if (currentSortBy === \"newest\") {\n           sortedPatches.sort((a, b) =\u003e b.created_at - a.created_at)\n-        } else if (sortBy === \"oldest\") {\n+        } else if (currentSortBy === \"oldest\") {\n           sortedPatches.sort((a, b) =\u003e a.created_at - b.created_at)\n-        } else if (sortBy === \"status\") {\n+        } else if (currentSortBy === \"status\") {\n           // Sort by current state priority using Status.svelte semantics\n           const prio = (id: string) =\u003e {\n             const s = currentPatchStateFor(id)\n             return s === \"open\" ? 0 : s === \"draft\" ? 1 : s === \"applied\" ? 2 : 3\n           }\n           sortedPatches.sort((a, b) =\u003e prio(a.id) - prio(b.id))\n-        } else if (sortBy === \"commits\") {\n+        } else if (currentSortBy === \"commits\") {\n           // Sort by commit count (highest first)\n           sortedPatches.sort((a, b) =\u003e b.commitCount - a.commitCount)\n         }\n@@ -459,24 +471,33 @@\n \n   // Initialize feed asynchronously - don't block render\n   $effect(() =\u003e {\n+    // Access reactive dependencies synchronously to ensure they're tracked\n+    const currentRepoClass = repoClass\n+    const currentPatchFilter = patchFilter\n+    const currentPullRequestFilter = pullRequestFilter\n+    const currentRepoRelays = repoRelays\n+    const currentPatchList = patchList\n+    const currentElement = element\n+    const currentFeedInitialized = feedInitialized\n+\n     // Defer makeFeed to avoid blocking initial render\n     const timeout = setTimeout(() =\u003e {\n-      if (repoClass \u0026\u0026 repoClass.patches \u0026\u0026 patchFilter \u0026\u0026 pullRequestFilter \u0026\u0026 !feedInitialized) {\n-        const tryStart = () =\u003e {\n-          if (element \u0026\u0026 !feedInitialized) {\n+      if (currentRepoClass \u0026\u0026 currentRepoClass.patches \u0026\u0026 currentPatchFilter \u0026\u0026 currentPullRequestFilter \u0026\u0026 !currentFeedInitialized) {\n+        const tryStart = () =\u003e {          \n+          if (currentElement \u0026\u0026 !currentFeedInitialized) {\n             feedInitialized = true\n             const feed = makeFeed({\n-              element,\n-              relays: repoRelays,\n-              feedFilters: [patchFilter, pullRequestFilter],\n-              subscriptionFilters: [patchFilter, pullRequestFilter],\n-              initialEvents: patchList,\n+              element: currentElement,\n+              relays: currentRepoRelays,\n+              feedFilters: [currentPatchFilter, currentPullRequestFilter],\n+              subscriptionFilters: [currentPatchFilter, currentPullRequestFilter],\n+              initialEvents: currentPatchList,\n               onExhausted: () =\u003e {\n                 // Feed exhausted, but we already showed content\n               },\n             })\n             feedCleanup = feed.cleanup\n-          } else if (!element) {\n+          } else if (!currentElement) {\n             requestAnimationFrame(tryStart)\n           }\n         }\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-cgcz1xq1","title":"Sharing of git-related items","description":"Sharing mechanism is just a copy nostr entity btn which user can paste into a chat room, thread or event etc","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["enhancement","issue"]}
{"id":"flotilla-ch4xij9n","title":"From 00111b3bd1e35c6050b144eec7721685c6553bfe Mon Sep 17 00:00:00 2001","description":"From 00111b3bd1e35c6050b144eec7721685c6553bfe Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Tue, 27 May 2025 17:18:30 -0700\nSubject: [PATCH 5/67] Unnest nip29 commands\n\n---\n src/app/commands.ts                           | 41 +++++++++++++++++++++--------------------\n src/app/components/RoomCreate.svelte          | 12 +++++++-----\n src/routes/+layout.svelte                     |  7 ++++++-\n src/routes/spaces/[relay]/+layout.svelte      |  6 +-----\n src/routes/spaces/[relay]/[room]/+page.svelte | 30 +++++++++++++-----------------\n 5 files changed, 48 insertions(+), 48 deletions(-)\n\ndiff --git a/src/app/commands.ts b/src/app/commands.ts\nindex 9d46683..53dfae7 100644\n--- a/src/app/commands.ts\n+++ b/src/app/commands.ts\n@@ -145,29 +145,30 @@ export const broadcastUserData = async (relays: string[]) =\u003e {\n \n // NIP 29 stuff\n \n-export const nip29 = {\n-  createRoom: (url: string, room: string) =\u003e {\n-    const event = createEvent(GROUP_CREATE, {tags: [tagRoom(room, url)]})\n-\n-    return publishThunk({event, relays: [url]})\n-  },\n-  editMeta: (url: string, room: string, meta: Record\u003cstring, string\u003e) =\u003e {\n-    const event = createEvent(GROUP_EDIT_META, {\n-      tags: [tagRoom(room, url), ...Object.entries(meta)],\n-    })\n+export const createRoom = (url: string, room: string) =\u003e {\n+  const event = createEvent(GROUP_CREATE, {tags: [tagRoom(room, url)]})\n+\n+  return publishThunk({event, relays: [url]})\n+}\n+\n+export const editRoom = (url: string, room: string, meta: Record\u003cstring, string\u003e) =\u003e {\n+  const event = createEvent(GROUP_EDIT_META, {\n+    tags: [tagRoom(room, url), ...Object.entries(meta)],\n+  })\n \n-    return publishThunk({event, relays: [url]})\n-  },\n-  joinRoom: (url: string, room: string) =\u003e {\n-    const event = createEvent(GROUP_JOIN, {tags: [tagRoom(room, url)]})\n+  return publishThunk({event, relays: [url]})\n+}\n+\n+export const joinRoom = (url: string, room: string) =\u003e {\n+  const event = createEvent(GROUP_JOIN, {tags: [tagRoom(room, url)]})\n+\n+  return publishThunk({event, relays: [url]})\n+}\n \n-    return publishThunk({event, relays: [url]})\n-  },\n-  leaveRoom: (url: string, room: string) =\u003e {\n-    const event = createEvent(GROUP_LEAVE, {tags: [tagRoom(room, url)]})\n+export const leaveRoom = (url: string, room: string) =\u003e {\n+  const event = createEvent(GROUP_LEAVE, {tags: [tagRoom(room, url)]})\n \n-    return publishThunk({event, relays: [url]})\n-  },\n+  return publishThunk({event, relays: [url]})\n }\n \n // List updates\ndiff --git a/src/app/components/RoomCreate.svelte b/src/app/components/RoomCreate.svelte\nindex 724acca..e5c71d7 100644\n--- a/src/app/components/RoomCreate.svelte\n+++ b/src/app/components/RoomCreate.svelte\n@@ -10,8 +10,8 @@\n   import Icon from \"@lib/components/Icon.svelte\"\n   import ModalHeader from \"@lib/components/ModalHeader.svelte\"\n   import ModalFooter from \"@lib/components/ModalFooter.svelte\"\n-  import {hasNip29} from \"@app/state\"\n-  import {addRoomMembership, nip29, getThunkError} from \"@app/commands\"\n+  import {hasNip29, loadChannel} from \"@app/state\"\n+  import {addRoomMembership, createRoom, editRoom, joinRoom, getThunkError} from \"@app/commands\"\n   import {makeSpacePath} from \"@app/routes\"\n   import {pushToast} from \"@app/toast\"\n \n@@ -23,24 +23,26 @@\n   const back = () =\u003e history.back()\n \n   const tryCreate = async () =\u003e {\n-    const createMessage = await getThunkError(nip29.createRoom(url, room))\n+    const createMessage = await getThunkError(createRoom(url, room))\n \n     if (createMessage \u0026\u0026 !createMessage.match(/^duplicate:|already a member/)) {\n       return pushToast({theme: \"error\", message: createMessage})\n     }\n \n-    const editMessage = await getThunkError(nip29.editMeta(url, room, {name}))\n+    const editMessage = await getThunkError(editRoom(url, room, {name}))\n \n     if (editMessage) {\n       return pushToast({theme: \"error\", message: editMessage})\n     }\n \n-    const joinMessage = await getThunkError(nip29.joinRoom(url, room))\n+    const joinMessage = await getThunkError(joinRoom(url, room))\n \n     if (joinMessage \u0026\u0026 !joinMessage.includes(\"already\")) {\n       return pushToast({theme: \"error\", message: joinMessage})\n     }\n \n+    await loadChannel(url, room)\n+\n     addRoomMembership(url, room, name)\n     goto(makeSpacePath(url, room))\n   }\ndiff --git a/src/routes/+layout.svelte b/src/routes/+layout.svelte\nindex 1d87079..c9b8676 100644\n--- a/src/routes/+layout.svelte\n+++ b/src/routes/+layout.svelte\n@@ -17,6 +17,7 @@\n     MESSAGE,\n     INBOX_RELAYS,\n     DIRECT_MESSAGE,\n+    GROUP_META,\n     MUTES,\n     FOLLOWS,\n     PROFILE,\n@@ -173,7 +174,11 @@\n           limit: 10_000,\n           repository,\n           rankEvent: (e: TrustedEvent) =\u003e {\n-            if ([PROFILE, FOLLOWS, MUTES, RELAYS, BLOSSOM_SERVERS, INBOX_RELAYS].includes(e.kind)) {\n+            if (\n+              [PROFILE, FOLLOWS, MUTES, RELAYS, BLOSSOM_SERVERS, INBOX_RELAYS, GROUP_META].includes(\n+                e.kind,\n+              )\n+            ) {\n               return 1\n             }\n \ndiff --git a/src/routes/spaces/[relay]/+layout.svelte b/src/routes/spaces/[relay]/+layout.svelte\nindex 0156ec0..892a446 100644\n--- a/src/routes/spaces/[relay]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/+layout.svelte\n@@ -2,8 +2,7 @@\n   import {onMount} from \"svelte\"\n   import {page} from \"$app/stores\"\n   import {ago, WEEK} from \"@welshman/lib\"\n-  import {GROUP_META, EVENT_TIME, GROUPS, THREAD, COMMENT, MESSAGE} from \"@welshman/util\"\n-  import {request} from \"@welshman/net\"\n+  import {GROUP_META, EVENT_TIME, THREAD, COMMENT, MESSAGE} from \"@welshman/util\"\n   import Page from \"@lib/components/Page.svelte\"\n   import SecondaryNav from \"@lib/components/SecondaryNav.svelte\"\n   import MenuSpace from \"@app/components/MenuSpace.svelte\"\n@@ -76,9 +75,6 @@\n       ],\n     })\n \n-    // Completely refresh our groups list and listen for new ones\n-    request({relays, filters: [{kinds: [GROUPS]}], signal: controller.signal})\n-\n     return () =\u003e {\n       controller.abort()\n     }\ndiff --git a/src/routes/spaces/[relay]/[room]/+page.svelte b/src/routes/spaces/[relay]/[room]/+page.svelte\nindex 4bb149c..439ed2d 100644\n--- a/src/routes/spaces/[relay]/[room]/+page.svelte\n+++ b/src/routes/spaces/[relay]/[room]/+page.svelte\n@@ -30,13 +30,14 @@\n   } from \"@app/state\"\n   import {setChecked, checked} from \"@app/notifications\"\n   import {\n-    nip29,\n+    joinRoom,\n+    leaveRoom,\n     addRoomMembership,\n     removeRoomMembership,\n     prependParent,\n     getThunkError,\n   } from \"@app/commands\"\n-  import {PROTECTED, hasNip29} from \"@app/state\"\n+  import {PROTECTED} from \"@app/state\"\n   import {makeFeed} from \"@app/requests\"\n   import {popKey} from \"@app/implicit\"\n   import {pushToast} from \"@app/toast\"\n@@ -49,27 +50,22 @@\n   const filter = {kinds: [MESSAGE, GIT_REPO], \"#h\": [room]}\n   const relay = deriveRelay(url)\n \n-  const joinRoom = async () =\u003e {\n-    if (hasNip29($relay)) {\n-      joiningRoom = true\n+  const join = async () =\u003e {\n+    joiningRoom = true\n \n-      const message = await getThunkError(nip29.joinRoom(url, room))\n+    const message = await getThunkError(joinRoom(url, room))\n \n-      joiningRoom = false\n+    joiningRoom = false\n \n-      if (message \u0026\u0026 !message.includes(\"already\")) {\n-        return pushToast({theme: \"error\", message})\n-      }\n+    if (message \u0026\u0026 !message.includes(\"already\")) {\n+      return pushToast({theme: \"error\", message})\n     }\n \n     addRoomMembership(url, room, displayChannel(url, room))\n   }\n \n-  const leaveRoom = () =\u003e {\n-    if (hasNip29($relay)) {\n-      nip29.leaveRoom(url, room)\n-    }\n-\n+  const leave = () =\u003e {\n+    leaveRoom(url, room)\n     removeRoomMembership(url, room)\n   }\n \n@@ -256,12 +252,12 @@\n   {#snippet action()}\n     \u003cdiv class=\"row-2\"\u003e\n       {#if $userRoomsByUrl.get(url)?.has(room)}\n-        \u003cButton class=\"btn btn-neutral btn-sm\" onclick={leaveRoom}\u003e\n+        \u003cButton class=\"btn btn-neutral btn-sm\" onclick={leave}\u003e\n           \u003cIcon icon=\"arrows-a-logout-2\" /\u003e\n           Leave Room\n         \u003c/Button\u003e\n       {:else}\n-        \u003cButton class=\"btn btn-neutral btn-sm\" disabled={joiningRoom} onclick={joinRoom}\u003e\n+        \u003cButton class=\"btn btn-neutral btn-sm\" disabled={joiningRoom} onclick={join}\u003e\n           {#if joiningRoom}\n             \u003cspan class=\"loading loading-spinner loading-sm\"\u003e\u003c/span\u003e\n           {:else}\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-ckhnl4v0","title":"Patch merge analysis hanging","description":"- Mergeability status is pending too long\n- Until we get automatic analysis really reliable, we need to get back to manual analysis as before\n- Need spinner or sth for visible UI feeback when analysis is ongoing","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue"]}
{"id":"flotilla-cmw8um9w","title":"From fedb941b0696e3c1966b1642ebaba4b3c47331e2 Mon Sep 17 00:00:00 2001","description":"From fedb941b0696e3c1966b1642ebaba4b3c47331e2 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 17 Jun 2025 22:19:10 -0700\nSubject: [PATCH] feat: redesign repository overview with commits tab and enhanced UI\n\n---\n package.json                                                  |   2 ++\n packages/nostr-git                                            |   2 +-\n pnpm-lock.yaml                                                | Bin 489191 -\u003e 493808 bytes\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte       |   6 +++---\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte         | 509 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------------------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte | 175 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte |   2 +-\n 7 files changed, 558 insertions(+), 138 deletions(-)\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n\ndiff --git a/package.json b/package.json\nindex 914d04b..2c3ce67 100644\n--- a/package.json\n+++ b/package.json\n@@ -19,6 +19,7 @@\n     \"@sentry/cli\": \"^2.40.0\",\n     \"@sveltejs/kit\": \"^2.5.27\",\n     \"@sveltejs/vite-plugin-svelte\": \"^4.0.0\",\n+    \"@types/date-fns\": \"^2.6.3\",\n     \"@types/eslint\": \"^9.6.0\",\n     \"@types/markdown-it\": \"^14.1.2\",\n     \"@types/mustache\": \"^4.2.6\",\n@@ -74,6 +75,7 @@\n     \"@welshman/store\": \"^0.3.0\",\n     \"@welshman/util\": \"^0.3.0\",\n     \"daisyui\": \"^4.12.10\",\n+    \"date-fns\": \"^4.1.0\",\n     \"date-picker-svelte\": \"^2.13.0\",\n     \"dotenv\": \"^16.4.5\",\n     \"emoji-picker-element\": \"^1.22.8\",\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 7e69223..7de4657 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 7e692237ea99cdee33f895a360cb21f01bedd795\n+Subproject commit 7de4657fbc68b8b40b27d76ec1817d74ca2b0cef\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 98c9f2d7721d576eca6647bc5cc4d3bb6323f110..631349f86ab93a3c03b145720f5b6f247ca0e940 100644\nGIT binary patch\ndelta 3672\nzc$~#oTZr4}6~^g!rkys~gr\u003c{ZlT5T-(p;3WBunyT(uMK;BH5NLOS1j2RF-5*wl20V\nzw(Mm)1j\u003ef?Ww#hs\u003e|6U%=)x{3S#Y7H(3i4(=zAYZ\u003eAtjuZXw%;K9o`_du~bAvy@\u0026a\nzSQvB;|M|}O\u0026-uQiKm7UnlkaXnf-lUbiLXBfFBCU6MBbKmI{NIv%}Z;qhC`9rgWZck\nz|38F2?p)r!d\u0026wF}s_!8fqNFLNX_z~bsMyAg\u0026t5u%gk}`+l}ktn3n8~pJoX|XIE38s\nzK6)#-_4r%K*Wb8$Y=U^lHUvW(sFE%Den`v\u003c+zZ^^r}Ft^BWq}kg{QM%+)h\u003cW5MywW\nzMir}Jm`aw*a*gNW6hYM)I2~0By;\u003eK|s4idB\u003etjoWjJ#5dqa58xCrzm@8%!=m+1*!O\nzd3|#e0B-G_V1xYN8n26%A3PR9ZtePZ0GPci-PkA89NTm{`BHW2w#90ttdNsjHO+9a\nzVw+@ZJVaAMGwKdT@fKOj52yVkZP=0_B=dGDWi+EuO2J%tN}F|~Ad%f@*3CQocohbf\nz*SikiT^0a20x|oc1nlE|8eyW6R\u003e`q3Y~-du(@EMB++w;y8n\u0026f~IB^D(8k-AGdAcXp\nz)1@d%$}GXy\u003e{uDnQlvW8GDZTUQwkGH5L9;JXbG;m5`\u0026`K%NpQ^H83U1nEm#zSNAPc\nzM+wEsM@1JMS%#D=xmLTD=n@iEK}Ky;Cz2^ui^nMj?r^T=S}tzZ!c=Ei?G|h\u003eTq+fl\nz`L\u003cHT%}zlio1J95Tpn48RTwOZHwD\u003e8f%|nhf-\u00262CYkQy2IBAg1M0$)!M)a7FNDK\u003eu\nznnqH|7TzLsMaaaA90OTs)l9I3GzhaYnKh@3Bd|n1hr=iiCFx0D\u0026bVn3YG_e0Z_CPR\nz3^u\u003e)L_8EeDTMd\u0026{lK;TEIYKQp-piF%aW)_(e5NR\u0026Sas9R\u003e(N)G\u003ecFK%C?!V={5#M\nzhR#\u003cxt~JGqrMfY6YOdZNgJ^`T^IEEv3o8yErtBfySqWmKNMj!Z8vPWAW+RP~Vz)YQ\nzs}|mqE0tC_Ut{ZFt%t`e80`qrZkQoQEwHJ?q*PxK`ewg{7qgC$maQ;dN3?PQpVC\u0026j\nz*{z}F9FJ8Pv#l?\u003e^6}q3d`\u0026tlO{IgGF!Vjdd+?pW-TiUY=m{~YmmHemT86SXx7agF\nzSt|ietaK_{Na?X@rc#S*=5ShZ!n`II\u003eP?4C$M|lf(dxjdY$I*T#Bdx1Z7wD\u003eB9Stm\nzK1o|$hLn}Atoo0=hlIk%bGYb1uL1_H`Z\u003cVBAFGuibn38`XmJP+a%2%5PV|Axu$CMx\nzw3\u00269U7mI-o8%_-9gdXX0-7xQ\u003cO0f;XEhX9~\u003e|v)\u003c$k5%gP-}24PNSa(p_+bl%=_K_\nz!0qP1feECSDu{X\u00263G-Z;Pp}N$o+{C#h\u003eUTph-OmVM48f\u003eq+KN_IG^l=g$#rXMlv0V\nzl\u003cElVw(Ww$m{Ge6({kGy^\u003ciz9wFg0gt+$0\u003eaQ^L3Ko4BwO{J$p9Yq\u0026+1l6%@$=qq1\nz65scszz0xNSdPV-aw|I_#6}@o?$F#|(xdHkFP9\u0026;ASS99ZGk|9YBe3Rq@GnNi\u0026eYM\nzG9WT$%LtVmV=$#C`6Mz*;B=I\u0026cd7~%Uy$Ma2^8QTe(`|ut-S@?fAXu_`-Ft3\u003c8WC)\nzY-n6!4ALgD8eLA2##E\u003e$#mGo24YL#`*QO0U;?rK)jz`;6q5-\u003ej6A}\u003cSO\u003c`!C7\u003ezk(\nzBKRP25JP)xby@4hor==HlmtJfxC_)}#RB{v4_LO-2JFc|vVfK-`PEQt#n3~*p\u0026VJj\nzz%)jR=$jSW0*tY~bOugbt$ToF029LjL\u003c7(b8_*?51ngx1-5+XImBi3IJr7)QK7TZ4\nz-Z#`Wuvv`tK)nT~L{2M6*+Q\u003c7$+okUJy4pwkS(Qav7DMG(845NEtXO|TkGW9c)1Sd\nzU1c;vgg(hpqq5i\u003c\u003eSEi3qADw!9f%$+%Ip0aTfgr8@{fTV4`=tz%xCvLC;ug=8R8!1\nz4YtnQX^izWlAo|cpDYStP$F8OWFXAAD|c)vGI6r9lpGEvu+60mJK0Nx38bmpQn5hR\nzN)}3\u0026FcyMEGQ%NsDjY3w6g~m9vF4BR{K@v(qxCO8FVTK;d*|OdbBCcuC=M\u002680XLyU\nzt6qmD;R?wcx-3\u003cPiLr{qd9kAm_;7KAv|y}GQ+S_ZCT\u003e-)^@grg\u003cD%(Cr4hIAvWOsd\nzUQDWSrAbe{?`wgVfRmWJz^e\u003c{hnIH_00(Qsu6OQX;96kQ\u003cJI-8hwt57o4\u003cE6_|vnW\nzxeq+52e0q1l*?PYz=2\u003eM#`rXkFFkxFU*)ji*rk2Jvd0eUQv~Q+7i5HPZeBTcY4AP~\nzgD\u003es\u003eU%\u003e\u0026urBk*E4}O2`tNZ_\u003exX\u00267o`TNj*l6LZlTbCB\u003e_*l!HsM3x\u003c4!eNAF8Z%e\nz-$=X*AFN%E|J!+ZKl*t6;)|y*8(!k#`u6?*;DVL`uAI6_crSdgcH_Qw8qqK70\u003cS2*\nz@fNT=;PPqk7SUfk|9m;U-~4I)`s^Pcg5KZ7;Ffpp_Qs9*FVG+eLC;A1;wt@vUOQck\nzz3;uhcH?WOwcc~mxd3``mG6=2z4P*C\u003eD^-8@v(TmE?u6#D+IT{dG;xB@=x\u0026_;pz)V\nznsAUQJpai@!I$aHldlbr|M~j%vy|~PtsG2dEEHLFuSb);bc(H\u003e-hXMt_ZRJZcnZFf\nz1D5@Fc!|h=gC=|r!BBm=7Yuzg|2?)oe)6TI+${RRudC\u003cl0^oT+Ub{Gd\u003cL1WC*6yrO\nrh*Lh@ez3D~_xw}bzI^Syd2eIOgF_o%@Dz3ZoagiT#=LQN\u003c4y9PSs|Bh\n\ndelta 162\nzc%1t%QSSL$*$oDQ)2}Bp@ougYv|!\u0026P$*;A!(Ydy5`aCCAjmf)w\u003cu^|{r\u003c*!my_l7M\nz`y^AwV#evqidhA\u003e?=olfY~L\u003c(fRU%PeU~ZI_FbmT^FD2Vsll?8ZTihxHs1Eh1}xhr\nz8?f%--3~OULmzCw^v6Z4Gq(fv\u003e(@;OYUSRp@`;r@c)PC~Tm6UWK)s^df0(gfVgVbl\nKJ\u003c5iCnhyYL1wVKI\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 62bb304..e1ffa14 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -80,9 +80,9 @@\n           {/snippet}\n         \u003c/RepoTab\u003e\n         \u003cRepoTab\n-          tabValue=\"workbench\"\n-          label=\"Workbench\"\n-          href={`/spaces/${encodedRelay}/git/${id}/workbench`}\n+          tabValue=\"commits\"\n+          label=\"Commits\"\n+          href={`/spaces/${encodedRelay}/git/${id}/commits`}\n           {activeTab}\u003e\n           {#snippet icon()}\n             \u003cGitBranch class=\"h-4 w-4\" /\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 109772e..b08d99e 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -2,36 +2,75 @@\n   import {getContext} from \"svelte\"\n   import markdownit from \"markdown-it\"\n   import {Card, Repo} from \"@nostr-git/ui\"\n-  import {CircleAlert, GitBranch, GitPullRequest, Users} from \"@lucide/svelte\"\n+  import {\n+    CircleAlert,\n+    GitBranch,\n+    GitPullRequest,\n+    Users,\n+    Calendar,\n+    Globe,\n+    Hash,\n+    GitCommit,\n+    Clock,\n+    User,\n+    Link,\n+    Eye,\n+    BookOpen,\n+  } from \"@lucide/svelte\"\n   import {fly} from \"@lib/transition\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n-    import { pushToast } from \"@src/app/toast\"\n+  import {pushToast} from \"@src/app/toast\"\n+  import {formatDistanceToNow} from \"date-fns\"\n+  import {nthEq} from \"@welshman/lib\"\n \n   let loading = $state(true)\n+  let lastCommit = $state\u003cany\u003e(null)\n \n   const repoClass = getContext\u003cRepo\u003e(\"repoClass\")\n \n-  const stats = [\n+  const stats = $derived([\n     {\n       label: \"Branches\",\n-      value: () =\u003e repoClass.branches?.length,\n+      value: repoClass.branches?.length || 0,\n       icon: GitBranch,\n+      color: \"text-blue-600\",\n     },\n     {\n-      label: \"Contributors\",\n-      value: () =\u003e repoClass.maintainers?.length,\n+      label: \"Doers\",\n+      value: repoClass.maintainers?.length || 0,\n       icon: Users,\n+      color: \"text-green-600\",\n     },\n     {\n       label: \"Issues\",\n-      value: () =\u003e repoClass.issues?.length,\n-      icon: CircleAlert},\n+      value: repoClass.issues?.length || 0,\n+      icon: CircleAlert,\n+      color: \"text-red-600\",\n+    },\n     {\n       label: \"Patches\",\n-      value: () =\u003e repoClass.patches?.length,\n+      value: repoClass.patches?.length || 0,\n       icon: GitPullRequest,\n+      color: \"text-purple-600\",\n     },\n-  ]\n+  ])\n+\n+  const repoMetadata = $derived({\n+    name: repoClass.repo?.name || \"Unknown Repository\",\n+    description: repoClass.repo?.description || \"\",\n+    repoId: repoClass.repo?.repoId || \"\",\n+    maintainers: repoClass.maintainers || [],\n+    relays: repoClass.relays || [],\n+    cloneUrls: repoClass.repo?.clone || [],\n+    webUrls: repoClass.repo?.web || [],\n+    mainBranch: repoClass.mainBranch || \"main\",\n+    createdAt: repoClass.repoEvent?.created_at\n+      ? new Date(repoClass.repoEvent.created_at * 1000)\n+      : null,\n+    updatedAt: repoClass.repoStateEvent?.created_at\n+      ? new Date(repoClass.repoStateEvent.created_at * 1000)\n+      : null,\n+  })\n \n   let readme = $state\u003cstring | undefined\u003e(undefined)\n   let renderedReadme = $state\u003cstring | undefined\u003e(undefined)\n@@ -43,136 +82,340 @@\n \n   $effect(() =\u003e {\n     if (repoClass.repoEvent) {\n-      repoClass\n-        .getFileContent({\n-          path: \"README.md\",\n-        })\n-        .then(content =\u003e {\n-          readme = content\n-          renderedReadme = readme ? md.render(readme) : \"\"\n-          loading = false\n-        })\n-        .catch((e) =\u003e {\n-          console.error(e)\n-          pushToast({message: \"Failed to load README.md: \" + e, theme: \"error\"})\n-          loading = false\n-        })\n+      loadRepoInfo()\n     }\n   })\n+\n+  async function loadRepoInfo() {\n+    try {\n+      try {\n+        const readmeContent = await repoClass.getFileContent({path: \"README.md\"})\n+        readme = readmeContent\n+        renderedReadme = readme ? md.render(readme) : \"\"\n+      } catch (e) {\n+        console.log(\"No README.md found\")\n+      }\n+\n+      try {\n+        if (repoClass.mainBranch) {\n+          const commits = await repoClass.getCommitHistory({\n+            branch: repoClass.mainBranch,\n+            depth: 1,\n+          })\n+          if (commits \u0026\u0026 commits.length \u003e 0) {\n+            lastCommit = commits[0]\n+          }\n+        }\n+      } catch (e) {\n+        console.log(\"Could not fetch commit info:\", e)\n+      }\n+\n+      loading = false\n+    } catch (e) {\n+      console.error(\"Error loading repo info:\", e)\n+      pushToast({message: \"Failed to load repository information: \" + e, theme: \"error\"})\n+      loading = false\n+    }\n+  }\n+\n+  function formatDate(date: Date | null) {\n+    if (!date) return \"Unknown\"\n+    return formatDistanceToNow(date, {addSuffix: true})\n+  }\n+\n+  function truncateHash(hash: string, length = 8) {\n+    return hash ? hash.substring(0, length) : \"\"\n+  }\n \u003c/script\u003e\n \n-\u003cdiv class=\"relative flex flex-col gap-3 px-2\"\u003e\n-  \u003cdiv class=\"grid grid-cols-4 gap-4\"\u003e\n-    {#each stats as stat}\n-      \u003cCard class=\"p-4\"\u003e\n-        \u003cdiv class=\"flex items-center gap-2\"\u003e\n-          \u003cstat.icon class=\"h-5 text-muted-foreground\" /\u003e\n-          \u003cdiv\u003e\n-            \u003cp class=\"text-sm text-muted-foreground\"\u003e{stat.label}\u003c/p\u003e\n-            \u003cp class=\"text-2xl font-semibold\"\u003e{stat.value()}\u003c/p\u003e\n+\u003cdiv class=\"relative flex flex-col gap-6 py-2\"\u003e\n+  {#if loading}\n+    \u003cdiv class=\"flex justify-center py-8\"\u003e\n+      \u003cSpinner /\u003e\n+    \u003c/div\u003e\n+  {:else}\n+    \u003c!-- Stats Grid --\u003e\n+    \u003cdiv class=\"grid grid-cols-2 gap-4 md:grid-cols-4\"\u003e\n+      {#each stats as stat}\n+        \u003cCard class=\"p-4 transition-shadow hover:shadow-md\"\u003e\n+          \u003cdiv class=\"flex items-center gap-3\"\u003e\n+            \u003cdiv class=\"p-2\"\u003e\n+              \u003cstat.icon class=\"h-5 w-5 {stat.color}\" /\u003e\n+            \u003c/div\u003e\n+            \u003cdiv\u003e\n+              \u003cp class=\"text-sm text-muted-foreground\"\u003e{stat.label}\u003c/p\u003e\n+              \u003cp class=\"text-2xl font-semibold\"\u003e{stat.value}\u003c/p\u003e\n+            \u003c/div\u003e\n+          \u003c/div\u003e\n+        \u003c/Card\u003e\n+      {/each}\n+    \u003c/div\u003e\n+\n+    \u003cdiv class=\"grid gap-6 md:grid-cols-2\"\u003e\n+    \u003c!-- Repository Details --\u003e\n+    \u003cCard class=\"p-6\"\u003e\n+      \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+        \u003cGitCommit class=\"h-5 w-5\" /\u003e\n+        Repo Information\n+      \u003c/h3\u003e\n+      \u003cdiv class=\"grid gap-6 md:grid-cols-1\"\u003e\n+        \u003c!-- Git Information --\u003e\n+        \u003cdiv class=\"space-y-3\"\u003e\n+          \u003cdiv class=\"flex items-center justify-between\"\u003e\n+            \u003cspan class=\"text-sm text-muted-foreground\"\u003eDefault Branch\u003c/span\u003e\n+            \u003cspan class=\"rounded px-2 py-1 font-mono text-sm\"\u003e\n+              {repoMetadata.mainBranch}\n+            \u003c/span\u003e\n           \u003c/div\u003e\n+\n+          {#if lastCommit}\n+            \u003cdiv class=\"border-t pt-3\"\u003e\n+              \u003cdiv class=\"mb-2 flex items-start justify-between\"\u003e\n+                \u003cspan class=\"text-sm text-muted-foreground\"\u003eLatest Commit\u003c/span\u003e\n+                \u003cspan class=\"rounded px-2 py-1 font-mono text-xs\"\u003e\n+                  {truncateHash(lastCommit.oid)}\n+                \u003c/span\u003e\n+              \u003c/div\u003e\n+              \u003cp class=\"text-sm\"\u003e{lastCommit.commit.message}\u003c/p\u003e\n+              \u003cdiv class=\"mt-2 flex items-center gap-2 text-xs text-muted-foreground\"\u003e\n+                \u003cUser class=\"h-3 w-3\" /\u003e\n+                \u003cspan\u003e{lastCommit.commit.author.name}\u003c/span\u003e\n+                \u003cspan\u003e•\u003c/span\u003e\n+                \u003cspan\u003e{formatDate(new Date(lastCommit.commit.author.timestamp * 1000))}\u003c/span\u003e\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          {#if repoClass.branches \u0026\u0026 repoClass.branches.length \u003e 0}\n+            \u003cdiv class=\"border-t pt-3\"\u003e\n+              \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eBranches\u003c/span\u003e\n+              \u003cdiv class=\"flex flex-wrap gap-1\"\u003e\n+                {#each repoClass.branches.slice(0, 5) as branch}\n+                  \u003cspan\n+                    class=\"rounded-full bg-blue-100 px-2 py-1 text-xs text-blue-800 dark:bg-blue-900/30 dark:text-blue-200\"\u003e\n+                    {branch.name}\n+                    {#if branch.isHead}\n+                      \u003cspan class=\"ml-1\"\u003e•\u003c/span\u003e\n+                    {/if}\n+                  \u003c/span\u003e\n+                {/each}\n+                {#if repoClass.branches.length \u003e 5}\n+                  \u003cspan class=\"px-2 py-1 text-xs text-muted-foreground\"\u003e\n+                    +{repoClass.branches.length - 5} more\n+                  \u003c/span\u003e\n+                {/if}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+        \u003c/div\u003e\n+\n+        \u003c!-- Nostr Information --\u003e\n+        \u003cdiv class=\"space-y-3\"\u003e\n+          {#if repoMetadata.maintainers.length \u003e 0}\n+            \u003cdiv\u003e\n+              \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eMaintainers\u003c/span\u003e\n+              \u003cdiv class=\"space-y-1\"\u003e\n+                {#each repoMetadata.maintainers as maintainer}\n+                  \u003cdiv class=\"flex items-center gap-2 text-sm\"\u003e\n+                    \u003cUser class=\"h-3 w-3\" /\u003e\n+                    \u003cspan class=\"font-mono text-xs\"\u003e{truncateHash(maintainer, 16)}\u003c/span\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          {#if repoMetadata.relays.length \u003e 0}\n+            \u003cdiv class=\"border-t pt-3\"\u003e\n+              \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eRelays\u003c/span\u003e\n+              \u003cdiv class=\"space-y-1\"\u003e\n+                {#each repoMetadata.relays.slice(0, 3) as relay}\n+                  \u003cdiv class=\"flex items-center gap-2 text-sm\"\u003e\n+                    \u003cGlobe class=\"h-3 w-3\" /\u003e\n+                    \u003cspan class=\"truncate\"\u003e{relay}\u003c/span\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+                {#if repoMetadata.relays.length \u003e 3}\n+                  \u003cspan class=\"text-xs text-muted-foreground\"\u003e\n+                    +{repoMetadata.relays.length - 3} more relays\n+                  \u003c/span\u003e\n+                {/if}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          {#if repoMetadata.cloneUrls.length \u003e 0}\n+            \u003cdiv class=\"border-t pt-3\"\u003e\n+              \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eClone URLs\u003c/span\u003e\n+              \u003cdiv class=\"space-y-1\"\u003e\n+                {#each repoMetadata.cloneUrls as url}\n+                  \u003cdiv class=\"flex items-center gap-2 text-sm\"\u003e\n+                    \u003cLink class=\"h-3 w-3\" /\u003e\n+                    \u003cspan class=\"truncate font-mono text-xs\"\u003e{url}\u003c/span\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    \u003c/Card\u003e\n+\n+    \u003c!-- Activity Overview --\u003e\n+    {#if repoClass.issues.length \u003e 0 || repoClass.patches.length \u003e 0}\n+      \u003cCard class=\"p-6\"\u003e\n+        \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+          \u003cEye class=\"h-5 w-5\" /\u003e\n+          Recent Activity\n+        \u003c/h3\u003e\n+        \u003cdiv class=\"space-y-4\"\u003e\n+          {#if repoClass.issues.length \u003e 0}\n+            \u003cdiv\u003e\n+              \u003ch4 class=\"mb-2 text-sm font-medium text-muted-foreground\"\u003eRecent Issues\u003c/h4\u003e\n+              \u003cdiv class=\"space-y-2\"\u003e\n+                {#each repoClass.issues.slice(0, 3) as issue}\n+                  \u003cdiv class=\"flex items-start gap-3 rounded-lg p-3 outline outline-1 outline-gray-200\"\u003e\n+                    \u003cCircleAlert class=\"mt-0.5 h-4 w-4 text-red-500\" /\u003e\n+                    \u003cdiv class=\"min-w-0 flex-1\"\u003e\n+                      \u003cp class=\"truncate text-sm font-medium\"\u003e\n+                        {issue.tags.find(nthEq(0, \"t\"))?.[1] || \"Untitled Issue\"}\n+                      \u003c/p\u003e\n+                      \u003cp class=\"text-xs text-muted-foreground\"\u003e\n+                        {formatDate(new Date(issue.created_at * 1000))}\n+                      \u003c/p\u003e\n+                    \u003c/div\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          {#if repoClass.patches.length \u003e 0}\n+            \u003cdiv\u003e\n+              \u003ch4 class=\"mb-2 text-sm font-medium text-muted-foreground\"\u003eRecent Patches\u003c/h4\u003e\n+              \u003cdiv class=\"space-y-2\"\u003e\n+                {#each repoClass.patches.slice(0, 3) as patch}\n+                  \u003cdiv class=\"flex items-start gap-3 rounded-lg p-3 outline outline-1 outline-gray-200\"\u003e\n+                    \u003cGitPullRequest class=\"mt-0.5 h-4 w-4 text-purple-500\" /\u003e\n+                    \u003cdiv class=\"min-w-0 flex-1\"\u003e\n+                      \u003cp class=\"truncate text-sm font-medium\"\u003e\n+                        {patch.tags.find(nthEq(0, \"title\"))?.[1] || \"Untitled Patch\"}\n+                      \u003c/p\u003e\n+                      \u003cp class=\"text-xs text-muted-foreground\"\u003e\n+                        {formatDate(new Date(patch.created_at * 1000))}\n+                      \u003c/p\u003e\n+                    \u003c/div\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n         \u003c/div\u003e\n       \u003c/Card\u003e\n-    {/each}\n-  \u003c/div\u003e\n-  {#if renderedReadme}\n-    \u003cdiv class=\"prose max-w-2xl bg-white dark:bg-zinc-900\" in:fly\u003e\n-      {@html renderedReadme}\n-      \u003cstyle\u003e\n-        .prose {\n-          color: theme(\"colors.zinc.50\");\n-          background: none;\n-        }\n-        .dark .prose {\n-          color: theme(\"colors.white\");\n-        }\n-        .prose h1,\n-        .prose h2,\n-        .prose h3 {\n-          font-weight: 600;\n-          line-height: 1.25;\n-          color: theme(\"colors.zinc.50\");\n-          margin-top: 2rem;\n-          margin-bottom: 1rem;\n-        }\n-        .prose h1 {\n-          font-size: 2rem;\n-          border-bottom: 1px solid theme(\"colors.zinc.50\");\n-          padding-bottom: 0.3em;\n-        }\n-        .prose h2 {\n-          font-size: 1.5rem;\n-          border-bottom: 1px solid theme(\"colors.zinc.50\");\n-          padding-bottom: 0.2em;\n-        }\n-        .prose h3 {\n-          font-size: 1.25rem;\n-          padding-bottom: 0.1em;\n-        }\n-        .prose ul,\n-        .prose ol {\n-          margin: 1em 0;\n-          padding-left: 2em;\n-        }\n-        .prose li {\n-          margin: 0.3em 0;\n-        }\n-        .prose a {\n-          color: theme(\"colors.accent\");\n-          text-decoration: underline;\n-          text-underline-offset: 2px;\n-          transition: color 0.2s;\n-        }\n-        .prose a:hover {\n-          color: theme(\"colors.primary\");\n-        }\n-        .prose code {\n-          background: theme(\"colors.zinc.700\");\n-          color: theme(\"colors.zinc.100\");\n-          border-radius: 4px;\n-          padding: 0.2em 0.4em;\n-          font-size: 0.95em;\n-        }\n-        .prose pre {\n-          background: theme(\"colors.zinc.900\");\n-          color: theme(\"colors.zinc.100\");\n-          border-radius: 8px;\n-          padding: 1em;\n-          margin: 1.5em 0;\n-          font-size: 1em;\n-          overflow-x: auto;\n-        }\n-        .prose blockquote {\n-          border-left: 4px solid theme(\"colors.zinc.300\");\n-          background: theme(\"colors.zinc.50\");\n-          color: theme(\"colors.zinc.600\");\n-          padding: 1em 1.5em;\n-          border-radius: 0.5em;\n-          margin: 1.5em 0;\n-          font-style: italic;\n-        }\n-        .prose table {\n-          width: 100%;\n-          border-collapse: collapse;\n-          margin-bottom: 1.5em;\n-          background: theme(\"colors.zinc.50\");\n-          border-radius: 0.5em;\n-          overflow: hidden;\n-        }\n-        .prose th,\n-        .prose td {\n-          border: 1px solid theme(\"colors.zinc.200\");\n-          padding: 0.6em 1em;\n-        }\n-        .prose th {\n-          background: theme(\"colors.zinc.100\");\n-          font-weight: 600;\n-        }\n-      \u003c/style\u003e\n+    {/if}\n     \u003c/div\u003e\n-  {:else if loading}\n-    \u003cSpinner {loading}\u003eLoading README.md...\u003c/Spinner\u003e\n-  {:else}\n-    \u003cdiv class=\"text-muted-foreground\"\u003eNo README.md found.\u003c/div\u003e\n+    \u003c!-- README --\u003e\n+    {#if renderedReadme}\n+      \u003cCard class=\"p-6\"\u003e\n+        \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+          \u003cBookOpen class=\"h-5 w-5\" /\u003e\n+          README\n+        \u003c/h3\u003e\n+        \u003cdiv class=\"prose max-w-2xl bg-white dark:bg-zinc-900\" in:fly\u003e\n+          {@html renderedReadme}\n+          \u003cstyle\u003e\n+            .prose {\n+              color: theme(\"colors.zinc.50\");\n+              background: none;\n+            }\n+            .dark .prose {\n+              color: theme(\"colors.white\");\n+            }\n+            .prose h1,\n+            .prose h2,\n+            .prose h3 {\n+              font-weight: 600;\n+              line-height: 1.25;\n+              color: theme(\"colors.zinc.50\");\n+              margin-top: 2rem;\n+              margin-bottom: 1rem;\n+            }\n+            .prose h1 {\n+              font-size: 2rem;\n+              border-bottom: 1px solid theme(\"colors.zinc.50\");\n+              padding-bottom: 0.3em;\n+            }\n+            .prose h2 {\n+              font-size: 1.5rem;\n+              border-bottom: 1px solid theme(\"colors.zinc.50\");\n+              padding-bottom: 0.2em;\n+            }\n+            .prose h3 {\n+              font-size: 1.25rem;\n+              padding-bottom: 0.1em;\n+            }\n+            .prose ul,\n+            .prose ol {\n+              margin: 1em 0;\n+              padding-left: 2em;\n+            }\n+            .prose li {\n+              margin: 0.3em 0;\n+            }\n+            .prose a {\n+              color: theme(\"colors.accent\");\n+              text-decoration: underline;\n+              text-underline-offset: 2px;\n+              transition: color 0.2s;\n+            }\n+            .prose a:hover {\n+              color: theme(\"colors.primary\");\n+            }\n+            .prose code {\n+              background: theme(\"colors.zinc.700\");\n+              color: theme(\"colors.zinc.100\");\n+              border-radius: 4px;\n+              padding: 0.2em 0.4em;\n+              font-size: 0.95em;\n+            }\n+            .prose pre {\n+              background: theme(\"colors.zinc.900\");\n+              color: theme(\"colors.zinc.100\");\n+              border-radius: 8px;\n+              padding: 1em;\n+              margin: 1.5em 0;\n+              font-size: 1em;\n+              overflow-x: auto;\n+            }\n+            .prose blockquote {\n+              border-left: 4px solid theme(\"colors.zinc.300\");\n+              background: theme(\"colors.zinc.50\");\n+              color: theme(\"colors.zinc.600\");\n+              padding: 1em 1.5em;\n+              border-radius: 0.5em;\n+              margin: 1.5em 0;\n+              font-style: italic;\n+            }\n+            .prose table {\n+              width: 100%;\n+              border-collapse: collapse;\n+              margin-bottom: 1.5em;\n+              background: theme(\"colors.zinc.50\");\n+              border-radius: 0.5em;\n+              overflow: hidden;\n+            }\n+            .prose th,\n+            .prose td {\n+              border: 1px solid theme(\"colors.zinc.200\");\n+              padding: 0.6em 1em;\n+            }\n+            .prose th {\n+              background: theme(\"colors.zinc.100\");\n+              font-weight: 600;\n+            }\n+          \u003c/style\u003e\n+        \u003c/div\u003e\n+      \u003c/Card\u003e\n+    {/if}\n   {/if}\n \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\nnew file mode 100644\nindex 0000000..afb0e08\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n@@ -0,0 +1,175 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {GitBranch, Funnel, User, Search} from \"@lucide/svelte\"\n+  import {\n+    Button,\n+    Input,\n+    Select,\n+    SelectContent,\n+    SelectTrigger,\n+    SelectItem,\n+    Separator,\n+    CommitCard,\n+  } from \"@nostr-git/ui\"\n+  import {formatDistanceToNow} from \"date-fns\"\n+  import Spinner from \"@src/lib/components/Spinner.svelte\"\n+\n+  let {data} = $props()\n+  const {repoClass} = data\n+\n+  // Reactive state for UI\n+  let searchQuery = $state(\"\")\n+  let selectedBranch = $state([repoClass.mainBranch.split(\"/\").pop() || \"\"])\n+  let selectedAuthor = $state([])\n+\n+  // Get commits from the repo class (lazy-loaded and reactive)\n+  let commitsLoading = $state(true)\n+  let commitsError = $state\u003cstring | undefined\u003e(undefined)\n+  let commits = $state\u003cany[]\u003e([])\n+  // Get available branches for filtering\n+  let branches = $state\u003cstring[]\u003e([])\n+\n+  // Get unique authors from commits for filtering\n+  let authors = $state\u003cSet\u003cstring\u003e\u003e(new Set())\n+\n+  $effect(() =\u003e {\n+    if (repoClass.commits) {\n+      commits = repoClass.commits\n+    }\n+  })\n+\n+  $effect(() =\u003e {\n+    if (repoClass.branches) {\n+      branches = repoClass.branches.map((branch: any) =\u003e branch.name.split(\"/\").pop())\n+    }\n+  })\n+\n+  $effect(() =\u003e {\n+    if (repoClass.commits \u0026\u0026 repoClass.commits.length \u003e 0) {\n+      authors = new Set(repoClass.commits.map((commit: any) =\u003e commit.commit.author.name))\n+      commitsLoading = false\n+    }\n+  })\n+\n+  // Filter commits based on search and filters\n+  const filteredCommits = $derived.by(() =\u003e {\n+    if (commits) {\n+      let filtered = commits\n+\n+      // Filter by search query\n+      if (searchQuery.trim()) {\n+        const query = searchQuery.toLowerCase()\n+        filtered = filtered.filter(\n+          commit =\u003e\n+            commit.commit.message.toLowerCase().includes(query) ||\n+            commit.commit.author.name.toLowerCase().includes(query) ||\n+            commit.oid.toLowerCase().includes(query),\n+        )\n+      }\n+\n+      // Filter by branch (if branch filtering is implemented)\n+      if (selectedBranch.length \u003e 0) {\n+        //filtered = filtered.filter(commit =\u003e commit.branch === selectedBranch[0])\n+      }\n+\n+      // Filter by author\n+      if (selectedAuthor.length \u003e 0) {\n+        filtered = filtered.filter(commit =\u003e commit.commit.author.name === selectedAuthor[0])\n+      }\n+\n+      return filtered\n+    }\n+    return []\n+  })\n+\n+  const handleReact = (commitId: string, type: \"heart\") =\u003e {\n+    console.log(`Reacting to commit ${commitId} with ${type}`)\n+  }\n+\n+  const handleComment = (commitId: string, comment: string) =\u003e {\n+    console.log(`Commenting on commit ${commitId}: ${comment}`)\n+    // TODO: Implement Nostr comments for commits\n+  }\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"flex flex-col gap-6\"\u003e\n+  {#if commitsLoading}\n+    \u003cdiv class=\"flex items-center justify-center py-12\"\u003e\n+      \u003cSpinner loading={commitsLoading}\u003e\n+        Loading commits...\n+      \u003c/Spinner\u003e\n+    \u003c/div\u003e\n+  {:else if commitsError}\n+    \u003cdiv class=\"py-12 text-center\"\u003e\n+      \u003cp class=\"text-muted-foreground\"\u003eFailed to load commits.\u003c/p\u003e\n+    \u003c/div\u003e\n+  {:else}\n+    \u003cdiv class=\"mt-6\"\u003e\n+      \u003cdiv class=\"mb-6 flex flex-col gap-4 rounded-lg border border-border bg-card p-4 sm:flex-row\"\u003e\n+        \u003cdiv class=\"flex-1\"\u003e\n+          \u003cdiv class=\"relative\"\u003e\n+            \u003cSearch\n+              class=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 transform text-muted-foreground\" /\u003e\n+            \u003cInput placeholder=\"Search commits...\" bind:value={searchQuery} class=\"pl-10\" /\u003e\n+          \u003c/div\u003e\n+        \u003c/div\u003e\n+\n+        \u003cSelect bind:value={selectedBranch}\u003e\n+          \u003cSelectTrigger class=\"w-[140px]\"\u003e\n+            \u003cGitBranch class=\"mr-2 h-4 w-4\" /\u003e\n+            \u003cspan\u003e{selectedBranch}\u003c/span\u003e\n+          \u003c/SelectTrigger\u003e\n+          \u003cSelectContent\u003e\n+            {#each branches as branch (branch)}\n+              \u003cSelectItem value={branch}\u003e\n+                {branch}\n+              \u003c/SelectItem\u003e\n+            {/each}\n+          \u003c/SelectContent\u003e\n+        \u003c/Select\u003e\n+\n+        \u003cSelect bind:value={selectedAuthor}\u003e\n+          \u003cSelectTrigger class=\"w-[120px]\"\u003e\n+            \u003cUser class=\"mr-2 h-4 w-4\" /\u003e\n+            \u003cspan\u003e{selectedAuthor.length \u003e 0 ? selectedAuthor[0] : \"All authors\"}\u003c/span\u003e\n+          \u003c/SelectTrigger\u003e\n+          \u003cSelectContent\u003e\n+            {#each authors as author (author)}\n+              \u003cSelectItem value={author}\u003e\n+                {author}\n+              \u003c/SelectItem\u003e\n+            {/each}\n+          \u003c/SelectContent\u003e\n+        \u003c/Select\u003e\n+      \u003c/div\u003e\n+\n+      \u003cdiv class=\"space-y-4\"\u003e\n+        \u003cdiv class=\"flex items-center justify-between\"\u003e\n+          \u003ch2 class=\"text-lg font-semibold\"\u003e\n+            {filteredCommits?.length} commit{filteredCommits?.length !== 1 ? \"s\" : \"\"}\n+            {#if selectedBranch.length \u003e 0}\n+              on {selectedBranch[0]}{/if}\n+          \u003c/h2\u003e\n+\n+          \u003cButton variant=\"outline\" size=\"sm\" class=\"gap-2\"\u003e\n+            \u003cFunnel class=\"h-4 w-4\" /\u003e\n+            More filters\n+          \u003c/Button\u003e\n+        \u003c/div\u003e\n+\n+        \u003cSeparator /\u003e\n+\n+        {#if !repoClass.commits || repoClass.commits.length === 0}\n+          \u003cdiv class=\"py-12 text-center\"\u003e\n+            \u003cp class=\"text-muted-foreground\"\u003eNo commits found in this repository.\u003c/p\u003e\n+          \u003c/div\u003e\n+        {:else}\n+          \u003cdiv class=\"space-y-3\"\u003e\n+            {#each filteredCommits as commit (commit.oid)}\n+              \u003cCommitCard {commit} onReact={handleReact} onComment={handleComment} /\u003e\n+            {/each}\n+          \u003c/div\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  {/if}\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 9c706dc..1359cba 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -1,5 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {Button, IssueCard, PatchCard, Repo} from \"@nostr-git/ui\"\n+  import {Button, PatchCard, Repo} from \"@nostr-git/ui\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Address, type TrustedEvent} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-cn3fq3r3","title":"From 1859f898c169d7ea8bfd29f35baa8563e1b050c2 Mon Sep 17 00:00:00 2001","description":"From 1859f898c169d7ea8bfd29f35baa8563e1b050c2 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Sat, 14 Jun 2025 12:22:44 -0700\nSubject: [PATCH 2/2] refactor: move repo state management to +layout.ts and add function registry for UI components\n\n---\n packages/nostr-git                                                      |   2 +-\n src/app/state.ts                                                        |   1 -\n src/lib/components/Button.svelte                                        |  24 +++++++++++++++---------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 | 244 ++++++++++++++++++++++++++++++----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts                     | 140 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte            |  63 +++++++++++++++++++++++++++++++--------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           |  58 +++++++++++++++++++++++-----------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte |   5 ++---\n 8 files changed, 242 insertions(+), 295 deletions(-)\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex fffeb32..b936f21 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit fffeb3233b3e91903d3cac5b375e96ad4cc65deb\n+Subproject commit b936f2148a5391d625d7a7aa1dd8f0424379c486\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 5784a61..f038616 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -256,7 +256,6 @@ export const deriveNaddrEvent = (naddr: string, hints: string[] = []) =\u003e {\n         load({relays: relays as string[], filters})\n         attempted = true\n       }\n-\n       return events[0]\n     },\n   )\ndiff --git a/src/lib/components/Button.svelte b/src/lib/components/Button.svelte\nindex 4184b17..5966f28 100644\n--- a/src/lib/components/Button.svelte\n+++ b/src/lib/components/Button.svelte\n@@ -1,23 +1,25 @@\n \u003cscript lang=\"ts\"\u003e\n   import type {Snippet} from \"svelte\"\n \n-  const {\n-    children,\n+  let {\n     onclick,\n     type = \"button\",\n+    ref = $bindable(null),\n+    children,\n     ...restProps\n   }: {\n-    children: Snippet\n+    children?: Snippet  // Changed from required to optional\n     onclick?: (event: Event) =\u003e any\n     type?: \"button\" | \"submit\"\n     class?: string\n     style?: string\n     disabled?: boolean\n     \"data-tip\"?: string\n+    ref?: any\n   } = $props()\n-\n+  \n   const className = $derived(`text-left ${restProps.class}`)\n-\n+  \n   const onClick = (e: Event) =\u003e {\n     e.preventDefault()\n     e.stopPropagation()\n@@ -27,11 +29,15 @@\n \u003c/script\u003e\n \n {#if type === \"submit\"}\n-  \u003cbutton {...restProps} {type} class={className}\u003e\n-    {@render children?.()}\n+  \u003cbutton {...restProps} {type} class={className} bind:this={ref}\u003e\n+    {#if children}\n+      {@render children()}\n+    {/if}\n   \u003c/button\u003e\n {:else}\n-  \u003cbutton {...restProps} onclick={onClick} type={type as \"button\" | \"submit\"} class={className}\u003e\n-    {@render children?.()}\n+  \u003cbutton {...restProps} onclick={onClick} type={type as \"button\" | \"submit\"} class={className} bind:this={ref}\u003e\n+    {#if children}\n+      {@render children()}\n+    {/if}\n   \u003c/button\u003e\n {/if}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex fcf18a5..e88a9a1 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -1,205 +1,25 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {Repo, RepoHeader, RepoTab} from \"@nostr-git/ui\"\n+  import {FunctionProvider, Repo, RepoHeader, RepoTab, toast} from \"@nostr-git/ui\"\n+  import {ConfigProvider} from \"@nostr-git/ui\"\n+  import {FileCode, GitBranch, CircleAlert, GitPullRequest} from \"@lucide/svelte\"\n   import {page} from \"$app/stores\"\n-  import {decodeRelay, deriveNaddrEvent, hasNip29, userMembership} from \"@app/state\"\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n-  import {FileCode, GitBranch, CircleAlert, GitPullRequest, Layers, GitMerge} from \"@lucide/svelte\"\n-  import {\n-    parseRepoAnnouncementEvent,\n-    type CommentEvent,\n-    type IssueEvent,\n-    type PatchEvent,\n-    type RepoAnnouncementEvent,\n-    type RepoStateEvent,\n-  } from \"@nostr-git/shared-types\"\n-  import {setContext} from \"svelte\"\n-  import {deriveEvents} from \"@welshman/store\"\n-  import {deriveProfile, deriveRelay, publishThunk, repository} from \"@welshman/app\"\n-  import {GIT_REPO_STATE} from \"@src/lib/util\"\n-  import {derived as _derived, get} from \"svelte/store\"\n-  import {Address, GIT_ISSUE, GIT_PATCH, type Filter} from \"@welshman/util\"\n-  import {load} from \"@welshman/net\"\n-  import {equals, nthEq} from \"@welshman/lib\"\n-  import {nip19, type NostrEvent} from \"nostr-tools\"\n-  import type {AddressPointer} from \"nostr-tools/nip19\"\n-  import {addRoomMembership, getThunkError, nip29} from \"@src/app/commands\"\n-  import {pushToast} from \"@src/app/toast\"\n-  import {makeSpacePath} from \"@src/app/routes\"\n-  import {goto} from \"$app/navigation\"\n-  import {toast} from \"@nostr-git/ui\"\n-  import {ConfigProvider} from \"@nostr-git/ui\"\n-\n   import Button from \"@lib/components/Button.svelte\"\n   import Avatar from \"@lib/components/Avatar.svelte\"\n   import Divider from \"@lib/components/Divider.svelte\"\n   import Input from \"@lib/components/Field.svelte\"\n   import Dialog from \"@lib/components/Dialog.svelte\"\n+  import {setContext} from \"svelte\"\n+  import {pushToast} from \"@src/app/toast\"\n \n   const {id, relay} = $page.params\n+  let {data, children} = $props()\n \n-  let {children} = $props()\n-\n-  const decoded = nip19.decode(id).data as AddressPointer\n-  const repoId = decoded.identifier\n-\n-  let eventStore = deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay])\n-\n-  const repoState = $derived.by(() =\u003e {\n-    if ($eventStore) {\n-      const repoEvent = parseRepoAnnouncementEvent(\n-        $eventStore as RepoAnnouncementEvent\n-      )\n-      const address = repoEvent.repoId\n-\n-      const repoStateFilter: Filter[] = [\n-        {\n-          kinds: [GIT_REPO_STATE],\n-          \"#d\": [address!],\n-        },\n-      ]\n-      return deriveEvents(repository, {filters: repoStateFilter})\n-    }\n-  })\n-\n-  const issues = $derived.by(() =\u003e {\n-    if ($eventStore) {\n-      return deriveEvents(repository, {\n-        filters: [\n-          {\n-            kinds: [GIT_ISSUE],\n-            \"#a\": [Address.fromEvent($eventStore).toString()],\n-          },\n-        ],\n-      })\n-    }\n-  })\n-\n-  const patches = $derived.by(() =\u003e {\n-    if ($eventStore) {\n-      return deriveEvents(repository, {\n-        filters: [\n-          {\n-            kinds: [GIT_PATCH],\n-            \"#a\": [Address.fromEvent($eventStore).toString()],\n-            \"#t\": [\"root\"],\n-          },\n-        ],\n-      })\n-    }\n-  })\n-\n-  const url = decodeRelay($page.params.relay)\n-\n-  const relays = $derived.by(() =\u003e {\n-    if ($eventStore) {\n-      const [_, ...relays] = $eventStore.tags.find(nthEq(0, \"relays\")) || []\n-      return relays\n-    }\n-  })\n-\n-  const postComment = (comment: CommentEvent) =\u003e {\n-    if (!relays) {\n-      pushToast({\n-          theme: \"error\",\n-          message: 'No relays found to post!', timeout: 7000\n-      })\n-      return;\n-    }\n-    publishThunk({\n-      relays: relays,\n-      event: comment,\n-    })\n-  }\n-\n-  setContext(\"postComment\", postComment)\n-\n-  const postIssue = async (issue: IssueEvent) =\u003e {\n-    if (!relays) {\n-      pushToast({\n-          theme: \"error\",\n-          message: 'No relays found to post!', timeout: 7000\n-      })\n-      return;\n-    }\n-    publishThunk({\n-      relays: relays,\n-      event: issue,\n-    })\n-  }\n-\n-  setContext(\"postIssue\", postIssue)\n-\n-  setContext(\"getProfile\", deriveProfile)\n+  const {repoClass, eventStore, functionRegistry} = data\n \n   let activeTab: string | undefined = $page.url.pathname.split(\"/\").pop()\n   const encodedRelay = encodeURIComponent(relay)\n \n-  $effect(() =\u003e {\n-    if ($eventStore) {\n-      const address = Address.fromEvent($eventStore).toString()\n-      const repoStateFilter: Filter = {kinds: [GIT_REPO_STATE], \"#d\": [address]}\n-      const issuesFilter: Filter = {kinds: [GIT_ISSUE], \"#a\": [address]}\n-      const patchesFilter: Filter = {kinds: [GIT_PATCH], \"#a\": [address]}\n-\n-      load({\n-        relays: relays!,\n-        filters: [issuesFilter, patchesFilter, repoStateFilter],\n-      })\n-    }\n-  })\n-\n-  const nipRelay = deriveRelay(url)\n-\n-  const isRepoWatched = $derived.by(() =\u003e {\n-    const list = get(userMembership)\n-    const pred = (t: string[]) =\u003e equals([\"group\", repoId, url], t.slice(0, 3))\n-    const room = list?.publicTags.find(pred)\n-    return room !== undefined \u0026\u0026 room.length \u003e 0\n-  })\n-\n-  const watchRepo = async () =\u003e {\n-    $eventStore.tags.push([\"h\", id])\n-    console.log($eventStore)\n-\n-    const publish = publishThunk({\n-      relays: [url],\n-      event: {\n-        content: $eventStore.content,\n-        tags: $eventStore.tags,\n-        kind: $eventStore.kind,\n-        pubkey: $eventStore.pubkey,\n-      },\n-    })\n-\n-    const message = await getThunkError(publish)\n-\n-    if (message) {\n-      return pushToast({theme: \"error\", message})\n-    }\n-\n-    if (hasNip29($nipRelay)) {\n-      const createMessage = await getThunkError(nip29.createRoom(url, id))\n-\n-      if (createMessage \u0026\u0026 !createMessage.match(/^duplicate:|already a member/)) {\n-        return pushToast({theme: \"error\", message: createMessage})\n-      }\n-\n-      const editMessage = await getThunkError(nip29.editMeta(url, id, {repoId}))\n-\n-      if (editMessage) {\n-        return pushToast({theme: \"error\", message: editMessage})\n-      }\n-\n-      const joinMessage = await getThunkError(nip29.joinRoom(url, id))\n-\n-      if (joinMessage \u0026\u0026 !joinMessage.includes(\"already\")) {\n-        return pushToast({theme: \"error\", message: joinMessage})\n-      }\n-    }\n-    addRoomMembership(url, id, repoId)\n-    goto(makeSpacePath(url, id))\n-  }\n-\n   // Connect the nostr-git toast store to the toast component\n   $effect(() =\u003e {\n     if ($toast.length \u003e 0) {\n@@ -210,19 +30,7 @@\n     }\n   })\n \n-  const repoClass = new Repo({\n-    repoEvent: $eventStore as RepoAnnouncementEvent,\n-    repoStateEvent: $repoState ? ($repoState[0] as RepoStateEvent) : undefined,\n-    publish: (event) =\u003e {\n-      return publishThunk({\n-        relays: [url],\n-        event: event,\n-      })\n-    },\n-    issues: $issues! as IssueEvent[],\n-    patches: $patches! as PatchEvent[],\n-  })\n-\n+  setContext(\"functions\", functionRegistry)\n   setContext(\"repoClass\", repoClass)\n \u003c/script\u003e\n \n@@ -232,11 +40,7 @@\n   {:else if !$eventStore}\n     \u003cdiv class=\"p-4 text-center text-red-500\"\u003eRepository not found.\u003c/div\u003e\n   {:else}\n-    \u003cRepoHeader\n-      event={$eventStore as RepoAnnouncementEvent}\n-      {activeTab}\n-      {watchRepo}\n-      {isRepoWatched}\u003e\n+    \u003cRepoHeader event={$eventStore as any} {activeTab} isRepoWatched={false}\u003e\n       {#snippet children(activeTab: string)}\n         \u003cRepoTab\n           tabValue={id}\n@@ -274,16 +78,28 @@\n             \u003cGitPullRequest class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n+        \u003cRepoTab\n+          tabValue=\"workbench\"\n+          label=\"Workbench\"\n+          href={`/spaces/${encodedRelay}/git/${id}/workbench`}\n+          {activeTab}\u003e\n+          {#snippet icon()}\n+            \u003cGitBranch class=\"h-4 w-4\" /\u003e\n+          {/snippet}\n+        \u003c/RepoTab\u003e\n       {/snippet}\n     \u003c/RepoHeader\u003e\n-    \u003cConfigProvider components={{\n-      Button,\n-      Avatar,\n-      Separator: Divider,\n-      Input,\n-      Alert: Dialog\n-    }}\u003e\n-      {@render children()}\n-    \u003c/ConfigProvider\u003e\n+    \u003cFunctionProvider functions={functionRegistry}\u003e\n+      \u003cConfigProvider\n+        components={{\n+          Button: Button as typeof import(\"@nostr-git/ui\").Button,\n+          AvatarImage: Avatar as typeof import(\"@nostr-git/ui\").AvatarImage,\n+          Separator: Divider as typeof import(\"@nostr-git/ui\").Separator,\n+          Input: Input as typeof import(\"@nostr-git/ui\").Input,\n+          Alert: Dialog as typeof import(\"@nostr-git/ui\").Alert,\n+        }}\u003e\n+        {@render children()}\n+      \u003c/ConfigProvider\u003e\n+    \u003c/FunctionProvider\u003e\n   {/if}\n \u003c/PageContent\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nnew file mode 100644\nindex 0000000..0d62418\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -0,0 +1,140 @@\n+import { derived, get, type Readable } from 'svelte/store';\n+import {\n+    type CommentEvent,\n+    type IssueEvent,\n+    type PatchEvent,\n+} from '@nostr-git/shared-types';\n+import { GIT_ISSUE, GIT_PATCH } from '@welshman/util';\n+import { nip19 } from 'nostr-tools';\n+import type { AddressPointer } from 'nostr-tools/nip19';\n+import { nthEq } from '@welshman/lib';\n+import { GIT_REPO, GIT_REPO_STATE } from '@src/lib/util.js';\n+import { browser } from '$app/environment';\n+\n+export const ssr = false;\n+\n+export async function load({ params }) {\n+    const { id, relay } = params;\n+\n+    // Only import and use browser-specific modules when in browser context\n+    if (!browser) {\n+        // Return minimal data for SSR\n+        return {\n+            repoClass: null,\n+            eventStore: null,\n+            relays: null,\n+            url: null,\n+            repoId: null,\n+            functionRegistry: undefined,\n+        };\n+    }\n+\n+    // Dynamic imports to avoid SSR issues\n+    const { deriveNaddrEvent, decodeRelay, INDEXER_RELAYS } = await import('@app/state');\n+    const { deriveEvents } = await import('@welshman/store');\n+    const { publishThunk, repository } = await import('@welshman/app');\n+    const { load } = await import(\"@welshman/net\");\n+    const { Repo } = await import('@nostr-git/ui'); // Make Repo import dynamic\n+\n+    const decoded = nip19.decode(id).data as AddressPointer;\n+    const repoId = decoded.identifier;\n+    const url = decodeRelay(relay);\n+\n+    const eventStore = deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay]);\n+\n+    const fallbackRelays = INDEXER_RELAYS\n+    const relayList = decoded.relays?.length! \u003e 0 ? decoded.relays : fallbackRelays\n+\n+    const filters = [{\n+        authors: [decoded.pubkey],\n+        kinds: [GIT_REPO_STATE, GIT_REPO],\n+        \"#d\": [decoded.identifier],\n+    }]\n+\n+    load({ relays: relayList as string[], filters })\n+\n+    // Combine the separate event stores\n+    const repoAnnouncementEvents = deriveEvents(repository, {\n+        filters: [{\n+            authors: [decoded.pubkey],\n+            kinds: [GIT_REPO],\n+            \"#d\": [decoded.identifier],\n+        }]\n+    });\n+\n+    const repoStateEvents = deriveEvents(repository, {\n+        filters: [{\n+            authors: [decoded.pubkey],\n+            kinds: [GIT_REPO_STATE],\n+            \"#d\": [decoded.identifier],\n+        }]\n+    });\n+\n+    const repoEvents = derived([repoAnnouncementEvents, repoStateEvents], ([announcements, states]) =\u003e {\n+        const combined = [...(announcements || []), ...(states || [])];\n+        return combined;\n+    });\n+\n+    // Get relays from event tags\n+    const relays = derived(eventStore, $eventStore =\u003e {\n+        if ($eventStore) {\n+            const [_, ...relaysList] = $eventStore.tags.find(nthEq(0, \"relays\")) || [];\n+            return relaysList;\n+        }\n+        return undefined;\n+    });\n+\n+    // Create derived stores for issues and patches\n+    const issues: Readable\u003cIssueEvent[]\u003e = derived(\n+        deriveEvents(repository, {\n+            filters: [{\n+                authors: [decoded.pubkey],\n+                kinds: [GIT_ISSUE],\n+                \"#a\": [`${GIT_REPO}:${decoded.pubkey}:${decoded.identifier}`],\n+            }],\n+        }),\n+        (events) =\u003e (events || []) as IssueEvent[]\n+    );\n+\n+    const patches: Readable\u003cPatchEvent[]\u003e = derived(\n+        deriveEvents(repository, {\n+            filters: [{\n+                authors: [decoded.pubkey],\n+                kinds: [GIT_PATCH],\n+                \"#a\": [`${GIT_REPO}:${decoded.pubkey}:${decoded.identifier}`],\n+            }]\n+        }),\n+        (events) =\u003e (events || []) as PatchEvent[]\n+    );\n+\n+    const functionRegistry = {\n+        postComment: (comment: CommentEvent) =\u003e {\n+            return publishThunk({\n+                relays: get(relays) ?? [],\n+                event: comment,\n+            });\n+        },\n+\n+        postIssue: (issue: IssueEvent) =\u003e {\n+            return publishThunk({\n+                relays: get(relays) ?? [],\n+                event: issue,\n+            });\n+        },\n+    };\n+\n+    const repoClass = new Repo({\n+        repoEvents,\n+        issues,\n+        patches,\n+    });\n+\n+    return {\n+        repoClass,\n+        eventStore,\n+        relays,\n+        url,\n+        repoId,\n+        functionRegistry,\n+    };\n+}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex 526eb96..296cd7f 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -1,29 +1,27 @@\n \u003cscript lang=\"ts\"\u003e\n   import {Button, IssueCard, NewIssueForm, Repo} from \"@nostr-git/ui\"\n-  import { isCommentEvent, type CommentEvent } from \"@nostr-git/shared-types\"\n+  import {isCommentEvent, type CommentEvent} from \"@nostr-git/shared-types\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Address, COMMENT, GIT_ISSUE} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n-  import {deriveProfile, repository} from \"@welshman/app\"\n+  import {deriveProfile, repository, Thunk} from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {makeFeed} from \"@src/app/requests\"\n   import {fly} from \"@lib/transition\"\n   import {pushModal} from \"@src/app/modal\"\n-  import {load} from \"@welshman/net\"\n   import {deriveEvents} from \"@welshman/store\"\n-  import type { IssueEvent } from \"@nostr-git/shared-types\"\n+  import type {IssueEvent} from \"@nostr-git/shared-types\"\n+  import {load} from \"@welshman/net\"\n \n   const repoClass = getContext\u003cRepo\u003e(\"repoClass\")\n \n-  const comments = $derived.by(() =\u003e {\n-    return deriveEvents(repository, {\n-      filters: [\n-        {\n-          kinds: [COMMENT],\n-          \"#E\": [...repoClass.issues.map((i) =\u003e i.id)],\n-        },\n-      ],\n-    })\n+  const commentFilter = {\n+    kinds: [COMMENT],\n+    \"#E\": [...repoClass.issues.map(i =\u003e i.id)],\n+  }\n+\n+  const comments = deriveEvents(repository, {\n+    filters: [commentFilter],\n   })\n \n   const commentEvents = $derived.by(() =\u003e {\n@@ -34,29 +32,30 @@\n   let loading = $state(true)\n   let element: HTMLElement | undefined = $state()\n \n+  const issueFilter = {\n+    kinds: [GIT_ISSUE],\n+    \"#a\": [Address.fromEvent(repoClass.repoEvent).toString()],\n+  }\n+\n   $effect(() =\u003e {\n     if (repoClass.issues) {\n-      loading = false\n-    }\n+      load({relays: repoClass.relays, filters: [commentFilter, issueFilter]})\n \n-    const issueFilter = {\n-      kinds: [GIT_ISSUE],\n-      \"#a\": [Address.fromEvent(repoClass.repoEvent).toString()],\n+      makeFeed({\n+        element: element!,\n+        relays: repoClass.relays,\n+        feedFilters: [issueFilter],\n+        subscriptionFilters: [issueFilter],\n+        initialEvents: repoClass.issues,\n+        onExhausted: () =\u003e {\n+          loading = false\n+        },\n+      })\n+      loading = false\n     }\n-\n-    makeFeed({\n-      element: element!,\n-      relays: repoClass.relays,\n-      feedFilters: [issueFilter],\n-      subscriptionFilters: [issueFilter],\n-      initialEvents: repoClass.issues,\n-      onExhausted: () =\u003e {\n-        loading = false\n-      },\n-    })\n   })\n \n-  const postIssue: (issue: IssueEvent) =\u003e Promise\u003cvoid\u003e = getContext(\"postIssue\");\n+  const {postIssue} = getContext(\"functions\") as {postIssue: (issue: IssueEvent) =\u003e Thunk}\n \n   const onNewIssue = () =\u003e {\n     pushModal(NewIssueForm, {\n@@ -68,7 +67,7 @@\n \u003c/script\u003e\n \n \u003cdiv bind:this={element}\u003e\n-  \u003cdiv class=\"z-nav sticky -top-8 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n+  \u003cdiv class=\"sticky -top-8 z-nav mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003eIssues\u003c/h2\u003e\n       \u003cp class=\"text-sm text-muted-foreground\"\u003eTrack bugs and feature requests\u003c/p\u003e\n@@ -107,7 +106,7 @@\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each repoClass.issues as issue (issue.id)}\n         \u003cdiv in:fly\u003e\n-          \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)} comments={commentEvents} /\u003e\n+          \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)} comments={commentEvents}/\u003e\n         \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 9a5a9f0..9c706dc 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -20,26 +20,12 @@\n \n   const repoClass = getContext\u003cRepo\u003e(\"repoClass\")\n \n-  const statuses = $derived.by(() =\u003e {\n-    if (repoClass.patches) {\n-      const patchIds = repoClass.patches.map((patch: TrustedEvent) =\u003e patch.id)\n-\n-      const filters = [\n-        {\n-          kinds: [\n-            GIT_STATUS_OPEN,\n-            GIT_STATUS_COMPLETE,\n-            GIT_STATUS_CLOSED,\n-            GIT_STATUS_DRAFT,\n-          ],\n-          \"#e\": [...patchIds],\n-        },\n-      ]\n+  const statusFilter = {\n+    kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+    \"#e\": [...repoClass.patches.map((patch: TrustedEvent) =\u003e patch.id)],\n+  }\n \n-      load({relays: repoClass.relays, filters})\n-      return deriveEvents(repository, {filters})\n-    }\n-  })\n+  const statuses = deriveEvents(repository, {filters: [statusFilter]})\n \n   const patchList = $derived.by(() =\u003e {\n     if (repoClass.patches) {\n@@ -66,26 +52,28 @@\n   let loading = $state(true)\n   let element: HTMLElement | undefined = $state()\n \n+  const patchFilter = {\n+    kinds: [GIT_PATCH],\n+    \"#a\": [Address.fromEvent(repoClass.repoEvent).toString()],\n+    \"#t\": [\"root\"],\n+  }\n+\n   $effect(() =\u003e {\n     if (repoClass.patches) {\n+      load({relays: repoClass.relays, filters: [patchFilter, statusFilter]})\n+ \n+      makeFeed({\n+        element: element!,\n+        relays: repoClass.relays,\n+        feedFilters: [patchFilter],\n+        subscriptionFilters: [patchFilter],\n+        initialEvents: patchList,\n+        onExhausted: () =\u003e {\n+          loading = false\n+        },\n+      })\n       loading = false\n     }\n-\n-    const patchFilter = {\n-      kinds: [GIT_PATCH],\n-      \"#a\": [repoClass.repoId],\n-    }\n-\n-    makeFeed({\n-      element: element!,\n-      relays: repoClass.relays,\n-      feedFilters: [patchFilter],\n-      subscriptionFilters: [patchFilter],\n-      initialEvents: repoClass.patches,\n-      onExhausted: () =\u003e {\n-        loading = false\n-      },\n-    })\n   })\n \u003c/script\u003e\n \ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 7db863d..92d42ff 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -10,6 +10,7 @@\n   import {deriveEvents} from \"@welshman/store\"\n   import {load} from \"@welshman/net\"\n   import {COMMENT, type Filter} from \"@welshman/util\"\n+  import type {CommentEvent} from \"@nostr-git/shared-types\"\n \n   const repoClass = getContext\u003cRepo\u003e(\"repoClass\")\n \n@@ -105,8 +106,6 @@\n           \u003ch2 class=\"text-lg font-medium\"\u003e{patch?.commitCount} Commits\u003c/h2\u003e\n \n           \u003cdiv class=\"flex items-center gap-2\"\u003e\n-            \u003cButton variant=\"outline\" size=\"sm\"\u003eView on GitHub\u003c/Button\u003e\n-\n             {#if patch?.status === \"open\"}\n               \u003cButton variant=\"default\" size=\"sm\" class=\"bg-git hover:bg-git-hover\"\u003e\n                 Merge Patch\n@@ -130,7 +129,7 @@\n             Discussion ({$threadComments?.length})\n           \u003c/h2\u003e\n \n-          \u003cIssueThread issueId={patch?.id} comments={$threadComments} /\u003e\n+          \u003cIssueThread issueId={patch?.id} comments={$threadComments as CommentEvent[]} /\u003e\n         \u003c/div\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-comq9om4","title":"From f18d5993555d705bb719481e63b1786078397148 Mon Sep 17 00:00:00 2001","description":"From f18d5993555d705bb719481e63b1786078397148 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 14 Dec 2025 16:33:43 +0500\nSubject: [PATCH 1/1] refactor: optimize git repository navigation with non-blocking data loading\n\nRefactor git repository layout and page components to improve performance\nby making data loading non-blocking and using reactive stores instead of\nblocking await calls. This significantly reduces initial page load time\nand improves navigation responsiveness.\n\nKey improvements:\n\nLayout Loader (+layout.ts):\n- Convert blocking repo event loading to non-blocking promise that starts\n  in background (repoLoadPromise)\n- Replace synchronous maintainer extraction with reactive derived store\n  (repoAuthors) that updates when repo event loads\n- Create reactive event stores (allIssueEvents, allPatchEvents, etc.)\n  that watch repository and filter based on current authors\n- Remove blocking filter loads - stores update reactively as data arrives\n- Add support for StatusEvent, CommentEvent, and LabelEvent types\n- Improve maintainer extraction to handle cases where repo event hasn't\n  loaded yet\n\nLayout Component (+layout.svelte):\n- Remove onMount refresh call that was causing unnecessary repo updates\n- Remove navigation-based refresh calls (afterNavigate/beforeNavigate)\n  that were triggering redundant data fetches\n- Simplify navigation handling to only manage scroll position for issues\n  page\n\nRepository Overview Page (+page.svelte):\n- Optimize commit history loading to use main branch directly instead of\n  trying multiple branch candidates\n- Add graceful error handling for non-cloned repositories - commit history\n  and README are now optional and won't block page load\n- Improve README loading with better error handling that doesn't fail\n  silently but also doesn't block rendering\n- Simplify commit history depth strategy (5 -\u003e 10 -\u003e 25) with early exit\n  on success\n\nCode Page (+code/+page.svelte):\n- Add better error handling and loading states\n\nIssues Page (issues/+page.ts):\n- Refactor to use reactive stores instead of blocking filter loads\n- Improve maintainer-based filtering logic\n\nPatches Page (patches/+page.ts, patches/+page.svelte):\n- Remove blocking load() calls for comments, status events, patches, and\n  pull requests\n- Convert to reactive stores that update as data arrives\n- Pass repoRelays to page component for incremental loading support\n- Simplify filter creation by moving to return object\n\nPatch Detail Page (patches/[patchid]/+page.svelte):\n- Improve error handling and loading states\n\nPerformance Impact:\n- Initial page load no longer blocked by network requests\n- Navigation between repo pages is now instant\n- Reactive stores update UI as data arrives from relays\n- Better user experience with progressive data loading\n- Reduced unnecessary network requests from removed refresh calls\n\nThis change maintains all existing functionality while significantly\nimproving perceived performance and reducing blocking operations.\n---\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |  23 -----------------------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts                     | 284 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte                   |  72 +++++++++++++++++++++++++++++++++++++-----------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte              |  84 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.ts                |  34 +++++++++-------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           |   9 ++++++++-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts               |  40 ++++++++++++++++++----------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte |  27 ++++++++++++++++++++++++++-\n 8 files changed, 396 insertions(+), 177 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 7b1f356..82f9908 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -25,7 +25,6 @@\n   import {load} from \"@welshman/net\"\n   import {Router} from \"@welshman/router\"\n   import {goto, afterNavigate, beforeNavigate} from \"$app/navigation\"\n-  import {onMount} from \"svelte\"\n   import {normalizeRelayUrl, NAMED_BOOKMARKS, makeEvent, Address} from \"@welshman/util\"\n   import PageBar from \"@src/lib/components/PageBar.svelte\"\n   import Button from \"@src/lib/components/Button.svelte\"\n@@ -86,25 +85,14 @@\n     \"#d\": [DEFAULT_GRASP_SET_ID],\n   }\n \n-  // Initial refresh on mount\n-  onMount(() =\u003e {\n-    // Fire and forget; guard prevents overlap\n-    updateRepo()\n-  })\n-\n   // Helper to compute base path for this repo scope\n   function repoBasePath() {\n     return `/spaces/${encodeURIComponent(relay)}/git/${id}`\n   }\n \n-  // Refresh after navigation into any sub-route under this layout\n   afterNavigate(({to}) =\u003e {\n     try {\n       if (!to) return\n-      const base = repoBasePath()\n-      if (to.url.pathname.startsWith(base)) {\n-        updateRepo()\n-      }\n \n       if (to.route.id === \"/spaces/[relay]/git/[id=naddr]/issues\") {\n         // Restore scroll position for issues page\n@@ -127,9 +115,7 @@\n     } catch {}\n   })\n \n-  // Pre-emptive refresh when navigating within the same repo scope\n   beforeNavigate(({from, to}) =\u003e {\n-\n     if (from?.route.id === \"/spaces/[relay]/git/[id=naddr]/issues\") {\n       // Save scroll position when leaving issues page\n       if (pageContentElement) {\n@@ -137,15 +123,6 @@\n         sessionStorage.setItem(scrollStorageKey, scrollPosition.toString())\n       }\n     }\n-\n-    try {\n-      if (!to) return\n-      const base = repoBasePath()\n-      if (to.url.pathname.startsWith(base)) {\n-        // Kick off without awaiting to avoid blocking navigation\n-        Promise.resolve().then(() =\u003e updateRepo())\n-      }\n-    } catch {}\n   })\n \n   const graspServersEvent = _derived(\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nindex 9dc7d8c..ada41f0 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -6,6 +6,10 @@ import {\n   type RepoAnnouncementEvent,\n   type RepoStateEvent,\n   type PullRequestEvent,\n+  type StatusEvent,\n+  type CommentEvent,\n+  type LabelEvent,\n+  isCommentEvent,\n } from \"@nostr-git/shared-types\"\n import {\n   GIT_REPO_ANNOUNCEMENT,\n@@ -13,7 +17,7 @@ import {\n   GIT_PULL_REQUEST,\n   normalizeRelayUrl,\n } from \"@nostr-git/shared-types\"\n-import {GIT_ISSUE, GIT_PATCH, GIT_STATUS_OPEN, GIT_STATUS_DRAFT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE, getTagValue} from \"@welshman/util\"\n+import {GIT_ISSUE, GIT_PATCH, GIT_STATUS_OPEN, GIT_STATUS_DRAFT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE, getTagValue, COMMENT, type TrustedEvent} from \"@welshman/util\"\n import {nthEq} from \"@welshman/lib\"\n import {nip19} from \"nostr-tools\"\n import type {AddressPointer} from \"nostr-tools/nip19\"\n@@ -50,14 +54,15 @@ export const load: LayoutLoad = async ({params}) =\u003e {\n     .map((u: string) =\u003e normalizeRelayUrl(u))\n     .filter(Boolean) as string[]\n \n-  const filters = [\n+  const repoFilters = [\n     {\n       authors: [decoded.pubkey],\n       kinds: [GIT_REPO_STATE, GIT_REPO_ANNOUNCEMENT],\n     },\n   ]\n \n-  await load({relays: relayListFromUrl as string[], filters})\n+  // Start loading repo events immediately (will be used later)\n+  const repoLoadPromise = load({relays: relayListFromUrl as string[], filters: repoFilters})\n \n   const repoEvent = derived(\n     deriveEvents(repository, {\n@@ -122,96 +127,182 @@ export const load: LayoutLoad = async ({params}) =\u003e {\n     return relayListFromUrl\n   })\n \n-  // First, load all repo announcements with the same name to get all related repos\n-  const allReposFilter = {\n-    kinds: [GIT_REPO_ANNOUNCEMENT],\n-    \"#d\": [repoName],\n-  }\n-\n-  await load({\n-    relays: relayListFromUrl as string[],\n-    filters: [allReposFilter],\n-  })\n-\n-  // Extract maintainers and author from repo event for filtering\n+  // Don't block on repo load - start loading in background and return immediately\n+  // The page will render with what we have, and reactive stores will update as data arrives\n+  \n+  // Extract maintainers reactively (non-blocking)\n   const {parseRepoAnnouncementEvent} = await import(\"@nostr-git/shared-types\")\n-\n-  // Wait for repo event to be available\n-  let repoAuthors: string[] = [decoded.pubkey]\n-  const unsubscribe = repoEvent.subscribe(repo =\u003e {\n-    if (repo) {\n+  \n+  // Create reactive repoAuthors that updates when repo event loads\n+  const repoAuthors = derived(repoEvent, (repo) =\u003e {\n+    if (!repo) {\n+      // Fallback to just the pubkey if repo event not loaded yet\n+      return [decoded.pubkey]\n+    }\n+    try {\n       const parsed = parseRepoAnnouncementEvent(repo)\n       const authors = new Set\u003cstring\u003e()\n       authors.add(repo.pubkey) // Author of the repo announcement\n       if (parsed.maintainers) {\n         parsed.maintainers.forEach(m =\u003e authors.add(m))\n       }\n-      repoAuthors = Array.from(authors)\n+      return Array.from(authors)\n+    } catch {\n+      return [decoded.pubkey]\n     }\n   })\n-  unsubscribe()\n \n-  // Filter issues and patches by authors (maintainers + repo author)\n-  const issueFilters = {\n-    kinds: [GIT_ISSUE],\n-    \"#a\": repoAuthors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n-  }\n+  // Create event stores that watch the repository\n+  // These stores watch for events matching the repo address pattern\n+  // When maintainer events are loaded (via the load() call below), they're added to the repository\n+  // The derived stores (issues, patches, etc.) then filter these events based on current authors\n+  const allIssueEvents = deriveEvents(repository, {\n+    filters: [{\n+      kinds: [GIT_ISSUE],\n+      // Note: We filter by repo address in the derived store below, not here\n+      // This allows us to see all events loaded for this repo (owner + maintainers)\n+    }],\n+  })\n \n-  const patchFilters = {\n-    kinds: [GIT_PATCH],\n-    \"#a\": repoAuthors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n-  }\n+  const allPatchEvents = deriveEvents(repository, {\n+    filters: [{\n+      kinds: [GIT_PATCH],\n+    }],\n+  })\n \n-  const pullRequestFilters = {\n-    kinds: [GIT_PULL_REQUEST],\n-    \"#a\": repoAuthors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n-  }\n+  const allPullRequestEvents = deriveEvents(repository, {\n+    filters: [{\n+      kinds: [GIT_PULL_REQUEST],\n+    }],\n+  })\n \n-  const statusFilters = {\n-    kinds: [GIT_STATUS_OPEN, GIT_STATUS_DRAFT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE],\n-    \"#a\": repoAuthors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n-  }\n-  // Load issues and patches\n-  await load({\n-    relays: relayListFromUrl as string[],\n-    filters: [issueFilters, patchFilters, pullRequestFilters, statusFilters],\n+  const allStatusEvents = deriveEvents(repository, {\n+    filters: [{\n+      kinds: [GIT_STATUS_OPEN, GIT_STATUS_DRAFT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE],\n+    }],\n   })\n \n-  // Create derived stores that will include all issues/patches\n-  // The Repo class will filter to only those matching its canonical identity\n-  const issues: Readable\u003cIssueEvent[]\u003e = derived(\n-    deriveEvents(repository, {\n-      filters: [issueFilters],\n+  // Load initial data in background (don't await - let it load asynchronously)\n+  const allReposFilter = {\n+    kinds: [GIT_REPO_ANNOUNCEMENT],\n+    \"#d\": [repoName],\n+  }\n+\n+  // Start loading with initial authors\n+  Promise.all([\n+    repoLoadPromise,\n+    load({\n+      relays: relayListFromUrl as string[],\n+      filters: [allReposFilter],\n+    }),\n+    load({\n+      relays: relayListFromUrl as string[],\n+      filters: [\n+        {\n+          kinds: [GIT_ISSUE],\n+          \"#a\": [`${GIT_REPO_ANNOUNCEMENT}:${decoded.pubkey}:${repoName}`],\n+        },\n+        {\n+          kinds: [GIT_PATCH],\n+          \"#a\": [`${GIT_REPO_ANNOUNCEMENT}:${decoded.pubkey}:${repoName}`],\n+        },\n+        {\n+          kinds: [GIT_PULL_REQUEST],\n+          \"#a\": [`${GIT_REPO_ANNOUNCEMENT}:${decoded.pubkey}:${repoName}`],\n+        },\n+        {\n+          kinds: [GIT_STATUS_OPEN, GIT_STATUS_DRAFT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE],\n+          \"#a\": [`${GIT_REPO_ANNOUNCEMENT}:${decoded.pubkey}:${repoName}`],\n+        },\n+      ],\n     }),\n-    events =\u003e (events || []) as IssueEvent[],\n+  ]).then(() =\u003e {\n+    // Reactively load data when authors change (including when maintainers are discovered)\n+    // This subscription will be cleaned up automatically when the route changes\n+    repoAuthors.subscribe((authors) =\u003e {\n+      // Only load if we have more than just the initial pubkey\n+      if (authors.length \u003e 1) {\n+        // Maintainers loaded, load with full author list\n+        load({\n+          relays: relayListFromUrl as string[],\n+          filters: [\n+            {\n+              kinds: [GIT_ISSUE],\n+              \"#a\": authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n+            },\n+            {\n+              kinds: [GIT_PATCH],\n+              \"#a\": authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n+            },\n+            {\n+              kinds: [GIT_PULL_REQUEST],\n+              \"#a\": authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n+            },\n+            {\n+              kinds: [GIT_STATUS_OPEN, GIT_STATUS_DRAFT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE],\n+              \"#a\": authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`),\n+            },\n+          ],\n+        }).catch(() =\u003e {}) // Ignore errors - this is background loading\n+      }\n+    })\n+  }).catch(() =\u003e {}) // Don't block on errors\n+\n+  // Create derived stores that filter events reactively based on current authors\n+  // This ensures we include events from maintainers when they're discovered\n+  // Layer 2: Filter events by repo address (owner + maintainers)\n+  // The address tag format is: [\"a\", \"kind:pubkey:identifier\"]\n+  // So we check if the event's address matches any of our current authors' addresses\n+  const issues: Readable\u003cIssueEvent[]\u003e = derived(\n+    [allIssueEvents, repoAuthors],\n+    ([events, authors]) =\u003e {\n+      const authorAddresses = new Set(authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`))\n+      return (events || []).filter((event: TrustedEvent) =\u003e {\n+        const addressTag = event.tags.find((t: string[]) =\u003e t[0] === \"a\")\n+        // Check if event's address matches any of our current authors (owner + maintainers)\n+        return addressTag \u0026\u0026 authorAddresses.has(addressTag[1])\n+      }) as IssueEvent[]\n+    },\n   )\n \n   const patches: Readable\u003cPatchEvent[]\u003e = derived(\n-    deriveEvents(repository, {\n-      filters: [patchFilters],\n-    }),\n-    events =\u003e (events || []) as PatchEvent[],\n+    [allPatchEvents, repoAuthors],\n+    ([events, authors]) =\u003e {\n+      const authorAddresses = new Set(authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`))\n+      return (events || []).filter((event: TrustedEvent) =\u003e {\n+        const addressTag = event.tags.find((t: string[]) =\u003e t[0] === \"a\")\n+        return addressTag \u0026\u0026 authorAddresses.has(addressTag[1])\n+      }) as PatchEvent[]\n+    },\n   )\n \n   const pullRequests: Readable\u003cPullRequestEvent[]\u003e = derived(\n-    deriveEvents(repository, {\n-      filters: [pullRequestFilters],\n-    }),\n-    events =\u003e (events || []) as PullRequestEvent[],\n+    [allPullRequestEvents, repoAuthors],\n+    ([events, authors]) =\u003e {\n+      const authorAddresses = new Set(authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`))\n+      return (events || []).filter((event: TrustedEvent) =\u003e {\n+        const addressTag = event.tags.find((t: string[]) =\u003e t[0] === \"a\")\n+        return addressTag \u0026\u0026 authorAddresses.has(addressTag[1])\n+      }) as PullRequestEvent[]\n+    },\n   )\n \n-  const statusEvents: Readable\u003cany[]\u003e = derived(\n-    deriveEvents(repository, {\n-      filters: [statusFilters],\n-    }),\n-    events =\u003e events || [],\n+  const statusEvents: Readable\u003cStatusEvent[]\u003e = derived(\n+    [allStatusEvents, repoAuthors],\n+    ([events, authors]) =\u003e {\n+      const authorAddresses = new Set(authors.map(a =\u003e `${GIT_REPO_ANNOUNCEMENT}:${a}:${repoName}`))\n+      return (events || []).filter((event: TrustedEvent) =\u003e {\n+        const addressTag = event.tags.find((t: string[]) =\u003e t[0] === \"a\")\n+        return addressTag \u0026\u0026 authorAddresses.has(addressTag[1])\n+      }) as StatusEvent[]\n+    },\n   )\n \n   // Create statusEventsByRoot map\n-  const statusEventsByRoot: Readable\u003cMap\u003cstring, any[]\u003e\u003e = derived(\n+  const statusEventsByRoot: Readable\u003cMap\u003cstring, StatusEvent[]\u003e\u003e = derived(\n     statusEvents,\n     events =\u003e {\n-      const map = new Map\u003cstring, any[]\u003e()\n+      const map = new Map\u003cstring, StatusEvent[]\u003e()\n       for (const event of events) {\n         const rootId = getTagValue(\"e\", event.tags)\n         if (rootId) {\n@@ -225,16 +316,73 @@ export const load: LayoutLoad = async ({params}) =\u003e {\n     }\n   )\n \n-  const emptyArr = derived([], () =\u003e [] as any[])\n+  // Get all root IDs from issues, patches, and PRs reactively\n+  const allRootIds = derived([issues, patches, pullRequests], ([issueEvents, patchEvents, prEvents]) =\u003e {\n+    const ids: string[] = []\n+    if (issueEvents) ids.push(...issueEvents.map((issue: IssueEvent) =\u003e issue.id))\n+    if (patchEvents) ids.push(...patchEvents.map((patch: PatchEvent) =\u003e patch.id))\n+    if (prEvents) ids.push(...prEvents.map((pr: PullRequestEvent) =\u003e pr.id))\n+    return ids\n+  })\n+\n+  // Create comment events store that filters comments by root IDs\n+  // We use a broad filter and then filter reactively based on root IDs\n+  const allCommentEvents = deriveEvents(repository, {\n+    filters: [{\n+      kinds: [COMMENT],\n+    }],\n+  })\n+\n+  const commentEvents: Readable\u003cCommentEvent[]\u003e = derived(\n+    [allCommentEvents, allRootIds],\n+    ([events, rootIds]) =\u003e {\n+      if (rootIds.length === 0) return []\n+      // Filter to only comments that reference our root IDs\n+      return (events || []).filter((event) =\u003e {\n+        const eTags = event.tags.filter((t: string[]) =\u003e t[0] === \"E\" || t[0] === \"e\")\n+        return eTags.some((tag: string[]) =\u003e rootIds.includes(tag[1]))\n+      }).filter(isCommentEvent) as CommentEvent[]\n+    },\n+  )\n+\n+  // Load comments reactively when root IDs are available\n+  // Use a derived store with a side effect to trigger loading\n+  let lastLoadedIds = new Set\u003cstring\u003e()\n+  const commentLoadTrigger = derived(allRootIds, (rootIds) =\u003e {\n+    if (rootIds.length \u003e 0) {\n+      const idsKey = rootIds.sort().join(',')\n+      if (!lastLoadedIds.has(idsKey)) {\n+        lastLoadedIds.add(idsKey)\n+        // Trigger load in background (non-blocking)\n+        load({\n+          relays: relayListFromUrl as string[],\n+          filters: [{\n+            kinds: [COMMENT],\n+            \"#E\": rootIds,\n+          }],\n+        }).catch(() =\u003e {}) // Ignore errors - this is background loading\n+      }\n+    }\n+    return rootIds\n+  })\n+\n+  // Subscribe to trigger the load (this is necessary to trigger the derived store)\n+  // This subscription will be cleaned up automatically when the route changes\n+  commentLoadTrigger.subscribe(() =\u003e {\n+    // The actual loading is handled in the derived store above\n+  })\n+\n+  const emptyRepoStateEvents = derived([], () =\u003e [] as RepoStateEvent[])\n+  const emptyLabelEvents = derived([], () =\u003e [] as LabelEvent[])\n   const repoClass = new Repo({\n     repoEvent,\n     repoStateEvent,\n     issues,\n     patches,\n-    repoStateEvents: emptyArr as unknown as Readable\u003cany[]\u003e,\n+    repoStateEvents: emptyRepoStateEvents as unknown as Readable\u003cRepoStateEvent[]\u003e,\n     statusEvents,\n-    commentEvents: emptyArr as unknown as Readable\u003cany[]\u003e,\n-    labelEvents: emptyArr as unknown as Readable\u003cany[]\u003e,\n+    commentEvents,\n+    labelEvents: emptyLabelEvents as unknown as Readable\u003cLabelEvent[]\u003e,\n   })\n \n   return {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex a97eb7f..ef57fa5 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -179,7 +179,7 @@\n   $effect(() =\u003e {\n     if (repoClass) {\n       // Load async data in parallel\n-      loadRepoInfo()\n+        loadRepoInfo()\n     }\n   })\n \n@@ -223,6 +223,8 @@\n \n   async function loadReadme() {\n     try {\n+      // Try to get README - if repo not cloned, that's okay (overview doesn't need clone)\n+      // The getFileContent will attempt to fetch, but won't block if it fails\n       const readmeContent = await repoClass.getFileContent({\n         path: \"README.md\",\n         branch: repoClass.mainBranch?.split(\"/\").pop() || \"master\",\n@@ -231,6 +233,9 @@\n       readme = readmeContent.content\n       renderedReadme = readme ? md.render(readme) : \"\"\n     } catch (e) {\n+      // Silently fail - README is optional and shouldn't block page load\n+      // If repo not cloned, user can still see overview without README\n+      console.debug(\"README: Failed to load (repo may not be cloned, which is fine for overview)\", e)\n     } finally {\n       readmeLoading = false\n     }\n@@ -238,45 +243,41 @@\n \n   async function loadLastCommit() {\n     try {\n-      // Assume Repo already initialized; avoid triggering repo updates here\n-      // Build candidate branches to try in order\n-      const shortMain = repoClass.mainBranch\n-        ? repoClass.mainBranch.split(\"/\").pop() || repoClass.mainBranch\n-        : undefined\n-      const fullMain = repoClass.mainBranch || undefined\n-      const firstBranch = repoClass.branches?.[0]?.name\n-      const candidates = Array.from(new Set([shortMain, fullMain, firstBranch].filter(Boolean))) as string[]\n-      console.debug(\"LatestCommit candidates\", { shortMain, fullMain, firstBranch, candidates })\n-\n-      // Try a few depths to accommodate shallow clones\n-      const depths = [5, 10, 25]\n+      // Use main branch directly - no need to try multiple branches\n+      // Start with small depth (5) for faster loading, only increase if needed\n+      const mainBranch = repoClass.mainBranch\n+      if (!mainBranch) {\n+        commitLoading = false\n+        return\n+      }\n \n-      for (const branchName of candidates) {\n-        for (const depth of depths) {\n-          try {\n-            const res = await repoClass.getCommitHistory({ branch: branchName, depth })\n-            const list = Array.isArray(res) ? res : res?.commits\n-            console.debug(\"LatestCommit attempt\", { branchName, depth, count: list?.length })\n-            if (Array.isArray(list) \u0026\u0026 list.length \u003e 0) {\n-              lastCommit = list[0]\n-              return\n-            }\n-          } catch (e) {\n-            console.debug(\"LatestCommit attempt failed\", { branchName, depth, error: String(e) })\n+      // Try depth 5 first (fast), then 10 if needed, then 25 as fallback\n+      const depths = [5, 10, 25]\n+      \n+      for (const depth of depths) {\n+        try {\n+          const res = await repoClass.getCommitHistory({ branch: mainBranch, depth })\n+          const list = Array.isArray(res) ? res : res?.commits\n+          if (Array.isArray(list) \u0026\u0026 list.length \u003e 0) {\n+            lastCommit = list[0]\n+            commitLoading = false\n+            return\n           }\n+        } catch (e) {\n+          // If repo not cloned, that's okay - commit history is optional for overview\n+          // Don't trigger clone just for commit history\n+          if (String(e).includes(\"not cloned\") || String(e).includes(\"Repository not\")) {\n+            console.debug(\"LatestCommit: Repository not cloned, skipping (overview page doesn't need clone)\")\n+            commitLoading = false\n+            return\n+          }\n+          // Try next depth on other errors\n+          console.debug(\"LatestCommit attempt failed\", { depth, error: String(e) })\n         }\n       }\n-      // Final fallback: let Repo resolve the branch internally\n-      try {\n-        const res = await repoClass.getCommitHistory({ depth: 25 } as any)\n-        const list = Array.isArray(res) ? res : res?.commits\n-        console.debug(\"LatestCommit final fallback\", { count: list?.length })\n-        if (Array.isArray(list) \u0026\u0026 list.length \u003e 0) {\n-          lastCommit = list[0]\n-          return\n-        }\n-      } catch {}\n     } catch (e) {\n+      // Silently fail - commit history is optional\n+      console.debug(\"LatestCommit: Failed to load\", e)\n     } finally {\n       commitLoading = false\n     }\n@@ -727,3 +728,4 @@\n     {/if}\n   {/if}\n \u003c/div\u003e\n+\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex f791a9c..e668727 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -14,6 +14,11 @@\n   let error: string | null = $state(null)\n   let files: Promise\u003cFileEntry[]\u003e = $state(Promise.resolve([]))\n   let path = $state\u003cstring | undefined\u003e(undefined)\n+  \n+  // Clone progress state - only show when actually cloning\n+  let isCloning = $state(false)\n+  let cloneProgress = $state\u003cstring\u003e(\"\")\n+  let cloneProgressPercent = $state\u003cnumber | undefined\u003e(undefined)\n \n   const rootDir: FileEntry = $state({\n     name: \".\",\n@@ -45,9 +50,68 @@\n     $state([])\n   let loadingRefs = $state(true)\n \n+  // Check if repo is cloned and clone if needed (only on code tab)\n+  $effect(() =\u003e {\n+    if (!repoClass || !repoClass.workerManager?.isReady) return\n+    \n+    ;(async () =\u003e {\n+      try {\n+        const isCloned = await repoClass.workerManager.isRepoCloned({\n+          repoId: repoClass.key\n+        })\n+        \n+        if (!isCloned) {\n+          // Show clone progress\n+          isCloning = true\n+          cloneProgress = \"Initializing repository...\"\n+          \n+          // Set up progress callback using WorkerManager's API\n+          const originalCallback = repoClass.workerManager.setProgressCallback.bind(repoClass.workerManager)\n+          repoClass.workerManager.setProgressCallback((progressEvent) =\u003e {\n+            if (progressEvent.repoId === repoClass.key) {\n+              cloneProgress = progressEvent.phase || \"Cloning repository...\"\n+              cloneProgressPercent = progressEvent.progress\n+            }\n+          })\n+          \n+          try {\n+            const cloneUrls = repoClass.cloneUrls\n+            if (cloneUrls.length === 0) {\n+              throw new Error(\"No clone URLs found for repository\")\n+            }\n+            \n+            const result = await repoClass.workerManager.smartInitializeRepo({\n+              repoId: repoClass.key,\n+              cloneUrls,\n+              forceUpdate: false\n+            })\n+            \n+            if (!result.success) {\n+              throw new Error(result.error || \"Repository initialization failed\")\n+            }\n+          } finally {\n+            // Restore original callback (or clear it)\n+            repoClass.workerManager.setProgressCallback(() =\u003e {})\n+            isCloning = false\n+            cloneProgress = \"\"\n+            cloneProgressPercent = undefined\n+          }\n+        }\n+      } catch (error) {\n+        console.error(\"Failed to initialize repository:\", error)\n+        pushToast({\n+          message: `Failed to initialize repository: ${error instanceof Error ? error.message : \"Unknown error\"}`,\n+          theme: \"error\",\n+        })\n+        isCloning = false\n+        error = error instanceof Error ? error.message : \"Failed to initialize repository\"\n+      }\n+    })()\n+  })\n+\n   // Load refs using the unified API\n   $effect(() =\u003e {\n-    if (repoClass) {\n+    if (repoClass \u0026\u0026 !isCloning) {\n       loadingRefs = true\n       repoClass\n         .getAllRefsWithFallback()\n@@ -161,7 +225,23 @@\n \n \u003cdiv class=\"mt-2 rounded-lg border border-border bg-card\"\u003e\n   \u003cdiv class=\"p-4\"\u003e\n-    {#if loading}\n+    {#if isCloning}\n+      \u003cdiv class=\"flex flex-col items-center justify-center py-12 space-y-4\"\u003e\n+        \u003cSpinner\u003eCloning repository...\u003c/Spinner\u003e\n+        \u003cdiv class=\"text-center space-y-2\"\u003e\n+          \u003cp class=\"text-lg font-medium\"\u003e{cloneProgress}\u003c/p\u003e\n+          {#if cloneProgressPercent !== undefined}\n+            \u003cdiv class=\"w-64 bg-gray-200 rounded-full h-2.5 dark:bg-gray-700\"\u003e\n+              \u003cdiv \n+                class=\"bg-blue-600 h-2.5 rounded-full transition-all duration-300\" \n+                style=\"width: {Math.round(cloneProgressPercent * 100)}%\"\n+              \u003e\u003c/div\u003e\n+            \u003c/div\u003e\n+            \u003cp class=\"text-sm text-muted-foreground\"\u003e{Math.round(cloneProgressPercent * 100)}%\u003c/p\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    {:else if loading}\n       \u003cSpinner {loading}\u003eLoading files...\u003c/Spinner\u003e\n     {:else if error}\n       \u003cdiv class=\"text-red-500\"\u003e{error}\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.ts b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.ts\nindex eb35dcb..e70dffd 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.ts\n@@ -17,12 +17,6 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n   const {repoClass} = await parent()\n   const {deriveEvents} = await import(\"@welshman/store\")\n   const {repository} = await import(\"@welshman/app\")\n-  const {load} = await import(\"@welshman/net\")\n-\n-  const commentFilter = {\n-    kinds: [COMMENT],\n-    \"#E\": [...repoClass.issues.map((issue: IssueEvent) =\u003e issue.id)],\n-  }\n \n   const statusEventFilter = {\n     kinds: [\n@@ -34,22 +28,20 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n     \"#e\": [...repoClass.issues.map((issue: IssueEvent) =\u003e issue.id)],\n   }\n \n-\n-  console.log(repoClass.repoEvent)\n-  const issueFilter = {\n-    kinds: [GIT_ISSUE],\n-    \"#a\": [Address.fromEvent(repoClass.repoEvent!).toString()],\n-  }\n-\n   const statusEvents = deriveEvents(repository, {filters: [statusEventFilter]})\n \n   const comments = derived(\n-    deriveEvents(repository, {filters: [commentFilter]}),\n+    deriveEvents(repository, {\n+      filters: [{\n+        kinds: [COMMENT],\n+        \"#E\": [...repoClass.issues.map((issue: IssueEvent) =\u003e issue.id)],\n+      }],\n+    }),\n     events =\u003e events.filter(isCommentEvent) as CommentEvent[],\n   )\n \n-  // Group status events by root ID for easier lookup\n-  const statusEventsByRoot = derived(statusEvents, events =\u003e {\n+  // Group status events by root ID for easier lookup (reactive, loads as events arrive)\n+  const localStatusEventsByRoot = derived(statusEvents, events =\u003e {\n     const map = new Map\u003cstring, any[]\u003e()\n     for (const event of events) {\n       const rootTag = event.tags.find((t: string[]) =\u003e t[0] === \"e\" \u0026\u0026 t[3] === \"root\")\n@@ -64,18 +56,10 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n     return map\n   })\n \n-  await load({\n-    relays: repoClass.relays,\n-    filters: [commentFilter, statusEventFilter, issueFilter],\n-  })\n-\n   return {\n     comments,\n     statusEvents,\n-    statusEventsByRoot,\n-    issueFilter,\n-    commentFilter,\n-    statusEventFilter,\n+    statusEventsByRoot: localStatusEventsByRoot, // Reactive store that loads as events arrive\n     repoRelays: repoClass.relays,\n   }\n }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 2aa05f2..a5edd0c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -229,7 +229,7 @@\n   }\n \n   $effect(() =\u003e {\n-    if (repoClass.patches) {\n+    if (repoClass.patches \u0026\u0026 patchFilter \u0026\u0026 pullRequestFilter) {\n       const tryStart = () =\u003e {\n         if (element) {\n           makeFeed({\n@@ -247,6 +247,13 @@\n         }\n       }\n       tryStart()\n+      // Set loading to false immediately if we have patches already\n+      // makeFeed will handle incremental loading\n+      if (patchList.length \u003e 0) {\n+        loading = false\n+      }\n+    } else if (repoClass.patches \u0026\u0026 repoClass.patches.length === 0) {\n+      // No patches, so we're done loading\n       loading = false\n     }\n   })\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\nindex fe52436..b4ee3ba 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.ts\n@@ -22,12 +22,6 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n   const {repoClass, pullRequests} = await parent()\n   const {deriveEvents} = await import(\"@welshman/store\")\n   const {repository} = await import(\"@welshman/app\")\n-  const {load} = await import(\"@welshman/net\")\n-\n-  const commentFilter = {\n-    kinds: [COMMENT],\n-    \"#E\": [...repoClass.patches.map((patch: PatchEvent) =\u003e patch.id)],\n-  }\n \n   const statusEventFilter = {\n     kinds: [\n@@ -39,25 +33,15 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n     \"#e\": [...repoClass.patches.map((patch: PatchEvent) =\u003e patch.id)],\n   }\n \n-  const patchFilter = {\n-    kinds: [GIT_PATCH],\n-    \"#a\": [Address.fromEvent(repoClass.repoEvent!).toString()],\n-  }\n-\n-  const pullRequestFilter = {\n-    kinds: [GIT_PULL_REQUEST],\n-    \"#a\": [Address.fromEvent(repoClass.repoEvent!).toString()],\n-  }\n-\n-  await load({\n-    relays: repoClass.relays,\n-    filters: [commentFilter, statusEventFilter, patchFilter, pullRequestFilter],\n-  })\n-\n   const statusEvents = deriveEvents(repository, {filters: [statusEventFilter]})\n \n   const comments = derived(\n-    deriveEvents(repository, {filters: [commentFilter]}),\n+    deriveEvents(repository, {\n+      filters: [{\n+        kinds: [COMMENT],\n+        \"#E\": [...repoClass.patches.map((patch: PatchEvent) =\u003e patch.id)],\n+      }],\n+    }),\n     events =\u003e events.filter(isCommentEvent) as CommentEvent[],\n   )\n \n@@ -79,6 +63,17 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n \n   const uniqueAuthors = new Set(repoClass.patches.map((patch: PatchEvent) =\u003e patch.pubkey))\n \n+  // Create filters for makeFeed (needed for incremental loading)\n+  const patchFilter = {\n+    kinds: [GIT_PATCH],\n+    \"#a\": [Address.fromEvent(repoClass.repoEvent!).toString()],\n+  }\n+\n+  const pullRequestFilter = {\n+    kinds: [GIT_PULL_REQUEST],\n+    \"#a\": [Address.fromEvent(repoClass.repoEvent!).toString()],\n+  }\n+\n   return {\n     comments,\n     statusEvents,\n@@ -86,5 +81,6 @@ export const load: PageLoad = async ({ parent }) =\u003e {\n     patchFilter,\n     pullRequestFilter,\n     uniqueAuthors,\n+    repoRelays: repoClass.relays,\n   }\n }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 2513509..779274c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -499,10 +499,35 @@\n     showMergeDialog = false\n     isMerging = true\n     mergeProgress = 0\n-    mergeStep = \"Preparing merge...\"\n+    mergeStep = \"Ensuring latest repository state...\"\n     mergeError = null\n     mergeSuccess = false\n \n+    // Strategic sync point: Ensure we have latest state before merging\n+    try {\n+      const cloneUrls = repoClass.cloneUrls\n+      if (cloneUrls.length \u003e 0) {\n+        mergeStep = \"Syncing with remote...\"\n+        mergeProgress = 5\n+        const syncResult = await repoClass.workerManager.syncWithRemote({\n+          repoId: repoClass.key,\n+          cloneUrls,\n+          branch: repoClass.mainBranch,\n+        })\n+        \n+        if (!syncResult.success \u0026\u0026 !syncResult.error?.includes(\"Repository not cloned\")) {\n+          console.warn(\"Sync before merge had issues, but continuing:\", syncResult.error)\n+          // Don't fail merge if sync has issues - continue with current state\n+        }\n+      }\n+    } catch (syncError) {\n+      console.warn(\"Failed to sync before merge, but continuing:\", syncError)\n+      // Don't fail merge if sync fails - continue with current state\n+    }\n+\n+    mergeStep = \"Preparing merge...\"\n+    mergeProgress = 10\n+\n     // Get user profile for commit author\n     const authorName = \"Repository Maintainer\" // You might want to get this from user profile\n     const authorEmail = \"maintainer@nostr-git.local\" // You might want to get this from user profile\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-d03uhbpp","title":"From 4be873911f39f1bc9273fb5c0fe560b3ec300fa4 Mon Sep 17 00:00:00 2001","description":"From 4be873911f39f1bc9273fb5c0fe560b3ec300fa4 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Tue, 18 Nov 2025 12:20:34 +0500\nSubject: [PATCH 2/4] feat: improve patch detail page markdown rendering and mobile responsiveness\n\n- Add markdown preprocessing utility to handle escaped newlines\n  - Create preprocessMarkdown() function in util.ts to convert literal \\n to actual newlines\n  - Enables proper rendering of markdown content with escaped line breaks\n\n- Enhance markdown styling in app.css\n  - Add .markdown-content styles for better code block handling\n  - Implement word-break and overflow-wrap for inline code\n  - Add proper overflow handling for pre blocks\n  - Ensure code blocks maintain proper whitespace\n\n- Improve patch detail page UI/UX\n  - Enable markdown breaks option for better line break rendering\n  - Add title truncation with ellipsis for long patch titles\n  - Replace @nostr-git/ui Profile component with local Profile component\n  - Apply prose classes for better markdown typography\n\n- Enhance mobile responsiveness\n  - Convert fixed layouts to responsive flex/grid layouts\n  - Add mobile-first breakpoints (sm:) throughout the page\n  - Improve navigation controls for mobile (hide text labels, show icons)\n  - Make commit hash and branch names break properly on small screens\n  - Adjust padding and spacing for mobile devices\n  - Improve stats display with responsive text sizes\n  - Better handling of long titles and metadata on mobile\n\n- Code quality improvements\n  - Remove unused Profile import from @nostr-git/ui\n  - Add proper title attributes for truncated text\n  - Improve code block display with break-all for long hashes\n  - Better spacing and layout consistency\n\n- Update nostr-git submodule to latest version\n---\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex cbdb94a..1118ba0 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -19,7 +19,7 @@\n     User,\n     X,\n   } from \"@lucide/svelte\"\n-  import {Button, Profile, MergeStatus, toast, Status} from \"@nostr-git/ui\"\n+  import {Button, MergeStatus, toast, Status} from \"@nostr-git/ui\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import {DiffViewer, IssueThread, MergeAnalyzer, PatchViewer} from \"@nostr-git/ui\"\n   import {pubkey, repository} from \"@welshman/app\"\n@@ -58,6 +58,7 @@\n   import {normalizeRelayUrl} from \"@welshman/util\"\n   import {profilesByPubkey, profileSearch, loadProfile} from \"@welshman/app\"\n   import {deriveRoleAssignments} from \"@lib/budabit\"\n+  import Profile from \"@src/app/components/Profile.svelte\"\n   import {preprocessMarkdown} from \"@lib/util\"\n \n   const {data}: LayoutProps = $props()\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-d4gu64wm","title":"From fdf1f57126e9cb86291c63f1477ba589e82b5bc3 Mon Sep 17 00:00:00 2001","description":"From fdf1f57126e9cb86291c63f1477ba589e82b5bc3 Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/1] feature: add feed to git repo\n\nThis patch adds a feed to each Git Rep consisting of all of the incomming issues, patches and comments","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-dfq1xbuq","title":"From 85ca50d66405a3eb658bff6483d47c7226a34591 Mon Sep 17 00:00:00 2001","description":"From 85ca50d66405a3eb658bff6483d47c7226a34591 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Tue, 27 May 2025 15:30:39 -0700\nSubject: [PATCH 3/67] Remove unmanaged groups\n\n---\n src/app/state.ts | 140 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------------------------------------------------------------------------------\n 1 file changed, 59 insertions(+), 81 deletions(-)\n\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 811e785..c59c50d 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -15,6 +15,7 @@ import {\n   memoize,\n   addToMapKey,\n   identity,\n+  groupBy,\n   always,\n } from \"@welshman/lib\"\n import {load} from \"@welshman/net\"\n@@ -505,109 +506,86 @@ export const chatSearch = derived(chats, $chats =\u003e\n \n // Messages\n \n-export const messages = derived(\n-  deriveEvents(repository, {filters: [{kinds: [MESSAGE]}]}),\n-  $events =\u003e $events,\n-)\n-\n-// Nip29\n-\n-export const groupMeta = deriveEvents(repository, {filters: [{kinds: [GROUP_META]}]})\n-\n-export const hasNip29 = (relay?: Relay) =\u003e\n-  relay?.profile?.supported_nips?.map?.(String)?.includes?.(\"29\")\n+export const messages = deriveEvents(repository, {filters: [{kinds: [MESSAGE]}]})\n \n // Channels\n \n-export type ChannelMeta = {\n+export type Channel = {\n+  id: string\n+  url: string\n+  room: string\n+  name: string\n+  event: TrustedEvent\n   access: \"public\" | \"private\"\n   membership: \"open\" | \"closed\"\n   picture?: string\n   about?: string\n }\n \n-export type Channel = {\n-  url: string\n-  room: string\n-  name: string\n-  meta?: ChannelMeta\n-}\n+export const makeChannelId = (url: string, room: string) =\u003e `${url}'${room}`\n \n-export const makeChannelId = (url: string, room: string) =\u003e `${url}|${room}`\n-\n-export const splitChannelId = (id: string) =\u003e id.split(\"|\")\n-\n-export const channelsById = withGetter(\n-  derived(\n-    [groupMeta, memberships, messages, getUrlsForEvent],\n-    ([$groupMeta, $memberships, $messages, $getUrlsForEvent]) =\u003e {\n-      const channelsById = new Map\u003cstring, Channel\u003e()\n-      // Add meta using group meta events\n-      for (const event of $groupMeta) {\n-        const meta = fromPairs(event.tags)\n-        const room = meta.d\n-        if (room) {\n-          for (const url of $getUrlsForEvent(event.id)) {\n-            const id = makeChannelId(url, room)\n-\n-            channelsById.set(id, {\n-              url,\n-              room,\n-              name: meta.name || room,\n-              meta: {\n-                access: meta.private ? \"private\" : \"public\",\n-                membership: meta.closed ? \"closed\" : \"open\",\n-                picture: meta.picture,\n-                about: meta.about,\n-              },\n-            })\n-          }\n-        }\n-      }\n+export const splitChannelId = (id: string) =\u003e id.split(\"'\")\n \n-      // Add known rooms based on membership events\n-      for (const membership of $memberships) {\n-        for (const {url, room, name} of getMembershipRooms(membership)) {\n-          const id = makeChannelId(url, room)\n+export const hasNip29 = (relay?: Relay) =\u003e\n+  relay?.profile?.supported_nips?.map?.(String)?.includes?.(\"29\")\n \n-          if (!channelsById.has(id)) {\n-            channelsById.set(id, {url, room, name})\n-          }\n-        }\n-      }\n+export const channelEvents = deriveEvents(repository, {filters: [{kinds: [GROUP_META]}]})\n+\n+export const channels = derived(\n+  [channelEvents, getUrlsForEvent],\n+  ([$channelEvents, $getUrlsForEvent]) =\u003e {\n+    const $channels: Channel[] = []\n \n-      // Add rooms based on known messages\n-      for (const event of $messages) {\n-        const [_, room] = event.tags.find(nthEq(0, ROOM)) || []\n+    for (const event of $channelEvents) {\n+      const meta = fromPairs(event.tags)\n+      const room = meta.d\n \n-        if (room) {\n-          for (const url of $getUrlsForEvent(event.id)) {\n-            const id = makeChannelId(url, room)\n+      if (room) {\n+        for (const url of $getUrlsForEvent(event.id)) {\n+          const id = makeChannelId(url, room)\n \n-            if (!channelsById.has(id)) {\n-              channelsById.set(id, {url, room, name: room})\n-            }\n-          }\n+          $channels.push({\n+            id,\n+            url,\n+            room,\n+            event,\n+            name: meta.name || room,\n+            access: meta.private ? \"private\" : \"public\",\n+            membership: meta.closed ? \"closed\" : \"open\",\n+            picture: meta.picture,\n+            about: meta.about,\n+          })\n         }\n       }\n+    }\n \n-      return channelsById\n-    },\n-  ),\n+    return $channels\n+  },\n )\n \n-export const deriveChannel = (url: string, room: string) =\u003e\n-  derived(channelsById, $channelsById =\u003e $channelsById.get(makeChannelId(url, room)))\n+export const channelsByUrl = derived(channels, $channels =\u003e groupBy(c =\u003e c.url, $channels))\n \n-export const channelsByUrl = derived(channelsById, $channelsById =\u003e {\n-  const $channelsByUrl = new Map\u003cstring, Channel[]\u003e()\n+export const {\n+  indexStore: channelsById,\n+  deriveItem: _deriveChannel,\n+  loadItem: _loadChannel,\n+} = collection({\n+  name: \"channels\",\n+  store: channels,\n+  getKey: channel =\u003e channel.id,\n+  load: async (id: string) =\u003e {\n+    const [url, room] = splitChannelId(id)\n+\n+    await load({\n+      relays: [url],\n+      filters: [{kinds: [GROUP_META], \"#d\": [room]}],\n+    })\n+  },\n+})\n \n-  for (const channel of $channelsById.values()) {\n-    pushToMapKey($channelsByUrl, channel.url, channel)\n-  }\n+export const deriveChannel = (url: string, room: string) =\u003e _deriveChannel(makeChannelId(url, room))\n \n-  return $channelsByUrl\n-})\n+export const loadChannel = (url: string, room: string) =\u003e _loadChannel(makeChannelId(url, room))\n \n export const displayChannel = (url: string, room: string) =\u003e\n   channelsById.get().get(makeChannelId(url, room))?.name || room\n@@ -616,7 +594,7 @@ export const roomComparator = (url: string) =\u003e (room: string) =\u003e\n   displayChannel(url, room).toLowerCase()\n \n export const channelIsLocked = (channel?: Channel) =\u003e\n-  channel?.meta?.access === \"private\" \u0026\u0026 channel?.meta?.membership === \"closed\"\n+  channel?.access === \"private\" \u0026\u0026 channel?.membership === \"closed\"\n \n // User stuff\n \n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-dg3jc3ki","title":"High memory consumption: Probably a memory leak","description":"I have navigated to mostly only flotilla-budabit repo and have NOT browsed the code, still the app consumed 2Gigs of memory after leaving it out for a couple hours and working in it every now and then.\n\nhttps://i.nostr.build/lKucgnslKtI9SRq7.png","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","enhancement","issue","performance"]}
{"id":"flotilla-djpiceo6","title":"From beda279f8b549e64abaf25962c31bfaafc4d4b96 Mon Sep 17 00:00:00 2001","description":"From beda279f8b549e64abaf25962c31bfaafc4d4b96 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 15 Apr 2025 16:51:59 +1000\nSubject: [PATCH] added Permalink extension to editor\n\n---\n package.json            | 3 ++-\n src/app/editor/index.ts | 7 +++++++\n 2 files changed, 9 insertions(+), 1 deletion(-)\n\ndiff --git a/package.json b/package.json\nindex 39f341f..53dd566 100644\n--- a/package.json\n+++ b/package.json\n@@ -48,6 +48,7 @@\n     \"@sentry/browser\": \"^8.35.0\",\n     \"@sveltejs/adapter-static\": \"^3.0.4\",\n     \"@types/qrcode\": \"^1.5.5\",\n+    \"@types/throttle-debounce\": \"^5.0.2\",\n     \"@vite-pwa/assets-generator\": \"^0.2.6\",\n     \"@vite-pwa/sveltekit\": \"^0.6.6\",\n     \"@welshman/app\": \"~0.0.42\",\n@@ -60,7 +61,6 @@\n     \"@welshman/signer\": \"~0.0.20\",\n     \"@welshman/store\": \"~0.0.16\",\n     \"@welshman/util\": \"~0.0.61\",\n-    \"@types/throttle-debounce\": \"^5.0.2\",\n     \"daisyui\": \"^4.12.10\",\n     \"date-picker-svelte\": \"^2.13.0\",\n     \"dotenv\": \"^16.4.5\",\n@@ -68,6 +68,7 @@\n     \"fuse.js\": \"^7.0.0\",\n     \"husky\": \"^9.1.6\",\n     \"idb\": \"^8.0.0\",\n+    \"nostr-git\": \"github:chebizarro/nostr-git\",\n     \"nostr-signer-capacitor-plugin\": \"coracle-social/nostr-signer-capacitor-plugin#9fbe4f8\",\n     \"nostr-tools\": \"^2.7.2\",\n     \"prettier-plugin-tailwindcss\": \"^0.6.5\",\ndiff --git a/src/app/editor/index.ts b/src/app/editor/index.ts\nindex 9ba3c74..6ff8944 100644\n--- a/src/app/editor/index.ts\n+++ b/src/app/editor/index.ts\n@@ -11,6 +11,8 @@ import {MentionSuggestion, WelshmanExtension} from \"@welshman/editor\"\n import {getSetting, userSettingValues} from \"@app/state\"\n import {MentionNodeView} from \"./MentionNodeView\"\n import ProfileSuggestion from \"./ProfileSuggestion.svelte\"\n+import {PermalinkExtension} from \"nostr-git\"\n+import Spinner from \"@src/lib/components/Spinner.svelte\"\n \n export const getUploadType = () =\u003e getSetting\u003c\"nip96\" | \"blossom\"\u003e(\"upload_type\")\n \n@@ -52,6 +54,11 @@ export const makeEditor = ({\n     autofocus,\n     element: document.createElement(\"div\"),\n     extensions: [\n+      PermalinkExtension.configure({\n+\t\tsigner: async (e) =\u003e await signer.get().sign(e),\n+\t\trelays: ctx.app.router.FromUser().getUrls(),\n+\t\tspinnerComponent: Spinner,\n+\t  }),\n       WelshmanExtension.configure({\n         submit,\n         sign: signWithAssert,\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-dkbxnwm3","title":"From b8bfeff8a89c90c02646f760958b1aa41c6571df Mon Sep 17 00:00:00 2001","description":"From b8bfeff8a89c90c02646f760958b1aa41c6571df Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Tue, 18 Nov 2025 12:20:34 +0500\nSubject: [PATCH 2/6] feat: improve patch detail page markdown rendering and mobile responsiveness\n\n- Add markdown preprocessing utility to handle escaped newlines\n  - Create preprocessMarkdown() function in util.ts to convert literal \\n to actual newlines\n  - Enables proper rendering of markdown content with escaped line breaks\n\n- Enhance markdown styling in app.css\n  - Add .markdown-content styles for better code block handling\n  - Implement word-break and overflow-wrap for inline code\n  - Add proper overflow handling for pre blocks\n  - Ensure code blocks maintain proper whitespace\n\n- Improve patch detail page UI/UX\n  - Enable markdown breaks option for better line break rendering\n  - Add title truncation with ellipsis for long patch titles\n  - Replace @nostr-git/ui Profile component with local Profile component\n  - Apply prose classes for better markdown typography\n\n- Enhance mobile responsiveness\n  - Convert fixed layouts to responsive flex/grid layouts\n  - Add mobile-first breakpoints (sm:) throughout the page\n  - Improve navigation controls for mobile (hide text labels, show icons)\n  - Make commit hash and branch names break properly on small screens\n  - Adjust padding and spacing for mobile devices\n  - Improve stats display with responsive text sizes\n  - Better handling of long titles and metadata on mobile\n\n- Code quality improvements\n  - Remove unused Profile import from @nostr-git/ui\n  - Add proper title attributes for truncated text\n  - Improve code block display with break-all for long hashes\n  - Better spacing and layout consistency\n\n- Update nostr-git submodule to latest version\n---\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex a8eeeae..43bf1e9 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -16,7 +16,7 @@\n     User,\n     X,\n   } from \"@lucide/svelte\"\n-  import {Button, Profile, MergeStatus, toast, Status} from \"@nostr-git/ui\"\n+  import {Button, MergeStatus, toast, Status} from \"@nostr-git/ui\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import {IssueThread, MergeAnalyzer, PatchViewer} from \"@nostr-git/ui\"\n   import {pubkey, repository} from \"@welshman/app\"\n@@ -57,6 +57,7 @@\n   import {normalizeRelayUrl} from \"@welshman/util\"\n   import {profilesByPubkey, profileSearch, loadProfile} from \"@welshman/app\"\n   import {deriveRoleAssignments} from \"@lib/budabit\"\n+  import Profile from \"@src/app/components/Profile.svelte\"\n   import {preprocessMarkdown} from \"@lib/util\"\n \n   const {data}: LayoutProps = $props()\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-docs-extension-template","title":"Update flotilla-extension-template for Smart Widgets","description":"Update the extension template so it targets Smart Widgets, uses Svelte 5 on the host side, and demonstrates NIP-compliant widget authoring.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T00:21:39.733124-08:00"}
{"id":"flotilla-docs-smart-widget-dev","title":"Write Smart Widget developer documentation","description":"Produce documentation explaining what Smart Widgets are, how Budabit loads them, how to publish widgets to relays, and how state and configuration work.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-24T18:05:14.811561-08:00","closed_at":"2026-01-24T18:05:14.811561-08:00","close_reason":"Verified implemented via codebase triage"}
{"id":"flotilla-dpae8qz3","title":"Make patch card responsive","description":"It is overextending on narrower screens","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["UI","enhancement","issue"]}
{"id":"flotilla-enfmz1b7","title":"Assign people to issues: complete the feature","description":"The basic UI is built but the assignees don't get posted and don't show up on issue cards","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["enhancement","good first issue","issue","issues"]}
{"id":"flotilla-eqeh3svk","title":"From 9be637119a60bd146d7aa1e435db864341908981 Mon Sep 17 00:00:00 2001","description":"From 9be637119a60bd146d7aa1e435db864341908981 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Fri, 13 Jun 2025 10:46:46 -0700\nSubject: [PATCH 1/2] refactor: improve issue comments handling and add UI component configuration\n\n---\n packages/nostr-git                                           |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte      | 26 +++++++++++++++++++++-----\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte | 21 +++++++++++++++------\n 3 files changed, 37 insertions(+), 12 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 4d1e47a..fffeb32 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 4d1e47ab9af6d0a45617180a31c6547bd7b771c8\n+Subproject commit fffeb3233b3e91903d3cac5b375e96ad4cc65deb\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 4945d1b..fcf18a5 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -8,6 +8,7 @@\n     parseRepoAnnouncementEvent,\n     type CommentEvent,\n     type IssueEvent,\n+    type PatchEvent,\n     type RepoAnnouncementEvent,\n     type RepoStateEvent,\n   } from \"@nostr-git/shared-types\"\n@@ -26,6 +27,13 @@\n   import {makeSpacePath} from \"@src/app/routes\"\n   import {goto} from \"$app/navigation\"\n   import {toast} from \"@nostr-git/ui\"\n+  import {ConfigProvider} from \"@nostr-git/ui\"\n+\n+  import Button from \"@lib/components/Button.svelte\"\n+  import Avatar from \"@lib/components/Avatar.svelte\"\n+  import Divider from \"@lib/components/Divider.svelte\"\n+  import Input from \"@lib/components/Field.svelte\"\n+  import Dialog from \"@lib/components/Dialog.svelte\"\n \n   const {id, relay} = $page.params\n \n@@ -204,15 +212,15 @@\n \n   const repoClass = new Repo({\n     repoEvent: $eventStore as RepoAnnouncementEvent,\n-    repoStateEvent: $repoState[0] as RepoStateEvent,\n-    publish: (event: NostrEvent) =\u003e {\n+    repoStateEvent: $repoState ? ($repoState[0] as RepoStateEvent) : undefined,\n+    publish: (event) =\u003e {\n       return publishThunk({\n         relays: [url],\n         event: event,\n       })\n     },\n-    issues: $issues,\n-    patches: $patches,\n+    issues: $issues! as IssueEvent[],\n+    patches: $patches! as PatchEvent[],\n   })\n \n   setContext(\"repoClass\", repoClass)\n@@ -268,6 +276,14 @@\n         \u003c/RepoTab\u003e\n       {/snippet}\n     \u003c/RepoHeader\u003e\n-    {@render children()}\n+    \u003cConfigProvider components={{\n+      Button,\n+      Avatar,\n+      Separator: Divider,\n+      Input,\n+      Alert: Dialog\n+    }}\u003e\n+      {@render children()}\n+    \u003c/ConfigProvider\u003e\n   {/if}\n \u003c/PageContent\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex ac70df1..526eb96 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -1,5 +1,6 @@\n \u003cscript lang=\"ts\"\u003e\n   import {Button, IssueCard, NewIssueForm, Repo} from \"@nostr-git/ui\"\n+  import { isCommentEvent, type CommentEvent } from \"@nostr-git/shared-types\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Address, COMMENT, GIT_ISSUE} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n@@ -15,11 +16,19 @@\n   const repoClass = getContext\u003cRepo\u003e(\"repoClass\")\n \n   const comments = $derived.by(() =\u003e {\n-    if (repoClass.issues) {\n-      const filters = repoClass.issues.map(issue =\u003e issue.id)\n-      load({relays: repoClass.relays, filters: [{kinds: [COMMENT], \"#E\": filters}]})\n-      return deriveEvents(repository, {filters: [{kinds: [COMMENT], \"#E\": filters}]})\n-    }\n+    return deriveEvents(repository, {\n+      filters: [\n+        {\n+          kinds: [COMMENT],\n+          \"#E\": [...repoClass.issues.map((i) =\u003e i.id)],\n+        },\n+      ],\n+    })\n+  })\n+\n+  const commentEvents = $derived.by(() =\u003e {\n+    if (!$comments) return undefined\n+    return $comments.filter(isCommentEvent) as CommentEvent[]\n   })\n \n   let loading = $state(true)\n@@ -98,7 +107,7 @@\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each repoClass.issues as issue (issue.id)}\n         \u003cdiv in:fly\u003e\n-          \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)} comments={$comments} /\u003e\n+          \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)} comments={commentEvents} /\u003e\n         \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-er1btwp6","title":"From 6c56029961b8809422cd9b1617b9e6b04cf8e373 Mon Sep 17 00:00:00 2001","description":"From 6c56029961b8809422cd9b1617b9e6b04cf8e373 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 16 Nov 2025 21:20:58 +0500\nSubject: [PATCH 1/13] feat: implemented the logic for inline comments in diff viewer\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 48 ++++++++++++++++++++++++++++++++++++++++++++++++\n 1 file changed, 48 insertions(+)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 4f23b5a..a8eeeae 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -345,6 +345,54 @@\n     }\n   })\n \n+  // Transform CommentEvent[] into DiffViewer Comment[] format\n+  const diffComments = $derived.by(() =\u003e {\n+    const comments = $threadComments\n+    if (!comments || comments.length === 0) return []\n+    \n+    return comments.map((commentEvent: CommentEvent) =\u003e {\n+      // Parse line number and file path from comment content\n+      // Format: \"comment text\\n\\n---\\nFile: path\\nLine: 123\"\n+      let lineNumber = 0\n+      let filePath = \"\"\n+      let content = commentEvent.content\n+      \n+      const separatorIndex = content.indexOf('\\n\\n---\\n')\n+      if (separatorIndex !== -1) {\n+        // Extract the actual comment content (before the separator)\n+        content = content.substring(0, separatorIndex).trim()\n+        \n+        // Extract file path and line number from the metadata section\n+        const metadataSection = commentEvent.content.substring(separatorIndex + 6)\n+        const fileMatch = metadataSection.match(/File:\\s*(.+?)(?:\\n|$)/i)\n+        if (fileMatch) {\n+          filePath = fileMatch[1].trim()\n+        }\n+        const lineMatch = metadataSection.match(/Line:\\s*(\\d+)/i)\n+        if (lineMatch) {\n+          lineNumber = parseInt(lineMatch[1], 10)\n+        }\n+      }\n+      \n+      // Get profile information for the author\n+      const profile = $profilesByPubkey.get(commentEvent.pubkey)\n+      const authorName = profile?.name || profile?.display_name || commentEvent.pubkey.slice(0, 8)\n+      const authorAvatar = profile?.picture || \"\"\n+      \n+      return {\n+        id: commentEvent.id || \"\",\n+        lineNumber,\n+        filePath,\n+        content,\n+        author: {\n+          name: authorName,\n+          avatar: authorAvatar,\n+        },\n+        createdAt: new Date(commentEvent.created_at * 1000).toISOString(),\n+      }\n+    })\n+  })\n+\n   const getStatusFilter = () =\u003e ({\n     kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n     \"#e\": [selectedPatch?.id ?? \"\"],\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-esq5cueb","title":"Bookmarks: Bookmarking / UnBookmarking on Repo page error","description":"Some error with svelte getContext\nhttps://i.nostr.build/p6VsnBTvgGCnWX9E.png","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bookmark_repos","bug","good first issue","issue","v1"]}
{"id":"flotilla-etgrylo5","title":"Add user's repos by default to repo list","description":"Need to add repos that user created or is a maintainer of to the list.\nThis effectively means to add repos where user has a nip34 announcement event (maintainers need to publish announcements as well).\nQuestion remains if these need to be added to bookmarks as well. Not necessarily in my opinion.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue","question"]}
{"id":"flotilla-ezkyw6m5","title":"From 643f2b706b64acfea7fbeb978c48102c219d28db Mon Sep 17 00:00:00 2001","description":"From 643f2b706b64acfea7fbeb978c48102c219d28db Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 20 May 2025 21:33:33 -0700\nSubject: [PATCH] refactoring of git feed code\n\n---\n .env                                                         |   9 ++++++---\n packages/nostr-git                                           |   2 +-\n pnpm-lock.yaml                                               | 203 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--\n src/app/components/GitActions.svelte                         |  57 +++++++++++----------------------------------------------\n src/app/components/RepoPicker.svelte                         | 186 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------------------------------------------------------------------------------------\n src/routes/spaces/[relay]/git/+page.svelte                   |  26 +++++++++++---------------\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte | 115 ++++++++++++++++++++++++++++++++++++++++++++++++++-----------------------------------------------------------------\n vite.config.ts                                               |   8 ++++++++\n 8 files changed, 364 insertions(+), 242 deletions(-)\n\ndiff --git a/.env b/.env\nindex 3e77ae5..1bbf3e0 100644\n--- a/.env\n+++ b/.env\n@@ -5,10 +5,13 @@ VITE_PLATFORM_TERMS=\n VITE_PLATFORM_PRIVACY=\n VITE_PLATFORM_NAME=Budabit\n VITE_PLATFORM_LOGO=static/budabit.png\n-VITE_PLATFORM_RELAY=ws://192.168.1.101:7000\n+VITE_PLATFORM_RELAY=wss://budabit.nostr1.com\n VITE_PLATFORM_ACCENT=\"#D4AF37\"\n+VITE_PLATFORM_SECONDARY=\"#EB5E28\"\n VITE_PLATFORM_DESCRIPTION=\"The Club for Builders in Freedom Tech.\"\n-VITE_GLITCHTIP_API_KEY=\n-GLITCHTIP_AUTH_TOKEN=\n VITE_INDEXER_RELAYS=wss://purplepag.es/,wss://relay.damus.io/,wss://relay.nostr.band/\n VITE_SIGNER_RELAYS=wss://relay.nsec.app/,wss://bucket.coracle.social/\n+VITE_NOTIFIER_PUBKEY=27b7c2ed89ef78322114225ea3ebf5f72c7767c2528d4d0c1854d039c00085df\n+VITE_NOTIFIER_RELAY=wss://anchor.coracle.social/\n+VITE_GLITCHTIP_API_KEY=\n+GLITCHTIP_AUTH_TOKEN=\n\\ No newline at end of file\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex ba20964..b536fcc 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit ba20964c0fcab077d9c0c76d95241e8e980c4d81\n+Subproject commit b536fcc8a64b876ad9bed5615f3a62bf77888c85\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 9ddf517..fd252da 100644\n--- a/pnpm-lock.yaml\n+++ b/pnpm-lock.yaml\n@@ -213,6 +213,9 @@ importers:\n       '@nostr-git/ui':\n         specifier: link:packages/ui\n         version: link:packages/ui\n+      svelte-routing:\n+        specifier: ^2.13.0\n+        version: 2.13.0\n     devDependencies:\n       '@storybook/addon-svelte-csf':\n         specifier: 5.0.0-next.28\n@@ -221,12 +224,26 @@ importers:\n         specifier: ^5.3.3\n         version: 5.8.3\n \n+  packages/nostr-git/packages/actions/generate-repo-announcement: {}\n+\n   packages/nostr-git/packages/actions/nostr-post-event:\n     dependencies:\n+      '@actions/core':\n+        specifier: ^1.11.1\n+        version: 1.11.1\n+      '@actions/github':\n+        specifier: ^6.0.1\n+        version: 6.0.1\n+      '@nostr-git/core':\n+        specifier: workspace:*\n+        version: link:../../core\n       nostr-tools:\n         specifier: ^2.12.0\n         version: 2.12.0(typescript@5.8.3)\n     devDependencies:\n+      '@types/node':\n+        specifier: ^22.15.19\n+        version: 22.15.19\n       typescript:\n         specifier: 5.8.3\n         version: 5.8.3\n@@ -530,6 +547,21 @@ importers:\n \n packages:\n \n+  '@actions/core@1.11.1':\n+    resolution: {integrity: sha512-hXJCSrkwfA46Vd9Z3q4cpEpHB1rL5NG04+/rbqW9d3+CSvtB1tYe8UTpAlixa1vj0m/ULglfEK2UKxMGxCxv5A==}\n+\n+  '@actions/exec@1.1.1':\n+    resolution: {integrity: sha512-+sCcHHbVdk93a0XT19ECtO/gIXoxvdsgQLzb2fE2/5sIZmWQuluYyjPQtrtTHdU1YzTZ7bAPN4sITq2xi1679w==}\n+\n+  '@actions/github@6.0.1':\n+    resolution: {integrity: sha512-xbZVcaqD4XnQAe35qSQqskb3SqIAfRyLBrHMd/8TuL7hJSz2QtbDwnNM8zWx4zO5l2fnGtseNE3MbEvD7BxVMw==}\n+\n+  '@actions/http-client@2.2.3':\n+    resolution: {integrity: sha512-mx8hyJi/hjFvbPokCg4uRd4ZX78t+YyRPtnKWwIl+RzNaVuFpQHfmlGVfsKEJN8LwTCvL+DfVgAM04XaHkm6bA==}\n+\n+  '@actions/io@1.1.3':\n+    resolution: {integrity: sha512-wi9JjgKLYS7U/z8PPbco+PvTb/nRWjeoFlJ1Qer83k/3C5PHQi28hiVdeE2kHXmIL99mQFawx8qt/JPjZilJ8Q==}\n+\n   '@adobe/css-tools@4.4.2':\n     resolution: {integrity: sha512-baYZExFpsdkBNuvGKTKWCwKH57HRZLVtycZS05WTQNVOiXVSeAki3nU35zlRbToeMW8aHlJfyS+1C4BOv27q0A==}\n \n@@ -1599,6 +1631,10 @@ packages:\n     resolution: {integrity: sha512-ZAoA40rNMPwSm+AeHpCq8STiNAwzWLJuP8Xv4CHIc9wv/PSuExjMrmjfYNj682vW0OOiZ1HKxzvjQr9XZIisQA==}\n     engines: {node: ^18.18.0 || ^20.9.0 || \u003e=21.1.0}\n \n+  '@fastify/busboy@2.1.1':\n+    resolution: {integrity: sha512-vBZP4NlzfOlerQTnba4aqZoMhE/a9HY7HRqoOPaETQcSQuWEIyZMHGfVu6w9wGtGK5fED5qRs2DteVCjOH60sA==}\n+    engines: {node: '\u003e=14'}\n+\n   '@floating-ui/core@1.7.0':\n     resolution: {integrity: sha512-FRdBLykrPPA6P76GGGqlex/e7fbe0F1ykgxHYNXQsH/iTEtjMj/f9bpY5oQqbjt5VgZvgz/uKXbGuROijh3VLA==}\n \n@@ -1890,6 +1926,54 @@ packages:\n     resolution: {integrity: sha512-oGB+UxlgWcgQkgwo8GcEGwemoTFt3FIO9ababBmaGwXIoBKZ+GTy0pP185beGg7Llih/NSHSV2XAs1lnznocSg==}\n     engines: {node: '\u003e= 8'}\n \n+  '@octokit/auth-token@4.0.0':\n+    resolution: {integrity: sha512-tY/msAuJo6ARbK6SPIxZrPBms3xPbfwBrulZe0Wtr/DIY9lje2HeV1uoebShn6mx7SjCHif6EjMvoREj+gZ+SA==}\n+    engines: {node: '\u003e= 18'}\n+\n+  '@octokit/core@5.2.1':\n+    resolution: {integrity: sha512-dKYCMuPO1bmrpuogcjQ8z7ICCH3FP6WmxpwC03yjzGfZhj9fTJg6+bS1+UAplekbN2C+M61UNllGOOoAfGCrdQ==}\n+    engines: {node: '\u003e= 18'}\n+\n+  '@octokit/endpoint@9.0.6':\n+    resolution: {integrity: sha512-H1fNTMA57HbkFESSt3Y9+FBICv+0jFceJFPWDePYlR/iMGrwM5ph+Dd4XRQs+8X+PUFURLQgX9ChPfhJ/1uNQw==}\n+    engines: {node: '\u003e= 18'}\n+\n+  '@octokit/graphql@7.1.1':\n+    resolution: {integrity: sha512-3mkDltSfcDUoa176nlGoA32RGjeWjl3K7F/BwHwRMJUW/IteSa4bnSV8p2ThNkcIcZU2umkZWxwETSSCJf2Q7g==}\n+    engines: {node: '\u003e= 18'}\n+\n+  '@octokit/openapi-types@20.0.0':\n+    resolution: {integrity: sha512-EtqRBEjp1dL/15V7WiX5LJMIxxkdiGJnabzYx5Apx4FkQIFgAfKumXeYAqqJCj1s+BMX4cPFIFC4OLCR6stlnA==}\n+\n+  '@octokit/openapi-types@24.2.0':\n+    resolution: {integrity: sha512-9sIH3nSUttelJSXUrmGzl7QUBFul0/mB8HRYl3fOlgHbIWG+WnYDXU3v/2zMtAvuzZ/ed00Ei6on975FhBfzrg==}\n+\n+  '@octokit/plugin-paginate-rest@9.2.2':\n+    resolution: {integrity: sha512-u3KYkGF7GcZnSD/3UP0S7K5XUFT2FkOQdcfXZGZQPGv3lm4F2Xbf71lvjldr8c1H3nNbF+33cLEkWYbokGWqiQ==}\n+    engines: {node: '\u003e= 18'}\n+    peerDependencies:\n+      '@octokit/core': '5'\n+\n+  '@octokit/plugin-rest-endpoint-methods@10.4.1':\n+    resolution: {integrity: sha512-xV1b+ceKV9KytQe3zCVqjg+8GTGfDYwaT1ATU5isiUyVtlVAO3HNdzpS4sr4GBx4hxQ46s7ITtZrAsxG22+rVg==}\n+    engines: {node: '\u003e= 18'}\n+    peerDependencies:\n+      '@octokit/core': '5'\n+\n+  '@octokit/request-error@5.1.1':\n+    resolution: {integrity: sha512-v9iyEQJH6ZntoENr9/yXxjuezh4My67CBSu9r6Ve/05Iu5gNgnisNWOsoJHTP6k0Rr0+HQIpnH+kyammu90q/g==}\n+    engines: {node: '\u003e= 18'}\n+\n+  '@octokit/request@8.4.1':\n+    resolution: {integrity: sha512-qnB2+SY3hkCmBxZsR/MPCybNmbJe4KAlfWErXq+rBKkQJlbjdJeS85VI9r8UqeLYLvnAenU8Q1okM/0MBsAGXw==}\n+    engines: {node: '\u003e= 18'}\n+\n+  '@octokit/types@12.6.0':\n+    resolution: {integrity: sha512-1rhSOfRa6H9w4YwK0yrf5faDaDTb+yLyBUKOCV4xtCDB5VmIPqd/v9yr9o6SAzOAlRxMiRiCic6JVM1/kunVkw==}\n+\n+  '@octokit/types@13.10.0':\n+    resolution: {integrity: sha512-ifLaO34EbbPj0Xgro4G5lP5asESjwHracYJvVaPIyXMuiuXLlhic3S47cBdTb+jfODkTE5YtGCLt3Ay3+J97sA==}\n+\n   '@pkgjs/parseargs@0.11.0':\n     resolution: {integrity: sha512-+1VkjdD0QBLPodGrJUeqarH8VAIvQODIbwh9XpP5Syisf7YoQgsJKPNFoqqLQlu+VQ/tVSshMR6loPMn8U+dPg==}\n     engines: {node: '\u003e=14'}\n@@ -3087,6 +3171,9 @@ packages:\n   base64-js@1.5.1:\n     resolution: {integrity: sha512-AKpaYlHn8t4SVbOHCy+b5+KKgvR4vrsD8vbvrbiQJps7fKDTkjkDry6ji0rUJjC0kzbNePLwzxq8iypo41qeWA==}\n \n+  before-after-hook@2.2.3:\n+    resolution: {integrity: sha512-NzUnlZexiaH/46WDhANlyR2bXRopNg4F/zuSA3OpZnllCUgRaOF2znDioDWrmbNVsuZk6l9pMquQB38cfBZwkQ==}\n+\n   better-opn@3.0.2:\n     resolution: {integrity: sha512-aVNobHnJqLiUelTaHat9DZ1qM2w0C0Eym4LPI/3JxOnSokGVdsl1T1kN7TFvsEAD8G47A6VKQ0TVHqbBnYMJlQ==}\n     engines: {node: '\u003e=12.0.0'}\n@@ -3627,6 +3714,9 @@ packages:\n     resolution: {integrity: sha512-ZySD7Nf91aLB0RxL4KGrKHBXl7Eds1DAmEdcoVawXnLD7SDhpNgtuII2aAkg7a7QS41jxPSZ17p4VdGnMHk3MQ==}\n     engines: {node: '\u003e=0.4.0'}\n \n+  deprecation@2.3.1:\n+    resolution: {integrity: sha512-xmHIy4F3scKVwMsQ4WnVaS8bHOx0DmVwRywosKhaILI0ywMDWPtBSku2HNxRvF7jtwDRsoEwYQSfbxj8b7RlJQ==}\n+\n   dequal@2.0.3:\n     resolution: {integrity: sha512-0je+qPKHEMohvfRTCEo3CrPG6cAzAYgmzKyxRiYSSDkS6eGJdyVJm7WaYA5ECaAD9wLB2T4EEeymA5aFVcYXCA==}\n     engines: {node: '\u003e=6'}\n@@ -6451,6 +6541,10 @@ packages:\n   tunnel-agent@0.6.0:\n     resolution: {integrity: sha512-McnNiV1l8RYeY8tBgEpuodCC1mLUdbSN+CYBL7kJsJNInOP8UjDDEwdk6Mw60vdLLrr5NHKZhMAOSrR2NZuQ+w==}\n \n+  tunnel@0.0.6:\n+    resolution: {integrity: sha512-1h/Lnq9yajKY2PEbBadPXj3VxsDDu844OnaAo52UVmIzIvwwtBPIuNvkjuzBlTWpfJyUbG3ez0KSBibQkj4ojg==}\n+    engines: {node: '\u003e=0.6.11 \u003c=0.7.0 || \u003e=0.7.3'}\n+\n   tw-animate-css@1.3.0:\n     resolution: {integrity: sha512-jrJ0XenzS9KVuDThJDvnhalbl4IYiMQ/XvpA0a2FL8KmlK+6CSMviO7ROY/I7z1NnUs5NnDhlM6fXmF40xPxzw==}\n \n@@ -6541,6 +6635,10 @@ packages:\n   undici-types@6.21.0:\n     resolution: {integrity: sha512-iwDZqg0QAGrg9Rav5H4n0M64c3mkR59cJ6wQp+7C4nI0gsmExaedaYLNO44eT4AtBBwjbTiGPMlt2Md0T9H9JQ==}\n \n+  undici@5.29.0:\n+    resolution: {integrity: sha512-raqeBD6NQK4SkWhQzeYKd1KmIG6dllBOTt55Rmkt4HtI9mwdWtJljnrXjAFUBLTSN67HWrOIZ3EPF4kjUw80Bg==}\n+    engines: {node: '\u003e=14.0'}\n+\n   unicode-canonical-property-names-ecmascript@2.0.1:\n     resolution: {integrity: sha512-dA8WbNeb2a6oQzAQ55YlT5vQAWGV9WXOsi3SskE3bcCdM0P4SDd+24zS/OCacdRq5BkdsRj9q3Pg6YyQoxIGqg==}\n     engines: {node: '\u003e=4'}\n@@ -6565,6 +6663,9 @@ packages:\n     resolution: {integrity: sha512-uNaeirEPvpZWSgzwsPGtU2zVSTrn/8L5q/IexZmH0eH6SA73CmAA5U4GwORTxQAZs95TAXLNqeLoPPNO5gZfWg==}\n     engines: {node: '\u003e=8'}\n \n+  universal-user-agent@6.0.1:\n+    resolution: {integrity: sha512-yCzhz6FN2wU1NiiQRogkTQszlQSlpWaw8SvVegAc+bDxbzHgh1vX8uIe8OYyMH6DwH+sdTJsgMl36+mSMdRJIQ==}\n+\n   universalify@2.0.1:\n     resolution: {integrity: sha512-gptHNQghINnc/vTGIk0SOFGFNXw7JVrlRUtConJRlvaw6DuX0wO5Jeko9sWrMBhh+PsYAZ7oXAiOnf/UKogyiw==}\n     engines: {node: '\u003e= 10.0.0'}\n@@ -6971,6 +7072,32 @@ packages:\n \n snapshots:\n \n+  '@actions/core@1.11.1':\n+    dependencies:\n+      '@actions/exec': 1.1.1\n+      '@actions/http-client': 2.2.3\n+\n+  '@actions/exec@1.1.1':\n+    dependencies:\n+      '@actions/io': 1.1.3\n+\n+  '@actions/github@6.0.1':\n+    dependencies:\n+      '@actions/http-client': 2.2.3\n+      '@octokit/core': 5.2.1\n+      '@octokit/plugin-paginate-rest': 9.2.2(@octokit/core@5.2.1)\n+      '@octokit/plugin-rest-endpoint-methods': 10.4.1(@octokit/core@5.2.1)\n+      '@octokit/request': 8.4.1\n+      '@octokit/request-error': 5.1.1\n+      undici: 5.29.0\n+\n+  '@actions/http-client@2.2.3':\n+    dependencies:\n+      tunnel: 0.0.6\n+      undici: 5.29.0\n+\n+  '@actions/io@1.1.3': {}\n+\n   '@adobe/css-tools@4.4.2': {}\n \n   '@alloc/quick-lru@5.2.0': {}\n@@ -8155,6 +8282,8 @@ snapshots:\n       '@eslint/core': 0.13.0\n       levn: 0.4.1\n \n+  '@fastify/busboy@2.1.1': {}\n+\n   '@floating-ui/core@1.7.0':\n     dependencies:\n       '@floating-ui/utils': 0.2.9\n@@ -8485,6 +8614,64 @@ snapshots:\n       '@nodelib/fs.scandir': 2.1.5\n       fastq: 1.19.1\n \n+  '@octokit/auth-token@4.0.0': {}\n+\n+  '@octokit/core@5.2.1':\n+    dependencies:\n+      '@octokit/auth-token': 4.0.0\n+      '@octokit/graphql': 7.1.1\n+      '@octokit/request': 8.4.1\n+      '@octokit/request-error': 5.1.1\n+      '@octokit/types': 13.10.0\n+      before-after-hook: 2.2.3\n+      universal-user-agent: 6.0.1\n+\n+  '@octokit/endpoint@9.0.6':\n+    dependencies:\n+      '@octokit/types': 13.10.0\n+      universal-user-agent: 6.0.1\n+\n+  '@octokit/graphql@7.1.1':\n+    dependencies:\n+      '@octokit/request': 8.4.1\n+      '@octokit/types': 13.10.0\n+      universal-user-agent: 6.0.1\n+\n+  '@octokit/openapi-types@20.0.0': {}\n+\n+  '@octokit/openapi-types@24.2.0': {}\n+\n+  '@octokit/plugin-paginate-rest@9.2.2(@octokit/core@5.2.1)':\n+    dependencies:\n+      '@octokit/core': 5.2.1\n+      '@octokit/types': 12.6.0\n+\n+  '@octokit/plugin-rest-endpoint-methods@10.4.1(@octokit/core@5.2.1)':\n+    dependencies:\n+      '@octokit/core': 5.2.1\n+      '@octokit/types': 12.6.0\n+\n+  '@octokit/request-error@5.1.1':\n+    dependencies:\n+      '@octokit/types': 13.10.0\n+      deprecation: 2.3.1\n+      once: 1.4.0\n+\n+  '@octokit/request@8.4.1':\n+    dependencies:\n+      '@octokit/endpoint': 9.0.6\n+      '@octokit/request-error': 5.1.1\n+      '@octokit/types': 13.10.0\n+      universal-user-agent: 6.0.1\n+\n+  '@octokit/types@12.6.0':\n+    dependencies:\n+      '@octokit/openapi-types': 20.0.0\n+\n+  '@octokit/types@13.10.0':\n+    dependencies:\n+      '@octokit/openapi-types': 24.2.0\n+\n   '@pkgjs/parseargs@0.11.0':\n     optional: true\n \n@@ -8513,7 +8700,7 @@ snapshots:\n   '@rollup/plugin-babel@5.3.1(@babel/core@7.26.10)(rollup@2.79.2)':\n     dependencies:\n       '@babel/core': 7.26.10\n-      '@babel/helper-module-imports': 7.25.9\n+      '@babel/helper-module-imports': 7.27.1\n       '@rollup/pluginutils': 3.1.0(rollup@2.79.2)\n       rollup: 2.79.2\n     transitivePeerDependencies:\n@@ -10026,6 +10213,8 @@ snapshots:\n \n   base64-js@1.5.1: {}\n \n+  before-after-hook@2.2.3: {}\n+\n   better-opn@3.0.2:\n     dependencies:\n       open: 8.4.2\n@@ -10605,6 +10794,8 @@ snapshots:\n \n   delayed-stream@1.0.0: {}\n \n+  deprecation@2.3.1: {}\n+\n   dequal@2.0.3: {}\n \n   detect-indent@6.1.0: {}\n@@ -13728,6 +13919,8 @@ snapshots:\n     dependencies:\n       safe-buffer: 5.2.1\n \n+  tunnel@0.0.6: {}\n+\n   tw-animate-css@1.3.0: {}\n \n   tween-functions@1.2.0: {}\n@@ -13821,6 +14014,10 @@ snapshots:\n \n   undici-types@6.21.0: {}\n \n+  undici@5.29.0:\n+    dependencies:\n+      '@fastify/busboy': 2.1.1\n+\n   unicode-canonical-property-names-ecmascript@2.0.1: {}\n \n   unicode-match-property-ecmascript@2.0.0:\n@@ -13838,6 +14035,8 @@ snapshots:\n     dependencies:\n       crypto-random-string: 2.0.0\n \n+  universal-user-agent@6.0.1: {}\n+\n   universalify@2.0.1: {}\n \n   unplugin@1.16.1:\n@@ -13886,7 +14085,7 @@ snapshots:\n     dependencies:\n       debug: 4.4.0\n       pretty-bytes: 6.1.1\n-      tinyglobby: 0.2.12\n+      tinyglobby: 0.2.13\n       vite: 5.4.17(@types/node@22.15.19)(terser@5.39.0)\n       workbox-build: 7.3.0\n       workbox-window: 7.3.0\ndiff --git a/src/app/components/GitActions.svelte b/src/app/components/GitActions.svelte\nindex d4ab776..9fce7d5 100644\n--- a/src/app/components/GitActions.svelte\n+++ b/src/app/components/GitActions.svelte\n@@ -3,14 +3,9 @@\n   import {\n     Address,\n     GIT_ISSUE,\n-    GIT_STATUS_CLOSED,\n-    GIT_STATUS_COMPLETE,\n-    GIT_STATUS_DRAFT,\n-    GIT_STATUS_OPEN,\n-    type Filter,\n     type TrustedEvent,\n   } from \"@welshman/util\"\n-  import {pubkey} from \"@welshman/app\"\n+  import {pubkey, repository} from \"@welshman/app\"\n   import ReactionSummary from \"@app/components/ReactionSummary.svelte\"\n   import ThunkStatusOrDeleted from \"@app/components/ThunkStatusOrDeleted.svelte\"\n   import EventActions from \"@app/components/EventActions.svelte\"\n@@ -18,10 +13,9 @@\n   import {makeGitPath} from \"@app/routes\"\n   import Button from \"@src/lib/components/Button.svelte\"\n   import Link from \"@src/lib/components/Link.svelte\"\n-  import {nthEq} from \"@welshman/lib\"\n-  import {onMount, tick} from \"svelte\"\n-  import {nip19} from \"nostr-tools\"\n+  import {onMount} from \"svelte\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n+  import {deriveEvents} from \"@welshman/store\"\n \n   interface Props {\n     url: any\n@@ -32,14 +26,13 @@\n \n   const {url, event, showIssues = true, showActivity}: Props = $props()\n \n-  const repoNpub = $derived(nip19.npubEncode(event.pubkey))\n-  const repoDtag = $derived(event.tags.find(nthEq(0, \"d\"))?.[1])\n-\n-  const gitworkshopLink = $derived(`https://gitworkshop.dev/${repoNpub}/${repoDtag}`)\n+  const issueFilter = {\n+    kinds: [GIT_ISSUE],\n+    \"#a\": [Address.fromEvent(event).toString()],\n+  }\n \n-  let issues: TrustedEvent[] = []\n-  const issueFilter: Filter = {kinds: [GIT_ISSUE]}\n-  let issueCount = $state(0)\n+  const issues = deriveEvents(repository, {filters: [issueFilter]})\n+  const issueCount = $derived($issues.length)\n \n   const onReactionClick = (content: string, events: TrustedEvent[]) =\u003e {\n     const reaction = events.find(e =\u003e e.pubkey === $pubkey)\n@@ -51,39 +44,11 @@\n   }\n \n   let loadingIssues = $state(false)\n-  const loadIssuesAndStatuses = async () =\u003e {\n-    loadingIssues = true\n-    await tick()\n-    const address = Address.fromEvent(event)\n-    issueFilter[\"#a\"] = [address.toString()]\n-    const [tagId, ...relays] = event.tags.find(nthEq(0, \"relays\")) || []\n-\n-    issues = await load({\n-      relays: relays,\n-      filters: [issueFilter],\n-    })\n-\n-    loadingIssues = false\n \n-    const statusFilter = [\n-      {\n-        kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n-        \"#e\": issues.map(issue =\u003e issue.id),\n-      },\n-    ]\n-\n-    issueCount = issues.length\n-\n-    // No need to await this one, justawait pre-loading\n-    const statuses = load({\n-      relays: relays,\n-      filters: statusFilter,\n-    })\n-  }\n \n   onMount(() =\u003e {\n     if (showIssues) {\n-      loadIssuesAndStatuses()\n+      load({relays: [url], filters: [issueFilter]})\n     }\n   })\n \n@@ -107,7 +72,7 @@\n           class=\"flex h-full w-full cursor-pointer items-center\"\n           href={makeGitPath(url, Address.fromEvent(event).toNaddr()) + \"/issues\"}\u003e\n           \u003cSpinner loading={loadingIssues} minHeight={\"min-h-6\"}\u003e\n-            \u003cspan class=\"\"\u003e{\"Issues (\" + issueCount + \")\"}\u003c/span\u003e\n+            {\"Issues (\" + issueCount + \")\"}\n           \u003c/Spinner\u003e\n         \u003c/Link\u003e\n       \u003c/Button\u003e\ndiff --git a/src/app/components/RepoPicker.svelte b/src/app/components/RepoPicker.svelte\nindex e19dc6a..fb344eb 100644\n--- a/src/app/components/RepoPicker.svelte\n+++ b/src/app/components/RepoPicker.svelte\n@@ -1,7 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n   import {debounce} from \"throttle-debounce\"\n   import {onMount} from \"svelte\"\n-  import { GIT_REPO_BOOKMARK_DTAG } from \"@src/lib/util\"\n+  import {GIT_REPO_BOOKMARK_DTAG} from \"@src/lib/util\"\n   import {page} from \"$app/stores\"\n   import {writable} from \"svelte/store\"\n   import {\n@@ -10,47 +10,39 @@\n     getTagValue,\n     NAMED_BOOKMARKS,\n     type Filter,\n-    type TrustedEvent\n+    type TrustedEvent,\n   } from \"@welshman/util\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n   import ModalHeader from \"@lib/components/ModalHeader.svelte\"\n   import ModalFooter from \"@lib/components/ModalFooter.svelte\"\n   import FieldInline from \"@src/lib/components/FieldInline.svelte\"\n-  import {\n-    makeFeedController,\n-    createSearch,\n-    publishThunk,\n-    repository,\n-    tracker\n-  } from \"@welshman/app\"\n-  import {\n-    feedFromFilter,\n-    makeIntersectionFeed,\n-    makeWOTFeed,\n-  } from \"@welshman/feeds\"\n+  import {makeFeedController, createSearch, publishThunk, repository, tracker} from \"@welshman/app\"\n+  import {feedFromFilter, makeIntersectionFeed, makeWOTFeed} from \"@welshman/feeds\"\n   import {sleep} from \"@welshman/lib\"\n   import {createScroller, isMobile, type Scroller} from \"@src/lib/html\"\n   import {deriveEvents} from \"@welshman/store\"\n-  import { GIT_REPO } from \"@src/lib/util\"\n-  import { preventDefault } from \"svelte/legacy\"\n-  import { decodeRelay, shouldReloadRepos } from \"../state\"\n+  import {GIT_REPO} from \"@src/lib/util\"\n+  import {preventDefault} from \"svelte/legacy\"\n+  import {decodeRelay, shouldReloadRepos} from \"../state\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n-  import { fly } from \"svelte/transition\"\n+  import {fly} from \"svelte/transition\"\n   import GitItem from \"./GitItem.svelte\"\n   import Divider from \"@src/lib/components/Divider.svelte\"\n-  import { makeGitPath } from \"../routes\"\n-  import { goto } from \"$app/navigation\"\n-    import { Router } from \"@welshman/router\"\n-\n+  import {makeGitPath} from \"../routes\"\n+  import {goto} from \"$app/navigation\"\n+  import {Router} from \"@welshman/router\"\n+  import {load} from \"@welshman/net\"\n \n   const url = decodeRelay($page.params.relay)\n-  const {selectedRepos}: {\n-    selectedRepos: Array\u003c{address: string, event: TrustedEvent, relayHint: string}\u003e\n+  const {\n+    selectedRepos,\n+  }: {\n+    selectedRepos: Array\u003c{address: string; event: TrustedEvent; relayHint: string}\u003e\n   } = $props()\n \n   let localSelectedReposState = $state([...selectedRepos])\n-  $effect(() =\u003e{\n+  $effect(() =\u003e {\n     localSelectedReposState = [...selectedRepos]\n   })\n \n@@ -71,7 +63,7 @@\n         repo: event,\n         relay: relayHint,\n         address: address,\n-        selected: true\n+        selected: true,\n       })\n     }\n \n@@ -79,23 +71,20 @@\n       const address = Address.fromEvent(event)\n       const addressStr = address.toString()\n       // Need to keep selected and unselected repos as distinct sets\n-      if (!localSelectedReposState.find(r=\u003er.address===addressStr)) {\n+      if (!localSelectedReposState.find(r =\u003e r.address === addressStr)) {\n         const relayHints = tracker.getRelays(event.id)\n-        const repoEventRelayHint = getTagValue('relays', event.tags)\n+        const repoEventRelayHint = getTagValue(\"relays\", event.tags)\n \n-        const relaysFromRepoPubkey = \n-        Router.get().getRelaysForPubkey(event.pubkey)?.[0] ?? ''\n+        const relaysFromRepoPubkey = Router.get().getRelaysForPubkey(event.pubkey)?.[0] ?? \"\"\n \n-        const firstHint = \n-          relayHints.values().next().value ??\n-            repoEventRelayHint ??\n-            relaysFromRepoPubkey\n+        const firstHint =\n+          relayHints.values().next().value ?? repoEventRelayHint ?? relaysFromRepoPubkey\n \n         elements.push({\n           repo: event,\n           relay: firstHint,\n           address: addressStr,\n-          selected: false\n+          selected: false,\n         })\n       }\n     }\n@@ -104,53 +93,44 @@\n   })\n \n   let searchTerm = $state(\"\")\n-  let debouncedTerm = $state('');\n+  let debouncedTerm = $state(\"\")\n \n   // Set up the debounced update\n-  const updateDebouncedTerm = debounce(500, (term) =\u003e {\n-    debouncedTerm = term;\n-  });\n+  const updateDebouncedTerm = debounce(500, term =\u003e {\n+    debouncedTerm = term\n+  })\n \n   // Watch searchTerm changes\n   $effect(() =\u003e {\n-    updateDebouncedTerm(searchTerm);\n-  });\n-\n+    updateDebouncedTerm(searchTerm)\n+  })\n \n-  const searchedRepos = $derived.by(()=\u003e{\n-    const reposToSearch = repos.map((r) =\u003e {\n+  const searchedRepos = $derived.by(() =\u003e {\n+    const reposToSearch = repos.map(r =\u003e {\n       return {\n         id: r.repo.id,\n-        name: getTagValue('name', r.repo.tags) ?? '',\n-        desc: getTagValue('description', r.repo.tags) ?? ''\n+        name: getTagValue(\"name\", r.repo.tags) ?? \"\",\n+        desc: getTagValue(\"description\", r.repo.tags) ?? \"\",\n       }\n     })\n     if (debouncedTerm.length \u003e 2) {\n-      const repoSearch = createSearch(\n-        reposToSearch,\n-        {\n-          getValue: (repo: {\n-            id: string,\n-            name: string,\n-            desc: string\n-          }) =\u003e repo.id,\n-          fuseOptions: {\n-            keys: [\n-              {name: \"name\", weight: 0.8}, {name: 'desc', weight: 0.2}\n-            ],\n-            includeScore: true,\n-            threshold: 0.3\n-          },\n-          sortFn: ({score, item}) =\u003e {\n-            if (score \u0026\u0026 score \u003e 0.3) return -score!\n-            return item.name\n-          }\n-        }\n-      )\n+      const repoSearch = createSearch(reposToSearch, {\n+        getValue: (repo: {id: string; name: string; desc: string}) =\u003e repo.id,\n+        fuseOptions: {\n+          keys: [\n+            {name: \"name\", weight: 0.8},\n+            {name: \"desc\", weight: 0.2},\n+          ],\n+          includeScore: true,\n+          threshold: 0.3,\n+        },\n+        sortFn: ({score, item}) =\u003e {\n+          if (score \u0026\u0026 score \u003e 0.3) return -score!\n+          return item.name\n+        },\n+      })\n       const searchResults = repoSearch.searchOptions(searchTerm)\n-      const result = repos.filter(\n-        r =\u003e searchResults.find(res =\u003e res.id === r.repo.id)\n-      )\n+      const result = repos.filter(r =\u003e searchResults.find(res =\u003e res.id === r.repo.id))\n       return result\n     } else {\n       return repos\n@@ -159,10 +139,7 @@\n \n   const ctrl = makeFeedController({\n     useWindowing: true,\n-    feed: makeIntersectionFeed(\n-      makeWOTFeed({min: 0.1}),\n-      feedFromFilter({kinds: [GIT_REPO]}),\n-    ),\n+    feed: makeIntersectionFeed(makeWOTFeed({min: 0.1}), feedFromFilter({kinds: [GIT_REPO]})),\n     onExhausted: () =\u003e {\n       loading = false\n     },\n@@ -174,21 +151,15 @@\n \n   const submit = () =\u003e {\n     if ($uploading) return\n-    const atagList:string[][] = [];\n+    const atagList: string[][] = []\n \n     for (const {address, relayHint} of localSelectedReposState) {\n-      atagList.push(['a', address, relayHint])\n+      atagList.push([\"a\", address, relayHint])\n     }\n \n-    const eventToPublish = createEvent(\n-      NAMED_BOOKMARKS,\n-      { \n-        tags: [ \n-          [\"d\", GIT_REPO_BOOKMARK_DTAG],\n-          ...atagList\n-        ] \n-      }\n-    )\n+    const eventToPublish = createEvent(NAMED_BOOKMARKS, {\n+      tags: [[\"d\", GIT_REPO_BOOKMARK_DTAG], ...atagList],\n+    })\n     console.log(\"eventToPublish\", eventToPublish)\n \n     publishThunk({\n@@ -196,12 +167,17 @@\n       relays: [url, ...Router.get().FromUser().getUrls()],\n     })\n \n-    $shouldReloadRepos = true;\n+    $shouldReloadRepos = true\n \n     goto(makeGitPath(url))\n   }\n \n   onMount(() =\u003e {\n+    const relays = [url, ...Router.get().FromUser().getUrls()];\n+    load({\n+      relays,\n+      filters,\n+    })\n     // Element is frequently not defined. I don't know why\n     sleep(1000).then(() =\u003e {\n       if (!unmounted) {\n@@ -226,12 +202,7 @@\n     }\n   })\n \n-  const onRepoChecked = (\n-    relay: string,\n-    address: string,\n-    event:TrustedEvent,\n-    checked: boolean\n-  ) =\u003e {\n+  const onRepoChecked = (relay: string, address: string, event: TrustedEvent, checked: boolean) =\u003e {\n     if (checked) {\n       localSelectedReposState.push({address, event, relayHint: relay})\n     } else {\n@@ -240,19 +211,14 @@\n   }\n \u003c/script\u003e\n \n-{#snippet repoSelectCheckBox(relay: string, address:string, repo:TrustedEvent, selected: boolean)}\n+{#snippet repoSelectCheckBox(relay: string, address: string, repo: TrustedEvent, selected: boolean)}\n   \u003cinput\n     slot=\"input\"\n     type=\"checkbox\"\n     class=\"toggle toggle-primary\"\n     checked={selected}\n-    onchange={event =\u003e onRepoChecked(\n-      relay,\n-      address,\n-      repo,\n-      (event.target as HTMLInputElement).checked\n-    )}\n-  /\u003e\n+    onchange={event =\u003e\n+      onRepoChecked(relay, address, repo, (event.target as HTMLInputElement).checked)} /\u003e\n {/snippet}\n \n \u003cform class=\"column gap-4\" onsubmit={preventDefault(submit)}\u003e\n@@ -275,18 +241,18 @@\n       placeholder=\"Search repos...\" /\u003e\n   \u003c/label\u003e\n   \u003cdiv\n-    class=\"scroll-container -mt-2 h-96 flex flex-grow flex-col overflow-auto py-2\"\n+    class=\"scroll-container -mt-2 flex h-96 flex-grow flex-col overflow-auto py-2\"\n     bind:this={element}\u003e\n     \u003cDivider\u003e\n       \u003cp\u003eSelected\u003c/p\u003e\n     \u003c/Divider\u003e\n-    {#each searchedRepos.filter((r)=\u003er.selected) as {repo, relay, address} (repo.id)}\n-      \u003cdiv out:fly=\"{{ duration: 200 }}\"\u003e\n-        \u003cGitItem {url} event={repo} showActivity={false} showActions={false}/\u003e\n+    {#each searchedRepos.filter(r =\u003e r.selected) as { repo, relay, address } (repo.id)}\n+      \u003cdiv out:fly={{duration: 200}}\u003e\n+        \u003cGitItem {url} event={repo} showActivity={false} showActions={false} /\u003e\n         \u003cdiv class=\"flex w-full justify-end\"\u003e\n           \u003cFieldInline\u003e\n             {#snippet input()}\n-              {@render repoSelectCheckBox(relay, address,repo, true)}\n+              {@render repoSelectCheckBox(relay, address, repo, true)}\n             {/snippet}\n           \u003c/FieldInline\u003e\n         \u003c/div\u003e\n@@ -295,9 +261,9 @@\n     \u003cDivider\u003e\n       \u003cp\u003eOther\u003c/p\u003e\n     \u003c/Divider\u003e\n-    {#each searchedRepos.filter((r)=\u003e!r.selected) as {repo, relay, address} (repo.id)}\n-      \u003cdiv out:fly=\"{{ duration: 200 }}\"\u003e\n-        \u003cGitItem {url} event={repo} showActivity={false} showActions={false}/\u003e\n+    {#each searchedRepos.filter(r =\u003e !r.selected) as { repo, relay, address } (repo.id)}\n+      \u003cdiv out:fly={{duration: 200}}\u003e\n+        \u003cGitItem {url} event={repo} showActivity={false} showActions={false} /\u003e\n         \u003cdiv class=\"flex w-full justify-end\"\u003e\n           \u003cFieldInline\u003e\n             {#snippet input()}\n@@ -307,12 +273,12 @@\n         \u003c/div\u003e\n       \u003c/div\u003e\n     {/each}\n-    {#if loading || $repoEvents.length === 0}\n+    {#if loading || searchedRepos.length === 0}\n       \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n         \u003cSpinner {loading}\u003e\n           {#if loading}\n             Looking for repos...\n-          {:else if $repoEvents.length === 0}\n+          {:else if searchedRepos.length === 0}\n             No Repos found.\n           {/if}\n         \u003c/Spinner\u003e\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex d064661..7b6604d 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -28,6 +28,7 @@\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n \n   const url = decodeRelay($page.params.relay)\n+\n   const mutedPubkeys = getPubkeyTagValues(getListTags($userMutes))\n   const repos: TrustedEvent[] = $state([])\n \n@@ -40,16 +41,13 @@\n     // --- Logging bookmark filter and relays ---\n     const bookmarkFilter = { kinds: [NAMED_BOOKMARKS], authors: [pubkey.get()!] };\n     const bookmarkRelays = [url, ...Router.get().FromUser().getUrls()];\n-    console.log(\"[RepoLoad] Bookmark filter:\", bookmarkFilter, \"Relays:\", bookmarkRelays);\n     let bookmark = [];\n     try {\n       bookmark = await load({\n         relays: bookmarkRelays,\n         filters: [bookmarkFilter],\n       });\n-      console.log(\"[RepoLoad] Bookmark result:\", bookmark);\n     } catch (e) {\n-      console.error(\"[RepoLoad] Bookmark load() error:\", e, \"Relays:\", bookmarkRelays, \"Filter:\", bookmarkFilter);\n       loading = false;\n       return;\n     }\n@@ -66,28 +64,25 @@\n         if (relayHint \u0026\u0026 !relayHints.includes(relayHint)) relayHints.push(relayHint)\n       })\n       const repoFilter = { kinds: [GIT_REPO], authors, \"#d\": dTagValues };\n-      console.log(\"[RepoLoad] Repo filter:\", repoFilter, \"Relay hints:\", relayHints);\n-      let loadedRepos = [];\n       try {\n-        loadedRepos = await load({\n+        await load({\n           relays: relayHints,\n           filters: [repoFilter],\n+          onEvent(event, url) {\n+            repos.push(event);\n+          },\n         });\n-        console.log(\"[RepoLoad] Loaded repos result:\", loadedRepos);\n       } catch (e) {\n-        console.error(\"[RepoLoad] Repo load() error:\", e, \"Relays:\", relayHints, \"Filter:\", repoFilter);\n         loading = false;\n         return;\n       }\n-      loadedBookmarkedRepos = loadedRepos.map(repo =\u003e {\n+      loadedBookmarkedRepos = repos.map(repo =\u003e {\n         const address = Address.fromEvent(repo)\n         const addressString = address.toString()\n         const relayHintFromEvent = Router.get().getRelaysForPubkey(repo.pubkey)?.[0]\n         const hint = relaysOfAddresses.get(addressString) ?? relayHintFromEvent\n         return {address: addressString, event: repo, relayHint: hint}\n       })\n-      loadedRepos.filter(e =\u003e !mutedPubkeys.includes(e.pubkey)).forEach(e =\u003e repos.push(e))\n-      console.log(loadedRepos)\n     }\n     loading = false\n   }\n@@ -118,12 +113,13 @@\n     \u003cdiv class=\"row-2\"\u003e\n       \u003cButton class=\"btn btn-primary btn-sm\" disabled={loading} onclick={onAddRepo}\u003e\n         \u003cIcon icon=\"git\" /\u003e\n-        \u003cspan\u003eAdd Repo\u003c/span\u003e\n+        Add Repo\n       \u003c/Button\u003e\n       \u003cMenuSpaceButton {url} /\u003e\n     \u003c/div\u003e\n   {/snippet}\n \u003c/PageBar\u003e\n+\n \u003cPageContent\u003e\n   \u003cdiv class=\"flex flex-grow flex-col gap-2 overflow-auto p-2\"\u003e\n     {#if loading || repos.length === 0}\n@@ -137,9 +133,9 @@\n         \u003c/Spinner\u003e\n       \u003c/p\u003e\n     {:else}\n-      {#each repos as event (event.id)}\n-        \u003cdiv in:fly class=\"\"\u003e\n-          \u003cGitItem {url} {event} /\u003e\n+      {#each repos as repo (repo.id)}\n+        \u003cdiv in:fly\u003e\n+          \u003cGitItem {url} event={repo} /\u003e\n         \u003c/div\u003e\n       {/each}\n     {/if}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex 5ca7d94..6751668 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -1,71 +1,69 @@\n \u003cscript lang=\"ts\"\u003e\n   import {Button, IssueCard} from \"@nostr-git/ui\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n-  import {deriveNaddrEvent} from \"@app/state\"\n   import {page} from \"$app/stores\"\n-  import {GIT_ISSUE, type TrustedEvent} from \"@welshman/util\"\n-  import {Address} from \"@welshman/util\"\n-  import {load} from \"@welshman/net\"\n-  import {onMount} from \"svelte\"\n+  import {\n+    Address,\n+    COMMENT,\n+    getListTags,\n+    getPubkeyTagValues,\n+    GIT_ISSUE,\n+    type TrustedEvent,\n+  } from \"@welshman/util\"\n+  import {getContext, onMount} from \"svelte\"\n   import {setChecked} from \"@src/app/notifications\"\n   import {nthEq} from \"@welshman/lib\"\n-  import {deriveProfile} from \"@welshman/app\"\n+  import {deriveProfile, userMutes} from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n+  import type {Readable} from \"svelte/store\"\n+  import {makeFeed} from \"@src/app/requests\"\n \n-  // Receive eventStore from layout via $props (Svelte 5 idiom)\n-  const { eventStore } = $props();\n+  const repo = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n+  const [_, ...relays] = $repo.tags.find(nthEq(0, \"relays\")) || []\n+  const mutedPubkeys = getPubkeyTagValues(getListTags($userMutes))\n \n-  const {id, relay} = $page.params\n-  const relayArray = Array.isArray(relay) ? relay : [relay]\n-  const repo = deriveNaddrEvent(id)\n-  let issues = $state([] as TrustedEvent[])\n-  let loading = $state(true)\n-  let currentPage = $state(1)\n-  const pageSize = 10\n-  const pageCount = $derived(() =\u003e Math.max(1, Math.ceil(issues.length / pageSize)))\n-  const paginatedIssues = $derived(() =\u003e\n-    issues.slice((currentPage - 1) * pageSize, currentPage * pageSize),\n-  )\n+  const issueFilter = {\n+    kinds: [GIT_ISSUE, COMMENT],\n+    \"#a\": [Address.fromEvent($repo).toString()],\n+  }\n \n-  async function loadIssues() {\n-    issues.length = 0\n-    const issueFilter = {\n-      kinds: [GIT_ISSUE],\n-      \"#a\": [Address.fromEvent($repo).toString()],\n-    }\n-    const [tagId, ...relays] = $repo.tags.find(nthEq(0, \"relays\")) || []\n+  const issues: TrustedEvent[] = $state([])\n+  const comments: TrustedEvent[] = $state([])\n+\n+  let loading = $state(true)\n+  let element: HTMLElement | undefined = $state()\n \n-    const issue = await load({\n+  onMount(() =\u003e {\n+    const {cleanup} = makeFeed({\n+      element: element!,\n       relays: relays,\n-      filters: [issueFilter],\n-    })\n-    if (issue.length \u003e 0) {\n-      issues.push(...issue)\n-    }\n-  }\n+      feedFilters: [issueFilter],\n+      subscriptionFilters: [issueFilter],\n+      initialEvents: [],\n+      onEvent: event =\u003e {\n+        if (event.kind === GIT_ISSUE \u0026\u0026 !mutedPubkeys.includes(event.pubkey)) {\n+          issues.push(event)\n+        }\n \n-  async function loadIssuesWrapper() {\n-    loading = true\n-    await loadIssues()\n-    loading = false\n-  }\n+        if (event.kind === COMMENT \u0026\u0026 !mutedPubkeys.includes(event.pubkey)) {\n+          comments.push(event)\n+        }\n+      },\n+      onExhausted: () =\u003e {\n+        loading = false\n+      },\n+    })\n \n-  onMount(() =\u003e {\n-    loadIssuesWrapper()\n-    return () =\u003e setChecked($page.url.pathname)\n+    return () =\u003e {\n+      cleanup()\n+      setChecked($page.url.pathname)\n+    }\n   })\n-\n-  function prevPage() {\n-    if (currentPage \u003e 1) currentPage = currentPage - 1\n-  }\n-  function nextPage() {\n-    if (currentPage \u003c pageCount()) currentPage = currentPage + 1\n-  }\n \u003c/script\u003e\n \n-\u003cdiv\u003e\n+\u003cdiv bind:this={element}\u003e\n   \u003cdiv\n-    class=\"z-10 sticky top-0 mb-4 flex items-center justify-between bg-background/95 py-4 backdrop-blur supports-[backdrop-filter]:bg-background/60\"\u003e\n+    class=\"z-10 sticky top-0 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003eIssues\u003c/h2\u003e\n       \u003cp class=\"text-sm text-muted-foreground\"\u003eTrack bugs and feature requests\u003c/p\u003e\n@@ -100,23 +98,10 @@\n       No issues found.\n     \u003c/div\u003e\n   {:else}\n-    \u003cdiv class=\"flex max-h-[32rem] flex-col gap-y-4 overflow-y-auto rounded-md bg-background p-2\"\u003e\n-      {#each paginatedIssues() as issue}\n+    \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n+      {#each issues as issue (issue.id)}\n         \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey, relayArray)} /\u003e\n       {/each}\n     \u003c/div\u003e\n-    \u003cdiv class=\"mt-4 flex items-center justify-center gap-4\"\u003e\n-      \u003cbutton\n-        onclick={prevPage}\n-        class=\"rounded bg-gray-100 px-3 py-1 hover:bg-gray-200 disabled:opacity-50\"\n-        disabled={currentPage === 1}\u003e\u0026larr; Prev\u003c/button\u003e\n-      \u003cspan class=\"text-gray-600\"\u003ePage {currentPage} of {pageCount()}\u003c/span\u003e\n-      \u003cbutton\n-        onclick={nextPage}\n-        class=\"rounded bg-gray-100 px-3 py-1 hover:bg-gray-200 disabled:opacity-50\"\n-        disabled={currentPage === pageCount()}\u003e\n-        Next \u0026rarr;\n-      \u003c/button\u003e\n-    \u003c/div\u003e\n   {/if}\n \u003c/div\u003e\ndiff --git a/vite.config.ts b/vite.config.ts\nindex 67ca659..b10a730 100644\n--- a/vite.config.ts\n+++ b/vite.config.ts\n@@ -1,4 +1,5 @@\n import {config} from \"dotenv\"\n+import path from \"path\"\n import {defineConfig} from \"vite\"\n import {SvelteKitPWA} from \"@vite-pwa/sveltekit\"\n import {sveltekit} from \"@sveltejs/kit/vite\"\n@@ -10,6 +11,13 @@ config({path: \".env.template\"})\n export default defineConfig({\n   server: {\n     port: 1847,\n+    // local serving of package files\n+    fs: {\n+      allow: [\n+        '.',\n+        path.resolve(__dirname, '../'),\n+      ]\n+    }\n   },\n   build: {\n     sourcemap: true,\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-f0q","title":"extensions","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-15T23:51:27.863889-08:00","created_by":"bizarro","updated_at":"2026-01-16T00:16:38.33951-08:00","deleted_at":"2026-01-16T00:16:38.33951-08:00","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"flotilla-fals3iac","title":"Repo search on repos list","description":"Because search bars are awesome","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","enhancement","issue"]}
{"id":"flotilla-fbx3uaad","title":"Posted issues and comments appear on bottom of the list, it should be topmost","description":"When page reloads they are in correct order, so it could be how the subscription pushes new events to the back, rather than the front. ","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue"]}
{"id":"flotilla-fhyj71qs","title":"From ebd491e1666477cb26fca357e92444fe9502ae59 Mon Sep 17 00:00:00 2001","description":"From ebd491e1666477cb26fca357e92444fe9502ae59 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 11 Dec 2025 13:50:34 +1000\nSubject: [PATCH 2/2] ``` feat(terminal): add feature flag for conditional Terminal component loading\n\n- Add dynamic import for Terminal component with __TERMINAL__ feature flag\n- Wrap Terminal component in conditional block to prevent loading when flag is disabled\n- Remove Terminal from static imports, use lazy loading instead\n- Update nostr-git submodule reference (dirty state)\n```\n---\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte | 17 ++++++++++++-----\n 1 file changed, 12 insertions(+), 5 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 424e4ed..f3a80da 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -1,6 +1,6 @@\n \u003cscript lang=\"ts\"\u003e\n   import markdownit from \"markdown-it\"\n-  import {Card, Terminal} from \"@nostr-git/ui\"\n+  import {Card} from \"@nostr-git/ui\"\n   import {\n     CircleAlert,\n     GitBranch,\n@@ -28,6 +28,11 @@\n   import {nip19} from \"nostr-tools\"\n   import {clip, pushToast} from \"@app/util/toast\"\n \n+  let Terminal = $state\u003cany\u003e(null);\n+  if (__TERMINAL__) {\n+    import(\"@nostr-git/ui\").then(m =\u003e Terminal = m.Terminal);\n+  }\n+\n   let {data}: LayoutProps = $props()\n   const {repoClass, repoRelays} = data\n \n@@ -536,10 +541,11 @@\n       {/if}\n     \u003c/div\u003e\n     \u003cdiv class=\"flex-1\" transition:slide\u003e\n-      \u003cTerminal\n-        fs={undefined}\n-        repoRef={repoRefObj}\n-        repoEvent={repoClass.repoEvent}\n+      {#if __TERMINAL__ \u0026\u0026 Terminal}\n+        \u003cTerminal\n+          fs={undefined}\n+          repoRef={repoRefObj}\n+          repoEvent={repoClass.repoEvent}\n         relays={$repoRelays}\n         theme=\"retro\"\n         height={260}\n@@ -557,6 +563,7 @@\n         {defaultBranch}\n         provider={detectedProvider}\n         token={defaultToken} /\u003e\n+      {/if}\n     \u003c/div\u003e\n \n     \u003c!-- README --\u003e\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-fk1oa1w6","title":"From 8f706d191f9faa8c8b449e1a69f1dbce19edb8c5 Mon Sep 17 00:00:00 2001","description":"From 8f706d191f9faa8c8b449e1a69f1dbce19edb8c5 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Thu, 5 Jun 2025 10:16:05 -0700\nSubject: [PATCH 26/67] Flesh out recent activity component\n\n---\n CLAUDE.md                                     |  71 +++++------------------------------------------------------------------\n src/app/components/Content.svelte             |   2 +-\n src/app/components/SpaceRecentActivity.svelte | 187 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------------------------------------\n 3 files changed, 102 insertions(+), 158 deletions(-)\n\ndiff --git a/CLAUDE.md b/CLAUDE.md\nindex 682c0d2..f901715 100644\n--- a/CLAUDE.md\n+++ b/CLAUDE.md\n@@ -6,28 +6,6 @@ This file provides guidance to Claude Code (claude.ai/code) when working with co\n \n Flotilla is a Discord-like Nostr client that operates on the concept of \"relays as groups/spaces.\" Built with SvelteKit 2.5 and Svelte 5, it provides messaging, threads, calendar events, and social features across Nostr relays.\n \n-## Development Commands\n-\n-```bash\n-# Development\n-pnpm run dev          # Start dev server on port 1847\n-pnpm run check        # TypeScript checking\n-pnpm run check:watch  # Watch mode TypeScript checking\n-\n-# Production\n-pnpm run build        # Custom build with env processing\n-./build.sh            # Main build script with PWA assets\n-pnpm run sourcemaps   # Build with sourcemap upload\n-\n-# Code Quality\n-pnpm run lint         # ESLint + Prettier checking\n-pnpm run format       # Auto-format with Prettier\n-\n-# Mobile\n-pnpm run release:android  # Android APK build\n-npx cap sync             # Sync web assets to native\n-```\n-\n ## Architecture\n \n ### Core Technology Stack\n@@ -37,58 +15,18 @@ npx cap sync             # Sync web assets to native\n - **Capacitor 7** - Cross-platform mobile deployment\n - **TypeScript** - Full type safety throughout\n \n-### Key Directories\n-- `/src/app/state.ts` - Global state management, stores, derived values\n-- `/src/app/components/` - 80+ feature-specific Svelte components\n-- `/src/lib/components/` - Shared/generic UI components\n-- `/src/routes/` - SvelteKit file-based routing with dynamic relay/room routes\n-- `/src/app/commands.ts` - User actions and business logic\n-- `/src/assets/icons/` - 60+ custom SVG icons\n-\n ### State Management Patterns\n - Svelte stores with Welshman reactive patterns\n - Repository pattern for Nostr event storage with 10k event limit\n - Derived stores for computed values and real-time updates\n - Event-based architecture with reactive data flow\n \n-### Nostr Integration Architecture\n-- **NIP-29 support** - Group chat functionality via relays\n-- **NIP-46 support** - Remote signing (Nostr Connect/Bunker)\n-- **Event unwrapping** - Handles gift-wrapped messages for privacy\n-- **Real-time relay management** - Automatic connection and authentication\n-- **Web of trust calculations** - User reputation and content filtering\n-\n-### Mobile \u0026 PWA Features\n-- Responsive navigation (drawer on mobile, sidebar on desktop)\n-- Capacitor integration for native mobile apps\n-- PWA with offline support and auto-updating\n-- Safe area handling for iOS/Android\n-\n-## Environment Configuration\n-\n-All environment variables are optional and enable platform customization:\n-\n-```bash\n-# Branding\n-VITE_PLATFORM_NAME=\"Custom Name\"\n-VITE_PLATFORM_LOGO=\"/custom-logo.png\"\n-VITE_PLATFORM_DESCRIPTION=\"Custom description\"\n-\n-# Platform Mode (single-relay instance)\n-VITE_PLATFORM_RELAYS=\"wss://relay.example.com\"\n-\n-# Bootstrap and Discovery\n-VITE_DEFAULT_PUBKEYS=\"npub1...,npub2...\"  # Web of trust seed\n-VITE_INDEXER_RELAYS=\"wss://indexer1.com,wss://indexer2.com\"\n-\n-# Monitoring\n-VITE_GLITCHTIP_API_KEY=\"...\"  # Error reporting\n-```\n-\n-The `build.sh` script processes these variables and generates theme files.\n-\n ## Important Patterns\n \n+### Finding Code\n+- Prefer navigating from one file to the next following imports when possible\n+- If search is necessary, use `ack`, not `grep` or `rg`.\n+\n ### Component Organization\n - Components are organized by feature (Chat, Calendar, Profile, Space)\n - Use existing components from `/lib/components/` before creating new ones\n@@ -103,6 +41,7 @@ The `build.sh` script processes these variables and generates theme files.\n - Events flow through the repository pattern in `state.ts`\n - Use Welshman utilities for event validation and parsing\n - Handle both plain and gift-wrapped events for privacy\n+- Prefer seconds to milliseconds when handling nostr events.\n \n ### Styling Conventions\n - TailwindCSS with DaisyUI components\ndiff --git a/src/app/components/Content.svelte b/src/app/components/Content.svelte\nindex a92778a..74a1980 100644\n--- a/src/app/components/Content.svelte\n+++ b/src/app/components/Content.svelte\n@@ -131,7 +131,7 @@\n     \u003c/div\u003e\n   {:else}\n     \u003cdiv\n-      class=\"flex flex-col overflow-hidden text-ellipsis break-words\"\n+      class=\"overflow-hidden text-ellipsis break-words\"\n       style={expandBlock ? \"mask-image: linear-gradient(0deg, transparent 0px, black 100px)\" : \"\"}\u003e\n       {#each shortContent as parsed, i}\n         {#if isNewline(parsed) \u0026\u0026 !isBlock(i - 1)}\ndiff --git a/src/app/components/SpaceRecentActivity.svelte b/src/app/components/SpaceRecentActivity.svelte\nindex 14b2d0c..c0b7473 100644\n--- a/src/app/components/SpaceRecentActivity.svelte\n+++ b/src/app/components/SpaceRecentActivity.svelte\n@@ -1,70 +1,70 @@\n \u003cscript lang=\"ts\"\u003e\n+  import {derived} from \"svelte/store\"\n+  import {groupBy, first, last, uniq, avg, overlappingPairs} from \"@welshman/lib\"\n+  import {formatTimestamp} from \"@welshman/lib\"\n+  import {MESSAGE, getTagValue} from \"@welshman/util\"\n+  import type {TrustedEvent} from \"@welshman/util\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n+  import Content from \"@app/components/Content.svelte\"\n   import ProfileCircle from \"@app/components/ProfileCircle.svelte\"\n   import ProfileCircles from \"@app/components/ProfileCircles.svelte\"\n-  import {formatTimestamp} from \"@welshman/lib\"\n+  import {deriveEventsForUrl} from \"@app/state\"\n \n-  interface Props {\n+  type Props = {\n     url: string\n   }\n \n   const {url}: Props = $props()\n \n-  // Mock conversation data similar to Slack's threads view\n-  const mockConversations = [\n-    {\n-      id: \"conv1\",\n-      starter: {\n-        pubkey: \"npub1xyz123\",\n-        content:\n-          \"What's everyone's thoughts on the new relay implementation? I'm seeing some interesting performance improvements...\",\n-        timestamp: Date.now() - 3600000, // 1 hour ago\n-      },\n-      room: \"general\",\n-      replyCount: 12,\n-      lastActivity: Date.now() - 900000, // 15 minutes ago\n-      participants: [\"npub1abc\", \"npub1def\", \"npub1ghi\", \"npub1jkl\"],\n-      latestReply: {\n-        pubkey: \"npub1abc\",\n-        content: \"The latency improvements are definitely noticeable in my tests\",\n-      },\n-    },\n-    {\n-      id: \"conv2\",\n-      starter: {\n-        pubkey: \"npub2abc456\",\n-        content:\n-          \"Has anyone tried the new calendar integration? Looking for feedback before we roll it out to more spaces\",\n-        timestamp: Date.now() - 7200000, // 2 hours ago\n-      },\n-      room: \"development\",\n-      replyCount: 8,\n-      lastActivity: Date.now() - 1800000, // 30 minutes ago\n-      participants: [\"npub2def\", \"npub2ghi\", \"npub2jkl\"],\n-      latestReply: {\n-        pubkey: \"npub2def\",\n-        content: \"Works great on mobile, had one small sync issue but figured it out\",\n-      },\n-    },\n-    {\n-      id: \"conv3\",\n-      starter: {\n-        pubkey: \"npub3def789\",\n-        content:\n-          \"Quick question about zap splitting - should we implement this at the relay level or client level?\",\n-        timestamp: Date.now() - 10800000, // 3 hours ago\n-      },\n-      room: \"random\",\n-      replyCount: 5,\n-      lastActivity: Date.now() - 3600000, // 1 hour ago\n-      participants: [\"npub3abc\", \"npub3ghi\"],\n-      latestReply: {\n-        pubkey: \"npub3abc\",\n-        content: \"I think client level makes more sense for privacy\",\n-      },\n-    },\n-  ]\n+  const messages = deriveEventsForUrl(url, [{kinds: [MESSAGE]}])\n+\n+  const conversations = derived(messages, $messages =\u003e {\n+    const convs = []\n+\n+    for (const [room, messages] of groupBy(e =\u003e getTagValue(\"h\", e.tags), $messages).entries()) {\n+      const avgTime = avg(overlappingPairs(messages).map(([a, b]) =\u003e a.created_at - b.created_at))\n+      const groups: TrustedEvent[][] = []\n+      const group: TrustedEvent[] = []\n+\n+      // Group conversations by time between messages\n+      let prevCreatedAt = messages[0].created_at\n+      for (const message of messages) {\n+        if (prevCreatedAt - message.created_at \u003c avgTime) {\n+          group.push(message)\n+        } else {\n+          groups.push(group.splice(0))\n+        }\n+\n+        prevCreatedAt = message.created_at\n+      }\n+\n+      if (group.length \u003e 0) {\n+        groups.push(group.splice(0))\n+      }\n+\n+      // Convert each group into a conversation\n+      for (const events of groups) {\n+        if (events.length \u003c 2) {\n+          continue\n+        }\n+\n+        const latest = first(events)!\n+        const earliest = last(events)!\n+        const participants = uniq(events.map(msg =\u003e msg.pubkey))\n+\n+        convs.push({room, events, latest, earliest, participants})\n+      }\n+    }\n+\n+    return convs\n+  })\n+\n+  const viewMore = () =\u003e {\n+    limit += 3\n+  }\n+\n+  let limit = $state(3)\n \u003c/script\u003e\n \n \u003cdiv class=\"card2 bg-alt\"\u003e\n@@ -74,53 +74,58 @@\n       Recent Conversations\n     \u003c/h3\u003e\n     \u003cdiv class=\"flex flex-col gap-4\"\u003e\n-      {#each mockConversations as conversation (conversation.id)}\n-        \u003cdiv class=\"card2 bg-alt\"\u003e\n-          \u003cdiv class=\"flex flex-col gap-3\"\u003e\n-            \u003cdiv class=\"flex items-start gap-3\"\u003e\n-              \u003cProfileCircle pubkey={conversation.starter.pubkey} size={10} /\u003e\n-              \u003cdiv class=\"min-w-0 flex-1\"\u003e\n-                \u003cdiv class=\"flex items-center gap-2 text-sm opacity-70\"\u003e\n-                  \u003cspan class=\"font-medium text-blue-400\"\u003e#{conversation.room}\u003c/span\u003e\n-                  \u003cspan class=\"opacity-50\"\u003e•\u003c/span\u003e\n-                  \u003cspan\u003e{formatTimestamp(conversation.starter.timestamp)}\u003c/span\u003e\n-                \u003c/div\u003e\n-                \u003cdiv class=\"flex flex-col gap-2\"\u003e\n-                  \u003cp class=\"text-base leading-relaxed\"\u003e{conversation.starter.content}\u003c/p\u003e\n+      {#if $conversations.length === 0}\n+        \u003cdiv class=\"py-8 text-center opacity-70\"\u003e\n+          \u003cp\u003eNo recent conversations\u003c/p\u003e\n+        \u003c/div\u003e\n+      {:else}\n+        {#each $conversations.slice(0, limit) as { room, events, latest, earliest, participants } (latest.id)}\n+          \u003cdiv class=\"card2 bg-alt\"\u003e\n+            \u003cdiv class=\"flex flex-col gap-3\"\u003e\n+              \u003cdiv class=\"flex items-start gap-3\"\u003e\n+                \u003cProfileCircle pubkey={earliest.pubkey} size={10} /\u003e\n+                \u003cdiv class=\"min-w-0 flex-1\"\u003e\n+                  \u003cdiv class=\"flex items-center gap-2 text-sm opacity-70\"\u003e\n+                    \u003cspan class=\"font-medium text-blue-400\"\u003e#{room}\u003c/span\u003e\n+                    \u003cspan class=\"opacity-50\"\u003e•\u003c/span\u003e\n+                    \u003cspan\u003e{formatTimestamp(earliest.created_at)}\u003c/span\u003e\n+                  \u003c/div\u003e\n+                  \u003cContent minimalQuote minLength={100} maxLength={200} event={earliest} /\u003e\n                 \u003c/div\u003e\n               \u003c/div\u003e\n-            \u003c/div\u003e\n-            \u003cdiv class=\"ml-13 flex items-center justify-between\"\u003e\n-              \u003cdiv class=\"flex items-center gap-4\"\u003e\n-                \u003cspan class=\"flex items-center gap-2 text-sm opacity-70\"\u003e\n-                  \u003cIcon icon=\"alt-arrow-left\" size={4} /\u003e\n-                  {conversation.replyCount} replies\n-                \u003c/span\u003e\n-                \u003cdiv class=\"flex -space-x-2\"\u003e\n-                  \u003cProfileCircles pubkeys={conversation.participants} size={6} /\u003e\n+              \u003cdiv class=\"ml-13 flex items-center justify-between\"\u003e\n+                \u003cdiv class=\"flex items-center gap-4\"\u003e\n+                  \u003cspan class=\"flex items-center gap-2 text-sm opacity-70\"\u003e\n+                    \u003cIcon icon=\"alt-arrow-left\" size={4} /\u003e\n+                    {events.length} messages\n+                  \u003c/span\u003e\n+                  \u003cdiv class=\"flex -space-x-2\"\u003e\n+                    \u003cProfileCircles pubkeys={participants} size={6} /\u003e\n+                  \u003c/div\u003e\n                 \u003c/div\u003e\n+                \u003cspan class=\"text-sm opacity-50\"\u003e\n+                  {formatTimestamp(latest.created_at)}\n+                \u003c/span\u003e\n               \u003c/div\u003e\n-              \u003cspan class=\"text-sm opacity-50\"\u003e\n-                {formatTimestamp(conversation.lastActivity)}\n-              \u003c/span\u003e\n-            \u003c/div\u003e\n-            {#if conversation.latestReply}\n               \u003cdiv class=\"card2 bg-alt\"\u003e\n                 \u003cdiv class=\"flex flex-col gap-2\"\u003e\n                   \u003cdiv class=\"flex items-center gap-2 text-sm opacity-70\"\u003e\n-                    \u003cProfileCircle pubkey={conversation.latestReply.pubkey} size={5} /\u003e\n+                    \u003cProfileCircle pubkey={latest.pubkey} size={5} /\u003e\n                     \u003cspan class=\"font-medium\"\u003eLatest reply:\u003c/span\u003e\n                   \u003c/div\u003e\n-                  \u003cp class=\"text-sm leading-relaxed opacity-90\"\u003e\n-                    {conversation.latestReply.content}\n-                  \u003c/p\u003e\n+                  \u003cContent minimalQuote minLength={100} maxLength={200} event={latest} /\u003e\n                 \u003c/div\u003e\n               \u003c/div\u003e\n-            {/if}\n+            \u003c/div\u003e\n           \u003c/div\u003e\n-        \u003c/div\u003e\n-      {/each}\n-      \u003cButton class=\"btn btn-primary btn-sm\"\u003eView all conversations →\u003c/Button\u003e\n+        {/each}\n+        {#if $conversations.length \u003e limit}\n+          \u003cButton class=\"btn btn-primary\" onclick={viewMore}\u003e\n+            View more conversations\n+            \u003cIcon icon=\"alt-arrow-down\" /\u003e\n+          \u003c/Button\u003e\n+        {/if}\n+      {/if}\n     \u003c/div\u003e\n   \u003c/div\u003e\n \u003c/div\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-foq2igxj","title":"From 314c3de4c8fcba82107bb7b65fdd86ef8c5cbc56 Mon Sep 17 00:00:00 2001","description":"From 314c3de4c8fcba82107bb7b65fdd86ef8c5cbc56 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Fri, 27 Jun 2025 07:16:31 -0700\nSubject: [PATCH 8/9] refactor: replace context usage with props for repo data access in issue pages\n\n---\n packages/nostr-git                                              | 2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte    | 3 ++-\n src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte | 2 --\n 3 files changed, 3 insertions(+), 4 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex ced0a44..606defd 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit ced0a443ff4f13e5095277df8893606846885a29\n+Subproject commit 606defd36b6ebb5e3c961d6953794097ebad46a5\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex f0699e5..0fd2bb4 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -15,7 +15,8 @@\n   import { REPO_KEY, REPO_RELAYS_KEY } from \"@src/app/state\"\n   import { postComment, postIssue } from \"@src/app/commands\"\n \n-  const repoClass = getContext\u003cRepo\u003e(REPO_KEY)\n+  const {data} = $props()\n+  const {repoClass} = data\n \n   const commentFilter = {\n     kinds: [COMMENT],\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\nindex 023f6e4..c738dd3 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n@@ -26,11 +26,9 @@\n   let mergeAnalysis = $state\u003cany\u003e(null)\n   let isAnalyzing = $state(false)\n \n-  // Simulate merge analysis when both patch and commit are selected\n   $effect(() =\u003e {\n     if ($selectedPatch \u0026\u0026 $selectedCommit) {\n       isAnalyzing = true\n-      // Simulate analysis delay\n       setTimeout(() =\u003e {\n         mergeAnalysis = {\n           compatibility: $selectedPatch.id === \"patch-002\" ? \"conflicts\" : \"clean\",\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-fqqexxb7","title":"From 51876e7bbb2e97e44b330ef73a24f3a5ce2dcc89 Mon Sep 17 00:00:00 2001","description":"From 51876e7bbb2e97e44b330ef73a24f3a5ce2dcc89 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Thu, 5 Jun 2025 09:13:48 -0700\nSubject: [PATCH 24/67] Add tos and pp links\n\n---\n src/assets/icons/Bill List.svg         |  9 +++++++++\n src/assets/icons/Shield User.svg       |  5 +++++\n src/lib/components/Icon.svelte         |  4 ++++\n src/routes/spaces/[relay]/+page.svelte | 16 ++++++++++++++++\n 4 files changed, 34 insertions(+)\n create mode 100644 src/assets/icons/Bill List.svg\n create mode 100644 src/assets/icons/Shield User.svg\n\ndiff --git a/src/assets/icons/Bill List.svg b/src/assets/icons/Bill List.svg\nnew file mode 100644\nindex 0000000..bea2f2d\n--- /dev/null\n+++ b/src/assets/icons/Bill List.svg\n@@ -0,0 +1,9 @@\n+\u003csvg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"\u003e\n+\u003cpath d=\"M16.755 2H7.24502C6.08614 2 5.50671 2 5.03939 2.16261C4.15322 2.47096 3.45748 3.18719 3.15795 4.09946C3 4.58055 3 5.17705 3 6.37006V20.3742C3 21.2324 3.985 21.6878 4.6081 21.1176C4.97417 20.7826 5.52583 20.7826 5.8919 21.1176L6.375 21.5597C7.01659 22.1468 7.98341 22.1468 8.625 21.5597C9.26659 20.9726 10.2334 20.9726 10.875 21.5597C11.5166 22.1468 12.4834 22.1468 13.125 21.5597C13.7666 20.9726 14.7334 20.9726 15.375 21.5597C16.0166 22.1468 16.9834 22.1468 17.625 21.5597L18.1081 21.1176C18.4742 20.7826 19.0258 20.7826 19.3919 21.1176C20.015 21.6878 21 21.2324 21 20.3742V6.37006C21 5.17705 21 4.58055 20.842 4.09946C20.5425 3.18719 19.8468 2.47096 18.9606 2.16261C18.4933 2 17.9139 2 16.755 2Z\" stroke=\"#1C274C\" stroke-width=\"1.5\"/\u003e\n+\u003cpath d=\"M10.5 11L17 11\" stroke=\"#1C274C\" stroke-width=\"1.5\" stroke-linecap=\"round\"/\u003e\n+\u003cpath d=\"M7 11H7.5\" stroke=\"#1C274C\" stroke-width=\"1.5\" stroke-linecap=\"round\"/\u003e\n+\u003cpath d=\"M7 7.5H7.5\" stroke=\"#1C274C\" stroke-width=\"1.5\" stroke-linecap=\"round\"/\u003e\n+\u003cpath d=\"M7 14.5H7.5\" stroke=\"#1C274C\" stroke-width=\"1.5\" stroke-linecap=\"round\"/\u003e\n+\u003cpath d=\"M10.5 7.5H17\" stroke=\"#1C274C\" stroke-width=\"1.5\" stroke-linecap=\"round\"/\u003e\n+\u003cpath d=\"M10.5 14.5H17\" stroke=\"#1C274C\" stroke-width=\"1.5\" stroke-linecap=\"round\"/\u003e\n+\u003c/svg\u003e\ndiff --git a/src/assets/icons/Shield User.svg b/src/assets/icons/Shield User.svg\nnew file mode 100644\nindex 0000000..284478e\n--- /dev/null\n+++ b/src/assets/icons/Shield User.svg\n@@ -0,0 +1,5 @@\n+\u003csvg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"\u003e\n+\u003cpath d=\"M3 10.4167C3 7.21907 3 5.62028 3.37752 5.08241C3.75503 4.54454 5.25832 4.02996 8.26491 3.00079L8.83772 2.80472C10.405 2.26824 11.1886 2 12 2C12.8114 2 13.595 2.26824 15.1623 2.80472L15.7351 3.00079C18.7417 4.02996 20.245 4.54454 20.6225 5.08241C21 5.62028 21 7.21907 21 10.4167C21 10.8996 21 11.4234 21 11.9914C21 17.6294 16.761 20.3655 14.1014 21.5273C13.38 21.8424 13.0193 22 12 22C10.9807 22 10.62 21.8424 9.89856 21.5273C7.23896 20.3655 3 17.6294 3 11.9914C3 11.4234 3 10.8996 3 10.4167Z\" stroke=\"#1C274C\" stroke-width=\"1.5\"/\u003e\n+\u003ccircle cx=\"12\" cy=\"9\" r=\"2\" stroke=\"#1C274C\" stroke-width=\"1.5\"/\u003e\n+\u003cpath d=\"M16 15C16 16.1046 16 17 12 17C8 17 8 16.1046 8 15C8 13.8954 9.79086 13 12 13C14.2091 13 16 13.8954 16 15Z\" stroke=\"#1C274C\" stroke-width=\"1.5\"/\u003e\n+\u003c/svg\u003e\ndiff --git a/src/lib/components/Icon.svelte b/src/lib/components/Icon.svelte\nindex f188cc5..61fd42d 100644\n--- a/src/lib/components/Icon.svelte\n+++ b/src/lib/components/Icon.svelte\n@@ -10,6 +10,7 @@\n   import AddSquare from \"@assets/icons/Add Square.svg?dataurl\"\n   import ArrowsALogout2 from \"@assets/icons/Arrows ALogout 2.svg?dataurl\"\n   import Bookmark from \"@assets/icons/Bookmark.svg?dataurl\"\n+  import BillList from \"@assets/icons/Bill List.svg?dataurl\"\n   import Code2 from \"@assets/icons/Code 2.svg?dataurl\"\n   import Document from \"@assets/icons/Document.svg?dataurl\"\n   import Earth from \"@assets/icons/Earth.svg?dataurl\"\n@@ -75,6 +76,7 @@\n   import Server from \"@assets/icons/Server.svg?dataurl\"\n   import Settings from \"@assets/icons/Settings.svg?dataurl\"\n   import SettingsMinimalistic from \"@assets/icons/Settings Minimalistic.svg?dataurl\"\n+  import ShieldUser from \"@assets/icons/Shield User.svg?dataurl\"\n   import Station from \"@assets/icons/Station.svg?dataurl\"\n   import TagHorizontal from \"@assets/icons/Tag Horizontal.svg?dataurl\"\n   import Ticket from \"@assets/icons/Ticket.svg?dataurl\"\n@@ -109,6 +111,7 @@\n     \"add-square\": AddSquare,\n     \"arrows-a-logout-2\": ArrowsALogout2,\n     bookmark: Bookmark,\n+    \"bill-list\": BillList,\n     \"code-2\": Code2,\n     document: Document,\n     earth: Earth,\n@@ -177,6 +180,7 @@\n     server: Server,\n     settings: Settings,\n     \"settings-minimalistic\": SettingsMinimalistic,\n+    \"shield-user\": ShieldUser,\n     station: Station,\n     \"tag-horizontal\": TagHorizontal,\n     ticket: Ticket,\ndiff --git a/src/routes/spaces/[relay]/+page.svelte b/src/routes/spaces/[relay]/+page.svelte\nindex 648060e..c9c0d8f 100644\n--- a/src/routes/spaces/[relay]/+page.svelte\n+++ b/src/routes/spaces/[relay]/+page.svelte\n@@ -122,6 +122,22 @@\n       \u003c/div\u003e\n     \u003c/div\u003e\n     \u003cRelayDescription {url} /\u003e\n+    {#if $relay?.profile?.terms_of_service || $relay?.profile?.privacy_policy}\n+      \u003cdiv class=\"flex gap-3\"\u003e\n+        {#if $relay.profile.terms_of_service}\n+          \u003cLink href={$relay.profile.terms_of_service} class=\"badge badge-neutral flex gap-2\"\u003e\n+            \u003cIcon icon=\"bill-list\" size={4} /\u003e\n+            Terms of Service\n+          \u003c/Link\u003e\n+        {/if}\n+        {#if $relay.profile.privacy_policy}\n+          \u003cLink href={$relay?.profile?.privacy_policy} class=\"badge badge-neutral flex gap-2\"\u003e\n+            \u003cIcon icon=\"shield-user\" size={4} /\u003e\n+            Privacy Policy\n+          \u003c/Link\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    {/if}\n   \u003c/div\u003e\n   \u003cSpaceQuickLinks {url} /\u003e\n   \u003cdiv class=\"grid grid-cols-1 gap-2 lg:grid-cols-2\"\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-fs91tebs","title":"From 08a45e41bbeac8e9f6ee66bb061737597cf4e69a Mon Sep 17 00:00:00 2001","description":"From 08a45e41bbeac8e9f6ee66bb061737597cf4e69a Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Wed, 13 Aug 2025 23:14:18 -0700\nSubject: [PATCH 3/6] feat: add GRASP server management to profile settings and repo creation\n\n---\n packages/nostr-git                         |   2 +-\n scripts/verify-events.mjs                  | 121 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/settings/profile/+page.svelte   |  61 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-\n src/routes/spaces/[relay]/git/+page.svelte |  35 ++++++++++++++++++++++++++++++++---\n 4 files changed, 214 insertions(+), 5 deletions(-)\n create mode 100644 scripts/verify-events.mjs\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 1e1f587..5e6761b 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 1e1f58716df6dc7cd56e00879591812db93b3204\n+Subproject commit 5e6761b52cdbe71837afbc5d2445721b36c22c11\ndiff --git a/scripts/verify-events.mjs b/scripts/verify-events.mjs\nnew file mode 100644\nindex 0000000..4df340c\n--- /dev/null\n+++ b/scripts/verify-events.mjs\n@@ -0,0 +1,121 @@\n+import { createRepoAnnouncementEvent as createAnnouncement, createRepoStateEvent as createState } from '@nostr-git/shared-types';\n+\n+function ensureNoGitSuffix(url) {\n+  return url?.replace(/\\.git$/, '') ?? '';\n+}\n+\n+function toHttpFromWs(raw) {\n+  return (raw || '')\n+    .replace(/^ws:\\/\\//, 'http://')\n+    .replace(/^wss:\\/\\//, 'https://');\n+}\n+\n+function normalizeRelayWsOrigin(u) {\n+  if (!u) return '';\n+  try {\n+    const url = new URL(u);\n+    const origin = `${url.protocol}//${url.host}`;\n+    return origin.replace(/^http:\\/\\//, 'ws://').replace(/^https:\\/\\//, 'wss://');\n+  } catch {\n+    return u\n+      .replace(/^http:\\/\\//, 'ws://')\n+      .replace(/^https:\\/\\//, 'wss://')\n+      .replace(/(ws[s]?:\\/\\/[^/]+).*/, '$1');\n+  }\n+}\n+\n+function buildRelays(relayUrl) {\n+  const baseRelay = normalizeRelayWsOrigin(relayUrl || '');\n+  const aliases = [];\n+  if (baseRelay) aliases.push(baseRelay);\n+  const viteAliases = (import.meta?.env?.VITE_GRASP_RELAY_ALIASES);\n+  if (viteAliases) viteAliases.split(',').map(s =\u003e s.trim()).filter(Boolean).forEach(a =\u003e aliases.push(a));\n+  const nodeAliases = (globalThis?.process?.env?.VITE_GRASP_RELAY_ALIASES);\n+  if (nodeAliases) nodeAliases.split(',').map(s =\u003e s.trim()).filter(Boolean).forEach(a =\u003e aliases.push(a));\n+  if (baseRelay) {\n+    const u = new URL(baseRelay);\n+    const port = u.port ? `:${u.port}` : '';\n+    aliases.push(`${u.protocol}//ngit-relay${port}`);\n+  }\n+  const seen = new Set();\n+  return aliases.filter(a =\u003e { if (seen.has(a)) return false; seen.add(a); return true; });\n+}\n+\n+function verifyGrasp() {\n+  const config = {\n+    name: 'alice/example',\n+    provider: 'grasp',\n+    relayUrl: 'wss://relay.example.org',\n+    cloneUrl: 'wss://relay.example.org/git/alice/example.git',\n+    webUrl: '' ,\n+    defaultBranch: 'main',\n+    description: 'Test repo',\n+    maintainers: ['npub1example...'],\n+    tags: ['test']\n+  };\n+  const localRepo = { initialCommit: 'deadbeef' };\n+\n+  const cloneUrl = toHttpFromWs(config.cloneUrl);\n+  const webUrl = ensureNoGitSuffix(config.webUrl || cloneUrl);\n+  const relays = buildRelays(config.relayUrl);\n+\n+  const ann = createAnnouncement({\n+    repoId: config.name,\n+    name: config.name,\n+    description: config.description,\n+    web: webUrl ? [webUrl] : undefined,\n+    clone: cloneUrl ? [cloneUrl] : undefined,\n+    relays,\n+    maintainers: config.maintainers,\n+    hashtags: config.tags,\n+    earliestUniqueCommit: localRepo.initialCommit,\n+  });\n+\n+  const refs = [{ type: 'heads', name: config.defaultBranch, commit: localRepo.initialCommit }];\n+  const state = createState({ repoId: config.name, refs, head: config.defaultBranch });\n+\n+  return { ann, state };\n+}\n+\n+function verifyGithub() {\n+  const config = {\n+    name: 'alice/example',\n+    provider: 'github',\n+    cloneUrl: 'https://github.com/alice/example.git',\n+    webUrl: 'https://github.com/alice/example',\n+    defaultBranch: 'main',\n+    description: 'Test repo',\n+  };\n+  const localRepo = { initialCommit: 'cafebabe' };\n+\n+  const cloneUrl = config.cloneUrl;\n+  const webUrl = ensureNoGitSuffix(config.webUrl || cloneUrl);\n+\n+  const ann = createAnnouncement({\n+    repoId: config.name,\n+    name: config.name,\n+    description: config.description,\n+    web: [webUrl],\n+    clone: [cloneUrl],\n+  });\n+\n+  const refs = [{ type: 'heads', name: config.defaultBranch, commit: localRepo.initialCommit }];\n+  const state = createState({ repoId: config.name, refs, head: config.defaultBranch });\n+\n+  return { ann, state };\n+}\n+\n+function main() {\n+  const grasp = verifyGrasp();\n+  const gh = verifyGithub();\n+  console.log('=== GRASP Announcement ===');\n+  console.log(JSON.stringify(grasp.ann, null, 2));\n+  console.log('=== GRASP State ===');\n+  console.log(JSON.stringify(grasp.state, null, 2));\n+  console.log('=== GitHub Announcement ===');\n+  console.log(JSON.stringify(gh.ann, null, 2));\n+  console.log('=== GitHub State ===');\n+  console.log(JSON.stringify(gh.state, null, 2));\n+}\n+\n+main();\ndiff --git a/src/routes/settings/profile/+page.svelte b/src/routes/settings/profile/+page.svelte\nindex 12ac6df..6cf37c8 100644\n--- a/src/routes/settings/profile/+page.svelte\n+++ b/src/routes/settings/profile/+page.svelte\n@@ -17,6 +17,45 @@\n   import {pushModal} from \"@app/modal\"\n   import {clip} from \"@app/toast\"\n   import GitAuth from \"@src/app/components/GitAuth.svelte\"\n+  import { GraspServersPanel } from \"@nostr-git/ui\";\n+\n+  // Nostr data access (patterns from spaces/[relay]/git/+page.svelte)\n+  import { repository, publishThunk } from \"@welshman/app\";\n+  import { load } from \"@welshman/net\";\n+  import { deriveEvents } from \"@welshman/store\";\n+  import { Router } from \"@welshman/router\";\n+  import { GRASP_SET_KIND, DEFAULT_GRASP_SET_ID, parseGraspServersEvent } from \"@nostr-git/core\";\n+\n+  // Local state fed into GraspServersPanel\n+  let graspUrls = $state\u003cstring[]\u003e([]);\n+\n+  // Event handlers for GraspServersPanel. Integrate with your app's Nostr layer.\n+  function handleReload() {\n+    const author = $session?.pubkey;\n+    if (!author) return;\n+    const filters = [\n+      { kinds: [GRASP_SET_KIND], authors: [author], \"#d\": [DEFAULT_GRASP_SET_ID], limit: 1 },\n+    ];\n+    const relays = Router.get().FromUser().getUrls();\n+    load({ relays, filters });\n+    // Subscribe once to repository for these filters and update urls\n+    const store = deriveEvents(repository, { filters });\n+    const unsub = store.subscribe((events) =\u003e {\n+      if (events \u0026\u0026 events.length \u003e 0) {\n+        graspUrls = parseGraspServersEvent(events[0] as any);\n+        unsub();\n+      }\n+    });\n+  }\n+\n+  function handleSave(e: CustomEvent\u003c{ unsigned: { kind: number; created_at: number; tags: string[][]; content: string }; urls: string[] }\u003e) {\n+    const author = $session?.pubkey;\n+    if (!author) return;\n+    const { unsigned } = e.detail;\n+    const relays = Router.get().FromUser().getUrls();\n+    // TODO: sign 'unsigned' with app signer if required. If your stack auto-signs in publishThunk, this is sufficient.\n+    publishThunk({ relays, event: unsigned as any });\n+  }\n \n   const profile = deriveProfile($pubkey!)\n \n@@ -32,7 +71,14 @@\n \n   const startDelete = () =\u003e pushModal(ProfileDelete)\n \n-  let showAdvanced = false\n+  let showAdvanced = $state(false)\n+\n+  // Load current GRASP servers once session pubkey is available\n+  $effect(() =\u003e {\n+    if ($session?.pubkey) {\n+      handleReload();\n+    }\n+  });\n \n \u003c/script\u003e\n \n@@ -135,6 +181,19 @@\n \n   \u003cGitAuth tokenKey=\"gh_tokens\" /\u003e\n \n+  \u003c!-- GRASP Servers Settings --\u003e\n+  \u003cdiv class=\"card2 bg-alt shadow-xl\"\u003e\n+    \u003cdiv class=\"flex items-center justify-between\"\u003e\n+      \u003cstrong class=\"flex items-center gap-3\"\u003e\n+        \u003cIcon icon=\"settings\" /\u003e\n+        GRASP Servers\n+      \u003c/strong\u003e\n+    \u003c/div\u003e\n+    \u003cdiv class=\"pt-4\"\u003e\n+      \u003cGraspServersPanel pubkey={$session?.pubkey} urls={graspUrls} on:reload={handleReload} on:save={handleSave} /\u003e\n+    \u003c/div\u003e\n+  \u003c/div\u003e\n+\n   \u003cAlerts /\u003e\n \n   \u003cdiv class=\"card2 bg-alt shadow-xl\"\u003e\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 44b481b..e70f288 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -20,8 +20,9 @@\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {derived as _derived} from \"svelte/store\"\n-  import { NewRepoWizard } from \"@nostr-git/ui\"\n-    import type { RepoAnnouncementEvent } from \"@nostr-git/shared-types\"\n+  import {NewRepoWizard} from \"@nostr-git/ui\"\n+  import type {RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n+  import { GRASP_SET_KIND, DEFAULT_GRASP_SET_ID, parseGraspServersEvent } from \"@nostr-git/core\";\n \n   const url = decodeRelay($page.params.relay)\n \n@@ -31,7 +32,7 @@\n \n   const bookmarkFilter = {\n     kinds: [NAMED_BOOKMARKS],\n-    '#d': [GIT_REPO_BOOKMARK_DTAG],\n+    \"#d\": [GIT_REPO_BOOKMARK_DTAG],\n     authors: [pubkey.get()!],\n   }\n \n@@ -69,6 +70,33 @@\n     }\n   })\n \n+  // Load user's saved GRASP servers (profile settings) and expose as list of URLs\n+  const graspServersFilter = {\n+    kinds: [GRASP_SET_KIND],\n+    authors: [pubkey.get()!],\n+    \"#d\": [DEFAULT_GRASP_SET_ID],\n+  };\n+\n+  const graspServersEvent = _derived(\n+    deriveEvents(repository, { filters: [graspServersFilter] }),\n+    (events: TrustedEvent[]) =\u003e {\n+      if (events.length === 0) {\n+        load({ relays: Router.get().FromUser().getUrls(), filters: [graspServersFilter] });\n+      }\n+      return events[0];\n+    }\n+  );\n+\n+  // Keep a reactive list of saved GRASP servers\n+  let graspServerUrls = $state\u003cstring[]\u003e([])\n+  graspServersEvent.subscribe((ev) =\u003e {\n+    try {\n+      graspServerUrls = ev ? (parseGraspServersEvent(ev as any) as string[]) : []\n+    } catch {\n+      graspServerUrls = []\n+    }\n+  })\n+\n   const loadedBookmarkedRepos = $derived.by(() =\u003e {\n     if ($repos) {\n       return $repos.map(repo =\u003e {\n@@ -116,6 +144,7 @@\n             event,\n           })\n         },\n+        graspServerUrls: graspServerUrls,\n       },\n       {\n         fullscreen: true,\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-fufi1ytl","title":"Clicking Repo Name should go to Repo Overview","description":"it is more intuitive than the btn-icon","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue"]}
{"id":"flotilla-g0pxsmjd","title":"From e6ced77299d646cf0cf5105585de40a9f1a9708c Mon Sep 17 00:00:00 2001","description":"From e6ced77299d646cf0cf5105585de40a9f1a9708c Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Fri, 1 Aug 2025 07:43:40 -0700\nSubject: [PATCH 6/8] chore: remove hardcoded components\n\n---\n packages/nostr-git                   | 2 +-\n src/app/components/GitAuthAdd.svelte | 2 --\n 2 files changed, 1 insertion(+), 3 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex d0a5ea8..1354055 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit d0a5ea8806c88cc784540fa52a5a02bebd9e0c4c\n+Subproject commit 13540557d285f4829a7b11627f14af0243233608\ndiff --git a/src/app/components/GitAuthAdd.svelte b/src/app/components/GitAuthAdd.svelte\nindex 4f277ce..518f256 100644\n--- a/src/app/components/GitAuthAdd.svelte\n+++ b/src/app/components/GitAuthAdd.svelte\n@@ -22,8 +22,6 @@\n   const key = tokenKey\n \n   const back = () =\u003e history.back()\n-  //ghp_REDACTED_TOKEN\n-  //ghp_REDACTED_TOKEN\n   const disabled = $state(true)\n \n   let host = $state(editToken?.host || \"\")\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-g2b5q8x7","title":"From 5f08cd5af970fe2a55896408553e023b492961f6 Mon Sep 17 00:00:00 2001","description":"From 5f08cd5af970fe2a55896408553e023b492961f6 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sat, 20 Dec 2025 17:32:42 +0500\nSubject: [PATCH] fix: add reactive branch switching and sync for code/commits pages\n\nImplement reactive branch switching with proper content updates and remote\nsynchronization for repository code and commits views.\n\nProblems Fixed:\n- Branch switching displayed loading state but didn't update content\n- Code page showed files from previous branch after switching\n- Commits page didn't reload commits for new branch\n- Initial repository load didn't sync with remote for latest content\n- Branch switch completion wasn't properly tracked for UI updates\n\nChanges:\n\nCode Page (src/routes/.../code/+page.svelte):\n- Added branchSwitchComplete reactive trigger to track branch switch lifecycle\n- Added wasSwitching state to detect when isBranchSwitching transitions false\n- Enhanced file loading effects to react to branchSwitchComplete changes\n- Added syncWithRemote call after initial repository clone\n- Added explicit branch tracking in file loading with switchTrigger\n- Improved loading state management during branch operations\n- Added debug logging for branch switch and file loading events\n\nCommits Page (src/routes/.../commits/+page.svelte):\n- Added similar branch switch completion tracking mechanism\n- Added reactive effects to reload commits when branch switch completes\n- Enhanced commit loading to properly respond to branch changes\n- Added loading state during branch transitions\n\nSubmodule Update (packages/nostr-git):\n- Updated to fc3a7f8 which includes branch switching fixes in:\n  * Worker sync layer for proper branch fetching and checkout\n  * Browser git layer for remote branch resolution\n  * File operations for consistent branch handling\n\nFlow:\n1. User selects branch in BranchSelector\n2. isBranchSwitching becomes true -\u003e show loading state\n3. Worker syncs, fetches, and checks out branch\n4. isBranchSwitching becomes false -\u003e branchSwitchComplete increments\n5. File/commit loading effects detect change and reload content\n6. UI updates with correct branch content\n\nThis ensures branch switching works reliably with proper content updates\nacross all repository views, fixing issues where content would remain on\nthe previous branch despite UI showing the new branch was selected.\n\nRelates to: Branch switching, content updates, remote sync\n---\n packages/nostr-git                                            |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte    | 92 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------\n src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte | 49 +++++++++++++++++++++++++++++++++++++++++++++----\n 3 files changed, 124 insertions(+), 19 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex f6d9e4d..ca95cef 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit f6d9e4defda2c695775cf293c86ce6d251fc3e1f\n+Subproject commit ca95ceff17011c579f4bf53099d713e12256962f\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex 28d42f6..fe56303 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -33,10 +33,16 @@\n     type: \"directory\",\n   })\n \n+  // Initialize selectedBranch first\n+  let selectedBranch = $state(repoClass.selectedBranch || repoClass.mainBranch)\n+\n   // Keep local selectedBranch in sync with repoClass changes (e.g., BranchSelector)\n   $effect(() =\u003e {\n     if (repoClass) {\n-      const next = repoClass.selectedBranch || repoClass.mainBranch || selectedBranch\n+      // Explicitly track selectedBranch and mainBranch for reactivity\n+      const repoSelectedBranch = repoClass.selectedBranch;\n+      const repoMainBranch = repoClass.mainBranch;\n+      const next = repoSelectedBranch || repoMainBranch || selectedBranch\n       if (next \u0026\u0026 next !== selectedBranch) {\n         selectedBranch = next\n       }\n@@ -49,9 +55,20 @@\n     type: \"directory\",\n   })\n \n-  let selectedBranch = $state(repoClass.selectedBranch)\n-\n   let branchLoadTrigger = $state(0)\n+  let branchSwitchComplete = $state(0) // Increments when branch switch finishes\n+  \n+  // Track when branch switching completes\n+  let wasSwitching = $state(false)\n+  $effect(() =\u003e {\n+    const isSwitching = repoClass.isBranchSwitching\n+    if (wasSwitching \u0026\u0026 !isSwitching) {\n+      // Branch switch just completed\n+      console.log(\"✅ Branch switch completed, triggering reload\")\n+      branchSwitchComplete++\n+    }\n+    wasSwitching = isSwitching\n+  })\n \n   let refs: Array\u003c{name: string; type: \"heads\" | \"tags\"; fullRef: string; commitId: string}\u003e =\n     $state([])\n@@ -100,12 +117,29 @@\n               if (!result.success) {\n                 throw new Error(result.error || \"Repository initialization failed\")\n               }\n+              \n+              // After cloning, sync with remote to ensure we have latest content\n+              console.log(\"🔄 Syncing with remote after clone...\")\n+              cloneProgress = \"Syncing with remote...\"\n+              try {\n+                await repoClass.workerManager.syncWithRemote({\n+                  repoId: repoClass.key,\n+                  cloneUrls,\n+                  branch: selectedBranch?.split(\"/\").pop()\n+                })\n+                console.log(\"✅ Sync complete\")\n+              } catch (syncErr) {\n+                console.warn(\"Sync with remote failed:\", syncErr)\n+                // Don't throw - repo is still usable even if sync fails\n+              }\n             } finally {\n               // Restore original callback (or clear it)\n               repoClass.workerManager.setProgressCallback(() =\u003e {})\n               isCloning = false\n               cloneProgress = \"\"\n               cloneProgressPercent = undefined\n+              // Trigger file reload after clone+sync completes\n+              branchSwitchComplete++\n             }\n           }\n         } catch (error) {\n@@ -156,18 +190,33 @@\n   })\n \n   $effect(() =\u003e {\n-    if (selectedBranch \u0026\u0026 !isCloning) {\n+    const isSwitching = repoClass.isBranchSwitching;\n+    \n+    // Don't load files while branch is still switching, but show loading state\n+    if (isSwitching) {\n+      console.log(\"⏳ Branch is switching, showing loading state...\");\n+      loading = true;\n+      return;\n+    }\n+    \n+    // Explicitly track branchSwitchComplete and selectedBranch to ensure effect re-runs after branch changes\n+    const currentBranch = selectedBranch;\n+    const switchTrigger = branchSwitchComplete; // This increments when branch switch completes\n+    \n+    if (currentBranch \u0026\u0026 !isCloning \u0026\u0026 !path) {\n       // Show loading only when actually fetching\n       loading = true\n       // Defer file loading slightly to avoid blocking render\n       const timeout = setTimeout(() =\u003e {\n+        console.log(\"🔄 Loading files for branch:\", currentBranch, \"trigger:\", switchTrigger);\n         files = repoClass\n           .listRepoFiles({\n-            branch: selectedBranch?.split(\"/\").pop() || \"master\",\n-            path,\n+            branch: currentBranch?.split(\"/\").pop() || \"master\",\n+            path: undefined,\n           })\n             .then(result =\u003e {\n               loading = false\n+              console.log(\"✅ Files loaded:\", result.files.length, \"files\");\n               return result.files.map(\n                 file =\u003e\n                   ({\n@@ -181,6 +230,7 @@\n             .catch((e) =\u003e {\n               loading = false\n               error = e instanceof Error ? e.message : \"Failed to load files\"\n+              console.error(\"❌ Failed to load files:\", e);\n               return []\n             })\n       }, 100)\n@@ -192,15 +242,23 @@\n   })\n \n   $effect(() =\u003e {\n-    if (path) {\n-      curDir.path = path.split(\"/\").slice(0, -1).join(\"/\")\n+    const currentBranch = selectedBranch;\n+    const currentPath = path;\n+    const switchTrigger = branchSwitchComplete; // Track branch switches\n+    \n+    if (currentPath \u0026\u0026 currentBranch \u0026\u0026 !isCloning) {\n+      curDir.path = currentPath.split(\"/\").slice(0, -1).join(\"/\")\n+      loading = true\n+      console.log(\"🔄 Loading files for branch:\", currentBranch, \"path:\", currentPath, \"trigger:\", switchTrigger);\n       files = repoClass\n         .listRepoFiles({\n-          branch: selectedBranch?.split(\"/\").pop() || \"master\",\n-          path,\n+          branch: currentBranch?.split(\"/\").pop() || \"master\",\n+          path: currentPath,\n         })\n-        .then(result =\u003e\n-          result.files.map(\n+        .then(result =\u003e {\n+          loading = false\n+          console.log(\"✅ Files loaded:\", result.files.length, \"files\");\n+          return result.files.map(\n             file =\u003e\n               ({\n                 name: file.path.split(\"/\").pop() || file.path,\n@@ -208,8 +266,14 @@\n                 type: file.type as \"file\" | \"directory\" | \"submodule\" | \"symlink\",\n                 oid: file.lastCommit,\n               }) as FileEntry,\n-          ),\n-        )\n+          )\n+        })\n+        .catch((e) =\u003e {\n+          loading = false\n+          error = e instanceof Error ? e.message : \"Failed to load files\"\n+          console.error(\"❌ Failed to load files:\", e);\n+          return []\n+        })\n     }\n   })\n \ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\nindex eea5349..2143bea 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n@@ -56,10 +56,51 @@\n     return `/spaces/${encodeURIComponent($page.params.relay)}/git/${encodeURIComponent($page.params.id)}/commits/${commitId}`;\n   };\n \n-  // Set initial page size and load commits when the component mounts or when the repo changes\n+  // Track the previous branch to detect changes\n+  let previousBranch = $state\u003cstring | undefined\u003e(undefined);\n+  let wasJustSwitching = $state(false);\n+\n+  // Handle branch switching state changes\n   $effect(() =\u003e {\n-    if (repoClass \u0026\u0026 repoClass.repoId \u0026\u0026 (repoClass.selectedBranch || repoClass.mainBranch)) {\n-      loadCommits()\n+    const isSwitching = repoClass.isBranchSwitching;\n+    \n+    if (isSwitching) {\n+      // Show loading state while switching\n+      commitsLoading = true;\n+      wasJustSwitching = true;\n+    } else if (wasJustSwitching) {\n+      // Switch just completed - commits are already loaded by setSelectedBranch\n+      // Just clear the flag, don't reload\n+      wasJustSwitching = false;\n+      commitsLoading = false;\n+    }\n+  });\n+\n+  // Load commits when branch changes (but not during active switching)\n+  $effect(() =\u003e {\n+    const selectedBranch = repoClass.selectedBranch;\n+    const mainBranch = repoClass.mainBranch;\n+    const currentBranch = selectedBranch || mainBranch;\n+    const isSwitching = repoClass.isBranchSwitching;\n+    \n+    // Skip if actively switching (setSelectedBranch will handle loading)\n+    if (isSwitching || wasJustSwitching) {\n+      return;\n+    }\n+    \n+    if (repoClass \u0026\u0026 repoClass.repoId \u0026\u0026 currentBranch) {\n+      // Detect branch changes (e.g., from navigation, not from selector)\n+      if (previousBranch !== undefined \u0026\u0026 previousBranch !== currentBranch) {\n+        console.log(`🔄 Branch changed from \"${previousBranch}\" to \"${currentBranch}\", resetting to page 1`);\n+        currentPage = 1;\n+        initialLoadComplete = false;\n+        previousBranch = currentBranch;\n+        loadCommits();\n+      } else if (previousBranch === undefined) {\n+        // Initial load\n+        previousBranch = currentBranch;\n+        loadCommits();\n+      }\n     }\n   })\n \n@@ -193,7 +234,7 @@\n   \u003c/div\u003e\n \n   \u003cdiv class=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\"\u003e\n-    \u003cdiv\u003e\n+    \u003cdiv class=\"flex-1\"\u003e\n       \u003ch2 class=\"text-lg font-medium\"\u003e\n         {#if totalCommits !== undefined}\n           {totalCommits.toLocaleString()} {totalCommits === 1 ? \"commit\" : \"commits\"}\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-gkgd70ya","title":"Latest commit rarely loads","description":"Mostly just hanging with placeholders pulsing","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue"]}
{"id":"flotilla-gz4xovfz","title":"Back button on repo page","description":"To easily navigate back to repo list","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue"]}
{"id":"flotilla-h7xyo0yp","title":"'Analyze patch set': Svelte error 'each key duplicate' after merge analysis","description":"https://i.nostr.build/KQzcSO5e9JyqUZ2a.png\n\nThis error makes budabit crash immediately after merge analysis","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["bug","issue","patches"]}
{"id":"flotilla-hco78cq7","title":"Issue comments NOT appearing sometimes","description":"Issue comments are queried on issues/+page.svelte on budabit and passed over to budabit, where each IssueCard filters for comments on the exact issue id it is associated with.\nThis is mostly not appearing first when page loads but appear when switching away and back on the Repo header tabs.\nNewly posted comments dont automatically appear either, when accordion is expanded","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue"]}
{"id":"flotilla-hdq2s2ea","title":"From 756c7f9c0a65834d26eaa784d2f72ae86c40e754 Mon Sep 17 00:00:00 2001","description":"From 756c7f9c0a65834d26eaa784d2f72ae86c40e754 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 2 Jun 2025 09:00:37 -0700\nSubject: [PATCH 2/2] update nostr-git\n\n---\n packages/nostr-git | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 1e83572..bc609f5 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 1e835722f528da5f31239627ec39c70fa2dfb773\n+Subproject commit bc609f563cbb0de023f5314f065737050cca3fd5\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-hef38csj","title":"Fix commit tab and cards","description":"Card: Responsiveness (title too short on mobile), profile unclickable, ... ?\n\nCommit page:\nResponsiveness and other problems. Seems mostly broken on mobile","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["bug","enhancement","good first issue","issue"]}
{"id":"flotilla-heojqfw9","title":"From d391a4c959e117779892fe10c341be2a2265f481 Mon Sep 17 00:00:00 2001","description":"From d391a4c959e117779892fe10c341be2a2265f481 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 12 May 2025 13:04:25 -0700\nSubject: [PATCH 2/2] feat: add pagination and loading states to issues and patches views\n\n---\n package.json                                                  |  1 +\n pnpm-workspace.yaml                                           |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte       |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte    | 41 ++++++++++++++++++++++++++---------------\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte  | 29 +++++++++--------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte | 83 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++------------\n 6 files changed, 109 insertions(+), 49 deletions(-)\n\ndiff --git a/package.json b/package.json\nindex 09dc6f4..bc46dab 100644\n--- a/package.json\n+++ b/package.json\n@@ -47,6 +47,7 @@\n     \"@lucide/svelte\": \"^0.509.0\",\n     \"@noble/curves\": \"^1.5.0\",\n     \"@noble/hashes\": \"^1.4.0\",\n+    \"@nostr-git/core\": \"link:../../../Library/pnpm/global/5/node_modules/@nostr-git/core\",\n     \"@nostr-git/shared-types\": \"link:../../../Library/pnpm/global/5/node_modules/@nostr-git/shared-types\",\n     \"@nostr-git/ui\": \"link:../../../Library/pnpm/global/5/node_modules/@nostr-git/ui\",\n     \"@poppanator/sveltekit-svg\": \"^4.2.1\",\ndiff --git a/pnpm-workspace.yaml b/pnpm-workspace.yaml\nindex f8b5454..2fef114 100644\n--- a/pnpm-workspace.yaml\n+++ b/pnpm-workspace.yaml\n@@ -1,7 +1,7 @@\n onlyBuiltDependencies:\n   - sharp\n-\n overrides:\n   ui: link:../../../Library/pnpm/global/5/node_modules/@nostr-git/ui\n   '@nostr-git/ui': link:../../../Library/pnpm/global/5/node_modules/@nostr-git/ui\n   '@nostr-git/shared-types': link:../../../Library/pnpm/global/5/node_modules/@nostr-git/shared-types\n+  '@nostr-git/core': link:../../../Library/pnpm/global/5/node_modules/@nostr-git/core\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex eda9862..f5a2fbd 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -11,7 +11,7 @@\n   const relayArray = Array.isArray(relay) ? relay : [relay]\n   const eventStore = deriveNaddrEvent(id, relayArray)\n   let {children} = $props()\n-  let activeTab = $page.url.pathname.split(\"/\").pop()\n+  let activeTab: string | undefined = $page.url.pathname.split(\"/\").pop()\n \u003c/script\u003e\n \n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex e6f3b57..6dca34b 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -1,12 +1,21 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {FileView} from \"@nostr-git/ui\"\n-  import {GitBranch} from \"@lucide/svelte\"\n-  import {deriveNaddrEvent} from \"@app/state\"\n-  import {page} from \"$app/stores\"\n-  const {id, relay} = $page.params\n-  const relayArray = Array.isArray(relay) ? relay : [relay]\n-  const repo = deriveNaddrEvent(id, relayArray)\n+  import { FileView } from \"@nostr-git/ui\";\n+  import { GitBranch } from \"@lucide/svelte\";\n+  import { listRepoFiles } from \"@nostr-git/core\";\n+  let { params } = $props();\n+  let { host, owner, repo } = params;\n \n+  let branches = $state([{ name: 'main', isDefault: true }]); // Replace with real branch fetch\n+  let selectedBranch = $state('main');\n+  let files = $state([]);\n+\n+  async function fetchFiles(branch: string) {\n+    files = await listRepoFiles({ host, owner, repo, branch });\n+  }\n+\n+  $effect(() =\u003e {\n+    fetchFiles(selectedBranch);\n+  });\n \u003c/script\u003e\n \n \u003cdiv class=\"border-border bg-card rounded-lg border\"\u003e\n@@ -14,26 +23,28 @@\n     \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n       \u003cdiv class=\"flex items-center gap-2\"\u003e\n         \u003cGitBranch class=\"text-muted-foreground h-5 w-5\" /\u003e\n-        \u003cselect class=\"border-border rounded border bg-secondary px-2 py-1\"\u003e\n-          {#each $repo.branches as branch}\n-            \u003coption key={branch.name} value={branch.name}\u003e\n+        \u003cselect\n+          class=\"border-border rounded border bg-secondary px-2 py-1\"\n+          bind:value={selectedBranch}\n+        \u003e\n+          {#each branches as branch}\n+            \u003coption value={branch.name}\u003e\n               {branch.name}\n-              {branch.isDefault \u0026\u0026 \"(default)\"}\n+              {branch.isDefault ? ' (default)' : ''}\n             \u003c/option\u003e\n           {/each}\n         \u003c/select\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n-\n     \u003cdiv class=\"border-border border-t pt-4\"\u003e\n       \u003cdiv class=\"space-y-2\"\u003e\n         \u003ch3 class=\"mb-4 font-medium\"\u003eFiles\u003c/h3\u003e\n         \u003cdiv class=\"space-y-2\"\u003e\n-          {#each $repo.files as file}\n-            \u003cFileView name={file.name} type={file.type} path={file.path} content={file.content} /\u003e\n+          {#each files as file}\n+            \u003cFileView name={file.name} type={file.type} path={file.path} /\u003e\n           {/each}\n         \u003c/div\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n   \u003c/div\u003e\n-\u003c/div\u003e\n+\u003c/div\u003e\n\\ No newline at end of file\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex c430d68..e22bb14 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -1,21 +1,21 @@\n \u003cscript lang=\"ts\"\u003e\n   import {Button, IssueCard} from \"@nostr-git/ui\"\n-  import {Funnel, Plus} from \"@lucide/svelte\"\n+  import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {deriveNaddrEvent} from \"@app/state\"\n   import {page} from \"$app/stores\"\n-  import {GIT_ISSUE} from \"@welshman/util\"\n+  import {GIT_ISSUE, type TrustedEvent} from \"@welshman/util\"\n   import {Address} from \"@welshman/util\"\n   import {load} from \"@welshman/net\"\n   import {onMount} from \"svelte\"\n   import {setChecked} from \"@src/app/notifications\"\n   import {nthEq} from \"@welshman/lib\"\n   import {deriveProfile} from \"@welshman/app\"\n-  import Profile from \"@src/app/components/Profile.svelte\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n+\n   const {id, relay} = $page.params\n   const relayArray = Array.isArray(relay) ? relay : [relay]\n   const repo = deriveNaddrEvent(id)\n-  let issues = $state([])\n+  let issues = $state([] as TrustedEvent[])\n   let loading = $state(true)\n   let currentPage = $state(1)\n   const pageSize = 10\n@@ -62,10 +62,10 @@\n \n \u003cdiv\u003e\n   \u003cdiv\n-    class=\"z-10 bg-background/95 supports-[backdrop-filter]:bg-background/60 sticky top-0 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n+    class=\"z-10 sticky top-0 mb-4 flex items-center justify-between bg-background/95 py-4 backdrop-blur supports-[backdrop-filter]:bg-background/60\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003eIssues\u003c/h2\u003e\n-      \u003cp class=\"text-muted-foreground text-sm\"\u003eTrack bugs and feature requests\u003c/p\u003e\n+      \u003cp class=\"text-sm text-muted-foreground\"\u003eTrack bugs and feature requests\u003c/p\u003e\n     \u003c/div\u003e\n \n     \u003cdiv class=\"flex items-center gap-2\"\u003e\n@@ -74,7 +74,7 @@\n         Filter\n       \u003c/Button\u003e\n \n-      \u003cButton size=\"sm\" class=\"bg-git hover:bg-git-hover gap-2\"\u003e\n+      \u003cButton size=\"sm\" class=\"gap-2 bg-git hover:bg-git-hover\"\u003e\n         \u003cPlus class=\"h-4 w-4\" /\u003e\n         New Issue\n       \u003c/Button\u003e\n@@ -93,22 +93,11 @@\n     \u003c/div\u003e\n   {:else if issues.length === 0}\n     \u003cdiv class=\"flex flex-col items-center justify-center py-12 text-gray-500\"\u003e\n-      \u003csvg\n-        class=\"mb-2 h-8 w-8\"\n-        fill=\"none\"\n-        stroke=\"currentColor\"\n-        stroke-width=\"2\"\n-        viewBox=\"0 0 24 24\"\u003e\n-        \u003cpath\n-          stroke-linecap=\"round\"\n-          stroke-linejoin=\"round\"\n-          d=\"M9 17v-2a4 4 0 118 0v2m-6 4h4a2 2 0 002-2v-2a6 6 0 10-12 0v2a2 2 0 002 2z\" /\u003e\n-      \u003c/svg\u003e\n+      \u003cSearchX class=\"mb-2 h-8 w-8\" /\u003e\n       No issues found.\n     \u003c/div\u003e\n   {:else}\n-    \u003cdiv\n-      class=\"bg-background flex max-h-[32rem] flex-col gap-y-4 overflow-y-auto rounded-md p-2\"\u003e\n+    \u003cdiv class=\"flex max-h-[32rem] flex-col gap-y-4 overflow-y-auto rounded-md bg-background p-2\"\u003e\n       {#each paginatedIssues() as issue}\n         \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey, relayArray)} /\u003e\n       {/each}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 45e5305..016bbeb 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -1,17 +1,34 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/state\"\n-  import {Filter, Plus} from \"@lucide/svelte\"\n+  import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Button, PatchCard} from \"@nostr-git/ui\"\n   import {setChecked} from \"@src/app/notifications\"\n   import {deriveNaddrEvent} from \"@src/app/state\"\n+  import Spinner from \"@src/lib/components/Spinner.svelte\"\n+  import {deriveProfile} from \"@welshman/app\"\n+  import {nthEq} from \"@welshman/lib\"\n   import {load} from \"@welshman/net\"\n-  import {Address, displayPubkey, GIT_PATCH} from \"@welshman/util\"\n+  import {Address, GIT_PATCH, type TrustedEvent} from \"@welshman/util\"\n   import {onMount} from \"svelte\"\n \n   const {id, relay} = page.params\n   const relayArray = Array.isArray(relay) ? relay : [relay]\n   const repo = deriveNaddrEvent(id, relayArray)\n-  const patches = $state([])\n+  let patches = $state([] as TrustedEvent[])\n+  let loading = $state(true)\n+  let currentPage = $state(1)\n+  const pageSize = 10\n+  const pageCount = $derived(() =\u003e Math.max(1, Math.ceil(patches.length / pageSize)))\n+  const paginatedPatches = $derived(() =\u003e\n+    patches.slice((currentPage - 1) * pageSize, currentPage * pageSize),\n+  )\n+\n+  function prevPage() {\n+    if (currentPage \u003e 1) currentPage = currentPage - 1\n+  }\n+  function nextPage() {\n+    if (currentPage \u003c pageCount()) currentPage = currentPage + 1\n+  }\n \n   async function loadPatches() {\n     patches.length = 0\n@@ -19,8 +36,11 @@\n       kinds: [GIT_PATCH],\n       \"#a\": [Address.fromEvent($repo).toString()],\n     }\n+\n+    const [tagId, ...relays] = $repo.tags.find(nthEq(0, \"relays\")) || []\n+\n     const patch = await load({\n-      relays: relayArray,\n+      relays: relays,\n       filters: [patchFilter],\n     })\n     if (patch.length \u003e 0) {\n@@ -28,33 +48,72 @@\n     }\n   }\n \n+  async function loadPatchesWrapper() {\n+    loading = true\n+    await loadPatches()\n+    loading = false\n+  }\n+\n   onMount(() =\u003e {\n-    loadPatches()\n+    loadPatchesWrapper()\n     return () =\u003e setChecked(page.url.pathname)\n   })\n \u003c/script\u003e\n \n \u003cdiv\u003e\n-  \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n+  \u003cdiv\n+    class=\"z-10 sticky top-0 mb-4 flex items-center justify-between bg-background/95 py-4 backdrop-blur supports-[backdrop-filter]:bg-background/60\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003ePatches\u003c/h2\u003e\n-      \u003cp class=\"text-muted-foreground text-sm\"\u003eReview and merge code changes\u003c/p\u003e\n+      \u003cp class=\"text-sm text-muted-foreground\"\u003eReview and merge code changes\u003c/p\u003e\n     \u003c/div\u003e\n \n     \u003cdiv class=\"flex items-center gap-2\"\u003e\n       \u003cButton variant=\"outline\" size=\"sm\" class=\"gap-2\"\u003e\n-        \u003cFilter class=\"h-4 w-4\" /\u003e\n+        \u003cFunnel class=\"h-4 w-4\" /\u003e\n         Filter\n       \u003c/Button\u003e\n \n-      \u003cButton size=\"sm\" class=\"bg-git hover:bg-git-hover gap-2\"\u003e\n+      \u003cButton size=\"sm\" class=\"gap-2 bg-git hover:bg-git-hover\"\u003e\n         \u003cPlus class=\"h-4 w-4\" /\u003e\n         New Patch\n       \u003c/Button\u003e\n     \u003c/div\u003e\n   \u003c/div\u003e\n \n-  {#each patches as patch}\n-    \u003cPatchCard event={patch} owner={displayPubkey(patch.pubkey)}/\u003e\n-  {/each}\n+  {#if loading}\n+    \u003cdiv class=\"flex flex-col items-center justify-center py-12\"\u003e\n+      \u003cSpinner {loading}\u003e\n+        {#if loading}\n+          Loading patches….\n+        {:else}\n+          End of patches history\n+        {/if}\n+      \u003c/Spinner\u003e\n+    \u003c/div\u003e\n+  {:else if patches.length === 0}\n+    \u003cdiv class=\"flex flex-col items-center justify-center py-12 text-gray-500\"\u003e\n+      \u003cSearchX class=\"mb-2 h-8 w-8\" /\u003e\n+      No patches found.\n+    \u003c/div\u003e\n+  {:else}\n+    \u003cdiv class=\"flex max-h-[32rem] flex-col gap-y-4 overflow-y-auto rounded-md bg-background p-2\"\u003e\n+      {#each paginatedPatches() as patch}\n+        \u003cPatchCard event={patch} owner={deriveProfile(patch.pubkey)} /\u003e\n+      {/each}\n+    \u003c/div\u003e\n+    \u003cdiv class=\"mt-4 flex items-center justify-center gap-4\"\u003e\n+      \u003cbutton\n+        onclick={prevPage}\n+        class=\"rounded bg-gray-100 px-3 py-1 hover:bg-gray-200 disabled:opacity-50\"\n+        disabled={currentPage === 1}\u003e\u0026larr; Prev\u003c/button\u003e\n+      \u003cspan class=\"text-gray-600\"\u003ePage {currentPage} of {pageCount()}\u003c/span\u003e\n+      \u003cbutton\n+        onclick={nextPage}\n+        class=\"rounded bg-gray-100 px-3 py-1 hover:bg-gray-200 disabled:opacity-50\"\n+        disabled={currentPage === pageCount()}\u003e\n+        Next \u0026rarr;\n+      \u003c/button\u003e\n+    \u003c/div\u003e\n+  {/if}\n \u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-hh74dmzz","title":"From 6169a71b53ffd33d35b9d17bc9216e3b5d5bdc41 Mon Sep 17 00:00:00 2001","description":"From 6169a71b53ffd33d35b9d17bc9216e3b5d5bdc41 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Thu, 29 May 2025 13:37:23 -0700\nSubject: [PATCH 8/67] Allow for multiple platform relays\n\n---\n README.md                                     |   2 +-\n src/app/components/MenuSpaces.svelte          |  44 ++++++++++++++++++++++++--------------------\n src/app/components/PrimaryNav.svelte          |  10 +++++-----\n src/app/state.ts                              |   2 +-\n src/routes/home/+page.svelte                  | 100 +++++++++++++++++++++++++++++++++++++++++++++++++---------------------------------------------------\n src/routes/spaces/[relay]/[room]/+page.svelte |  20 +++++++++++++++++++-\n 6 files changed, 99 insertions(+), 79 deletions(-)\n\ndiff --git a/README.md b/README.md\nindex c18b2c4..6371aa3 100644\n--- a/README.md\n+++ b/README.md\n@@ -12,7 +12,7 @@ You can also optionally create an `.env` file and populate it with the following\n - `VITE_PLATFORM_URL` - The url where the app will be hosted. This is only used for build-time population of meta tags.\n - `VITE_PLATFORM_NAME` - The name of the app\n - `VITE_PLATFORM_LOGO` - A logo url for the app\n-- `VITE_PLATFORM_RELAY` - A relay url that will make flotilla operate in \"platform mode\". Disables all space browse/add/select functionality and makes the platform relay the home page.\n+- `VITE_PLATFORM_RELAYS` - A list of comma-separated relay urls that will make flotilla operate in \"platform mode\". Disables all space browse/add/select functionality and makes the first platform relay the home page.\n - `VITE_PLATFORM_ACCENT` - A hex color for the app's accent color\n - `VITE_PLATFORM_DESCRIPTION` - A description of the app\n - `VITE_GLITCHTIP_API_KEY` - A Sentry DSN for use with glitchtip (error reporting)\ndiff --git a/src/app/components/MenuSpaces.svelte b/src/app/components/MenuSpaces.svelte\nindex 6cdf0c7..406e07b 100644\n--- a/src/app/components/MenuSpaces.svelte\n+++ b/src/app/components/MenuSpaces.svelte\n@@ -5,30 +5,34 @@\n   import CardButton from \"@lib/components/CardButton.svelte\"\n   import MenuSpacesItem from \"@app/components/MenuSpacesItem.svelte\"\n   import SpaceAdd from \"@app/components/SpaceAdd.svelte\"\n-  import {userRoomsByUrl} from \"@app/state\"\n+  import {userRoomsByUrl, PLATFORM_RELAYS} from \"@app/state\"\n   import {pushModal} from \"@app/modal\"\n \n   const addSpace = () =\u003e pushModal(SpaceAdd)\n \u003c/script\u003e\n \n \u003cdiv class=\"column menu gap-2\"\u003e\n-  {#if $userRoomsByUrl.size \u003e 0}\n-    {#each $userRoomsByUrl.keys() as url (url)}\n-      \u003cMenuSpacesItem {url} /\u003e\n-    {/each}\n-    \u003cDivider /\u003e\n-  {/if}\n-  \u003cButton onclick={addSpace}\u003e\n-    \u003cCardButton\u003e\n-      {#snippet icon()}\n-        \u003cdiv\u003e\u003cIcon icon=\"login-2\" size={7} /\u003e\u003c/div\u003e\n-      {/snippet}\n-      {#snippet title()}\n-        \u003cdiv\u003eAdd a space\u003c/div\u003e\n-      {/snippet}\n-      {#snippet info()}\n-        \u003cdiv\u003eJoin or create a new space\u003c/div\u003e\n-      {/snippet}\n-    \u003c/CardButton\u003e\n-  \u003c/Button\u003e\n+  {#each PLATFORM_RELAYS as url (url)}\n+    \u003cMenuSpacesItem {url} /\u003e\n+  {:else}\n+    {#if $userRoomsByUrl.size \u003e 0}\n+      {#each $userRoomsByUrl.keys() as url (url)}\n+        \u003cMenuSpacesItem {url} /\u003e\n+      {/each}\n+      \u003cDivider /\u003e\n+    {/if}\n+    \u003cButton onclick={addSpace}\u003e\n+      \u003cCardButton\u003e\n+        {#snippet icon()}\n+          \u003cdiv\u003e\u003cIcon icon=\"login-2\" size={7} /\u003e\u003c/div\u003e\n+        {/snippet}\n+        {#snippet title()}\n+          \u003cdiv\u003eAdd a space\u003c/div\u003e\n+        {/snippet}\n+        {#snippet info()}\n+          \u003cdiv\u003eJoin or create a new space\u003c/div\u003e\n+        {/snippet}\n+      \u003c/CardButton\u003e\n+    \u003c/Button\u003e\n+  {/each}\n \u003c/div\u003e\ndiff --git a/src/app/components/PrimaryNav.svelte b/src/app/components/PrimaryNav.svelte\nindex 05f49d4..2fa7ee9 100644\n--- a/src/app/components/PrimaryNav.svelte\n+++ b/src/app/components/PrimaryNav.svelte\n@@ -13,7 +13,7 @@\n   import MenuOtherSpaces from \"@app/components/MenuOtherSpaces.svelte\"\n   import MenuSettings from \"@app/components/MenuSettings.svelte\"\n   import PrimaryNavItemSpace from \"@app/components/PrimaryNavItemSpace.svelte\"\n-  import {userRoomsByUrl, canDecrypt, PLATFORM_RELAY, PLATFORM_LOGO} from \"@app/state\"\n+  import {userRoomsByUrl, canDecrypt, PLATFORM_RELAYS, PLATFORM_LOGO} from \"@app/state\"\n   import {pushModal} from \"@app/modal\"\n   import {makeSpacePath} from \"@app/routes\"\n   import {notifications} from \"@app/notifications\"\n@@ -57,8 +57,8 @@\n   class=\"ml-sai mt-sai mb-sai relative z-nav hidden w-14 flex-shrink-0 bg-base-200 pt-4 md:block\"\u003e\n   \u003cdiv class=\"flex h-full flex-col justify-between\"\u003e\n     \u003cdiv\u003e\n-      {#if PLATFORM_RELAY}\n-        \u003cPrimaryNavItemSpace url={PLATFORM_RELAY} /\u003e\n+      {#each PLATFORM_RELAYS as url (url)}\n+        \u003cPrimaryNavItemSpace {url} /\u003e\n       {:else}\n         \u003cPrimaryNavItem title=\"Home\" href=\"/home\" class=\"tooltip-right\"\u003e\n           \u003cAvatar src={PLATFORM_LOGO} class=\"!h-10 !w-10\" /\u003e\n@@ -79,7 +79,7 @@\n         \u003cPrimaryNavItem title=\"Add Space\" onclick={addSpace} class=\"tooltip-right\"\u003e\n           \u003cAvatar icon=\"settings-minimalistic\" class=\"!h-10 !w-10\" /\u003e\n         \u003c/PrimaryNavItem\u003e\n-      {/if}\n+      {/each}\n     \u003c/div\u003e\n     \u003cdiv\u003e\n       \u003cPrimaryNavItem\n@@ -120,7 +120,7 @@\n         notification={$notifications.has(\"/chat\")}\u003e\n         \u003cAvatar icon=\"letter\" class=\"!h-10 !w-10\" /\u003e\n       \u003c/PrimaryNavItem\u003e\n-      {#if !PLATFORM_RELAY}\n+      {#if PLATFORM_RELAYS.length !== 1}\n         \u003cPrimaryNavItem\n           title=\"Spaces\"\n           onclick={showSpacesMenu}\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 8f45b90..fe6c5cb 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -103,7 +103,7 @@ export const PLATFORM_LOGO = PLATFORM_URL + \"/pwa-192x192.png\"\n \n export const PLATFORM_NAME = import.meta.env.VITE_PLATFORM_NAME\n \n-export const PLATFORM_RELAY = import.meta.env.VITE_PLATFORM_RELAY\n+export const PLATFORM_RELAYS = fromCsv(import.meta.env.VITE_PLATFORM_RELAYS)\n \n export const PLATFORM_ACCENT = import.meta.env.VITE_PLATFORM_ACCENT\n \ndiff --git a/src/routes/home/+page.svelte b/src/routes/home/+page.svelte\nindex b56d308..3d2bd4c 100644\n--- a/src/routes/home/+page.svelte\n+++ b/src/routes/home/+page.svelte\n@@ -8,65 +8,63 @@\n   import SpaceAdd from \"@app/components/SpaceAdd.svelte\"\n   import {pushModal} from \"@app/modal\"\n   import {makeSpacePath} from \"@app/routes\"\n-  import {PLATFORM_NAME, PLATFORM_RELAY} from \"@app/state\"\n+  import {PLATFORM_NAME, PLATFORM_RELAYS} from \"@app/state\"\n \n   const addSpace = () =\u003e pushModal(SpaceAdd)\n \n   onMount(() =\u003e {\n-    if (PLATFORM_RELAY) {\n-      goto(makeSpacePath(PLATFORM_RELAY))\n+    if (PLATFORM_RELAYS.length \u003e 0) {\n+      goto(makeSpacePath(PLATFORM_RELAYS[0]))\n     }\n   })\n \u003c/script\u003e\n \n-{#if !PLATFORM_RELAY}\n-  \u003cdiv class=\"hero min-h-screen overflow-auto pb-8\"\u003e\n-    \u003cdiv class=\"hero-content\"\u003e\n-      \u003cdiv class=\"column content gap-4\"\u003e\n-        \u003ch1 class=\"text-center text-5xl\"\u003eWelcome to\u003c/h1\u003e\n-        \u003ch1 class=\"mb-4 text-center text-5xl font-bold uppercase\"\u003e{PLATFORM_NAME}\u003c/h1\u003e\n-        \u003cdiv class=\"col-3\"\u003e\n-          \u003cButton onclick={addSpace}\u003e\n-            \u003cCardButton\u003e\n-              {#snippet icon()}\n-                \u003cdiv\u003e\u003cIcon icon=\"add-circle\" size={7} /\u003e\u003c/div\u003e\n-              {/snippet}\n-              {#snippet title()}\n-                \u003cdiv\u003eAdd a space\u003c/div\u003e\n-              {/snippet}\n-              {#snippet info()}\n-                \u003cdiv\u003eUse an invite link, or create your own space.\u003c/div\u003e\n-              {/snippet}\n-            \u003c/CardButton\u003e\n-          \u003c/Button\u003e\n-          \u003cLink href=\"/discover\"\u003e\n-            \u003cCardButton\u003e\n-              {#snippet icon()}\n-                \u003cdiv\u003e\u003cIcon icon=\"compass\" size={7} /\u003e\u003c/div\u003e\n-              {/snippet}\n-              {#snippet title()}\n-                \u003cdiv\u003eBrowse the network\u003c/div\u003e\n-              {/snippet}\n-              {#snippet info()}\n-                \u003cdiv\u003eFind communities on the nostr network.\u003c/div\u003e\n-              {/snippet}\n-            \u003c/CardButton\u003e\n-          \u003c/Link\u003e\n-          \u003cLink href=\"/chat\"\u003e\n-            \u003cCardButton\u003e\n-              {#snippet icon()}\n-                \u003cdiv\u003e\u003cIcon icon=\"chat-round\" size={7} /\u003e\u003c/div\u003e\n-              {/snippet}\n-              {#snippet title()}\n-                \u003cdiv\u003eStart a conversation\u003c/div\u003e\n-              {/snippet}\n-              {#snippet info()}\n-                \u003cdiv\u003eUse nostr's encrypted group chats to stay in touch.\u003c/div\u003e\n-              {/snippet}\n-            \u003c/CardButton\u003e\n-          \u003c/Link\u003e\n-        \u003c/div\u003e\n+\u003cdiv class=\"hero min-h-screen overflow-auto pb-8\"\u003e\n+  \u003cdiv class=\"hero-content\"\u003e\n+    \u003cdiv class=\"column content gap-4\"\u003e\n+      \u003ch1 class=\"text-center text-5xl\"\u003eWelcome to\u003c/h1\u003e\n+      \u003ch1 class=\"mb-4 text-center text-5xl font-bold uppercase\"\u003e{PLATFORM_NAME}\u003c/h1\u003e\n+      \u003cdiv class=\"col-3\"\u003e\n+        \u003cButton onclick={addSpace}\u003e\n+          \u003cCardButton\u003e\n+            {#snippet icon()}\n+              \u003cdiv\u003e\u003cIcon icon=\"add-circle\" size={7} /\u003e\u003c/div\u003e\n+            {/snippet}\n+            {#snippet title()}\n+              \u003cdiv\u003eAdd a space\u003c/div\u003e\n+            {/snippet}\n+            {#snippet info()}\n+              \u003cdiv\u003eUse an invite link, or create your own space.\u003c/div\u003e\n+            {/snippet}\n+          \u003c/CardButton\u003e\n+        \u003c/Button\u003e\n+        \u003cLink href=\"/discover\"\u003e\n+          \u003cCardButton\u003e\n+            {#snippet icon()}\n+              \u003cdiv\u003e\u003cIcon icon=\"compass\" size={7} /\u003e\u003c/div\u003e\n+            {/snippet}\n+            {#snippet title()}\n+              \u003cdiv\u003eBrowse the network\u003c/div\u003e\n+            {/snippet}\n+            {#snippet info()}\n+              \u003cdiv\u003eFind communities on the nostr network.\u003c/div\u003e\n+            {/snippet}\n+          \u003c/CardButton\u003e\n+        \u003c/Link\u003e\n+        \u003cLink href=\"/chat\"\u003e\n+          \u003cCardButton\u003e\n+            {#snippet icon()}\n+              \u003cdiv\u003e\u003cIcon icon=\"chat-round\" size={7} /\u003e\u003c/div\u003e\n+            {/snippet}\n+            {#snippet title()}\n+              \u003cdiv\u003eStart a conversation\u003c/div\u003e\n+            {/snippet}\n+            {#snippet info()}\n+              \u003cdiv\u003eUse nostr's encrypted group chats to stay in touch.\u003c/div\u003e\n+            {/snippet}\n+          \u003c/CardButton\u003e\n+        \u003c/Link\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n   \u003c/div\u003e\n-{/if}\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/[room]/+page.svelte b/src/routes/spaces/[relay]/[room]/+page.svelte\nindex fc6c639..cb3ecc9 100644\n--- a/src/routes/spaces/[relay]/[room]/+page.svelte\n+++ b/src/routes/spaces/[relay]/[room]/+page.svelte\n@@ -304,7 +304,25 @@\n   {/snippet}\n   {#snippet action()}\n     \u003cdiv class=\"row-2\"\u003e\n-      {#if $membershipStatus !== MembershipStatus.Initial}\n+      {#if $membershipStatus === MembershipStatus.Initial}\n+        \u003cButton\n+          class=\"btn btn-neutral btn-sm tooltip tooltip-left\"\n+          data-tip=\"Request to be added to the member list\"\n+          disabled={joining}\n+          onclick={join}\u003e\n+          {#if joining}\n+            \u003cspan class=\"loading loading-spinner loading-sm\"\u003e\u003c/span\u003e\n+          {:else}\n+            \u003cIcon size={4} icon=\"login-2\" /\u003e\n+          {/if}\n+        \u003c/Button\u003e\n+      {:else if $membershipStatus === MembershipStatus.Pending}\n+        \u003cButton\n+          class=\"btn btn-neutral btn-sm tooltip tooltip-left\"\n+          data-tip=\"Membership is pending\"\u003e\n+          \u003cIcon size={4} icon=\"clock-circle\" /\u003e\n+        \u003c/Button\u003e\n+      {:else}\n         \u003cButton\n           class=\"btn btn-neutral btn-sm tooltip tooltip-left\"\n           data-tip=\"Request to be removed from member list\"\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-hka0fztl","title":"From 0461faf180d89631d7201701ec56bcc341467431 Mon Sep 17 00:00:00 2001","description":"From 0461faf180d89631d7201701ec56bcc341467431 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 8 Jul 2025 21:54:13 -0700\nSubject: [PATCH 2/2] feat: add permalink extension to editor and patch apply button to UI\n\n---\n packages/nostr-git                                                      |  2 +-\n src/app/editor/index.ts                                                 |  7 +++++++\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 17 ++++++++++++-----\n 3 files changed, 20 insertions(+), 6 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 4f3f9cc..fa2291f 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 4f3f9cc02cad3aefe6b103cd9d876e9853e6a2e9\n+Subproject commit fa2291f7ee37f2ccb8179a3f76f31daeb423f6f7\ndiff --git a/src/app/editor/index.ts b/src/app/editor/index.ts\nindex 4b6c772..bd05a42 100644\n--- a/src/app/editor/index.ts\n+++ b/src/app/editor/index.ts\n@@ -17,6 +17,8 @@ import {Editor, MentionSuggestion, WelshmanExtension} from \"@welshman/editor\"\n import {makeMentionNodeView} from \"./MentionNodeView\"\n import ProfileSuggestion from \"./ProfileSuggestion.svelte\"\n import {pushToast} from \"@app/toast\"\n+import {PermalinkExtension} from \"@nostr-git/ui\"\n+import Spinner from \"@lib/components/Spinner.svelte\"\n \n export const getBlossomServer = () =\u003e {\n   const userUrls = getTagValues(\"server\", getListTags(userBlossomServers.get()))\n@@ -54,6 +56,11 @@ export const makeEditor = async ({\n     autofocus,\n     element: document.createElement(\"div\"),\n     extensions: [\n+      PermalinkExtension.configure({\n+        signer: async (e) =\u003e await signer.get().sign(e),\n+        relays: Router.get().FromUser().getUrls(),\n+        spinnerComponent: Spinner,\n+      }),\n       WelshmanExtension.configure({\n         submit,\n         extensions: {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex f6214ea..3765238 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -1,6 +1,6 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n-  import {Check, ChevronLeft, ChevronRight, GitCommit, MessageSquare, X} from \"@lucide/svelte\"\n+  import {Check, ChevronLeft, ChevronRight, GitCommit, GitMerge, MessageSquare, X} from \"@lucide/svelte\"\n   import {Button, Profile} from \"@nostr-git/ui\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import {DiffViewer, IssueThread} from \"@nostr-git/ui\"\n@@ -119,15 +119,16 @@\n     }\n   })\n \n-  function truncateHash(hash: string): string {\n-    return hash.substring(0, 7)\n-  }\n-\n   const md = markdownit({\n     html: true,\n     linkify: true,\n     typographer: true,\n   })\n+\n+  const applyPatch = () =\u003e {\n+    \n+  }\n+\n \u003c/script\u003e\n \n {#if patch}\n@@ -266,6 +267,12 @@\n           {/key}\n         \u003c/div\u003e\n \n+        \u003cdiv class=\"flex justify-end\"\u003e\n+          \u003cButton onclick={applyPatch} variant=\"default\"\u003e\n+            \u003cGitMerge class=\"h-4 w-4\" /\u003e Apply\n+          \u003c/Button\u003e\n+        \u003c/div\u003e\n+\n         \u003cdiv class=\"git-separator my-6\"\u003e\u003c/div\u003e\n \n         \u003cdiv class=\"space-y-4\"\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-hmnykpa8","title":"From 6cb37a6cc1c76ab19c1c513b4d8b75b8d5a0853c Mon Sep 17 00:00:00 2001","description":"From 6cb37a6cc1c76ab19c1c513b4d8b75b8d5a0853c Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 29 May 2025 12:41:59 -0700\nSubject: [PATCH] feat: enhance UI with loading states, transitions and markdown styling\n\n---\n .env                                                          |   2 +-\n packages/nostr-git                                            |   2 +-\n src/routes/spaces/[relay]/+layout.svelte                      |   3 ++-\n src/routes/spaces/[relay]/git/+page.svelte                    |  18 ++++++------------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte       |  59 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte         | 164 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte    |   1 +\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte  |  18 ++++++++----------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte |  44 ++++++++++++++++++++++++++++++++++++++------\n 9 files changed, 236 insertions(+), 75 deletions(-)\n\ndiff --git a/.env b/.env\nindex bc4e21d..e8062af 100644\n--- a/.env\n+++ b/.env\n@@ -5,7 +5,7 @@ VITE_PLATFORM_TERMS=\n VITE_PLATFORM_PRIVACY=\n VITE_PLATFORM_NAME=Budabit\n VITE_PLATFORM_LOGO=static/budabit.png\n-VITE_PLATFORM_RELAY=ws://192.168.1.101:7000\n+VITE_PLATFORM_RELAY=ws://192.168.1.149:7000\n VITE_PLATFORM_ACCENT=\"#D4AF37\"\n VITE_PLATFORM_SECONDARY=\"#EB5E28\"\n VITE_PLATFORM_DESCRIPTION=\"The Club for Builders in Freedom Tech.\"\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 1148da4..565f147 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 1148da40e044d428c086d2085058225ef55d0986\n+Subproject commit 565f147cd1ff1efda2516b1b9c9e421870106f7d\ndiff --git a/src/routes/spaces/[relay]/+layout.svelte b/src/routes/spaces/[relay]/+layout.svelte\nindex d05f571..a01c186 100644\n--- a/src/routes/spaces/[relay]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/+layout.svelte\n@@ -16,7 +16,8 @@\n   import {decodeRelay, userRoomsByUrl} from \"@app/state\"\n   import {pullConservatively} from \"@app/requests\"\n   import {notifications} from \"@app/notifications\"\n-    import { FREELANCE_JOB, GIT_REPO } from \"@src/lib/util\"\n+  import {FREELANCE_JOB, GIT_REPO} from \"@src/lib/util\"\n+\n   interface Props {\n     children?: import(\"svelte\").Snippet\n   }\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 87479bf..29356f2 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -1,13 +1,6 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {onMount} from \"svelte\"\n   import {page} from \"$app/stores\"\n-  import {\n-    getPubkeyTagValues,\n-    getListTags,\n-    Address,\n-    NAMED_BOOKMARKS,\n-    type TrustedEvent,\n-  } from \"@welshman/util\"\n+  import {Address, NAMED_BOOKMARKS, type TrustedEvent} from \"@welshman/util\"\n   import {GIT_REPO} from \"@src/lib/util\"\n   import {repository, userMutes} from \"@welshman/app\"\n   import {fly} from \"@lib/transition\"\n@@ -63,7 +56,7 @@\n       })\n       const repoFilter = {kinds: [GIT_REPO], authors, \"#d\": dTagValues}\n       return _derived(deriveEvents(repository, {filters: [repoFilter]}), events =\u003e {\n-        if (events.length === 0) {\n+        if (events.length !== dTagValues.length) {\n           load({relays: relayHints, filters: [repoFilter]})\n         }\n         return events\n@@ -83,9 +76,10 @@\n     }\n   })\n \n-  onMount(() =\u003e {\n-    loading = false\n-    console.log(\"loadedBookmarkedRepos\", loadedBookmarkedRepos)\n+  $effect(() =\u003e {\n+    if (loadedBookmarkedRepos) {\n+      loading = false\n+    }\n   })\n \n   const onAddRepo = () =\u003e {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex ef46a62..02c4ef9 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -13,6 +13,7 @@\n   import {Address, GIT_ISSUE, GIT_PATCH, type Filter} from \"@welshman/util\"\n   import {load} from \"@welshman/net\"\n   import {nthEq} from \"@welshman/lib\"\n+    import PageBar from \"@src/lib/components/PageBar.svelte\"\n \n   const {id, relay} = $page.params\n \n@@ -77,11 +78,67 @@\n         relays: relays,\n         filters: [issuesFilter, patchesFilter, repoStateFilter],\n       })\n+\n+      if ($repoState \u0026\u0026 $issues \u0026\u0026 $patches) {\n+        console.log(\"issues\", $issues)\n+        console.log(\"patches\", $patches)\n+      }\n     }\n   })\n \u003c/script\u003e\n-\n+\u003cPageBar\u003e\n+  \u003cRepoHeader event={$eventStore as RepoAnnouncementEvent} {activeTab}\u003e\n+    {#snippet children(activeTab: string)}\n+      \u003cRepoTab\n+        tabValue={id}\n+        label=\"Overview\"\n+        href={`/spaces/${encodeddRelay}/git/${id}`}\n+        {activeTab}\u003e\n+        {#snippet icon()}\n+          \u003cFileCode class=\"h-4 w-4\" /\u003e\n+        {/snippet}\n+      \u003c/RepoTab\u003e\n+      \u003cRepoTab\n+        tabValue=\"code\"\n+        label=\"Code\"\n+        href={`/spaces/${encodeddRelay}/git/${id}/code`}\n+        {activeTab}\u003e\n+        {#snippet icon()}\n+          \u003cGitBranch class=\"h-4 w-4\" /\u003e\n+        {/snippet}\n+      \u003c/RepoTab\u003e\n+      \u003cRepoTab\n+        tabValue=\"issues\"\n+        label=\"Issues\"\n+        href={`/spaces/${encodeddRelay}/git/${id}/issues`}\n+        {activeTab}\u003e\n+        {#snippet icon()}\n+          \u003cCircleAlert class=\"h-4 w-4\" /\u003e\n+        {/snippet}\n+      \u003c/RepoTab\u003e\n+      \u003cRepoTab\n+        tabValue=\"patches\"\n+        label=\"Patches\"\n+        href={`/spaces/${encodeddRelay}/git/${id}/patches`}\n+        {activeTab}\u003e\n+        {#snippet icon()}\n+          \u003cGitPullRequest class=\"h-4 w-4\" /\u003e\n+        {/snippet}\n+      \u003c/RepoTab\u003e\n+      \u003cRepoTab\n+        tabValue=\"wiki\"\n+        label=\"Wiki\"\n+        href={`/spaces/${encodeddRelay}/git/${id}/wiki`}\n+        {activeTab}\u003e\n+        {#snippet icon()}\n+          \u003cBook class=\"h-4 w-4\" /\u003e\n+        {/snippet}\n+      \u003c/RepoTab\u003e\n+    {/snippet}\n+  \u003c/RepoHeader\u003e\n+\u003c/PageBar\u003e\n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n+\n   {#if $eventStore === undefined}\n     \u003cdiv class=\"p-4 text-center\"\u003eLoading repository...\u003c/div\u003e\n   {:else if !$eventStore}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 91516ec..977bd01 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -22,6 +22,8 @@\n     type RepoAnnouncementEvent,\n     type RepoStateEvent,\n   } from \"@nostr-git/shared-types\"\n+  import {fly} from \"@lib/transition\"\n+  import Spinner from \"@src/lib/components/Spinner.svelte\"\n \n   const eventStore = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n   const repo = getContext\u003c{\n@@ -31,30 +33,48 @@\n     patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n   }\u003e(\"repo\")\n \n-  let loading = $state(false)\n+  let loading = $state(true)\n \n   const repoState = repo.state()\n   const issues = repo.issues()\n   const patches = repo.patches()\n \n-  let issueCount = $derived.by(() =\u003e $issues?.length ?? 0)\n+  let issueCount = $derived.by(() =\u003e {\n+    if ($issues) {\n+      return $issues.length\n+    }\n+  })\n+\n+  let branchCount = $state(0)\n \n-  let branchCount = $derived.by(() =\u003e {\n+  $effect(() =\u003e {\n     if ($repoState) {\n       const repo = parseRepoStateEvent($repoState as RepoStateEvent)\n-      return repo.refs.length\n+      branchCount = repo.refs.length\n+    } else {\n+      listBranchesFromEvent({repoEvent: $eventStore}).then(b =\u003e (branchCount = b.length))\n     }\n-    return 0\n   })\n \n   let contributorCount = $derived.by(() =\u003e {\n     if ($eventStore) {\n       const repo = parseRepoAnnouncementEvent($eventStore as RepoAnnouncementEvent)\n-      return repo.maintainers?.length ?? 0\n+      const maintainerCount = repo.maintainers\n+        ? repo.maintainers.includes($eventStore.pubkey)\n+          ? repo.maintainers.length\n+          : repo.maintainers.length + 1\n+        : 1\n+      return maintainerCount\n     }\n     return 0\n   })\n \n+  const patchCount = $derived.by(() =\u003e {\n+    if ($patches) {\n+      return $patches.length\n+    }\n+  })\n+\n   const statuses = $derived.by(() =\u003e {\n     if ($issues) {\n       const statusFilter = [\n@@ -98,12 +118,10 @@\n   const mainBranch = $derived.by(async () =\u003e {\n     if ($repoState) {\n       const repo = parseRepoStateEvent($repoState as RepoStateEvent)\n-      console.log(repo)\n       return repo.head\n     } else {\n       const branches = await listBranchesFromEvent({repoEvent: $eventStore})\n-      console.log(branches)\n-      return branches?.[0].name\n+      return branches.length \u003e 0 ? branches[0].name : undefined\n     }\n   })\n \n@@ -117,7 +135,7 @@\n     {label: \"Issues\", value: () =\u003e issueCount, icon: CircleAlert},\n     {\n       label: \"Patches\",\n-      value: () =\u003e $patches.length,\n+      value: () =\u003e patchCount,\n       icon: GitPullRequest,\n     },\n   ]\n@@ -138,6 +156,7 @@\n       path: \"README.md\",\n     })\n     renderedReadme = readme ? md.render(readme) : \"\"\n+    loading = false\n   })\n \u003c/script\u003e\n \n@@ -146,7 +165,7 @@\n     {#each stats as stat}\n       \u003cCard class=\"p-4\"\u003e\n         \u003cdiv class=\"flex items-center gap-2\"\u003e\n-          \u003cstat.icon class=\"h-5 w-5 text-muted-foreground\" /\u003e\n+          \u003cstat.icon class=\"h-5 text-muted-foreground\" /\u003e\n           \u003cdiv\u003e\n             \u003cp class=\"text-sm text-muted-foreground\"\u003e{stat.label}\u003c/p\u003e\n             \u003cp class=\"text-2xl font-semibold\"\u003e{stat.value()}\u003c/p\u003e\n@@ -157,42 +176,101 @@\n   \u003c/div\u003e\n   {#if renderedReadme}\n     \u003cdiv\n-      class=\"prose-slate dark:prose-invert prose-headings:font-bold prose-headings:mb-3 prose-headings:mt-8 prose-h1:text-3xl prose-h2:text-2xl prose-h3:text-xl prose-p:leading-relaxed prose-p:my-4 prose-ul:my-4 prose-ol:my-4 prose-li:marker:text-primary prose-blockquote:border-l-4 prose-blockquote:border-accent prose-blockquote:bg-accent/10 prose-blockquote:p-4 prose-blockquote:rounded prose-blockquote:my-6 prose-table:my-6 prose-table:border prose-table:border-muted prose-th:bg-muted/50 prose-th:font-semibold prose-th:p-3 prose-td:p-3 prose-pre:bg-zinc-900 prose-pre:rounded-lg prose-pre:p-4 prose-code:bg-zinc-800 prose-code:rounded-md prose-code:px-2 prose-code:py-1 prose-code:text-sm prose max-w-none overflow-x-auto rounded-xl border border-muted bg-muted p-8 shadow-md\"\u003e\n+      class=\"prose max-w-2xl bg-white dark:bg-zinc-900\"\n+      in:fly\u003e\n       {@html renderedReadme}\n+      \u003cstyle\u003e\n+        .prose {\n+          color: theme('colors.zinc.50');\n+          background: none;\n+        }\n+        .dark .prose {\n+          color: theme('colors.white');\n+        }\n+        .prose h1, .prose h2, .prose h3 {\n+          font-weight: 600;\n+          line-height: 1.25;\n+          color: theme('colors.zinc.50');\n+          margin-top: 2rem;\n+          margin-bottom: 1rem;\n+        }\n+        .prose h1 {\n+          font-size: 2rem;\n+          border-bottom: 1px solid theme('colors.zinc.50');\n+          padding-bottom: 0.3em;\n+        }\n+        .prose h2 {\n+          font-size: 1.5rem;\n+          border-bottom: 1px solid theme('colors.zinc.50');\n+          padding-bottom: 0.2em;\n+        }\n+        .prose h3 {\n+          font-size: 1.25rem;\n+          padding-bottom: 0.1em;\n+        }\n+        .prose ul, .prose ol {\n+          margin: 1em 0;\n+          padding-left: 2em;\n+        }\n+        .prose li {\n+          margin: 0.3em 0;\n+        }\n+        .prose a {\n+          color: theme('colors.accent');\n+          text-decoration: underline;\n+          text-underline-offset: 2px;\n+          transition: color 0.2s;\n+        }\n+        .prose a:hover {\n+          color: theme('colors.primary');\n+        }\n+        .prose code {\n+          background: theme('colors.zinc.700');\n+          color: theme('colors.zinc.100');\n+          border-radius: 4px;\n+          padding: 0.2em 0.4em;\n+          font-size: 0.95em;\n+        }\n+        .prose pre {\n+          background: theme('colors.zinc.900');\n+          color: theme('colors.zinc.100');\n+          border-radius: 8px;\n+          padding: 1em;\n+          margin: 1.5em 0;\n+          font-size: 1em;\n+          overflow-x: auto;\n+        }\n+        .prose blockquote {\n+          border-left: 4px solid theme('colors.zinc.300');\n+          background: theme('colors.zinc.50');\n+          color: theme('colors.zinc.600');\n+          padding: 1em 1.5em;\n+          border-radius: 0.5em;\n+          margin: 1.5em 0;\n+          font-style: italic;\n+        }\n+        .prose table {\n+          width: 100%;\n+          border-collapse: collapse;\n+          margin-bottom: 1.5em;\n+          background: theme('colors.zinc.50');\n+          border-radius: 0.5em;\n+          overflow: hidden;\n+        }\n+        .prose th, .prose td {\n+          border: 1px solid theme('colors.zinc.200');\n+          padding: 0.6em 1em;\n+        }\n+        .prose th {\n+          background: theme('colors.zinc.100');\n+          font-weight: 600;\n+        }\n+      \u003c/style\u003e\n     \u003c/div\u003e\n+  {:else if loading}\n+    \u003cSpinner {loading}\u003eLoading README.md...\u003c/Spinner\u003e\n   {:else}\n     \u003cdiv class=\"text-muted-foreground\"\u003eNo README.md found.\u003c/div\u003e\n   {/if}\n \n-  \u003cstyle\u003e\n-    /* Further polish for markdown rendering in README */\n-    .prose h1,\n-    .prose h2,\n-    .prose h3 {\n-      letter-spacing: -0.01em;\n-    }\n-    .prose h1 {\n-      border-bottom: 1px solid theme(\"colors.border\");\n-      padding-bottom: 0.3em;\n-    }\n-    .prose blockquote {\n-      border-left-width: 4px;\n-      border-color: var(--tw-prose-accent);\n-      background: var(--tw-prose-accent-bg, rgba(59, 130, 246, 0.05));\n-      padding: 1rem;\n-      border-radius: 0.5rem;\n-      margin: 1.5rem 0;\n-    }\n-    .prose pre {\n-      margin: 1.5rem 0;\n-    }\n-    .prose table {\n-      border-radius: 0.5rem;\n-      overflow: hidden;\n-    }\n-    .prose th,\n-    .prose td {\n-      border: 1px solid theme(\"colors.zinc.700\");\n-    }\n-  \u003c/style\u003e\n \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex 1383488..a03e86c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -29,6 +29,7 @@\n     repo: Readable\u003cTrustedEvent\u003e\n     state: () =\u003e Readable\u003cRepoStateEvent\u003e\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n   }\u003e(\"repo\")\n \n   // UI state\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex d3d803b..a638f33 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -1,12 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n   import {Button, IssueCard} from \"@nostr-git/ui\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n-  import {\n-    Address,\n-    COMMENT,\n-    GIT_ISSUE,\n-    type TrustedEvent,\n-  } from \"@welshman/util\"\n+  import {Address, COMMENT, GIT_ISSUE, type TrustedEvent} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n   import {nthEq} from \"@welshman/lib\"\n   import {deriveProfile, repository} from \"@welshman/app\"\n@@ -14,6 +9,7 @@\n   import {makeFeed} from \"@src/app/requests\"\n   import type {Readable} from \"svelte/store\"\n   import {type RepoStateEvent} from \"@nostr-git/shared-types\"\n+  import {fly} from \"@lib/transition\"\n \n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n@@ -23,15 +19,15 @@\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n   }\u003e(\"repo\")\n \n-  let issues = $derived(repo.issues())\n+  let issues = repo.issues()\n   const comments: TrustedEvent[] = $state([])\n \n   let loading = $state(true)\n   let element: HTMLElement | undefined = $state()\n \n   $effect(() =\u003e {\n-    if (!issues) {\n-      return\n+    if (issues) {\n+      loading = false\n     }\n \n     const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || []\n@@ -92,7 +88,9 @@\n   {:else}\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each $issues as issue (issue.id)}\n-        \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey, relays)} /\u003e\n+        \u003cdiv in:fly\u003e\n+          \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)} /\u003e\n+        \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\n   {/if}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 99618ed..2c65bf6 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -9,6 +9,14 @@\n   import {makeFeed} from \"@src/app/requests\"\n   import type {Readable} from \"svelte/store\"\n   import {type RepoStateEvent} from \"@nostr-git/shared-types\"\n+  import {deriveEvents} from \"@welshman/store\"\n+  import {\n+    GIT_STATUS_OPEN,\n+    GIT_STATUS_COMPLETE,\n+    GIT_STATUS_CLOSED,\n+    GIT_STATUS_DRAFT,\n+  } from \"@welshman/util\"\n+    import { fly } from \"@lib/transition\"\n \n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n@@ -19,14 +27,36 @@\n     patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n   }\u003e(\"repo\")\n \n-  let patches = $derived(repo.patches())\n+  const patches = $derived(repo.patches())\n+\n+  const patchList = $derived.by(() =\u003e {\n+    if ($patches) {\n+      return $patches.map(patch =\u003e {\n+        const statuses = deriveEvents(repository, {\n+          filters: [\n+            {\n+              kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+              \"#e\": [patch.id],\n+            },\n+          ],\n+        })\n+        const profile = deriveProfile(patch.pubkey)\n+\n+        return {\n+          ...patch,\n+          status,\n+          profile,\n+        }\n+      })\n+    }\n+  })\n \n   let loading = $state(true)\n   let element: HTMLElement | undefined = $state()\n \n   $effect(() =\u003e {\n-    if (!patches) {\n-      return\n+    if (patches) {\n+      loading = false\n     }\n \n     const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || []\n@@ -51,7 +81,7 @@\n \n \u003cdiv bind:this={element}\u003e\n   \u003cdiv\n-    class=\"z-10 sticky top-0 mb-4 flex items-center justify-between bg-background/95 py-4 backdrop-blur supports-[backdrop-filter]:bg-background/60\"\u003e\n+    class=\"z-10 sticky top-0 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003ePatches\u003c/h2\u003e\n       \u003cp class=\"text-sm text-muted-foreground\"\u003eReview and merge code changes\u003c/p\u003e\n@@ -87,8 +117,10 @@\n     \u003c/div\u003e\n   {:else}\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n-      {#each $patches as patch}\n-        \u003cPatchCard event={patch} owner={deriveProfile(patch.pubkey)} /\u003e\n+      {#each patchList! as patch}\n+        \u003cdiv in:fly\u003e\n+          \u003cPatchCard event={patch} status={patch.status} owner={patch.profile} /\u003e\n+        \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\n   {/if}\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-hsz7296u","title":"Repo Feed: make it responsive","description":"Check for the different content types (issues, patches, comments and others)","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["enhancement","good first issue","issue"]}
{"id":"flotilla-ibhrbq1w","title":"From d3fae448dbad0e9fcf694783598c64862d765e26 Mon Sep 17 00:00:00 2001","description":"From d3fae448dbad0e9fcf694783598c64862d765e26 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 4 Jan 2026 19:44:35 +0500\nSubject: [PATCH] fix(markdown): resolve list rendering errors with block-level content\n\nFixed a critical bug in the markdown list renderer that caused errors when\nlist items contained block-level tokens (such as paragraphs).\n\nChanges:\n- Changed list item parsing from parseInline() to parse() to properly\n  handle both inline and block-level tokens within list items\n- Removed list-inside class from list renderer to prevent list markers\n  from appearing on separate lines when items contain block content\n\nRoot cause:\nThe list renderer was using this.parser.parseInline() which only handles\ninline tokens. When list items contained block-level tokens (like\nparagraphs), marked.js would throw: 'Token with paragraph type was not\nfound' because parseInline() cannot process block tokens.\n\nAdditionally, the list-inside class was causing visual issues where list\nmarkers appeared on separate lines from their content when block elements\nwere present. Removing this class allows the default list-outside behavior\n(already styled in Markdown.svelte with pl-6 padding) to properly align\nmarkers with content.\n\nImpact:\n- Lists with paragraphs and other block-level content now render correctly\n- List markers properly align with content regardless of item structure\n- No more runtime errors when parsing markdown with complex list structures\n---\n src/lib/components/markdown/markdownRenderers.ts | 8 +++-----\n 1 file changed, 3 insertions(+), 5 deletions(-)\n\ndiff --git a/src/lib/components/markdown/markdownRenderers.ts b/src/lib/components/markdown/markdownRenderers.ts\nindex 3087b7f..8558e2e 100644\n--- a/src/lib/components/markdown/markdownRenderers.ts\n+++ b/src/lib/components/markdown/markdownRenderers.ts\n@@ -55,16 +55,14 @@ export function createRenderers(options: RendererOptions = {}): Partial\u003cRenderer\n     list(this: Renderer, token: Tokens.List): string {\n       const listItems: string = token.items\n         .map((item): string =\u003e {\n-          const itemContent: string = this.parser.parseInline(item.tokens)\n+          const itemContent: string = this.parser.parse(item.tokens)\n           return `\u003cli\u003e${itemContent}\u003c/li\u003e`\n         })\n         .join(\"\\n\")\n \n-      const listClass = token.ordered ? \"list-decimal list-inside\" : \"list-disc list-inside\"\n-\n       return token.ordered\n-        ? `\u003col class=\"${listClass}\"\u003e${listItems}\u003c/ol\u003e`\n-        : `\u003cul class=\"${listClass}\"\u003e${listItems}\u003c/ul\u003e`\n+        ? `\u003col\u003e${listItems}\u003c/ol\u003e`\n+        : `\u003cul\u003e${listItems}\u003c/ul\u003e`\n     },\n \n     code(token: Tokens.Code): string {\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-impl-host-ui","title":"Implement Smart Widget host UI components","description":"Build Svelte 5 components responsible for rendering widget containers, handling loading and error states, and exposing widget configuration UI where applicable.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-24T18:05:14.812022-08:00","closed_at":"2026-01-24T18:05:14.812022-08:00","close_reason":"Verified implemented via codebase triage"}
{"id":"flotilla-impl-repo-scoped-state","title":"Filter widget state by repository ID","description":"Ensure widget discovery and state reconstruction can be scoped to a specific repository via the canonical repo ID tag.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T08:34:16.659122-08:00","closed_at":"2026-01-16T08:34:16.659122-08:00","close_reason":"Implemented repo-scoped widget state: added RepoContext type, repo-aware storage handlers (get/set/remove/keys with repoScoped option), context:getRepo handler, repo context in widget:init lifecycle, setRepoContext method on registry, and context:repoUpdate event for dynamic updates"}
{"id":"flotilla-impl-toolkit-agnostic","title":"Enforce toolkit-agnostic widget execution","description":"Ensure that widgets authored in React, Vue, vanilla JS, or other toolchains run without modification. The runtime must not assume Svelte inside the widget.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-24T18:05:14.812473-08:00","closed_at":"2026-01-24T18:05:14.812473-08:00","close_reason":"Verified implemented via codebase triage"}
{"id":"flotilla-impl-widget-discovery","title":"Implement Smart Widget discovery via relays","description":"Implement discovery of Smart Widgets via Nostr relays, including subscription filters, relay selection, and validation of widget metadata events.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-24T18:05:14.812942-08:00","closed_at":"2026-01-24T18:05:14.812942-08:00","close_reason":"Verified implemented via codebase triage"}
{"id":"flotilla-impl-widget-runtime-loader","title":"Implement Smart Widget runtime loader","description":"Implement the runtime responsible for fetching widget code, instantiating the sandbox, and wiring host-to-widget communication.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T08:27:23.48429-08:00","closed_at":"2026-01-16T08:27:23.48429-08:00","close_reason":"Implemented Smart Widget runtime loader with: storage API (get/set/remove/keys), lifecycle events (init/mounted/unmounting), iframe load waiting with timeout, error handling and cleanup on failure, widget metadata passing to iframe"}
{"id":"flotilla-impl-widget-state-sync","title":"Implement widget state synchronization","description":"Implement logic to publish widget state updates, subscribe to relevant state events, and reconcile concurrent updates deterministically.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T00:21:39.733124-08:00"}
{"id":"flotilla-impl-yakihonne-compat","title":"Support YakiHonne relay compatibility","description":"Ensure that Smart Widgets published to YakiHonne-compatible relays can be discovered and loaded without Budabit-specific assumptions.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T00:37:49.113362-08:00","closed_at":"2026-01-16T00:37:49.113362-08:00","close_reason":"Implemented YakiHonne compatibility: made image tag optional for basic widgets per YakiHonne spec, made relay discovery configurable via VITE_SMART_WIDGET_RELAYS env var with YakiHonne as default, verified UI displays content field as widget title"}
{"id":"flotilla-j12gu4oy","title":"From 042b8d6ea75c5e55d91c512408742a9d1edd3850 Mon Sep 17 00:00:00 2001","description":"From 042b8d6ea75c5e55d91c512408742a9d1edd3850 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Thu, 29 May 2025 13:43:02 -0700\nSubject: [PATCH 9/67] Update changelog\n\n---\n CHANGELOG.md | 6 +++++-\n 1 file changed, 5 insertions(+), 1 deletion(-)\n\ndiff --git a/CHANGELOG.md b/CHANGELOG.md\nindex fc21bc5..a5fe192 100644\n--- a/CHANGELOG.md\n+++ b/CHANGELOG.md\n@@ -1,9 +1,13 @@\n # Changelog\n \n-# 1.0.5\n+# 1.1.0\n \n * Add better theming support\n * Improve forms for entering invite codes\n+* Rely more heavily on NIP 29 for rooms\n+* Support multiple platform relays\n+* Remove default general room\n+* Remove room tag from threads/calendars\n \n # 1.0.4\n \n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-j3xfm9i5","title":"From cfe65049fb414285c7ea384c39d7d09420b79657 Mon Sep 17 00:00:00 2001","description":"From cfe65049fb414285c7ea384c39d7d09420b79657 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Wed, 30 Jul 2025 21:40:46 -0700\nSubject: [PATCH 5/8] feat: added new repo and fork capabilities\n\n---\n packages/nostr-git                                         |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte    | 14 ++++++++++----\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte | 88 +++++++++++++++++++++++-----------------------------------------------------------------\n 3 files changed, 34 insertions(+), 70 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 42161e5..d0a5ea8 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 42161e542071106536b5db70d436f799bd3fbc63\n+Subproject commit d0a5ea8806c88cc784540fa52a5a02bebd9e0c4c\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 29f677c..bbba2e9 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -14,7 +14,7 @@\n   import EventActions from \"@src/app/components/EventActions.svelte\"\n   import ReactionSummary from \"@src/app/components/ReactionSummary.svelte\"\n   import {pushModal} from \"@src/app/modal.js\"\n-  import {EditRepoPanel} from \"@nostr-git/ui\"\n+  import {EditRepoPanel, ForkRepoDialog} from \"@nostr-git/ui\"\n   import {postRepoAnnouncement} from \"@src/app/commands.js\"\n   import type {RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n \n@@ -76,9 +76,15 @@\n   }\n \n   function forkRepo() {\n-    if (!repoClass) return\n-    // Fork the repository\n-    repoClass.workerManager.apiInstance.forkAndCloneRepo()\n+    if (!repoClass || !repoClass.repo) return\n+    \n+    pushModal(ForkRepoDialog, {\n+      repo: repoClass,\n+      onPublishEvent: async (event: any) =\u003e {\n+        // Handle event publishing\n+        await postRepoAnnouncement(event, [])\n+      }\n+    })\n   }\n \n   function settingsRepo() {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex 11c6d5f..b0d256f 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -33,71 +33,29 @@\n \n   let branchLoadTrigger = $state(0)\n \n-  let allRefs = $derived.by(() =\u003e {\n-    branchLoadTrigger\n+  let refs: Array\u003c{name: string; type: \"heads\" | \"tags\"; fullRef: string; commitId: string}\u003e = $state([])\n+  let loadingRefs = $state(true)\n \n-    const repoStateEvent = repoClass.repoStateEvent\n-\n-    if (repoStateEvent \u0026\u0026 repoStateEvent.tags) {\n-      const hasProcessedState = repoClass.branchManager?.getAllNIP34References().size \u003e 0\n-      if (!hasProcessedState) {\n-        repoClass.branchManager?.processRepoStateEvent(repoStateEvent)\n-      }\n-    } else if (!repoStateEvent) {\n-      if (\n-        repoClass.branchManager \u0026\u0026\n-        repoClass.branchManager.getBranches().length === 0 \u0026\u0026\n-        repoClass.repoEvent\n-      ) {\n-        repoClass.branchManager\n-          .loadBranchesFromRepo(repoClass.repoEvent)\n-          .then(() =\u003e {\n-            branchLoadTrigger++\n-          })\n-          .catch((error: Error) =\u003e {\n-            pushToast({\n-              message: \"Failed to load branches from git repository: \" + error,\n-              theme: \"error\",\n-            })\n+  // Load refs using the unified API\n+  $effect(() =\u003e {\n+    if (repoClass) {\n+      loadingRefs = true\n+      repoClass.getAllRefsWithFallback()\n+        .then(loadedRefs =\u003e {\n+          refs = loadedRefs\n+          loadingRefs = false\n+          branchLoadTrigger++ // Trigger reactivity for dependent effects\n+        })\n+        .catch((error: Error) =\u003e {\n+          console.error('Failed to load repository references:', error)\n+          pushToast({\n+            message: \"Failed to load branches from git repository: \" + error,\n+            theme: \"error\",\n           })\n-      }\n-    }\n-\n-    const nip34Refs = repoClass.branchManager?.getAllNIP34References() || new Map()\n-\n-    const processedBranches = repoClass.branchManager?.getBranches() || []\n-\n-    const refs: Array\u003c{name: string; type: \"heads\" | \"tags\"; fullRef: string; commitId: string}\u003e =\n-      []\n-\n-    for (const [shortName, ref] of nip34Refs) {\n-      refs.push({\n-        name: shortName,\n-        type: ref.type,\n-        fullRef: ref.fullRef,\n-        commitId: ref.commitId,\n-      })\n-    }\n-\n-    if (refs.length === 0 \u0026\u0026 processedBranches.length \u003e 0) {\n-\n-      for (const branch of processedBranches) {\n-        const refObj = {\n-          name: branch.name,\n-          type: \"heads\" as const,\n-          fullRef: `refs/heads/${branch.name}`,\n-          commitId: branch.oid || \"\",\n-        }\n-        refs.push(refObj)\n-      }\n+          refs = []\n+          loadingRefs = false\n+        })\n     }\n-\n-    return refs.sort((a, b) =\u003e {\n-      if (a.type !== b.type) {\n-        return a.type === \"heads\" ? -1 : 1\n-      }\n-      return a.name.localeCompare(b.name)\n-    })\n   })\n \n   $effect(() =\u003e {\n@@ -197,11 +155,11 @@\n             \u003cul\n               transition:fly\n               class=\"menu z-popover mt-2 flex max-h-64 flex-col overflow-y-auto rounded-box bg-base-100 p-2 shadow-xl\"\u003e\n-              {#if allRefs.length === 0}\n+              {#if refs.length === 0}\n                 \u003cli class=\"px-3 py-2 text-sm text-muted-foreground\"\u003eNo branches or tags found\u003c/li\u003e\n               {:else}\n-                {@const branches = allRefs.filter(ref =\u003e ref.type === \"heads\")}\n-                {@const tags = allRefs.filter(ref =\u003e ref.type === \"tags\")}\n+                {@const branches = refs.filter(ref =\u003e ref.type === \"heads\")}\n+                {@const tags = refs.filter(ref =\u003e ref.type === \"tags\")}\n \n                 {#if branches.length \u003e 0}\n                   \u003cli\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-j9avf040","title":"Repo removal buggy","description":"Switching off repos does not reliably remove it from list.\nPerhaps it is related to caching, will have to check details.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue"]}
{"id":"flotilla-jkofmx1t","title":"From 46a7c7257fa7068072e567b6a4ba2555026b8861 Mon Sep 17 00:00:00 2001","description":"From 46a7c7257fa7068072e567b6a4ba2555026b8861 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 28 Jul 2025 22:12:36 -0700\nSubject: [PATCH 1/4] refactor: remove debug console logs across repository management code\n\n---\n packages/nostr-git                                                      |  2 +-\n src/lib/utils/tokenLoader.ts                                            | 12 ++++++------\n src/routes/+layout.svelte                                               |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts                     | 11 +++--------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte                   |  4 ++--\n src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte           | 44 +++-----------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 59 ++---------------------------------------------------------\n 7 files changed, 18 insertions(+), 116 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 71eaa7a..18c78d2 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 71eaa7a61931dbaa2f58d685947ccec7f4e6e288\n+Subproject commit 18c78d2675110698468e20fb074c0c406d96affd\ndiff --git a/src/lib/utils/tokenLoader.ts b/src/lib/utils/tokenLoader.ts\nindex 98e8b71..312d270 100644\n--- a/src/lib/utils/tokenLoader.ts\n+++ b/src/lib/utils/tokenLoader.ts\n@@ -19,7 +19,7 @@ async function waitForSignerReady(maxWaitMs: number = 10000): Promise\u003c{ signer: \n       const currentPubkey = get(pubkey);\n       \n       if (currentSigner \u0026\u0026 currentPubkey) {\n-        console.log('🔐 Signer and pubkey are ready for token decryption');\n+\n         resolve({ signer: currentSigner, pubkey: currentPubkey });\n         return;\n       }\n@@ -52,11 +52,11 @@ export async function loadTokensFromStorage(tokenKey: string): Promise\u003cTokenEntr\n \n     const encryptedTokens = localStorage.getItem(tokenKey);\n     if (!encryptedTokens) {\n-      console.log('🔐 No encrypted tokens found in localStorage');\n+\n       return [];\n     }\n \n-    console.log('🔐 Found encrypted tokens, waiting for signer to be ready...');\n+\n     \n     // Wait for signer and pubkey to be available\n     const signerInfo = await waitForSignerReady();\n@@ -65,7 +65,7 @@ export async function loadTokensFromStorage(tokenKey: string): Promise\u003cTokenEntr\n       return [];\n     }\n \n-    console.log('🔐 Signer ready, attempting to decrypt tokens...');\n+\n     \n     // Decrypt the tokens\n     const decrypted = await signerInfo.signer.nip04.decrypt(signerInfo.pubkey, encryptedTokens);\n@@ -75,7 +75,7 @@ export async function loadTokensFromStorage(tokenKey: string): Promise\u003cTokenEntr\n     }\n \n     const tokens = JSON.parse(decrypted) as TokenEntry[];\n-    console.log(`🔐 Successfully loaded ${tokens.length} tokens from localStorage`);\n+\n     return tokens;\n \n   } catch (error) {\n@@ -106,7 +106,7 @@ export async function saveTokensToStorage(tokenKey: string, tokens: TokenEntry[]\n     const encrypted = await currentSigner.nip04.encrypt(currentPubkey, JSON.stringify(tokens));\n     localStorage.setItem(tokenKey, encrypted);\n     \n-    console.log(`🔐 Successfully saved ${tokens.length} tokens to localStorage`);\n+\n \n   } catch (error) {\n     console.error('Failed to save tokens to localStorage:', error);\ndiff --git a/src/routes/+layout.svelte b/src/routes/+layout.svelte\nindex c24733c..e6a543e 100644\n--- a/src/routes/+layout.svelte\n+++ b/src/routes/+layout.svelte\n@@ -238,7 +238,7 @@\n           const loadedTokens = await loadTokensFromStorage(tokenKey)\n           tokens.clear()\n           loadedTokens.forEach(token =\u003e tokens.push(token))\n-          console.log(`🔐 Git tokens initialized at app level: ${loadedTokens.length} tokens loaded`)\n+\n         } catch (error) {\n           console.warn('🔐 Failed to initialize git tokens at app level:', error)\n         }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nindex a6e0604..24a4d40 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -55,17 +55,12 @@ export const load: LayoutLoad = async ({ params }) =\u003e {\n             \"#d\": [decoded.identifier],\n         }]\n     }), (events) =\u003e {\n-        console.log('🔍 Repository State events found:', events?.length || 0, events)\n+\n         const stateEvent = events?.[0]\n         if (stateEvent) {\n-            console.log('✅ Repository State event loaded:', stateEvent.kind, stateEvent.id)\n-            console.log('🔍 Repository State event tags:', stateEvent.tags)\n+            // Repository State event loaded successfully\n         } else {\n-            console.log('❌ No Repository State event found for:', {\n-                author: decoded.pubkey,\n-                identifier: decoded.identifier,\n-                kind: GIT_REPO_STATE\n-            })\n+            // No Repository State event found\n         }\n         return stateEvent\n     }) as Readable\u003cRepoStateEvent\u003e;\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex b91db61..2ee4c84 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -111,7 +111,7 @@\n       readme = readmeContent.content\n       renderedReadme = readme ? md.render(readme) : \"\"\n     } catch (e) {\n-      console.log(\"No README.md found\")\n+\n     } finally {\n       readmeLoading = false\n     }\n@@ -129,7 +129,7 @@\n         }\n       }\n     } catch (e) {\n-      console.log(\"Could not fetch commit info:\", e)\n+\n     } finally {\n       commitLoading = false\n     }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\nindex 0f5e78c..53595bc 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n@@ -47,35 +47,8 @@\n \n   // Set initial page size and load commits when the component mounts or when the repo changes\n   $effect(() =\u003e {\n-    console.log(\"🔍 $effect triggered:\", {\n-      repoClass: !!repoClass,\n-      repoEvent: !!repoClass?.repoEvent,\n-      mainBranch: repoClass?.mainBranch,\n-      branches: repoClass?.branches?.length || 0,\n-      selectedPageSize\n-    });\n-    \n-    if (repoClass \u0026\u0026 repoClass.repoEvent \u0026\u0026 repoClass.mainBranch) {\n-      // Set the initial page size\n-      repoClass.setCommitsPerPage(selectedPageSize)\n+    if (repoClass \u0026\u0026 repoClass.repoId \u0026\u0026 repoClass.mainBranch) {\n       loadCommits()\n-    } else if (repoClass) {\n-      console.log(\"⚠️ Repository not fully initialized yet, waiting...\");\n-      // Try again after a short delay to allow initialization to complete\n-      setTimeout(() =\u003e {\n-        if (repoClass.repoEvent \u0026\u0026 repoClass.mainBranch) {\n-          console.log(\"✅ Repository now initialized, loading commits...\");\n-          repoClass.setCommitsPerPage(selectedPageSize)\n-          loadCommits()\n-        } else {\n-          console.error(\"❌ Repository failed to initialize:\", {\n-            repoEvent: !!repoClass.repoEvent,\n-            mainBranch: repoClass.mainBranch\n-          });\n-          commitsError = \"Repository not properly initialized\";\n-          commitsLoading = false;\n-        }\n-      }, 1000);\n     }\n   })\n \n@@ -91,23 +64,12 @@\n \n   // Load commits with pagination\n   async function loadCommits() {\n-    console.log('🔍 loadCommits called with:', {\n-      currentPage,\n-      repoClass: !!repoClass,\n-      repoEvent: !!repoClass?.repoEvent,\n-      mainBranch: repoClass?.mainBranch,\n-      repoId: repoClass?.repoId,\n-      initialLoadComplete\n-    });\n-    \n     if (!initialLoadComplete) {\n       commitsLoading = true\n     }\n \n     try {\n-      console.log('🔍 About to call repoClass.loadPage with:', currentPage);\n       const result = await repoClass.loadPage(currentPage);\n-      console.log('🔍 loadPage result:', result);\n       \n       // Check if the result indicates an error\n       if (result \u0026\u0026 !result.success) {\n@@ -190,11 +152,11 @@\n   })\n \n   const handleReact = (commitId: string, type: \"heart\") =\u003e {\n-    console.log(`Reacting to commit ${commitId} with ${type}`)\n+\n   }\n \n   const handleComment = (commitId: string, comment: string) =\u003e {\n-    console.log(`Commenting on commit ${commitId}: ${comment}`)\n+\n     // TODO: Implement Nostr comments for commits\n   }\n \u003c/script\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 95234e4..0535fb6 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -116,13 +116,13 @@\n \n     // Check if repository is properly initialized before attempting merge analysis\n     if (!repoClass.repoId || !repoClass.mainBranch) {\n-      console.log('Repository not fully initialized yet, skipping merge analysis')\n+\n       return\n     }\n \n     // Check if WorkerManager is ready\n     if (!repoClass.workerManager) {\n-      console.log('WorkerManager not ready yet, skipping merge analysis')\n+\n       return\n     }\n \n@@ -140,34 +140,16 @@\n     isAnalyzingMerge = true\n     mergeAnalysisResult = null\n     try {\n-      console.log('🔍 DEBUG: Starting merge analysis with:', {\n-        patchId: patchEvent?.id,\n-        targetBranch,\n-        repoId: repoClass.repoId,\n-        mainBranch: repoClass.mainBranch,\n-        hasWorkerManager: !!repoClass.workerManager\n-      });\n-      \n       let result = await repoClass.getMergeAnalysis(patchEvent, targetBranch)\n       \n-      console.log('🔍 DEBUG: Merge analysis result:', {\n-        hasResult: !!result,\n-        analysis: result?.analysis,\n-        errorMessage: result?.errorMessage,\n-        canMerge: result?.canMerge,\n-        fullResult: result\n-      });\n-      \n       if (result) {\n         mergeAnalysisResult = result\n       } else {\n         // If still no result, try to get from cache first\n         const cachedResult = await repoClass.getMergeAnalysis(patchEvent, targetBranch)\n         if (cachedResult) {\n-          console.log('🔍 DEBUG: Using cached result:', cachedResult);\n           mergeAnalysisResult = cachedResult\n         } else {\n-          console.log('🔍 DEBUG: No merge analysis result available yet - will retry')\n           // Don't show error immediately, just return and let it retry\n           return\n         }\n@@ -320,19 +302,6 @@\n       rawContent: selectedPatch.raw?.content || ''\n     };\n     \n-    // Debug patch data before sending to worker\n-    console.log('🔍 Patch Data Debug:', {\n-      patchId: patchData.id,\n-      hasRawContent: !!patchData.rawContent,\n-      rawContentType: typeof patchData.rawContent,\n-      rawContentLength: patchData.rawContent?.length,\n-      rawContentPreview: patchData.rawContent?.substring(0, 100),\n-      baseBranch: patchData.baseBranch,\n-      commitsCount: patchData.commits.length,\n-      selectedPatchRaw: selectedPatch.raw,\n-      selectedPatchRawContent: selectedPatch.raw?.content\n-    });\n-    \n     // Validate patch data before proceeding\n     if (!patchData.rawContent || typeof patchData.rawContent !== 'string') {\n       mergeError = `Invalid patch data: rawContent is ${typeof patchData.rawContent} (${patchData.rawContent})`;\n@@ -399,30 +368,6 @@\n     const effectiveRepoId = repoClass.repoEvent?.id || repoClass.repoId || '';\n     \n     try {\n-        console.log('🚀 Starting patch merge operation...');\n-        \n-        // Debug authentication configuration\n-        const authConfig = repoClass.workerManager.getAuthConfig();\n-        console.log('🔍 Auth Debug - Available tokens:', authConfig.tokens.length);\n-        console.log('🔍 Auth Debug - Token hosts:', authConfig.tokens.map(t =\u003e t.host));\n-        console.log('🔍 Auth Debug - Repo clone URLs:', repoClass.repo?.clone || []);\n-        \n-        // Check if any tokens match the repo URLs\n-        const repoUrls = repoClass.repo?.clone || [];\n-        for (const url of repoUrls) {\n-          try {\n-            const hostname = new URL(url).hostname;\n-            const matchingToken = authConfig.tokens.find(token =\u003e \n-              hostname === token.host || hostname.endsWith('.' + token.host)\n-            );\n-            console.log(`🔍 Auth Debug - URL: ${url}, Hostname: ${hostname}, Has Token: ${!!matchingToken}`);\n-            if (matchingToken) {\n-              console.log(`🔍 Auth Debug - Token for ${hostname}: ${matchingToken.token.substring(0, 8)}...`);\n-            }\n-          } catch (e) {\n-            console.log(`🔍 Auth Debug - Invalid URL: ${url}`);\n-          }\n-        }\n         \n         const result = await repoClass.workerManager.applyPatchAndPush({\n           repoId: effectiveRepoId,\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-js72xbhl","title":"From 216022d12cd6db80325c5c05cbd7d7a2e0c83928 Mon Sep 17 00:00:00 2001","description":"From 216022d12cd6db80325c5c05cbd7d7a2e0c83928 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 30 Nov 2025 19:22:44 +0500\nSubject: [PATCH] refactor: migrate from INDEXER_RELAYS to GIT_RELAYS for git-related operations\n\nReplace INDEXER_RELAYS with GIT_RELAYS throughout the budabit module to\nbetter separate concerns between general indexing and git-specific relay\noperations.\n\nChanges:\n- Updated GIT_RELAYS initialization to use fromCsv() helper for proper\n  string array conversion from environment variable\n- Replaced all INDEXER_RELAYS references with GIT_RELAYS in:\n  * commands.ts: All publish operations (issues, patches, comments,\n    statuses, repo announcements, repo state events, labels, permalinks,\n    GRASP servers list, and role labels)\n  * requests.ts: User git data loading operations\n  * state.ts: Repo announcements loading, repo context loading, and\n    naddr event derivation\n  * +layout.ts: Repository layout loading with proper import from\n    budabit state module\n\n- Added purplepag.es relay to VITE_INDEXER_RELAYS in .env for improved\n  relay diversity\n\nThis change improves code organization by using dedicated git-specific\nrelays (configured via VITE_GIT_RELAYS) instead of general indexer\nrelays, allowing for better control over where git-related events are\npublished and queried.\n---\n .env                                                |  2 +-\n src/lib/budabit/commands.ts                         | 22 +++++++++++-----------\n src/lib/budabit/requests.ts                         |  4 ++--\n src/lib/budabit/state.ts                            | 10 +++++-----\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts |  7 ++++---\n 5 files changed, 23 insertions(+), 22 deletions(-)\n\ndiff --git a/.env b/.env\nindex cdf04bc..c19ca9b 100644\n--- a/.env\n+++ b/.env\n@@ -10,7 +10,7 @@ VITE_PLATFORM_RELAYS=wss://budabit.nostr1.com/\n VITE_PLATFORM_ACCENT=\"#D4AF37\"\n VITE_PLATFORM_SECONDARY=\"#EB5E28\"\n VITE_PLATFORM_DESCRIPTION=\"The Club for Builders in Freedom Tech.\"\n-VITE_INDEXER_RELAYS=wss://relay.damus.io/,wss://relay.nostr.band/\n+VITE_INDEXER_RELAYS=wss://purplepag.es/,wss://relay.damus.io/,wss://relay.nostr.band/\n VITE_SIGNER_RELAYS=wss://relay.nsec.app/,wss://bucket.coracle.social/\n VITE_NOTIFIER_PUBKEY=27b7c2ed89ef78322114225ea3ebf5f72c7767c2528d4d0c1854d039c00085df\n VITE_NOTIFIER_RELAY=wss://anchor.coracle.social/\ndiff --git a/src/lib/budabit/commands.ts b/src/lib/budabit/commands.ts\nindex be26598..caa7bbb 100644\n--- a/src/lib/budabit/commands.ts\n+++ b/src/lib/budabit/commands.ts\n@@ -1,12 +1,12 @@\n import type { CommentEvent, IssueEvent, RepoAnnouncementEvent, StatusEvent, PermalinkEvent, RepoStateEvent, GraspSetEvent, NostrEvent, TrustedEvent } from \"@nostr-git/shared-types\"\n import { buildRoleLabelEvent } from \"./labels\"\n import { publishThunk } from \"@welshman/app\"\n-import { INDEXER_RELAYS } from \"@app/core/state\"\n+import { GIT_RELAYS } from \"./state\"\n import { Router } from \"@welshman/router\"\n import { publishDelete } from \"@src/app/core/commands\"\n \n export const publishEvent = \u003cT extends NostrEvent\u003e(event: T, relays?: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays ?? []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays ?? []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     relays: merged,\n     event: event,\n@@ -15,13 +15,13 @@ export const publishEvent = \u003cT extends NostrEvent\u003e(event: T, relays?: string[]) \n \n export const postComment = (comment: CommentEvent, relays: string[]) =\u003e {\n   return publishThunk({\n-    relays: relays ?? [...INDEXER_RELAYS, ...Router.get().FromUser().getUrls()],\n+    relays: relays ?? [...GIT_RELAYS, ...Router.get().FromUser().getUrls()],\n     event: comment,\n   })\n }\n \n export const postIssue = (issue: IssueEvent, relays: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     event: issue,\n     relays: merged,\n@@ -29,7 +29,7 @@ export const postIssue = (issue: IssueEvent, relays: string[]) =\u003e {\n }\n \n export const postStatus = (status: StatusEvent, relays: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     relays: merged,\n     event: status,\n@@ -37,7 +37,7 @@ export const postStatus = (status: StatusEvent, relays: string[]) =\u003e {\n }\n \n export const postRepoAnnouncement = (repo: RepoAnnouncementEvent, relays: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     relays: merged,\n     event: repo,\n@@ -45,7 +45,7 @@ export const postRepoAnnouncement = (repo: RepoAnnouncementEvent, relays: string\n }\n \n export const postRepoStateEvent = (repoEvent: RepoStateEvent, relays: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     relays: merged,\n     event: repoEvent,\n@@ -54,7 +54,7 @@ export const postRepoStateEvent = (repoEvent: RepoStateEvent, relays: string[]) \n \n // Publish a NIP-32 label event (kind 1985)\n export const postLabel = (labelEvent: any, relays: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     relays: merged,\n     event: labelEvent,\n@@ -62,7 +62,7 @@ export const postLabel = (labelEvent: any, relays: string[]) =\u003e {\n }\n \n export const postPermalink = (permalink: PermalinkEvent, relays: string[]) =\u003e {\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     event: permalink,\n     relays: merged,\n@@ -70,7 +70,7 @@ export const postPermalink = (permalink: PermalinkEvent, relays: string[]) =\u003e {\n }\n \n export const postGraspServersList = (graspServersList: GraspSetEvent) =\u003e {\n-  const merged = Array.from(new Set([...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     event: graspServersList,\n     relays: merged,\n@@ -94,7 +94,7 @@ export const postRoleLabel = (params: {\n     repoAddr,\n     created_at\n   })\n-  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...INDEXER_RELAYS]))\n+  const merged = Array.from(new Set([...(relays || []), ...Router.get().FromUser().getUrls(), ...GIT_RELAYS]))\n   return publishThunk({\n     relays: merged,\n     event: event,\ndiff --git a/src/lib/budabit/requests.ts b/src/lib/budabit/requests.ts\nindex 58c3365..cc6a517 100644\n--- a/src/lib/budabit/requests.ts\n+++ b/src/lib/budabit/requests.ts\n@@ -7,9 +7,9 @@ import { load } from \"@welshman/net\"\n import { deriveEvents } from \"@welshman/store\"\n import { NAMED_BOOKMARKS, getAddressTags, normalizeRelayUrl } from \"@welshman/util\"\n import { validateGraspServerUrl } from \"@nostr-git/shared-types\"\n-import { INDEXER_RELAYS } from \"@app/core/state\"\n+import { GIT_RELAYS } from \"./state\"\n \n-export const loadUserGitData = async (pubkey: string, relays: string[] = INDEXER_RELAYS) =\u003e {\n+export const loadUserGitData = async (pubkey: string, relays: string[] = GIT_RELAYS) =\u003e {\n     await Promise.race([sleep(3000), loadRelaySelections(pubkey, relays)])\n \n     // Start centralized syncs (idempotent)\ndiff --git a/src/lib/budabit/state.ts b/src/lib/budabit/state.ts\nindex eadcfe6..f6e63b8 100644\n--- a/src/lib/budabit/state.ts\n+++ b/src/lib/budabit/state.ts\n@@ -16,7 +16,7 @@ import {\n } from \"@nostr-git/core\"\n import { repository } from \"@welshman/app\"\n import { collection, deriveEvents, withGetter } from \"@welshman/store\"\n-import { INDEXER_RELAYS, channelEvents, deriveEvent, messages, getUrlsForEvent, memberships, roomComparator, splitChannelId, userRoomsByUrl, type Channel, getMembershipRooms, ROOM } from \"@app/core/state\"\n+import { channelEvents, deriveEvent, messages, getUrlsForEvent, memberships, roomComparator, splitChannelId, userRoomsByUrl, type Channel, getMembershipRooms, ROOM, fromCsv } from \"@app/core/state\"\n import { normalizeRelayUrl, type TrustedEvent, ROOM_META, getTag } from \"@welshman/util\"\n import { nip19 } from \"nostr-tools\"\n import { fromPairs, nthEq, pushToMapKey, sortBy, uniq, uniqBy } from \"@welshman/lib\"\n@@ -32,7 +32,7 @@ export const GIT_CLIENT_ID = import.meta.env.VITE_GH_CLIENT_ID\n \n export const FREELANCE_JOB = 32767\n \n-export const GIT_RELAYS = import.meta.env.VITE_GIT_RELAYS\n+export const GIT_RELAYS = fromCsv(import.meta.env.VITE_GIT_RELAYS)\n \n export const ROOMS = 10009\n \n@@ -82,7 +82,7 @@ export const deriveRepoGroup = (euc: string) =\u003e\n export const deriveMaintainersForEuc = (euc: string) =\u003e\n   withGetter(derived(deriveRepoGroup(euc), g =\u003e (g ? deriveMaintainers(g) : new Set\u003cstring\u003e())))\n \n-export const loadRepoAnnouncements = (relays: string[] = INDEXER_RELAYS) =\u003e\n+export const loadRepoAnnouncements = (relays: string[] = GIT_RELAYS) =\u003e\n   load({\n     relays: relays.map(u =\u003e normalizeRelayUrl(u)).filter(Boolean) as string[],\n     filters: [{ kinds: [30617] }],\n@@ -244,7 +244,7 @@ export const loadRepoContext = (args: {\n     rootEventId: args.rootId,\n     euc: args.euc,\n   })\n-  const defaults = GIT_RELAYS \u0026\u0026 GIT_RELAYS.length \u003e 0 ? GIT_RELAYS : INDEXER_RELAYS\n+  const defaults = GIT_RELAYS\n   const relays = (args.relays || defaults)\n     .map((u: string) =\u003e normalizeRelayUrl(u))\n     .filter(Boolean) as string[]\n@@ -254,7 +254,7 @@ export const loadRepoContext = (args: {\n export const deriveNaddrEvent = (naddr: string, hints: string[] = []) =\u003e {\n   let attempted = false\n   const decoded = nip19.decode(naddr).data as nip19.AddressPointer\n-  const fallbackRelays = [...hints, ...INDEXER_RELAYS]\n+  const fallbackRelays = [...hints, ...GIT_RELAYS]\n   const relays = (decoded.relays \u0026\u0026 decoded.relays.length \u003e 0 ? decoded.relays : fallbackRelays)\n     .map(u =\u003e normalizeRelayUrl(u))\n     .filter(Boolean)\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nindex 2dae8c2..9dc7d8c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -22,7 +22,8 @@ import type {LayoutLoad} from \"./$types\"\n export const load: LayoutLoad = async ({params}) =\u003e {\n   const {id, relay} = params\n   // Dynamic imports to avoid SSR issues\n-  const {decodeRelay, INDEXER_RELAYS} = await import(\"@app/core/state\")\n+  const {decodeRelay} = await import(\"@app/core/state\")\n+  const {GIT_RELAYS} = await import(\"@src/lib/budabit/state\")\n   const {deriveEvents} = await import(\"@welshman/store\")\n   const {repository} = await import(\"@welshman/app\")\n   const {load} = await import(\"@welshman/net\")\n@@ -42,11 +43,11 @@ export const load: LayoutLoad = async ({params}) =\u003e {\n   }\n   const url = decodeRelay(relay)\n \n-  const fallbackRelays = INDEXER_RELAYS\n+  const fallbackRelays = GIT_RELAYS\n   const relayListFromUrl = (\n     (decoded.relays?.length ?? 0) \u003e 0 ? (decoded.relays as string[]) : fallbackRelays\n   )\n-    .map(u =\u003e normalizeRelayUrl(u))\n+    .map((u: string) =\u003e normalizeRelayUrl(u))\n     .filter(Boolean) as string[]\n \n   const filters = [\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-k0woh6u0","title":"From fde1fc366b2fa9a3bd07583393a95a77ddea10a6 Mon Sep 17 00:00:00 2001","description":"From fde1fc366b2fa9a3bd07583393a95a77ddea10a6 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Fri, 28 Nov 2025 16:09:30 +0500\nSubject: [PATCH 7/13] chore: update nostr-git submodule and remove purplepag.es relay\n\nThis commit updates dependencies and configuration for improved\nrepository creation functionality.\n\n- Remove wss://purplepag.es/ from VITE_INDEXER_RELAYS\n\nUpdate from 181d6ed7 to 4efc313f\n\nIncludes the following improvements:\n- Fix repo creation wizard UX with better keyboard navigation\n- Add case-insensitive duplicate tag detection\n- Implement chip-based tag display UI\n- Fix URL generation to use actual pubkey instead of placeholders\n- Improve autocomplete dropdown behavior across all components\n- Add auto-scroll on wizard step changes\n- Refactor relay handling to use sanitizeRelays utility\n---\n .env | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/.env b/.env\nindex f71b2f2..2589753 100644\n--- a/.env\n+++ b/.env\n@@ -10,7 +10,7 @@ VITE_PLATFORM_RELAYS=wss://budabit.nostr1.com/\n VITE_PLATFORM_ACCENT=\"#D4AF37\"\n VITE_PLATFORM_SECONDARY=\"#EB5E28\"\n VITE_PLATFORM_DESCRIPTION=\"The Club for Builders in Freedom Tech.\"\n-VITE_INDEXER_RELAYS=wss://purplepag.es/,wss://relay.damus.io/,wss://relay.nostr.band/\n+VITE_INDEXER_RELAYS=wss://relay.damus.io/,wss://relay.nostr.band/\n VITE_SIGNER_RELAYS=wss://relay.nsec.app/,wss://bucket.coracle.social/\n VITE_NOTIFIER_PUBKEY=27b7c2ed89ef78322114225ea3ebf5f72c7767c2528d4d0c1854d039c00085df\n VITE_NOTIFIER_RELAY=wss://anchor.coracle.social/\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-k7m1twno","title":"Some Buttons don't react immediately, sometimes need multiple presses","description":"Saw this behavior on 'Browse' and 'Issues' buttons on repo cards but the 'View Diff' button seemed to also do this weird behavior.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["bug","draft","issue"]}
{"id":"flotilla-kbd4mvfs","title":"Fix 'About' in menu","description":"It should be relevant info to budabit not flotilla","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue"]}
{"id":"flotilla-ke82hp1i","title":"From d997b5605cc7087ec828735e7911d0cd4485e909 Mon Sep 17 00:00:00 2001","description":"From d997b5605cc7087ec828735e7911d0cd4485e909 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 16 Nov 2025 21:20:58 +0500\nSubject: [PATCH] feat: implemented the logic for inline comments in diff viewer\n\n---\n packages/nostr-git                                                      |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 63 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-\n 2 files changed, 63 insertions(+), 2 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 354f97e..354e1f7 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 354f97ef399bbab7a0d40603e6288b1a1ee9aec7\n+Subproject commit 354e1f77df3e063abffe5b43406afa9e432e272f\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex f6b98a9..bd9cfd8 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -300,6 +300,54 @@\n     }\n   })\n \n+  // Transform CommentEvent[] into DiffViewer Comment[] format\n+  const diffComments = $derived.by(() =\u003e {\n+    const comments = $threadComments\n+    if (!comments || comments.length === 0) return []\n+    \n+    return comments.map((commentEvent: CommentEvent) =\u003e {\n+      // Parse line number and file path from comment content\n+      // Format: \"comment text\\n\\n---\\nFile: path\\nLine: 123\"\n+      let lineNumber = 0\n+      let filePath = \"\"\n+      let content = commentEvent.content\n+      \n+      const separatorIndex = content.indexOf('\\n\\n---\\n')\n+      if (separatorIndex !== -1) {\n+        // Extract the actual comment content (before the separator)\n+        content = content.substring(0, separatorIndex).trim()\n+        \n+        // Extract file path and line number from the metadata section\n+        const metadataSection = commentEvent.content.substring(separatorIndex + 6)\n+        const fileMatch = metadataSection.match(/File:\\s*(.+?)(?:\\n|$)/i)\n+        if (fileMatch) {\n+          filePath = fileMatch[1].trim()\n+        }\n+        const lineMatch = metadataSection.match(/Line:\\s*(\\d+)/i)\n+        if (lineMatch) {\n+          lineNumber = parseInt(lineMatch[1], 10)\n+        }\n+      }\n+      \n+      // Get profile information for the author\n+      const profile = $profilesByPubkey.get(commentEvent.pubkey)\n+      const authorName = profile?.name || profile?.display_name || commentEvent.pubkey.slice(0, 8)\n+      const authorAvatar = profile?.picture || \"\"\n+      \n+      return {\n+        id: commentEvent.id || \"\",\n+        lineNumber,\n+        filePath,\n+        content,\n+        author: {\n+          name: authorName,\n+          avatar: authorAvatar,\n+        },\n+        createdAt: new Date(commentEvent.created_at * 1000).toISOString(),\n+      }\n+    })\n+  })\n+\n   const getStatusFilter = () =\u003e ({\n     kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n     \"#e\": [selectedPatch?.id ?? \"\"],\n@@ -1081,7 +1129,20 @@\n                 \u003c/div\u003e\n               {/if}\n               {#if selectedPatch?.diff}\n-                \u003cDiffViewer diff={selectedPatch.diff} /\u003e\n+                {@const comments = diffComments}\n+                {@const diffViewerProps = {\n+                  diff: selectedPatch.diff,\n+                  rootEvent: patchEvent,\n+                  comments: comments,\n+                  onComment: (comment: Omit\u003cCommentEvent, \"id\" | \"pubkey\" | \"sig\"\u003e) =\u003e {\n+                    if (!patchEvent) return;\n+                    const commentEvent = comment as CommentEvent;\n+                    postComment(commentEvent, $repoRelays);\n+                  },\n+                  currentPubkey: $pubkey,\n+                  relays: $repoRelays,\n+                }}\n+                \u003cDiffViewer {...diffViewerProps} /\u003e\n               {/if}\n             \u003c/div\u003e\n           {/key}\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-kj7t97bo","title":"From fdf1f57126e9cb86291c63f1477ba589e82b5bc3 Mon Sep 17 00:00:00 2001","description":"From fdf1f57126e9cb86291c63f1477ba589e82b5bc3 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Fri, 4 Jul 2025 17:49:52 -0700\nSubject: [PATCH 1/1] feat: implement git repository feed view with real-time updates and message composition\n\n---\n packages/nostr-git                                         |   2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte | 447 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n 2 files changed, 448 insertions(+), 1 deletion(-)\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 3fdcb1f..035c761 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 3fdcb1f83d3e60f92c1dab29cdde4a5d2180127b\n+Subproject commit 035c7617c2016e99154120357ff4159dcaca5ef6\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte\nnew file mode 100644\nindex 0000000..3148a7a\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte\n@@ -0,0 +1,447 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import cx from \"classnames\"\n+  import {readable} from \"svelte/store\"\n+  import {onMount, onDestroy} from \"svelte\"\n+  import {page} from \"$app/stores\"\n+  import type {Readable} from \"svelte/store\"\n+  import {now, formatTimestampAsDate} from \"@welshman/lib\"\n+  import {load, request} from \"@welshman/net\"\n+  import type {TrustedEvent, EventContent} from \"@welshman/util\"\n+  import {\n+    makeEvent,\n+    makeRoomMeta,\n+    MESSAGE,\n+    DELETE,\n+    REACTION,\n+    ROOM_ADD_USER,\n+    ROOM_REMOVE_USER,\n+    GIT_ISSUE,\n+    GIT_PATCH,\n+    Address,\n+    GIT_STATUS_CLOSED,\n+    GIT_STATUS_DRAFT,\n+    GIT_STATUS_OPEN,\n+    GIT_STATUS_COMPLETE,\n+    COMMENT,\n+  } from \"@welshman/util\"\n+  import {\n+    pubkey,\n+    publishThunk,\n+    getThunkError,\n+    joinRoom,\n+    leaveRoom,\n+    deriveRelay,\n+  } from \"@welshman/app\"\n+  import {slide, fade, fly} from \"@lib/transition\"\n+  import Icon from \"@lib/components/Icon.svelte\"\n+  import Button from \"@lib/components/Button.svelte\"\n+  import Spinner from \"@lib/components/Spinner.svelte\"\n+  import PageBar from \"@lib/components/PageBar.svelte\"\n+  import PageContent from \"@lib/components/PageContent.svelte\"\n+  import Divider from \"@lib/components/Divider.svelte\"\n+  import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n+  import ChannelName from \"@app/components/ChannelName.svelte\"\n+  import ChannelMessage from \"@app/components/ChannelMessage.svelte\"\n+  import ChannelCompose from \"@app/components/ChannelCompose.svelte\"\n+  import ChannelComposeParent from \"@app/components/ChannelComposeParent.svelte\"\n+  import {\n+    userRoomsByUrl,\n+    userSettingValues,\n+    decodeRelay,\n+    deriveUserMembershipStatus,\n+    deriveChannel,\n+    MembershipStatus,\n+  } from \"@app/state\"\n+  import {setChecked, checked} from \"@app/notifications\"\n+  import {addRoomMembership, removeRoomMembership, prependParent} from \"@app/commands\"\n+  import {PROTECTED} from \"@app/state\"\n+  import {makeFeed} from \"@app/requests\"\n+  import {popKey} from \"@app/implicit\"\n+  import {pushToast} from \"@app/toast\"\n+  import {GIT_REPO} from \"@src/lib/util\"\n+\n+  const {id} = $page.params\n+  const {data} = $props()\n+  const {repoClass} = data\n+  const room = id\n+  const mounted = now()\n+  const lastChecked = $checked[$page.url.pathname]\n+  const url = decodeRelay($page.params.relay)\n+  const channel = deriveChannel(url, room)\n+\n+  const roomFilter = {kinds: [MESSAGE], \"#h\": [room]}\n+  const issueFilter = {\n+    kinds: [GIT_ISSUE],\n+    \"#a\": [Address.fromEvent(repoClass.repoEvent).toString()],\n+  }\n+  const patchFilter = {\n+    kinds: [GIT_PATCH],\n+    \"#a\": [Address.fromEvent(repoClass.repoEvent).toString()],\n+    \"#t\": [\"root\"],\n+  }\n+  const statusFilter = {\n+    kinds: [GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT, GIT_STATUS_OPEN],\n+    \"#e\": [...repoClass.issues.map(issue =\u003e issue.id), ...repoClass.patches.map(patch =\u003e patch.id)],\n+  }\n+\n+  const commentFilter = {\n+    kinds: [COMMENT],\n+    \"#E\": [...repoClass.issues.map(issue =\u003e issue.id), ...repoClass.patches.map(patch =\u003e patch.id)],\n+  }\n+\n+  const filter = [roomFilter, issueFilter, patchFilter, statusFilter, commentFilter]\n+\n+  const isFavorite = $derived($userRoomsByUrl.get(url)?.has(room))\n+  const membershipStatus = deriveUserMembershipStatus(url, room)\n+\n+  const addFavorite = () =\u003e addRoomMembership(url, room)\n+\n+  const removeFavorite = () =\u003e removeRoomMembership(url, room)\n+  const relay = deriveRelay(url)\n+\n+  const join = async () =\u003e {\n+    joining = true\n+\n+    try {\n+      const message = await getThunkError(joinRoom(url, makeRoomMeta({id: room})))\n+\n+      if (message \u0026\u0026 !message.startsWith(\"duplicate:\")) {\n+        return pushToast({theme: \"error\", message})\n+      } else {\n+        // Restart the feed now that we're a member\n+        start()\n+      }\n+    } finally {\n+      joining = false\n+    }\n+  }\n+\n+  const leave = async () =\u003e {\n+    leaving = true\n+    try {\n+      const message = await getThunkError(leaveRoom(url, makeRoomMeta({id: room})))\n+\n+      if (message \u0026\u0026 !message.startsWith(\"duplicate:\")) {\n+        pushToast({theme: \"error\", message})\n+      }\n+    } finally {\n+      leaving = false\n+    }\n+  }\n+\n+  const replyTo = (event: TrustedEvent) =\u003e {\n+    parent = event\n+    compose?.focus()\n+  }\n+\n+  const clearParent = () =\u003e {\n+    parent = undefined\n+  }\n+\n+  const clearShare = () =\u003e {\n+    share = undefined\n+  }\n+\n+  const onSubmit = ({content, tags}: EventContent) =\u003e {\n+    tags.push([\"h\", room])\n+    tags.push(PROTECTED)\n+\n+    let template = {content, tags}\n+\n+    if (share) {\n+      template = prependParent(share, template)\n+    }\n+\n+    if (parent) {\n+      template = prependParent(parent, template)\n+    }\n+\n+    publishThunk({\n+      relays: [url],\n+      event: makeEvent(MESSAGE, template),\n+      delay: $userSettingValues.send_delay,\n+    })\n+\n+    clearParent()\n+    clearShare()\n+  }\n+\n+  const onScroll = () =\u003e {\n+    showScrollButton = Math.abs(element?.scrollTop || 0) \u003e 1500\n+\n+    if (!newMessages || newMessagesSeen) {\n+      showFixedNewMessages = false\n+    } else {\n+      const {y} = newMessages.getBoundingClientRect()\n+\n+      if (y \u003e 300) {\n+        newMessagesSeen = true\n+      } else {\n+        showFixedNewMessages = y \u003c 0\n+      }\n+    }\n+  }\n+\n+  const scrollToNewMessages = () =\u003e\n+    newMessages?.scrollIntoView({behavior: \"smooth\", block: \"center\"})\n+\n+  const scrollToBottom = () =\u003e element?.scrollTo({top: 0, behavior: \"smooth\"})\n+\n+  let joining = $state(false)\n+  let leaving = $state(false)\n+  let loadingEvents = $state(true)\n+  let share = $state(popKey\u003cTrustedEvent | undefined\u003e(\"share\"))\n+  let parent: TrustedEvent | undefined = $state()\n+  let element: HTMLElement | undefined = $state()\n+  let newMessages: HTMLElement | undefined = $state()\n+  let chatCompose: HTMLElement | undefined = $state()\n+  let dynamicPadding: HTMLElement | undefined = $state()\n+  let newMessagesSeen = false\n+  let showFixedNewMessages = $state(false)\n+  let showScrollButton = $state(false)\n+  let cleanup: () =\u003e void\n+  let events: Readable\u003cTrustedEvent[]\u003e = $state(readable([]))\n+  let compose: ChannelCompose | undefined = $state()\n+\n+  const elements = $derived.by(() =\u003e {\n+    const elements = []\n+    const seen = new Set()\n+\n+    let previousDate\n+    let previousPubkey\n+    let newMessagesSeen = false\n+\n+    if (events) {\n+      const lastUserEvent = $events.find(e =\u003e e.pubkey === $pubkey)\n+\n+      // Adjust last checked to account for messages that came from a different device\n+      const adjustedLastChecked =\n+        lastChecked \u0026\u0026 lastUserEvent ? Math.max(lastUserEvent.created_at, lastChecked) : lastChecked\n+\n+      for (const event of $events.toReversed()) {\n+        if (seen.has(event.id)) {\n+          continue\n+        }\n+\n+        const date = formatTimestampAsDate(event.created_at)\n+\n+        if (\n+          !newMessagesSeen \u0026\u0026\n+          adjustedLastChecked \u0026\u0026\n+          event.pubkey !== $pubkey \u0026\u0026\n+          event.created_at \u003e adjustedLastChecked \u0026\u0026\n+          event.created_at \u003c mounted\n+        ) {\n+          elements.push({type: \"new-messages\", id: \"new-messages\"})\n+          newMessagesSeen = true\n+        }\n+\n+        if (date !== previousDate) {\n+          elements.push({type: \"date\", value: date, id: date, showPubkey: false})\n+        }\n+\n+        elements.push({\n+          id: event.id,\n+          type: \"note\",\n+          value: event,\n+          showPubkey: date !== previousDate || previousPubkey !== event.pubkey,\n+        })\n+\n+        previousDate = date\n+        previousPubkey = event.pubkey\n+        seen.add(event.id)\n+      }\n+    }\n+\n+    elements.reverse()\n+\n+    setTimeout(onScroll, 100)\n+\n+    return elements\n+  })\n+\n+  const start = async () =\u003e {\n+    cleanup?.()\n+\n+    const initialEvents = await load({\n+      relays: repoClass.relays || [url],\n+      filters: filter,\n+    })\n+\n+    initialEvents.push(\n+      ...repoClass.issues,\n+      ...repoClass.patches.filter(p =\u003e p.tags.some(t =\u003e t[0] === \"t\" \u0026\u0026 t[1] === \"root\")),\n+    )\n+\n+initialEvents.sort((a, b) =\u003e b.created_at - a.created_at)\n+\n+    const feed = makeFeed({\n+      element: element!,\n+      relays: [url],\n+      feedFilters: filter,\n+      subscriptionFilters: [\n+        ...filter,\n+        {kinds: [DELETE, REACTION, MESSAGE, GIT_REPO], \"#h\": [room], since: now()},\n+      ],\n+      initialEvents,\n+      onExhausted: () =\u003e {\n+        loadingEvents = false\n+      },\n+    })\n+\n+    events = feed.events\n+    cleanup = feed.cleanup\n+  }\n+\n+  onMount(() =\u003e {\n+    const controller = new AbortController()\n+\n+    request({\n+      signal: controller.signal,\n+      relays: [url],\n+      filters: [\n+        {\n+          kinds: [ROOM_ADD_USER, ROOM_REMOVE_USER],\n+          \"#p\": [$pubkey!],\n+          \"#h\": [room],\n+          limit: 10,\n+        },\n+      ],\n+    })\n+\n+    const observer = new ResizeObserver(() =\u003e {\n+      if (dynamicPadding \u0026\u0026 chatCompose) {\n+        dynamicPadding!.style.minHeight = `${chatCompose!.offsetHeight}px`\n+      }\n+    })\n+\n+    observer.observe(chatCompose!)\n+    observer.observe(dynamicPadding!)\n+    start()\n+\n+    return () =\u003e {\n+      controller.abort()\n+      observer.unobserve(chatCompose!)\n+      observer.unobserve(dynamicPadding!)\n+    }\n+  })\n+\n+  onDestroy(() =\u003e {\n+    cleanup()\n+\n+    // Sveltekit calls onDestroy at the beginning of the page load for some reason\n+    setTimeout(() =\u003e {\n+      setChecked($page.url.pathname)\n+    }, 800)\n+  })\n+\u003c/script\u003e\n+\n+\n+\u003cdiv bind:this={element} onscroll={onScroll} class=\"flex flex-col-reverse pt-4\"\u003e\n+  \u003cdiv bind:this={dynamicPadding}\u003e\u003c/div\u003e\n+  {#if $channel?.private \u0026\u0026 $membershipStatus !== MembershipStatus.Granted}\n+    \u003cdiv class=\"py-20\"\u003e\n+      \u003cdiv class=\"card2 col-8 m-auto max-w-md items-center text-center\"\u003e\n+        \u003cp class=\"row-2\"\u003eYou aren't currently a member of this room.\u003c/p\u003e\n+        {#if $membershipStatus === MembershipStatus.Pending}\n+          \u003cButton class=\"btn btn-neutral btn-sm\" disabled={leaving} onclick={leave}\u003e\n+            \u003cIcon icon=\"clock-circle\" /\u003e\n+            Access Pending\n+          \u003c/Button\u003e\n+        {:else}\n+          \u003cButton class=\"btn btn-neutral btn-sm\" disabled={joining} onclick={join}\u003e\n+            {#if joining}\n+              \u003cspan class=\"loading loading-spinner loading-sm\"\u003e\u003c/span\u003e\n+            {:else}\n+              \u003cIcon icon=\"login-2\" /\u003e\n+            {/if}\n+            Join Room\n+          \u003c/Button\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  {:else}\n+    {#each elements as { type, id, value, showPubkey } (id)}\n+      {#if type === \"new-messages\"}\n+        \u003cdiv\n+          bind:this={newMessages}\n+          class=\"flex items-center py-2 text-xs transition-colors\"\n+          class:opacity-0={showFixedNewMessages}\u003e\n+          \u003cdiv class=\"h-px flex-grow bg-primary\"\u003e\u003c/div\u003e\n+          \u003cp class=\"rounded-full bg-primary px-2 py-1 text-primary-content\"\u003eNew Messages\u003c/p\u003e\n+          \u003cdiv class=\"h-px flex-grow bg-primary\"\u003e\u003c/div\u003e\n+        \u003c/div\u003e\n+      {:else if type === \"date\"}\n+        \u003cDivider\u003e{value}\u003c/Divider\u003e\n+      {:else}\n+        \u003cdiv in:slide class:-mt-1={!showPubkey}\u003e\n+          \u003cChannelMessage\n+            {url}\n+            {replyTo}\n+            event={$state.snapshot(value as TrustedEvent)}\n+            {showPubkey} /\u003e\n+        \u003c/div\u003e\n+      {/if}\n+    {/each}\n+    \u003cp class=\"flex h-10 items-center justify-center py-20\"\u003e\n+      {#if loadingEvents}\n+        \u003cSpinner loading={loadingEvents}\u003eLooking for messages...\u003c/Spinner\u003e\n+      {:else}\n+        \u003cSpinner\u003eEnd of message history\u003c/Spinner\u003e\n+      {/if}\n+    \u003c/p\u003e\n+  {/if}\n+\u003c/div\u003e\n+\n+\u003cdiv class=\"chat__compose bg-base-200\" bind:this={chatCompose}\u003e\n+  {#if $channel?.private \u0026\u0026 $membershipStatus !== MembershipStatus.Granted}\n+    \u003c!-- pass --\u003e\n+  {:else if $channel?.closed \u0026\u0026 $membershipStatus !== MembershipStatus.Granted}\n+    \u003cdiv class=\"bg-alt card m-4 flex flex-row items-center justify-between px-4 py-3\"\u003e\n+      \u003cp\u003eOnly members are allowed to post to this room.\u003c/p\u003e\n+      {#if $membershipStatus === MembershipStatus.Pending}\n+        \u003cButton class=\"btn btn-neutral btn-sm\" disabled={leaving} onclick={leave}\u003e\n+          \u003cIcon icon=\"clock-circle\" /\u003e\n+          Access Pending\n+        \u003c/Button\u003e\n+      {:else}\n+        \u003cButton class=\"btn btn-neutral btn-sm\" disabled={joining} onclick={join}\u003e\n+          {#if joining}\n+            \u003cspan class=\"loading loading-spinner loading-sm\"\u003e\u003c/span\u003e\n+          {:else}\n+            \u003cIcon icon=\"login-2\" /\u003e\n+          {/if}\n+          Ask to Join\n+        \u003c/Button\u003e\n+      {/if}\n+    \u003c/div\u003e\n+  {:else}\n+    \u003cdiv\u003e\n+      {#if parent}\n+        \u003cChannelComposeParent event={parent} clear={clearParent} verb=\"Replying to\" /\u003e\n+      {/if}\n+      {#if share}\n+        \u003cChannelComposeParent event={share} clear={clearShare} verb=\"Sharing\" /\u003e\n+      {/if}\n+    \u003c/div\u003e\n+    \u003cChannelCompose bind:this={compose} {onSubmit} {url} /\u003e\n+  {/if}\n+\u003c/div\u003e\n+\n+{#if showScrollButton}\n+  \u003cdiv in:fade class=\"chat__scroll-down\"\u003e\n+    \u003cButton class=\"btn btn-circle btn-neutral\" onclick={scrollToBottom}\u003e\n+      \u003cIcon icon=\"alt-arrow-down\" /\u003e\n+    \u003c/Button\u003e\n+  \u003c/div\u003e\n+{/if}\n+\n+{#if showFixedNewMessages}\n+  \u003cdiv class=\"relative z-feature flex justify-center\"\u003e\n+    \u003cdiv transition:fly={{duration: 200}} class=\"fixed top-12\"\u003e\n+      \u003cButton class=\"btn btn-primary btn-xs rounded-full\" onclick={scrollToNewMessages}\u003e\n+        New Messages\n+      \u003c/Button\u003e\n+    \u003c/div\u003e\n+  \u003c/div\u003e\n+{/if}\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-kjuvink3","title":"Feature: Kanban boards","description":"Implement the nip kanbanstr uses.\nThe exact experience is not fleshed out yet.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["enhancement","issue","kanban"]}
{"id":"flotilla-kkivouf5","title":"From 1859f898c169d7ea8bfd29f35baa8563e1b050c2 Mon Sep 17 00:00:00 2001","description":"From 1859f898c169d7ea8bfd29f35baa8563e1b050c2 Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/2] Refactor to load repo events in the background\n\nrefactor: move repo state management to +layout.ts and add function registry for UI components","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-kqqrgj2x","title":"'Dev' branch on Flotilla-BudaBit shows only 1 Commit","description":"https://i.nostr.build/MTt0pqzd5SjrXclQ.png\nThis cannot be right, something weird is going on. This behavior has been consistently demonstrated.\nStrangely, the 'Code' tab has indeed the latest stated checked out. Perhaps an API call problem on 'Commit' tab?","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["branches","bug","commits","issue"]}
{"id":"flotilla-kupu30m2","title":"Issue card: many tags with long text overextend","description":"Small but annoying","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["bug","documentation","issue","issues"]}
{"id":"flotilla-lj1w8hj0","title":"From f699dfc235f22d16d78065e452ed2fcc2b2a4d45 Mon Sep 17 00:00:00 2001","description":"From f699dfc235f22d16d78065e452ed2fcc2b2a4d45 Mon Sep 17 00:00:00 2001\nFrom: Five \u003cco22rkn@protonmail.com\u003e\nDate: Mon, 23 Jun 2025 12:18:56 +0200\nSubject: [PATCH 6/8] Improvements around repoClass, Issues, Patches and Comments - Removed usage of function-registry - repoClass loaded with Symbol key from context - repo relays saved in context similarly to repoClass - Profile and ProfileLink components registered to nostr-git/ui to use them where avatar images, profile info or a name link is needed - postIssues and postComments provided as wrapped funcions for publishing events from nostr-git to be able to use welshman without type errors - Issues, Patches and comments on these work now mostly - Some reactivity issues and event ordering bugs remain\n\n---\n src/app/commands.ts                                                     | 16 ++++++++++++++++\n src/app/components/Profile.svelte                                       | 25 ++++++++++++++-----------\n src/app/state.ts                                                        |  4 ++++\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 | 13 +++++++++----\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts                     | 21 ++++-----------------\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte            | 32 ++++++++++++++++++++------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           | 23 ++++++++++++++++++-----\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 22 ++++++++++++----------\n 8 files changed, 97 insertions(+), 59 deletions(-)\n\ndiff --git a/src/app/commands.ts b/src/app/commands.ts\nindex 33d20b9..b846781 100644\n--- a/src/app/commands.ts\n+++ b/src/app/commands.ts\n@@ -65,6 +65,7 @@ import {\n   NOTIFIER_RELAY,\n   userRoomsByUrl,\n } from \"@app/state\"\n+import type { CommentEvent, IssueEvent } from \"@nostr-git/shared-types\"\n \n // Utils\n \n@@ -452,3 +453,18 @@ export const makeAlert = async ({cron, email, feed, bunker, secret, description}\n \n export const publishAlert = async (params: AlertParams) =\u003e\n   publishThunk({event: await makeAlert(params), relays: [NOTIFIER_RELAY]})\n+\n+export const postComment = (comment: CommentEvent, relays :string[]) =\u003e {\n+  return publishThunk({\n+    relays: relays ?? [],\n+    event: comment,\n+  });\n+}\n+\n+export const postIssue = (issue: IssueEvent, relays: string[]) =\u003e {\n+  return publishThunk({\n+    relays: relays ?? [],\n+    event: issue,\n+  });\n+}\n+\ndiff --git a/src/app/components/Profile.svelte b/src/app/components/Profile.svelte\nindex b19afa0..e0dd409 100644\n--- a/src/app/components/Profile.svelte\n+++ b/src/app/components/Profile.svelte\n@@ -19,9 +19,10 @@\n   type Props = {\n     pubkey: string\n     url?: string\n+    hideDetails?: boolean\n   }\n \n-  const {pubkey, url}: Props = $props()\n+  const {pubkey, url, hideDetails=false}: Props = $props()\n \n   const relays = removeNil([url])\n   const profile = deriveProfile(pubkey, relays)\n@@ -40,15 +41,17 @@\n   \u003cButton onclick={openProfile} class=\"py-1\"\u003e\n     \u003cAvatar src={$profile?.picture} size={10} /\u003e\n   \u003c/Button\u003e\n-  \u003cdiv class=\"flex min-w-0 flex-col\"\u003e\n-    \u003cdiv class=\"flex items-center gap-2\"\u003e\n-      \u003cButton onclick={openProfile} class=\"text-bold overflow-hidden text-ellipsis\"\u003e\n-        {$profileDisplay}\n-      \u003c/Button\u003e\n-      \u003cWotScore score={$score} active={following} /\u003e\n+  {#if !hideDetails}\n+    \u003cdiv class=\"flex min-w-0 flex-col\"\u003e\n+      \u003cdiv class=\"flex items-center gap-2\"\u003e\n+        \u003cButton onclick={openProfile} class=\"text-bold overflow-hidden text-ellipsis\"\u003e\n+          {$profileDisplay}\n+        \u003c/Button\u003e\n+        \u003cWotScore score={$score} active={following} /\u003e\n+      \u003c/div\u003e\n+      \u003cdiv class=\"overflow-hidden text-ellipsis text-sm opacity-75\"\u003e\n+        {$handle ? displayHandle($handle) : displayPubkey(pubkey)}\n+      \u003c/div\u003e\n     \u003c/div\u003e\n-    \u003cdiv class=\"overflow-hidden text-ellipsis text-sm opacity-75\"\u003e\n-      {$handle ? displayHandle($handle) : displayPubkey(pubkey)}\n-    \u003c/div\u003e\n-  \u003c/div\u003e\n+  {/if}\n \u003c/div\u003e\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 168bfea..2a4b32d 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -114,6 +114,10 @@ export const IMGPROXY_URL = \"https://imgproxy.coracle.social\"\n \n export const REACTION_KINDS = [REACTION, ZAP_RESPONSE]\n \n+export const REPO_KEY = Symbol(\"repo\");\n+\n+export const REPO_RELAYS_KEY = Symbol(\"repo-relays\");\n+\n export const NIP46_PERMS =\n   \"nip44_encrypt,nip44_decrypt,\" +\n   [CLIENT_AUTH, AUTH_JOIN, MESSAGE, THREAD, COMMENT, GROUPS, WRAP, REACTION]\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 62f976a..a161d4b 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -5,15 +5,19 @@\n   import {page} from \"$app/stores\"\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n   import Avatar from \"@lib/components/Avatar.svelte\"\n+  import Profile from \"@src/app/components/Profile.svelte\"\n+  import ProfileLink from \"@src/app/components/ProfileLink.svelte\"\n   import Divider from \"@lib/components/Divider.svelte\"\n   import Input from \"@lib/components/Field.svelte\"\n   import Dialog from \"@lib/components/Dialog.svelte\"\n   import {setContext} from \"svelte\"\n   import {pushToast} from \"@src/app/toast\"\n+  import { REPO_KEY, REPO_RELAYS_KEY } from \"@src/app/state.js\"\n \n   const {id, relay} = $page.params\n   let {data, children} = $props()\n-  const {repoClass, functionRegistry} = data\n+  // functionRegistry unused at the moment\n+  const {repoClass, relays, functionRegistry} = data\n \n   let activeTab: string | undefined = $page.url.pathname.split(\"/\").pop()\n   const encodedRelay = encodeURIComponent(relay)\n@@ -31,9 +35,8 @@\n     }\n   })\n \n-  setContext(\"functions\", functionRegistry)\n-  setContext(\"repoClass\", repoClass)\n-\n+  setContext(REPO_KEY, repoClass)\n+  setContext(REPO_RELAYS_KEY, relays)\n \u003c/script\u003e\n \n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n@@ -107,6 +110,8 @@\n           Separator: Divider as typeof import(\"@nostr-git/ui\").Separator,\n           Input: Input as typeof import(\"@nostr-git/ui\").Input,\n           Alert: Dialog as typeof import(\"@nostr-git/ui\").Alert,\n+          ProfileComponent: Profile as typeof import(\"@nostr-git/ui\").Profile,\n+          ProfileLink: ProfileLink as typeof import(\"@nostr-git/ui\").ProfileLink,\n         }}\u003e\n         {@render children()}\n       \u003c/ConfigProvider\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nindex fe5a0b5..8d6ab85 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -1,7 +1,6 @@\n export const ssr = false;\n-import { derived, get, type Readable } from 'svelte/store';\n+import { derived, type Readable } from 'svelte/store';\n import {\n-    type CommentEvent,\n     type IssueEvent,\n     type PatchEvent,\n     type RepoAnnouncementEvent,\n@@ -13,6 +12,7 @@ import { nip19 } from 'nostr-tools';\n import type { AddressPointer } from 'nostr-tools/nip19';\n import { nthEq } from '@welshman/lib';\n import { GIT_REPO, GIT_REPO_STATE } from '@src/lib/util.js';\n+import type { FunctionRegistry } from '@nostr-git/ui';\n \n export async function load({ params }) {\n     const { id, relay } = params;\n@@ -20,7 +20,7 @@ export async function load({ params }) {\n     // Dynamic imports to avoid SSR issues\n     const { decodeRelay, INDEXER_RELAYS } = await import('@app/state');\n     const { deriveEvents } = await import('@welshman/store');\n-    const { publishThunk, repository } = await import('@welshman/app');\n+    const { repository } = await import('@welshman/app');\n     const { load } = await import(\"@welshman/net\");\n     const { Repo } = await import('@nostr-git/ui');\n \n@@ -108,20 +108,7 @@ export async function load({ params }) {\n         (events) =\u003e (events || []) as StatusEvent[]\n     );\n \n-    const functionRegistry = {\n-        postComment: (comment: CommentEvent) =\u003e {\n-            return publishThunk({\n-                relays: get(relays) ?? [],\n-                event: comment,\n-            });\n-        },\n-\n-        postIssue: (issue: IssueEvent) =\u003e {\n-            return publishThunk({\n-                relays: get(relays) ?? [],\n-                event: issue,\n-            });\n-        },\n+    const functionRegistry:Partial\u003cFunctionRegistry\u003e = {\n     };\n \n     const repoClass = new Repo({\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex 88359dc..f0699e5 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -4,7 +4,7 @@\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Address, COMMENT, GIT_ISSUE} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n-  import {deriveProfile, repository, Thunk} from \"@welshman/app\"\n+  import { pubkey, repository } from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {makeFeed} from \"@src/app/requests\"\n   import {fly} from \"@lib/transition\"\n@@ -12,13 +12,10 @@\n   import {deriveEvents} from \"@welshman/store\"\n   import type {IssueEvent} from \"@nostr-git/shared-types\"\n   import {load} from \"@welshman/net\"\n+  import { REPO_KEY, REPO_RELAYS_KEY } from \"@src/app/state\"\n+  import { postComment, postIssue } from \"@src/app/commands\"\n \n-  interface FunctionRegistry {\n-    postComment: (comment: CommentEvent) =\u003e Thunk;\n-    postIssue: (issue: IssueEvent) =\u003e Thunk;\n-  }\n-\n-  const repoClass = getContext\u003cRepo\u003e(\"repoClass\")\n+  const repoClass = getContext\u003cRepo\u003e(REPO_KEY)\n \n   const commentFilter = {\n     kinds: [COMMENT],\n@@ -60,11 +57,9 @@\n     }\n   })\n \n-  const functions = getContext\u003cFunctionRegistry\u003e(\"functions\")\n-\n+  const repoRelays = getContext\u003cstring[]\u003e(REPO_RELAYS_KEY)\n   const onIssueCreated = async (issue: IssueEvent) =\u003e {\n-    await functions.postIssue(issue).result\n-    history.back()\n+    await postIssue(issue, repoClass.relays || repoRelays).result\n   }\n \n   const onNewIssue = () =\u003e {\n@@ -75,6 +70,14 @@\n     })\n   }\n \n+  const onCommentCreated = async (comment: CommentEvent) =\u003e {\n+    await postComment(comment, repoClass.relays || repoRelays).result\n+  }\n+\n+  $inspect(commentEvents).with((type, comments) =\u003e {\n+    console.log('comments for all issues on the repo in budabit:')\n+  })\n+\n \u003c/script\u003e\n \n \u003cdiv bind:this={element}\u003e\n@@ -117,7 +120,12 @@\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each repoClass.issues as issue (issue.id)}\n         \u003cdiv in:fly\u003e\n-          \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)} comments={commentEvents}/\u003e\n+          \u003cIssueCard\n+            event={issue}\n+            comments={commentEvents}\n+            currentCommenter={$pubkey!}\n+            onCommentCreated={onCommentCreated}\n+          /\u003e\n         \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 3ea5803..1aa6de3 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -47,7 +47,6 @@\n           ...patch.raw,\n           patches: repoClass.patches.filter(issue =\u003e issue.id === patch.id),\n           status,\n-          profile,\n         }\n       })\n     }\n@@ -62,10 +61,21 @@\n     \"#t\": [\"root\"],\n   }\n \n+  const commentFilter = {\n+    kinds: [COMMENT],\n+    \"#E\": [...repoClass.patches.map(i =\u003e i.id)],\n+  }\n+\n+  const allComments = $derived.by(() =\u003e {\n+    if(repoClass.patches) {\n+      return deriveEvents(repository, {filters:[commentFilter]})\n+    }\n+  })\n+\n   $effect(() =\u003e {\n     if (repoClass.patches) {\n-      load({relays: repoClass.relays, filters: [patchFilter, statusFilter]})\n-\n+      load({relays: repoClass.relays, filters: [patchFilter, statusFilter, commentFilter]})\n+ \n       makeFeed({\n         element: element!,\n         relays: repoClass.relays,\n@@ -82,7 +92,7 @@\n \u003c/script\u003e\n \n \u003cdiv bind:this={element}\u003e\n-  \u003cdiv class=\"z-10 sticky top-0 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n+  \u003cdiv class=\"z-10 sticky z-nav -top-8 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003ePatches\u003c/h2\u003e\n       \u003cp class=\"text-sm text-muted-foreground\"\u003eReview and merge code changes\u003c/p\u003e\n@@ -119,8 +129,11 @@\n   {:else}\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each patchList! as patch}\n+        {@const count = $allComments\n+          ?.filter((c)=\u003egetTagValue(\"E\", c.tags) === patch.id).length ?? 0\n+        }\n         \u003cdiv in:fly\u003e\n-          \u003cPatchCard event={patch} status={patch.status} author={patch.profile} /\u003e\n+          \u003cPatchCard event={patch} status={patch.status} commentCount={count} /\u003e\n         \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 24a3a23..1aa1123 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -30,11 +30,10 @@\n \n   const statusEvents = deriveEvents(repository, {filters: [statusFilter]})\n \n-  const patchProfile = $derived.by(() =\u003e {\n-    if (patch) {\n-      return deriveProfile(patch.author.pubkey)\n-    }\n-  })\n+  const repoRelays = getContext\u003cstring[]\u003e(REPO_RELAYS_KEY)\n+  const onCommentCreated = async (comment: CommentEvent) =\u003e {\n+    await postComment(comment, repoClass.relays || repoRelays).result\n+  }\n \n   const status = $derived.by(() =\u003e {\n     if ($statusEvents) {\n@@ -100,10 +99,7 @@\n             \u003c/div\u003e\n           \u003c/div\u003e\n \n-          \u003cAvatar class=\"h-10 w-10\"\u003e\n-            \u003cAvatarImage src={$patchProfile?.picture} alt={$patchProfile?.name} /\u003e\n-            \u003cAvatarFallback\u003e{$patchProfile?.name?.substring(0, 2).toUpperCase()}\u003c/AvatarFallback\u003e\n-          \u003c/Avatar\u003e\n+          \u003cProfile pubkey={patch.author.pubkey} hideDetails={true}\u003e\u003c/Profile\u003e\n         \u003c/div\u003e\n \n         \u003cdiv class=\"git-separator\"\u003e\u003c/div\u003e\n@@ -135,7 +131,13 @@\n             Discussion ({$threadComments?.length})\n           \u003c/h2\u003e\n \n-          \u003cIssueThread issueId={patch?.id} comments={$threadComments as CommentEvent[]} /\u003e\n+          \u003cIssueThread\n+            issueId = {patch?.id}\n+            issueKind={GIT_PATCH.toString() as '1617'}\n+            comments = {$threadComments}\n+            currentCommenter = {$pubkey!}\n+            onCommentCreated={onCommentCreated}\n+          /\u003e\n         \u003c/div\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-m7b58iqi","title":"From 4a8e676f60d35ed89db484b1b5b7c4b147625332 Mon Sep 17 00:00:00 2001","description":"From 4a8e676f60d35ed89db484b1b5b7c4b147625332 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Tue, 3 Jun 2025 16:46:30 -0700\nSubject: [PATCH 15/67] Use kind 15 to send images in DMs\n\n---\n src/app/components/Chat.svelte                  | 78 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++----------\n src/app/components/ContentLinkBlockImage.svelte |  2 +-\n src/app/components/ContentQuote.svelte          | 12 ++++++++++--\n src/app/state.ts                                |  5 ++++-\n src/routes/+layout.svelte                       |  5 ++++-\n 5 files changed, 87 insertions(+), 15 deletions(-)\n\ndiff --git a/src/app/components/Chat.svelte b/src/app/components/Chat.svelte\nindex aa4b9cf..077d61a 100644\n--- a/src/app/components/Chat.svelte\n+++ b/src/app/components/Chat.svelte\n@@ -1,9 +1,28 @@\n \u003cscript lang=\"ts\"\u003e\n   import type {Snippet} from \"svelte\"\n   import {onMount} from \"svelte\"\n-  import {int, nthNe, MINUTE, sortBy, remove, formatTimestampAsDate} from \"@welshman/lib\"\n-  import type {TrustedEvent, EventContent} from \"@welshman/util\"\n-  import {createEvent, DIRECT_MESSAGE, INBOX_RELAYS} from \"@welshman/util\"\n+  import {\n+    int,\n+    ms,\n+    partition,\n+    spec,\n+    nthEq,\n+    nthNe,\n+    MINUTE,\n+    sortBy,\n+    remove,\n+    formatTimestampAsDate,\n+  } from \"@welshman/lib\"\n+  import type {TrustedEvent, EventTemplate, EventContent} from \"@welshman/util\"\n+  import {parse, isLink} from \"@welshman/content\"\n+  import {\n+    createEvent,\n+    tagsFromIMeta,\n+    getTags,\n+    DIRECT_MESSAGE,\n+    DIRECT_MESSAGE_FILE,\n+    INBOX_RELAYS,\n+  } from \"@welshman/util\"\n   import {\n     pubkey,\n     tagPubkey,\n@@ -61,14 +80,53 @@\n   }\n \n   const onSubmit = async (params: EventContent) =\u003e {\n+    const ptags = remove($pubkey!, pubkeys).map(tagPubkey)\n+\n     // Remove p tags since they result in forking the conversation\n-    const tags = [...params.tags.filter(nthNe(0, \"p\")), ...remove($pubkey!, pubkeys).map(tagPubkey)]\n+    params.tags = params.tags.filter(nthNe(0, \"p\"))\n \n-    await sendWrapped({\n-      pubkeys,\n-      template: createEvent(DIRECT_MESSAGE, prependParent(parent, {...params, tags})),\n-      delay: $userSettingValues.send_delay,\n-    })\n+    // Add our reply quote to content\n+    params = prependParent(parent, params)\n+\n+    const [imetaTags, tags] = partition(nthEq(0, \"imeta\"), params.tags)\n+    const imetas = getTags(\"imeta\", imetaTags).map(tagsFromIMeta)\n+    const templates: EventTemplate[] = []\n+    const buffer = []\n+\n+    const addTemplate = (kind: number, content: string, tags: string[][]) =\u003e {\n+      content = content.trim()\n+\n+      if (content) {\n+        templates.push(createEvent(kind, {content, tags: [...tags, ...ptags]}))\n+      }\n+    }\n+\n+    for (const p of parse(params)) {\n+      const imeta = isLink(p)\n+        ? imetas.find(tags =\u003e tags.find(spec([\"url\", p.value.url.toString()])))\n+        : undefined\n+\n+      if (isLink(p) \u0026\u0026 imeta) {\n+        addTemplate(DIRECT_MESSAGE, buffer.splice(0).join(\"\"), tags)\n+        addTemplate(\n+          DIRECT_MESSAGE_FILE,\n+          p.value.url.toString(),\n+          imeta.slice(1).filter(nthNe(0, \"url\")),\n+        )\n+      } else {\n+        buffer.push(p.raw)\n+      }\n+    }\n+\n+    addTemplate(DIRECT_MESSAGE, buffer.splice(0).join(\"\"), tags)\n+\n+    // Split the message into multiple pieces so that we can use kind 15 to send images per nip 17\n+    // Sleep 1 second between each one to make sure timestamps are distinct\n+    for (let i = 0; i \u003c templates.length; i++) {\n+      const template = templates[i]\n+\n+      await sendWrapped({pubkeys, template, delay: $userSettingValues.send_delay + ms(i)})\n+    }\n \n     clearParent()\n   }\n@@ -191,7 +249,7 @@\n   {/snippet}\n \u003c/PageBar\u003e\n \n-\u003cPageContent class=\"flex flex-col-reverse pt-4\"\u003e\n+\u003cPageContent class=\"flex flex-col-reverse gap-2 pt-4\"\u003e\n   \u003cdiv bind:this={dynamicPadding}\u003e\u003c/div\u003e\n   {#if missingInboxes.includes($pubkey!)}\n     \u003cdiv class=\"py-12\"\u003e\ndiff --git a/src/app/components/ContentLinkBlockImage.svelte b/src/app/components/ContentLinkBlockImage.svelte\nindex 36a02e6..076fe0d 100644\n--- a/src/app/components/ContentLinkBlockImage.svelte\n+++ b/src/app/components/ContentLinkBlockImage.svelte\n@@ -10,7 +10,7 @@\n   const meta =\n     getTags(\"imeta\", event.tags)\n       .map(tagsFromIMeta)\n-      .find(meta =\u003e getTagValue(\"url\", meta) === url) || []\n+      .find(meta =\u003e getTagValue(\"url\", meta) === url) || event.tags\n \n   const key = getTagValue(\"decryption-key\", meta)\n   const nonce = getTagValue(\"decryption-nonce\", meta)\ndiff --git a/src/app/components/ContentQuote.svelte b/src/app/components/ContentQuote.svelte\nindex ed8a7c9..0c8f02e 100644\n--- a/src/app/components/ContentQuote.svelte\n+++ b/src/app/components/ContentQuote.svelte\n@@ -5,7 +5,15 @@\n   import {Router} from \"@welshman/router\"\n   import {tracker, repository} from \"@welshman/app\"\n   import type {TrustedEvent} from \"@welshman/util\"\n-  import {Address, getTagValue, DIRECT_MESSAGE, MESSAGE, THREAD, EVENT_TIME} from \"@welshman/util\"\n+  import {\n+    Address,\n+    getTagValue,\n+    DIRECT_MESSAGE,\n+    DIRECT_MESSAGE_FILE,\n+    MESSAGE,\n+    THREAD,\n+    EVENT_TIME,\n+  } from \"@welshman/util\"\n   import {scrollToEvent} from \"@lib/html\"\n   import Button from \"@lib/components/Button.svelte\"\n   import Spinner from \"@lib/components/Spinner.svelte\"\n@@ -52,7 +60,7 @@\n \n   const onclick = () =\u003e {\n     if ($quote) {\n-      if ($quote.kind === DIRECT_MESSAGE) {\n+      if ($quote.kind === DIRECT_MESSAGE || $quote.kind === DIRECT_MESSAGE_FILE) {\n         return scrollToEvent($quote.id)\n       }\n \ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex fe6c5cb..762ffa9 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -29,6 +29,7 @@ import {\n   REACTION,\n   ZAP_RESPONSE,\n   DIRECT_MESSAGE,\n+  DIRECT_MESSAGE_FILE,\n   GROUP_META,\n   MESSAGE,\n   GROUPS,\n@@ -444,7 +445,9 @@ export const {\n \n // Chats\n \n-export const chatMessages = deriveEvents(repository, {filters: [{kinds: [DIRECT_MESSAGE]}]})\n+export const chatMessages = deriveEvents(repository, {\n+  filters: [{kinds: [DIRECT_MESSAGE, DIRECT_MESSAGE_FILE]}],\n+})\n \n export type Chat = {\n   id: string\ndiff --git a/src/routes/+layout.svelte b/src/routes/+layout.svelte\nindex 1d87079..6b8797e 100644\n--- a/src/routes/+layout.svelte\n+++ b/src/routes/+layout.svelte\n@@ -17,6 +17,7 @@\n     MESSAGE,\n     INBOX_RELAYS,\n     DIRECT_MESSAGE,\n+    DIRECT_MESSAGE_FILE,\n     MUTES,\n     FOLLOWS,\n     PROFILE,\n@@ -177,7 +178,9 @@\n               return 1\n             }\n \n-            if ([EVENT_TIME, THREAD, MESSAGE, DIRECT_MESSAGE].includes(e.kind)) {\n+            if (\n+              [EVENT_TIME, THREAD, MESSAGE, DIRECT_MESSAGE, DIRECT_MESSAGE_FILE].includes(e.kind)\n+            ) {\n               return 0.9\n             }\n \n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-mdhng6xy","title":"From e3c62ba98855be7ea3626156ca4229bca36f8f9c Mon Sep 17 00:00:00 2001","description":"From e3c62ba98855be7ea3626156ca4229bca36f8f9c Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 29 Jul 2025 02:34:20 -0700\nSubject: [PATCH 2/4] feat: add timeout to NIP-04 token decryption and new repo wizard button\n\n---\n packages/nostr-git                         |  2 +-\n pnpm-lock.yaml                             | Bin 498514 -\u003e 498591 bytes\n src/lib/utils/tokenLoader.ts               | 12 ++++++++----\n src/routes/+layout.svelte                  |  1 -\n src/routes/spaces/[relay]/git/+page.svelte | 13 +++++++++++++\n 5 files changed, 22 insertions(+), 6 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 18c78d2..0336d88 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 18c78d2675110698468e20fb074c0c406d96affd\n+Subproject commit 0336d880f964d5179b4be9cbefb41989159fa1a3\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 43a0976cd90986f6f12628a7098e0e84021d9669..1d6fd1c3f9702f95cc5d744b6a18251f23bf1531 100644\nGIT binary patch\ndelta 327\nzc$~YmO\u003eX{nxeW{4rqA+Y6`X9WF3x0ZG5Mgj2%DLnv4x)DWL^\u0026c\u0026ClF4J0\u003e4$Qx6Nu\nz4e`%*HO~kNHTDk+axHWV^9%|1s4~k\u003ePIt;GGq7;aPYozec1+Ap4+~67\u0026U7\u003emc6WBo\nzHqTA6^sFimH#1E3_Rh@-De#DJH**PfH4ROw(Dro?Z0\u003cSV-gBN2h?#(xd3(=!mdVA8\nzhSL+9SmmbMIkV0{Vhc=SW!=u@!g`evBB-;S$Bk70\u0026hd0-ErN4ic(ATwf^w$s_hxN?\nzu\u003cfQ_Xke9`KHZ144JaVz3!_x0e{f@EnSRcf^)XOjeFLlF^!ZJ!tkZA!v5HO?a$(h+\nfKEab!q+QFOb-R{7n=m({VY^)v+jhGsb`eJa5yNVk\n\ndelta 309\nzc$}NRUGCC0xeW{4CW~\u003enZ8mn-?3nD_tsYic7Mz?BTJGVWQd$s^onl_$Wssj_Y?hT$\nz92}(Ysjcs\u003c9hMYnke23@\u003e0|1b864v3\u003cdWuO808+Gl;oM?l44qso)Vg!pHiuvQ=09V\nz;$IP2\u003cnNT4-hA_X`_1!=K+FWh%-e6CXPI2gXfXYOH\u003e=$AZfDjRNNj;gtgPF^U0AO\u0026\nzLIicD^SiS0Y)^G#Wr2xopXSb51m~D~vaVu+aMr-I*fp?fPk-XW+6ELT@Mjg7UhfOk\nzfnW\u003cxcW`E9nJ(?e`WPts-;dRLx\u003eGgKetu_G?\u0026\u003cc\u003ctRn5@{;b=}{n\u003e=M84cRIqu920\nJN3n}I0suC`XwU!v\n\ndiff --git a/src/lib/utils/tokenLoader.ts b/src/lib/utils/tokenLoader.ts\nindex 312d270..16432fb 100644\n--- a/src/lib/utils/tokenLoader.ts\n+++ b/src/lib/utils/tokenLoader.ts\n@@ -52,7 +52,6 @@ export async function loadTokensFromStorage(tokenKey: string): Promise\u003cTokenEntr\n \n     const encryptedTokens = localStorage.getItem(tokenKey);\n     if (!encryptedTokens) {\n-\n       return [];\n     }\n \n@@ -67,15 +66,20 @@ export async function loadTokensFromStorage(tokenKey: string): Promise\u003cTokenEntr\n \n \n     \n-    // Decrypt the tokens\n-    const decrypted = await signerInfo.signer.nip04.decrypt(signerInfo.pubkey, encryptedTokens);\n+    // Decrypt the tokens with timeout to prevent hanging\n+    const decryptPromise = signerInfo.signer.nip04.decrypt(signerInfo.pubkey, encryptedTokens);\n+    const timeoutPromise = new Promise((_, reject) =\u003e \n+      setTimeout(() =\u003e reject(new Error('NIP-04 decryption timed out after 10 seconds')), 10000)\n+    );\n+    \n+    const decrypted = await Promise.race([decryptPromise, timeoutPromise]);\n+    \n     if (!decrypted) {\n       console.warn('🔐 Failed to decrypt tokens from localStorage');\n       return [];\n     }\n \n     const tokens = JSON.parse(decrypted) as TokenEntry[];\n-\n     return tokens;\n \n   } catch (error) {\ndiff --git a/src/routes/+layout.svelte b/src/routes/+layout.svelte\nindex e6a543e..13ea0e7 100644\n--- a/src/routes/+layout.svelte\n+++ b/src/routes/+layout.svelte\n@@ -238,7 +238,6 @@\n           const loadedTokens = await loadTokensFromStorage(tokenKey)\n           tokens.clear()\n           loadedTokens.forEach(token =\u003e tokens.push(token))\n-\n         } catch (error) {\n           console.warn('🔐 Failed to initialize git tokens at app level:', error)\n         }\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 00dd81b..5a0bf46 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -20,6 +20,7 @@\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {derived as _derived} from \"svelte/store\"\n+    import { NewRepoWizard } from \"@nostr-git/ui\"\n \n   const url = decodeRelay($page.params.relay)\n \n@@ -97,6 +98,14 @@\n       },\n     })\n   }\n+\n+  const onNewRepo = () =\u003e {\n+    pushModal(NewRepoWizard, {\n+      onClose: () =\u003e {\n+        back()\n+      },\n+    })\n+  }\n \u003c/script\u003e\n \n \u003cPageBar\u003e\n@@ -110,6 +119,10 @@\n   {/snippet}\n   {#snippet action()}\n     \u003cdiv class=\"row-2\"\u003e\n+      \u003cButton class=\"btn btn-secondary btn-sm\" onclick={onNewRepo}\u003e\n+        \u003cIcon icon=\"add-circle\" /\u003e\n+        New Repo\n+      \u003c/Button\u003e\n       \u003cButton class=\"btn btn-primary btn-sm\" onclick={onAddRepo}\u003e\n         \u003cIcon icon=\"git\" /\u003e\n         Edit Repos\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-meta-extension-inventory","title":"Inventory existing Budabit extension implementation","description":"Audit the current Budabit extension framework, including entry points, lifecycle hooks, rendering model, persistence assumptions, and divergences from the Smart Widgets NIP.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T00:21:39.733124-08:00"}
{"id":"flotilla-meta-extension-scope","title":"Define extension system scope and goals","description":"Define the high-level goals, constraints, and non-goals of the Budabit extension system. Clarify how extensions differ from core features and how Smart Widgets fit into the architecture.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T00:21:39.733124-08:00"}
{"id":"flotilla-meta-integration-complete","title":"Declare Smart Widget integration complete","description":"Mark Smart Widget integration as complete once all blocking issues are resolved and acceptance criteria pass.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T00:21:39.733124-08:00"}
{"id":"flotilla-mf3eg05m","title":"Remove general discovery home page","description":"/home route is unnecessary for BudaBit because it is not like the general flotilla client that allows multiple spaces for the user but a dedicated dev comunity.\n- The spaces home page should be there by default\n- The general home button on the left sidebar should be removed\n- The 'Discover Spaces' button on the left sidebar should be removed","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue"]}
{"id":"flotilla-mido61z5","title":"From efbc7f5a7eb8672813e3f4f78b3426af8fc480f4 Mon Sep 17 00:00:00 2001","description":"From efbc7f5a7eb8672813e3f4f78b3426af8fc480f4 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Fri, 11 Jul 2025 21:44:21 -0700\nSubject: [PATCH 3/3] feat: enhance git patch UI with merge analysis and technical details\n\n---\n packages/nostr-git                                                      |   2 +-\n src/app/components/GitActions.svelte                                    |  20 +++++++-------------\n src/app/components/GitAuth.svelte                                       |  94 +++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------------\n src/app/components/GitAuthAdd.svelte                                    |  72 +++++++++++++++++++++++++++++++++++++-----------------------------------\n src/app/components/ProfileDetail.svelte                                 |   8 ++++++--\n src/app/routes.ts                                                       |   3 +++\n src/routes/+layout.svelte                                               |   4 ++++\n src/routes/settings/profile/+page.svelte                                |   4 +++-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |  10 ++++++++--\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           |  11 ++++++++++-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 331 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-----------------\n src/routes/spaces/[relay]/git/repos/+page.svelte                        | 102 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/repos/[id]/+page.svelte                   | 107 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n 13 files changed, 647 insertions(+), 121 deletions(-)\n create mode 100644 src/routes/spaces/[relay]/git/repos/+page.svelte\n create mode 100644 src/routes/spaces/[relay]/git/repos/[id]/+page.svelte\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex fa2291f..2add9f0 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit fa2291f7ee37f2ccb8179a3f76f31daeb423f6f7\n+Subproject commit 2add9f07ac9f0ebff49a63b934f07c9ff5799b5e\ndiff --git a/src/app/components/GitActions.svelte b/src/app/components/GitActions.svelte\nindex 906213d..dda62fc 100644\n--- a/src/app/components/GitActions.svelte\n+++ b/src/app/components/GitActions.svelte\n@@ -8,12 +8,11 @@\n   import {publishDelete, publishReaction} from \"@app/commands\"\n   import {makeGitPath} from \"@app/routes\"\n   import Button from \"@src/lib/components/Button.svelte\"\n-  import Link from \"@src/lib/components/Link.svelte\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {nthEq} from \"@welshman/lib\"\n-    import { navigating } from \"$app/state\"\n-    import { goto } from \"$app/navigation\"\n+  import {navigating} from \"$app/state\"\n+  import {goto} from \"$app/navigation\"\n \n   interface Props {\n     url: any\n@@ -54,7 +53,6 @@\n \n   $effect(() =\u003e {\n     if (navigating.type) {\n-\n     }\n   })\n \n@@ -64,10 +62,8 @@\n   }\n \n   const gotoIssues = async () =\u003e {\n-    const destination = makeGitPath(\n-      url, Address.fromEvent(event).toNaddr()\n-    ) + \"/issues\"\n-    \n+    const destination = makeGitPath(url, Address.fromEvent(event).toNaddr()) + \"/issues\"\n+\n     goto(destination)\n   }\n \n@@ -79,16 +75,14 @@\n \u003cdiv class=\"flex flex-wrap items-center justify-between gap-2\"\u003e\n   \u003cdiv class=\"flex flex-grow flex-wrap justify-end gap-2\"\u003e\n     \u003cButton\n-      class=\"cursor-pointer btn btn-primary btn-sm\"\n+      class=\"btn btn-primary btn-sm cursor-pointer\"\n       onclick={gotoRepo}\n       disabled={!!navigating.type}\u003e\n-      \u003cSpinner loading={!!navigating.type} minHeight={\"min-h-6\"}\u003e\n-        Browse\n-      \u003c/Spinner\u003e\n+      \u003cSpinner loading={!!navigating.type} minHeight={\"min-h-6\"}\u003eBrowse\u003c/Spinner\u003e\n     \u003c/Button\u003e\n     {#if showIssues}\n       \u003cButton\n-        class=\"flex btn btn-secondary btn-sm cursor-pointer items-center\"\n+        class=\"btn btn-secondary btn-sm flex cursor-pointer items-center\"\n         onclick={gotoIssues}\n         disabled={!!navigating.type}\u003e\n         \u003cSpinner loading={loadingIssues || !!navigating.type} minHeight={\"min-h-6\"}\u003e\ndiff --git a/src/app/components/GitAuth.svelte b/src/app/components/GitAuth.svelte\nindex 3e22c6d..e408358 100644\n--- a/src/app/components/GitAuth.svelte\n+++ b/src/app/components/GitAuth.svelte\n@@ -4,28 +4,38 @@\n   import Button from \"@lib/components/Button.svelte\"\n   import {pushModal} from \"@app/modal\"\n   import GitAuthAdd from \"@app/components/GitAuthAdd.svelte\"\n+  import {pubkey} from \"@welshman/app\"\n+  import {signer} from \"@welshman/app\"\n \n   type Props = {\n-    clientId: string\n     tokenKey: string\n-    callbackUrl?: string\n   }\n \n-  const {clientId, tokenKey, callbackUrl}: Props = $props()\n+  const {tokenKey}: Props = $props()\n \n   type TokenEntry = {host: string; token: string}\n \n-  function loadTokens(): TokenEntry[] {\n-    console.log(localStorage.getItem(tokenKey))\n+  async function loadTokens(): Promise\u003cTokenEntry[]\u003e {\n     try {\n-      return JSON.parse(localStorage.getItem(tokenKey) ?? \"[]\")\n-    } catch {\n+      const tok = localStorage.getItem(tokenKey)\n+      if (!tok) return []\n+      const decrypted = await $signer.nip04.decrypt($pubkey!, tok)\n+      if (!decrypted) return []\n+      return JSON.parse(decrypted)\n+    } catch (e) {\n+      console.error(\"Failed to load tokens\", e)\n       return []\n     }\n   }\n \n-  function saveTokens(toks: TokenEntry[]) {\n-    localStorage.setItem(tokenKey, JSON.stringify(toks))\n+  async function saveTokens(toks: TokenEntry[]) {\n+    try {\n+      const encrypted = await $signer.nip04.encrypt($pubkey!, JSON.stringify(toks))\n+      console.log(encrypted)\n+      localStorage.setItem(tokenKey, encrypted)\n+    } catch (e) {\n+      console.error(\"Failed to save tokens\", e)\n+    }\n   }\n \n   function mask(t: string) {\n@@ -33,38 +43,15 @@\n   }\n \n   let tokens: TokenEntry[] = $state([])\n-  let host = $state(\"\")\n-  let token = $state(\"\")\n-  let showForm = $state(false)\n-  let busy = $state(false)\n-  let userCode = $state(\"\")\n-  let verificationUri = $state(\"\")\n-  let error = $state(\"\")\n \n-  onMount(() =\u003e (tokens = loadTokens()))\n-\n-  function saveManual() {\n-    if (!host.trim() || !token.trim()) return\n-    tokens = [\n-      ...tokens.filter(t =\u003e t.host !== host.trim()),\n-      {host: host.trim(), token: token.trim()},\n-    ]\n-    saveTokens(tokens)\n-    reset()\n-  }\n+  onMount(async () =\u003e (tokens = await loadTokens()))\n \n   function del(h: string) {\n     tokens = tokens.filter(t =\u003e t.host !== h)\n     saveTokens(tokens)\n   }\n \n-  function reset() {\n-    host = token = verificationUri = userCode = \"\"\n-    busy = showForm = false\n-    error = \"\"\n-  }\n-\n-  const openDialog = () =\u003e pushModal(GitAuthAdd, {clientId, tokenKey, callbackUrl})\n+  const openDialog = () =\u003e pushModal(GitAuthAdd, {tokenKey})\n \u003c/script\u003e\n \n \u003cdiv class=\"card2 bg-alt flex flex-col gap-6 shadow-xl\"\u003e\n@@ -80,22 +67,31 @@\n   \u003c/div\u003e\n \n   {#if tokens.length}\n-  \u003cdiv class=\"flex items-center justify-between\"\u003e\n-    \u003ctable class=\"mb-4 w-full\"\u003e\n-      \u003cthead\u003e\u003ctr\u003e\u003cth\u003eHost\u003c/th\u003e\u003cth\u003eToken\u003c/th\u003e\u003cth\u003e\u003c/th\u003e\u003c/tr\u003e\u003c/thead\u003e\n-      \u003ctbody\u003e\n-        {#each tokens as t}\n-          \u003ctr class=\"hover:bg-neutral flex items-center p-4\"\u003e\n-            \u003ctd class=\"w-1/3\"\u003e{t.host}\u003c/td\u003e\n-            \u003ctd class=\"w-1/3\"\u003e{mask(t.token)}\u003c/td\u003e\n-            \u003ctd class=\"w-1/3 flex gap-2 justify-end\" align=\"right\"\u003e\n-              \u003cButton class=\"btn btn-primary btn-sm\"\u003e\u003cIcon icon=\"pen\" /\u003e\u003c/Button\u003e\n-              \u003cButton class=\"btn btn-error btn-sm\" onclick={() =\u003e del(t.host)}\u003e\u003cIcon icon=\"trash-bin-2\" /\u003e\u003c/Button\u003e\n-            \u003c/td\u003e\n+    \u003cdiv class=\"w-full\"\u003e\n+      \u003ctable class=\"w-full table-fixed\"\u003e\n+        \u003cthead\u003e\n+          \u003ctr\u003e\n+            \u003cth class=\"p-2 text-left w-1/3\"\u003eHost\u003c/th\u003e\n+            \u003cth class=\"p-2 text-left w-1/3\"\u003eToken\u003c/th\u003e\n+            \u003cth class=\"p-2 text-right w-1/3\"\u003eActions\u003c/th\u003e\n           \u003c/tr\u003e\n-        {/each}\n-      \u003c/tbody\u003e\n-    \u003c/table\u003e\n+        \u003c/thead\u003e\n+        \u003ctbody\u003e\n+          {#each tokens as t}\n+            \u003ctr class=\"hover:bg-neutral\"\u003e\n+              \u003ctd class=\"p-2 text-left\"\u003e{t.host}\u003c/td\u003e\n+              \u003ctd class=\"p-2 text-left\"\u003e{mask(t.token)}\u003c/td\u003e\n+              \u003ctd class=\"p-2 text-right\"\u003e\n+                \u003cdiv class=\"flex gap-2 justify-end\"\u003e\n+                  \u003cButton class=\"btn btn-primary btn-sm\"\u003e\u003cIcon icon=\"pen\" /\u003e\u003c/Button\u003e\n+                  \u003cButton class=\"btn btn-error btn-sm\" onclick={() =\u003e del(t.host)}\n+                    \u003e\u003cIcon icon=\"trash-bin-2\" /\u003e\u003c/Button\u003e\n+                \u003c/div\u003e\n+              \u003c/td\u003e\n+            \u003c/tr\u003e\n+          {/each}\n+        \u003c/tbody\u003e\n+      \u003c/table\u003e\n     \u003c/div\u003e\n   {:else}\n     \u003cp class=\"py-12 text-center opacity-75\"\u003eNo tokens saved yet!\u003c/p\u003e\ndiff --git a/src/app/components/GitAuthAdd.svelte b/src/app/components/GitAuthAdd.svelte\nindex d95cbdb..c89c3ed 100644\n--- a/src/app/components/GitAuthAdd.svelte\n+++ b/src/app/components/GitAuthAdd.svelte\n@@ -1,5 +1,4 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {onMount} from \"svelte\"\n   import {preventDefault} from \"@lib/html\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n@@ -10,32 +9,21 @@\n   import Field from \"@src/lib/components/Field.svelte\"\n   import {GithubIcon} from \"@lucide/svelte\"\n   import {pushToast} from \"@app/toast\"\n-  import {toast} from \"@nostr-git/ui\"\n+  import {toast, tokens as tokensStore} from \"@nostr-git/ui\"\n+  import {signer, pubkey} from \"@welshman/app\"\n \n   type Props = {\n     tokenKey: string\n   }\n \n-  let {tokenKey}: Props = $props()\n+  const {tokenKey}: Props = $props()\n \n-  const back = () =\u003e history.back()\n+  const key = tokenKey\n \n+  const back = () =\u003e history.back()\n+  //ghp_REDACTED_TOKEN\n   const disabled = $state(true)\n \n-  type TokenEntry = {host: string; token: string}\n-\n-  function loadTokens(): TokenEntry[] {\n-    try {\n-      return JSON.parse(localStorage.getItem(tokenKey) ?? \"[]\")\n-    } catch {\n-      return []\n-    }\n-  }\n-  function saveTokens(toks: TokenEntry[]) {\n-    localStorage.setItem(tokenKey, JSON.stringify(toks))\n-  }\n-\n-  let tokens: TokenEntry[] = $state([])\n   let host = $state(\"\")\n   let token = $state(\"\")\n   let busy = $state(false)\n@@ -43,27 +31,44 @@\n   let verificationUri = $state(\"\")\n   let error = $state(\"\")\n \n-  onMount(() =\u003e (tokens = loadTokens()))\n+  let tokens: TokenEntry[] = $state([])\n \n-  function saveManual() {\n-    if (!host.trim() || !token.trim()) return\n-    tokens = [\n-      ...tokens.filter(t =\u003e t.host !== host.trim()),\n-      {host: host.trim(), token: token.trim()},\n-    ]\n-    saveTokens(tokens)\n-    reset()\n+  interface TokenEntry {\n+    host: string\n+    token: string\n   }\n \n-\n   function reset() {\n     host = token = verificationUri = userCode = \"\"\n     busy = false\n     error = \"\"\n   }\n \n+  async function saveTokens(toks: TokenEntry[]) {\n+    try {\n+      const existing = localStorage.getItem(key)\n+      if (existing) {\n+        const decrypted = await $signer.nip04.decrypt($pubkey!, existing)\n+        if (!decrypted) return\n+        const parsed = JSON.parse(decrypted)\n+        tokens = [...parsed, ...toks]\n+      } else {\n+        tokens = toks\n+      }\n+\n+      const encrypted = await $signer.nip04.encrypt($pubkey!, JSON.stringify(tokens))\n+      console.log(key)\n+      tokensStore.push(toks[0])\n+      localStorage.setItem(key, encrypted)\n+    } catch (e) {\n+      error = \"Failed to save tokens: \" + e\n+      console.error(\"Failed to save tokens\", e)\n+    }\n+  }\n+\n   const submit = () =\u003e {\n-    saveManual()\n+    saveTokens([...tokens, {host: host.trim(), token: token.trim()}])\n+    reset()\n     back()\n   }\n \n@@ -78,7 +83,7 @@\n       toast.clear()\n     }\n   })\n-  \n+\n   $effect(() =\u003e {\n     if (error) {\n       pushToast({\n@@ -87,9 +92,6 @@\n       })\n     }\n   })\n-\n-\n-\n \u003c/script\u003e\n \n \u003cform class=\"column gap-4\" onsubmit={preventDefault(submit)}\u003e\n@@ -106,7 +108,7 @@\n     \u003cp\u003eDevice flow\u003c/p\u003e\n   \u003c/Divider\u003e\n \n-  \u003cButton class=\"btn btn-primary\" disabled={disabled}\u003e\n+  \u003cButton class=\"btn btn-primary\" {disabled}\u003e\n     \u003cGithubIcon /\u003e\n     Device flow\n   \u003c/Button\u003e\n@@ -147,7 +149,7 @@\n       Go back\n     \u003c/Button\u003e\n     \u003cButton type=\"submit\" class=\"btn btn-primary\" disabled={busy}\u003e\n-      \u003cSpinner loading={busy}\u003eConfirm\u003c/Spinner\u003e\n+      \u003cSpinner loading={busy}\u003eAdd\u003c/Spinner\u003e\n       \u003cIcon icon=\"alt-arrow-right\" /\u003e\n     \u003c/Button\u003e\n   \u003c/ModalFooter\u003e\ndiff --git a/src/app/components/ProfileDetail.svelte b/src/app/components/ProfileDetail.svelte\nindex 204e71a..22e1d02 100644\n--- a/src/app/components/ProfileDetail.svelte\n+++ b/src/app/components/ProfileDetail.svelte\n@@ -11,7 +11,7 @@\n   import ChatEnable from \"@app/components/ChatEnable.svelte\"\n   import {canDecrypt, pubkeyLink} from \"@app/state\"\n   import {pushModal} from \"@app/modal\"\n-  import {makeChatPath} from \"@app/routes\"\n+  import {makeChatPath, makeGitRepoPath} from \"@app/routes\"\n \n   export type Props = {\n     pubkey: string\n@@ -39,8 +39,12 @@\n     \u003cdiv class=\"flex gap-2\"\u003e\n       \u003cLink external href={pubkeyLink(pubkey)} class=\"btn btn-neutral\"\u003e\n         \u003cAvatar src=\"/coracle.png\" /\u003e\n-        Open in Coracle\n+        Profile\n       \u003c/Link\u003e\n+      \u003cButton onclick={() =\u003e goto(makeGitRepoPath(pubkey))} class=\"btn btn-neutral\"\u003e\n+        \u003cIcon icon=\"git\" /\u003e\n+        Git Repos\n+      \u003c/Button\u003e\n       \u003cButton onclick={openChat} class=\"btn btn-primary\"\u003e\n         \u003cIcon icon=\"letter\" /\u003e\n         Open Chat\ndiff --git a/src/app/routes.ts b/src/app/routes.ts\nindex 2bc6911..1123a21 100644\n--- a/src/app/routes.ts\n+++ b/src/app/routes.ts\n@@ -49,6 +49,9 @@ export const makeJobPath = (url: string, eventId?: string) =\u003e\n export const makeGitPath = (url: string, eventId?: string) =\u003e\n   makeSpacePath(url, \"git\", eventId)\n \n+export const makeGitRepoPath = (url: string, eventId?: string) =\u003e\n+  makeSpacePath(url, \"git\", \"repos\", eventId)\n+\n export const getPrimaryNavItem = ($page: Page) =\u003e $page.route?.id?.split(\"/\")[1]\n \n export const getPrimaryNavItemIndex = ($page: Page) =\u003e {\ndiff --git a/src/routes/+layout.svelte b/src/routes/+layout.svelte\nindex 27cfb5e..b8c5cd7 100644\n--- a/src/routes/+layout.svelte\n+++ b/src/routes/+layout.svelte\n@@ -69,6 +69,8 @@\n   import * as notifications from \"@app/notifications\"\n   import * as appState from \"@app/state\"\n \n+  import {signer as gitSigner} from \"@nostr-git/ui\"\n+\n   // Migration: old nostrtalk instance used different sessions\n   if ($session \u0026\u0026 !$signer) {\n     dropSession($session.pubkey)\n@@ -220,6 +222,8 @@\n         await loadUserData($pubkey)\n       }\n \n+      gitSigner.set($signer)\n+\n       // Listen for space data, populate space-based notifications\n       let unsubSpaces: any\n \ndiff --git a/src/routes/settings/profile/+page.svelte b/src/routes/settings/profile/+page.svelte\nindex c70b1aa..2e872dd 100644\n--- a/src/routes/settings/profile/+page.svelte\n+++ b/src/routes/settings/profile/+page.svelte\n@@ -133,8 +133,10 @@\n     {/if}\n   \u003c/div\u003e\n \n-  \u003cGitAuth clientId={GIT_CLIENT_ID} tokenKey=\"gh_tokens\" /\u003e\n+  \u003cGitAuth tokenKey=\"gh_tokens\" /\u003e\n+\n   \u003cAlerts /\u003e\n+\n   \u003cdiv class=\"card2 bg-alt shadow-xl\"\u003e\n     \u003cdiv class=\"flex items-center justify-between\"\u003e\n       \u003cstrong class=\"flex items-center gap-3\"\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex c92efa8..d71ed89 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -11,6 +11,8 @@\n   import Input from \"@lib/components/Field.svelte\"\n   import Dialog from \"@lib/components/Dialog.svelte\"\n   import {pushToast} from \"@src/app/toast\"\n+  import EventActions from \"@src/app/components/EventActions.svelte\"\n+  import ReactionSummary from \"@src/app/components/ReactionSummary.svelte\"\n \n   const {id, relay} = $page.params\n \n@@ -24,9 +26,11 @@\n   $effect(() =\u003e {\n     if ($toast.length \u003e 0) {\n       $toast.forEach(t =\u003e {\n+        // The toast store now handles format conversion internally\n         pushToast({\n-          message: t.description!,\n-          theme: t.variant === \"error\" ? \"error\" : undefined,\n+          message: t.message || (t.title \u0026\u0026 t.description ? `${t.title}: ${t.description}` : t.title || t.description || ''),\n+          timeout: t.timeout || t.duration,\n+          theme: t.theme || (t.variant === 'destructive' ? 'error' : undefined),\n         })\n       })\n       toast.clear()\n@@ -107,6 +111,8 @@\n           Alert: Dialog as typeof import(\"@nostr-git/ui\").Alert,\n           ProfileComponent: Profile as typeof import(\"@nostr-git/ui\").Profile,\n           ProfileLink: ProfileLink as typeof import(\"@nostr-git/ui\").ProfileLink,\n+          EventActions: EventActions as typeof import(\"@nostr-git/ui\").EventActions,\n+          ReactionSummary: ReactionSummary as typeof import(\"@nostr-git/ui\").ReactionSummary,\n       }}\u003e\n       {@render children()}\n     \u003c/ConfigProvider\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 1957852..544c2ce 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -1,6 +1,15 @@\n \u003cscript lang=\"ts\"\u003e\n   import {Button, PatchCard} from \"@nostr-git/ui\"\n-  import {CalendarDays, Check, Clock, Eye, GitCommit, SearchX, User, X} from \"@lucide/svelte\"\n+  import {\n+    CalendarDays,\n+    Check,\n+    Clock,\n+    Eye,\n+    GitCommit,\n+    SearchX,\n+    User,\n+    X,\n+  } from \"@lucide/svelte\"\n   import {createSearch, pubkey} from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {makeFeed} from \"@src/app/requests\"\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex fa75f47..9a0bc63 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -4,12 +4,16 @@\n     Check,\n     ChevronLeft,\n     ChevronRight,\n+    Copy,\n+    FileCode,\n     GitCommit,\n     GitMerge,\n     MessageSquare,\n+    Shield,\n+    User,\n     X,\n   } from \"@lucide/svelte\"\n-  import {Button, Profile} from \"@nostr-git/ui\"\n+  import {Button, Profile, MergeStatus, toast} from \"@nostr-git/ui\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import {DiffViewer, IssueThread} from \"@nostr-git/ui\"\n   import {pubkey, repository} from \"@welshman/app\"\n@@ -34,7 +38,8 @@\n     type PatchEvent,\n   } from \"@nostr-git/shared-types\"\n   import {postComment} from \"@src/app/commands.js\"\n-  import {parseGitPatchFromEvent} from \"@nostr-git/core\"\n+  import {parseGitPatchFromEvent, analyzePatchMerge} from \"@nostr-git/core\"\n+  import type {MergeAnalysisResult} from \"@nostr-git/core\"\n   import {sortBy} from \"@welshman/lib\"\n   import {derived as _derived} from \"svelte/store\"\n   import type {LayoutProps} from \"../../$types\"\n@@ -96,6 +101,53 @@\n     .map(p =\u003e parseGitPatchFromEvent(p))\n \n   let selectedPatch = $state(patch)\n+  let mergeAnalysisResult: MergeAnalysisResult | null = $state(null)\n+  let isAnalyzingMerge = $state(false)\n+\n+  async function analyzeMerge() {\n+    if (!selectedPatch || !repoClass.repoEvent) return\n+\n+    isAnalyzingMerge = true\n+    mergeAnalysisResult = null\n+\n+    try {\n+      const result = await analyzePatchMerge(\n+        repoClass.repoEvent.id,\n+        selectedPatch,\n+        selectedPatch.baseBranch || repoClass.mainBranch.split(\"/\").pop()!,\n+      )\n+      mergeAnalysisResult = result\n+    } catch (error) {\n+      console.error(\"Failed to analyze merge:\", error)\n+      const errorMessage = error instanceof Error ? error.message : \"Unknown error\"\n+\n+      toast.push({\n+        message: `Merge Analysis Failed: Unable to analyze merge status: ${errorMessage}`,\n+        timeout: 5000,\n+        theme: \"error\",\n+      })\n+\n+      mergeAnalysisResult = {\n+        canMerge: false,\n+        hasConflicts: false,\n+        conflictFiles: [],\n+        conflictDetails: [],\n+        upToDate: false,\n+        fastForward: false,\n+        patchCommits: [],\n+        analysis: \"error\",\n+        errorMessage,\n+      }\n+    } finally {\n+      isAnalyzingMerge = false\n+    }\n+  }\n+\n+  $effect(() =\u003e {\n+    if (selectedPatch) {\n+      analyzeMerge()\n+    }\n+  })\n \n   const threadComments = $derived.by(() =\u003e {\n     if (repoClass.patches \u0026\u0026 selectedPatch) {\n@@ -108,12 +160,7 @@\n   })\n \n   const getStatusFilter = () =\u003e ({\n-    kinds: [\n-      GIT_STATUS_OPEN,\n-      GIT_STATUS_COMPLETE,\n-      GIT_STATUS_CLOSED,\n-      GIT_STATUS_DRAFT,\n-    ],\n+    kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n     \"#e\": [selectedPatch?.id ?? \"\"],\n   })\n \n@@ -138,8 +185,48 @@\n     typographer: true,\n   })\n \n-  const applyPatch = () =\u003e {\n+  const applyPatch = () =\u003e {}\n+\n+  // Copy to clipboard function\n+  const copyToClipboard = async (text: string, label: string) =\u003e {\n+    try {\n+      await navigator.clipboard.writeText(text)\n+      toast.push({\n+        message: `${label} copied to clipboard`,\n+        timeout: 2000\n+      })\n+    } catch (error) {\n+      console.error('Failed to copy to clipboard:', error)\n+      toast.push({\n+        message: `Failed to copy ${label}`,\n+        timeout: 3000,\n+        theme: 'error'\n+      })\n+    }\n+  }\n+\n+  // Enhanced timestamp formatting\n+  const formatTimestamp = (timestamp: string | number) =\u003e {\n+    const date = new Date(typeof timestamp === 'string' ? timestamp : timestamp * 1000)\n+    const now = new Date()\n+    const diffMs = now.getTime() - date.getTime()\n+    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))\n     \n+    if (diffDays === 0) {\n+      return `today at ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`\n+    } else if (diffDays === 1) {\n+      return `yesterday at ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`\n+    } else if (diffDays \u003c 7) {\n+      return `${diffDays} days ago`\n+    } else {\n+      return date.toLocaleDateString([], { \n+        year: 'numeric', \n+        month: 'short', \n+        day: 'numeric',\n+        hour: '2-digit',\n+        minute: '2-digit'\n+      })\n+    }\n   }\n \u003c/script\u003e\n \n@@ -184,7 +271,7 @@\n                 \u003c/div\u003e\n                 \u003cspan class=\"text-sm text-muted-foreground\"\u003e\n                   \u003cProfileLink pubkey={patch?.author.pubkey} /\u003e\n-                  opened this patch • {new Date(patch?.createdAt).toLocaleString()}\n+                  opened this patch • {formatTimestamp(patch?.createdAt || '')}\n                 \u003c/span\u003e\n               \u003c/div\u003e\n             \u003c/div\u003e\n@@ -197,6 +284,216 @@\n           \u003cp class=\"text-muted-foreground\"\u003e{@html md.render(patch?.description || \"\")}\u003c/p\u003e\n         \u003c/div\u003e\n \n+        \u003c!-- Technical Metadata --\u003e\n+        \u003cdiv class=\"mb-6 p-4 bg-muted/30 rounded-lg border\"\u003e\n+          \u003ch3 class=\"text-sm font-medium mb-3 flex items-center gap-2\"\u003e\n+            \u003cGitCommit class=\"h-4 w-4\" /\u003e\n+            Technical Details\n+          \u003c/h3\u003e\n+          \n+          \u003cdiv class=\"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm\"\u003e\n+            \u003c!-- Commit Hash --\u003e\n+            {#if selectedPatch?.commitHash}\n+              \u003cdiv class=\"flex items-center justify-between\"\u003e\n+                \u003cspan class=\"text-muted-foreground\"\u003eCommit:\u003c/span\u003e\n+                \u003cdiv class=\"flex items-center gap-2\"\u003e\n+                  \u003ccode class=\"bg-background px-2 py-1 rounded text-xs font-mono\"\u003e\n+                    {selectedPatch.commitHash.substring(0, 8)}\n+                  \u003c/code\u003e\n+                  \u003cButton\n+                    variant=\"ghost\"\n+                    size=\"icon\"\n+                    class=\"h-6 w-6\"\n+                    onclick={() =\u003e copyToClipboard(selectedPatch?.commitHash || '', 'Commit hash')}\n+                  \u003e\n+                    \u003cCopy class=\"h-3 w-3\" /\u003e\n+                  \u003c/Button\u003e\n+                \u003c/div\u003e\n+              \u003c/div\u003e\n+            {/if}\n+\n+            \u003c!-- Author vs Committer --\u003e\n+            {#if selectedPatch?.raw?.tags}\n+              {@const committerTag = selectedPatch.raw.tags.find(t =\u003e t[0] === 'committer')}\n+              {#if committerTag \u0026\u0026 committerTag[1] !== selectedPatch?.author.name}\n+                \u003cdiv class=\"flex items-center justify-between\"\u003e\n+                  \u003cspan class=\"text-muted-foreground\"\u003eCommitter:\u003c/span\u003e\n+                  \u003cdiv class=\"flex items-center gap-2\"\u003e\n+                    \u003cUser class=\"h-3 w-3\" /\u003e\n+                    \u003cspan class=\"text-xs\"\u003e{committerTag[1]}\u003c/span\u003e\n+                  \u003c/div\u003e\n+                \u003c/div\u003e\n+              {/if}\n+              {#if committerTag \u0026\u0026 committerTag[3]}\n+                \u003cdiv class=\"flex items-center justify-between\"\u003e\n+                  \u003cspan class=\"text-muted-foreground\"\u003eCommitted:\u003c/span\u003e\n+                  \u003cspan class=\"text-xs\"\u003e{formatTimestamp(committerTag[3])}\u003c/span\u003e\n+                \u003c/div\u003e\n+              {/if}\n+            {/if}\n+\n+            \u003c!-- PGP Signature --\u003e\n+            {#if selectedPatch?.raw?.tags?.find(t =\u003e t[0] === 'commit-pgp-sig')}\n+              \u003cdiv class=\"flex items-center justify-between\"\u003e\n+                \u003cspan class=\"text-muted-foreground\"\u003eSigned:\u003c/span\u003e\n+                \u003cdiv class=\"flex items-center gap-2 text-green-600\"\u003e\n+                  \u003cShield class=\"h-3 w-3\" /\u003e\n+                  \u003cspan class=\"text-xs\"\u003ePGP Verified\u003c/span\u003e\n+                \u003c/div\u003e\n+              \u003c/div\u003e\n+            {/if}\n+\n+            \u003c!-- Base Branch --\u003e\n+            \u003cdiv class=\"flex items-center justify-between\"\u003e\n+              \u003cspan class=\"text-muted-foreground\"\u003eTarget Branch:\u003c/span\u003e\n+              \u003ccode class=\"bg-background px-2 py-1 rounded text-xs\"\u003e\n+                {selectedPatch?.baseBranch || 'main'}\n+              \u003c/code\u003e\n+            \u003c/div\u003e\n+\n+            \u003c!-- Commit Count --\u003e\n+            \u003cdiv class=\"flex items-center justify-between\"\u003e\n+              \u003cspan class=\"text-muted-foreground\"\u003eCommits:\u003c/span\u003e\n+              \u003cspan class=\"text-xs font-medium\"\u003e{selectedPatch?.commitCount || 1}\u003c/span\u003e\n+            \u003c/div\u003e\n+\n+            \u003c!-- Recipients/Reviewers --\u003e\n+            {#if selectedPatch?.raw?.tags \u0026\u0026 selectedPatch.raw.tags.filter(t =\u003e t[0] === 'p').length \u003e 0}\n+              {@const recipients = selectedPatch.raw.tags.filter(t =\u003e t[0] === 'p')}\n+              \u003cdiv class=\"col-span-full\"\u003e\n+                \u003cdiv class=\"flex items-start justify-between\"\u003e\n+                  \u003cspan class=\"text-muted-foreground\"\u003eReviewers:\u003c/span\u003e\n+                  \u003cdiv class=\"flex flex-wrap gap-1 max-w-xs\"\u003e\n+                    {#each recipients.slice(0, 3) as recipient}\n+                      \u003cProfileLink pubkey={recipient[1]} /\u003e\n+                    {/each}\n+                    {#if recipients.length \u003e 3}\n+                      \u003cspan class=\"text-xs text-muted-foreground\"\u003e+{recipients.length - 3} more\u003c/span\u003e\n+                    {/if}\n+                  \u003c/div\u003e\n+                \u003c/div\u003e\n+              \u003c/div\u003e\n+            {/if}\n+          \u003c/div\u003e\n+        \u003c/div\u003e\n+\n+        \u003c!-- Individual Commit Timeline --\u003e\n+        {#if selectedPatch?.commits \u0026\u0026 selectedPatch.commits.length \u003e 1}\n+          \u003cdiv class=\"mb-6\"\u003e\n+            \u003cdiv class=\"flex items-center justify-between mb-4\"\u003e\n+              \u003ch3 class=\"text-lg font-medium flex items-center gap-2\"\u003e\n+                \u003cGitCommit class=\"h-5 w-5\" /\u003e\n+                Commit Timeline ({selectedPatch.commits.length} commits)\n+              \u003c/h3\u003e\n+            \u003c/div\u003e\n+            \n+            \u003cdiv class=\"space-y-3\"\u003e\n+              {#each selectedPatch.commits.slice(0, 5) as commitHash, index}\n+                {@const commitTag = selectedPatch?.raw?.tags?.find(t =\u003e t[0] === 'commit' \u0026\u0026 t[1] === commitHash)}\n+                \u003cdiv class=\"flex items-start gap-3 p-3 bg-muted/20 rounded-lg border\"\u003e\n+                  \u003cdiv class=\"flex-shrink-0 mt-1\"\u003e\n+                    \u003cdiv class=\"w-2 h-2 bg-primary rounded-full\"\u003e\u003c/div\u003e\n+                  \u003c/div\u003e\n+                  \n+                  \u003cdiv class=\"flex-1 min-w-0\"\u003e\n+                    \u003cdiv class=\"flex items-center gap-2 mb-1\"\u003e\n+                      \u003ccode class=\"bg-background px-2 py-1 rounded text-xs font-mono\"\u003e\n+                        {commitHash.substring(0, 8)}\n+                      \u003c/code\u003e\n+                      \u003cButton\n+                        variant=\"ghost\"\n+                        size=\"icon\"\n+                        class=\"h-5 w-5\"\n+                        onclick={() =\u003e copyToClipboard(commitHash, 'Commit hash')}\n+                      \u003e\n+                        \u003cCopy class=\"h-3 w-3\" /\u003e\n+                      \u003c/Button\u003e\n+                      \u003cspan class=\"text-xs text-muted-foreground\"\u003e\n+                        #{selectedPatch.commits.length - index}\n+                      \u003c/span\u003e\n+                    \u003c/div\u003e\n+                    \n+                    \u003c!-- Commit message would go here if available in tags --\u003e\n+                    \u003cp class=\"text-sm text-muted-foreground\"\u003e\n+                      Commit {index + 1} of {selectedPatch.commits.length}\n+                    \u003c/p\u003e\n+                    \n+                    \u003c!-- Author and timestamp if available --\u003e\n+                    {#if commitTag \u0026\u0026 commitTag.length \u003e 2}\n+                      \u003cdiv class=\"flex items-center gap-4 mt-2 text-xs text-muted-foreground\"\u003e\n+                        {#if commitTag[2]}\n+                          \u003cdiv class=\"flex items-center gap-1\"\u003e\n+                            \u003cUser class=\"h-3 w-3\" /\u003e\n+                            \u003cspan\u003e{commitTag[2]}\u003c/span\u003e\n+                          \u003c/div\u003e\n+                        {/if}\n+                        {#if commitTag[3]}\n+                          \u003cspan\u003e{formatTimestamp(commitTag[3])}\u003c/span\u003e\n+                        {/if}\n+                      \u003c/div\u003e\n+                    {/if}\n+                  \u003c/div\u003e\n+                \u003c/div\u003e\n+              {/each}\n+              \n+              {#if selectedPatch.commits.length \u003e 5}\n+                \u003cdiv class=\"text-center\"\u003e\n+                  \u003cButton variant=\"outline\" size=\"sm\"\u003e\n+                    Show {selectedPatch.commits.length - 5} more commits\n+                  \u003c/Button\u003e\n+                \u003c/div\u003e\n+              {/if}\n+            \u003c/div\u003e\n+          \u003c/div\u003e\n+        {/if}\n+\n+        \u003c!-- File Statistics --\u003e\n+        {#if selectedPatch?.diff \u0026\u0026 selectedPatch.diff.length \u003e 0}\n+          \u003cdiv class=\"mb-6\"\u003e\n+            \u003cdiv class=\"flex items-center justify-between mb-4\"\u003e\n+              \u003ch3 class=\"text-lg font-medium flex items-center gap-2\"\u003e\n+                \u003cFileCode class=\"h-5 w-5\" /\u003e\n+                File Changes\n+              \u003c/h3\u003e\n+            \u003c/div\u003e\n+            \n+            {#if selectedPatch.diff}\n+              {@const stats = selectedPatch.diff.reduce((acc, file) =\u003e {\n+                // This is a simplified calculation - real implementation would parse the diff\n+                const content = file.content || ''\n+                const added = (content.match(/^\\+/gm) || []).length\n+                const removed = (content.match(/^-/gm) || []).length\n+                return { added: acc.added + added, removed: acc.removed + removed }\n+              }, { added: 0, removed: 0 })}\n+              \n+              \u003cdiv class=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4\"\u003e\n+                \u003cdiv class=\"bg-muted/20 p-3 rounded-lg border text-center\"\u003e\n+                  \u003cdiv class=\"text-2xl font-bold text-primary\"\u003e{selectedPatch.diff.length}\u003c/div\u003e\n+                  \u003cdiv class=\"text-sm text-muted-foreground\"\u003eFiles Changed\u003c/div\u003e\n+                \u003c/div\u003e\n+                \n+                \u003cdiv class=\"bg-green-50 dark:bg-green-950/20 p-3 rounded-lg border text-center\"\u003e\n+                  \u003cdiv class=\"text-2xl font-bold text-green-600\"\u003e+{stats.added}\u003c/div\u003e\n+                  \u003cdiv class=\"text-sm text-muted-foreground\"\u003eLines Added\u003c/div\u003e\n+                \u003c/div\u003e\n+                \n+                \u003cdiv class=\"bg-red-50 dark:bg-red-950/20 p-3 rounded-lg border text-center\"\u003e\n+                  \u003cdiv class=\"text-2xl font-bold text-red-600\"\u003e-{stats.removed}\u003c/div\u003e\n+                  \u003cdiv class=\"text-sm text-muted-foreground\"\u003eLines Removed\u003c/div\u003e\n+                \u003c/div\u003e\n+              \u003c/div\u003e\n+            {/if}\n+          \u003c/div\u003e\n+        {/if}\n+\n+        \u003c!-- Merge Status Analysis --\u003e\n+        \u003cdiv class=\"mb-6\"\u003e\n+          \u003cMergeStatus\n+            result={mergeAnalysisResult}\n+            loading={isAnalyzingMerge}\n+            targetBranch={selectedPatch?.baseBranch || \"main\"} /\u003e\n+        \u003c/div\u003e\n+\n         \u003cdiv class=\"git-separator\"\u003e\u003c/div\u003e\n \n         \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n@@ -278,13 +575,13 @@\n             \u003c/div\u003e\n           {/key}\n         \u003c/div\u003e\n-\n-        \u003cdiv class=\"flex justify-end\"\u003e\n-          \u003cButton onclick={applyPatch} variant=\"default\"\u003e\n-            \u003cGitMerge class=\"h-4 w-4\" /\u003e Apply\n-          \u003c/Button\u003e\n-        \u003c/div\u003e\n-\n+        {#if repoClass.maintainers.includes($pubkey!)}\n+          \u003cdiv class=\"flex justify-end\"\u003e\n+            \u003cButton onclick={applyPatch} variant=\"default\"\u003e\n+              \u003cGitMerge class=\"h-4 w-4\" /\u003e Apply\n+            \u003c/Button\u003e\n+          \u003c/div\u003e\n+        {/if}\n         \u003cdiv class=\"git-separator my-6\"\u003e\u003c/div\u003e\n \n         \u003cdiv class=\"space-y-4\"\u003e\ndiff --git a/src/routes/spaces/[relay]/git/repos/+page.svelte b/src/routes/spaces/[relay]/git/repos/+page.svelte\nnew file mode 100644\nindex 0000000..a4a0dfe\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/repos/+page.svelte\n@@ -0,0 +1,102 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {page} from \"$app/stores\"\n+  import {\n+    Address,\n+    getTagValue,\n+    type Filter,\n+  } from \"@welshman/util\"\n+  import {GIT_REPO} from \"@src/lib/util\"\n+  import {repository, tracker} from \"@welshman/app\"\n+  import {fly} from \"@lib/transition\"\n+  import Icon from \"@lib/components/Icon.svelte\"\n+  import PageBar from \"@lib/components/PageBar.svelte\"\n+  import Spinner from \"@lib/components/Spinner.svelte\"\n+  import GitItem from \"@app/components/GitItem.svelte\"\n+  import {decodeRelay} from \"@app/state\"\n+  import {load} from \"@welshman/net\"\n+  import {Router} from \"@welshman/router\"\n+  import PageContent from \"@src/lib/components/PageContent.svelte\"\n+  import {deriveEvents} from \"@welshman/store\"\n+  import {derived as _derived} from \"svelte/store\"\n+  import {onMount} from \"svelte\"\n+\n+  const url = decodeRelay($page.params.relay)\n+\n+  let loading = $state(true)\n+\n+  const filters: Filter[] = [{kinds: [GIT_REPO]}]\n+  const repoEvents = deriveEvents(repository, {filters})\n+\n+  const repos = $derived.by(() =\u003e {\n+    const elements = []\n+\n+    for (const event of $repoEvents.toReversed()) {\n+      const address = Address.fromEvent(event)\n+      const addressStr = address.toString()\n+      // Need to keep selected and unselected repos as distinct sets\n+      const relayHints = tracker.getRelays(event.id)\n+      const repoEventRelayHint = getTagValue(\"relays\", event.tags)\n+\n+      const relaysFromRepoPubkey = Router.get().getRelaysForPubkey(event.pubkey)?.[0] ?? \"\"\n+\n+      const firstHint =\n+        relayHints.values().next().value ?? repoEventRelayHint ?? relaysFromRepoPubkey\n+\n+      elements.push({\n+        repo: event,\n+        relay: firstHint,\n+        address: addressStr,\n+        selected: false,\n+      })\n+    }\n+\n+    return elements\n+  })\n+\n+  $effect(() =\u003e {\n+    if (repos.length \u003e 0) {\n+      loading = false\n+    }\n+  })\n+\n+  onMount(() =\u003e {\n+    const relays = [url, ...Router.get().FromUser().getUrls()]\n+    load({\n+      relays,\n+      filters,\n+    })\n+  })\n+\u003c/script\u003e\n+\n+\u003cPageBar\u003e\n+  {#snippet icon()}\n+    \u003cdiv class=\"center\"\u003e\n+      \u003cIcon icon=\"git\" /\u003e\n+    \u003c/div\u003e\n+  {/snippet}\n+  {#snippet title()}\n+    \u003cstrong\u003eGit Repos\u003c/strong\u003e\n+  {/snippet}\n+\u003c/PageBar\u003e\n+\n+\u003cPageContent\u003e\n+  \u003cdiv class=\"flex flex-grow flex-col gap-2 overflow-auto p-2\"\u003e\n+    {#if loading}\n+      \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n+        \u003cSpinner {loading}\u003e\n+          {#if loading}\n+            Looking for Git Repos...\n+          {:else if !repos || repos.length === 0}\n+            No Git Repos found.\n+          {/if}\n+        \u003c/Spinner\u003e\n+      \u003c/p\u003e\n+    {:else}\n+      {#each repos! as repo (repo.repo.id)}\n+        \u003cdiv in:fly\u003e\n+          \u003cGitItem {url} event={repo.repo} showActivity={false} showIssues={false} showActions={true}/\u003e\n+        \u003c/div\u003e\n+      {/each}\n+    {/if}\n+  \u003c/div\u003e\n+\u003c/PageContent\u003e\ndiff --git a/src/routes/spaces/[relay]/git/repos/[id]/+page.svelte b/src/routes/spaces/[relay]/git/repos/[id]/+page.svelte\nnew file mode 100644\nindex 0000000..a6a772d\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/repos/[id]/+page.svelte\n@@ -0,0 +1,107 @@\n+\u003cscript lang=\"ts\"\u003e\n+    import {page} from \"$app/stores\"\n+    import {\n+      Address,\n+      getTagValue,\n+      type Filter,\n+    } from \"@welshman/util\"\n+    import {GIT_REPO} from \"@src/lib/util\"\n+    import {repository, tracker} from \"@welshman/app\"\n+    import {fly} from \"@lib/transition\"\n+    import Icon from \"@lib/components/Icon.svelte\"\n+    import PageBar from \"@lib/components/PageBar.svelte\"\n+    import Spinner from \"@lib/components/Spinner.svelte\"\n+    import GitItem from \"@app/components/GitItem.svelte\"\n+    import {decodeRelay} from \"@app/state\"\n+    import {load} from \"@welshman/net\"\n+    import {Router} from \"@welshman/router\"\n+    import PageContent from \"@src/lib/components/PageContent.svelte\"\n+    import {deriveEvents} from \"@welshman/store\"\n+    import {derived as _derived} from \"svelte/store\"\n+    import {onMount} from \"svelte\"\n+  \n+    const url = decodeRelay($page.params.relay)\n+    const id = $page.params.id\n+\n+    let loading = $state(true)\n+  \n+    const filters: Filter[] = [{\n+        kinds: [GIT_REPO],\n+        authors: [id]\n+    }]\n+    const repoEvents = deriveEvents(repository, {filters})\n+  \n+    const repos = $derived.by(() =\u003e {\n+      const elements = []\n+  \n+      for (const event of $repoEvents.toReversed()) {\n+        const address = Address.fromEvent(event)\n+        const addressStr = address.toString()\n+        // Need to keep selected and unselected repos as distinct sets\n+        const relayHints = tracker.getRelays(event.id)\n+        const repoEventRelayHint = getTagValue(\"relays\", event.tags)\n+  \n+        const relaysFromRepoPubkey = Router.get().getRelaysForPubkey(event.pubkey)?.[0] ?? \"\"\n+  \n+        const firstHint =\n+          relayHints.values().next().value ?? repoEventRelayHint ?? relaysFromRepoPubkey\n+  \n+        elements.push({\n+          repo: event,\n+          relay: firstHint,\n+          address: addressStr,\n+          selected: false,\n+        })\n+      }\n+  \n+      return elements\n+    })\n+  \n+    $effect(() =\u003e {\n+      if (repos.length \u003e 0) {\n+        loading = false\n+      }\n+    })\n+  \n+    onMount(() =\u003e {\n+      const relays = [url, ...Router.get().FromUser().getUrls()]\n+      load({\n+        relays,\n+        filters,\n+      })\n+    })\n+  \u003c/script\u003e\n+  \n+  \u003cPageBar\u003e\n+    {#snippet icon()}\n+      \u003cdiv class=\"center\"\u003e\n+        \u003cIcon icon=\"git\" /\u003e\n+      \u003c/div\u003e\n+    {/snippet}\n+    {#snippet title()}\n+      \u003cstrong\u003eGit Repos\u003c/strong\u003e\n+    {/snippet}\n+  \u003c/PageBar\u003e\n+  \n+  \u003cPageContent\u003e\n+    \u003cdiv class=\"flex flex-grow flex-col gap-2 overflow-auto p-2\"\u003e\n+      {#if loading}\n+        \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n+          \u003cSpinner {loading}\u003e\n+            {#if loading}\n+              Looking for Git Repos...\n+            {:else if !repos || repos.length === 0}\n+              No Git Repos found.\n+            {/if}\n+          \u003c/Spinner\u003e\n+        \u003c/p\u003e\n+      {:else}\n+        {#each repos! as repo (repo.repo.id)}\n+          \u003cdiv in:fly\u003e\n+            \u003cGitItem {url} event={repo.repo} showActivity={false} showIssues={false} showActions={true}/\u003e\n+          \u003c/div\u003e\n+        {/each}\n+      {/if}\n+    \u003c/div\u003e\n+  \u003c/PageContent\u003e\n+  \n\\ No newline at end of file\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-migration-breaking-changes","title":"Identify breaking changes for existing extensions","description":"Identify which existing Budabit extensions break under the Smart Widget model and document the reasons.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T00:21:39.733124-08:00"}
{"id":"flotilla-migration-guidance","title":"Provide adapters or migration guidance","description":"Provide adapters, shims, or documentation to migrate legacy Budabit extensions to Smart Widgets where feasible.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T00:21:39.733124-08:00"}
{"id":"flotilla-mkpn8z8c","title":"From f59e25ea80b6fd953887c3dec4e20f9546073b9f Mon Sep 17 00:00:00 2001","description":"From f59e25ea80b6fd953887c3dec4e20f9546073b9f Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 9 Jun 2025 10:38:50 -0700\nSubject: [PATCH 2/3] feat: add git workbench UI for analyzing merge compatibility between patches and commits\n\n---\n packages/nostr-git                                                      |   2 +-\n src/app/state.ts                                                        |   2 +-\n src/lib/repo.ts                                                         |  81 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |  10 ++++++----\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte              |   9 +++------\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte            |  21 +++++++++++++++++----\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte |   7 +++----\n src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte         | 263 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n 8 files changed, 375 insertions(+), 20 deletions(-)\n create mode 100644 src/lib/repo.ts\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 0ce8d9f..89be359 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 0ce8d9feb98cbee9580cff8d34d0234d6ab47640\n+Subproject commit 89be359b3968d98d5a2d426e5c42601602469cf6\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 9006e8e..5784a61 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -242,7 +242,7 @@ export const deriveNaddrEvent = (naddr: string, hints: string[] = []) =\u003e {\n   let attempted = false\n   const decoded = nip19.decode(naddr).data as AddressPointer\n   const fallbackRelays = [...hints, ...INDEXER_RELAYS]\n-  const relays = decoded.relays?.length \u003e 0 ? decoded.relays : fallbackRelays\n+  const relays = decoded.relays?.length! \u003e 0 ? decoded.relays : fallbackRelays\n   const filters = [{\n     authors: [decoded.pubkey],\n     kinds: [decoded.kind],\ndiff --git a/src/lib/repo.ts b/src/lib/repo.ts\nnew file mode 100644\nindex 0000000..477fe7e\n--- /dev/null\n+++ b/src/lib/repo.ts\n@@ -0,0 +1,81 @@\n+import { derived, get } from 'svelte/store';\n+import { parseRepoAnnouncementEvent, type CommentEvent, type IssueEvent, type RepoAnnouncementEvent } from '@nostr-git/shared-types';\n+import { deriveNaddrEvent } from '@src/app/state';\n+import { deriveEvents } from '@welshman/store';\n+import { publishThunk, repository } from '@welshman/app';\n+import { GIT_ISSUE, GIT_PATCH, type Filter } from '@welshman/util';\n+import { Address } from '@welshman/util';\n+import { GIT_REPO_STATE } from '@src/lib/util';\n+import { nthEq } from '@welshman/lib';\n+\n+\n+export function createRepoModel({ id, relay }: { id: string; relay: string }) {\n+    const repoEvent = deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay]);\n+\n+    const issues = derived(repoEvent, $repoEvent =\u003e {\n+        if (!$repoEvent) return [];\n+        const address = Address.fromEvent($repoEvent).toString();\n+        const issueFilter = [{ kinds: [GIT_ISSUE], \"#a\": [address] }];\n+        return deriveEvents(repository, { filters: issueFilter });\n+    });\n+\n+    const patches = derived(repoEvent, $repoEvent =\u003e {\n+        if (!$repoEvent) return [];\n+        const address = Address.fromEvent($repoEvent).toString();\n+        const patchFilter = [{ kinds: [GIT_PATCH], \"#a\": [address], \"#t\": [\"root\"] }];\n+        return deriveEvents(repository, { filters: patchFilter });\n+    });\n+\n+    const repoState = derived(repoEvent, $repoEvent =\u003e {\n+        if (!$repoEvent) return null;\n+        const repoAnn = parseRepoAnnouncementEvent($repoEvent as RepoAnnouncementEvent);\n+        const address = repoAnn.repoId;\n+        const repoStateFilter: Filter[] = [\n+            { kinds: [GIT_REPO_STATE], \"#d\": [address!] },\n+        ];\n+        return deriveEvents(repository, { filters: repoStateFilter });\n+    });\n+\n+    const relays = derived(repoEvent, $repoEvent =\u003e {\n+        if ($repoEvent) {\n+            const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || [];\n+            return relays;\n+        }\n+    });\n+\n+    function postComment(comment: CommentEvent) {\n+        const currentRelays = get(relays);\n+        if (!currentRelays?.length) {\n+            console.error('No relays available for posting comment');\n+            return Promise.reject('No relays available');\n+        }\n+\n+        return publishThunk({\n+            relays: currentRelays,\n+            event: comment,\n+        });\n+    }\n+\n+    function postIssue(issue: IssueEvent) {\n+        const currentRelays = get(relays);\n+        if (!currentRelays?.length) {\n+            console.error('No relays available for posting issue');\n+            return Promise.reject('No relays available');\n+        }\n+\n+        return publishThunk({\n+            relays: currentRelays,\n+            event: issue,\n+        });\n+    }\n+\n+    return {\n+        repoEvent,\n+        issues,\n+        patches,\n+        repoState,\n+        relays,\n+        postComment,\n+        postIssue,\n+    }\n+}\n\\ No newline at end of file\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex db36f2e..224fa4b 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -19,6 +19,8 @@\n   import {load} from \"@welshman/net\"\n   import {nthEq} from \"@welshman/lib\"\n   import {Buffer} from \"buffer\"\n+  import {nip19} from \"nostr-tools\"\n+  import type {AddressPointer} from \"nostr-tools/nip19\"\n   const {id, relay} = $page.params\n \n   let {children} = $props()\n@@ -27,6 +29,9 @@\n     ;(window as any).Buffer = Buffer\n   }\n \n+  const decoded = nip19.decode(id).data as AddressPointer\n+  const repoId = decoded.identifier\n+\n   let eventStore = $state(deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay]))\n \n   const repoState = $derived.by(() =\u003e {\n@@ -91,14 +96,11 @@\n \n   setContext(\"postIssue\", postIssue)\n \n-  const getProfile = (pubkey: string) =\u003e {\n-    return deriveProfile(pubkey)\n-  }\n-\n   setContext(\"getProfile\", deriveProfile)\n \n   const repo = $state({\n     repo: eventStore,\n+    repoId,\n     state: () =\u003e repoState,\n     issues: () =\u003e issues,\n     patches: () =\u003e patches,\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex e50102a..8a30724 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -16,7 +16,7 @@\n   import Button from \"@src/lib/components/Button.svelte\"\n   import {fly} from \"svelte/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n-    import Spinner from \"@src/lib/components/Spinner.svelte\"\n+  import Spinner from \"@src/lib/components/Spinner.svelte\"\n \n   const {id, relay} = $page.params\n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n@@ -67,7 +67,6 @@\n       loading = false\n     } else {\n       branches = listBranchesFromEvent({repoEvent: $repoEvent})\n-      loading = false\n     }\n   })\n \n@@ -85,8 +84,7 @@\n \u003cdiv class=\"rounded-lg border border-border bg-card\"\u003e\n   \u003cdiv class=\"p-4\"\u003e\n     {#if loading}\n-\n-      \u003cdiv class=\"text-muted-foreground\"\u003eLoading repository files...\u003c/div\u003e\n+      \u003cSpinner {loading}\u003eLoading files...\u003c/Spinner\u003e\n     {:else if error}\n       \u003cdiv class=\"text-red-500\"\u003e{error}\u003c/div\u003e\n     {:else if fallbackToBranches}\n@@ -140,9 +138,8 @@\n       \u003c/div\u003e\n       \u003cdiv class=\"border-t border-border pt-4\"\u003e\n         \u003cdiv class=\"space-y-2\"\u003e\n-          \u003cSpinner loading={loading}\u003eLoading files...\u003c/Spinner\u003e\n           {#await files then files}\n-          {#if files.length === 0}\n+            {#if files.length === 0}\n               \u003cdiv class=\"text-muted-foreground\"\u003eNo files found in this branch.\u003c/div\u003e\n             {:else}\n               {#each files as file}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex 875351d..a553d76 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -3,20 +3,23 @@\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Address, COMMENT, GIT_ISSUE, type TrustedEvent} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n-  import {deriveProfile, relays, repository} from \"@welshman/app\"\n+  import {deriveProfile, publishThunk, repository} from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {makeFeed} from \"@src/app/requests\"\n   import type {Readable} from \"svelte/store\"\n-  import {type RepoStateEvent} from \"@nostr-git/shared-types\"\n+  import {type IssueEvent, type RepoStateEvent} from \"@nostr-git/shared-types\"\n   import {fly} from \"@lib/transition\"\n   import {pushModal} from \"@src/app/modal\"\n   import {load} from \"@welshman/net\"\n   import {deriveEvents} from \"@welshman/store\"\n+  import {page} from \"$app/stores\"\n+  import {decodeRelay} from \"@src/app/state\"\n \n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n   const repo = getContext\u003c{\n     repo: Readable\u003cTrustedEvent\u003e\n+    repoId: string\n     state: () =\u003e Readable\u003cRepoStateEvent\u003e\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n     relays: () =\u003e string[]\n@@ -42,7 +45,7 @@\n \n     const issueFilter = {\n       kinds: [GIT_ISSUE],\n-      \"#a\": [Address.fromEvent($repoEvent).toString()],\n+      \"#a\": [repo.repoId],\n     }\n \n     const {cleanup} = makeFeed({\n@@ -57,10 +60,20 @@\n     })\n   })\n \n+  const url = decodeRelay($page.params.relay)\n+\n+  const postIssue = (issue: IssueEvent) =\u003e {\n+    publishThunk({\n+      relays: [url],\n+      event: issue,\n+    })\n+  }\n+\n   const onNewIssue = () =\u003e {\n     pushModal(NewIssueForm, {\n-      repoId: $repoEvent.id,\n+      repoId: repo.repoId,\n       repoOwnerPubkey: $repoEvent.pubkey,\n+      postIssue,\n     })\n   }\n \u003c/script\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 7489b0f..eb7014c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -11,8 +11,8 @@\n   import markdownit from \"markdown-it\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {load} from \"@welshman/net\"\n-  import {COMMENT, GIT_PATCH} from \"@welshman/util\"\n-    import { nthEq } from \"@welshman/lib\"\n+  import {COMMENT, GIT_PATCH, type Filter} from \"@welshman/util\"\n+  import {nthEq} from \"@welshman/lib\"\n \n   const repo = getContext\u003c{\n     repo: Readable\u003cTrustedEvent\u003e\n@@ -43,8 +43,7 @@\n \n   const threadComments = $derived.by(() =\u003e {\n     if ($patchSet) {\n-      console.log($patchSet)\n-      const filters = [{kinds: [COMMENT], \"#e\": $patchSet.map(patch =\u003e patch.tags.find(nthEq(0, \"e\"))?.[1])}]\n+      const filters: Filter[] = [{kinds: [COMMENT], \"#E\": patch?.id}]\n       load({relays: repo.relays(), filters})\n       return deriveEvents(repository, {filters})\n     }\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\nnew file mode 100644\nindex 0000000..4b12723\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n@@ -0,0 +1,263 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {page} from \"$app/stores\"\n+  import {\n+    GitMerge,\n+    GitPullRequest,\n+    AlertTriangle,\n+    CheckCircle,\n+    XCircle,\n+    Zap,\n+    ArrowRight,\n+    Eye,\n+    Layers,\n+    Target,\n+    GitBranch,\n+  } from \"@lucide/svelte\"\n+  import {Button} from \"@nostr-git/ui\"\n+  import {Card, CardContent, CardHeader, CardTitle} from \"@nostr-git/ui\"\n+  import {Tabs, TabsContent, TabsList, TabsTrigger} from \"@nostr-git/ui\"\n+  import {Badge} from \"@nostr-git/ui\"\n+  import PatchSelector from \"@nostr-git/ui\"\n+  import CommitSelector from \"@nostr-git/ui\"\n+  import MergeAnalyzer from \"@nostr-git/ui\"\n+  import ConflictVisualizer from \"@nostr-git/ui\"\n+  import {getContext} from \"svelte\"\n+  import type {Readable} from \"svelte/store\"\n+  import type {RepoStateEvent} from \"@nostr-git/shared-types\"\n+  import type {TrustedEvent} from \"@welshman/util\"\n+\n+  let {repoId} = $page.params\n+  let selectedPatch = $state\u003cany\u003e(null)\n+  let selectedCommit = $state\u003cany\u003e(null)\n+  let mergeAnalysis = $state\u003cany\u003e(null)\n+  let isAnalyzing = $state(false)\n+\n+  const repo = getContext\u003c{\n+    repo: Readable\u003cTrustedEvent\u003e\n+    state: () =\u003e Readable\u003cRepoStateEvent\u003e\n+    issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+  }\u003e(\"repo\")\n+\n+  // Simulate merge analysis when both patch and commit are selected\n+  $effect(() =\u003e {\n+    if ($selectedPatch \u0026\u0026 $selectedCommit) {\n+      isAnalyzing = true\n+      // Simulate analysis delay\n+      setTimeout(() =\u003e {\n+        mergeAnalysis = {\n+          compatibility: $selectedPatch.id === \"patch-002\" ? \"conflicts\" : \"clean\",\n+          conflictCount: $selectedPatch.id === \"patch-002\" ? 3 : 0,\n+          affectedFiles:\n+            selectedPatch.id === \"patch-002\"\n+              ? [\"src/components/App.tsx\", \"src/styles/main.css\", \"src/auth/login.tsx\"]\n+              : [\"src/auth/oauth.ts\", \"src/types/user.ts\"],\n+          similarity: selectedPatch.id === \"patch-002\" ? 0.65 : 0.92,\n+          autoMergeable: selectedPatch.id !== \"patch-002\",\n+          riskLevel: selectedPatch.id === \"patch-002\" ? \"high\" : \"low\",\n+        }\n+        isAnalyzing = false\n+      }, 1500)\n+    }\n+  })\n+\n+  const getCompatibilityIcon = (compatibility: string) =\u003e {\n+    switch (compatibility) {\n+      case \"clean\":\n+        return {icon: CheckCircle, color: \"text-green-500\"}\n+      case \"conflicts\":\n+        return {icon: AlertTriangle, color: \"text-orange-500\"}\n+      case \"error\":\n+        return {icon: XCircle, color: \"text-red-500\"}\n+      default:\n+        return {icon: Zap, color: \"text-blue-500\"}\n+    }\n+  }\n+\n+  const getCompatibilityColor = (compatibility: string) =\u003e {\n+    switch (compatibility) {\n+      case \"clean\":\n+        return \"border-green-200 bg-green-50\"\n+      case \"conflicts\":\n+        return \"border-orange-200 bg-orange-50\"\n+      case \"error\":\n+        return \"border-red-200 bg-red-50\"\n+      default:\n+        return \"border-blue-200 bg-blue-50\"\n+    }\n+  }\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"container max-w-7xl py-6\"\u003e\n+  \u003cdiv class=\"mt-6\"\u003e\n+    \u003cdiv class=\"mb-6\"\u003e\n+      \u003cdiv class=\"mb-2 flex items-center gap-3\"\u003e\n+        \u003cdiv class=\"rounded-lg bg-gradient-to-br from-purple-500 to-blue-600 p-2\"\u003e\n+          \u003cLayers class=\"h-5 w-5 text-white\" /\u003e\n+        \u003c/div\u003e\n+        \u003cdiv\u003e\n+          \u003ch1 class=\"text-2xl font-bold\"\u003eGit Workbench\u003c/h1\u003e\n+          \u003cp class=\"text-muted-foreground\"\u003e\n+            Compare patches to commits and analyze merge compatibility with advanced visual tools\n+          \u003c/p\u003e\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+\n+    \u003cdiv class=\"mb-6 grid grid-cols-2 gap-6\"\u003e\n+      \u003cPatchSelector selectedPatch={$selectedPatch} onPatchSelect={setSelectedPatch} /\u003e\n+      \u003cCommitSelector selectedCommit={$selectedCommit} onCommitSelect={setSelectedCommit} /\u003e\n+    \u003c/div\u003e\n+\n+    {#if selectedPatch \u0026\u0026 selectedCommit}\n+      \u003cdiv class=\"mb-6 flex justify-center\"\u003e\n+        \u003cdiv class=\"flex items-center gap-4 rounded-lg bg-secondary/30 p-4\"\u003e\n+          \u003cBadge variant=\"outline\" class=\"gap-2\"\u003e\n+            \u003cGitPullRequest class=\"h-3 w-3\" /\u003e\n+            {$selectedPatch.name}\n+          \u003c/Badge\u003e\n+          \u003cArrowRight class=\"h-6 w-6 animate-pulse text-muted-foreground\" /\u003e\n+          \u003cBadge variant=\"outline\" class=\"gap-2\"\u003e\n+            \u003cGitBranch class=\"h-3 w-3\" /\u003e\n+            {$selectedCommit.hash}\n+          \u003c/Badge\u003e\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    {/if}\n+\n+    {#if mergeAnalysis || isAnalyzing}\n+      \u003cdiv class=\"space-y-6\"\u003e\n+        \u003cCard class={mergeAnalysis ? getCompatibilityColor(mergeAnalysis.compatibility) : \"\"}\u003e\n+          \u003cCardHeader class=\"pb-3\"\u003e\n+            \u003cCardTitle class=\"flex items-center gap-2 text-lg\"\u003e\n+              {#if isAnalyzing}\n+                \u003cZap class=\"h-5 w-5 animate-spin text-blue-500\" /\u003e\n+                Analyzing Merge Compatibility...\n+              {:else}\n+                {getCompatibilityIcon(mergeAnalysis.compatibility)}\n+                Merge Analysis Complete\n+              {/if}\n+            \u003c/CardTitle\u003e\n+          \u003c/CardHeader\u003e\n+          {#if mergeAnalysis}\n+            \u003cCardContent\u003e\n+              \u003cdiv class=\"mb-4 grid grid-cols-4 gap-4\"\u003e\n+                \u003cdiv class=\"text-center\"\u003e\n+                  \u003cdiv class=\"text-2xl font-bold text-blue-600\"\u003e\n+                    {Math.round(mergeAnalysis.similarity * 100)}%\n+                  \u003c/div\u003e\n+                  \u003cdiv class=\"text-xs text-muted-foreground\"\u003eSimilarity\u003c/div\u003e\n+                \u003c/div\u003e\n+                \u003cdiv class=\"text-center\"\u003e\n+                  \u003cdiv class=\"text-2xl font-bold text-orange-600\"\u003e\n+                    {mergeAnalysis.conflictCount}\n+                  \u003c/div\u003e\n+                  \u003cdiv class=\"text-xs text-muted-foreground\"\u003eConflicts\u003c/div\u003e\n+                \u003c/div\u003e\n+                \u003cdiv class=\"text-center\"\u003e\n+                  \u003cdiv class=\"text-2xl font-bold text-purple-600\"\u003e\n+                    {mergeAnalysis.affectedFiles.length}\n+                  \u003c/div\u003e\n+                  \u003cdiv class=\"text-xs text-muted-foreground\"\u003eFiles\u003c/div\u003e\n+                \u003c/div\u003e\n+                \u003cdiv class=\"text-center\"\u003e\n+                  \u003cBadge\n+                    variant={mergeAnalysis.riskLevel === \"low\" ? \"default\" : \"destructive\"}\n+                    class=\"text-xs\"\u003e\n+                    {mergeAnalysis.riskLevel} risk\n+                  \u003c/Badge\u003e\n+                \u003c/div\u003e\n+              \u003c/div\u003e\n+\n+              \u003cdiv class=\"flex items-center justify-between\"\u003e\n+                \u003cdiv class=\"flex items-center gap-2\"\u003e\n+                  \u003cTarget class=\"h-4 w-4\" /\u003e\n+                  \u003cspan class=\"text-sm\"\u003e\n+                    {mergeAnalysis.autoMergeable\n+                      ? \"Auto-mergeable\"\n+                      : \"Manual intervention required\"}\n+                  \u003c/span\u003e\n+                \u003c/div\u003e\n+\n+                \u003cdiv class=\"flex gap-2\"\u003e\n+                  \u003cButton size=\"sm\" variant=\"outline\" class=\"gap-2\"\u003e\n+                    \u003cEye class=\"h-3 w-3\" /\u003e\n+                    Preview Merge\n+                  \u003c/Button\u003e\n+                  \u003cButton size=\"sm\" class=\"gap-2\" disabled={!mergeAnalysis.autoMergeable}\u003e\n+                    \u003cGitMerge class=\"h-3 w-3\" /\u003e\n+                    Apply Merge\n+                  \u003c/Button\u003e\n+                \u003c/div\u003e\n+              \u003c/div\u003e\n+            \u003c/CardContent\u003e\n+          {/if}\n+        \u003c/Card\u003e\n+\n+        {#if mergeAnalysis}\n+          \u003cTabs value=\"analyzer\" class=\"w-full\"\u003e\n+            \u003cTabsList class=\"grid w-full grid-cols-2\"\u003e\n+              \u003cTabsTrigger value=\"analyzer\"\u003eMerge Analyzer\u003c/TabsTrigger\u003e\n+              \u003cTabsTrigger value=\"conflicts\"\u003e\n+                Conflict Visualizer\n+                {#if mergeAnalysis.conflictCount \u003e 0}\n+                  \u003cBadge variant=\"destructive\" class=\"ml-2\"\u003e\n+                    {mergeAnalysis.conflictCount}\n+                  \u003c/Badge\u003e\n+                {/if}\n+              \u003c/TabsTrigger\u003e\n+            \u003c/TabsList\u003e\n+\n+            \u003cTabsContent value=\"analyzer\"\u003e\n+              \u003cMergeAnalyzer\n+                analysis={mergeAnalysis}\n+                patch={selectedPatch}\n+                commit={selectedCommit} /\u003e\n+            \u003c/TabsContent\u003e\n+\n+            \u003cTabsContent value=\"conflicts\"\u003e\n+              \u003cConflictVisualizer\n+                conflicts={mergeAnalysis.conflictCount \u003e 0\n+                  ? [\n+                      {\n+                        file: \"src/components/App.tsx\",\n+                        lines: \"23-31\",\n+                        type: \"content\",\n+                        severity: \"high\",\n+                      },\n+                      {\n+                        file: \"src/styles/main.css\",\n+                        lines: \"45-48\",\n+                        type: \"formatting\",\n+                        severity: \"low\",\n+                      },\n+                      {\n+                        file: \"src/auth/login.tsx\",\n+                        lines: \"15-20\",\n+                        type: \"structure\",\n+                        severity: \"medium\",\n+                      },\n+                    ]\n+                  : []}\n+                analysis={mergeAnalysis} /\u003e\n+            \u003c/TabsContent\u003e\n+          \u003c/Tabs\u003e\n+        {/if}\n+      \u003c/div\u003e\n+\n+      {#if !selectedPatch || !selectedCommit}\n+        \u003cCard class=\"h-96\"\u003e\n+          \u003cCardContent class=\"flex h-full items-center justify-center\"\u003e\n+            \u003cdiv class=\"text-center text-muted-foreground\"\u003e\n+              \u003cLayers class=\"mx-auto mb-4 h-16 w-16 opacity-50\" /\u003e\n+              \u003ch3 class=\"mb-2 text-xl font-medium\"\u003eReady for Analysis\u003c/h3\u003e\n+              \u003cp class=\"max-w-md text-sm\"\u003e\n+                Select a patch and a commit above to begin merge compatibility analysis. The\n+                workbench will show you exactly what happens when they're combined.\n+              \u003c/p\u003e\n+            \u003c/div\u003e\n+          \u003c/CardContent\u003e\n+        \u003c/Card\u003e\n+      {/if}\n+    {/if}\n+  \u003c/div\u003e\n+\u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-mnhlzcm8","title":"From d13c10cecde5f1876d4abd708e185552338e2d66 Mon Sep 17 00:00:00 2001","description":"From d13c10cecde5f1876d4abd708e185552338e2d66 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Fri, 4 Jul 2025 10:18:51 -0700\nSubject: [PATCH 70/70] refactor: remove unused addToMapKey import from state module\n\n---\n src/app/state.ts | 1 -\n 1 file changed, 1 deletion(-)\n\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 9a95dc2..34c93e9 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -16,7 +16,6 @@ import {\n   parseJson,\n   fromPairs,\n   memoize,\n-  addToMapKey,\n   identity,\n   always,\n } from \"@welshman/lib\"\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-ms6cb2dv","title":"From 78183ad9aaa5631fa9b82d39de4f90fb5383e59f Mon Sep 17 00:00:00 2001","description":"From 78183ad9aaa5631fa9b82d39de4f90fb5383e59f Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Thu, 29 May 2025 14:30:22 -0700\nSubject: [PATCH 10/67] Support copying and pasting npubs better\n\n---\n CHANGELOG.md                                 |  2 ++\n src/app/components/ChatStart.svelte          | 36 +++++++++++++++++++++++++++++++++++-\n src/app/components/Profile.svelte            | 27 ++++++++++++++++++++++-----\n src/app/components/ProfileDetail.svelte      | 41 ++---------------------------------------\n src/app/components/ProfileMultiSelect.svelte |  9 ++++++---\n src/lib/components/Avatar.svelte             |  2 +-\n src/lib/components/Suggestions.svelte        |  4 ++--\n src/lib/components/Tippy.svelte              |  4 +---\n 8 files changed, 71 insertions(+), 54 deletions(-)\n\ndiff --git a/CHANGELOG.md b/CHANGELOG.md\nindex a5fe192..01f0775 100644\n--- a/CHANGELOG.md\n+++ b/CHANGELOG.md\n@@ -8,6 +8,8 @@\n * Support multiple platform relays\n * Remove default general room\n * Remove room tag from threads/calendars\n+* Show pubkey on profile detail\n+* Support pasting pubkey into chat start dialog\n \n # 1.0.4\n \ndiff --git a/src/app/components/ChatStart.svelte b/src/app/components/ChatStart.svelte\nindex dcda9e6..dfa6df1 100644\n--- a/src/app/components/ChatStart.svelte\n+++ b/src/app/components/ChatStart.svelte\n@@ -1,5 +1,10 @@\n \u003cscript lang=\"ts\"\u003e\n+  import * as nip19 from \"nostr-tools/nip19\"\n+  import {onMount} from \"svelte\"\n+  import {writable} from \"svelte/store\"\n   import {goto} from \"$app/navigation\"\n+  import {tryCatch, uniq} from \"@welshman/lib\"\n+  import {fromNostrURI} from \"@welshman/util\"\n   import {pubkey} from \"@welshman/app\"\n   import {preventDefault} from \"@lib/html\"\n   import Field from \"@lib/components/Field.svelte\"\n@@ -14,7 +19,36 @@\n \n   const onSubmit = () =\u003e goto(makeChatPath([...pubkeys, $pubkey!]))\n \n+  const addPubkey = (pubkey: string) =\u003e {\n+    pubkeys = uniq([...pubkeys, pubkey])\n+    term.set(\"\")\n+  }\n+\n+  const term = writable(\"\")\n+\n   let pubkeys: string[] = $state([])\n+\n+  onMount(() =\u003e {\n+    return term.subscribe(t =\u003e {\n+      if (t.match(/^[0-9a-f]{64}$/)) {\n+        addPubkey(t)\n+      }\n+\n+      if (t.match(/^(nostr:)?(npub1|nprofile1)/)) {\n+        tryCatch(() =\u003e {\n+          const {type, data} = nip19.decode(fromNostrURI(t))\n+\n+          if (type === \"npub\") {\n+            addPubkey(data)\n+          }\n+\n+          if (type === \"nprofile\") {\n+            addPubkey(data.pubkey)\n+          }\n+        })\n+      }\n+    })\n+  })\n \u003c/script\u003e\n \n \u003cform class=\"column gap-4\" onsubmit={preventDefault(onSubmit)}\u003e\n@@ -28,7 +62,7 @@\n   \u003c/ModalHeader\u003e\n   \u003cField\u003e\n     {#snippet input()}\n-      \u003cProfileMultiSelect autofocus bind:value={pubkeys} /\u003e\n+      \u003cProfileMultiSelect autofocus bind:value={pubkeys} {term} /\u003e\n     {/snippet}\n   \u003c/Field\u003e\n   \u003cModalFooter\u003e\ndiff --git a/src/app/components/Profile.svelte b/src/app/components/Profile.svelte\nindex e0dd409..aea1084 100644\n--- a/src/app/components/Profile.svelte\n+++ b/src/app/components/Profile.svelte\n@@ -1,4 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n+  import * as nip19 from \"nostr-tools/nip19\"\n   import {removeNil} from \"@welshman/lib\"\n   import {displayPubkey, getPubkeyTagValues, getListTags} from \"@welshman/util\"\n   import {\n@@ -10,19 +11,23 @@\n     deriveProfile,\n     deriveProfileDisplay,\n   } from \"@welshman/app\"\n+  import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n   import Avatar from \"@lib/components/Avatar.svelte\"\n   import WotScore from \"@lib/components/WotScore.svelte\"\n   import ProfileDetail from \"@app/components/ProfileDetail.svelte\"\n   import {pushModal} from \"@app/modal\"\n+  import {clip} from \"@app/toast\"\n \n   type Props = {\n     pubkey: string\n     url?: string\n     hideDetails?: boolean\n+    showPubkey?: boolean\n+    avatarSize?: number\n   }\n \n-  const {pubkey, url, hideDetails=false}: Props = $props()\n+  const {pubkey, url, hideDetails=false, showPubkey, avatarSize = 10}: Props = $props()\n \n   const relays = removeNil([url])\n   const profile = deriveProfile(pubkey, relays)\n@@ -32,14 +37,16 @@\n \n   const openProfile = () =\u003e pushModal(ProfileDetail, {pubkey, url})\n \n+  const copyPubkey = () =\u003e clip(nip19.npubEncode(pubkey))\n+\n   const following = $derived(\n     pubkey === $session!.pubkey || getPubkeyTagValues(getListTags($userFollows)).includes(pubkey),\n   )\n \u003c/script\u003e\n \n-\u003cdiv class=\"flex max-w-full gap-3\"\u003e\n+\u003cdiv class=\"flex max-w-full items-start gap-3\"\u003e\n   \u003cButton onclick={openProfile} class=\"py-1\"\u003e\n-    \u003cAvatar src={$profile?.picture} size={10} /\u003e\n+    \u003cAvatar src={$profile?.picture} size={avatarSize} /\u003e\n   \u003c/Button\u003e\n   {#if !hideDetails}\n     \u003cdiv class=\"flex min-w-0 flex-col\"\u003e\n@@ -49,9 +56,19 @@\n         \u003c/Button\u003e\n         \u003cWotScore score={$score} active={following} /\u003e\n       \u003c/div\u003e\n+      {#if $handle}\n       \u003cdiv class=\"overflow-hidden text-ellipsis text-sm opacity-75\"\u003e\n-        {$handle ? displayHandle($handle) : displayPubkey(pubkey)}\n+          {displayHandle($handle)}\n+      \u003c/div\u003e\n+    {/if}\n+    {#if showPubkey}\n+      \u003cdiv class=\"flex items-center gap-1 overflow-hidden text-ellipsis text-xs opacity-60\"\u003e\n+        {displayPubkey(pubkey)}\n+          \u003cButton onclick={copyPubkey} class=\"pt-1\"\u003e\n+          \u003cIcon size={3} icon=\"copy\" /\u003e\n+        \u003c/Button\u003e\n       \u003c/div\u003e\n-    \u003c/div\u003e\n+      {/if}\n+  \u003c/div\u003e\n   {/if}\n \u003c/div\u003e\ndiff --git a/src/app/components/ProfileDetail.svelte b/src/app/components/ProfileDetail.svelte\nindex 31640a2..9e9a2d9 100644\n--- a/src/app/components/ProfileDetail.svelte\n+++ b/src/app/components/ProfileDetail.svelte\n@@ -1,22 +1,10 @@\n \u003cscript lang=\"ts\"\u003e\n   import {goto} from \"$app/navigation\"\n-  import {removeNil} from \"@welshman/lib\"\n-  import {displayPubkey, getPubkeyTagValues, getListTags} from \"@welshman/util\"\n-  import {\n-    session,\n-    userFollows,\n-    deriveUserWotScore,\n-    deriveHandleForPubkey,\n-    displayHandle,\n-    deriveProfile,\n-    deriveProfileDisplay,\n-  } from \"@welshman/app\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Link from \"@lib/components/Link.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n-  import Avatar from \"@lib/components/Avatar.svelte\"\n-  import WotScore from \"@lib/components/WotScore.svelte\"\n   import ModalFooter from \"@lib/components/ModalFooter.svelte\"\n+  import Profile from \"@app/components/Profile.svelte\"\n   import ProfileInfo from \"@app/components/ProfileInfo.svelte\"\n   import ChatEnable from \"@app/components/ChatEnable.svelte\"\n   import {canDecrypt, pubkeyLink} from \"@app/state\"\n@@ -30,40 +18,15 @@\n \n   const {pubkey, url}: Props = $props()\n \n-  const relays = removeNil([url])\n-  const profile = deriveProfile(pubkey, relays)\n-  const display = deriveProfileDisplay(pubkey, relays)\n-  const handle = deriveHandleForPubkey(pubkey)\n-  const score = deriveUserWotScore(pubkey)\n-\n   const back = () =\u003e history.back()\n \n   const chatPath = makeChatPath([pubkey])\n \n   const openChat = () =\u003e ($canDecrypt ? goto(chatPath) : pushModal(ChatEnable, {next: chatPath}))\n-\n-  const following = $derived(\n-    pubkey === $session!.pubkey || getPubkeyTagValues(getListTags($userFollows)).includes(pubkey),\n-  )\n \u003c/script\u003e\n \n \u003cdiv class=\"column gap-4\"\u003e\n-  \u003cdiv class=\"flex max-w-full gap-3\"\u003e\n-    \u003cspan class=\"py-1\"\u003e\n-      \u003cAvatar src={$profile?.picture} size={10} /\u003e\n-    \u003c/span\u003e\n-    \u003cdiv class=\"flex min-w-0 flex-col\"\u003e\n-      \u003cdiv class=\"flex items-center gap-2\"\u003e\n-        \u003cspan class=\"text-bold overflow-hidden text-ellipsis\"\u003e\n-          {$display}\n-        \u003c/span\u003e\n-        \u003cWotScore score={$score} active={following} /\u003e\n-      \u003c/div\u003e\n-      \u003cdiv class=\"overflow-hidden text-ellipsis text-sm opacity-75\"\u003e\n-        {$handle ? displayHandle($handle) : displayPubkey(pubkey)}\n-      \u003c/div\u003e\n-    \u003c/div\u003e\n-  \u003c/div\u003e\n+  \u003cProfile showPubkey avatarSize={14} {pubkey} {url} /\u003e\n   \u003cProfileInfo {pubkey} {url} /\u003e\n   \u003cModalFooter\u003e\n     \u003cButton onclick={back} class=\"hidden md:btn md:btn-link\"\u003e\ndiff --git a/src/app/components/ProfileMultiSelect.svelte b/src/app/components/ProfileMultiSelect.svelte\nindex ecd6d9d..00af8f1 100644\n--- a/src/app/components/ProfileMultiSelect.svelte\n+++ b/src/app/components/ProfileMultiSelect.svelte\n@@ -1,5 +1,6 @@\n \u003cscript lang=\"ts\"\u003e\n   import {writable} from \"svelte/store\"\n+  import type {Writable} from \"svelte/store\"\n   import {type Instance} from \"tippy.js\"\n   import {append, remove, uniq} from \"@welshman/lib\"\n   import {profileSearch} from \"@welshman/app\"\n@@ -15,11 +16,10 @@\n   interface Props {\n     value: string[]\n     autofocus?: boolean\n+    term?: Writable\u003cstring\u003e\n   }\n \n-  let {value = $bindable(), autofocus = false}: Props = $props()\n-\n-  const term = writable(\"\")\n+  let {value = $bindable(), term = writable(\"\"), autofocus = false}: Props = $props()\n \n   const search = (term: string) =\u003e $profileSearch.searchValues(term)\n \n@@ -44,6 +44,9 @@\n   let instance: any = $state()\n \n   $effect(() =\u003e {\n+    // @ts-ignore\n+    oninput?.($term)\n+\n     if ($term) {\n       popover?.show()\n     } else {\ndiff --git a/src/lib/components/Avatar.svelte b/src/lib/components/Avatar.svelte\nindex 372e3e0..398c607 100644\n--- a/src/lib/components/Avatar.svelte\n+++ b/src/lib/components/Avatar.svelte\n@@ -13,7 +13,7 @@\n       const image = new Image()\n \n       image.addEventListener(\"error\", () =\u003e {\n-        element.querySelector(\".hidden\")?.classList.remove(\"hidden\")\n+        element?.querySelector(\".hidden\")?.classList.remove(\"hidden\")\n       })\n \n       image.src = src\ndiff --git a/src/lib/components/Suggestions.svelte b/src/lib/components/Suggestions.svelte\nindex e6bfff3..e907881 100644\n--- a/src/lib/components/Suggestions.svelte\n+++ b/src/lib/components/Suggestions.svelte\n@@ -3,7 +3,7 @@\n   import {throttle, clamp} from \"@welshman/lib\"\n   import {preventDefault, stopPropagation} from \"@lib/html\"\n \n-  const {term, search, select, component: Component, allowCreate = false} = $props()\n+  const {term, search, select, component: Component, style = \"\", allowCreate = false} = $props()\n \n   let index = $state(0)\n   let items: string[] = $state([])\n@@ -57,7 +57,7 @@\n   })\n \u003c/script\u003e\n \n-\u003cdiv transition:fly|local={{duration: 200}} class=\"tiptap-suggestions\"\u003e\n+\u003cdiv transition:fly|local={{duration: 200}} class=\"tiptap-suggestions\" {style}\u003e\n   \u003cdiv class=\"tiptap-suggestions__content max-h-[40vh]\"\u003e\n     {#if $term \u0026\u0026 allowCreate \u0026\u0026 !items.includes($term)}\n       \u003cbutton\ndiff --git a/src/lib/components/Tippy.svelte b/src/lib/components/Tippy.svelte\nindex 9fafd2e..ec97281 100644\n--- a/src/lib/components/Tippy.svelte\n+++ b/src/lib/components/Tippy.svelte\n@@ -14,8 +14,6 @@\n     ...restProps\n   } = $props()\n \n-  const reactiveProps = $derived(props)\n-\n   let element: Element\n \n   onMount(() =\u003e {\n@@ -28,7 +26,7 @@\n       ...params,\n     })\n \n-    instance = mount(component, {target, props: reactiveProps})\n+    instance = mount(component, {target, props})\n \n     return () =\u003e {\n       popover?.destroy()\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-nca5gzz8","title":"\"Load more\" feature if items exceed a limit","description":"Places where loading too many items would be unnecessary.\nPerformance boosy and data savings.\n\nRepo feed, chats with potentially long history etc.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["enhancement","good first issue","issue"]}
{"id":"flotilla-ndxp6a9l","title":"From bf7e3f3fb84a6ade0e113131c0814ef9f4624c6e Mon Sep 17 00:00:00 2001","description":"From bf7e3f3fb84a6ade0e113131c0814ef9f4624c6e Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Tue, 11 Nov 2025 10:52:36 +0500\nSubject: [PATCH] feat(git): Provide Profile component to nostr-git UI via ConfigProvider\n\n- Create RepoPickerWrapper component to wrap RepoPicker with ConfigProvider\n  - Provides ProfileComponent from app's Profile component to nostr-git UI\n  - Ensures avatars display correctly when RepoPicker is opened in modal\n  - Follows same pattern as NewRepoWizardWrapper for consistency\n\n- Update git page to use RepoPickerWrapper instead of direct RepoPicker\n  - Fixes avatar display issue in RepoPicker modal\n  - Removes unused imports (RepoPicker, TabsContent)\n  - Update search placeholder to match RepoPicker functionality\n\n- Update submodule reference to include RepoPicker avatar improvements\n  - References commit with NostrAvatar integration and naddr search\n\nThis ensures that nostr-git UI components have access to the app's Profile\ncomponent through the registry system, enabling proper avatar rendering in\nmodals and other components that are rendered outside the page context.\n---\n packages/nostr-git                          |  2 +-\n src/app/components/RepoPickerWrapper.svelte | 14 ++++++++++++++\n src/routes/spaces/[relay]/git/+page.svelte  |  7 +++----\n 3 files changed, 18 insertions(+), 5 deletions(-)\n create mode 100644 src/app/components/RepoPickerWrapper.svelte\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex d06f175..deb66d0 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit d06f17550182224baafe87e3e13b8eb643f91d1a\n+Subproject commit deb66d015ea9373b71ab04f1da3fa52fcdbd4d28\ndiff --git a/src/app/components/RepoPickerWrapper.svelte b/src/app/components/RepoPickerWrapper.svelte\nnew file mode 100644\nindex 0000000..f901c7a\n--- /dev/null\n+++ b/src/app/components/RepoPickerWrapper.svelte\n@@ -0,0 +1,14 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import { ConfigProvider, RepoPicker } from \"@nostr-git/ui\"\n+  import Profile from \"@app/components/Profile.svelte\"\n+  \n+  const props = $props()\n+\u003c/script\u003e\n+\n+\u003cConfigProvider\n+  components={{\n+    ProfileComponent: Profile as typeof import(\"@nostr-git/ui\").Profile,\n+  }}\u003e\n+  \u003cRepoPicker {...props} /\u003e\n+\u003c/ConfigProvider\u003e\n+\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex a1f56ac..07055e0 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -37,15 +37,14 @@\n     Avatar,\n     AvatarImage,\n     AvatarFallback,\n-    RepoPicker,\n     bookmarksStore,\n     repositoriesStore,\n     Tabs,\n-    TabsContent,\n     TabsList,\n     TabsTrigger,\n   } from \"@nostr-git/ui\"\n   import NewRepoWizardWrapper from \"@app/components/NewRepoWizardWrapper.svelte\"\n+  import RepoPickerWrapper from \"@app/components/RepoPickerWrapper.svelte\"\n   import {\n     deriveRepoRefState,\n     deriveMaintainersForEuc,\n@@ -387,7 +386,7 @@\n           return \"\"\n         }\n       }\n-      pushModal(RepoPicker, {\n+      pushModal(RepoPickerWrapper, {\n         selectedRepos: loadedBookmarkedRepos,\n         fetchRepos,\n         publishBookmarks,\n@@ -622,7 +621,7 @@\n                 bind:value={searchQuery}\n                 class=\"grow\"\n                 type=\"text\"\n-                placeholder=\"Search repositories...\" /\u003e\n+                placeholder=\"Paste naddr or search...\" /\u003e\n             \u003c/label\u003e\n           \u003c/div\u003e\n         \u003c/div\u003e\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-ndy8w7sp","title":"From 4ee8a6eb1b3f84f1ad691b877d9d98ac2d39204f Mon Sep 17 00:00:00 2001","description":"From 4ee8a6eb1b3f84f1ad691b877d9d98ac2d39204f Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Fri, 12 Dec 2025 00:22:57 +0500\nSubject: [PATCH 1/2] Add token-based authentication for git push operations\n\n- Update GitActions component to extract hostname from remote URLs\n- Implement token matching and retry logic for authenticated pushes\n- Support both SSH (git@host) and HTTPS URL formats\n- Fallback to unauthenticated push if no tokens available\n- Update nostr-git submodule reference\n- Update pnpm-lock.yaml with dependency changes\n---\n pnpm-lock.yaml                       | Bin 548939 -\u003e 549005 bytes\n src/app/components/GitActions.svelte | 35 ++++++++++++++++++++++++++++++++++-\n 2 files changed, 34 insertions(+), 1 deletion(-)\n\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex c04570460e0c12b0745e9127f13fe320b55fd887..aa6a9f59ceeb867341b58c9e813399268b8865c0 100644\nGIT binary patch\ndelta 70\nzc$_\u003cZK(Y6r;)WR#?70P{MVV=plP7vgFd9!zG#6nt)-%\u003eKXzrJ2@0VZ%VkRJF24WT\u003c\nRW(8t4AZFj*FTt_L9RPUN7jFOn\n\ndelta 46\ntc%17!sCfE-;)WR#\u00269@}lZ%Hr$F%u9o12GE_vjQ\u003c25VLQ;CBd=T9RS+?69)hQ\n\ndiff --git a/src/app/components/GitActions.svelte b/src/app/components/GitActions.svelte\nindex 4d980a0..a7b278b 100644\n--- a/src/app/components/GitActions.svelte\n+++ b/src/app/components/GitActions.svelte\n@@ -24,6 +24,8 @@\n   import Link from \"@lib/components/Link.svelte\"\n   import { onMount } from \"svelte\"\n   import { parseRepoAnnouncementEvent } from \"@nostr-git/shared-types\"\n+  import {tokens as tokensStore} from \"@nostr-git/ui\"\n+  import {tryTokensForHost, getTokensForHost} from \"@nostr-git/ui\"\n \n   interface Props {\n     url: any\n@@ -195,7 +197,38 @@\n     const remoteUrl = cloneUrls[0]\n     syncing = true\n     try {\n-      await workerApi.pushToRemote({ repoId, remoteUrl })\n+      // Extract hostname for token matching\n+      let hostname: string\n+      try {\n+        // Handle SSH URLs like git@github.com:owner/repo.git\n+        if (remoteUrl.startsWith('git@')) {\n+          const match = remoteUrl.match(/git@([^:]+):/)\n+          hostname = match ? match[1] : ''\n+        } else {\n+          // Handle HTTPS URLs\n+          const urlObj = new URL(remoteUrl)\n+          hostname = urlObj.hostname\n+        }\n+      } catch {\n+        hostname = ''\n+      }\n+      const tokens = await tokensStore.waitForInitialization()\n+      const matchingTokens = getTokensForHost(tokens, hostname)\n+\n+      // Try all tokens for this host until one succeeds, or push without token if none available\n+      if (matchingTokens.length \u003e 0) {\n+        await tryTokensForHost(\n+          tokens,\n+          hostname,\n+          async (token: string, host: string) =\u003e {\n+            return await workerApi.pushToRemote({ repoId, remoteUrl, token })\n+          }\n+        )\n+      } else {\n+        // No tokens available - try pushing without authentication (may fail for private repos)\n+        await workerApi.pushToRemote({ repoId, remoteUrl })\n+      }\n+\n       const syncResult = await workerApi.syncWithRemote({ repoId, cloneUrls })\n       \n       // Handle warnings like CORS issues gracefully\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-nfpj3dh7","title":"From 7ceac256482228673d750195723c95caacac2822 Mon Sep 17 00:00:00 2001","description":"From 7ceac256482228673d750195723c95caacac2822 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 2 Jun 2025 08:58:26 -0700\nSubject: [PATCH 1/2] feat: add patch view page and improve file loading in git repository browser\n\n---\n packages/nostr-git                                                      |   2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |  18 +++++++++---------\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte              |  84 ++++++++++++++++++++++++++++++++++++++++--------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 134 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n 4 files changed, 184 insertions(+), 54 deletions(-)\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 565f147..1e83572 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 565f147cd1ff1efda2516b1b9c9e421870106f7d\n+Subproject commit 1e835722f528da5f31239627ec39c70fa2dfb773\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 02c4ef9..1acffff 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -13,12 +13,17 @@\n   import {Address, GIT_ISSUE, GIT_PATCH, type Filter} from \"@welshman/util\"\n   import {load} from \"@welshman/net\"\n   import {nthEq} from \"@welshman/lib\"\n-    import PageBar from \"@src/lib/components/PageBar.svelte\"\n+  import PageBar from \"@src/lib/components/PageBar.svelte\"\n+  import {Buffer} from \"buffer\"\n \n   const {id, relay} = $page.params\n \n   let {children} = $props()\n \n+  if (typeof window !== \"undefined\" \u0026\u0026 !window.Buffer) {\n+    (window as any).Buffer = Buffer;\n+  }\n+\n   let eventStore = $state(deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay]))\n \n   const repoState = $derived.by(() =\u003e {\n@@ -65,7 +70,7 @@\n   let activeTab: string | undefined = $page.url.pathname.split(\"/\").pop()\n   const encodeddRelay = encodeURIComponent(relay)\n \n-  $effect(async () =\u003e {\n+  $effect(() =\u003e {\n     if ($eventStore) {\n       const repoEvent = parseRepoAnnouncementEvent($eventStore as RepoAnnouncementEvent)\n       const address = repoEvent.repoId\n@@ -74,18 +79,14 @@\n       const patchesFilter: Filter = {kinds: [GIT_PATCH], \"#a\": [address]}\n       const [tagId, ...relays] = $eventStore.tags.find(nthEq(0, \"relays\")) ?? []\n \n-      await load({\n+      load({\n         relays: relays,\n         filters: [issuesFilter, patchesFilter, repoStateFilter],\n       })\n-\n-      if ($repoState \u0026\u0026 $issues \u0026\u0026 $patches) {\n-        console.log(\"issues\", $issues)\n-        console.log(\"patches\", $patches)\n-      }\n     }\n   })\n \u003c/script\u003e\n+\n \u003cPageBar\u003e\n   \u003cRepoHeader event={$eventStore as RepoAnnouncementEvent} {activeTab}\u003e\n     {#snippet children(activeTab: string)}\n@@ -138,7 +139,6 @@\n   \u003c/RepoHeader\u003e\n \u003c/PageBar\u003e\n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n-\n   {#if $eventStore === undefined}\n     \u003cdiv class=\"p-4 text-center\"\u003eLoading repository...\u003c/div\u003e\n   {:else if !$eventStore}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex a03e86c..e50102a 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -2,18 +2,13 @@\n   import {getContext} from \"svelte\"\n   import {FileView} from \"@nostr-git/ui\"\n   import {GitBranch} from \"@lucide/svelte\"\n-  import {\n-    listRepoFilesFromEvent,\n-    type FileEntry,\n-    listBranchesFromEvent,\n-  } from \"@nostr-git/core\"\n+  import {listRepoFilesFromEvent, type FileEntry, listBranchesFromEvent} from \"@nostr-git/core\"\n   import {\n     parseRepoAnnouncementEvent,\n     parseRepoStateEvent,\n     type RepoAnnouncementEvent,\n     type RepoStateEvent,\n     type TrustedEvent,\n-    type RepoEvent,\n   } from \"@nostr-git/shared-types\"\n   import {page} from \"$app/stores\"\n   import type {Readable} from \"svelte/store\"\n@@ -21,6 +16,7 @@\n   import Button from \"@src/lib/components/Button.svelte\"\n   import {fly} from \"svelte/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n+    import Spinner from \"@src/lib/components/Spinner.svelte\"\n \n   const {id, relay} = $page.params\n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n@@ -35,7 +31,7 @@\n   // UI state\n   let loading = $state(true)\n   let error: string | null = $state(null)\n-  let files: FileEntry[] = $state([])\n+  let files: Promise\u003cFileEntry[]\u003e = $state(Promise.resolve([]))\n   let fallbackToBranches = $state(false)\n \n   const repoState = repo.state()\n@@ -59,28 +55,18 @@\n     }\n   })\n \n-let selectedBranchValue = $state\u003cstring | undefined\u003e(undefined)\n+  let selectedBranchValue = $state\u003cstring | undefined\u003e(undefined)\n \n   $effect(async () =\u003e {\n     if (selectedBranch) {\n       selectedBranchValue = await selectedBranch\n-      files = await listRepoFilesFromEvent({\n-        repoEvent: $repoEvent as RepoEvent,\n-        branch: selectedBranchValue,\n+      files = listRepoFilesFromEvent({\n+        repoEvent: $repoEvent as RepoAnnouncementEvent,\n+        branch: selectedBranchValue?.split(\"/\").pop() || \"master\",\n       })\n-    }\n-  })\n-\n-  $effect(async () =\u003e {\n-    if ($repoState) {\n       loading = false\n-      files = await listRepoFilesFromEvent({\n-        repoEvent: $repoEvent as RepoEvent,\n-        branch: await selectedBranch,\n-      })\n     } else {\n-      console.log($repoEvent)\n-      branches = await listBranchesFromEvent({repoEvent: $repoEvent})\n+      branches = listBranchesFromEvent({repoEvent: $repoEvent})\n       loading = false\n     }\n   })\n@@ -99,6 +85,7 @@ let selectedBranchValue = $state\u003cstring | undefined\u003e(undefined)\n \u003cdiv class=\"rounded-lg border border-border bg-card\"\u003e\n   \u003cdiv class=\"p-4\"\u003e\n     {#if loading}\n+\n       \u003cdiv class=\"text-muted-foreground\"\u003eLoading repository files...\u003c/div\u003e\n     {:else if error}\n       \u003cdiv class=\"text-red-500\"\u003e{error}\u003c/div\u003e\n@@ -112,11 +99,13 @@ let selectedBranchValue = $state\u003cstring | undefined\u003e(undefined)\n           class=\"rounded border border-border bg-secondary px-2 py-1\"\n           bind:value={selectedBranchValue}\n           disabled\u003e\n-          {#each branches as branch}\n-            \u003coption value={branch.name}\u003e\n-              {branch.name}\n-            \u003c/option\u003e\n-          {/each}\n+          {#await branches then branches}\n+            {#each branches as branch}\n+              \u003coption value={branch.name}\u003e\n+                {branch.name}\n+              \u003c/option\u003e\n+            {/each}\n+          {/await}\n         \u003c/select\u003e\n       \u003c/div\u003e\n       \u003cdiv class=\"border-t border-border pt-4\"\u003e\n@@ -133,28 +122,35 @@ let selectedBranchValue = $state\u003cstring | undefined\u003e(undefined)\n         \u003c/Button\u003e\n         {#if showMenu}\n           \u003cPopover hideOnClick onClose={toggleMenu}\u003e\n-            \u003cul transition:fly class=\"menu z-popover mt-2 rounded-box bg-base-100 p-2 shadow-xl\"\u003e\n-              {#each branches as branch}\n-                \u003cli\u003e\n-                  \u003cButton onclick={() =\u003e (selectedBranch = branch.name)}\u003e\n-                    \u003cspan\u003e{branch.name}\u003c/span\u003e\n-                  \u003c/Button\u003e\n-                \u003c/li\u003e\n-              {/each}\n+            \u003cul\n+              transition:fly\n+              class=\"menu z-popover mt-2 flex flex-col rounded-box bg-base-100 p-2 shadow-xl\"\u003e\n+              {#await branches then branches}\n+                {#each branches as branch}\n+                  \u003cli\u003e\n+                    \u003cButton onclick={() =\u003e (selectedBranchValue = branch.name)}\u003e\n+                      \u003cspan\u003e{branch.name}\u003c/span\u003e\n+                    \u003c/Button\u003e\n+                  \u003c/li\u003e\n+                {/each}\n+              {/await}\n             \u003c/ul\u003e\n           \u003c/Popover\u003e\n         {/if}\n       \u003c/div\u003e\n       \u003cdiv class=\"border-t border-border pt-4\"\u003e\n-        {#if files.length === 0}\n-          \u003cdiv class=\"text-muted-foreground\"\u003eNo files found in this branch.\u003c/div\u003e\n-        {:else}\n-          \u003cdiv class=\"space-y-2\"\u003e\n-            {#each files as file}\n-              \u003cFileView name={file.name} type={file.type} path={file.path} /\u003e\n-            {/each}\n-          \u003c/div\u003e\n-        {/if}\n+        \u003cdiv class=\"space-y-2\"\u003e\n+          \u003cSpinner loading={loading}\u003eLoading files...\u003c/Spinner\u003e\n+          {#await files then files}\n+          {#if files.length === 0}\n+              \u003cdiv class=\"text-muted-foreground\"\u003eNo files found in this branch.\u003c/div\u003e\n+            {:else}\n+              {#each files as file}\n+                \u003cFileView name={file.name} type={file.type} path={file.path} /\u003e\n+              {/each}\n+            {/if}\n+          {/await}\n+        \u003c/div\u003e\n       \u003c/div\u003e\n     {/if}\n   \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nnew file mode 100644\nindex 0000000..e3c3b09\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -0,0 +1,134 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {page} from \"$app/stores\"\n+  import {GitCommit, MessageSquare, Check, X} from \"@lucide/svelte\"\n+  import { parseGitPatchFromEvent } from \"@nostr-git/core\"\n+  import {type RepoStateEvent, type TrustedEvent} from \"@nostr-git/shared-types\"\n+  import {Button} from \"@nostr-git/ui\"\n+  import {Avatar, AvatarFallback, AvatarImage, DiffViewer, IssueThread} from \"@nostr-git/ui\"\n+  import {getContext} from \"svelte\"\n+  import type {Readable} from \"svelte/motion\"\n+\n+  const repo = getContext\u003c{\n+    repo: Readable\u003cTrustedEvent\u003e\n+    state: () =\u003e Readable\u003cRepoStateEvent\u003e\n+    issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+  }\u003e(\"repo\")\n+\n+  const patches = $derived(repo.patches())\n+\n+  const patch = $derived.by(() =\u003e {\n+    if ($patches) {\n+      const p = $patches.find(patch =\u003e patch.id === $page.params.patchid)\n+      if (p) {\n+        return parseGitPatchFromEvent(p)\n+      }\n+    }\n+  })\n+\n+  const threadComments = $derived.by(() =\u003e {\n+    if (patch) {\n+      console.log(patch)\n+      return []\n+    }\n+  })\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"container max-w-6xl py-6\"\u003e\n+  \u003cdiv class=\"mt-6\"\u003e\n+    \u003cdiv class=\"rounded-lg border border-border bg-card p-6\"\u003e\n+      \u003cdiv class=\"mb-4 flex items-start justify-between\"\u003e\n+        \u003cdiv class=\"flex items-start gap-4\"\u003e\n+          {#if patch?.status === \"open\"}\n+            \u003cdiv class=\"mt-1\"\u003e\n+              \u003cdiv class=\"flex h-10 w-10 items-center justify-center rounded-full bg-amber-500/10\"\u003e\n+                \u003cGitCommit class=\"h-5 w-5 text-amber-500\" /\u003e\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {:else if patch?.status === \"merged\"}\n+            \u003cdiv class=\"mt-1\"\u003e\n+              \u003cdiv class=\"flex h-10 w-10 items-center justify-center rounded-full bg-green-500/10\"\u003e\n+                \u003cCheck class=\"h-5 w-5 text-green-500\" /\u003e\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {:else}\n+            \u003cdiv class=\"mt-1\"\u003e\n+              \u003cdiv class=\"flex h-10 w-10 items-center justify-center rounded-full bg-red-500/10\"\u003e\n+                \u003cX class=\"h-5 w-5 text-red-500\" /\u003e\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          \u003cdiv\u003e\n+            \u003ch1 class=\"text-2xl font-bold\"\u003e{patch?.title}\u003c/h1\u003e\n+\n+            \u003cdiv class=\"mt-1 flex items-center gap-2\"\u003e\n+              \u003cdiv class=\"git-tag bg-secondary\"\u003e\n+                {patch?.status === \"open\" ? \"Open\" : patch?.status === \"merged\" ? \"Merged\" : \"Closed\"}\n+              \u003c/div\u003e\n+              \u003cspan class=\"text-sm text-muted-foreground\"\u003e\n+                {patch?.author.name} opened this patch • {new Date(patch?.createdAt).toLocaleString()}\n+              \u003c/span\u003e\n+            \u003c/div\u003e\n+\n+            \u003cp class=\"mt-4 text-muted-foreground\"\u003e{patch?.description}\u003c/p\u003e\n+          \u003c/div\u003e\n+        \u003c/div\u003e\n+\n+        \u003cAvatar class=\"h-10 w-10\"\u003e\n+          \u003cAvatarImage src={patch?.author.picture} alt={patch?.author.name} /\u003e\n+          \u003cAvatarFallback\u003e{patch?.author.name.substring(0, 2).toUpperCase()}\u003c/AvatarFallback\u003e\n+        \u003c/Avatar\u003e\n+      \u003c/div\u003e\n+\n+      \u003cdiv class=\"git-separator\"\u003e\u003c/div\u003e\n+\n+      \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n+        \u003ch2 class=\"text-lg font-medium\"\u003e{patch?.commitCount} Commits\u003c/h2\u003e\n+\n+        \u003cdiv class=\"flex items-center gap-2\"\u003e\n+          \u003cButton variant=\"outline\" size=\"sm\"\u003eView on GitHub\u003c/Button\u003e\n+\n+          {#if patch?.status === \"open\"}\n+            \u003cButton variant=\"default\" size=\"sm\" class=\"bg-git hover:bg-git-hover\"\u003e\n+              Merge Patch\n+            \u003c/Button\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+\n+      \u003cdiv class=\"mb-6 space-y-3\"\u003e\n+        {#each patch?.diff as commit (commit.id)}\n+          \u003cdiv class=\"flex items-start gap-3 rounded-md border border-border p-3\"\u003e\n+            \u003cGitCommit class=\"mt-1 h-5 w-5 text-muted-foreground\" /\u003e\n+            \u003cdiv\u003e\n+              \u003cp class=\"font-medium\"\u003e{commit.message}\u003c/p\u003e\n+              \u003cdiv class=\"mt-1 flex items-center gap-2 text-sm text-muted-foreground\"\u003e\n+                \u003cspan\u003e{commit.author}\u003c/span\u003e\n+                \u003cspan\u003e•\u003c/span\u003e\n+                \u003cspan\u003e{new Date(commit.date).toLocaleString()}\u003c/span\u003e\n+                \u003cspan\u003e•\u003c/span\u003e\n+                \u003ccode class=\"rounded bg-secondary/50 px-1.5 py-0.5 text-xs\"\n+                  \u003e{commit.id.substring(0, 7)}\u003c/code\u003e\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          \u003c/div\u003e\n+        {/each}\n+      \u003c/div\u003e\n+\n+      \u003ch2 class=\"mb-4 text-lg font-medium\"\u003eChanges\u003c/h2\u003e\n+      \u003cDiffViewer diff={patch?.raw.diff} /\u003e\n+\n+      \u003cdiv class=\"git-separator my-6\"\u003e\u003c/div\u003e\n+\n+      \u003cdiv class=\"space-y-4\"\u003e\n+        \u003ch2 class=\"flex items-center gap-2 text-lg font-medium\"\u003e\n+          \u003cMessageSquare class=\"h-5 w-5\" /\u003e\n+          Discussion ({threadComments?.length})\n+        \u003c/h2\u003e\n+\n+        \u003cIssueThread issueId={patch?.id} comments={threadComments} /\u003e\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  \u003c/div\u003e\n+\u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-ngium2js","title":"From d9ad3d3c1415f1c0d8d5d805d6ce34669b9fd396 Mon Sep 17 00:00:00 2001","description":"From d9ad3d3c1415f1c0d8d5d805d6ce34669b9fd396 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Fri, 25 Jul 2025 17:42:31 -0700\nSubject: [PATCH 10/10] feat: add repository refresh functionality with sync status and merge analysis logging\n\n---\n packages/nostr-git                                                      |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 | 51 ++++++++++++++++++++++++++++++++++++++++++++++++++-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 25 ++++++++++++++++++-------\n 3 files changed, 69 insertions(+), 9 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 0829d84..71eaa7a 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 0829d843b456337f56b9dbe3ce643bbabcd53cbd\n+Subproject commit 71eaa7a61931dbaa2f58d685947ccec7f4e6e288\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex d71ed89..842bddf 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -21,6 +21,55 @@\n \n   let activeTab: string | undefined = $page.url.pathname.split(\"/\").pop()\n   const encodedRelay = encodeURIComponent(relay)\n+  \n+  // Refresh state\n+  let isRefreshing = $state(false)\n+\n+  // Refresh repository function\n+  async function refreshRepo() {\n+    if (!repoClass || isRefreshing) return\n+    \n+    isRefreshing = true\n+    \n+    try {\n+      // Get clone URLs from the repo event\n+      const cloneUrls = repoClass.repoEvent.tags\n+        .filter((tag: string[]) =\u003e tag[0] === 'clone')\n+        .map((tag: string[]) =\u003e tag[1])\n+        .filter(Boolean)\n+      \n+      if (cloneUrls.length === 0) {\n+        throw new Error('No clone URLs found for repository')\n+      }\n+      \n+      // Call syncWithRemote through the repo's worker manager\n+      const result = await repoClass.workerManager.syncWithRemote({\n+        repoId: repoClass.repoEvent.id,\n+        cloneUrls,\n+        branch: repoClass.mainBranch\n+      })\n+      \n+      if (result.success) {\n+        // Show success toast\n+        pushToast({\n+          message: `Repository synced with remote (${result.headCommit?.slice(0, 8)})`\n+        })\n+        \n+        // Reset the repo to refresh all cached data\n+        await repoClass.reset()\n+      } else {\n+        throw new Error(result.error || 'Sync failed')\n+      }\n+    } catch (error) {\n+      console.error('Failed to refresh repository:', error)\n+      pushToast({\n+        message: `Failed to sync repository: ${error instanceof Error ? error.message : 'Unknown error'}`,\n+        theme: 'error'\n+      })\n+    } finally {\n+      isRefreshing = false\n+    }\n+  }\n \n   // Connect the nostr-git toast store to the toast component\n   $effect(() =\u003e {\n@@ -45,7 +94,7 @@\n   {:else if !repoClass}\n     \u003cdiv class=\"p-4 text-center text-red-500\"\u003eRepository not found.\u003c/div\u003e\n   {:else}\n-    \u003cRepoHeader event={repoClass.repoEvent} {activeTab} isRepoWatched={false}\u003e\n+    \u003cRepoHeader event={repoClass.repoEvent} {activeTab} isRepoWatched={false} {refreshRepo} {isRefreshing}\u003e\n       {#snippet children(activeTab: string)}\n         \u003cRepoTab\n           tabValue=\"feed\"\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex d5c8535..95234e4 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -139,14 +139,24 @@\n \n     isAnalyzingMerge = true\n     mergeAnalysisResult = null\n-\n     try {\n-      // Add a small delay to ensure repository is fully ready\n-      await new Promise(resolve =\u003e setTimeout(resolve, 100))\n+      console.log('🔍 DEBUG: Starting merge analysis with:', {\n+        patchId: patchEvent?.id,\n+        targetBranch,\n+        repoId: repoClass.repoId,\n+        mainBranch: repoClass.mainBranch,\n+        hasWorkerManager: !!repoClass.workerManager\n+      });\n       \n-      // The repository should already be running background merge analysis\n-      // We just need to trigger a refresh if needed and wait for the result\n-      const result = await repoClass.refreshMergeAnalysis(patchEvent)\n+      let result = await repoClass.getMergeAnalysis(patchEvent, targetBranch)\n+      \n+      console.log('🔍 DEBUG: Merge analysis result:', {\n+        hasResult: !!result,\n+        analysis: result?.analysis,\n+        errorMessage: result?.errorMessage,\n+        canMerge: result?.canMerge,\n+        fullResult: result\n+      });\n       \n       if (result) {\n         mergeAnalysisResult = result\n@@ -154,9 +164,10 @@\n         // If still no result, try to get from cache first\n         const cachedResult = await repoClass.getMergeAnalysis(patchEvent, targetBranch)\n         if (cachedResult) {\n+          console.log('🔍 DEBUG: Using cached result:', cachedResult);\n           mergeAnalysisResult = cachedResult\n         } else {\n-          console.log('No merge analysis result available yet - will retry')\n+          console.log('🔍 DEBUG: No merge analysis result available yet - will retry')\n           // Don't show error immediately, just return and let it retry\n           return\n         }\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-nk28dsxh","title":"From 751c38bce1d923f9bb1ab74ea3e0cee2e0fb9d8d Mon Sep 17 00:00:00 2001","description":"From 751c38bce1d923f9bb1ab74ea3e0cee2e0fb9d8d Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 23 Nov 2025 17:38:44 +0500\nSubject: [PATCH] chore: update nostr-git submodule and add pubkey validation to GitItem\n\nProblem:\n- GitItem component could display invalid maintainer pubkeys\n- No validation of pubkeys before using them for display\n- Could cause rendering issues with malformed pubkey data\n- Forking was adding git username as maintainer which was causing rendering issues\n\nSolution:\n- Add pubkey validation consistent with nostr-git submodule changes\n- Filter invalid maintainers before selecting display pubkey\n- Ensure only valid 64-character hex pubkeys are used\n---\n packages/nostr-git                |  2 +-\n src/app/components/GitItem.svelte | 21 +++++++++++++++++----\n 2 files changed, 18 insertions(+), 5 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 13ba161..181d6ed 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 13ba16132fc286a3cda9564f417324c0719c393b\n+Subproject commit 181d6ed732987ebf719f88b87d6d9dd8b619679c\ndiff --git a/src/app/components/GitItem.svelte b/src/app/components/GitItem.svelte\nindex 5e824ed..8d99a97 100644\n--- a/src/app/components/GitItem.svelte\n+++ b/src/app/components/GitItem.svelte\n@@ -20,13 +20,26 @@\n \n   const name = event.tags.find(nthEq(0, \"name\"))?.[1]\n   const description = event.tags.find(nthEq(0, \"description\"))?.[1]\n-  \n+\n+  // Validate that a string is a valid hex pubkey (exactly 64 hex characters)\n+  const isValidPubkey = (pubkey: string | undefined | null): boolean =\u003e {\n+    if (!pubkey || typeof pubkey !== 'string') return false;\n+    return /^[0-9a-f]{64}$/i.test(pubkey);\n+  }\n+\n   // Get maintainers from the event, or fall back to the event author\n   const maintainersTag = event.tags.find(nthEq(0, \"maintainers\"))\n-  const maintainers = maintainersTag ? maintainersTag.slice(1) : [event.pubkey]\n+  const maintainers = maintainersTag \n+    ? maintainersTag.slice(1).filter((pk: string) =\u003e isValidPubkey(pk))\n+    : []\n+  \n+  // Use first valid maintainer, or fall back to event author if valid\n+  const displayPubkey = maintainers.length \u003e 0 \u0026\u0026 isValidPubkey(maintainers[0])\n+    ? maintainers[0]\n+    : event.pubkey\n   \n-  // Create a modified event with the first maintainer as the pubkey for display\n-  const displayEvent = {...event, pubkey: maintainers[0]}\n+  // Create a modified event with the validated pubkey for display\n+  const displayEvent = displayPubkey ? {...event, pubkey: displayPubkey} : event\n \u003c/script\u003e\n \n \u003cNoteCard event={displayEvent} class=\"card2 sm:card2-sm bg-alt\"\u003e\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-ntjhnvi3","title":"From 7ad564bc736f9a8f35b95caa62e2f23c587d464a Mon Sep 17 00:00:00 2001","description":"From 7ad564bc736f9a8f35b95caa62e2f23c587d464a Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Mon, 22 Dec 2025 12:27:23 +0500\nSubject: [PATCH] feat: persist Repo instances across navigation and improve branch switching\n\nImplement Repo instance persistence and enhanced branch switching state\nmanagement to maintain repository state (including branch selection) across\npage navigations and improve commit loading during branch switches.\n\nChanges:\n- Add global activeRepoClass store in state.ts to persist Repo instances\n  across component re-initializations and navigations\n- Update layout to reuse existing Repo instances when navigating to the\n  same repository, disposing and recreating only when switching to a\n  different repository (identified by repo address)\n- Enhance commits page branch switching logic:\n  * Add branchSwitchComplete state flag to track completion of branch\n    switches and prevent race conditions\n  * Use microtask to ensure reactive state is fully updated before\n    syncing commits after branch switch completes\n  * Improve reactive syncing of commits from repoClass with better\n    handling of branch change detection\n  * Prevent duplicate commit loading during active switching operations\n- Update nostr-git submodule to include branch synchronization fixes\n\nThis ensures:\n- Branch selection and repository state persist when navigating between\n  tabs (code, commits, etc.) within the same repository\n- Commit lists update correctly and efficiently when switching branches\n- No duplicate or conflicting state updates during branch switch operations\n- Better user experience with maintained context across navigation\n---\n packages/nostr-git                                            |  2 +-\n src/lib/budabit/state.ts                                      |  5 ++++-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte       | 60 +++++++++++++++++++++++++++++++++++++++++++-----------------\n src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte | 61 +++++++++++++++++++++++++++++++++++++++++++++++++++++--------\n 4 files changed, 101 insertions(+), 27 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex ca95cef..3809d3d 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit ca95ceff17011c579f4bf53099d713e12256962f\n+Subproject commit 3809d3dbbf39f8eb97c274deafb480b1cdbefb5e\ndiff --git a/src/lib/budabit/state.ts b/src/lib/budabit/state.ts\nindex f47a151..5af8812 100644\n--- a/src/lib/budabit/state.ts\n+++ b/src/lib/budabit/state.ts\n@@ -1,5 +1,5 @@\n \n-import { writable, derived, } from \"svelte/store\"\n+import { writable, derived, get as getStore, type Writable } from \"svelte/store\"\n import { load, request } from \"@welshman/net\"\n import {\n   groupByEuc,\n@@ -21,9 +21,12 @@ import { normalizeRelayUrl, type TrustedEvent, ROOM_META, getTag } from \"@welshm\n import { nip19 } from \"nostr-tools\"\n import { fromPairs, pushToMapKey, sortBy, uniq, uniqBy } from \"@welshman/lib\"\n import { extractRoleAssignments } from \"./labels\"\n+import type { Repo } from \"@nostr-git/ui\"\n \n export const shouldReloadRepos = writable(false)\n \n+export const activeRepoClass = writable\u003cRepo | undefined\u003e(undefined)\n+\n export const REPO_KEY = Symbol(\"repo\")\n \n export const REPO_RELAYS_KEY = Symbol(\"repo-relays\")\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex de04482..0b388fe 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -29,7 +29,7 @@\n   import {isCommentEvent} from \"@nostr-git/shared-types\"\n   import {nthEq} from \"@welshman/lib\"\n   import {setContext, getContext, onDestroy} from \"svelte\"\n-  import {REPO_KEY, REPO_RELAYS_KEY, STATUS_EVENTS_BY_ROOT_KEY, PULL_REQUESTS_KEY} from \"@lib/budabit/state\"\n+  import {REPO_KEY, REPO_RELAYS_KEY, STATUS_EVENTS_BY_ROOT_KEY, PULL_REQUESTS_KEY, activeRepoClass} from \"@lib/budabit/state\"\n   import PageBar from \"@src/lib/components/PageBar.svelte\"\n   import Button from \"@src/lib/components/Button.svelte\"\n   import Icon from \"@src/lib/components/Icon.svelte\"\n@@ -43,8 +43,8 @@\n   const layoutData = data as unknown as {repoId: string, repoName: string, repoPubkey: string, fallbackRelays: string[], naddrRelays: string[], url: string}\n   const {repoId, repoName, repoPubkey, fallbackRelays, naddrRelays, url} = layoutData\n   \n-  // Store for repoClass - will be created in effect\n-  let repoClass = $state\u003cRepo | undefined\u003e(undefined)\n+  // Derive repoClass from activeRepoClass store\n+  const repoClass = $derived($activeRepoClass)\n \n   // Make activeTab reactive to avoid lag on navigation - memoize the calculation\n   const activeTab = $derived.by(() =\u003e {\n@@ -266,21 +266,47 @@\n   const emptyRepoStateEvents = derived([], () =\u003e [] as RepoStateEvent[])\n   const emptyLabelEvents = derived([], () =\u003e [] as LabelEvent[])\n \n-  // Create Repo instance\n-  const repoInstance = new Repo({\n-    repoEvent: repoEventStore as Readable\u003cRepoAnnouncementEvent\u003e,\n-    repoStateEvent: repoStateEventStore as Readable\u003cRepoStateEvent\u003e,\n-    issues: issuesStore,\n-    patches: patchesStore,\n-    repoStateEvents: emptyRepoStateEvents as unknown as Readable\u003cRepoStateEvent[]\u003e,\n-    statusEvents: statusEventsStore,\n-    commentEvents: commentEventsStore,\n-    labelEvents: emptyLabelEvents as unknown as Readable\u003cLabelEvent[]\u003e,\n-  })\n-  repoClass = repoInstance\n-\n+  // Get or create Repo instance (reuse existing instance if available)\n+  // This ensures branch selection and other state persists across navigations\n+  // The store-based cache persists across component re-initializations  \n+  if (!$activeRepoClass) {\n+    $activeRepoClass = new Repo({\n+      repoEvent: repoEventStore as Readable\u003cRepoAnnouncementEvent\u003e,\n+      repoStateEvent: repoStateEventStore as Readable\u003cRepoStateEvent\u003e,\n+      issues: issuesStore,\n+      patches: patchesStore,\n+      repoStateEvents: emptyRepoStateEvents as unknown as Readable\u003cRepoStateEvent[]\u003e,\n+      statusEvents: statusEventsStore,\n+      commentEvents: commentEventsStore,\n+      labelEvents: emptyLabelEvents as unknown as Readable\u003cLabelEvent[]\u003e,\n+    })\n+  } else {\n+    // Check if the existing repoInstance is for a different repository\n+    // Compare repoPubkey:repoName to determine if it's a different repoInstance\n+    const existingRepo = $activeRepoClass\n+\n+    const expectedAddress = `${GIT_REPO_ANNOUNCEMENT}:${repoPubkey}:${repoName}`\n+    const isDifferentRepo = existingRepo.address !== expectedAddress\n+    console.log('isDifferentRepo', isDifferentRepo)\n+    if (isDifferentRepo) {\n+      existingRepo.dispose()\n+      $activeRepoClass = new Repo({\n+        repoEvent: repoEventStore as Readable\u003cRepoAnnouncementEvent\u003e,\n+        repoStateEvent: repoStateEventStore as Readable\u003cRepoStateEvent\u003e,\n+        issues: issuesStore,\n+        patches: patchesStore,\n+        repoStateEvents: emptyRepoStateEvents as unknown as Readable\u003cRepoStateEvent[]\u003e,\n+        statusEvents: statusEventsStore,\n+        commentEvents: commentEventsStore,\n+        labelEvents: emptyLabelEvents as unknown as Readable\u003cLabelEvent[]\u003e,\n+      })\n+    } else {\n+      console.log(\"♻️  [LAYOUT INIT] REUSING existing Repo instance\")\n+    }\n+  }\n+    \n   // Set context for child components (only once, not in effect)\n-  setContext(REPO_KEY, repoInstance)\n+  setContext(REPO_KEY, $activeRepoClass)\n   setContext(REPO_RELAYS_KEY, repoRelaysStore)\n   setContext(STATUS_EVENTS_BY_ROOT_KEY, statusEventsByRootStore)\n   setContext(PULL_REQUESTS_KEY, pullRequestsStore)\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\nindex 2143bea..e74e145 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n@@ -59,6 +59,7 @@\n   // Track the previous branch to detect changes\n   let previousBranch = $state\u003cstring | undefined\u003e(undefined);\n   let wasJustSwitching = $state(false);\n+  let branchSwitchComplete = $state(false);\n \n   // Handle branch switching state changes\n   $effect(() =\u003e {\n@@ -68,23 +69,33 @@\n       // Show loading state while switching\n       commitsLoading = true;\n       wasJustSwitching = true;\n+      branchSwitchComplete = false;\n     } else if (wasJustSwitching) {\n       // Switch just completed - commits are already loaded by setSelectedBranch\n-      // Just clear the flag, don't reload\n+      // Mark as complete and wait a tick to ensure state is fully updated\n       wasJustSwitching = false;\n-      commitsLoading = false;\n+      branchSwitchComplete = true;\n+      // Use a microtask to ensure reactive state is fully updated\n+      Promise.resolve().then(() =\u003e {\n+        branchSwitchComplete = false;\n+        commitsLoading = false;\n+        // Update commits from repoClass after switch completes\n+        commits = repoClass.commits || [];\n+        totalCommits = repoClass.totalCommits;\n+        hasMoreCommits = repoClass.hasMoreCommits;\n+      });\n     }\n   });\n \n-  // Load commits when branch changes (but not during active switching)\n+  // Load commits when branch changes (but not during active switching or right after)\n   $effect(() =\u003e {\n     const selectedBranch = repoClass.selectedBranch;\n     const mainBranch = repoClass.mainBranch;\n     const currentBranch = selectedBranch || mainBranch;\n     const isSwitching = repoClass.isBranchSwitching;\n     \n-    // Skip if actively switching (setSelectedBranch will handle loading)\n-    if (isSwitching || wasJustSwitching) {\n+    // Skip if actively switching or just completed (setSelectedBranch already loaded commits)\n+    if (isSwitching || wasJustSwitching || branchSwitchComplete) {\n       return;\n     }\n     \n@@ -161,10 +172,44 @@\n \n   // Branch list removed\n \n+  // Sync commits from repoClass reactively (especially after branch switches)\n   $effect(() =\u003e {\n-    if (repoClass.commits \u0026\u0026 repoClass.commits.length \u003e 0) {\n-      authors = new Set(repoClass.commits.map((commit: any) =\u003e commit.commit.author.name))\n-      commitsLoading = false\n+    const repoCommits = repoClass.commits;\n+    const repoTotalCommits = repoClass.totalCommits;\n+    const repoHasMore = repoClass.hasMoreCommits;\n+    const currentBranch = repoClass.selectedBranch || repoClass.mainBranch;\n+    const isSwitching = repoClass.isBranchSwitching;\n+    \n+    // Don't sync during active switching to avoid race conditions\n+    if (isSwitching) {\n+      return;\n+    }\n+    \n+    // Update commits from repoClass (especially after branch switches)\n+    if (repoCommits) {\n+      // If branch changed, update previousBranch to match\n+      if (previousBranch !== undefined \u0026\u0026 currentBranch !== previousBranch) {\n+        previousBranch = currentBranch;\n+      }\n+      \n+      commits = repoCommits;\n+      totalCommits = repoTotalCommits;\n+      hasMoreCommits = repoHasMore;\n+      \n+      // Update authors list\n+      const newAuthors = new Set\u003cstring\u003e();\n+      repoCommits.forEach((commit: any) =\u003e {\n+        if (commit.commit?.author?.name) {\n+          newAuthors.add(commit.commit.author.name);\n+        }\n+      });\n+      authors = newAuthors;\n+      \n+      // Mark as loaded if we have commits\n+      if (repoCommits.length \u003e 0) {\n+        initialLoadComplete = true;\n+        commitsLoading = false;\n+      }\n     }\n   })\n \n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-nwr0m0o2","title":"From cb8e39b909e25f298412ad4bf81ac72e61d974f7 Mon Sep 17 00:00:00 2001","description":"From cb8e39b909e25f298412ad4bf81ac72e61d974f7 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Tue, 30 Dec 2025 09:57:40 +0500\nSubject: [PATCH] refactor: make git data loading reactive and fix relay selection race condition\n\n- Convert git data loading in root layout to reactive subscription pattern\n  - Subscribe to pubkey changes to handle login and user switching scenarios\n  - Add AbortController to cancel pending git data loads when pubkey changes\n  - Implement retry logic (up to 2s) to wait for relay selections after login\n    - Handles case where relay selections haven't loaded yet after fresh login\n    - Falls back to default GIT_RELAYS if relay selections remain empty\n  - Add proper error handling with AbortError filtering\n\n- Refactor git repo layout to simplify context usage\n  - Remove unused getContext import\n  - Use repoRelaysStore directly instead of multiple context lookups\n  - Reduce code duplication in settingsRepo, loadProfile, and createPatch functions\n---\n src/routes/+layout.svelte                               | 39 ++++++++++++++++++++++++++++++++++-----\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte | 13 ++++---------\n 2 files changed, 38 insertions(+), 14 deletions(-)\n\ndiff --git a/src/routes/+layout.svelte b/src/routes/+layout.svelte\nindex 184be27..bbd4dce 100644\n--- a/src/routes/+layout.svelte\n+++ b/src/routes/+layout.svelte\n@@ -398,11 +398,40 @@\n         await loadUserData($pubkey)\n       }\n \n-      // Load user git data\n-      if ($pubkey) {\n-        //gitSigner.set($signer)\n-        await loadUserGitData($pubkey, Router.get().FromUser().getUrls())\n-      }\n+      // Reactively load user git data when pubkey changes (e.g., after login)\n+      let gitDataLoadController: AbortController | undefined\n+      pubkey.subscribe(async ($pubkey) =\u003e {\n+        // Cancel any pending git data load\n+        gitDataLoadController?.abort()\n+        gitDataLoadController = new AbortController()\n+\n+        if ($pubkey) {\n+          try {\n+            // Get user relays - if empty after login, wait a bit for relay selections to load\n+            let userRelays = Router.get().FromUser().getUrls()\n+            \n+            // If relays are empty (common after fresh login), wait for relay selections to load\n+            if (userRelays.length === 0) {\n+              // Wait up to 2 seconds for relay selections to become available\n+              // This handles the case where relay selections haven't loaded yet after login\n+              for (let i = 0; i \u003c 20; i++) {\n+                await sleep(100)\n+                userRelays = Router.get().FromUser().getUrls()\n+                if (userRelays.length \u003e 0) break\n+              }\n+            }\n+            \n+            // Load git data reactively when pubkey is set (login) or changes (user switch)\n+            // Pass undefined if still empty to use GIT_RELAYS default from loadUserGitData\n+            await loadUserGitData($pubkey, userRelays.length \u003e 0 ? userRelays : undefined)\n+          } catch (error) {\n+            // Ignore errors (e.g., if aborted or network issues)\n+            if (error instanceof Error \u0026\u0026 error.name !== 'AbortError') {\n+              console.warn('Failed to load user git data:', error)\n+            }\n+          }\n+        }\n+      })\n \n       // Listen for space data, populate space-based notifications\n       let unsubSpaces: any\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 0c7763b..d0767ba 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -40,7 +40,7 @@\n   import {normalizeRelayUrl, NAMED_BOOKMARKS, makeEvent, Address, GIT_ISSUE, GIT_PATCH, GIT_STATUS_OPEN, GIT_STATUS_DRAFT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE, getTagValue, COMMENT, type TrustedEvent} from \"@welshman/util\"\n   import {isCommentEvent} from \"@nostr-git/shared-types\"\n   import {nthEq} from \"@welshman/lib\"\n-  import {setContext, getContext, onDestroy} from \"svelte\"\n+  import {setContext, onDestroy} from \"svelte\"\n   import {REPO_KEY, REPO_RELAYS_KEY, STATUS_EVENTS_BY_ROOT_KEY, PULL_REQUESTS_KEY, activeRepoClass} from \"@lib/budabit/state\"\n   import PageBar from \"@src/lib/components/PageBar.svelte\"\n   import Button from \"@src/lib/components/Button.svelte\"\n@@ -678,9 +678,7 @@\n   function settingsRepo() {\n     if (!repoClass) return\n     \n-    // Get repoRelays from context\n-    const repoRelaysStore = getContext\u003cReadable\u003cstring[]\u003e\u003e(REPO_RELAYS_KEY)\n-    const repoRelays = repoRelaysStore ? getStore(repoRelaysStore) : []\n+    const repoRelays = getStore(repoRelaysStore)\n     if (repoRelays.length === 0) {\n       pushToast({\n         message: \"Repository relays not ready. Please wait...\",\n@@ -705,8 +703,7 @@\n           }\n         }\n         // Try to load profile if not in cache\n-        const repoRelaysStore = getContext\u003cReadable\u003cstring[]\u003e\u003e(REPO_RELAYS_KEY)\n-        const repoRelays = repoRelaysStore ? getStore(repoRelaysStore) : (repoClass?.relays || [])\n+        const repoRelays = getStore(repoRelaysStore) || (repoClass?.relays || [])\n         await loadProfile(pubkey, repoRelays)\n         const loadedProfile = $profilesByPubkey.get(pubkey)\n         if (loadedProfile) {\n@@ -752,9 +749,7 @@\n         throw new Error(\"Repository event not available\")\n       }\n       \n-      // Get repoRelays from context\n-      const repoRelaysStore = getContext\u003cReadable\u003cstring[]\u003e\u003e(REPO_RELAYS_KEY)\n-      const repoRelays = repoRelaysStore ? getStore(repoRelaysStore) : (repoClass?.relays || [])\n+      const repoRelays = getStore(repoRelaysStore) || (repoClass?.relays || [])\n       \n       // Get repo address\n       const address = repoClass.address || Address.fromEvent(repoClass.repoEvent).toString()\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-o1qz75uv","title":"Issues/Patches: default selected filters are not applied initially","description":"On navigation to these pages, the filters previously set are not applied","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T18:05:14.809588-08:00","closed_at":"2026-01-24T18:05:14.809588-08:00","close_reason":"Verified implemented via codebase triage","labels":["bug","issue","issues","patches","v1"]}
{"id":"flotilla-o96zeg8p","title":"From a60f7e6d365dd011309e12be5834a2ce6ab81706 Mon Sep 17 00:00:00 2001","description":"From a60f7e6d365dd011309e12be5834a2ce6ab81706 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Fri, 6 Jun 2025 15:12:27 -0700\nSubject: [PATCH 1/3] feat: patch workshop\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 | 67 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte            | 31 ++++++++++++++++++-------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           | 31 ++++++++++++++++++-------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 44 +++++++++++++++++++++++++++++---------------\n 4 files changed, 123 insertions(+), 50 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 06b3626..db36f2e 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -1,26 +1,30 @@\n \u003cscript lang=\"ts\"\u003e\n   import {RepoHeader, RepoTab} from \"@nostr-git/ui\"\n   import {page} from \"$app/stores\"\n-  import {deriveNaddrEvent} from \"@app/state\"\n+  import {decodeRelay, deriveNaddrEvent, userSettingValues} from \"@app/state\"\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n-  import {FileCode, GitBranch, CircleAlert, GitPullRequest} from \"@lucide/svelte\"\n-  import {parseRepoAnnouncementEvent, type RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n+  import {FileCode, GitBranch, CircleAlert, GitPullRequest, Layers} from \"@lucide/svelte\"\n+  import {\n+    parseRepoAnnouncementEvent,\n+    type CommentEvent,\n+    type IssueEvent,\n+    type RepoAnnouncementEvent,\n+  } from \"@nostr-git/shared-types\"\n   import {setContext} from \"svelte\"\n   import {deriveEvents} from \"@welshman/store\"\n-  import {repository} from \"@welshman/app\"\n+  import {deriveProfile, publishThunk, repository} from \"@welshman/app\"\n   import {GIT_REPO_STATE} from \"@src/lib/util\"\n   import {derived as _derived} from \"svelte/store\"\n   import {Address, GIT_ISSUE, GIT_PATCH, type Filter} from \"@welshman/util\"\n   import {load} from \"@welshman/net\"\n   import {nthEq} from \"@welshman/lib\"\n   import {Buffer} from \"buffer\"\n-\n   const {id, relay} = $page.params\n \n   let {children} = $props()\n \n   if (typeof window !== \"undefined\" \u0026\u0026 !window.Buffer) {\n-    (window as any).Buffer = Buffer;\n+    ;(window as any).Buffer = Buffer\n   }\n \n   let eventStore = $state(deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay]))\n@@ -29,7 +33,10 @@\n     if ($eventStore) {\n       const repoEvent = parseRepoAnnouncementEvent($eventStore as RepoAnnouncementEvent)\n       const address = repoEvent.repoId\n-      const repoStateFilter = [{kinds: [GIT_REPO_STATE], \"#d\": [address]}]\n+      const repoStateFilter: Filter[] = [\n+        {kinds: [GIT_REPO_STATE], \"#d\": [address!]},\n+        {kinds: [GIT_REPO_STATE], \"#d\": [address!], \"#t\": [\"root\"]},\n+      ]\n       const repoState = _derived(\n         deriveEvents(repository, {filters: repoStateFilter}),\n         events =\u003e events[0],\n@@ -57,11 +64,45 @@\n \n   setContext(\"repo-event\", eventStore)\n \n+  const url = decodeRelay($page.params.relay)\n+\n+  const relays = $derived.by(() =\u003e {\n+    if ($eventStore) {\n+      const [_, ...relays] = $eventStore.tags.find(nthEq(0, \"relays\")) || []\n+      return [url, ...relays]\n+    }\n+  })\n+\n+  const postComment = (comment: CommentEvent) =\u003e {\n+    publishThunk({\n+      relays: [url],\n+      event: comment,\n+    })\n+  }\n+\n+  setContext(\"postComment\", postComment)\n+\n+  const postIssue = (issue: IssueEvent) =\u003e {\n+    publishThunk({\n+      relays: [url],\n+      event: issue,\n+    })\n+  }\n+\n+  setContext(\"postIssue\", postIssue)\n+\n+  const getProfile = (pubkey: string) =\u003e {\n+    return deriveProfile(pubkey)\n+  }\n+\n+  setContext(\"getProfile\", deriveProfile)\n+\n   const repo = $state({\n     repo: eventStore,\n     state: () =\u003e repoState,\n     issues: () =\u003e issues,\n     patches: () =\u003e patches,\n+    relays: () =\u003e relays,\n   })\n \n   setContext(\"repo\", repo)\n@@ -76,10 +117,9 @@\n       const repoStateFilter: Filter = {kinds: [GIT_REPO_STATE], \"#d\": [address]}\n       const issuesFilter: Filter = {kinds: [GIT_ISSUE], \"#a\": [address]}\n       const patchesFilter: Filter = {kinds: [GIT_PATCH], \"#a\": [address]}\n-      const [tagId, ...relays] = $eventStore.tags.find(nthEq(0, \"relays\")) ?? []\n \n       load({\n-        relays: relays,\n+        relays: relays!,\n         filters: [issuesFilter, patchesFilter, repoStateFilter],\n       })\n     }\n@@ -130,6 +170,15 @@\n             \u003cGitPullRequest class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n+        \u003cRepoTab\n+          tabValue=\"workbench\"\n+          label=\"Workbench\"\n+          href={`/spaces/${encodeddRelay}/git/${id}/workbench`}\n+          {activeTab}\u003e\n+          {#snippet icon()}\n+            \u003cLayers class=\"h-4 w-4\" /\u003e\n+          {/snippet}\n+        \u003c/RepoTab\u003e\n       {/snippet}\n     \u003c/RepoHeader\u003e\n     {@render children()}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex d30eaa5..875351d 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -3,14 +3,15 @@\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Address, COMMENT, GIT_ISSUE, type TrustedEvent} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n-  import {nthEq} from \"@welshman/lib\"\n-  import {deriveProfile, repository} from \"@welshman/app\"\n+  import {deriveProfile, relays, repository} from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {makeFeed} from \"@src/app/requests\"\n   import type {Readable} from \"svelte/store\"\n   import {type RepoStateEvent} from \"@nostr-git/shared-types\"\n   import {fly} from \"@lib/transition\"\n   import {pushModal} from \"@src/app/modal\"\n+  import {load} from \"@welshman/net\"\n+  import {deriveEvents} from \"@welshman/store\"\n \n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n@@ -18,10 +19,18 @@\n     repo: Readable\u003cTrustedEvent\u003e\n     state: () =\u003e Readable\u003cRepoStateEvent\u003e\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    relays: () =\u003e string[]\n   }\u003e(\"repo\")\n \n-  let issues = repo.issues()\n-  const comments: TrustedEvent[] = $state([])\n+  const issues = repo.issues()\n+\n+  const comments = $derived.by(() =\u003e {\n+    if ($issues) {\n+      const filters = $issues.map(issue =\u003e issue.id)\n+      load({relays: repo.relays(), filters: [{kinds: [COMMENT], \"#E\": filters}]})\n+      return deriveEvents(repository, {filters: [{kinds: [COMMENT], \"#E\": filters}]})\n+    }\n+  })\n \n   let loading = $state(true)\n   let element: HTMLElement | undefined = $state()\n@@ -31,16 +40,14 @@\n       loading = false\n     }\n \n-    const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || []\n-\n     const issueFilter = {\n-      kinds: [GIT_ISSUE, COMMENT],\n+      kinds: [GIT_ISSUE],\n       \"#a\": [Address.fromEvent($repoEvent).toString()],\n     }\n \n     const {cleanup} = makeFeed({\n       element: element!,\n-      relays: relays,\n+      relays: repo.relays(),\n       feedFilters: [issueFilter],\n       subscriptionFilters: [issueFilter],\n       initialEvents: $issues,\n@@ -52,12 +59,10 @@\n \n   const onNewIssue = () =\u003e {\n     pushModal(NewIssueForm, {\n-      selectedRepos: [],\n-      onClose: () =\u003e {},\n+      repoId: $repoEvent.id,\n+      repoOwnerPubkey: $repoEvent.pubkey,\n     })\n   }\n-\n-\n \u003c/script\u003e\n \n \u003cdiv bind:this={element}\u003e\n@@ -99,7 +104,7 @@\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each $issues as issue (issue.id)}\n         \u003cdiv in:fly\u003e\n-          \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)} /\u003e\n+          \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)} comments={$comments} /\u003e\n         \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex fdc05e1..bc19b94 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -1,7 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n   import {Button, IssueCard, PatchCard} from \"@nostr-git/ui\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n-  import {Address, GIT_PATCH, type TrustedEvent} from \"@welshman/util\"\n+  import {Address, type TrustedEvent} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n   import {nthEq} from \"@welshman/lib\"\n   import {deriveProfile, repository} from \"@welshman/app\"\n@@ -11,6 +11,7 @@\n   import {type RepoStateEvent} from \"@nostr-git/shared-types\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {\n+    GIT_PATCH,\n     GIT_STATUS_OPEN,\n     GIT_STATUS_COMPLETE,\n     GIT_STATUS_CLOSED,\n@@ -26,6 +27,7 @@\n     state: () =\u003e Readable\u003cRepoStateEvent\u003e\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n     patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    relays: () =\u003e string[]\n   }\u003e(\"repo\")\n \n   const patches = $state(repo.patches())\n@@ -34,12 +36,16 @@\n     if ($patches) {\n       const filters = $patches.map(patch =\u003e {\n         return {\n-          kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+          kinds: [\n+            GIT_STATUS_OPEN,\n+            GIT_STATUS_COMPLETE,\n+            GIT_STATUS_CLOSED,\n+            GIT_STATUS_DRAFT,\n+          ],\n           \"#e\": [patch.id],\n         }\n       })\n-      const [tagId, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || []\n-      load({relays: relays, filters})\n+      load({relays: repo.relays(), filters})\n       return deriveEvents(repository, {filters})\n     }\n   })\n@@ -48,14 +54,15 @@\n     if ($patches) {\n       return $patches.map(patch =\u003e {\n         const profile = deriveProfile(patch.pubkey)\n-        let status = $statuses?.filter(s =\u003e {\n-          let [tagId, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n-          return eventId === patch.id\n-        }).sort(\n-          (a: TrustedEvent, b: TrustedEvent) =\u003e b.created_at - a.created_at,\n-        )[0]\n+        let status = $statuses\n+          ?.filter(s =\u003e {\n+            let [tagId, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n+            return eventId === patch.id\n+          })\n+          .sort((a: TrustedEvent, b: TrustedEvent) =\u003e b.created_at - a.created_at)[0]\n         return {\n           ...patch,\n+          patches: $patches.filter(issue =\u003e issue.tags.find(nthEq(0, \"e\"))?.[1] === patch.id),\n           status,\n           profile,\n         }\n@@ -71,8 +78,6 @@\n       loading = false\n     }\n \n-    const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || []\n-\n     const patchFilter = {\n       kinds: [GIT_PATCH],\n       \"#a\": [Address.fromEvent($repoEvent).toString()],\n@@ -80,7 +85,7 @@\n \n     const {cleanup} = makeFeed({\n       element: element!,\n-      relays: relays,\n+      relays: repo.relays(),\n       feedFilters: [patchFilter],\n       subscriptionFilters: [patchFilter],\n       initialEvents: $patches,\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 8a99209..7489b0f 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -5,23 +5,36 @@\n   import {type RepoStateEvent, type TrustedEvent} from \"@nostr-git/shared-types\"\n   import {Button} from \"@nostr-git/ui\"\n   import {Avatar, AvatarFallback, AvatarImage, DiffViewer, IssueThread} from \"@nostr-git/ui\"\n-  import {deriveProfile} from \"@welshman/app\"\n+  import {deriveProfile, repository} from \"@welshman/app\"\n   import {getContext} from \"svelte\"\n   import type {Readable} from \"svelte/motion\"\n   import markdownit from \"markdown-it\"\n+  import {deriveEvents} from \"@welshman/store\"\n+  import {load} from \"@welshman/net\"\n+  import {COMMENT, GIT_PATCH} from \"@welshman/util\"\n+    import { nthEq } from \"@welshman/lib\"\n \n   const repo = getContext\u003c{\n     repo: Readable\u003cTrustedEvent\u003e\n     state: () =\u003e Readable\u003cRepoStateEvent\u003e\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n     patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    relays: () =\u003e string[]\n   }\u003e(\"repo\")\n \n   const patches = $derived(repo.patches())\n \n+  const patchSet = $derived.by(() =\u003e {\n+    if (patch) {\n+      const filters = [{kinds: [GIT_PATCH], \"#e\": [patch.id]}]\n+      load({relays: repo.relays(), filters})\n+      return deriveEvents(repository, {filters})\n+    }\n+  })\n+\n   const patch = $derived.by(() =\u003e {\n     if ($patches) {\n-      const p = $patches.find(patch =\u003e patch.id === $page.params.patchid)\n+      const p = $patches.find(p =\u003e p.id === $page.params.patchid)\n       if (p) {\n         return parseGitPatchFromEvent(p)\n       }\n@@ -29,9 +42,11 @@\n   })\n \n   const threadComments = $derived.by(() =\u003e {\n-    if (patch) {\n-      console.log(patch)\n-      return []\n+    if ($patchSet) {\n+      console.log($patchSet)\n+      const filters = [{kinds: [COMMENT], \"#e\": $patchSet.map(patch =\u003e patch.tags.find(nthEq(0, \"e\"))?.[1])}]\n+      load({relays: repo.relays(), filters})\n+      return deriveEvents(repository, {filters})\n     }\n   })\n \n@@ -46,17 +61,16 @@\n     linkify: true,\n     typographer: true,\n   })\n-\n \u003c/script\u003e\n \n {#if patch}\n-\u003cdiv class=\"z-10 sticky top-0 items-center justify-between py-4 backdrop-blur\"\u003e\n-  \u003cdiv\u003e\n-    \u003cdiv class=\"rounded-lg border border-border bg-card p-6\"\u003e\n-      \u003cdiv class=\"mb-4 flex items-start justify-between\"\u003e\n-        \u003cdiv class=\"flex items-start gap-4\"\u003e\n-          {#if patch?.status === \"open\"}\n-            \u003cdiv class=\"mt-1\"\u003e\n+  \u003cdiv class=\"z-10 sticky top-0 items-center justify-between py-4 backdrop-blur\"\u003e\n+    \u003cdiv\u003e\n+      \u003cdiv class=\"rounded-lg border border-border bg-card p-6\"\u003e\n+        \u003cdiv class=\"mb-4 flex items-start justify-between\"\u003e\n+          \u003cdiv class=\"flex items-start gap-4\"\u003e\n+            {#if patch?.status === \"open\"}\n+              \u003cdiv class=\"mt-1\"\u003e\n                 \u003cdiv\n                   class=\"flex h-10 w-10 items-center justify-center rounded-full bg-amber-500/10\"\u003e\n                   \u003cGitCommit class=\"h-5 w-5 text-amber-500\" /\u003e\n@@ -133,10 +147,10 @@\n         \u003cdiv class=\"space-y-4\"\u003e\n           \u003ch2 class=\"flex items-center gap-2 text-lg font-medium\"\u003e\n             \u003cMessageSquare class=\"h-5 w-5\" /\u003e\n-            Discussion ({threadComments?.length})\n+            Discussion ({$threadComments?.length})\n           \u003c/h2\u003e\n \n-          \u003cIssueThread issueId={patch?.id} comments={threadComments} /\u003e\n+          \u003cIssueThread issueId={patch?.id} comments={$threadComments} /\u003e\n         \u003c/div\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-objyn0mm","title":"From 8a27c89f04c63e5675e714554f8c74c9b81691a9 Mon Sep 17 00:00:00 2001","description":"From 8a27c89f04c63e5675e714554f8c74c9b81691a9 Mon Sep 17 00:00:00 2001\nFrom: Five \u003cco22rkn@protonmail.com\u003e\nDate: Fri, 20 Jun 2025 12:25:41 +0200\nSubject: [PATCH 5/8] Enable adding git repos while fetching the tracked ones - Since repo loading is reactively passed into the RepoPicker it is not necessarily a problem if we edit repos while loading Although it was problematic when user had zero repos and the long loading blocked user to add repos\n\n---\n src/routes/spaces/[relay]/git/+page.svelte | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 9facc8e..8fbb669 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -109,7 +109,7 @@\n   {/snippet}\n   {#snippet action()}\n     \u003cdiv class=\"row-2\"\u003e\n-      \u003cButton class=\"btn btn-primary btn-sm\" disabled={loading} onclick={onAddRepo}\u003e\n+      \u003cButton class=\"btn btn-primary btn-sm\" onclick={onAddRepo}\u003e\n         \u003cIcon icon=\"git\" /\u003e\n         Add Repo\n       \u003c/Button\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-ofm48p9c","title":"From f189779b334ec5cd04871324d4b8f11b7d75986a Mon Sep 17 00:00:00 2001","description":"From f189779b334ec5cd04871324d4b8f11b7d75986a Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 12 Aug 2025 12:19:39 -0700\nSubject: [PATCH 2/6] refactor: remove unused commit prop from MergeAnalyzer component\n\n---\n packages/nostr-git                                              | 2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte | 3 +--\n 2 files changed, 2 insertions(+), 3 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 1b674bf..1e1f587 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 1b674bff42659c421071bfd25e54dcdc41a36671\n+Subproject commit 1e1f58716df6dc7cd56e00879591812db93b3204\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\nindex 575a597..5feeb84 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n@@ -206,8 +206,7 @@\n             \u003cTabsContent value=\"analyzer\"\u003e\n               \u003cMergeAnalyzer\n                 analysis={mergeAnalysis}\n-                patch={selectedPatch}\n-                commit={selectedCommit} /\u003e\n+                patch={selectedPatch} /\u003e\n             \u003c/TabsContent\u003e\n \n             \u003cTabsContent value=\"conflicts\"\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-oz9usfu4","title":"From 82e1f5d3e1caa49aecea98abe07cdfb06b3f8a06 Mon Sep 17 00:00:00 2001","description":"From 82e1f5d3e1caa49aecea98abe07cdfb06b3f8a06 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Fri, 28 Nov 2025 16:09:30 +0500\nSubject: [PATCH] chore: update nostr-git submodule and remove purplepag.es relay\n\nThis commit updates dependencies and configuration for improved\nrepository creation functionality.\n\n## Changes\n\n### .env Configuration\n- Remove wss://purplepag.es/ from VITE_INDEXER_RELAYS\n\n### Submodule Update: packages/nostr-git\nUpdate from 181d6ed7 to 4efc313f\n\nIncludes the following improvements:\n- Fix repo creation wizard UX with better keyboard navigation\n- Add case-insensitive duplicate tag detection\n- Implement chip-based tag display UI\n- Fix URL generation to use actual pubkey instead of placeholders\n- Improve autocomplete dropdown behavior across all components\n- Add auto-scroll on wizard step changes\n- Refactor relay handling to use sanitizeRelays utility\n---\n .env               | 2 +-\n packages/nostr-git | 2 +-\n 2 files changed, 2 insertions(+), 2 deletions(-)\n\ndiff --git a/.env b/.env\nindex c19ca9b..cdf04bc 100644\n--- a/.env\n+++ b/.env\n@@ -10,7 +10,7 @@ VITE_PLATFORM_RELAYS=wss://budabit.nostr1.com/\n VITE_PLATFORM_ACCENT=\"#D4AF37\"\n VITE_PLATFORM_SECONDARY=\"#EB5E28\"\n VITE_PLATFORM_DESCRIPTION=\"The Club for Builders in Freedom Tech.\"\n-VITE_INDEXER_RELAYS=wss://purplepag.es/,wss://relay.damus.io/,wss://relay.nostr.band/\n+VITE_INDEXER_RELAYS=wss://relay.damus.io/,wss://relay.nostr.band/\n VITE_SIGNER_RELAYS=wss://relay.nsec.app/,wss://bucket.coracle.social/\n VITE_NOTIFIER_PUBKEY=27b7c2ed89ef78322114225ea3ebf5f72c7767c2528d4d0c1854d039c00085df\n VITE_NOTIFIER_RELAY=wss://anchor.coracle.social/\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 181d6ed..4efc313 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 181d6ed732987ebf719f88b87d6d9dd8b619679c\n+Subproject commit 4efc313fbe32818bfc24bb02e32b3ae90a5a1900\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-p5zlk9u2","title":"From ebd491e1666477cb26fca357e92444fe9502ae59 Mon Sep 17 00:00:00 2001","description":"From ebd491e1666477cb26fca357e92444fe9502ae59 Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/2] Feature Gating\n\nfeat(terminal): add feature flag for conditional Terminal component loading","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-p6natzfo","title":"From a60f7e6d365dd011309e12be5834a2ce6ab81706 Mon Sep 17 00:00:00 2001","description":"From a60f7e6d365dd011309e12be5834a2ce6ab81706 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Fri, 6 Jun 2025 15:12:27 -0700\nSubject: [PATCH 1/4] feat: patch workshop\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 | 67 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte            | 31 ++++++++++++++++++-------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           | 31 ++++++++++++++++++-------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 44 +++++++++++++++++++++++++++++---------------\n 4 files changed, 123 insertions(+), 50 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 06b3626..db36f2e 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -1,26 +1,30 @@\n \u003cscript lang=\"ts\"\u003e\n   import {RepoHeader, RepoTab} from \"@nostr-git/ui\"\n   import {page} from \"$app/stores\"\n-  import {deriveNaddrEvent} from \"@app/state\"\n+  import {decodeRelay, deriveNaddrEvent, userSettingValues} from \"@app/state\"\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n-  import {FileCode, GitBranch, CircleAlert, GitPullRequest} from \"@lucide/svelte\"\n-  import {parseRepoAnnouncementEvent, type RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n+  import {FileCode, GitBranch, CircleAlert, GitPullRequest, Layers} from \"@lucide/svelte\"\n+  import {\n+    parseRepoAnnouncementEvent,\n+    type CommentEvent,\n+    type IssueEvent,\n+    type RepoAnnouncementEvent,\n+  } from \"@nostr-git/shared-types\"\n   import {setContext} from \"svelte\"\n   import {deriveEvents} from \"@welshman/store\"\n-  import {repository} from \"@welshman/app\"\n+  import {deriveProfile, publishThunk, repository} from \"@welshman/app\"\n   import {GIT_REPO_STATE} from \"@src/lib/util\"\n   import {derived as _derived} from \"svelte/store\"\n   import {Address, GIT_ISSUE, GIT_PATCH, type Filter} from \"@welshman/util\"\n   import {load} from \"@welshman/net\"\n   import {nthEq} from \"@welshman/lib\"\n   import {Buffer} from \"buffer\"\n-\n   const {id, relay} = $page.params\n \n   let {children} = $props()\n \n   if (typeof window !== \"undefined\" \u0026\u0026 !window.Buffer) {\n-    (window as any).Buffer = Buffer;\n+    ;(window as any).Buffer = Buffer\n   }\n \n   let eventStore = $state(deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay]))\n@@ -29,7 +33,10 @@\n     if ($eventStore) {\n       const repoEvent = parseRepoAnnouncementEvent($eventStore as RepoAnnouncementEvent)\n       const address = repoEvent.repoId\n-      const repoStateFilter = [{kinds: [GIT_REPO_STATE], \"#d\": [address]}]\n+      const repoStateFilter: Filter[] = [\n+        {kinds: [GIT_REPO_STATE], \"#d\": [address!]},\n+        {kinds: [GIT_REPO_STATE], \"#d\": [address!], \"#t\": [\"root\"]},\n+      ]\n       const repoState = _derived(\n         deriveEvents(repository, {filters: repoStateFilter}),\n         events =\u003e events[0],\n@@ -57,11 +64,45 @@\n \n   setContext(\"repo-event\", eventStore)\n \n+  const url = decodeRelay($page.params.relay)\n+\n+  const relays = $derived.by(() =\u003e {\n+    if ($eventStore) {\n+      const [_, ...relays] = $eventStore.tags.find(nthEq(0, \"relays\")) || []\n+      return [url, ...relays]\n+    }\n+  })\n+\n+  const postComment = (comment: CommentEvent) =\u003e {\n+    publishThunk({\n+      relays: [url],\n+      event: comment,\n+    })\n+  }\n+\n+  setContext(\"postComment\", postComment)\n+\n+  const postIssue = (issue: IssueEvent) =\u003e {\n+    publishThunk({\n+      relays: [url],\n+      event: issue,\n+    })\n+  }\n+\n+  setContext(\"postIssue\", postIssue)\n+\n+  const getProfile = (pubkey: string) =\u003e {\n+    return deriveProfile(pubkey)\n+  }\n+\n+  setContext(\"getProfile\", deriveProfile)\n+\n   const repo = $state({\n     repo: eventStore,\n     state: () =\u003e repoState,\n     issues: () =\u003e issues,\n     patches: () =\u003e patches,\n+    relays: () =\u003e relays,\n   })\n \n   setContext(\"repo\", repo)\n@@ -76,10 +117,9 @@\n       const repoStateFilter: Filter = {kinds: [GIT_REPO_STATE], \"#d\": [address]}\n       const issuesFilter: Filter = {kinds: [GIT_ISSUE], \"#a\": [address]}\n       const patchesFilter: Filter = {kinds: [GIT_PATCH], \"#a\": [address]}\n-      const [tagId, ...relays] = $eventStore.tags.find(nthEq(0, \"relays\")) ?? []\n \n       load({\n-        relays: relays,\n+        relays: relays!,\n         filters: [issuesFilter, patchesFilter, repoStateFilter],\n       })\n     }\n@@ -130,6 +170,15 @@\n             \u003cGitPullRequest class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n+        \u003cRepoTab\n+          tabValue=\"workbench\"\n+          label=\"Workbench\"\n+          href={`/spaces/${encodeddRelay}/git/${id}/workbench`}\n+          {activeTab}\u003e\n+          {#snippet icon()}\n+            \u003cLayers class=\"h-4 w-4\" /\u003e\n+          {/snippet}\n+        \u003c/RepoTab\u003e\n       {/snippet}\n     \u003c/RepoHeader\u003e\n     {@render children()}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex d30eaa5..875351d 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -3,14 +3,15 @@\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Address, COMMENT, GIT_ISSUE, type TrustedEvent} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n-  import {nthEq} from \"@welshman/lib\"\n-  import {deriveProfile, repository} from \"@welshman/app\"\n+  import {deriveProfile, relays, repository} from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {makeFeed} from \"@src/app/requests\"\n   import type {Readable} from \"svelte/store\"\n   import {type RepoStateEvent} from \"@nostr-git/shared-types\"\n   import {fly} from \"@lib/transition\"\n   import {pushModal} from \"@src/app/modal\"\n+  import {load} from \"@welshman/net\"\n+  import {deriveEvents} from \"@welshman/store\"\n \n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n@@ -18,10 +19,18 @@\n     repo: Readable\u003cTrustedEvent\u003e\n     state: () =\u003e Readable\u003cRepoStateEvent\u003e\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    relays: () =\u003e string[]\n   }\u003e(\"repo\")\n \n-  let issues = repo.issues()\n-  const comments: TrustedEvent[] = $state([])\n+  const issues = repo.issues()\n+\n+  const comments = $derived.by(() =\u003e {\n+    if ($issues) {\n+      const filters = $issues.map(issue =\u003e issue.id)\n+      load({relays: repo.relays(), filters: [{kinds: [COMMENT], \"#E\": filters}]})\n+      return deriveEvents(repository, {filters: [{kinds: [COMMENT], \"#E\": filters}]})\n+    }\n+  })\n \n   let loading = $state(true)\n   let element: HTMLElement | undefined = $state()\n@@ -31,16 +40,14 @@\n       loading = false\n     }\n \n-    const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || []\n-\n     const issueFilter = {\n-      kinds: [GIT_ISSUE, COMMENT],\n+      kinds: [GIT_ISSUE],\n       \"#a\": [Address.fromEvent($repoEvent).toString()],\n     }\n \n     const {cleanup} = makeFeed({\n       element: element!,\n-      relays: relays,\n+      relays: repo.relays(),\n       feedFilters: [issueFilter],\n       subscriptionFilters: [issueFilter],\n       initialEvents: $issues,\n@@ -52,12 +59,10 @@\n \n   const onNewIssue = () =\u003e {\n     pushModal(NewIssueForm, {\n-      selectedRepos: [],\n-      onClose: () =\u003e {},\n+      repoId: $repoEvent.id,\n+      repoOwnerPubkey: $repoEvent.pubkey,\n     })\n   }\n-\n-\n \u003c/script\u003e\n \n \u003cdiv bind:this={element}\u003e\n@@ -99,7 +104,7 @@\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each $issues as issue (issue.id)}\n         \u003cdiv in:fly\u003e\n-          \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)} /\u003e\n+          \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)} comments={$comments} /\u003e\n         \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex fdc05e1..bc19b94 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -1,7 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n   import {Button, IssueCard, PatchCard} from \"@nostr-git/ui\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n-  import {Address, GIT_PATCH, type TrustedEvent} from \"@welshman/util\"\n+  import {Address, type TrustedEvent} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n   import {nthEq} from \"@welshman/lib\"\n   import {deriveProfile, repository} from \"@welshman/app\"\n@@ -11,6 +11,7 @@\n   import {type RepoStateEvent} from \"@nostr-git/shared-types\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {\n+    GIT_PATCH,\n     GIT_STATUS_OPEN,\n     GIT_STATUS_COMPLETE,\n     GIT_STATUS_CLOSED,\n@@ -26,6 +27,7 @@\n     state: () =\u003e Readable\u003cRepoStateEvent\u003e\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n     patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    relays: () =\u003e string[]\n   }\u003e(\"repo\")\n \n   const patches = $state(repo.patches())\n@@ -34,12 +36,16 @@\n     if ($patches) {\n       const filters = $patches.map(patch =\u003e {\n         return {\n-          kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+          kinds: [\n+            GIT_STATUS_OPEN,\n+            GIT_STATUS_COMPLETE,\n+            GIT_STATUS_CLOSED,\n+            GIT_STATUS_DRAFT,\n+          ],\n           \"#e\": [patch.id],\n         }\n       })\n-      const [tagId, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || []\n-      load({relays: relays, filters})\n+      load({relays: repo.relays(), filters})\n       return deriveEvents(repository, {filters})\n     }\n   })\n@@ -48,14 +54,15 @@\n     if ($patches) {\n       return $patches.map(patch =\u003e {\n         const profile = deriveProfile(patch.pubkey)\n-        let status = $statuses?.filter(s =\u003e {\n-          let [tagId, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n-          return eventId === patch.id\n-        }).sort(\n-          (a: TrustedEvent, b: TrustedEvent) =\u003e b.created_at - a.created_at,\n-        )[0]\n+        let status = $statuses\n+          ?.filter(s =\u003e {\n+            let [tagId, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n+            return eventId === patch.id\n+          })\n+          .sort((a: TrustedEvent, b: TrustedEvent) =\u003e b.created_at - a.created_at)[0]\n         return {\n           ...patch,\n+          patches: $patches.filter(issue =\u003e issue.tags.find(nthEq(0, \"e\"))?.[1] === patch.id),\n           status,\n           profile,\n         }\n@@ -71,8 +78,6 @@\n       loading = false\n     }\n \n-    const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || []\n-\n     const patchFilter = {\n       kinds: [GIT_PATCH],\n       \"#a\": [Address.fromEvent($repoEvent).toString()],\n@@ -80,7 +85,7 @@\n \n     const {cleanup} = makeFeed({\n       element: element!,\n-      relays: relays,\n+      relays: repo.relays(),\n       feedFilters: [patchFilter],\n       subscriptionFilters: [patchFilter],\n       initialEvents: $patches,\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 8a99209..7489b0f 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -5,23 +5,36 @@\n   import {type RepoStateEvent, type TrustedEvent} from \"@nostr-git/shared-types\"\n   import {Button} from \"@nostr-git/ui\"\n   import {Avatar, AvatarFallback, AvatarImage, DiffViewer, IssueThread} from \"@nostr-git/ui\"\n-  import {deriveProfile} from \"@welshman/app\"\n+  import {deriveProfile, repository} from \"@welshman/app\"\n   import {getContext} from \"svelte\"\n   import type {Readable} from \"svelte/motion\"\n   import markdownit from \"markdown-it\"\n+  import {deriveEvents} from \"@welshman/store\"\n+  import {load} from \"@welshman/net\"\n+  import {COMMENT, GIT_PATCH} from \"@welshman/util\"\n+    import { nthEq } from \"@welshman/lib\"\n \n   const repo = getContext\u003c{\n     repo: Readable\u003cTrustedEvent\u003e\n     state: () =\u003e Readable\u003cRepoStateEvent\u003e\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n     patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    relays: () =\u003e string[]\n   }\u003e(\"repo\")\n \n   const patches = $derived(repo.patches())\n \n+  const patchSet = $derived.by(() =\u003e {\n+    if (patch) {\n+      const filters = [{kinds: [GIT_PATCH], \"#e\": [patch.id]}]\n+      load({relays: repo.relays(), filters})\n+      return deriveEvents(repository, {filters})\n+    }\n+  })\n+\n   const patch = $derived.by(() =\u003e {\n     if ($patches) {\n-      const p = $patches.find(patch =\u003e patch.id === $page.params.patchid)\n+      const p = $patches.find(p =\u003e p.id === $page.params.patchid)\n       if (p) {\n         return parseGitPatchFromEvent(p)\n       }\n@@ -29,9 +42,11 @@\n   })\n \n   const threadComments = $derived.by(() =\u003e {\n-    if (patch) {\n-      console.log(patch)\n-      return []\n+    if ($patchSet) {\n+      console.log($patchSet)\n+      const filters = [{kinds: [COMMENT], \"#e\": $patchSet.map(patch =\u003e patch.tags.find(nthEq(0, \"e\"))?.[1])}]\n+      load({relays: repo.relays(), filters})\n+      return deriveEvents(repository, {filters})\n     }\n   })\n \n@@ -46,17 +61,16 @@\n     linkify: true,\n     typographer: true,\n   })\n-\n \u003c/script\u003e\n \n {#if patch}\n-\u003cdiv class=\"z-10 sticky top-0 items-center justify-between py-4 backdrop-blur\"\u003e\n-  \u003cdiv\u003e\n-    \u003cdiv class=\"rounded-lg border border-border bg-card p-6\"\u003e\n-      \u003cdiv class=\"mb-4 flex items-start justify-between\"\u003e\n-        \u003cdiv class=\"flex items-start gap-4\"\u003e\n-          {#if patch?.status === \"open\"}\n-            \u003cdiv class=\"mt-1\"\u003e\n+  \u003cdiv class=\"z-10 sticky top-0 items-center justify-between py-4 backdrop-blur\"\u003e\n+    \u003cdiv\u003e\n+      \u003cdiv class=\"rounded-lg border border-border bg-card p-6\"\u003e\n+        \u003cdiv class=\"mb-4 flex items-start justify-between\"\u003e\n+          \u003cdiv class=\"flex items-start gap-4\"\u003e\n+            {#if patch?.status === \"open\"}\n+              \u003cdiv class=\"mt-1\"\u003e\n                 \u003cdiv\n                   class=\"flex h-10 w-10 items-center justify-center rounded-full bg-amber-500/10\"\u003e\n                   \u003cGitCommit class=\"h-5 w-5 text-amber-500\" /\u003e\n@@ -133,10 +147,10 @@\n         \u003cdiv class=\"space-y-4\"\u003e\n           \u003ch2 class=\"flex items-center gap-2 text-lg font-medium\"\u003e\n             \u003cMessageSquare class=\"h-5 w-5\" /\u003e\n-            Discussion ({threadComments?.length})\n+            Discussion ({$threadComments?.length})\n           \u003c/h2\u003e\n \n-          \u003cIssueThread issueId={patch?.id} comments={threadComments} /\u003e\n+          \u003cIssueThread issueId={patch?.id} comments={$threadComments} /\u003e\n         \u003c/div\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-pak24s9x","title":"From 76e3abe2a63eb7d7c4b5009284a0b76348f3fbbb Mon Sep 17 00:00:00 2001","description":"From 76e3abe2a63eb7d7c4b5009284a0b76348f3fbbb Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 18 Jan 2026 22:01:40 +0500\nSubject: [PATCH] feat: integrate repository import feature into main application\n\nIntegrate the repository import functionality from the nostr-git submodule\ninto the main application, enabling users to import repositories from Git\nhosting platforms (GitHub, GitLab, Gitea, Bitbucket) directly from the UI.\n\nDocumentation:\n- Add import-repo-architecture.md: Comprehensive architecture documentation\n  covering the import process flow, rate limiting strategies for both Git\n  provider APIs and Nostr relays, error handling, and system design\n  - Includes detailed Mermaid diagrams showing component relationships\n  - Documents proactive throttling, retry mechanisms, and batch publishing\n  - Explains user profile mapping and comment threading preservation\n\nSubmodule Update:\n- Update packages/nostr-git submodule to commit 6c77b256\n  - Includes complete import feature implementation with core utilities,\n    UI components, and provider integrations\n\nUI Integration:\n- Add ImportRepoDialogWrapper.svelte: Wrapper component that provides\n  ConfigProvider context for the ImportRepoDialog component from\n  @nostr-git/ui package, enabling proper dependency injection\n\nGit Repository Page (+page.svelte):\n- Add Import Repository button in page header with download icon\n- Implement onImportRepo handler with full integration:\n  - Session and authentication validation\n  - Signer support (NIP-01, NIP-07, NIP-46) via getSigner\n  - Modal dialog integration with fullscreen support\n  - Event publishing with GRASP relay support (kinds 30617/30618)\n  - Automatic relay selection from event tags and default relays\n  - Import completion callbacks with statistics display\n  - Navigation to imported repository after successful import\n  - Repository list refresh after import completion\n- Add necessary imports: ImportRepoDialogWrapper, ImportResult type,\n  Download icon, clearModals utility, session from app context\n- Code formatting improvements: consistent spacing, quote style,\n  and formatting for better readability\n\nThis integration provides a seamless user experience for importing\nrepositories from external Git platforms into the Nostr Git system,\nwith proper error handling, progress tracking, and automatic\nnavigation to imported repositories.\n---\n docs/import-repo-architecture.md                              | 380 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n packages/nostr-git                                            |   2 +-\n src/app/components/ImportRepoDialogWrapper.svelte             |   9 +++++++++\n src/routes/spaces/[relay]/git/+page.svelte                    | 170 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte |  26 +++++++++++++++++++-------\n 5 files changed, 552 insertions(+), 35 deletions(-)\n create mode 100644 docs/import-repo-architecture.md\n create mode 100644 src/app/components/ImportRepoDialogWrapper.svelte\n\ndiff --git a/docs/import-repo-architecture.md b/docs/import-repo-architecture.md\nnew file mode 100644\nindex 0000000..db4df27\n--- /dev/null\n+++ b/docs/import-repo-architecture.md\n@@ -0,0 +1,380 @@\n+# Import Repository Feature Architecture\n+\n+## Overview\n+\n+This document describes the architecture and rate limiting strategies for the repository import feature, which imports repositories from Git hosting providers (GitHub, GitLab, Gitea, Bitbucket) into the Nostr Git system.\n+\n+## Architecture Diagram\n+\n+```mermaid\n+flowchart TB\n+    subgraph \"User Interface\"\n+        UI[ImportRepoDialog]\n+        Hook[useImportRepo Hook]\n+    end\n+\n+    subgraph \"Import Process Flow\"\n+        Start[Start Import]\n+        Parse[Parse URL \u0026 Detect Provider]\n+        Validate[Validate Token \u0026 Ownership]\n+        Fork{Fork\u003cbr/\u003eRequired?}\n+        Fetch[Fetch Repository Metadata]\n+        ConvertRepo[Convert Repo to Nostr Events]\n+        PublishRepo[Publish Repo Events]\n+        StreamIssues[Stream \u0026 Publish Issues]\n+        StreamPRs[Stream \u0026 Publish PRs]\n+        StreamComments[Stream \u0026 Publish Comments]\n+        PublishProfiles[Publish User Profiles]\n+        Complete[Import Complete]\n+    end\n+\n+    subgraph \"Git Provider API Layer\"\n+        GitHub[GitHub API]\n+        GitLab[GitLab API]\n+        Gitea[Gitea API]\n+        Bitbucket[Bitbucket API]\n+    end\n+\n+    subgraph \"Git Provider Rate Limiting\"\n+        GitRateLimiter[RateLimiter Class]\n+        ProactiveThrottle[Proactive Throttling\u003cbr/\u003e250ms between requests]\n+        RetryMechanism[Retry Mechanism\u003cbr/\u003eExponential Backoff]\n+        RateLimitTrack[Rate Limit Tracking\u003cbr/\u003eX-RateLimit-* headers]\n+    end\n+\n+    subgraph \"Nostr Relay Layer\"\n+        Relay1[Nostr Relay 1]\n+        Relay2[Nostr Relay 2]\n+        RelayN[Nostr Relay N]\n+    end\n+\n+    subgraph \"Relay Rate Limiting\"\n+        BatchPublisher[Batch Event Publisher]\n+        BatchQueue[Event Queue\u003cbr/\u003ecollects events]\n+        BatchFlush[Flush Batch\u003cbr/\u003epublish in parallel]\n+        BatchDelay[Delay Between Batches\u003cbr/\u003e250ms default]\n+    end\n+\n+    Start --\u003e Parse\n+    Parse --\u003e Validate\n+    Validate --\u003e Fork\n+    Fork --\u003e|Not Owner| Fork\n+    Fork --\u003e|Owner or Forked| Fetch\n+    Fetch --\u003e ConvertRepo\n+    ConvertRepo --\u003e PublishRepo\n+    PublishRepo --\u003e StreamIssues\n+    StreamIssues --\u003e StreamPRs\n+    StreamPRs --\u003e StreamComments\n+    StreamComments --\u003e PublishProfiles\n+    PublishProfiles --\u003e Complete\n+\n+    UI --\u003e Hook\n+    Hook --\u003e Start\n+\n+    Parse --\u003e GitHub\n+    Parse --\u003e GitLab\n+    Parse --\u003e Gitea\n+    Parse --\u003e Bitbucket\n+\n+    GitHub --\u003e GitRateLimiter\n+    GitLab --\u003e GitRateLimiter\n+    Gitea --\u003e GitRateLimiter\n+    Bitbucket --\u003e GitRateLimiter\n+\n+    GitRateLimiter --\u003e ProactiveThrottle\n+    GitRateLimiter --\u003e RetryMechanism\n+    GitRateLimiter --\u003e RateLimitTrack\n+\n+    PublishRepo --\u003e BatchPublisher\n+    StreamIssues --\u003e BatchPublisher\n+    StreamPRs --\u003e BatchPublisher\n+    StreamComments --\u003e BatchPublisher\n+    PublishProfiles --\u003e BatchPublisher\n+\n+    BatchPublisher --\u003e BatchQueue\n+    BatchQueue --\u003e BatchFlush\n+    BatchFlush --\u003e BatchDelay\n+    BatchDelay --\u003e Relay1\n+    BatchDelay --\u003e Relay2\n+    BatchDelay --\u003e RelayN\n+\n+    style GitRateLimiter fill:#f96,stroke:#333,stroke-width:3px\n+    style BatchPublisher fill:#69f,stroke:#333,stroke-width:3px\n+    style ProactiveThrottle fill:#fc9,stroke:#333,stroke-width:2px\n+    style RetryMechanism fill:#fc9,stroke:#333,stroke-width:2px\n+    style RateLimitTrack fill:#fc9,stroke:#333,stroke-width:2px\n+```\n+\n+## Rate Limiting Strategies\n+\n+### Git Provider Rate Limiting (Three-Layer Approach)\n+\n+The system implements a three-layer rate limiting strategy for Git provider APIs:\n+\n+#### Layer 1: Proactive Request Throttling\n+\n+- **Purpose**: Prevent hitting rate limits in the first place\n+- **Implementation**: Minimum 250ms delay between requests (configurable via `secondsBetweenRequests`)\n+- **Measurement**: Delay measured from end of previous request, not start\n+- **Location**: `RateLimiter.throttle()` method\n+\n+```typescript\n+// Example: Always wait at least 250ms between GitHub API requests\n+await rateLimiter.throttle(\"github\", \"GET\")\n+const data = await api.listIssues(owner, repo)\n+```\n+\n+#### Layer 2: Retry Mechanism with Backoff\n+\n+- **Purpose**: Handle rate limit errors gracefully\n+- **Error Detection**:\n+  - HTTP 403 status code\n+  - Response body containing \"rate limit exceeded\"\n+  - Response headers: `Retry-After`, `X-RateLimit-Reset`\n+- **Retry Strategy**:\n+  - **Primary Rate Limit**: Uses `X-RateLimit-Reset` header to calculate exact wait time\n+  - **Secondary Rate Limit** (abuse detection): Fixed 60-second wait (configurable via `secondaryRateWait`)\n+  - **5xx Server Errors**: Exponential backoff (1s, 2s, 4s, ...)\n+  - **Max Retries**: 3 attempts (configurable via `maxRetries`)\n+- **Location**: `RateLimiter.shouldRetry()` method\n+\n+#### Layer 3: Rate Limit Status Tracking\n+\n+- **Purpose**: Monitor remaining quota to inform users\n+- **Tracking**: Extracts and stores `X-RateLimit-*` headers:\n+  - `X-RateLimit-Remaining`: Requests left in window\n+  - `X-RateLimit-Limit`: Total requests allowed\n+  - `X-RateLimit-Reset`: Unix timestamp when limit resets\n+- **Usage**: Provides visibility into quota status\n+- **Location**: `RateLimiter.updateRateLimitStatus()` method\n+\n+### Relay Rate Limiting (Batched Publishing)\n+\n+For Nostr relays, a batched publishing approach is used to optimize performance:\n+\n+#### Batched Event Publishing\n+\n+- **Purpose**: Publish multiple events efficiently while respecting relay rate limits\n+- **Implementation**:\n+  - Events are collected into batches (default: 30 events per batch)\n+  - Events in each batch are published in parallel using `Promise.allSettled()`\n+  - A delay is applied between batches (default: 250ms)\n+- **Performance**: ~20x faster than per-event delays (e.g., 1000 events: ~8.5 seconds vs ~200 seconds)\n+- **Configuration**:\n+  - `relayBatchSize` in `ImportConfig` (default: 30 events)\n+  - `relayBatchDelay` in `ImportConfig` (default: 250ms)\n+- **Location**: `publishEventBatched()` and `flushEventQueue()` functions\n+\n+```typescript\n+// Example: Collect events into batches\n+await publishEventBatched(context, signedEvent)\n+// When batch reaches size (30), events are published in parallel\n+// Then wait 250ms before next batch\n+```\n+\n+#### Batch Flushing\n+\n+- Batches are automatically flushed when they reach the configured size\n+- Remaining events in the queue are flushed at the end of each phase (issues, PRs, comments, profiles)\n+- Final flush ensures all queued events are published before import completes\n+\n+#### No Retry Mechanism\n+\n+- Relays typically don't have the same aggressive rate limiting as Git providers\n+- Event publication failures are handled at a higher level (not retried automatically)\n+\n+## Detailed Flow with Rate Limiting\n+\n+```mermaid\n+sequenceDiagram\n+    participant User\n+    participant Hook as useImportRepo\n+    participant RateLimiter as Git Rate Limiter\n+    participant GitAPI as Git Provider API\n+    participant BatchPublisher as Batch Event Publisher\n+    participant Relay as Nostr Relay\n+\n+    User-\u003e\u003eHook: importRepository(repoUrl, token, config)\n+\n+    Note over Hook,RateLimiter: Initial Setup\n+    Hook-\u003e\u003eRateLimiter: Create RateLimiter(config)\n+    Hook-\u003e\u003eGitAPI: Parse URL \u0026 Detect Provider\n+\n+    Note over Hook,GitAPI: Validation Phase\n+    Hook-\u003e\u003eRateLimiter: throttle('github', 'GET')\n+    RateLimiter--\u003e\u003eHook: Wait 250ms\n+    Hook-\u003e\u003eGitAPI: validateTokenPermissions()\n+    GitAPI--\u003e\u003eHook: Response + X-RateLimit-* headers\n+    Hook-\u003e\u003eRateLimiter: updateRateLimitStatus(headers)\n+\n+    Hook-\u003e\u003eRateLimiter: throttle('github', 'GET')\n+    RateLimiter--\u003e\u003eHook: Wait 250ms\n+    Hook-\u003e\u003eGitAPI: checkRepoOwnership()\n+\n+    Note over Hook,GitAPI: Forking (if needed)\n+    alt Not Owner\n+        Hook-\u003e\u003eRateLimiter: throttle('github', 'POST')\n+        RateLimiter--\u003e\u003eHook: Wait 250ms\n+        Hook-\u003e\u003eGitAPI: forkRepo()\n+        GitAPI--\u003e\u003eHook: Forked Repository\n+    end\n+\n+    Note over Hook,GitAPI: Streaming Import Phase\n+    loop For Each Page of Issues\n+        Hook-\u003e\u003eRateLimiter: throttle('github', 'GET')\n+        RateLimiter--\u003e\u003eHook: Wait 250ms\n+        Hook-\u003e\u003eGitAPI: listIssues(page)\n+        alt Rate Limit Hit\n+            GitAPI--\u003e\u003eHook: HTTP 403 + Rate Limit Error\n+            Hook-\u003e\u003eRateLimiter: shouldRetry(error)\n+            RateLimiter--\u003e\u003eHook: {retry: true, delay: X}\n+            Hook-\u003e\u003eRateLimiter: waitWithProgress(delay)\n+            Note over RateLimiter: Shows progress: \"Rate limit hit, waiting X seconds...\"\n+            RateLimiter--\u003e\u003eHook: Wait Complete\n+            Hook-\u003e\u003eGitAPI: Retry request\n+        end\n+        GitAPI--\u003e\u003eHook: Issues Data\n+\n+        loop For Each Issue\n+            Hook-\u003e\u003eHook: Convert to Nostr Event\n+            Hook-\u003e\u003eBatchPublisher: Queue Event (batched)\n+            alt Batch Full (30 events)\n+                BatchPublisher-\u003e\u003eBatchPublisher: Flush Batch\n+                BatchPublisher-\u003e\u003eRelay: Publish All (parallel)\n+                BatchPublisher--\u003e\u003eHook: Wait 250ms\n+            end\n+        end\n+        Note over Hook,BatchPublisher: Flush remaining events\n+        BatchPublisher-\u003e\u003eRelay: Publish Remaining\n+    end\n+\n+    Note over Hook,GitAPI: Similar for PRs and Comments\n+    loop For Each Page of PRs/Comments\n+        Hook-\u003e\u003eRateLimiter: throttle('github', 'GET')\n+        Hook-\u003e\u003eGitAPI: Fetch Data\n+        Hook-\u003e\u003eBatchPublisher: Queue Events (batched)\n+        alt Batch Full\n+            BatchPublisher-\u003e\u003eRelay: Publish Batch (parallel)\n+            BatchPublisher--\u003e\u003eHook: Wait 250ms\n+        end\n+    end\n+    Note over Hook,BatchPublisher: Flush remaining events\n+\n+    Hook--\u003e\u003eUser: Import Complete\n+```\n+\n+## Rate Limit Error Handling\n+\n+```mermaid\n+stateDiagram-v2\n+    [*] --\u003e MakeRequest: API Call\n+    MakeRequest --\u003e Throttle: Before Request\n+    Throttle --\u003e CheckDelay: Check Time Since Last Request\n+    CheckDelay --\u003e Wait: Delay Required (\u003e250ms)\n+    CheckDelay --\u003e Execute: No Delay Needed\n+    Wait --\u003e Execute: Delay Complete\n+    Execute --\u003e Success: Request Succeeds\n+    Execute --\u003e Error: Request Fails\n+    Success --\u003e UpdateTracking: Update Rate Limit Status\n+    UpdateTracking --\u003e [*]\n+    Error --\u003e CheckRetry: Analyze Error\n+    CheckRetry --\u003e Retry: Rate Limit Error + Retries Left\n+    CheckRetry --\u003e Fail: Non-Retriable Error\n+    CheckRetry --\u003e Fail: Max Retries Exceeded\n+    Retry --\u003e CalculateWait: Determine Wait Time\n+    CalculateWait --\u003e PrimaryLimit: Primary Rate Limit (X-RateLimit-Reset)\n+    CalculateWait --\u003e SecondaryLimit: Secondary Rate Limit (60s fixed)\n+    CalculateWait --\u003e Exponential: 5xx Error (exponential backoff)\n+    PrimaryLimit --\u003e WaitWithProgress: Wait Until Reset\n+    SecondaryLimit --\u003e WaitWithProgress: Wait 60 Seconds\n+    Exponential --\u003e WaitWithProgress: Wait 2^(attempt-1) seconds\n+    WaitWithProgress --\u003e MakeRequest: Retry Request\n+    Fail --\u003e [*]\n+```\n+\n+## Configuration\n+\n+### Rate Limiter Configuration\n+\n+```typescript\n+interface RateLimitConfig {\n+  secondsBetweenRequests?: number // Default: 0.25 (250ms)\n+  secondaryRateWait?: number // Default: 60 (seconds)\n+  maxRetries?: number // Default: 3\n+}\n+```\n+\n+### Import Configuration\n+\n+```typescript\n+interface ImportConfig {\n+  relayBatchSize?: number // Default: 30 (events per batch)\n+  relayBatchDelay?: number // Default: 250 (milliseconds between batches)\n+  // ... other options\n+}\n+```\n+\n+## Provider-Specific Rate Limits\n+\n+### GitHub\n+\n+- **Authenticated**: 5,000 requests/hour\n+- **Headers**: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`\n+- **Secondary Limits**: Abuse detection triggers 60s wait\n+\n+### GitLab\n+\n+- **Authenticated**: 2,000 requests/minute\n+- **Headers**: Similar to GitHub\n+- **Note**: May have different header names\n+\n+### Gitea\n+\n+- **Rate Limits**: Configurable per instance\n+- **Headers**: May vary by instance\n+\n+### Bitbucket\n+\n+- **Rate Limits**: Varies by plan\n+- **Headers**: May differ from GitHub\n+\n+## Progress Tracking\n+\n+The import system uses step-based progress tracking instead of percentage-based progress:\n+\n+- **Step Messages**: Clear messages describing current operation (e.g., \"Publishing issues...\")\n+- **Count Information**: Actual counts of published items (e.g., \"150 published\", \"3/10 profiles\")\n+- **No Fake Percentages**: Progress shows real counts, not estimated percentages\n+\n+### Progress Interface\n+\n+```typescript\n+interface ImportProgress {\n+  step: string // Current step/message\n+  current?: number // Current count (e.g., published issues)\n+  total?: number // Total count (e.g., for profiles: 3/10)\n+  isComplete: boolean // Whether import is complete\n+  error?: string // Error message if failed\n+}\n+```\n+\n+## Best Practices\n+\n+1. **Always use rate limiter**: Wrap all Git API calls with `withRateLimit()`\n+2. **Monitor quota**: Check `getRemainingQuota()` for user feedback\n+3. **Use batched publishing**: Leverage `relayBatchSize` and `relayBatchDelay` for efficient relay publishing\n+4. **Stream processing**: Process and publish items incrementally to minimize memory usage\n+5. **Progress updates**: Use `onProgress` callback to show step messages and counts to users\n+\n+## Memory Optimization\n+\n+The import process uses streaming to minimize memory:\n+\n+- Issues/PRs/Comments are fetched page-by-page (100 per page)\n+- Each item is immediately converted and published\n+- Only lightweight ID mappings are kept in memory:\n+  - `issueEventIdMap`: issue.number → nostr event ID\n+  - `prEventIdMap`: pr.number → nostr event ID\n+  - `commentEventMap`: platformCommentId → nostr event ID\n+\n+This allows importing large repositories without loading everything into memory at once.\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 4265946..6c77b25 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 4265946c2fc5dc627f23509aea4637053748c90c\n+Subproject commit 6c77b256e4b9a19ac5eeb1f7dd24123f8ef87825\ndiff --git a/src/app/components/ImportRepoDialogWrapper.svelte b/src/app/components/ImportRepoDialogWrapper.svelte\nnew file mode 100644\nindex 0000000..3334005\n--- /dev/null\n+++ b/src/app/components/ImportRepoDialogWrapper.svelte\n@@ -0,0 +1,9 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {ConfigProvider, ImportRepoDialog} from \"@nostr-git/ui\"\n+\n+  const props = $props()\n+\u003c/script\u003e\n+\n+\u003cConfigProvider\u003e\n+  \u003cImportRepoDialog {...props} /\u003e\n+\u003c/ConfigProvider\u003e\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 8c4f2e6..52fc8bf 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -10,6 +10,7 @@\n     loadProfile,\n     relaySearch,\n     pubkey,\n+    session,\n   } from \"@welshman/app\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {Router} from \"@welshman/router\"\n@@ -21,7 +22,7 @@\n   import Spinner from \"@lib/components/Spinner.svelte\"\n   import PageContent from \"@lib/components/PageContent.svelte\"\n   import GitItem from \"@app/components/GitItem.svelte\"\n-  import {pushModal} from \"@app/util/modal\"\n+  import {pushModal, clearModals} from \"@app/util/modal\"\n   import {pushToast} from \"@app/util/toast\"\n   import {decodeRelay} from \"@app/core/state\"\n   import {goto} from \"$app/navigation\"\n@@ -45,6 +46,8 @@\n   } from \"@nostr-git/ui\"\n   import NewRepoWizardWrapper from \"@app/components/NewRepoWizardWrapper.svelte\"\n   import RepoPickerWrapper from \"@app/components/RepoPickerWrapper.svelte\"\n+  import ImportRepoDialogWrapper from \"@app/components/ImportRepoDialogWrapper.svelte\"\n+  import type {ImportResult} from \"@nostr-git/ui\"\n   import {\n     deriveRepoRefState,\n     deriveMaintainersForEuc,\n@@ -58,7 +61,8 @@\n   import Git from \"@assets/icons/git.svg?dataurl\"\n   import Magnifier from \"@assets/icons/magnifier.svg?dataurl\"\n   import FolderWithFiles from \"@assets/icons/folder-with-files.svg?dataurl\"\n-  import { makeGitPath } from \"@src/lib/budabit\"\n+  import Download from \"@assets/icons/download.svg?dataurl\"\n+  import {makeGitPath} from \"@src/lib/budabit\"\n \n   const url = decodeRelay($page.params.relay)\n \n@@ -81,7 +85,7 @@\n     } catch (error) {\n       console.error(\"[+page.svelte] Failed to initialize worker:\", error)\n     }\n-    \n+\n     // Load my repos on mount\n     if ($pubkey) {\n       const filter = {kinds: [GIT_REPO_ANNOUNCEMENT], authors: [$pubkey]}\n@@ -103,12 +107,14 @@\n   }\n \n   const toBookmarkAddresses = (bookmarks: BookmarkAddress[]): BookmarkAddress[] =\u003e\n-    bookmarks.map((b: BookmarkAddress): BookmarkAddress =\u003e ({\n-      address: b.address,\n-      author: b.address.split(\":\")[1] || \"\",\n-      identifier: b.address.split(\":\")[2] || \"\",\n-      relayHint: b.relayHint,\n-    }))\n+    bookmarks.map(\n+      (b: BookmarkAddress): BookmarkAddress =\u003e ({\n+        address: b.address,\n+        author: b.address.split(\":\")[1] || \"\",\n+        identifier: b.address.split(\":\")[2] || \"\",\n+        relayHint: b.relayHint,\n+      }),\n+    )\n \n   const bookmarkedAddresses = $derived((): BookmarkAddress[] =\u003e {\n     const bookmarks = normalizeBookmarks($bookmarksStore)\n@@ -133,7 +139,7 @@\n     )\n \n     const repoFilter = {kinds: [GIT_REPO_ANNOUNCEMENT], authors, \"#d\": identifiers}\n-    const loadKey = `${authors.join(',')}|${identifiers.join(',')}`\n+    const loadKey = `${authors.join(\",\")}|${identifiers.join(\",\")}`\n \n     return _derived(deriveEvents(repository, {filters: [repoFilter]}), events =\u003e {\n       if (events.length !== identifiers.length) {\n@@ -190,7 +196,7 @@\n \n   const loadedMyRepos = $derived.by(() =\u003e {\n     if (!$myReposEvents) return []\n-    \n+\n     return $myReposEvents.map(repo =\u003e {\n       let addressString = \"\"\n       try {\n@@ -208,7 +214,6 @@\n     })\n   })\n \n-\n   // Filter repos based on active tab\n   const filteredRepos = $derived.by(() =\u003e {\n     if (activeTab === \"bookmarks\") {\n@@ -238,7 +243,7 @@\n   const uriSearchEvent = $derived.by(() =\u003e {\n     if (!extractedNaddr) return null\n     const naddr = extractedNaddr\n-    \n+\n     try {\n       const decoded = nip19.decode(naddr) as {type: string; data: any}\n       // Only fetch if it's a repo announcement (kind 30617)\n@@ -277,12 +282,12 @@\n     }\n   })\n \n-  // Filter repos based on search query (from current tab) \n+  // Filter repos based on search query (from current tab)\n   const searchFilteredRepos = $derived.by(() =\u003e {\n     const repos = filteredRepos\n     // If URI search, don't filter tab repos (URI search shows in separate section)\n     if (isUriSearch) return repos\n-    \n+\n     if (!searchQuery.trim()) return repos\n \n     const query = searchQuery.toLowerCase().trim()\n@@ -495,19 +500,25 @@\n \n   const onNewRepo = async () =\u003e {\n     console.log(\"[+page.svelte] onNewRepo called\")\n-    \n+\n     // Ensure worker is initialized before opening wizard\n     if (!workerApi || !workerInstance) {\n       console.log(\"[+page.svelte] Worker not initialized, initializing...\")\n       try {\n         // Add a timeout to prevent hanging\n         const timeoutPromise = new Promise((_, reject) =\u003e {\n-          setTimeout(() =\u003e reject(new Error('Worker initialization timeout after 15 seconds')), 15000);\n-        });\n-        \n-        const workerPromise = getInitializedGitWorker();\n-        \n-        const {api, worker} = await Promise.race([workerPromise, timeoutPromise]) as {api: any, worker: Worker};\n+          setTimeout(\n+            () =\u003e reject(new Error(\"Worker initialization timeout after 15 seconds\")),\n+            15000,\n+          )\n+        })\n+\n+        const workerPromise = getInitializedGitWorker()\n+\n+        const {api, worker} = (await Promise.race([workerPromise, timeoutPromise])) as {\n+          api: any\n+          worker: Worker\n+        }\n         workerApi = api\n         workerInstance = worker\n         console.log(\"[+page.svelte] Worker initialized for new repo\")\n@@ -567,6 +578,104 @@\n       pushToast({message: `Failed to open New Repo wizard: ${String(error)}`, theme: \"error\"})\n     }\n   }\n+\n+  const onImportRepo = async () =\u003e {\n+    console.log(\"[+page.svelte] onImportRepo called\")\n+\n+    if (!$session || !$pubkey) {\n+      pushToast({\n+        theme: \"error\",\n+        message: \"Please log in to import a repository.\",\n+      })\n+      return\n+    }\n+\n+    // Get signer for event signing (supports NIP-07, NIP-46, NIP-01)\n+    const {getSigner} = await import(\"@welshman/app\")\n+    const signer = getSigner($session)\n+\n+    if (!signer) {\n+      pushToast({\n+        theme: \"error\",\n+        message:\n+          \"No signer available. Please log in with a supported signer (NIP-01, NIP-07, or NIP-46).\",\n+      })\n+      return\n+    }\n+\n+    // Create onSignEvent callback that works with any signer\n+    const onSignEvent = async (\n+      event: Omit\u003cNostrEvent, \"id\" | \"sig\" | \"pubkey\"\u003e,\n+    ): Promise\u003cNostrEvent\u003e =\u003e {\n+      return await signer.sign(event)\n+    }\n+\n+    try {\n+      const modalId = pushModal(\n+        ImportRepoDialogWrapper,\n+        {\n+          pubkey: $pubkey!,\n+          onSignEvent: onSignEvent, // Primary signing method (works with all signers)\n+          onClose: () =\u003e {\n+            clearModals()\n+          },\n+          onPublishEvent: async (repoEvent: NostrEvent) =\u003e {\n+            // For GRASP repos (kind 30617/30618), publish to the GRASP relay from the event's 'relays' tag\n+            let targetRelays = defaultRepoRelays\n+\n+            // Check if this is a repo announcement or state event\n+            if (repoEvent.kind === 30617 || repoEvent.kind === 30618) {\n+              // Extract relay URLs from the 'relays' tag if present\n+              const relaysTag = repoEvent.tags?.find((t: any[]) =\u003e t[0] === \"relays\")\n+              if (relaysTag \u0026\u0026 relaysTag.length \u003e 1) {\n+                // For GRASP events, publish to BOTH the GRASP relay AND default relays\n+                const graspRelays = relaysTag.slice(1)\n+                targetRelays = [...graspRelays, ...defaultRepoRelays]\n+                // Remove duplicates while preserving order\n+                targetRelays = [...new Set(targetRelays)]\n+                console.log(\n+                  \"🔐 Publishing GRASP event to GRASP relay + default relays:\",\n+                  targetRelays,\n+                )\n+              }\n+            }\n+\n+            const result = publishEventToRelays(repoEvent, targetRelays)\n+          },\n+          onImportComplete: (result: ImportResult) =\u003e {\n+            // Reload repos by forcing bookmarks refresh and announcements\n+            loadRepoAnnouncements(bookmarkRelays)\n+            pushToast({\n+              message: `Successfully imported repository! Imported ${result.issuesImported} issues, ${result.commentsImported} comments, ${result.prsImported} PRs, and created ${result.profilesCreated} profiles.`,\n+            })\n+          },\n+          onNavigateToRepo: (result: ImportResult) =\u003e {\n+            try {\n+              // Convert announcement event to naddr and navigate\n+              const naddr = Address.fromEvent(result.announcementEvent as any).toNaddr()\n+              const destination = makeGitPath(url, naddr)\n+              goto(destination)\n+            } catch (error) {\n+              console.error(\"[+page.svelte] Failed to navigate to imported repo:\", error)\n+              pushToast({\n+                message: `Failed to navigate to repository: ${String(error)}`,\n+                theme: \"error\",\n+              })\n+            }\n+          },\n+          defaultRelays: [...defaultRepoRelays],\n+        },\n+        {fullscreen: true},\n+      )\n+      console.log(\"[+page.svelte] ImportRepoDialog modal pushed with ID:\", modalId)\n+    } catch (error) {\n+      console.error(\"[+page.svelte] Failed to push ImportRepoDialog modal:\", error)\n+      pushToast({\n+        message: `Failed to open Import Repo dialog: ${String(error)}`,\n+        theme: \"error\",\n+      })\n+    }\n+  }\n \u003c/script\u003e\n \n \u003csvelte:head\u003e\n@@ -588,6 +697,10 @@\n         \u003cIcon icon={AddCircle} /\u003e\n         New Repo\n       \u003c/Button\u003e\n+      \u003cButton class=\"btn btn-secondary btn-sm\" onclick={() =\u003e onImportRepo()}\u003e\n+        \u003cIcon icon={Download} /\u003e\n+        Import Repo\n+      \u003c/Button\u003e\n     \u003c/div\u003e\n   {/snippet}\n \u003c/PageBar\u003e\n@@ -597,7 +710,7 @@\n   \u003cdiv class=\"flex flex-col gap-3\"\u003e\n     \u003cTabs bind:value={activeTab} class=\"w-full\"\u003e\n       \u003cdiv class=\"flex flex-col gap-3\"\u003e\n-        \u003cdiv class=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3\"\u003e\n+        \u003cdiv class=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\"\u003e\n           \u003cTabsList class=\"flex w-full sm:w-auto\"\u003e\n             \u003cTabsTrigger value=\"my-repos\" class=\"flex-1 sm:flex-none\"\u003e\n               \u003cspan class=\"flex items-center gap-2\"\u003e\n@@ -612,14 +725,17 @@\n               \u003c/span\u003e\n             \u003c/TabsTrigger\u003e\n           \u003c/TabsList\u003e\n-          \u003cdiv class=\"flex flex-col sm:flex-row gap-2 sm:items-center w-full sm:w-auto\"\u003e\n+          \u003cdiv class=\"flex w-full flex-col gap-2 sm:w-auto sm:flex-row sm:items-center\"\u003e\n             {#if activeTab === \"bookmarks\"}\n-              \u003cButton class=\"btn btn-primary btn-sm order-2 sm:order-1 w-full sm:w-auto\" onclick={onAddRepo}\u003e\n+              \u003cButton\n+                class=\"btn btn-primary btn-sm order-2 w-full sm:order-1 sm:w-auto\"\n+                onclick={onAddRepo}\u003e\n                 \u003cIcon icon={Bookmark} /\u003e\n                 \u003cspan\u003eBookmark a Repo\u003c/span\u003e\n               \u003c/Button\u003e\n             {/if}\n-            \u003clabel class=\"input input-bordered flex w-full sm:w-auto sm:max-w-md items-center gap-2 order-1 sm:order-2\"\u003e\n+            \u003clabel\n+              class=\"input input-bordered order-1 flex w-full items-center gap-2 sm:order-2 sm:w-auto sm:max-w-md\"\u003e\n               \u003cIcon icon={Magnifier} /\u003e\n               \u003cinput\n                 bind:value={searchQuery}\n@@ -704,7 +820,7 @@\n       \u003c/p\u003e\n     {:else if $repositoriesStore.length \u003e 0}\n       {#if uriSearchRepoCard.length \u003e 0}\n-        \u003ch3 class=\"text-sm font-semibold text-muted-foreground mb-2\"\u003e\n+        \u003ch3 class=\"mb-2 text-sm font-semibold text-muted-foreground\"\u003e\n           {activeTab === \"my-repos\" ? \"My Repositories\" : \"Bookmarked Repositories\"}\n         \u003c/h3\u003e\n       {/if}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 4e85e45..23ca79c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -58,6 +58,10 @@\n   const repoRelays = $derived.by(() =\u003e (repoRelaysStore ? $repoRelaysStore : []))\n   const pullRequests = $derived.by(() =\u003e (pullRequestsStore ? $pullRequestsStore : []))\n \n+  $effect(() =\u003e {\n+    console.log(\"pullRequests\", pullRequests)\n+  })\n+\n   // Comments are managed locally, similar to issues page\n   let comments = $state\u003cCommentEvent[]\u003e([])\n \n@@ -93,7 +97,7 @@\n         })\n       }\n     }, 100)\n-    \n+\n     return () =\u003e {\n       clearTimeout(timeout)\n       controller.abort()\n@@ -278,7 +282,7 @@\n   $effect(() =\u003e {\n     // Access all reactive dependencies synchronously to ensure they're tracked\n     if (!repoClass) return\n-    \n+\n     const currentPatches = repoClass.patches\n     const currentComments = comments\n     const currentStatusData = statusData\n@@ -304,7 +308,9 @@\n           .map(c =\u003e c.id)\n           .sort()\n           .join(\",\"),\n-        currentStatusData.stateById ? Object.keys(currentStatusData.stateById).sort().join(\",\") : \"\",\n+        currentStatusData.stateById\n+          ? Object.keys(currentStatusData.stateById).sort().join(\",\")\n+          : \"\",\n         currentPullRequests\n           .map(pr =\u003e pr.id)\n           .sort()\n@@ -482,8 +488,14 @@\n \n     // Defer makeFeed to avoid blocking initial render\n     const timeout = setTimeout(() =\u003e {\n-      if (currentRepoClass \u0026\u0026 currentRepoClass.patches \u0026\u0026 currentPatchFilter \u0026\u0026 currentPullRequestFilter \u0026\u0026 !currentFeedInitialized) {\n-        const tryStart = () =\u003e {          \n+      if (\n+        currentRepoClass \u0026\u0026\n+        currentRepoClass.patches \u0026\u0026\n+        currentPatchFilter \u0026\u0026\n+        currentPullRequestFilter \u0026\u0026\n+        !currentFeedInitialized\n+      ) {\n+        const tryStart = () =\u003e {\n           if (currentElement \u0026\u0026 !currentFeedInitialized) {\n             feedInitialized = true\n             const feed = makeFeed({\n@@ -504,7 +516,7 @@\n         tryStart()\n       }\n     }, 100)\n-    \n+\n     return () =\u003e {\n       clearTimeout(timeout)\n     }\n@@ -514,7 +526,7 @@\n   onDestroy(() =\u003e {\n     // Cleanup makeFeed (aborts network requests, stops scroll observers, unsubscribes)\n     feedCleanup?.()\n-    \n+\n     // Abort all network requests\n     abortControllers.forEach(controller =\u003e controller.abort())\n     abortControllers.length = 0 // Clear array without reassignment\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-ph1pdo0q","title":"can't create new repo","description":"i created a classic github token and gave it FULL permissions. the repo creates but says safe push failed and then i don't see the repo in budabit","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T18:05:14.810072-08:00","closed_at":"2026-01-24T18:05:14.810072-08:00","close_reason":"Verified implemented via codebase triage","labels":["bug","issue"]}
{"id":"flotilla-po27hg32","title":"From 1ce3661344a60f87cbb35de8eedb8b36792d8441 Mon Sep 17 00:00:00 2001","description":"From 1ce3661344a60f87cbb35de8eedb8b36792d8441 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Thu, 20 Nov 2025 12:10:34 +0500\nSubject: [PATCH 3/13] feat(markdown): created a markdown component and used it in issue page\n\n---\n pnpm-lock.yaml | Bin 542998 -\u003e 549117 bytes\n 1 file changed, 0 insertions(+), 0 deletions(-)\n\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 8939b762a97d4e4f6730e64c7bba10fa625c5c74..85c9f3693292ddcb35ce3df50e4993c693cf2a73 100644\nGIT binary patch\ndelta 6680\nzc%1E*\u00262QsG7{;~Te\u0026n!1T6(FrV\u0026\u0026B;QPIk-Ka-eMM7L?vCNxRYrfCu((0DwFr}fu*\nz#\u003eqAyazLWzr3k|f5EpKs9IBPLaN)EPqDRD$1OEd;V%#o51!+%6x%e\u003c+\u0026%Dogo*BKr\nz(fHGk@BR71y\u003eCBTn*6eqpBV?pMt~q55P~QX`j}dw5fT(Y\u0026!xzv0`#2Kt6ts@JTrt8\nzdoF)%*s3HdSzVJQSzPTYqMC=I!fPT#ysD@=4|)m{LPG(DD8rm;zDfK-kRgMDEbd8p\nzUXplG\u0026yb*CWQZRWEJ}TnA\u00265m~Ee=Y0Qx?\u003c8BQeJ+RqbX10?h)T6hO;i7Sqc5gC4e#\nz3mlYIHqOAqyW?0x3\u00268hn3_\u003cKTEtfn\u003c5#\u003cRD5O6Z\u0026*u!Q)\u0026qCQ$C6U*1Y$8\u003cw5)Y7R\nz^1zUEH3vYBS!Pnoq\u003e7#g*{r7Wx}Gz5HHUQGkYt0`HAyq_de%@)6iY8{k6-wf^w@Wn\nzRhrgi(U\u0026ZW9Fuqhj^kbVXH#\u0026$u$z|G\u003cp%R#3OXA`(H5JBb|;(Ntji_CuN%ATHClm{\nzBJ2)JyE{Yn\u00265g{_ct{KAq#~mBBV5Oow^~vI?-VPRu?6FH`CwF*YPg~cOyonQ8h5\u0026\u0026\nzz2}*S\u003c**~`w2X(i({3G?k30;W7U\u003e?AM%{hMf=bOcx2s`Swnebr!e+Z\u003eL#H+{+\u0026$ZH\nz8-I@-V\u003c5M*cyRoz?w3i~X{oSS\u0026Q_aHu8t0rdb1\u003cfi$iQU6^H4b)JC0AtqHa2sG~Bc\nz!wxfZZE{wi+!En-WzgMj9hqD9z`z\u003cdwsgG13_#}~G-W\u0026NZs`g\u003cakQ}8Zs1-+*s=I}\nzZy\u003cW\u003erRM%_)!RPtG$}Cb{qhz|2mSbo(+C\u003cC_AJHN%mj$|p3AcOMeg$^W*r2_`Exzr\nz(z5ukjFbL5nx6RRB`FyF{LRAR\u003caGI++X;jTgb9RGfpGH2!`#f|gVp6*34{rR353\u0026v\nz@S{}1U\u00263F)-*j%GPrsjEJbPDLn!K{vNJnd*%-\u003e!YUtbwuiq\u003cqi6=ZQ`E\u0026c\u003eqbv+ZU\nz$*PbSSe\u0026AO(HSdL*1Xaax~2%Spt5H4{Hyu9lgCHD_oJ2fXK#(07ABl;hkfjF79d\u003ec\nznkeXdF5*~jxwyx?xs-zzaQlb|-0mgT9P?*#)Vg|c5C\u003ee73;lioOvF*|GGc\u003exUd})i\nza0BLvEs*PZ0T-_xyCE_;68iqE7f|8syI+eRMi-~i#f|gmV\u0026;vnlT#--b\u0026^wODyPob\nzm+vh`rQyxw_cviMVQ@MOo\u003c1AiWM!6\u003ex$|ek`B#5SU`$|4V4Ti1TvF!lL_dALFn7N5\nr_QLST|Men%_V`GO{N\u003ec0bMAhsoQk}s^K\u0026=E2;5Jl\u0026%bz(8oc%wfnAUR\n\ndelta 208\nzc%1utP;uHM#SJqg*mDa?i!#$HCr|X0U^JebXfDEPtY@reu(@Btk!f\u003cOW9H^Mxhz32\nzW16uyACzIhw0Xa~KO2ZQS)xK^^Mk-Z)yZ@1G^XFP;*g\u0026F)=pvb=kn?4(|5gQl$!3a\nzhgEQL{Bz0a9-CQtoAV#E=RaWFp8tSJeF;!|(qzXr;pqV#%pfb0+BtfdftUq|S+{fa\nsun9c@iB5NPW0l%|yO_P^7|4$8Ks)L\u003crmtAR\u003c~rFxO=SB@XO0kA0OLwfO#lD@\n\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-ppdpidv7","title":"From 45208ba1cb2cf69db65a9dcc6269718911d9e7eb Mon Sep 17 00:00:00 2001","description":"From 45208ba1cb2cf69db65a9dcc6269718911d9e7eb Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 30 Nov 2025 20:32:05 +0500\nSubject: [PATCH] chore: Route Git-related Nostr URIs to BudaBit instead of Coracle\n\n---\n src/app/util/routes.ts | 91 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n 1 file changed, 91 insertions(+)\n\ndiff --git a/src/app/util/routes.ts b/src/app/util/routes.ts\nindex acc7818..018e107 100644\n--- a/src/app/util/routes.ts\n+++ b/src/app/util/routes.ts\n@@ -15,6 +15,7 @@ import {\n   ZAP_GOAL,\n   EVENT_TIME,\n   getPubkeyTagValues,\n+  Address,\n } from \"@welshman/util\"\n import {\n   ensureUnwrapped,\n@@ -25,6 +26,40 @@ import {\n   userRoomsByUrl,\n   ROOM,\n } from \"@app/core/state\"\n+import {\n+  GIT_REPO_ANNOUNCEMENT,\n+  GIT_REPO_STATE,\n+  GIT_PATCH,\n+  GIT_PULL_REQUEST,\n+  GIT_PULL_REQUEST_UPDATE,\n+  GIT_ISSUE,\n+  GIT_COMMENT,\n+  GIT_PERMALINK,\n+  GIT_STATUS_OPEN,\n+  GIT_STATUS_APPLIED,\n+  GIT_STATUS_CLOSED,\n+  GIT_STATUS_DRAFT,\n+} from \"@nostr-git/shared-types\"\n+\n+// Repository event kinds (use Address directly)\n+const GIT_REPO_KINDS = [GIT_REPO_ANNOUNCEMENT, GIT_REPO_STATE]\n+\n+// Collaboration event kinds (reference repository via 'a' tag)\n+const GIT_COLLABORATION_KINDS = [\n+  GIT_PATCH,\n+  GIT_PULL_REQUEST,\n+  GIT_PULL_REQUEST_UPDATE,\n+  GIT_ISSUE,\n+  GIT_COMMENT,\n+  GIT_PERMALINK,\n+  GIT_STATUS_OPEN,\n+  GIT_STATUS_APPLIED,\n+  GIT_STATUS_CLOSED,\n+  GIT_STATUS_DRAFT,\n+]\n+\n+// All Git event kinds handled by BudaBit\n+const GIT_EVENT_KINDS = [...GIT_REPO_KINDS, ...GIT_COLLABORATION_KINDS]\n \n export const makeSpacePath = (url: string, ...extra: (string | undefined)[]) =\u003e {\n   let path = `/spaces/${encodeRelay(url)}`\n@@ -100,6 +135,62 @@ export const getEventPath = async (event: TrustedEvent, urls: string[]) =\u003e {\n \n   const room = getTagValue(ROOM, event.tags)\n \n+  // Handle Git-related events - route them to BudaBit's internal Git pages\n+  if (GIT_EVENT_KINDS.includes(event.kind)) {\n+    // For repository announcements (30617) and state (30618), use naddr\n+    if (GIT_REPO_KINDS.includes(event.kind)) {\n+      const address = Address.fromEvent(event)\n+      const naddr = address.toNaddr()\n+      const url = urls.length \u003e 0 ? urls[0] : \"\"\n+\n+      if (url) {\n+        return `/spaces/${encodeRelay(url)}/git/${naddr}`\n+      }\n+    }\n+\n+    // For patches, pull requests, issues, comments, and status events\n+    // These reference a repository via 'a' tag\n+    if (GIT_COLLABORATION_KINDS.includes(event.kind)) {\n+      // Get the repository address from 'a' tag\n+      const repoAddress = getTagValue(\"a\", event.tags)\n+\n+      if (repoAddress) {\n+        try {\n+          // Parse the coordinate to get pubkey and identifier\n+          const [kind, pubkey, identifier] = repoAddress.split(\":\")\n+\n+          if (pubkey \u0026\u0026 identifier) {\n+            // Create naddr for the repository\n+            const address = new Address(parseInt(kind), pubkey, identifier, urls)\n+            const naddr = address.toNaddr()\n+            const url = urls.length \u003e 0 ? urls[0] : \"\"\n+\n+            if (url) {\n+              // Route to specific sub-pages based on event kind\n+              if (\n+                event.kind === GIT_PATCH ||\n+                event.kind === GIT_PULL_REQUEST ||\n+                event.kind === GIT_PULL_REQUEST_UPDATE\n+              ) {\n+                return `/spaces/${encodeRelay(url)}/git/${naddr}/patches/${event.id}`\n+              }\n+\n+              if (event.kind === GIT_ISSUE) {\n+                return `/spaces/${encodeRelay(url)}/git/${naddr}/issues/${event.id}`\n+              }\n+\n+              // Comments and status events go to the feed view of the repository\n+              return `/spaces/${encodeRelay(url)}/git/${naddr}/feed`\n+            }\n+          }\n+        } catch (e) {\n+          // If parsing fails, fall through to default handling\n+          console.error(\"Failed to parse repository address for Git event:\", e)\n+        }\n+      }\n+    }\n+  }\n+\n   if (urls.length \u003e 0) {\n     const url = urls[0]\n \n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-ppt7feqa","title":"From c70a10bfe15ad9122ee9631090ce7dbab7b51c27 Mon Sep 17 00:00:00 2001","description":"From c70a10bfe15ad9122ee9631090ce7dbab7b51c27 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Tue, 3 Jun 2025 10:20:04 -0700\nSubject: [PATCH 13/67] Ignore roocode\n\n---\n .gitignore | 1 +\n 1 file changed, 1 insertion(+)\n\ndiff --git a/.gitignore b/.gitignore\nindex 3602226..80a9c04 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -65,6 +65,7 @@ google-services.json\n GoogleService-Info.plist\n \n # IDEs and editors\n+.roo\n .idea/\n .vscode/\n \n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-protocol-concept-mapping","title":"Map Budabit concepts to Smart Widget concepts","description":"Produce a mapping between Budabit extension concepts and Smart Widget concepts, including widget metadata, code references, configuration, state, and lifecycle.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-24T18:05:14.813404-08:00","closed_at":"2026-01-24T18:05:14.813404-08:00","close_reason":"Verified implemented via codebase triage"}
{"id":"flotilla-protocol-event-kinds-tags","title":"Define supported Smart Widget event kinds and tags","description":"Enumerate and document all Nostr event kinds and tags used for widget definition, code references, configuration, and state updates. Ensure compatibility with YakiHonne relays.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-24T18:05:14.813856-08:00","closed_at":"2026-01-24T18:05:14.813856-08:00","close_reason":"Verified implemented via codebase triage"}
{"id":"flotilla-protocol-repo-id","title":"Define canonical repository ID tagging","description":"Define a canonical, deterministic repository ID representation used to scope widgets (such as Kanban boards) to repositories.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-24T18:05:14.814316-08:00","closed_at":"2026-01-24T18:05:14.814316-08:00","close_reason":"Verified implemented via codebase triage"}
{"id":"flotilla-protocol-smart-widgets-source-of-truth","title":"Adopt Smart Widgets NIP as source of truth","description":"Treat the Smart Widgets NIP as the canonical protocol definition. Document which parts of the existing extension system must be replaced, adapted, or deprecated to achieve compliance.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-24T18:05:14.814762-08:00","closed_at":"2026-01-24T18:05:14.814762-08:00","close_reason":"Verified implemented via codebase triage"}
{"id":"flotilla-protocol-widget-state-model","title":"Define widget state persistence model","description":"Define how Smart Widget state is stored using Nostr events, including append-only semantics, replaceable events, and deterministic reconstruction rules.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T00:21:39.733124-08:00"}
{"id":"flotilla-pt0mv6sq","title":"From 70be36092ffdaf77d4f167e3cbd6639e74962a5a Mon Sep 17 00:00:00 2001","description":"From 70be36092ffdaf77d4f167e3cbd6639e74962a5a Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Fri, 4 Jul 2025 00:06:48 -0700\nSubject: [PATCH 69/69] feat: tag thread and comment events with GENERAL room\n\n---\n src/app/components/EventReply.svelte        |  4 ++--\n src/app/components/MenuSpaceRoomItem.svelte |  3 ---\n src/app/components/ThreadCreate.svelte      | 48 ++++++++++++++++++++++++++++--------------------\n src/app/state.ts                            | 12 ++----------\n 4 files changed, 32 insertions(+), 35 deletions(-)\n\ndiff --git a/src/app/components/EventReply.svelte b/src/app/components/EventReply.svelte\nindex 7765c47..595f7ee 100644\n--- a/src/app/components/EventReply.svelte\n+++ b/src/app/components/EventReply.svelte\n@@ -8,7 +8,7 @@\n   import ModalFooter from \"@lib/components/ModalFooter.svelte\"\n   import EditorContent from \"@app/editor/EditorContent.svelte\"\n   import {publishComment} from \"@app/commands\"\n-  import {PROTECTED} from \"@app/state\"\n+  import {GENERAL, PROTECTED, tagRoom} from \"@app/state\"\n   import {makeEditor} from \"@app/editor\"\n   import {pushToast} from \"@app/toast\"\n \n@@ -23,7 +23,7 @@\n \n     const ed = await editor\n     const content = ed.getText({blockSeparator: \"\\n\"}).trim()\n-    const tags = [...ed.storage.nostr.getEditorTags(), PROTECTED]\n+    const tags = [...ed.storage.nostr.getEditorTags(), tagRoom(GENERAL, url), PROTECTED]\n \n     if (!content) {\n       return pushToast({\ndiff --git a/src/app/components/MenuSpaceRoomItem.svelte b/src/app/components/MenuSpaceRoomItem.svelte\nindex ac5c351..fbf906d 100644\n--- a/src/app/components/MenuSpaceRoomItem.svelte\n+++ b/src/app/components/MenuSpaceRoomItem.svelte\n@@ -18,9 +18,6 @@\n   const path = makeRoomPath(url, room)\n   const channel = deriveChannel(url, room)\n \n-  $effect(() =\u003e {\n-    if($channel) console.log(\"channel\", $channel)\n-  })\n \u003c/script\u003e\n \n \u003cSecondaryNavItem\ndiff --git a/src/app/components/ThreadCreate.svelte b/src/app/components/ThreadCreate.svelte\nindex b45efd2..ac1dd5a 100644\n--- a/src/app/components/ThreadCreate.svelte\n+++ b/src/app/components/ThreadCreate.svelte\n@@ -1,6 +1,13 @@\n \u003cscript lang=\"ts\"\u003e\n   import {writable} from \"svelte/store\"\n-  import {Address, makeEvent, getTagValue, GIT_ISSUE, THREAD, type TrustedEvent} from \"@welshman/util\"\n+  import {\n+    Address,\n+    makeEvent,\n+    getTagValue,\n+    GIT_ISSUE,\n+    THREAD,\n+    type TrustedEvent,\n+  } from \"@welshman/util\"\n   import {publishThunk} from \"@welshman/app\"\n   import {isMobile, preventDefault} from \"@lib/html\"\n   import Icon from \"@lib/components/Icon.svelte\"\n@@ -10,18 +17,18 @@\n   import ModalFooter from \"@lib/components/ModalFooter.svelte\"\n   import EditorContent from \"@app/editor/EditorContent.svelte\"\n   import {pushToast} from \"@app/toast\"\n-  import {PROTECTED} from \"@app/state\"\n+  import {GENERAL, PROTECTED, tagRoom} from \"@app/state\"\n   import {makeEditor} from \"@app/editor\"\n-  import { FREELANCE_JOB } from \"@src/lib/util\"\n-    import { goto } from \"$app/navigation\"\n-    import { makeThreadPath } from \"../routes\"\n+  import {FREELANCE_JOB} from \"@src/lib/util\"\n+  import {goto} from \"$app/navigation\"\n+  import {makeThreadPath} from \"../routes\"\n \n   const {\n     url,\n     jobOrGitIssue,\n-    relayHint\n+    relayHint,\n   }: {\n-    url: string,\n+    url: string\n     jobOrGitIssue?: TrustedEvent\n     relayHint?: string\n   } = $props()\n@@ -31,7 +38,6 @@\n   const back = () =\u003e history.back()\n   const selectFiles = () =\u003e editor.then(ed =\u003e ed.commands.selectFiles())\n \n-\n   const threadsPath = makeThreadPath(url)\n   const submit = async () =\u003e {\n     if ($uploading) return\n@@ -53,16 +59,21 @@\n       })\n     }\n \n-    let jobOrGitIssueTag:string[] | undefined = undefined\n+    let jobOrGitIssueTag: string[] | undefined = undefined\n     if (jobOrGitIssue?.kind === GIT_ISSUE) {\n-      jobOrGitIssueTag = ['gitissue', jobOrGitIssue.id]\n+      jobOrGitIssueTag = [\"gitissue\", jobOrGitIssue.id]\n       if (relayHint) jobOrGitIssueTag.push(relayHint)\n     } else if (jobOrGitIssue?.kind === FREELANCE_JOB) {\n-      jobOrGitIssueTag = ['job', Address.fromEvent(jobOrGitIssue).toString()]\n+      jobOrGitIssueTag = [\"job\", Address.fromEvent(jobOrGitIssue).toString()]\n       if (relayHint) jobOrGitIssueTag.push(relayHint)\n     }\n \n-    const tags = [...ed.storage.nostr.getEditorTags(), [\"title\", title], PROTECTED]\n+    const tags = [\n+      ...ed.storage.nostr.getEditorTags(),\n+      tagRoom(GENERAL, url),\n+      [\"title\", title],\n+      PROTECTED,\n+    ]\n \n     publishThunk({\n       relays: [url],\n@@ -76,21 +87,18 @@\n \n   let title: string = $state(\"\")\n   const jobOrGitIssueTitle = $derived.by(() =\u003e {\n-    if (!jobOrGitIssue) return ''\n+    if (!jobOrGitIssue) return \"\"\n \n-    let title = ''\n+    let title = \"\"\n     if (jobOrGitIssue.kind === GIT_ISSUE) {\n-      title = 'Git: ' + (getTagValue('subject', jobOrGitIssue.tags) ?? '?')\n+      title = \"Git: \" + (getTagValue(\"subject\", jobOrGitIssue.tags) ?? \"?\")\n     } else if (jobOrGitIssue.kind === FREELANCE_JOB) {\n-      title = 'Job: ' + (getTagValue('title', jobOrGitIssue.tags) ?? '?')\n+      title = \"Job: \" + (getTagValue(\"title\", jobOrGitIssue.tags) ?? \"?\")\n     }\n     return title\n   })\n \n-  let titleToPost = $derived(\n-    title + (jobOrGitIssueTitle ? \"(\" + jobOrGitIssueTitle + \")\" : \"\")\n-  )\n-\n+  let titleToPost = $derived(title + (jobOrGitIssueTitle ? \"(\" + jobOrGitIssueTitle + \")\" : \"\"))\n \u003c/script\u003e\n \n \u003cform class=\"column gap-4\" onsubmit={preventDefault(submit)}\u003e\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 4195c0d..9a95dc2 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -545,7 +545,7 @@ export type Channel = {\n   url: string\n   room: string\n   name: string\n-  event: TrustedEvent\n+  event?: TrustedEvent | null\n   closed: boolean\n   private: boolean\n   picture?: string\n@@ -598,7 +598,6 @@ export const channels = derived(\n             url,\n             room,\n             name,\n-            event,\n             closed: false,\n             private: false,\n           })\n@@ -615,6 +614,7 @@ export const channels = derived(\n           const id = makeChannelId(url, room)\n \n           if (!$channels.some(c =\u003e c.id === id)) {\n+            console.log(\"adding channel\", event)\n             $channels.push({\n               id,\n               url,\n@@ -713,14 +713,6 @@ export const userRoomsByUrl = withGetter(\n       $userRoomsByUrl.set(normalizeRelayUrl(url), new Set())\n     }\n \n-    for (const [_, room, url] of getGroupTags(tags)) {\n-      addToMapKey($userRoomsByUrl, normalizeRelayUrl(url), room)\n-    }\n-\n-    for (const url of getRelayTagValues(tags)) {\n-      addToMapKey($userRoomsByUrl, normalizeRelayUrl(url), GENERAL)\n-    }\n-\n     return $userRoomsByUrl\n   }),\n )\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-q3jcckhx","title":"From 12710ab1ddd7fe59335e63705f8ebcfb0b691d31 Mon Sep 17 00:00:00 2001","description":"From 12710ab1ddd7fe59335e63705f8ebcfb0b691d31 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 2 Jun 2025 09:00:37 -0700\nSubject: [PATCH 3/4] update nostr-git\n\n---\n packages/nostr-git | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 1e83572..bc609f5 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 1e835722f528da5f31239627ec39c70fa2dfb773\n+Subproject commit bc609f563cbb0de023f5314f065737050cca3fd5\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-q4ts8r9u","title":"From 68a805431da9bf2523165a1894d96d7a31a3a36c Mon Sep 17 00:00:00 2001","description":"From 68a805431da9bf2523165a1894d96d7a31a3a36c Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 17 Apr 2025 15:01:06 +1000\nSubject: [PATCH 2/3] Add renderers for unknown kinds\n\n---\n package.json                      |  2 ++\n src/app/components/Content.svelte |  3 ++-\n src/lib/unkown-kinds.ts           | 61 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n 3 files changed, 65 insertions(+), 1 deletion(-)\n create mode 100644 src/lib/unkown-kinds.ts\n\ndiff --git a/package.json b/package.json\nindex 53dd566..be36708 100644\n--- a/package.json\n+++ b/package.json\n@@ -47,6 +47,7 @@\n     \"@poppanator/sveltekit-svg\": \"^4.2.1\",\n     \"@sentry/browser\": \"^8.35.0\",\n     \"@sveltejs/adapter-static\": \"^3.0.4\",\n+    \"@types/mustache\": \"^4.2.5\",\n     \"@types/qrcode\": \"^1.5.5\",\n     \"@types/throttle-debounce\": \"^5.0.2\",\n     \"@vite-pwa/assets-generator\": \"^0.2.6\",\n@@ -68,6 +69,7 @@\n     \"fuse.js\": \"^7.0.0\",\n     \"husky\": \"^9.1.6\",\n     \"idb\": \"^8.0.0\",\n+    \"mustache\": \"^4.2.0\",\n     \"nostr-git\": \"github:chebizarro/nostr-git\",\n     \"nostr-signer-capacitor-plugin\": \"coracle-social/nostr-signer-capacitor-plugin#9fbe4f8\",\n     \"nostr-tools\": \"^2.7.2\",\ndiff --git a/src/app/components/Content.svelte b/src/app/components/Content.svelte\nindex dd4ee14..71e839f 100644\n--- a/src/app/components/Content.svelte\n+++ b/src/app/components/Content.svelte\n@@ -30,6 +30,7 @@\n   import ContentTopic from \"@app/components/ContentTopic.svelte\"\n   import ContentMention from \"@app/components/ContentMention.svelte\"\n   import {entityLink, userSettingValues} from \"@app/state\"\n+  import {isKnownUnknown, unknownKindFallback} from \"@src/lib/unkown-kinds\"\n \n   interface Props {\n     event: any\n@@ -53,7 +54,7 @@\n     depth = 0,\n   }: Props = $props()\n \n-  const fullContent = parse(event)\n+  const fullContent = parse(isKnownUnknown(event.kind) ? unknownKindFallback(event) : event)\n \n   const expand = () =\u003e {\n     showEntire = true\ndiff --git a/src/lib/unkown-kinds.ts b/src/lib/unkown-kinds.ts\nnew file mode 100644\nindex 0000000..6142e22\n--- /dev/null\n+++ b/src/lib/unkown-kinds.ts\n@@ -0,0 +1,61 @@\n+import Mustache from \"mustache\"\n+import * as nip19 from \"nostr-tools/nip19\"\n+\n+type RawTag = string[]\n+\n+const DEFAULT_TEMPLATES: Record\u003cnumber, string\u003e = {\n+  14: \"encrypted message to {{tags.p}}\",\n+  7: \"{{pubkey}} reacts to {{tags.e}} by {{tags.p}}{{#content}} with {{content}}{{/content}}\",\n+  10002: \"canonical relays list for {{pubkey}}\",\n+  1111: \"{{content}}\",\n+  30617: \"git repository {{tags.name}} hosted at  by {{pubkey}}\",\n+  31922: \"{{tags.title}} happening at {{tags.start}}\",\n+  1630: \"Status: Open {{#nevent}}{{tags.e}}{{/nevent}}\",\n+  1631: \"Patch Applied\",\n+  1617: \"```\\n{{{content}}}\\n```\",\n+  1621: \"{{#tags.subject}}Subject{{tags.subject}}\\n{{/tags.subject}}{{content}} {{#npub}}{{tags.p}}{{/npub}}\",\n+  1623: \"```\\n{{{content}}}\\n```\",\n+}\n+\n+function tagsToObj(tags: RawTag[]): Record\u003cstring, string\u003e {\n+  const out: Record\u003cstring, string\u003e = {}\n+  for (const [k, v] of tags) if (!(k in out) \u0026\u0026 v) out[k] = v\n+  return out\n+}\n+\n+export function isKnownUnknown(kind: number): boolean {\n+  return DEFAULT_TEMPLATES[kind] !== undefined\n+}\n+\n+export function unknownKindFallback(\n+  params: {\n+    kind: number\n+    created_at: number\n+    pubkey: string\n+    content: string\n+    tags: RawTag[]\n+  },\n+  templates: Record\u003cnumber, string\u003e = DEFAULT_TEMPLATES,\n+): {\n+  content: string\n+  tags: RawTag[]\n+} {\n+  const tpl = templates[params.kind] ?? \"event kind {{kind}} by {{pubkey}}\"\n+\n+  return {\n+    content: Mustache.render(tpl, {\n+      ...params,\n+      tags: tagsToObj(params.tags),\n+      nevent: () =\u003e (txt: string, render: (s: string) =\u003e string) =\u003e {\n+        const hex = render(txt).trim().toLowerCase();\n+        return \"nostr:\" + nip19.neventEncode({id: hex, relays: []});\n+      },\n+\t  npub: () =\u003e (txt: string, render: (s: string) =\u003e string) =\u003e {\n+        const hex = render(txt).trim().toLowerCase()\n+        return \"nostr:\" + nip19.npubEncode(hex);\n+      },\n+\n+    }),\n+    tags: params.tags,\n+  }\n+}\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-q8t7ty26","title":"From 0bb341b3bf2998f8aa7dd2551e07ecc143597637 Mon Sep 17 00:00:00 2001","description":"From 0bb341b3bf2998f8aa7dd2551e07ecc143597637 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 4 Aug 2025 21:10:56 -0700\nSubject: [PATCH 7/8] feat: add StackedDiff component to workbench view for commit visualization\n\n---\n packages/nostr-git                                              |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte | 12 +++++++++++-\n 2 files changed, 12 insertions(+), 2 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 1354055..738600a 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 13540557d285f4829a7b11627f14af0243233608\n+Subproject commit 738600a6c9cd9f752d21d78a193bf11d44b1011c\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\nindex c738dd3..575a597 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n@@ -16,7 +16,13 @@\n   import {Card, CardContent, CardHeader, CardTitle} from \"@nostr-git/ui\"\n   import {Tabs, TabsContent, TabsList, TabsTrigger} from \"@nostr-git/ui\"\n   import {Badge} from \"@nostr-git/ui\"\n-  import {PatchSelector, CommitSelector, MergeAnalyzer, ConflictVisualizer} from \"@nostr-git/ui\"\n+  import {\n+    PatchSelector,\n+    CommitSelector,\n+    MergeAnalyzer,\n+    ConflictVisualizer,\n+    StackedDiff,\n+  } from \"@nostr-git/ui\"\n \n   const {data} = $props()\n   const {repoClass} = data\n@@ -89,6 +95,10 @@\n       \u003c/div\u003e\n     \u003c/div\u003e\n \n+    \u003cdiv class=\"mb-6\"\u003e\n+      \u003cStackedDiff commits={repoClass.commits} repo={repoClass} /\u003e\n+    \u003c/div\u003e\n+\n     \u003cdiv class=\"mb-6 grid grid-cols-2 gap-6\"\u003e\n       \u003cPatchSelector patches={repoClass.patches} selectedPatch={selectedPatch} onPatchSelect={(patch: any) =\u003e selectedPatch = patch} /\u003e\n       \u003cCommitSelector commits={repoClass.commits} selectedCommit={$selectedCommit} onCommitSelect={(commit: any) =\u003e selectedCommit = commit} /\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-qh9jyz6l","title":"From 4ca225591b6410af6fd54cb58ca91129210b388e Mon Sep 17 00:00:00 2001","description":"From 4ca225591b6410af6fd54cb58ca91129210b388e Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Thu, 5 Jun 2025 10:55:16 -0700\nSubject: [PATCH 27/67] Generalize goToMessage\n\n---\n src/app/components/ContentQuote.svelte        | 72 ++++++------------------------------------------------------------------\n src/app/components/SpaceRecentActivity.svelte | 38 ++++++++++++++++++++++----------------\n src/app/routes.ts                             | 62 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-\n src/lib/html.ts                               | 10 ++++++++--\n 4 files changed, 97 insertions(+), 85 deletions(-)\n\ndiff --git a/src/app/components/ContentQuote.svelte b/src/app/components/ContentQuote.svelte\nindex 0c8f02e..5891a6e 100644\n--- a/src/app/components/ContentQuote.svelte\n+++ b/src/app/components/ContentQuote.svelte\n@@ -1,26 +1,14 @@\n \u003cscript lang=\"ts\"\u003e\n   import * as nip19 from \"nostr-tools/nip19\"\n-  import {goto} from \"$app/navigation\"\n-  import {nthEq} from \"@welshman/lib\"\n   import {Router} from \"@welshman/router\"\n-  import {tracker, repository} from \"@welshman/app\"\n   import type {TrustedEvent} from \"@welshman/util\"\n-  import {\n-    Address,\n-    getTagValue,\n-    DIRECT_MESSAGE,\n-    DIRECT_MESSAGE_FILE,\n-    MESSAGE,\n-    THREAD,\n-    EVENT_TIME,\n-  } from \"@welshman/util\"\n-  import {scrollToEvent} from \"@lib/html\"\n+  import {Address, MESSAGE} from \"@welshman/util\"\n   import Button from \"@lib/components/Button.svelte\"\n   import Spinner from \"@lib/components/Spinner.svelte\"\n   import NoteCard from \"@app/components/NoteCard.svelte\"\n   import NoteContent from \"@app/components/NoteContent.svelte\"\n-  import {deriveEvent, entityLink, ROOM} from \"@app/state\"\n-  import {makeThreadPath, makeSpacePath, makeCalendarPath, makeRoomPath} from \"@app/routes\"\n+  import {deriveEvent, entityLink} from \"@app/state\"\n+  import {goToEvent} from \"@app/routes\"\n \n   type Props = {\n     value: any\n@@ -46,60 +34,12 @@\n     ? nip19.neventEncode({id, relays: mergedRelays})\n     : new Address(kind, pubkey, identifier, mergedRelays).toNaddr()\n \n-  const openMessage = (url: string, room: string | undefined, id: string) =\u003e {\n-    const event = repository.getEvent(id)\n-    const path = room ? makeRoomPath(url, room) : makeSpacePath(url, \"chat\")\n-\n-    if (event) {\n-      goto(path)\n-      scrollToEvent(id)\n-    }\n-\n-    return Boolean(event)\n-  }\n-\n   const onclick = () =\u003e {\n     if ($quote) {\n-      if ($quote.kind === DIRECT_MESSAGE || $quote.kind === DIRECT_MESSAGE_FILE) {\n-        return scrollToEvent($quote.id)\n-      }\n-\n-      const [url] = tracker.getRelays($quote.id)\n-      const room = getTagValue(ROOM, $quote.tags)\n-\n-      if (url) {\n-        if ($quote.kind === THREAD) {\n-          return goto(makeThreadPath(url, $quote.id))\n-        }\n-\n-        if ($quote.kind === EVENT_TIME) {\n-          return goto(makeCalendarPath(url, $quote.id))\n-        }\n-\n-        if ($quote.kind === MESSAGE) {\n-          return scrollToEvent($quote.id) || openMessage(url, room, $quote.id)\n-        }\n-\n-        const kind = $quote.tags.find(nthEq(0, \"K\"))?.[1]\n-        const id = $quote.tags.find(nthEq(0, \"E\"))?.[1]\n-\n-        if (id \u0026\u0026 kind) {\n-          if (parseInt(kind) === THREAD) {\n-            return goto(makeThreadPath(url, id))\n-          }\n-\n-          if (parseInt(kind) === EVENT_TIME) {\n-            return goto(makeCalendarPath(url, id))\n-          }\n-\n-          if (parseInt(kind) === MESSAGE) {\n-            return scrollToEvent(id) || openMessage(url, room, id)\n-          }\n-        }\n-      }\n+      goToEvent($quote)\n+    } else {\n+      window.open(entityLink(entity))\n     }\n-\n-    window.open(entityLink(entity))\n   }\n \u003c/script\u003e\n \ndiff --git a/src/app/components/SpaceRecentActivity.svelte b/src/app/components/SpaceRecentActivity.svelte\nindex c0b7473..02f1e45 100644\n--- a/src/app/components/SpaceRecentActivity.svelte\n+++ b/src/app/components/SpaceRecentActivity.svelte\n@@ -10,6 +10,7 @@\n   import ProfileCircle from \"@app/components/ProfileCircle.svelte\"\n   import ProfileCircles from \"@app/components/ProfileCircles.svelte\"\n   import {deriveEventsForUrl} from \"@app/state\"\n+  import {goToEvent} from \"@app/routes\"\n \n   type Props = {\n     url: string\n@@ -80,7 +81,7 @@\n         \u003c/div\u003e\n       {:else}\n         {#each $conversations.slice(0, limit) as { room, events, latest, earliest, participants } (latest.id)}\n-          \u003cdiv class=\"card2 bg-alt\"\u003e\n+          \u003cButton class=\"card2 bg-alt\" onclick={() =\u003e goToEvent(earliest)}\u003e\n             \u003cdiv class=\"flex flex-col gap-3\"\u003e\n               \u003cdiv class=\"flex items-start gap-3\"\u003e\n                 \u003cProfileCircle pubkey={earliest.pubkey} size={10} /\u003e\n@@ -94,30 +95,35 @@\n                 \u003c/div\u003e\n               \u003c/div\u003e\n               \u003cdiv class=\"ml-13 flex items-center justify-between\"\u003e\n-                \u003cdiv class=\"flex items-center gap-4\"\u003e\n-                  \u003cspan class=\"flex items-center gap-2 text-sm opacity-70\"\u003e\n-                    \u003cIcon icon=\"alt-arrow-left\" size={4} /\u003e\n+                \u003cdiv class=\"flex gap-1\"\u003e\n+                  \u003cIcon icon=\"alt-arrow-left\" /\u003e\n+                  \u003cspan class=\"text-sm opacity-70\"\u003e\n                     {events.length} messages\n                   \u003c/span\u003e\n-                  \u003cdiv class=\"flex -space-x-2\"\u003e\n-                    \u003cProfileCircles pubkeys={participants} size={6} /\u003e\n-                  \u003c/div\u003e\n                 \u003c/div\u003e\n-                \u003cspan class=\"text-sm opacity-50\"\u003e\n-                  {formatTimestamp(latest.created_at)}\n-                \u003c/span\u003e\n+                \u003cdiv class=\"flex gap-2\"\u003e\n+                  \u003cProfileCircles pubkeys={participants} size={6} /\u003e\n+                  \u003cspan class=\"text-sm opacity-70\"\u003e\n+                    {participants.length} participants\n+                  \u003c/span\u003e\n+                \u003c/div\u003e\n               \u003c/div\u003e\n-              \u003cdiv class=\"card2 bg-alt\"\u003e\n+              \u003cButton class=\"card2 bg-alt\" onclick={() =\u003e goToEvent(latest)}\u003e\n                 \u003cdiv class=\"flex flex-col gap-2\"\u003e\n-                  \u003cdiv class=\"flex items-center gap-2 text-sm opacity-70\"\u003e\n-                    \u003cProfileCircle pubkey={latest.pubkey} size={5} /\u003e\n-                    \u003cspan class=\"font-medium\"\u003eLatest reply:\u003c/span\u003e\n+                  \u003cdiv class=\"flex items-center justify-between\"\u003e\n+                    \u003cdiv class=\"flex items-center gap-2 text-sm opacity-70\"\u003e\n+                      \u003cProfileCircle pubkey={latest.pubkey} size={5} /\u003e\n+                      \u003cspan class=\"font-medium\"\u003eLatest reply:\u003c/span\u003e\n+                    \u003c/div\u003e\n+                    \u003cspan class=\"text-xs opacity-50\"\u003e\n+                      {formatTimestamp(latest.created_at)}\n+                    \u003c/span\u003e\n                   \u003c/div\u003e\n                   \u003cContent minimalQuote minLength={100} maxLength={200} event={latest} /\u003e\n                 \u003c/div\u003e\n-              \u003c/div\u003e\n+              \u003c/Button\u003e\n             \u003c/div\u003e\n-          \u003c/div\u003e\n+          \u003c/Button\u003e\n         {/each}\n         {#if $conversations.length \u003e limit}\n           \u003cButton class=\"btn btn-primary\" onclick={viewMore}\u003e\ndiff --git a/src/app/routes.ts b/src/app/routes.ts\nindex 5bd3894..256bf0c 100644\n--- a/src/app/routes.ts\n+++ b/src/app/routes.ts\n@@ -1,6 +1,19 @@\n import type {Page} from \"@sveltejs/kit\"\n+import {goto} from \"$app/navigation\"\n+import {nthEq, sleep} from \"@welshman/lib\"\n+import type {TrustedEvent} from \"@welshman/util\"\n+import {tracker} from \"@welshman/app\"\n+import {scrollToEvent} from \"@lib/html\"\n import {identity} from \"@welshman/lib\"\n-import {makeChatId, decodeRelay, encodeRelay, userRoomsByUrl} from \"@app/state\"\n+import {\n+  getTagValue,\n+  DIRECT_MESSAGE,\n+  DIRECT_MESSAGE_FILE,\n+  MESSAGE,\n+  THREAD,\n+  EVENT_TIME,\n+} from \"@welshman/util\"\n+import {makeChatId, decodeRelay, encodeRelay, userRoomsByUrl, ROOM} from \"@app/state\"\n \n export const makeSpacePath = (url: string, ...extra: (string | undefined)[]) =\u003e {\n   let path = `/spaces/${encodeRelay(url)}`\n@@ -52,3 +65,50 @@ export const getPrimaryNavItemIndex = ($page: Page) =\u003e {\n       return 0\n   }\n }\n+\n+export const goToMessage = async (url: string, room: string | undefined, id: string) =\u003e {\n+  await goto(room ? makeRoomPath(url, room) : makeSpacePath(url, \"chat\"))\n+  await sleep(300)\n+\n+  return scrollToEvent(id)\n+}\n+\n+export const goToEvent = async (event: TrustedEvent) =\u003e {\n+  if (event.kind === DIRECT_MESSAGE || event.kind === DIRECT_MESSAGE_FILE) {\n+    return await scrollToEvent(event.id)\n+  }\n+\n+  const [url] = tracker.getRelays(event.id)\n+  const room = getTagValue(ROOM, event.tags)\n+\n+  if (url) {\n+    if (event.kind === THREAD) {\n+      return goto(makeThreadPath(url, event.id))\n+    }\n+\n+    if (event.kind === EVENT_TIME) {\n+      return goto(makeCalendarPath(url, event.id))\n+    }\n+\n+    if (event.kind === MESSAGE) {\n+      return goToMessage(url, room, event.id)\n+    }\n+\n+    const kind = event.tags.find(nthEq(0, \"K\"))?.[1]\n+    const id = event.tags.find(nthEq(0, \"E\"))?.[1]\n+\n+    if (id \u0026\u0026 kind) {\n+      if (parseInt(kind) === THREAD) {\n+        return goto(makeThreadPath(url, id))\n+      }\n+\n+      if (parseInt(kind) === EVENT_TIME) {\n+        return goto(makeCalendarPath(url, id))\n+      }\n+\n+      if (parseInt(kind) === MESSAGE) {\n+        return goToMessage(url, room, id)\n+      }\n+    }\n+  }\n+}\ndiff --git a/src/lib/html.ts b/src/lib/html.ts\nindex 8b4473b..b4ee2db 100644\n--- a/src/lib/html.ts\n+++ b/src/lib/html.ts\n@@ -100,7 +100,7 @@ export const isIntersecting = async (element: Element) =\u003e\n     observer.observe(element)\n   })\n \n-export const scrollToEvent = async (id: string) =\u003e {\n+export const scrollToEvent = async (id: string, attempts = 3): Promise\u003cboolean\u003e =\u003e {\n   const element = document.querySelector(`[data-event=\"${id}\"]`) as any\n \n   if (element) {\n@@ -114,6 +114,8 @@ export const scrollToEvent = async (id: string) =\u003e {\n     setTimeout(() =\u003e {\n       element.style = \"\"\n     }, 800 + 400)\n+\n+    return true\n   } else {\n     const lastElement = last(Array.from(document.querySelectorAll(\"[data-event]\")))\n \n@@ -123,6 +125,10 @@ export const scrollToEvent = async (id: string) =\u003e {\n \n     await sleep(300)\n \n-    scrollToEvent(id)\n+    if (attempts \u003e 0) {\n+      return scrollToEvent(id, attempts - 1)\n+    } else {\n+      return false\n+    }\n   }\n }\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-qvrtvim9","title":"From fedb941b0696e3c1966b1642ebaba4b3c47331e2 Mon Sep 17 00:00:00 2001","description":"From fedb941b0696e3c1966b1642ebaba4b3c47331e2 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 17 Jun 2025 22:19:10 -0700\nSubject: [PATCH 1/9] feat: redesign repository overview with commits tab and enhanced UI\n\n---\n package.json                                                  |   2 ++\n packages/nostr-git                                            |   2 +-\n pnpm-lock.yaml                                                | Bin 489191 -\u003e 493808 bytes\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte       |   6 +++---\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte         | 509 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------------------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte | 175 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte |   2 +-\n 7 files changed, 558 insertions(+), 138 deletions(-)\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n\ndiff --git a/package.json b/package.json\nindex 914d04b..2c3ce67 100644\n--- a/package.json\n+++ b/package.json\n@@ -19,6 +19,7 @@\n     \"@sentry/cli\": \"^2.40.0\",\n     \"@sveltejs/kit\": \"^2.5.27\",\n     \"@sveltejs/vite-plugin-svelte\": \"^4.0.0\",\n+    \"@types/date-fns\": \"^2.6.3\",\n     \"@types/eslint\": \"^9.6.0\",\n     \"@types/markdown-it\": \"^14.1.2\",\n     \"@types/mustache\": \"^4.2.6\",\n@@ -74,6 +75,7 @@\n     \"@welshman/store\": \"^0.3.0\",\n     \"@welshman/util\": \"^0.3.0\",\n     \"daisyui\": \"^4.12.10\",\n+    \"date-fns\": \"^4.1.0\",\n     \"date-picker-svelte\": \"^2.13.0\",\n     \"dotenv\": \"^16.4.5\",\n     \"emoji-picker-element\": \"^1.22.8\",\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 7e69223..7de4657 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 7e692237ea99cdee33f895a360cb21f01bedd795\n+Subproject commit 7de4657fbc68b8b40b27d76ec1817d74ca2b0cef\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 98c9f2d7721d576eca6647bc5cc4d3bb6323f110..631349f86ab93a3c03b145720f5b6f247ca0e940 100644\nGIT binary patch\ndelta 3672\nzc$~#oTZr4}6~^g!rkys~gr\u003c{ZlT5T-(p;3WBunyT(uMK;BH5NLOS1j2RF-5*wl20V\nzw(Mm)1j\u003ef?Ww#hs\u003e|6U%=)x{3S#Y7H(3i4(=zAYZ\u003eAtjuZXw%;K9o`_du~bAvy@\u0026a\nzSQvB;|M|}O\u0026-uQiKm7UnlkaXnf-lUbiLXBfFBCU6MBbKmI{NIv%}Z;qhC`9rgWZck\nz|38F2?p)r!d\u0026wF}s_!8fqNFLNX_z~bsMyAg\u0026t5u%gk}`+l}ktn3n8~pJoX|XIE38s\nzK6)#-_4r%K*Wb8$Y=U^lHUvW(sFE%Den`v\u003c+zZ^^r}Ft^BWq}kg{QM%+)h\u003cW5MywW\nzMir}Jm`aw*a*gNW6hYM)I2~0By;\u003eK|s4idB\u003etjoWjJ#5dqa58xCrzm@8%!=m+1*!O\nzd3|#e0B-G_V1xYN8n26%A3PR9ZtePZ0GPci-PkA89NTm{`BHW2w#90ttdNsjHO+9a\nzVw+@ZJVaAMGwKdT@fKOj52yVkZP=0_B=dGDWi+EuO2J%tN}F|~Ad%f@*3CQocohbf\nz*SikiT^0a20x|oc1nlE|8eyW6R\u003e`q3Y~-du(@EMB++w;y8n\u0026f~IB^D(8k-AGdAcXp\nz)1@d%$}GXy\u003e{uDnQlvW8GDZTUQwkGH5L9;JXbG;m5`\u0026`K%NpQ^H83U1nEm#zSNAPc\nzM+wEsM@1JMS%#D=xmLTD=n@iEK}Ky;Cz2^ui^nMj?r^T=S}tzZ!c=Ei?G|h\u003eTq+fl\nz`L\u003cHT%}zlio1J95Tpn48RTwOZHwD\u003e8f%|nhf-\u00262CYkQy2IBAg1M0$)!M)a7FNDK\u003eu\nznnqH|7TzLsMaaaA90OTs)l9I3GzhaYnKh@3Bd|n1hr=iiCFx0D\u0026bVn3YG_e0Z_CPR\nz3^u\u003e)L_8EeDTMd\u0026{lK;TEIYKQp-piF%aW)_(e5NR\u0026Sas9R\u003e(N)G\u003ecFK%C?!V={5#M\nzhR#\u003cxt~JGqrMfY6YOdZNgJ^`T^IEEv3o8yErtBfySqWmKNMj!Z8vPWAW+RP~Vz)YQ\nzs}|mqE0tC_Ut{ZFt%t`e80`qrZkQoQEwHJ?q*PxK`ewg{7qgC$maQ;dN3?PQpVC\u0026j\nz*{z}F9FJ8Pv#l?\u003e^6}q3d`\u0026tlO{IgGF!Vjdd+?pW-TiUY=m{~YmmHemT86SXx7agF\nzSt|ietaK_{Na?X@rc#S*=5ShZ!n`II\u003eP?4C$M|lf(dxjdY$I*T#Bdx1Z7wD\u003eB9Stm\nzK1o|$hLn}Atoo0=hlIk%bGYb1uL1_H`Z\u003cVBAFGuibn38`XmJP+a%2%5PV|Axu$CMx\nzw3\u00269U7mI-o8%_-9gdXX0-7xQ\u003cO0f;XEhX9~\u003e|v)\u003c$k5%gP-}24PNSa(p_+bl%=_K_\nz!0qP1feECSDu{X\u00263G-Z;Pp}N$o+{C#h\u003eUTph-OmVM48f\u003eq+KN_IG^l=g$#rXMlv0V\nzl\u003cElVw(Ww$m{Ge6({kGy^\u003ciz9wFg0gt+$0\u003eaQ^L3Ko4BwO{J$p9Yq\u0026+1l6%@$=qq1\nz65scszz0xNSdPV-aw|I_#6}@o?$F#|(xdHkFP9\u0026;ASS99ZGk|9YBe3Rq@GnNi\u0026eYM\nzG9WT$%LtVmV=$#C`6Mz*;B=I\u0026cd7~%Uy$Ma2^8QTe(`|ut-S@?fAXu_`-Ft3\u003c8WC)\nzY-n6!4ALgD8eLA2##E\u003e$#mGo24YL#`*QO0U;?rK)jz`;6q5-\u003ej6A}\u003cSO\u003c`!C7\u003ezk(\nzBKRP25JP)xby@4hor==HlmtJfxC_)}#RB{v4_LO-2JFc|vVfK-`PEQt#n3~*p\u0026VJj\nzz%)jR=$jSW0*tY~bOugbt$ToF029LjL\u003c7(b8_*?51ngx1-5+XImBi3IJr7)QK7TZ4\nz-Z#`Wuvv`tK)nT~L{2M6*+Q\u003c7$+okUJy4pwkS(Qav7DMG(845NEtXO|TkGW9c)1Sd\nzU1c;vgg(hpqq5i\u003c\u003eSEi3qADw!9f%$+%Ip0aTfgr8@{fTV4`=tz%xCvLC;ug=8R8!1\nz4YtnQX^izWlAo|cpDYStP$F8OWFXAAD|c)vGI6r9lpGEvu+60mJK0Nx38bmpQn5hR\nzN)}3\u0026FcyMEGQ%NsDjY3w6g~m9vF4BR{K@v(qxCO8FVTK;d*|OdbBCcuC=M\u002680XLyU\nzt6qmD;R?wcx-3\u003cPiLr{qd9kAm_;7KAv|y}GQ+S_ZCT\u003e-)^@grg\u003cD%(Cr4hIAvWOsd\nzUQDWSrAbe{?`wgVfRmWJz^e\u003c{hnIH_00(Qsu6OQX;96kQ\u003cJI-8hwt57o4\u003cE6_|vnW\nzxeq+52e0q1l*?PYz=2\u003eM#`rXkFFkxFU*)ji*rk2Jvd0eUQv~Q+7i5HPZeBTcY4AP~\nzgD\u003es\u003eU%\u003e\u0026urBk*E4}O2`tNZ_\u003exX\u00267o`TNj*l6LZlTbCB\u003e_*l!HsM3x\u003c4!eNAF8Z%e\nz-$=X*AFN%E|J!+ZKl*t6;)|y*8(!k#`u6?*;DVL`uAI6_crSdgcH_Qw8qqK70\u003cS2*\nz@fNT=;PPqk7SUfk|9m;U-~4I)`s^Pcg5KZ7;Ffpp_Qs9*FVG+eLC;A1;wt@vUOQck\nzz3;uhcH?WOwcc~mxd3``mG6=2z4P*C\u003eD^-8@v(TmE?u6#D+IT{dG;xB@=x\u0026_;pz)V\nznsAUQJpai@!I$aHldlbr|M~j%vy|~PtsG2dEEHLFuSb);bc(H\u003e-hXMt_ZRJZcnZFf\nz1D5@Fc!|h=gC=|r!BBm=7Yuzg|2?)oe)6TI+${RRudC\u003cl0^oT+Ub{Gd\u003cL1WC*6yrO\nrh*Lh@ez3D~_xw}bzI^Syd2eIOgF_o%@Dz3ZoagiT#=LQN\u003c4y9PSs|Bh\n\ndelta 162\nzc%1t%QSSL$*$oDQ)2}Bp@ougYv|!\u0026P$*;A!(Ydy5`aCCAjmf)w\u003cu^|{r\u003c*!my_l7M\nz`y^AwV#evqidhA\u003e?=olfY~L\u003c(fRU%PeU~ZI_FbmT^FD2Vsll?8ZTihxHs1Eh1}xhr\nz8?f%--3~OULmzCw^v6Z4Gq(fv\u003e(@;OYUSRp@`;r@c)PC~Tm6UWK)s^df0(gfVgVbl\nKJ\u003c5iCnhyYL1wVKI\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 62bb304..e1ffa14 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -80,9 +80,9 @@\n           {/snippet}\n         \u003c/RepoTab\u003e\n         \u003cRepoTab\n-          tabValue=\"workbench\"\n-          label=\"Workbench\"\n-          href={`/spaces/${encodedRelay}/git/${id}/workbench`}\n+          tabValue=\"commits\"\n+          label=\"Commits\"\n+          href={`/spaces/${encodedRelay}/git/${id}/commits`}\n           {activeTab}\u003e\n           {#snippet icon()}\n             \u003cGitBranch class=\"h-4 w-4\" /\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 109772e..b08d99e 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -2,36 +2,75 @@\n   import {getContext} from \"svelte\"\n   import markdownit from \"markdown-it\"\n   import {Card, Repo} from \"@nostr-git/ui\"\n-  import {CircleAlert, GitBranch, GitPullRequest, Users} from \"@lucide/svelte\"\n+  import {\n+    CircleAlert,\n+    GitBranch,\n+    GitPullRequest,\n+    Users,\n+    Calendar,\n+    Globe,\n+    Hash,\n+    GitCommit,\n+    Clock,\n+    User,\n+    Link,\n+    Eye,\n+    BookOpen,\n+  } from \"@lucide/svelte\"\n   import {fly} from \"@lib/transition\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n-    import { pushToast } from \"@src/app/toast\"\n+  import {pushToast} from \"@src/app/toast\"\n+  import {formatDistanceToNow} from \"date-fns\"\n+  import {nthEq} from \"@welshman/lib\"\n \n   let loading = $state(true)\n+  let lastCommit = $state\u003cany\u003e(null)\n \n   const repoClass = getContext\u003cRepo\u003e(\"repoClass\")\n \n-  const stats = [\n+  const stats = $derived([\n     {\n       label: \"Branches\",\n-      value: () =\u003e repoClass.branches?.length,\n+      value: repoClass.branches?.length || 0,\n       icon: GitBranch,\n+      color: \"text-blue-600\",\n     },\n     {\n-      label: \"Contributors\",\n-      value: () =\u003e repoClass.maintainers?.length,\n+      label: \"Doers\",\n+      value: repoClass.maintainers?.length || 0,\n       icon: Users,\n+      color: \"text-green-600\",\n     },\n     {\n       label: \"Issues\",\n-      value: () =\u003e repoClass.issues?.length,\n-      icon: CircleAlert},\n+      value: repoClass.issues?.length || 0,\n+      icon: CircleAlert,\n+      color: \"text-red-600\",\n+    },\n     {\n       label: \"Patches\",\n-      value: () =\u003e repoClass.patches?.length,\n+      value: repoClass.patches?.length || 0,\n       icon: GitPullRequest,\n+      color: \"text-purple-600\",\n     },\n-  ]\n+  ])\n+\n+  const repoMetadata = $derived({\n+    name: repoClass.repo?.name || \"Unknown Repository\",\n+    description: repoClass.repo?.description || \"\",\n+    repoId: repoClass.repo?.repoId || \"\",\n+    maintainers: repoClass.maintainers || [],\n+    relays: repoClass.relays || [],\n+    cloneUrls: repoClass.repo?.clone || [],\n+    webUrls: repoClass.repo?.web || [],\n+    mainBranch: repoClass.mainBranch || \"main\",\n+    createdAt: repoClass.repoEvent?.created_at\n+      ? new Date(repoClass.repoEvent.created_at * 1000)\n+      : null,\n+    updatedAt: repoClass.repoStateEvent?.created_at\n+      ? new Date(repoClass.repoStateEvent.created_at * 1000)\n+      : null,\n+  })\n \n   let readme = $state\u003cstring | undefined\u003e(undefined)\n   let renderedReadme = $state\u003cstring | undefined\u003e(undefined)\n@@ -43,136 +82,340 @@\n \n   $effect(() =\u003e {\n     if (repoClass.repoEvent) {\n-      repoClass\n-        .getFileContent({\n-          path: \"README.md\",\n-        })\n-        .then(content =\u003e {\n-          readme = content\n-          renderedReadme = readme ? md.render(readme) : \"\"\n-          loading = false\n-        })\n-        .catch((e) =\u003e {\n-          console.error(e)\n-          pushToast({message: \"Failed to load README.md: \" + e, theme: \"error\"})\n-          loading = false\n-        })\n+      loadRepoInfo()\n     }\n   })\n+\n+  async function loadRepoInfo() {\n+    try {\n+      try {\n+        const readmeContent = await repoClass.getFileContent({path: \"README.md\"})\n+        readme = readmeContent\n+        renderedReadme = readme ? md.render(readme) : \"\"\n+      } catch (e) {\n+        console.log(\"No README.md found\")\n+      }\n+\n+      try {\n+        if (repoClass.mainBranch) {\n+          const commits = await repoClass.getCommitHistory({\n+            branch: repoClass.mainBranch,\n+            depth: 1,\n+          })\n+          if (commits \u0026\u0026 commits.length \u003e 0) {\n+            lastCommit = commits[0]\n+          }\n+        }\n+      } catch (e) {\n+        console.log(\"Could not fetch commit info:\", e)\n+      }\n+\n+      loading = false\n+    } catch (e) {\n+      console.error(\"Error loading repo info:\", e)\n+      pushToast({message: \"Failed to load repository information: \" + e, theme: \"error\"})\n+      loading = false\n+    }\n+  }\n+\n+  function formatDate(date: Date | null) {\n+    if (!date) return \"Unknown\"\n+    return formatDistanceToNow(date, {addSuffix: true})\n+  }\n+\n+  function truncateHash(hash: string, length = 8) {\n+    return hash ? hash.substring(0, length) : \"\"\n+  }\n \u003c/script\u003e\n \n-\u003cdiv class=\"relative flex flex-col gap-3 px-2\"\u003e\n-  \u003cdiv class=\"grid grid-cols-4 gap-4\"\u003e\n-    {#each stats as stat}\n-      \u003cCard class=\"p-4\"\u003e\n-        \u003cdiv class=\"flex items-center gap-2\"\u003e\n-          \u003cstat.icon class=\"h-5 text-muted-foreground\" /\u003e\n-          \u003cdiv\u003e\n-            \u003cp class=\"text-sm text-muted-foreground\"\u003e{stat.label}\u003c/p\u003e\n-            \u003cp class=\"text-2xl font-semibold\"\u003e{stat.value()}\u003c/p\u003e\n+\u003cdiv class=\"relative flex flex-col gap-6 py-2\"\u003e\n+  {#if loading}\n+    \u003cdiv class=\"flex justify-center py-8\"\u003e\n+      \u003cSpinner /\u003e\n+    \u003c/div\u003e\n+  {:else}\n+    \u003c!-- Stats Grid --\u003e\n+    \u003cdiv class=\"grid grid-cols-2 gap-4 md:grid-cols-4\"\u003e\n+      {#each stats as stat}\n+        \u003cCard class=\"p-4 transition-shadow hover:shadow-md\"\u003e\n+          \u003cdiv class=\"flex items-center gap-3\"\u003e\n+            \u003cdiv class=\"p-2\"\u003e\n+              \u003cstat.icon class=\"h-5 w-5 {stat.color}\" /\u003e\n+            \u003c/div\u003e\n+            \u003cdiv\u003e\n+              \u003cp class=\"text-sm text-muted-foreground\"\u003e{stat.label}\u003c/p\u003e\n+              \u003cp class=\"text-2xl font-semibold\"\u003e{stat.value}\u003c/p\u003e\n+            \u003c/div\u003e\n+          \u003c/div\u003e\n+        \u003c/Card\u003e\n+      {/each}\n+    \u003c/div\u003e\n+\n+    \u003cdiv class=\"grid gap-6 md:grid-cols-2\"\u003e\n+    \u003c!-- Repository Details --\u003e\n+    \u003cCard class=\"p-6\"\u003e\n+      \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+        \u003cGitCommit class=\"h-5 w-5\" /\u003e\n+        Repo Information\n+      \u003c/h3\u003e\n+      \u003cdiv class=\"grid gap-6 md:grid-cols-1\"\u003e\n+        \u003c!-- Git Information --\u003e\n+        \u003cdiv class=\"space-y-3\"\u003e\n+          \u003cdiv class=\"flex items-center justify-between\"\u003e\n+            \u003cspan class=\"text-sm text-muted-foreground\"\u003eDefault Branch\u003c/span\u003e\n+            \u003cspan class=\"rounded px-2 py-1 font-mono text-sm\"\u003e\n+              {repoMetadata.mainBranch}\n+            \u003c/span\u003e\n           \u003c/div\u003e\n+\n+          {#if lastCommit}\n+            \u003cdiv class=\"border-t pt-3\"\u003e\n+              \u003cdiv class=\"mb-2 flex items-start justify-between\"\u003e\n+                \u003cspan class=\"text-sm text-muted-foreground\"\u003eLatest Commit\u003c/span\u003e\n+                \u003cspan class=\"rounded px-2 py-1 font-mono text-xs\"\u003e\n+                  {truncateHash(lastCommit.oid)}\n+                \u003c/span\u003e\n+              \u003c/div\u003e\n+              \u003cp class=\"text-sm\"\u003e{lastCommit.commit.message}\u003c/p\u003e\n+              \u003cdiv class=\"mt-2 flex items-center gap-2 text-xs text-muted-foreground\"\u003e\n+                \u003cUser class=\"h-3 w-3\" /\u003e\n+                \u003cspan\u003e{lastCommit.commit.author.name}\u003c/span\u003e\n+                \u003cspan\u003e•\u003c/span\u003e\n+                \u003cspan\u003e{formatDate(new Date(lastCommit.commit.author.timestamp * 1000))}\u003c/span\u003e\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          {#if repoClass.branches \u0026\u0026 repoClass.branches.length \u003e 0}\n+            \u003cdiv class=\"border-t pt-3\"\u003e\n+              \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eBranches\u003c/span\u003e\n+              \u003cdiv class=\"flex flex-wrap gap-1\"\u003e\n+                {#each repoClass.branches.slice(0, 5) as branch}\n+                  \u003cspan\n+                    class=\"rounded-full bg-blue-100 px-2 py-1 text-xs text-blue-800 dark:bg-blue-900/30 dark:text-blue-200\"\u003e\n+                    {branch.name}\n+                    {#if branch.isHead}\n+                      \u003cspan class=\"ml-1\"\u003e•\u003c/span\u003e\n+                    {/if}\n+                  \u003c/span\u003e\n+                {/each}\n+                {#if repoClass.branches.length \u003e 5}\n+                  \u003cspan class=\"px-2 py-1 text-xs text-muted-foreground\"\u003e\n+                    +{repoClass.branches.length - 5} more\n+                  \u003c/span\u003e\n+                {/if}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+        \u003c/div\u003e\n+\n+        \u003c!-- Nostr Information --\u003e\n+        \u003cdiv class=\"space-y-3\"\u003e\n+          {#if repoMetadata.maintainers.length \u003e 0}\n+            \u003cdiv\u003e\n+              \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eMaintainers\u003c/span\u003e\n+              \u003cdiv class=\"space-y-1\"\u003e\n+                {#each repoMetadata.maintainers as maintainer}\n+                  \u003cdiv class=\"flex items-center gap-2 text-sm\"\u003e\n+                    \u003cUser class=\"h-3 w-3\" /\u003e\n+                    \u003cspan class=\"font-mono text-xs\"\u003e{truncateHash(maintainer, 16)}\u003c/span\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          {#if repoMetadata.relays.length \u003e 0}\n+            \u003cdiv class=\"border-t pt-3\"\u003e\n+              \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eRelays\u003c/span\u003e\n+              \u003cdiv class=\"space-y-1\"\u003e\n+                {#each repoMetadata.relays.slice(0, 3) as relay}\n+                  \u003cdiv class=\"flex items-center gap-2 text-sm\"\u003e\n+                    \u003cGlobe class=\"h-3 w-3\" /\u003e\n+                    \u003cspan class=\"truncate\"\u003e{relay}\u003c/span\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+                {#if repoMetadata.relays.length \u003e 3}\n+                  \u003cspan class=\"text-xs text-muted-foreground\"\u003e\n+                    +{repoMetadata.relays.length - 3} more relays\n+                  \u003c/span\u003e\n+                {/if}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          {#if repoMetadata.cloneUrls.length \u003e 0}\n+            \u003cdiv class=\"border-t pt-3\"\u003e\n+              \u003cspan class=\"mb-2 block text-sm text-muted-foreground\"\u003eClone URLs\u003c/span\u003e\n+              \u003cdiv class=\"space-y-1\"\u003e\n+                {#each repoMetadata.cloneUrls as url}\n+                  \u003cdiv class=\"flex items-center gap-2 text-sm\"\u003e\n+                    \u003cLink class=\"h-3 w-3\" /\u003e\n+                    \u003cspan class=\"truncate font-mono text-xs\"\u003e{url}\u003c/span\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    \u003c/Card\u003e\n+\n+    \u003c!-- Activity Overview --\u003e\n+    {#if repoClass.issues.length \u003e 0 || repoClass.patches.length \u003e 0}\n+      \u003cCard class=\"p-6\"\u003e\n+        \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+          \u003cEye class=\"h-5 w-5\" /\u003e\n+          Recent Activity\n+        \u003c/h3\u003e\n+        \u003cdiv class=\"space-y-4\"\u003e\n+          {#if repoClass.issues.length \u003e 0}\n+            \u003cdiv\u003e\n+              \u003ch4 class=\"mb-2 text-sm font-medium text-muted-foreground\"\u003eRecent Issues\u003c/h4\u003e\n+              \u003cdiv class=\"space-y-2\"\u003e\n+                {#each repoClass.issues.slice(0, 3) as issue}\n+                  \u003cdiv class=\"flex items-start gap-3 rounded-lg p-3 outline outline-1 outline-gray-200\"\u003e\n+                    \u003cCircleAlert class=\"mt-0.5 h-4 w-4 text-red-500\" /\u003e\n+                    \u003cdiv class=\"min-w-0 flex-1\"\u003e\n+                      \u003cp class=\"truncate text-sm font-medium\"\u003e\n+                        {issue.tags.find(nthEq(0, \"t\"))?.[1] || \"Untitled Issue\"}\n+                      \u003c/p\u003e\n+                      \u003cp class=\"text-xs text-muted-foreground\"\u003e\n+                        {formatDate(new Date(issue.created_at * 1000))}\n+                      \u003c/p\u003e\n+                    \u003c/div\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n+\n+          {#if repoClass.patches.length \u003e 0}\n+            \u003cdiv\u003e\n+              \u003ch4 class=\"mb-2 text-sm font-medium text-muted-foreground\"\u003eRecent Patches\u003c/h4\u003e\n+              \u003cdiv class=\"space-y-2\"\u003e\n+                {#each repoClass.patches.slice(0, 3) as patch}\n+                  \u003cdiv class=\"flex items-start gap-3 rounded-lg p-3 outline outline-1 outline-gray-200\"\u003e\n+                    \u003cGitPullRequest class=\"mt-0.5 h-4 w-4 text-purple-500\" /\u003e\n+                    \u003cdiv class=\"min-w-0 flex-1\"\u003e\n+                      \u003cp class=\"truncate text-sm font-medium\"\u003e\n+                        {patch.tags.find(nthEq(0, \"title\"))?.[1] || \"Untitled Patch\"}\n+                      \u003c/p\u003e\n+                      \u003cp class=\"text-xs text-muted-foreground\"\u003e\n+                        {formatDate(new Date(patch.created_at * 1000))}\n+                      \u003c/p\u003e\n+                    \u003c/div\u003e\n+                  \u003c/div\u003e\n+                {/each}\n+              \u003c/div\u003e\n+            \u003c/div\u003e\n+          {/if}\n         \u003c/div\u003e\n       \u003c/Card\u003e\n-    {/each}\n-  \u003c/div\u003e\n-  {#if renderedReadme}\n-    \u003cdiv class=\"prose max-w-2xl bg-white dark:bg-zinc-900\" in:fly\u003e\n-      {@html renderedReadme}\n-      \u003cstyle\u003e\n-        .prose {\n-          color: theme(\"colors.zinc.50\");\n-          background: none;\n-        }\n-        .dark .prose {\n-          color: theme(\"colors.white\");\n-        }\n-        .prose h1,\n-        .prose h2,\n-        .prose h3 {\n-          font-weight: 600;\n-          line-height: 1.25;\n-          color: theme(\"colors.zinc.50\");\n-          margin-top: 2rem;\n-          margin-bottom: 1rem;\n-        }\n-        .prose h1 {\n-          font-size: 2rem;\n-          border-bottom: 1px solid theme(\"colors.zinc.50\");\n-          padding-bottom: 0.3em;\n-        }\n-        .prose h2 {\n-          font-size: 1.5rem;\n-          border-bottom: 1px solid theme(\"colors.zinc.50\");\n-          padding-bottom: 0.2em;\n-        }\n-        .prose h3 {\n-          font-size: 1.25rem;\n-          padding-bottom: 0.1em;\n-        }\n-        .prose ul,\n-        .prose ol {\n-          margin: 1em 0;\n-          padding-left: 2em;\n-        }\n-        .prose li {\n-          margin: 0.3em 0;\n-        }\n-        .prose a {\n-          color: theme(\"colors.accent\");\n-          text-decoration: underline;\n-          text-underline-offset: 2px;\n-          transition: color 0.2s;\n-        }\n-        .prose a:hover {\n-          color: theme(\"colors.primary\");\n-        }\n-        .prose code {\n-          background: theme(\"colors.zinc.700\");\n-          color: theme(\"colors.zinc.100\");\n-          border-radius: 4px;\n-          padding: 0.2em 0.4em;\n-          font-size: 0.95em;\n-        }\n-        .prose pre {\n-          background: theme(\"colors.zinc.900\");\n-          color: theme(\"colors.zinc.100\");\n-          border-radius: 8px;\n-          padding: 1em;\n-          margin: 1.5em 0;\n-          font-size: 1em;\n-          overflow-x: auto;\n-        }\n-        .prose blockquote {\n-          border-left: 4px solid theme(\"colors.zinc.300\");\n-          background: theme(\"colors.zinc.50\");\n-          color: theme(\"colors.zinc.600\");\n-          padding: 1em 1.5em;\n-          border-radius: 0.5em;\n-          margin: 1.5em 0;\n-          font-style: italic;\n-        }\n-        .prose table {\n-          width: 100%;\n-          border-collapse: collapse;\n-          margin-bottom: 1.5em;\n-          background: theme(\"colors.zinc.50\");\n-          border-radius: 0.5em;\n-          overflow: hidden;\n-        }\n-        .prose th,\n-        .prose td {\n-          border: 1px solid theme(\"colors.zinc.200\");\n-          padding: 0.6em 1em;\n-        }\n-        .prose th {\n-          background: theme(\"colors.zinc.100\");\n-          font-weight: 600;\n-        }\n-      \u003c/style\u003e\n+    {/if}\n     \u003c/div\u003e\n-  {:else if loading}\n-    \u003cSpinner {loading}\u003eLoading README.md...\u003c/Spinner\u003e\n-  {:else}\n-    \u003cdiv class=\"text-muted-foreground\"\u003eNo README.md found.\u003c/div\u003e\n+    \u003c!-- README --\u003e\n+    {#if renderedReadme}\n+      \u003cCard class=\"p-6\"\u003e\n+        \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+          \u003cBookOpen class=\"h-5 w-5\" /\u003e\n+          README\n+        \u003c/h3\u003e\n+        \u003cdiv class=\"prose max-w-2xl bg-white dark:bg-zinc-900\" in:fly\u003e\n+          {@html renderedReadme}\n+          \u003cstyle\u003e\n+            .prose {\n+              color: theme(\"colors.zinc.50\");\n+              background: none;\n+            }\n+            .dark .prose {\n+              color: theme(\"colors.white\");\n+            }\n+            .prose h1,\n+            .prose h2,\n+            .prose h3 {\n+              font-weight: 600;\n+              line-height: 1.25;\n+              color: theme(\"colors.zinc.50\");\n+              margin-top: 2rem;\n+              margin-bottom: 1rem;\n+            }\n+            .prose h1 {\n+              font-size: 2rem;\n+              border-bottom: 1px solid theme(\"colors.zinc.50\");\n+              padding-bottom: 0.3em;\n+            }\n+            .prose h2 {\n+              font-size: 1.5rem;\n+              border-bottom: 1px solid theme(\"colors.zinc.50\");\n+              padding-bottom: 0.2em;\n+            }\n+            .prose h3 {\n+              font-size: 1.25rem;\n+              padding-bottom: 0.1em;\n+            }\n+            .prose ul,\n+            .prose ol {\n+              margin: 1em 0;\n+              padding-left: 2em;\n+            }\n+            .prose li {\n+              margin: 0.3em 0;\n+            }\n+            .prose a {\n+              color: theme(\"colors.accent\");\n+              text-decoration: underline;\n+              text-underline-offset: 2px;\n+              transition: color 0.2s;\n+            }\n+            .prose a:hover {\n+              color: theme(\"colors.primary\");\n+            }\n+            .prose code {\n+              background: theme(\"colors.zinc.700\");\n+              color: theme(\"colors.zinc.100\");\n+              border-radius: 4px;\n+              padding: 0.2em 0.4em;\n+              font-size: 0.95em;\n+            }\n+            .prose pre {\n+              background: theme(\"colors.zinc.900\");\n+              color: theme(\"colors.zinc.100\");\n+              border-radius: 8px;\n+              padding: 1em;\n+              margin: 1.5em 0;\n+              font-size: 1em;\n+              overflow-x: auto;\n+            }\n+            .prose blockquote {\n+              border-left: 4px solid theme(\"colors.zinc.300\");\n+              background: theme(\"colors.zinc.50\");\n+              color: theme(\"colors.zinc.600\");\n+              padding: 1em 1.5em;\n+              border-radius: 0.5em;\n+              margin: 1.5em 0;\n+              font-style: italic;\n+            }\n+            .prose table {\n+              width: 100%;\n+              border-collapse: collapse;\n+              margin-bottom: 1.5em;\n+              background: theme(\"colors.zinc.50\");\n+              border-radius: 0.5em;\n+              overflow: hidden;\n+            }\n+            .prose th,\n+            .prose td {\n+              border: 1px solid theme(\"colors.zinc.200\");\n+              padding: 0.6em 1em;\n+            }\n+            .prose th {\n+              background: theme(\"colors.zinc.100\");\n+              font-weight: 600;\n+            }\n+          \u003c/style\u003e\n+        \u003c/div\u003e\n+      \u003c/Card\u003e\n+    {/if}\n   {/if}\n \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\nnew file mode 100644\nindex 0000000..afb0e08\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n@@ -0,0 +1,175 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import {GitBranch, Funnel, User, Search} from \"@lucide/svelte\"\n+  import {\n+    Button,\n+    Input,\n+    Select,\n+    SelectContent,\n+    SelectTrigger,\n+    SelectItem,\n+    Separator,\n+    CommitCard,\n+  } from \"@nostr-git/ui\"\n+  import {formatDistanceToNow} from \"date-fns\"\n+  import Spinner from \"@src/lib/components/Spinner.svelte\"\n+\n+  let {data} = $props()\n+  const {repoClass} = data\n+\n+  // Reactive state for UI\n+  let searchQuery = $state(\"\")\n+  let selectedBranch = $state([repoClass.mainBranch.split(\"/\").pop() || \"\"])\n+  let selectedAuthor = $state([])\n+\n+  // Get commits from the repo class (lazy-loaded and reactive)\n+  let commitsLoading = $state(true)\n+  let commitsError = $state\u003cstring | undefined\u003e(undefined)\n+  let commits = $state\u003cany[]\u003e([])\n+  // Get available branches for filtering\n+  let branches = $state\u003cstring[]\u003e([])\n+\n+  // Get unique authors from commits for filtering\n+  let authors = $state\u003cSet\u003cstring\u003e\u003e(new Set())\n+\n+  $effect(() =\u003e {\n+    if (repoClass.commits) {\n+      commits = repoClass.commits\n+    }\n+  })\n+\n+  $effect(() =\u003e {\n+    if (repoClass.branches) {\n+      branches = repoClass.branches.map((branch: any) =\u003e branch.name.split(\"/\").pop())\n+    }\n+  })\n+\n+  $effect(() =\u003e {\n+    if (repoClass.commits \u0026\u0026 repoClass.commits.length \u003e 0) {\n+      authors = new Set(repoClass.commits.map((commit: any) =\u003e commit.commit.author.name))\n+      commitsLoading = false\n+    }\n+  })\n+\n+  // Filter commits based on search and filters\n+  const filteredCommits = $derived.by(() =\u003e {\n+    if (commits) {\n+      let filtered = commits\n+\n+      // Filter by search query\n+      if (searchQuery.trim()) {\n+        const query = searchQuery.toLowerCase()\n+        filtered = filtered.filter(\n+          commit =\u003e\n+            commit.commit.message.toLowerCase().includes(query) ||\n+            commit.commit.author.name.toLowerCase().includes(query) ||\n+            commit.oid.toLowerCase().includes(query),\n+        )\n+      }\n+\n+      // Filter by branch (if branch filtering is implemented)\n+      if (selectedBranch.length \u003e 0) {\n+        //filtered = filtered.filter(commit =\u003e commit.branch === selectedBranch[0])\n+      }\n+\n+      // Filter by author\n+      if (selectedAuthor.length \u003e 0) {\n+        filtered = filtered.filter(commit =\u003e commit.commit.author.name === selectedAuthor[0])\n+      }\n+\n+      return filtered\n+    }\n+    return []\n+  })\n+\n+  const handleReact = (commitId: string, type: \"heart\") =\u003e {\n+    console.log(`Reacting to commit ${commitId} with ${type}`)\n+  }\n+\n+  const handleComment = (commitId: string, comment: string) =\u003e {\n+    console.log(`Commenting on commit ${commitId}: ${comment}`)\n+    // TODO: Implement Nostr comments for commits\n+  }\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"flex flex-col gap-6\"\u003e\n+  {#if commitsLoading}\n+    \u003cdiv class=\"flex items-center justify-center py-12\"\u003e\n+      \u003cSpinner loading={commitsLoading}\u003e\n+        Loading commits...\n+      \u003c/Spinner\u003e\n+    \u003c/div\u003e\n+  {:else if commitsError}\n+    \u003cdiv class=\"py-12 text-center\"\u003e\n+      \u003cp class=\"text-muted-foreground\"\u003eFailed to load commits.\u003c/p\u003e\n+    \u003c/div\u003e\n+  {:else}\n+    \u003cdiv class=\"mt-6\"\u003e\n+      \u003cdiv class=\"mb-6 flex flex-col gap-4 rounded-lg border border-border bg-card p-4 sm:flex-row\"\u003e\n+        \u003cdiv class=\"flex-1\"\u003e\n+          \u003cdiv class=\"relative\"\u003e\n+            \u003cSearch\n+              class=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 transform text-muted-foreground\" /\u003e\n+            \u003cInput placeholder=\"Search commits...\" bind:value={searchQuery} class=\"pl-10\" /\u003e\n+          \u003c/div\u003e\n+        \u003c/div\u003e\n+\n+        \u003cSelect bind:value={selectedBranch}\u003e\n+          \u003cSelectTrigger class=\"w-[140px]\"\u003e\n+            \u003cGitBranch class=\"mr-2 h-4 w-4\" /\u003e\n+            \u003cspan\u003e{selectedBranch}\u003c/span\u003e\n+          \u003c/SelectTrigger\u003e\n+          \u003cSelectContent\u003e\n+            {#each branches as branch (branch)}\n+              \u003cSelectItem value={branch}\u003e\n+                {branch}\n+              \u003c/SelectItem\u003e\n+            {/each}\n+          \u003c/SelectContent\u003e\n+        \u003c/Select\u003e\n+\n+        \u003cSelect bind:value={selectedAuthor}\u003e\n+          \u003cSelectTrigger class=\"w-[120px]\"\u003e\n+            \u003cUser class=\"mr-2 h-4 w-4\" /\u003e\n+            \u003cspan\u003e{selectedAuthor.length \u003e 0 ? selectedAuthor[0] : \"All authors\"}\u003c/span\u003e\n+          \u003c/SelectTrigger\u003e\n+          \u003cSelectContent\u003e\n+            {#each authors as author (author)}\n+              \u003cSelectItem value={author}\u003e\n+                {author}\n+              \u003c/SelectItem\u003e\n+            {/each}\n+          \u003c/SelectContent\u003e\n+        \u003c/Select\u003e\n+      \u003c/div\u003e\n+\n+      \u003cdiv class=\"space-y-4\"\u003e\n+        \u003cdiv class=\"flex items-center justify-between\"\u003e\n+          \u003ch2 class=\"text-lg font-semibold\"\u003e\n+            {filteredCommits?.length} commit{filteredCommits?.length !== 1 ? \"s\" : \"\"}\n+            {#if selectedBranch.length \u003e 0}\n+              on {selectedBranch[0]}{/if}\n+          \u003c/h2\u003e\n+\n+          \u003cButton variant=\"outline\" size=\"sm\" class=\"gap-2\"\u003e\n+            \u003cFunnel class=\"h-4 w-4\" /\u003e\n+            More filters\n+          \u003c/Button\u003e\n+        \u003c/div\u003e\n+\n+        \u003cSeparator /\u003e\n+\n+        {#if !repoClass.commits || repoClass.commits.length === 0}\n+          \u003cdiv class=\"py-12 text-center\"\u003e\n+            \u003cp class=\"text-muted-foreground\"\u003eNo commits found in this repository.\u003c/p\u003e\n+          \u003c/div\u003e\n+        {:else}\n+          \u003cdiv class=\"space-y-3\"\u003e\n+            {#each filteredCommits as commit (commit.oid)}\n+              \u003cCommitCard {commit} onReact={handleReact} onComment={handleComment} /\u003e\n+            {/each}\n+          \u003c/div\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  {/if}\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 9c706dc..1359cba 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -1,5 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {Button, IssueCard, PatchCard, Repo} from \"@nostr-git/ui\"\n+  import {Button, PatchCard, Repo} from \"@nostr-git/ui\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Address, type TrustedEvent} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-r60we0xw","title":"Repo overview, Issues and Patch lages load very slowly","description":"This might be due to some kind of (probably repo) synchronization kicking in prematurely.\n\nE.G: If user is jumping to an issue or directly to issues page that should not trigger repo cloning or other types of heavy-duty loading.\n\nNeeds code review and testing and then implement a better strategy to loading lightweight stuff faster.\nAt minimum repo overview, issues and patches page","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue","performance","question"]}
{"id":"flotilla-rd93pxpy","title":"From ea1090cd31db670fc8be959dfb7eebcf726f003f Mon Sep 17 00:00:00 2001","description":"From ea1090cd31db670fc8be959dfb7eebcf726f003f Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 3 Jul 2025 17:25:28 -0700\nSubject: [PATCH 68/68] chore: upgrade capacitor from 7.2.0 to 7.4.0 and remove NIP-29 relay checks\n\n---\n android/capacitor.settings.gradle           |  14 +++++++-------\n ios/App/Podfile                             |  18 +++++++++---------\n src/app/commands.ts                         |   1 -\n src/app/components/ChannelName.svelte       |   8 ++++++--\n src/app/components/MenuSpace.svelte         |  59 +++++++++++++++++++++++------------------------------------\n src/app/components/MenuSpaceRoomItem.svelte |   4 ++++\n src/app/components/RoomCreate.svelte        |  31 ++++++++++++-------------------\n src/app/components/SpaceQuickLinks.svelte   |  73 +++++++++++++++++++++++++++++++++++--------------------------------------\n src/app/state.ts                            | 130 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------\n src/routes/spaces/[relay]/+layout.svelte    |   3 ++-\n 10 files changed, 191 insertions(+), 150 deletions(-)\n\ndiff --git a/android/capacitor.settings.gradle b/android/capacitor.settings.gradle\nindex 1b7eb5e..bdc31ec 100644\n--- a/android/capacitor.settings.gradle\n+++ b/android/capacitor.settings.gradle\n@@ -1,21 +1,21 @@\n // DO NOT EDIT THIS FILE! IT IS GENERATED EACH TIME \"capacitor update\" IS RUN\n include ':capacitor-android'\n-project(':capacitor-android').projectDir = new File('../node_modules/.pnpm/@capacitor+android@7.2.0_@capacitor+core@7.2.0/node_modules/@capacitor/android/capacitor')\n+project(':capacitor-android').projectDir = new File('../node_modules/.pnpm/@capacitor+android@7.4.0_@capacitor+core@7.4.0/node_modules/@capacitor/android/capacitor')\n \n include ':capacitor-community-safe-area'\n-project(':capacitor-community-safe-area').projectDir = new File('../node_modules/.pnpm/@capacitor-community+safe-area@7.0.0-alpha.1_@capacitor+core@7.2.0/node_modules/@capacitor-community/safe-area/android')\n+project(':capacitor-community-safe-area').projectDir = new File('../node_modules/.pnpm/@capacitor-community+safe-area@7.0.0-alpha.1_@capacitor+core@7.4.0/node_modules/@capacitor-community/safe-area/android')\n \n include ':capacitor-app'\n-project(':capacitor-app').projectDir = new File('../node_modules/.pnpm/@capacitor+app@7.0.1_@capacitor+core@7.2.0/node_modules/@capacitor/app/android')\n+project(':capacitor-app').projectDir = new File('../node_modules/.pnpm/@capacitor+app@7.0.1_@capacitor+core@7.4.0/node_modules/@capacitor/app/android')\n \n include ':capacitor-keyboard'\n-project(':capacitor-keyboard').projectDir = new File('../node_modules/.pnpm/@capacitor+keyboard@7.0.1_@capacitor+core@7.2.0/node_modules/@capacitor/keyboard/android')\n+project(':capacitor-keyboard').projectDir = new File('../node_modules/.pnpm/@capacitor+keyboard@7.0.1_@capacitor+core@7.4.0/node_modules/@capacitor/keyboard/android')\n \n include ':capacitor-push-notifications'\n-project(':capacitor-push-notifications').projectDir = new File('../node_modules/.pnpm/@capacitor+push-notifications@7.0.1_@capacitor+core@7.2.0/node_modules/@capacitor/push-notifications/android')\n+project(':capacitor-push-notifications').projectDir = new File('../node_modules/.pnpm/@capacitor+push-notifications@7.0.1_@capacitor+core@7.4.0/node_modules/@capacitor/push-notifications/android')\n \n include ':capawesome-capacitor-badge'\n-project(':capawesome-capacitor-badge').projectDir = new File('../node_modules/.pnpm/@capawesome+capacitor-badge@7.0.1_@capacitor+core@7.2.0/node_modules/@capawesome/capacitor-badge/android')\n+project(':capawesome-capacitor-badge').projectDir = new File('../node_modules/.pnpm/@capawesome+capacitor-badge@7.0.1_@capacitor+core@7.4.0/node_modules/@capawesome/capacitor-badge/android')\n \n include ':nostr-signer-capacitor-plugin'\n-project(':nostr-signer-capacitor-plugin').projectDir = new File('../node_modules/.pnpm/nostr-signer-capacitor-plugin@0.0.4_@capacitor+core@7.2.0/node_modules/nostr-signer-capacitor-plugin/android')\n+project(':nostr-signer-capacitor-plugin').projectDir = new File('../node_modules/.pnpm/nostr-signer-capacitor-plugin@0.0.4_@capacitor+core@7.4.0/node_modules/nostr-signer-capacitor-plugin/android')\ndiff --git a/ios/App/Podfile b/ios/App/Podfile\nindex c9b2aa7..451e20a 100644\n--- a/ios/App/Podfile\n+++ b/ios/App/Podfile\n@@ -1,4 +1,4 @@\n-require_relative '../../node_modules/.pnpm/@capacitor+ios@7.2.0_@capacitor+core@7.2.0/node_modules/@capacitor/ios/scripts/pods_helpers'\n+require_relative '../../node_modules/.pnpm/@capacitor+ios@7.4.0_@capacitor+core@7.4.0/node_modules/@capacitor/ios/scripts/pods_helpers'\n \n platform :ios, '14.0'\n use_frameworks!\n@@ -9,14 +9,14 @@ use_frameworks!\n install! 'cocoapods', :disable_input_output_paths =\u003e true\n \n def capacitor_pods\n-  pod 'Capacitor', :path =\u003e '../../node_modules/.pnpm/@capacitor+ios@7.2.0_@capacitor+core@7.2.0/node_modules/@capacitor/ios'\n-  pod 'CapacitorCordova', :path =\u003e '../../node_modules/.pnpm/@capacitor+ios@7.2.0_@capacitor+core@7.2.0/node_modules/@capacitor/ios'\n-  pod 'CapacitorCommunitySafeArea', :path =\u003e '../../node_modules/.pnpm/@capacitor-community+safe-area@7.0.0-alpha.1_@capacitor+core@7.2.0/node_modules/@capacitor-community/safe-area'\n-  pod 'CapacitorApp', :path =\u003e '../../node_modules/.pnpm/@capacitor+app@7.0.1_@capacitor+core@7.2.0/node_modules/@capacitor/app'\n-  pod 'CapacitorKeyboard', :path =\u003e '../../node_modules/.pnpm/@capacitor+keyboard@7.0.1_@capacitor+core@7.2.0/node_modules/@capacitor/keyboard'\n-  pod 'CapacitorPushNotifications', :path =\u003e '../../node_modules/.pnpm/@capacitor+push-notifications@7.0.1_@capacitor+core@7.2.0/node_modules/@capacitor/push-notifications'\n-  pod 'CapawesomeCapacitorBadge', :path =\u003e '../../node_modules/.pnpm/@capawesome+capacitor-badge@7.0.1_@capacitor+core@7.2.0/node_modules/@capawesome/capacitor-badge'\n-  pod 'NostrSignerCapacitorPlugin', :path =\u003e '../../node_modules/.pnpm/nostr-signer-capacitor-plugin@0.0.4_@capacitor+core@7.2.0/node_modules/nostr-signer-capacitor-plugin'\n+  pod 'Capacitor', :path =\u003e '../../node_modules/.pnpm/@capacitor+ios@7.4.0_@capacitor+core@7.4.0/node_modules/@capacitor/ios'\n+  pod 'CapacitorCordova', :path =\u003e '../../node_modules/.pnpm/@capacitor+ios@7.4.0_@capacitor+core@7.4.0/node_modules/@capacitor/ios'\n+  pod 'CapacitorCommunitySafeArea', :path =\u003e '../../node_modules/.pnpm/@capacitor-community+safe-area@7.0.0-alpha.1_@capacitor+core@7.4.0/node_modules/@capacitor-community/safe-area'\n+  pod 'CapacitorApp', :path =\u003e '../../node_modules/.pnpm/@capacitor+app@7.0.1_@capacitor+core@7.4.0/node_modules/@capacitor/app'\n+  pod 'CapacitorKeyboard', :path =\u003e '../../node_modules/.pnpm/@capacitor+keyboard@7.0.1_@capacitor+core@7.4.0/node_modules/@capacitor/keyboard'\n+  pod 'CapacitorPushNotifications', :path =\u003e '../../node_modules/.pnpm/@capacitor+push-notifications@7.0.1_@capacitor+core@7.4.0/node_modules/@capacitor/push-notifications'\n+  pod 'CapawesomeCapacitorBadge', :path =\u003e '../../node_modules/.pnpm/@capawesome+capacitor-badge@7.0.1_@capacitor+core@7.4.0/node_modules/@capawesome/capacitor-badge'\n+  pod 'NostrSignerCapacitorPlugin', :path =\u003e '../../node_modules/.pnpm/nostr-signer-capacitor-plugin@0.0.4_@capacitor+core@7.4.0/node_modules/nostr-signer-capacitor-plugin'\n end\n \n target 'Flotilla Chat' do\ndiff --git a/src/app/commands.ts b/src/app/commands.ts\nindex e471b2b..ec0f247 100644\n--- a/src/app/commands.ts\n+++ b/src/app/commands.ts\n@@ -63,7 +63,6 @@ import {\n   userRoomsByUrl,\n } from \"@app/state\"\n import type {CommentEvent, IssueEvent, StatusEvent} from \"@nostr-git/shared-types\"\n-import {getPushInfo} from \"@app/push\"\n \n // Utils\n \ndiff --git a/src/app/components/ChannelName.svelte b/src/app/components/ChannelName.svelte\nindex e6c23cb..c5be05f 100644\n--- a/src/app/components/ChannelName.svelte\n+++ b/src/app/components/ChannelName.svelte\n@@ -1,7 +1,11 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {channelsById, makeChannelId} from \"@app/state\"\n+  import {channelsById, makeChannelId, GENERAL} from \"@app/state\"\n \n   const {url, room} = $props()\n \u003c/script\u003e\n \n-{$channelsById.get(makeChannelId(url, room))?.name || room}\n+{#if room === GENERAL}\n+  general\n+{:else}\n+  {$channelsById.get(makeChannelId(url, room))?.name || room}\n+{/if}\ndiff --git a/src/app/components/MenuSpace.svelte b/src/app/components/MenuSpace.svelte\nindex 5b94a21..e5ca0e1 100644\n--- a/src/app/components/MenuSpace.svelte\n+++ b/src/app/components/MenuSpace.svelte\n@@ -150,43 +150,30 @@\n       \u003cSecondaryNavItem href={gitPath} notification={$notifications.has(gitPath)}\u003e\n         \u003cIcon icon=\"git\" /\u003e Git\n       \u003c/SecondaryNavItem\u003e\n-      {#if hasNip29($relay)}\n-        {#if $userRooms.length \u003e 0}\n-          \u003cdiv class=\"h-2\"\u003e\u003c/div\u003e\n-          \u003cSecondaryNavHeader\u003eYour Rooms\u003c/SecondaryNavHeader\u003e\n-        {/if}\n-        {#each $userRooms as room, i (room)}\n-          \u003cMenuSpaceRoomItem {replaceState} notify {url} {room} /\u003e\n-        {/each}\n-        {#if $otherRooms.length \u003e 0}\n-          \u003cdiv class=\"h-2\"\u003e\u003c/div\u003e\n-          \u003cSecondaryNavHeader\u003e\n-            {#if $userRoomsByUrl.has(url)}\n-              Other Rooms\n-            {:else}\n-              Rooms\n-            {/if}\n-          \u003c/SecondaryNavHeader\u003e\n-        {/if}\n-        {#each $otherRooms as room, i (room)}\n-          \u003cMenuSpaceRoomItem {replaceState} {url} {room} /\u003e\n-        {/each}\n-        \u003cSecondaryNavItem {replaceState} onclick={addRoom}\u003e\n-          \u003cIcon icon=\"add-circle\" /\u003e\n-          Create room\n-        \u003c/SecondaryNavItem\u003e\n-      {:else}\n-        \u003cSecondaryNavItem\n-          {replaceState}\n-          href={chatPath}\n-          notification={$notifications.has(chatPath)}\u003e\n-          \u003cIcon icon=\"chat-round\" /\u003e Chat\n-        \u003c/SecondaryNavItem\u003e\n-        \u003cButton class=\"link flex items-center gap-2 py-2 pl-4 text-sm\" onclick={showMissingRooms}\u003e\n-          \u003cIcon icon=\"info-circle\" size={4} /\u003e\n-          Where did my rooms go?\n-        \u003c/Button\u003e\n+      {#if $userRooms.length \u003e 0}\n+        \u003cdiv class=\"h-2\"\u003e\u003c/div\u003e\n+        \u003cSecondaryNavHeader\u003eYour Rooms\u003c/SecondaryNavHeader\u003e\n       {/if}\n+      {#each $userRooms as room, i (room)}\n+        \u003cMenuSpaceRoomItem {replaceState} notify {url} {room} /\u003e\n+      {/each}\n+      {#if $otherRooms.length \u003e 0}\n+        \u003cdiv class=\"h-2\"\u003e\u003c/div\u003e\n+        \u003cSecondaryNavHeader\u003e\n+          {#if $userRoomsByUrl.has(url)}\n+            Other Rooms\n+          {:else}\n+            Rooms\n+          {/if}\n+        \u003c/SecondaryNavHeader\u003e\n+      {/if}\n+      {#each $otherRooms as room, i (room)}\n+        \u003cMenuSpaceRoomItem {replaceState} {url} {room} /\u003e\n+      {/each}\n+      \u003cSecondaryNavItem {replaceState} onclick={addRoom}\u003e\n+        \u003cIcon icon=\"add-circle\" /\u003e\n+        Create room\n+      \u003c/SecondaryNavItem\u003e\n     \u003c/div\u003e\n   \u003c/SecondaryNavSection\u003e\n   \u003cdiv class=\"p-4\"\u003e\ndiff --git a/src/app/components/MenuSpaceRoomItem.svelte b/src/app/components/MenuSpaceRoomItem.svelte\nindex e19cc26..ac5c351 100644\n--- a/src/app/components/MenuSpaceRoomItem.svelte\n+++ b/src/app/components/MenuSpaceRoomItem.svelte\n@@ -17,6 +17,10 @@\n \n   const path = makeRoomPath(url, room)\n   const channel = deriveChannel(url, room)\n+\n+  $effect(() =\u003e {\n+    if($channel) console.log(\"channel\", $channel)\n+  })\n \u003c/script\u003e\n \n \u003cSecondaryNavItem\ndiff --git a/src/app/components/RoomCreate.svelte b/src/app/components/RoomCreate.svelte\nindex 62c8174..cce07a3 100644\n--- a/src/app/components/RoomCreate.svelte\n+++ b/src/app/components/RoomCreate.svelte\n@@ -72,30 +72,23 @@\n       \u003c/div\u003e\n     {/snippet}\n   \u003c/ModalHeader\u003e\n-  {#if hasNip29($relay)}\n-    \u003cField\u003e\n-      {#snippet label()}\n-        \u003cp\u003eRoom Name\u003c/p\u003e\n-      {/snippet}\n-      {#snippet input()}\n-        \u003clabel class=\"input input-bordered flex w-full items-center gap-2\"\u003e\n-          \u003cIcon icon=\"hashtag\" /\u003e\n-          \u003cinput bind:value={name} class=\"grow\" type=\"text\" /\u003e\n-        \u003c/label\u003e\n-      {/snippet}\n-    \u003c/Field\u003e\n-  {:else}\n-    \u003cp class=\"bg-alt card2 row-2\"\u003e\n-      \u003cIcon icon=\"danger\" /\u003e\n-      This relay does not support creating rooms.\n-    \u003c/p\u003e\n-  {/if}\n+  \u003cField\u003e\n+    {#snippet label()}\n+      \u003cp\u003eRoom Name\u003c/p\u003e\n+    {/snippet}\n+    {#snippet input()}\n+      \u003clabel class=\"input input-bordered flex w-full items-center gap-2\"\u003e\n+        \u003cIcon icon=\"hashtag\" /\u003e\n+        \u003cinput bind:value={name} class=\"grow\" type=\"text\" /\u003e\n+      \u003c/label\u003e\n+    {/snippet}\n+  \u003c/Field\u003e\n   \u003cModalFooter\u003e\n     \u003cButton class=\"btn btn-link\" onclick={back}\u003e\n       \u003cIcon icon=\"alt-arrow-left\" /\u003e\n       Go back\n     \u003c/Button\u003e\n-    \u003cButton type=\"submit\" class=\"btn btn-primary\" disabled={!name || loading || !hasNip29($relay)}\u003e\n+    \u003cButton type=\"submit\" class=\"btn btn-primary\" disabled={!name || loading}\u003e\n       \u003cSpinner {loading}\u003eCreate Room\u003c/Spinner\u003e\n       \u003cIcon icon=\"alt-arrow-right\" /\u003e\n     \u003c/Button\u003e\ndiff --git a/src/app/components/SpaceQuickLinks.svelte b/src/app/components/SpaceQuickLinks.svelte\nindex f3759d7..6b359c8 100644\n--- a/src/app/components/SpaceQuickLinks.svelte\n+++ b/src/app/components/SpaceQuickLinks.svelte\n@@ -77,46 +77,43 @@\n         {/if}\n       \u003c/div\u003e\n     \u003c/Link\u003e\n-    {#if hasNip29($relay)}\n-      {#if $userRooms.length + $otherRooms.length \u003e 10}\n-        \u003clabel class=\"input input-sm input-bordered flex flex-grow items-center gap-2\"\u003e\n-          \u003cIcon icon=\"magnifer\" size={4} /\u003e\n-          \u003cinput bind:value={term} class=\"grow\" type=\"text\" placeholder=\"Search rooms...\" /\u003e\n-        \u003c/label\u003e\n-      {/if}\n-      {#each filteredRooms() as room (room)}\n-        {@const roomPath = makeRoomPath(url, room)}\n-        {@const channel = $channelsById.get(makeChannelId(url, room))}\n-        \u003cLink href={roomPath} class=\"btn btn-neutral btn-sm relative w-full justify-start\"\u003e\n-          \u003cdiv class=\"flex min-w-0 items-center gap-2 overflow-hidden text-nowrap\"\u003e\n-            {#if channel?.closed || channel?.private}\n-              \u003cIcon icon=\"lock\" size={4} /\u003e\n-            {:else}\n-              \u003cIcon icon=\"hashtag\" /\u003e\n-            {/if}\n-            \u003cChannelName {url} {room} /\u003e\n-          \u003c/div\u003e\n-          {#if $notifications.has(roomPath)}\n-            \u003cdiv class=\"absolute right-1 top-1 h-2 w-2 rounded-full bg-primary\" transition:fade\u003e\n-            \u003c/div\u003e\n-          {/if}\n-        \u003c/Link\u003e\n-      {/each}\n-      \u003cButton onclick={addRoom} class=\"btn btn-neutral btn-sm w-full justify-start\"\u003e\n-        \u003cIcon icon=\"add-circle\" /\u003e\n-        Create Room\n-      \u003c/Button\u003e\n-    {:else}\n-      \u003cLink href={chatPath} class=\"btn btn-neutral w-full justify-start\"\u003e\n-        \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n-          \u003cIcon icon=\"chat-round\" /\u003e\n-          Chat\n-          {#if $notifications.has(chatPath)}\n-            \u003cdiv class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary\" transition:fade\u003e\n-            \u003c/div\u003e\n+    {#if $userRooms.length + $otherRooms.length \u003e 10}\n+      \u003clabel class=\"input input-sm input-bordered flex flex-grow items-center gap-2\"\u003e\n+        \u003cIcon icon=\"magnifer\" size={4} /\u003e\n+        \u003cinput bind:value={term} class=\"grow\" type=\"text\" placeholder=\"Search rooms...\" /\u003e\n+      \u003c/label\u003e\n+    {/if}\n+    {#each filteredRooms() as room (room)}\n+      {@const roomPath = makeRoomPath(url, room)}\n+      {@const channel = $channelsById.get(makeChannelId(url, room))}\n+      \u003cLink href={roomPath} class=\"btn btn-neutral btn-sm relative w-full justify-start\"\u003e\n+        \u003cdiv class=\"flex min-w-0 items-center gap-2 overflow-hidden text-nowrap\"\u003e\n+          {#if channel?.closed || channel?.private}\n+            \u003cIcon icon=\"lock\" size={4} /\u003e\n+          {:else}\n+            \u003cIcon icon=\"hashtag\" /\u003e\n           {/if}\n+          \u003cChannelName {url} {room} /\u003e\n         \u003c/div\u003e\n+        {#if $notifications.has(roomPath)}\n+          \u003cdiv class=\"absolute right-1 top-1 h-2 w-2 rounded-full bg-primary\" transition:fade\u003e\n+          \u003c/div\u003e\n+        {/if}\n       \u003c/Link\u003e\n-    {/if}\n+    {/each}\n+    \u003cButton onclick={addRoom} class=\"btn btn-neutral btn-sm w-full justify-start\"\u003e\n+      \u003cIcon icon=\"add-circle\" /\u003e\n+      Create Room\n+    \u003c/Button\u003e\n+    \u003cLink href={chatPath} class=\"btn btn-neutral btn-sm relative w-full justify-start\"\u003e\n+      \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n+        \u003cIcon icon=\"chat-round\" /\u003e\n+        Chat\n+        {#if $notifications.has(chatPath)}\n+          \u003cdiv class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary\" transition:fade\u003e\n+          \u003c/div\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    \u003c/Link\u003e\n   \u003c/div\u003e\n \u003c/div\u003e\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 5a7186e..4195c0d 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -18,7 +18,6 @@ import {\n   memoize,\n   addToMapKey,\n   identity,\n-  groupBy,\n   always,\n } from \"@welshman/lib\"\n import type {Socket} from \"@welshman/net\"\n@@ -89,14 +88,18 @@ import {\n   appContext,\n } from \"@welshman/app\"\n import type {Thunk, Relay} from \"@welshman/app\"\n-import type { AddressPointer } from \"nostr-tools/nip19\"\n+import type {AddressPointer} from \"nostr-tools/nip19\"\n \n export const fromCsv = (s: string) =\u003e (s || \"\").split(\",\").filter(identity)\n \n export const ROOM = \"h\"\n \n+export const GENERAL = \"_\"\n+\n export const PROTECTED = [\"-\"]\n \n+export const GROUPS = 32829\n+\n export const NOTIFIER_PUBKEY = import.meta.env.VITE_NOTIFIER_PUBKEY\n \n export const NOTIFIER_RELAY = import.meta.env.VITE_NOTIFIER_RELAY\n@@ -133,9 +136,9 @@ export const IMGPROXY_URL = \"https://imgproxy.coracle.social\"\n \n export const REACTION_KINDS = [REACTION, ZAP_RESPONSE]\n \n-export const REPO_KEY = Symbol(\"repo\");\n+export const REPO_KEY = Symbol(\"repo\")\n \n-export const REPO_RELAYS_KEY = Symbol(\"repo-relays\");\n+export const REPO_RELAYS_KEY = Symbol(\"repo-relays\")\n \n export const NIP46_PERMS =\n   \"nip44_encrypt,nip44_decrypt,\" +\n@@ -266,22 +269,21 @@ export const deriveNaddrEvent = (naddr: string, hints: string[] = []) =\u003e {\n   const decoded = nip19.decode(naddr).data as AddressPointer\n   const fallbackRelays = [...hints, ...INDEXER_RELAYS]\n   const relays = decoded.relays \u0026\u0026 decoded.relays.length \u003e 0 ? decoded.relays : fallbackRelays\n-  const filters = [{\n-    authors: [decoded.pubkey],\n-    kinds: [decoded.kind],\n-    \"#d\": [decoded.identifier],\n-  }]\n-\n-  return derived(\n-    deriveEvents(repository, {filters}),\n-    (events: TrustedEvent[]) =\u003e {\n-      if (!attempted \u0026\u0026 events.length === 0) {\n-        load({relays: relays as string[], filters})\n-        attempted = true\n-      }\n-      return events[0]\n+  const filters = [\n+    {\n+      authors: [decoded.pubkey],\n+      kinds: [decoded.kind],\n+      \"#d\": [decoded.identifier],\n     },\n-  )\n+  ]\n+\n+  return derived(deriveEvents(repository, {filters}), (events: TrustedEvent[]) =\u003e {\n+    if (!attempted \u0026\u0026 events.length === 0) {\n+      load({relays: relays as string[], filters})\n+      attempted = true\n+    }\n+    return events[0]\n+  })\n }\n \n export const getUrlsForEvent = derived([trackerStore, thunks], ([$tracker, $thunks]) =\u003e {\n@@ -311,7 +313,6 @@ export const getUrlsForEvent = derived([trackerStore, thunks], ([$tracker, $thun\n export const getEventsForUrl = (url: string, filters: Filter[]) =\u003e {\n   const $getUrlsForEvent = get(getUrlsForEvent)\n   const $events = repository.query(filters)\n-\n   return sortBy(\n     e =\u003e -e.created_at,\n     $events.filter(e =\u003e $getUrlsForEvent(e.id).includes(url)),\n@@ -558,17 +559,15 @@ export const splitChannelId = (id: string) =\u003e id.split(\"'\")\n export const hasNip29 = (relay?: Relay) =\u003e\n   relay?.profile?.supported_nips?.map?.(String)?.includes?.(\"29\")\n \n-export const channelEvents = deriveEvents(repository, {filters: [{kinds: [ROOM_META]}]})\n+export const channelEvents = deriveEvents(repository, {filters: [{kinds: [ROOM_META, ROOMS]}]})\n \n export const channels = derived(\n-  [channelEvents, getUrlsForEvent],\n-  ([$channelEvents, $getUrlsForEvent]) =\u003e {\n+  [channelEvents, getUrlsForEvent, memberships, messages],\n+  ([$channelEvents, $getUrlsForEvent, $memberships, $messages]) =\u003e {\n     const $channels: Channel[] = []\n-\n     for (const event of $channelEvents) {\n       const meta = fromPairs(event.tags)\n       const room = meta.d\n-\n       if (room) {\n         for (const url of $getUrlsForEvent(event.id)) {\n           const id = makeChannelId(url, room)\n@@ -588,12 +587,52 @@ export const channels = derived(\n       }\n     }\n \n+    // Add known rooms based on membership events\n+    for (const membership of $memberships) {\n+      for (const {url, room, name} of getMembershipRooms(membership)) {\n+        const id = makeChannelId(url, room)\n+\n+        if (!$channels.some(c =\u003e c.id === id)) {\n+          $channels.push({\n+            id,\n+            url,\n+            room,\n+            name,\n+            event,\n+            closed: false,\n+            private: false,\n+          })\n+        }\n+      }\n+    }\n+\n+    // Add rooms based on known messages\n+    for (const event of $messages) {\n+      const [_, room] = event.tags.find(nthEq(0, ROOM)) || []\n+\n+      if (room) {\n+        for (const url of $getUrlsForEvent(event.id)) {\n+          const id = makeChannelId(url, room)\n+\n+          if (!$channels.some(c =\u003e c.id === id)) {\n+            $channels.push({\n+              id,\n+              url,\n+              room,\n+              name: room,\n+              event,\n+              closed: false,\n+              private: false,\n+            })\n+          }\n+        }\n+      }\n+    }\n+\n     return uniqBy(c =\u003e c.id, $channels)\n   },\n )\n \n-export const channelsByUrl = derived(channels, $channels =\u003e groupBy(c =\u003e c.url, $channels))\n-\n export const {\n   indexStore: channelsById,\n   deriveItem: _deriveChannel,\n@@ -601,23 +640,38 @@ export const {\n } = collection({\n   name: \"channels\",\n   store: channels,\n-  getKey: channel =\u003e channel.id,\n+  getKey: channel =\u003e {\n+    return channel.id\n+  },\n   load: async (id: string) =\u003e {\n     const [url, room] = splitChannelId(id)\n-\n     await load({\n       relays: [url],\n-      filters: [{kinds: [ROOM_META], \"#d\": [room]}],\n+      filters: [{kinds: [ROOM_META], \"#d\": [room]}, {kinds: [ROOMS]}],\n     })\n   },\n })\n \n+export const channelsByUrl = derived(channelsById, $channelsById =\u003e {\n+  const $channelsByUrl = new Map\u003cstring, Channel[]\u003e()\n+\n+  for (const channel of $channelsById.values()) {\n+    pushToMapKey($channelsByUrl, channel.url, channel)\n+  }\n+\n+  return $channelsByUrl\n+})\n+\n export const deriveChannel = (url: string, room: string) =\u003e _deriveChannel(makeChannelId(url, room))\n \n export const loadChannel = (url: string, room: string) =\u003e _loadChannel(makeChannelId(url, room))\n \n-export const displayChannel = (url: string, room: string) =\u003e\n-  channelsById.get().get(makeChannelId(url, room))?.name || room\n+export const displayChannel = (url: string, room: string) =\u003e {\n+  if (room === GENERAL) {\n+    return \"general\"\n+  }\n+  return channelsById.get().get(makeChannelId(url, room))?.name || room\n+}\n \n export const roomComparator = (url: string) =\u003e (room: string) =\u003e\n   displayChannel(url, room).toLowerCase()\n@@ -651,7 +705,7 @@ export const userMembership = withGetter(\n )\n \n export const userRoomsByUrl = withGetter(\n-  derived([userMembership, channelsById], ([$userMembership, $channelsById]) =\u003e {\n+  derived(userMembership, $userMembership =\u003e {\n     const tags = getListTags($userMembership)\n     const $userRoomsByUrl = new Map\u003cstring, Set\u003cstring\u003e\u003e()\n \n@@ -660,9 +714,11 @@ export const userRoomsByUrl = withGetter(\n     }\n \n     for (const [_, room, url] of getGroupTags(tags)) {\n-      if ($channelsById.has(makeChannelId(url, room))) {\n-        addToMapKey($userRoomsByUrl, normalizeRelayUrl(url), room)\n-      }\n+      addToMapKey($userRoomsByUrl, normalizeRelayUrl(url), room)\n+    }\n+\n+    for (const url of getRelayTagValues(tags)) {\n+      addToMapKey($userRoomsByUrl, normalizeRelayUrl(url), GENERAL)\n     }\n \n     return $userRoomsByUrl\n@@ -671,7 +727,7 @@ export const userRoomsByUrl = withGetter(\n \n export const deriveUserRooms = (url: string) =\u003e\n   derived(userRoomsByUrl, $userRoomsByUrl =\u003e\n-    sortBy(roomComparator(url), uniq(Array.from($userRoomsByUrl.get(url) || []))),\n+    sortBy(roomComparator(url), uniq(Array.from($userRoomsByUrl.get(url) || [GENERAL]))),\n   )\n \n export const deriveOtherRooms = (url: string) =\u003e\ndiff --git a/src/routes/spaces/[relay]/+layout.svelte b/src/routes/spaces/[relay]/+layout.svelte\nindex 9abe9f3..f2e7ab0 100644\n--- a/src/routes/spaces/[relay]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/+layout.svelte\n@@ -2,7 +2,7 @@\n   import {onMount} from \"svelte\"\n   import {page} from \"$app/stores\"\n   import {ago, MONTH} from \"@welshman/lib\"\n-  import {ROOM_META, EVENT_TIME, THREAD, COMMENT, MESSAGE} from \"@welshman/util\"\n+  import {ROOM_META, EVENT_TIME, THREAD, COMMENT, MESSAGE, ROOMS} from \"@welshman/util\"\n   import Page from \"@lib/components/Page.svelte\"\n   import SecondaryNav from \"@lib/components/SecondaryNav.svelte\"\n   import MenuSpace from \"@app/components/MenuSpace.svelte\"\n@@ -60,6 +60,7 @@\n     pullConservatively({\n       relays,\n       filters: [\n+        {kinds: [ROOMS]},\n         {kinds: [ROOM_META]},\n         {kinds: [GIT_REPO]},\n         {kinds: [THREAD, EVENT_TIME], since},\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-refactor-svelte5-host","title":"Migrate host-side extension code to Svelte 5","description":"Update all host-side extension code to use Svelte 5 runes ($state, $derived, $effect, $props) and remove legacy Svelte APIs.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T00:21:39.733124-08:00"}
{"id":"flotilla-rje59zeu","title":"bug: Copy button generates invalid file permalink","description":"When clicking the permalink copy button, it provides an invalid link. The\ngenerated link was \u003chttps://\u003cDOMAIN\u003e/git/repo/README.md\u003e, which leads to a 404\nerror page when opened.\n\n#bug","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T18:05:14.810593-08:00","closed_at":"2026-01-24T18:05:14.810593-08:00","close_reason":"Verified implemented via codebase triage","labels":["bug","draft","issue"]}
{"id":"flotilla-rldwv1hm","title":"Git tab: Select 'My Repos' by default","description":"Obvious choice","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue","repos"]}
{"id":"flotilla-rrly3947","title":"From 8a27c89f04c63e5675e714554f8c74c9b81691a9 Mon Sep 17 00:00:00 2001","description":"From 8a27c89f04c63e5675e714554f8c74c9b81691a9 Mon Sep 17 00:00:00 2001\nFrom: Five \u003cco22rkn@protonmail.com\u003e\nDate: Fri, 20 Jun 2025 12:25:41 +0200\nSubject: [PATCH 5/9] Enable adding git repos while fetching the tracked ones - Since repo loading is reactively passed into the RepoPicker it is not necessarily a problem if we edit repos while loading Although it was problematic when user had zero repos and the long loading blocked user to add repos\n\n---\n src/routes/spaces/[relay]/git/+page.svelte | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 9facc8e..8fbb669 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -109,7 +109,7 @@\n   {/snippet}\n   {#snippet action()}\n     \u003cdiv class=\"row-2\"\u003e\n-      \u003cButton class=\"btn btn-primary btn-sm\" disabled={loading} onclick={onAddRepo}\u003e\n+      \u003cButton class=\"btn btn-primary btn-sm\" onclick={onAddRepo}\u003e\n         \u003cIcon icon=\"git\" /\u003e\n         Add Repo\n       \u003c/Button\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-rslwdbw0","title":"From 422c49a8367eaacfb98e068089edff0c24d5bd88 Mon Sep 17 00:00:00 2001","description":"From 422c49a8367eaacfb98e068089edff0c24d5bd88 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 24 Jun 2025 20:45:48 -0700\nSubject: [PATCH 8/8] feat: add comment count and improve profile links in patch views\n\n---\n packages/nostr-git                                                      |   2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           | 199 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte |  12 +++++++++---\n 3 files changed, 112 insertions(+), 101 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex ced0a44..606defd 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit ced0a443ff4f13e5095277df8893606846885a29\n+Subproject commit 606defd36b6ebb5e3c961d6953794097ebad46a5\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 6a02a7c..4176bdb 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -1,6 +1,16 @@\n \u003cscript lang=\"ts\"\u003e\n   import {Button, PatchCard} from \"@nostr-git/ui\"\n-  import {CalendarDays, Check, Clock, Funnel, GitCommit, Plus, SearchX, User, X} from \"@lucide/svelte\"\n+  import {\n+    CalendarDays,\n+    Check,\n+    Clock,\n+    Funnel,\n+    GitCommit,\n+    Plus,\n+    SearchX,\n+    User,\n+    X,\n+  } from \"@lucide/svelte\"\n   import {Address, COMMENT} from \"@welshman/util\"\n   import {nthEq} from \"@welshman/lib\"\n   import {repository} from \"@welshman/app\"\n@@ -14,10 +24,11 @@\n     GIT_STATUS_CLOSED,\n     GIT_STATUS_DRAFT,\n   } from \"@welshman/util\"\n-  import {fly} from \"@lib/transition\"\n+  import {fly, slide} from \"@lib/transition\"\n   import {load} from \"@welshman/net\"\n   import {getTags, type PatchEvent, type StatusEvent} from \"@nostr-git/shared-types\"\n   import {parseGitPatchFromEvent} from \"@nostr-git/core\"\n+    import { get } from \"svelte/store\"\n \n   const {data} = $props()\n   const {repoClass} = data\n@@ -33,23 +44,22 @@\n   let sortBy = $state\u003cstring\u003e(\"newest\") // newest, oldest, status, commits\n   let authorFilter = $state\u003cstring\u003e(\"\") // empty string means all authors\n   let showFilters = $state(false)\n-    \n+\n   // Get all unique authors from patches\n   const uniqueAuthors = $derived.by(() =\u003e {\n     if (!repoClass.patches) return []\n-    \n+\n     const authors = new Set\u003cstring\u003e()\n     repoClass.patches.forEach((patch: PatchEvent) =\u003e {\n       const pubkey = patch.pubkey\n       if (pubkey) authors.add(pubkey)\n     })\n-    \n+\n     return Array.from(authors)\n   })\n-  \n+\n   const patchList = $derived.by(() =\u003e {\n     if (repoClass.patches \u0026\u0026 $statusEvents.length \u003e 0) {\n-      // First get all root patches\n       let filteredPatches = repoClass.patches\n         .filter((patch: PatchEvent) =\u003e {\n           const tags = getTags(patch, \"t\")\n@@ -67,28 +77,28 @@\n             const tags = getTags(issue, \"e\")\n             return tags.length \u003e 0 \u0026\u0026 tags[0][1] === patch.id\n           })\n-\n-          // Parse the patch to get additional metadata\n           const parsedPatch = parseGitPatchFromEvent(patch)\n-          \n+\n+          const comments = deriveEvents(repository, {\n+            filters: [{kinds: [COMMENT], \"#E\": [patch.id]}],\n+          })\n+\n           return {\n             ...patch,\n             patches,\n             status,\n+            comments,\n             parsedPatch,\n-            // Add commit count directly for easier sorting\n             commitCount: parsedPatch?.commitCount || 0,\n           }\n         })\n-      \n-      // Apply status filter\n+\n       if (statusFilter !== \"all\") {\n         filteredPatches = filteredPatches.filter(patch =\u003e {\n           if (!patch.status) {\n-            // If no status and filter is \"open\", show it (default is open)\n             return statusFilter === \"open\"\n           }\n-          \n+\n           switch (statusFilter) {\n             case \"open\":\n               return patch.status.kind === GIT_STATUS_OPEN\n@@ -103,18 +113,16 @@\n           }\n         })\n       }\n-      \n+\n       // Apply author filter\n       if (authorFilter) {\n         filteredPatches = filteredPatches.filter(patch =\u003e patch.pubkey === authorFilter)\n       }\n-      \n-      // Create a new array to avoid mutating the original\n+\n       let sortedPatches = [...filteredPatches]\n-      \n-      // Apply sorting - make a copy first to ensure reactivity\n-      const currentSortBy = sortBy // Capture the current sort value\n-      \n+\n+      const currentSortBy = sortBy\n+\n       if (currentSortBy === \"newest\") {\n         sortedPatches.sort((a, b) =\u003e b.created_at - a.created_at)\n       } else if (currentSortBy === \"oldest\") {\n@@ -125,11 +133,16 @@\n           const getStatusPriority = (status?: any) =\u003e {\n             if (!status) return 0 // Open (default)\n             switch (status.kind) {\n-              case GIT_STATUS_OPEN: return 0\n-              case GIT_STATUS_DRAFT: return 1\n-              case GIT_STATUS_COMPLETE: return 2\n-              case GIT_STATUS_CLOSED: return 3\n-              default: return 4\n+              case GIT_STATUS_OPEN:\n+                return 0\n+              case GIT_STATUS_DRAFT:\n+                return 1\n+              case GIT_STATUS_COMPLETE:\n+                return 2\n+              case GIT_STATUS_CLOSED:\n+                return 3\n+              default:\n+                return 4\n             }\n           }\n           return getStatusPriority(a.status) - getStatusPriority(b.status)\n@@ -182,21 +195,20 @@\n \u003c/script\u003e\n \n \u003cdiv bind:this={element}\u003e\n-  \u003cdiv class=\"z-10 sticky -top-8 z-nav mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n+  \u003cdiv class=\"z-10 sticky -top-8 z-nav mb-2 flex items-center justify-between py-4 backdrop-blur\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003ePatches\u003c/h2\u003e\n       \u003cp class=\"text-sm text-muted-foreground\"\u003eReview and merge code changes\u003c/p\u003e\n     \u003c/div\u003e\n \n     \u003cdiv class=\"flex items-center gap-2\"\u003e\n-      \u003cButton \n-        variant=\"outline\" \n-        size=\"sm\" \n-        class=\"gap-2\" \n-        onclick={() =\u003e showFilters = !showFilters}\n-      \u003e\n+      \u003cButton\n+        variant=\"outline\"\n+        size=\"sm\"\n+        class=\"gap-2\"\n+        onclick={() =\u003e (showFilters = !showFilters)}\u003e\n         \u003cFunnel class=\"h-4 w-4\" /\u003e\n-        {showFilters ? 'Hide Filters' : 'Filter'}\n+        {showFilters ? \"Hide Filters\" : \"Filter\"}\n       \u003c/Button\u003e\n \n       \u003cButton size=\"sm\" class=\"gap-2 bg-git hover:bg-git-hover\"\u003e\n@@ -207,113 +219,102 @@\n   \u003c/div\u003e\n \n   {#if showFilters}\n-    \u003cdiv class=\"mb-6 p-4 border border-border rounded-md bg-card\"\u003e\n-      \u003cdiv class=\"grid grid-cols-1 md:grid-cols-2 gap-4\"\u003e\n+    \u003cdiv class=\"mb-6 rounded-md border border-border bg-card p-4\" transition:slide\u003e\n+      \u003cdiv class=\"grid grid-cols-1 gap-4 md:grid-cols-2\"\u003e\n         \u003c!-- Status Filter --\u003e\n         \u003cdiv\u003e\n-          \u003ch3 class=\"text-sm font-medium mb-2\"\u003eStatus\u003c/h3\u003e\n+          \u003ch3 class=\"mb-2 text-sm font-medium\"\u003eStatus\u003c/h3\u003e\n           \u003cdiv class=\"flex flex-wrap gap-2\"\u003e\n-            \u003cButton \n-              variant={statusFilter === \"all\" ? \"default\" : \"outline\"} \n+            \u003cButton\n+              variant={statusFilter === \"all\" ? \"default\" : \"outline\"}\n               size=\"sm\"\n-              onclick={() =\u003e statusFilter = \"all\"}\n-            \u003e\n+              onclick={() =\u003e (statusFilter = \"all\")}\u003e\n               All\n             \u003c/Button\u003e\n-            \u003cButton \n-              variant={statusFilter === \"open\" ? \"default\" : \"outline\"} \n+            \u003cButton\n+              variant={statusFilter === \"open\" ? \"default\" : \"outline\"}\n               size=\"sm\"\n-              onclick={() =\u003e statusFilter = \"open\"}\n-              class=\"gap-1\"\n-            \u003e\n+              onclick={() =\u003e (statusFilter = \"open\")}\n+              class=\"gap-1\"\u003e\n               \u003cGitCommit class=\"h-3 w-3\" /\u003e Open\n             \u003c/Button\u003e\n-            \u003cButton \n-              variant={statusFilter === \"applied\" ? \"default\" : \"outline\"} \n+            \u003cButton\n+              variant={statusFilter === \"applied\" ? \"default\" : \"outline\"}\n               size=\"sm\"\n-              onclick={() =\u003e statusFilter = \"applied\"}\n-              class=\"gap-1\"\n-            \u003e\n+              onclick={() =\u003e (statusFilter = \"applied\")}\n+              class=\"gap-1\"\u003e\n               \u003cCheck class=\"h-3 w-3\" /\u003e Applied\n             \u003c/Button\u003e\n-            \u003cButton \n-              variant={statusFilter === \"closed\" ? \"default\" : \"outline\"} \n+            \u003cButton\n+              variant={statusFilter === \"closed\" ? \"default\" : \"outline\"}\n               size=\"sm\"\n-              onclick={() =\u003e statusFilter = \"closed\"}\n-              class=\"gap-1\"\n-            \u003e\n+              onclick={() =\u003e (statusFilter = \"closed\")}\n+              class=\"gap-1\"\u003e\n               \u003cX class=\"h-3 w-3\" /\u003e Closed\n             \u003c/Button\u003e\n-            \u003cButton \n-              variant={statusFilter === \"draft\" ? \"default\" : \"outline\"} \n+            \u003cButton\n+              variant={statusFilter === \"draft\" ? \"default\" : \"outline\"}\n               size=\"sm\"\n-              onclick={() =\u003e statusFilter = \"draft\"}\n-              class=\"gap-1\"\n-            \u003e\n+              onclick={() =\u003e (statusFilter = \"draft\")}\n+              class=\"gap-1\"\u003e\n               \u003cClock class=\"h-3 w-3\" /\u003e Draft\n             \u003c/Button\u003e\n           \u003c/div\u003e\n         \u003c/div\u003e\n-        \n+\n         \u003c!-- Sort Options --\u003e\n         \u003cdiv\u003e\n-          \u003ch3 class=\"text-sm font-medium mb-2\"\u003eSort By\u003c/h3\u003e\n+          \u003ch3 class=\"mb-2 text-sm font-medium\"\u003eSort By\u003c/h3\u003e\n           \u003cdiv class=\"flex flex-wrap gap-2\"\u003e\n-            \u003cButton \n-              variant={sortBy === \"newest\" ? \"default\" : \"outline\"} \n+            \u003cButton\n+              variant={sortBy === \"newest\" ? \"default\" : \"outline\"}\n               size=\"sm\"\n-              onclick={() =\u003e sortBy = \"newest\"}\n-              class=\"gap-1\"\n-            \u003e\n+              onclick={() =\u003e (sortBy = \"newest\")}\n+              class=\"gap-1\"\u003e\n               \u003cCalendarDays class=\"h-3 w-3\" /\u003e Newest\n             \u003c/Button\u003e\n-            \u003cButton \n-              variant={sortBy === \"oldest\" ? \"default\" : \"outline\"} \n+            \u003cButton\n+              variant={sortBy === \"oldest\" ? \"default\" : \"outline\"}\n               size=\"sm\"\n-              onclick={() =\u003e sortBy = \"oldest\"}\n-              class=\"gap-1\"\n-            \u003e\n+              onclick={() =\u003e (sortBy = \"oldest\")}\n+              class=\"gap-1\"\u003e\n               \u003cCalendarDays class=\"h-3 w-3\" /\u003e Oldest\n             \u003c/Button\u003e\n-            \u003cButton \n-              variant={sortBy === \"status\" ? \"default\" : \"outline\"} \n+            \u003cButton\n+              variant={sortBy === \"status\" ? \"default\" : \"outline\"}\n               size=\"sm\"\n-              onclick={() =\u003e sortBy = \"status\"}\n-              class=\"gap-1\"\n-            \u003e\n+              onclick={() =\u003e (sortBy = \"status\")}\n+              class=\"gap-1\"\u003e\n               \u003cCheck class=\"h-3 w-3\" /\u003e Status\n             \u003c/Button\u003e\n-            \u003cButton \n-              variant={sortBy === \"commits\" ? \"default\" : \"outline\"} \n+            \u003cButton\n+              variant={sortBy === \"commits\" ? \"default\" : \"outline\"}\n               size=\"sm\"\n-              onclick={() =\u003e sortBy = \"commits\"}\n-              class=\"gap-1\"\n-            \u003e\n+              onclick={() =\u003e (sortBy = \"commits\")}\n+              class=\"gap-1\"\u003e\n               \u003cGitCommit class=\"h-3 w-3\" /\u003e Commits\n             \u003c/Button\u003e\n           \u003c/div\u003e\n         \u003c/div\u003e\n-        \n+\n         \u003c!-- Author Filter --\u003e\n         {#if uniqueAuthors.length \u003e 1}\n           \u003cdiv class=\"md:col-span-2\"\u003e\n-            \u003ch3 class=\"text-sm font-medium mb-2\"\u003eAuthor\u003c/h3\u003e\n+            \u003ch3 class=\"mb-2 text-sm font-medium\"\u003eAuthor\u003c/h3\u003e\n             \u003cdiv class=\"flex flex-wrap gap-2\"\u003e\n-              \u003cButton \n-                variant={authorFilter === \"\" ? \"default\" : \"outline\"} \n+              \u003cButton\n+                variant={authorFilter === \"\" ? \"default\" : \"outline\"}\n                 size=\"sm\"\n-                onclick={() =\u003e authorFilter = \"\"}\n-              \u003e\n+                onclick={() =\u003e (authorFilter = \"\")}\u003e\n                 All Authors\n               \u003c/Button\u003e\n-              \n+\n               {#each uniqueAuthors as author}\n-                \u003cButton \n-                  variant={authorFilter === author ? \"default\" : \"outline\"} \n+                \u003cButton\n+                  variant={authorFilter === author ? \"default\" : \"outline\"}\n                   size=\"sm\"\n-                  onclick={() =\u003e authorFilter = author}\n-                  class=\"gap-1\"\n-                \u003e\n+                  onclick={() =\u003e (authorFilter = author)}\n+                  class=\"gap-1\"\u003e\n                   \u003cUser class=\"h-3 w-3\" /\u003e\n                   \u003cspan class=\"text-sm\"\u003e{author.slice(0, 8)}...\u003c/span\u003e\n                 \u003c/Button\u003e\n@@ -344,7 +345,11 @@\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each patchList! as patch}\n         \u003cdiv in:fly\u003e\n-          \u003cPatchCard event={patch} patches={patch.patches} status={patch.status as StatusEvent} /\u003e\n+          \u003cPatchCard\n+            event={patch}\n+            patches={patch.patches}\n+            status={patch.status as StatusEvent}\n+            commentCount={get(patch.comments).length} /\u003e\n         \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex e97c793..45c48c5 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -2,6 +2,7 @@\n   import {page} from \"$app/stores\"\n   import {Check, ChevronLeft, ChevronRight, GitCommit, MessageSquare, X} from \"@lucide/svelte\"\n   import {Button, Profile} from \"@nostr-git/ui\"\n+  import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import {DiffViewer, IssueThread} from \"@nostr-git/ui\"\n   import {pubkey, repository} from \"@welshman/app\"\n   import markdownit from \"markdown-it\"\n@@ -114,6 +115,10 @@\n     }\n   })\n \n+  function truncateHash(hash: string): string {\n+    return hash.substring(0, 7);\n+  }\n+\n   const md = markdownit({\n     html: true,\n     linkify: true,\n@@ -161,7 +166,8 @@\n                       : \"Closed\"}\n                 \u003c/div\u003e\n                 \u003cspan class=\"text-sm text-muted-foreground\"\u003e\n-                  {patch?.author.name} opened this patch • {new Date(\n+                  \u003cProfileLink pubkey={patch?.author.pubkey}/\u003e\n+                  opened this patch • {new Date(\n                     patch?.createdAt,\n                   ).toLocaleString()}\n                 \u003c/span\u003e\n@@ -207,12 +213,12 @@\n               \u003cdiv class=\"flex-grow\"\u003e\n                 \u003cdiv class=\"font-semibold break-words\"\u003e{patchItem.title || `Patch ${index + 1}`}\u003c/div\u003e\n                 \u003cdiv class=\"text-sm text-muted-foreground flex items-center gap-2\"\u003e\n-                  \u003cspan\u003e{patchItem.author.name || patchItem.author.pubkey.slice(0, 8)}\u003c/span\u003e\n+                  \u003cProfileLink pubkey={patchItem.author.pubkey}/\u003e\n                   \u003cspan\u003e•\u003c/span\u003e\n                   \u003cspan\u003e{new Date(patchItem.createdAt).toLocaleString()}\u003c/span\u003e\n                   {#if patchItem.commitHash}\n                     \u003cspan\u003e•\u003c/span\u003e\n-                    \u003cspan\u003e{patchItem.commitHash}\u003c/span\u003e\n+                    \u003cspan\u003e{truncateHash(patchItem.commitHash)}\u003c/span\u003e\n                   {/if}\n                   {#if isRoot}\n                     \u003cspan class=\"ml-1 px-1.5 py-0.5 text-xs rounded bg-blue-500/20 text-blue-500\"\u003eroot\u003c/span\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-rw5rdxrl","title":"From d449470777405fb8e9379c39516f177edb877ef2 Mon Sep 17 00:00:00 2001","description":"From d449470777405fb8e9379c39516f177edb877ef2 Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/1] Test patch for merge\n\nthis is a test patch that I intend to merge in budabit UI","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-ryp62xbc","title":"Distinguish open/closed issues on UI better","description":"1. Posting new issue should appear on top\n2. Closed issues should not be shown by default in the list","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue"]}
{"id":"flotilla-rzaomte2","title":"From e5526625941f6a80213d8e0677f8e9ec04ad3241 Mon Sep 17 00:00:00 2001","description":"From e5526625941f6a80213d8e0677f8e9ec04ad3241 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 23 Jun 2025 08:17:17 -0700\nSubject: [PATCH 3/8] refactor: migrate git patch status to separate events with improved UI handling\n\n---\n packages/nostr-git                                                      |  2 +-\n src/app/state.ts                                                        |  2 --\n src/lib/unknown-kinds.ts                                                |  8 ++++----\n src/routes/spaces/[relay]/[room]/+page.svelte                           |  1 +\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts                     | 29 ++++++++++++++++++++++-------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte                   |  4 ++--\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           | 30 +++++++++++++++++-------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 46 ++++++++++++++++++++++++++--------------------\n src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte         |  2 +-\n 9 files changed, 74 insertions(+), 50 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 7fc008d..97a87ad 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 7fc008d7736259976f22c8390c37c1f61f0a3410\n+Subproject commit 97a87adc93387f1f5378ab7fd6a0b6bac1f17d7d\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex f038616..168bfea 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -540,12 +540,10 @@ export const channelsById = withGetter(\n     [groupMeta, memberships, messages, getUrlsForEvent],\n     ([$groupMeta, $memberships, $messages, $getUrlsForEvent]) =\u003e {\n       const channelsById = new Map\u003cstring, Channel\u003e()\n-\n       // Add meta using group meta events\n       for (const event of $groupMeta) {\n         const meta = fromPairs(event.tags)\n         const room = meta.d\n-\n         if (room) {\n           for (const url of $getUrlsForEvent(event.id)) {\n             const id = makeChannelId(url, room)\ndiff --git a/src/lib/unknown-kinds.ts b/src/lib/unknown-kinds.ts\nindex 3f9eb87..c0f9210 100644\n--- a/src/lib/unknown-kinds.ts\n+++ b/src/lib/unknown-kinds.ts\n@@ -9,8 +9,8 @@ const DEFAULT_TEMPLATES: Record\u003cnumber, string\u003e = {\n   10002: \"canonical relays list for {{pubkey}}\",\n \n   1111: \"{{content}}\",\n-  30617: \"git repository {{tags.name}} hosted at {{tags.h}} by {{pubkey}}\",\n-  30618: \"git repository state {{tags.d}} hosted at {{tags.h[0]}} by {{pubkey}}\",\n+  30617: \"Git repository {{tags.name}} hosted at {{{tags.clone}}} by {{#npub}}{{pubkey}}{{/npub}}\",\n+  30618: \"## Git repository state {{tags.d}} hosted at {{tags.clone}} by {{#npub}}{{pubkey}}{{/npub}}\",\n   1617: \"```\\n{{{content}}}\\n```\",\n   1621: \"{{#tags.subject}}Subject{{tags.subject}}\\n{{/tags.subject}}{{content}} {{#npub}}{{tags.p}}{{/npub}}\",\n   1623: \"```\\n{{{content}}}\\n```\",\n@@ -53,9 +53,9 @@ export function unknownKindFallback(\n       tags: tagsToObj(params.tags),\n       nevent: () =\u003e (txt: string, render: (s: string) =\u003e string) =\u003e {\n         const hex = render(txt).trim().toLowerCase();\n-        return \"nostr:\" + nip19.neventEncode({id: hex, relays: []});\n+        return \"nostr:\" + nip19.neventEncode({ id: hex, relays: [] });\n       },\n-\t  npub: () =\u003e (txt: string, render: (s: string) =\u003e string) =\u003e {\n+      npub: () =\u003e (txt: string, render: (s: string) =\u003e string) =\u003e {\n         const hex = render(txt).trim().toLowerCase()\n         return \"nostr:\" + nip19.npubEncode(hex);\n       },\ndiff --git a/src/routes/spaces/[relay]/[room]/+page.svelte b/src/routes/spaces/[relay]/[room]/+page.svelte\nindex 9360a55..a315a4c 100644\n--- a/src/routes/spaces/[relay]/[room]/+page.svelte\n+++ b/src/routes/spaces/[relay]/[room]/+page.svelte\n@@ -27,6 +27,7 @@\n     userRoomsByUrl,\n     displayChannel,\n     getEventsForUrl,\n+    channelsById,\n   } from \"@app/state\"\n   import {setChecked, checked} from \"@app/notifications\"\n   import {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nindex b5a3c26..fe5a0b5 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -6,8 +6,9 @@ import {\n     type PatchEvent,\n     type RepoAnnouncementEvent,\n     type RepoStateEvent,\n+    type StatusEvent,\n } from '@nostr-git/shared-types';\n-import { GIT_ISSUE, GIT_PATCH } from '@welshman/util';\n+import { GIT_ISSUE, GIT_PATCH, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE, GIT_STATUS_DRAFT, GIT_STATUS_OPEN } from '@welshman/util';\n import { nip19 } from 'nostr-tools';\n import type { AddressPointer } from 'nostr-tools/nip19';\n import { nthEq } from '@welshman/lib';\n@@ -28,7 +29,7 @@ export async function load({ params }) {\n     const url = decodeRelay(relay);\n \n     const fallbackRelays = INDEXER_RELAYS\n-    const relayList = (decoded.relays?.length ?? 0) \u003e 0 ? decoded.relays : fallbackRelays\n+    const relayList: string[] = (decoded.relays?.length ?? 0) \u003e 0 ? decoded.relays ?? fallbackRelays : fallbackRelays\n \n     const filters = [{\n         authors: [decoded.pubkey],\n@@ -36,9 +37,8 @@ export async function load({ params }) {\n         \"#d\": [decoded.identifier],\n     }]\n \n-    await load({ relays: relayList as string[], filters })\n+    await load({ relays: relayList, filters })\n \n-    // Combine the separate event stores\n     const repoEvent = derived(deriveEvents(repository, {\n         filters: [{\n             authors: [decoded.pubkey],\n@@ -74,9 +74,9 @@ export async function load({ params }) {\n         \"#a\": [`${GIT_REPO}:${decoded.pubkey}:${decoded.identifier}`],\n     }\n \n-    await load({ \n-        relays: relayList as string[], \n-        filters: [issueFilters, patchFilters] \n+    await load({\n+        relays: relayList as string[],\n+        filters: [issueFilters, patchFilters]\n     })\n \n     // Create derived stores for issues and patches\n@@ -94,6 +94,20 @@ export async function load({ params }) {\n         (events) =\u003e (events || []) as PatchEvent[]\n     );\n \n+    const patchStatusFilter = derived(patches, (patches) =\u003e {\n+        return {\n+            kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+            \"#a\": patches.map((patch) =\u003e patch.id),\n+        }\n+    });\n+\n+    const patchStatusEvents: Readable\u003cStatusEvent[]\u003e = derived(\n+        deriveEvents(repository, {\n+            filters: [patchStatusFilter],\n+        }),\n+        (events) =\u003e (events || []) as StatusEvent[]\n+    );\n+\n     const functionRegistry = {\n         postComment: (comment: CommentEvent) =\u003e {\n             return publishThunk({\n@@ -115,6 +129,7 @@ export async function load({ params }) {\n         repoStateEvent,\n         issues,\n         patches,\n+        patchStatusEvents,\n     });\n \n     return {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex ef80698..31b58f4 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -324,10 +324,10 @@\n                       \u003cGitPullRequest class=\"mt-0.5 h-4 w-4 text-purple-500\" /\u003e\n                       \u003cdiv class=\"min-w-0 flex-1\"\u003e\n                         \u003cp class=\"truncate text-sm font-medium\"\u003e\n-                          {patch.tags.find(nthEq(0, \"title\"))?.[1] || \"Untitled Patch\"}\n+                          {patch.title || \"Untitled Patch\"}\n                         \u003c/p\u003e\n                         \u003cp class=\"text-xs text-muted-foreground\"\u003e\n-                          {formatDate(new Date(patch.created_at * 1000))}\n+                          {patch.createdAt}\n                         \u003c/p\u003e\n                       \u003c/div\u003e\n                     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 24ac7bd..3ea5803 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -16,32 +16,36 @@\n   } from \"@welshman/util\"\n   import {fly} from \"@lib/transition\"\n   import {load} from \"@welshman/net\"\n+  import {parseStatusEvent, type Patch, type StatusEvent} from \"@nostr-git/shared-types\"\n \n   const {data} = $props()\n   const {repoClass} = data\n \n   const statusFilter = {\n     kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n-    \"#e\": [...repoClass.patches.map((patch: TrustedEvent) =\u003e patch.id)],\n+    \"#e\": [...repoClass.patches.map((patch: Patch) =\u003e patch.id)],\n   }\n-\n-  const statuses = deriveEvents(repository, {filters: [statusFilter]})\n+  const statusEvents = deriveEvents(repository, {filters: [statusFilter]})\n \n   const patchList = $derived.by(() =\u003e {\n-    if (repoClass.patches) {\n-      return repoClass.patches.map((patch: TrustedEvent) =\u003e {\n-        const profile = deriveProfile(patch.pubkey)\n-        let status = $statuses\n-          ?.filter(s =\u003e {\n+    if (repoClass.patches \u0026\u0026 $statusEvents.length \u003e 0) {\n+      return repoClass.patches.map((patch: Patch) =\u003e {\n+        const profile = deriveProfile(patch.author.pubkey)\n+        const statusEvent = $statusEvents\n+          ?.filter((s: any) =\u003e {\n             let [_, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n             return eventId === patch.id\n           })\n-          .sort((a: TrustedEvent, b: TrustedEvent) =\u003e b.created_at - a.created_at)[0]\n+          .sort((a: any, b: any) =\u003e b.created_at - a.created_at)[0]\n+\n+        const status = statusEvent ? parseStatusEvent(statusEvent as StatusEvent) : undefined\n+        \n+        console.log($statusEvents)\n+        \n         return {\n           ...patch,\n-          patches: repoClass.patches.filter(\n-            issue =\u003e issue.tags.find(nthEq(0, \"e\"))?.[1] === patch.id,\n-          ),\n+          ...patch.raw,\n+          patches: repoClass.patches.filter(issue =\u003e issue.id === patch.id),\n           status,\n           profile,\n         }\n@@ -61,7 +65,7 @@\n   $effect(() =\u003e {\n     if (repoClass.patches) {\n       load({relays: repoClass.relays, filters: [patchFilter, statusFilter]})\n- \n+\n       makeFeed({\n         element: element!,\n         relays: repoClass.relays,\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 4868926..24a3a23 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -1,27 +1,19 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n   import {GitCommit, MessageSquare, Check, X} from \"@lucide/svelte\"\n-  import {parseGitPatchFromEvent} from \"@nostr-git/core\"\n-  import {Button, Repo} from \"@nostr-git/ui\"\n+  import {Button} from \"@nostr-git/ui\"\n   import {Avatar, AvatarFallback, AvatarImage, DiffViewer, IssueThread} from \"@nostr-git/ui\"\n   import {deriveProfile, repository} from \"@welshman/app\"\n-  import {getContext} from \"svelte\"\n   import markdownit from \"markdown-it\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {load} from \"@welshman/net\"\n-  import {COMMENT, type Filter} from \"@welshman/util\"\n-  import type {CommentEvent} from \"@nostr-git/shared-types\"\n+  import {COMMENT, GIT_STATUS_CLOSED, GIT_STATUS_COMPLETE, GIT_STATUS_DRAFT, GIT_STATUS_OPEN, type Filter} from \"@welshman/util\"\n+  import {isStatusEvent, parseStatusEvent, type CommentEvent, type StatusEvent} from \"@nostr-git/shared-types\"\n \n-  const repoClass = getContext\u003cRepo\u003e(\"repoClass\")\n+  const {data} = $props()\n+  const {repoClass} = data\n \n-  const patch = $derived.by(() =\u003e {\n-    if (repoClass.patches) {\n-      const p = repoClass.patches.find(p =\u003e p.id === $page.params.patchid)\n-      if (p) {\n-        return parseGitPatchFromEvent(p)\n-      }\n-    }\n-  })\n+  const patch = repoClass.patches.find(p =\u003e p.id === $page.params.patchid)\n \n   const threadComments = $derived.by(() =\u003e {\n     if (repoClass.patches) {\n@@ -31,12 +23,26 @@\n     }\n   })\n \n+  const statusFilter = {\n+    kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+    \"#e\": [patch?.id!],\n+  }\n+\n+  const statusEvents = deriveEvents(repository, {filters: [statusFilter]})\n+\n   const patchProfile = $derived.by(() =\u003e {\n     if (patch) {\n       return deriveProfile(patch.author.pubkey)\n     }\n   })\n \n+  const status = $derived.by(() =\u003e {\n+    if ($statusEvents) {\n+      const statusEvent = $statusEvents.filter(isStatusEvent).sort((a, b) =\u003e b.created_at - a.created_at)[0]\n+      return statusEvent ? parseStatusEvent(statusEvent as StatusEvent) : undefined\n+    }\n+  })\n+\n   const md = markdownit({\n     html: true,\n     linkify: true,\n@@ -50,14 +56,14 @@\n       \u003cdiv class=\"rounded-lg border border-border bg-card p-6\"\u003e\n         \u003cdiv class=\"mb-4 flex items-start justify-between\"\u003e\n           \u003cdiv class=\"flex items-start gap-4\"\u003e\n-            {#if patch?.status === \"open\"}\n+            {#if status?.status === \"open\"}\n               \u003cdiv class=\"mt-1\"\u003e\n                 \u003cdiv\n                   class=\"flex h-10 w-10 items-center justify-center rounded-full bg-amber-500/10\"\u003e\n                   \u003cGitCommit class=\"h-5 w-5 text-amber-500\" /\u003e\n                 \u003c/div\u003e\n               \u003c/div\u003e\n-            {:else if patch?.status === \"merged\"}\n+            {:else if status?.status === \"applied\"}\n               \u003cdiv class=\"mt-1\"\u003e\n                 \u003cdiv\n                   class=\"flex h-10 w-10 items-center justify-center rounded-full bg-green-500/10\"\u003e\n@@ -77,10 +83,10 @@\n \n               \u003cdiv class=\"mt-1 flex items-center gap-2\"\u003e\n                 \u003cdiv class=\"git-tag bg-secondary\"\u003e\n-                  {patch?.status === \"open\"\n+                  {status?.status === \"open\"\n                     ? \"Open\"\n-                    : patch?.status === \"merged\"\n-                      ? \"Merged\"\n+                    : status?.status === \"applied\"\n+                      ? \"Applied\"\n                       : \"Closed\"}\n                 \u003c/div\u003e\n                 \u003cspan class=\"text-sm text-muted-foreground\"\u003e\n@@ -106,7 +112,7 @@\n           \u003ch2 class=\"text-lg font-medium\"\u003e{patch?.commitCount} Commits\u003c/h2\u003e\n \n           \u003cdiv class=\"flex items-center gap-2\"\u003e\n-            {#if patch?.status === \"open\"}\n+            {#if status?.status === \"open\"}\n               \u003cButton variant=\"default\" size=\"sm\" class=\"bg-git hover:bg-git-hover\"\u003e\n                 Merge Patch\n               \u003c/Button\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\nindex dba97a7..023f6e4 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/workbench/+page.svelte\n@@ -92,7 +92,7 @@\n     \u003c/div\u003e\n \n     \u003cdiv class=\"mb-6 grid grid-cols-2 gap-6\"\u003e\n-      \u003cPatchSelector patches={repoClass.patches} selectedPatch={$selectedPatch} onPatchSelect={(patch: any) =\u003e selectedPatch = patch} /\u003e\n+      \u003cPatchSelector patches={repoClass.patches} selectedPatch={selectedPatch} onPatchSelect={(patch: any) =\u003e selectedPatch = patch} /\u003e\n       \u003cCommitSelector commits={repoClass.commits} selectedCommit={$selectedCommit} onCommitSelect={(commit: any) =\u003e selectedCommit = commit} /\u003e\n     \u003c/div\u003e\n \n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-s30ig4zn","title":"From de2046e2a2fa4f1dbfa72292ee1eab9ef016c7d6 Mon Sep 17 00:00:00 2001","description":"From de2046e2a2fa4f1dbfa72292ee1eab9ef016c7d6 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 24 Jul 2025 17:27:25 -0700\nSubject: [PATCH 7/7] feat: add CodeMirror language packages and themes for syntax highlighting\n\n---\n package.json       | 10 ++++++++++\n packages/nostr-git |  2 +-\n pnpm-lock.yaml     | Bin 491313 -\u003e 498514 bytes\n 3 files changed, 11 insertions(+), 1 deletion(-)\n\ndiff --git a/package.json b/package.json\nindex 7d94e0e..eeefb9a 100644\n--- a/package.json\n+++ b/package.json\n@@ -50,6 +50,16 @@\n     \"@capacitor/keyboard\": \"^7.0.0\",\n     \"@capacitor/push-notifications\": \"^7.0.1\",\n     \"@capawesome/capacitor-badge\": \"^7.0.1\",\n+    \"@codemirror/lang-css\": \"^6.3.1\",\n+    \"@codemirror/lang-html\": \"^6.4.9\",\n+    \"@codemirror/lang-javascript\": \"^6.2.4\",\n+    \"@codemirror/lang-json\": \"^6.0.2\",\n+    \"@codemirror/lang-markdown\": \"^6.3.3\",\n+    \"@codemirror/lang-python\": \"^6.2.1\",\n+    \"@codemirror/lang-sql\": \"^6.9.0\",\n+    \"@codemirror/lang-xml\": \"^6.1.0\",\n+    \"@codemirror/state\": \"^6.5.2\",\n+    \"@codemirror/theme-one-dark\": \"^6.1.3\",\n     \"@lucide/svelte\": \"^0.482.0\",\n     \"@noble/curves\": \"^1.5.0\",\n     \"@noble/hashes\": \"^1.4.0\",\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 6555b2d..396c5f0 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 6555b2d2897a182d4df818f3afa5f62a173d4b55\n+Subproject commit 396c5f0ef5d79b3007fdd120affa3789aefcd503\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 2a9659fe14aa11969d0706204d09d56722e69639..43a0976cd90986f6f12628a7098e0e84021d9669 100644\nGIT binary patch\ndelta 3450\nzc%1E4+mG956\u003c69gEmO9)nO\u003eG{mszo\u003e)21`=El%7rWpcOUT\u003ckcplL\u0026!wacn2PCytW{\nzw\u0026elsBSI0f1VZY*@`6^CC}NRlwN\u0026uNmcL+E;)RE*%OAkScBV6((hB|nB3X*QbH4LC\nz=l6ZTbH0!NdG#;9e)oRZ{Ur\u003eXIlkQ+FPYrs\u003cJb\u003ceeDD2\u003eA;dLzBVPlyrHQI6pB}pu\nz#\u0026*!1CG^d8!2g50AHl%oQ`^JNv@`BmvN7\u003e}yv^|P@%0VQ1\u003eQje7hroh)-~VgErOnz\nz0WXH\u0026!1R@EwPTI?x)Yd}X6Z_\u003ed}7;}Po\u0026kJAfTTO9Ap#T9-GSkI==kjJ3bJ;0|wi|\nz+p|@o$FQ9xvva{SK`YaS`+PTYV)^9uM\u0026!HLPCUqA!~H7^Tsl3G1XbA9HDSB\u0026rLrFx\nzTK\u003cIC2(}~3\u0026$GgV?}Wd+?Z$Q^r%osxP5eJkujA\u003c{u)Zw6|Lq4q-CMgC@hBSaVeYw7\nz=ms~k;sYmLkP8!afhk~#Es|YL#~Di=RLTu|EKiB9mVyW@tD19^Xy+#a(nygRc?NMd\nzrGrYDrWgyh%ybk?k0?3DBDtZseDrwZt\u003e83#+V?!B-MwgNi|a5`Bw\u003e(cR\u003cVV7m+Z%2\nznqz6KLTjpR\u003c+GgHb{4(FaJ=ZlR4Sh|`zV+0PAe_C$ulMn@?@$u9QU~q-F0Bx7%x=9\nz86%93wjQ7z9^;\u003cRIP_$z0rH$G84y!7+h}cq6%?-EP{j\u0026D@rkB{60n(Uw=0EqhsKmz\nzf7UE6)S-\u0026z\u00268b?|hujbwNqmtYyZG2hG-3\u0026uPs|w6Of7%^_`\u003c3_|5kWdp!)^y)i;By\nzlWH_Ib#jE2b829IKBp\u0026xY(rM`0%B=goo#avpKMHoPN|fPl{-VGpUfK5Mi*{zi%c|D\nzhmsvOI|T_`wWBi!%\u0026`+asP9~W_Tr*\u003eh=@y{3~e=_fd)xTisluTEoY`$J_\u0026\u0026-FKMGv\nz8Wjx%!!or2IY*|P0)woAR-BA9(ya_(8s$l)+q9sZT`rETtS04*VS7fk;YJhj%R3VQ\nzuC8!E=HHbqj;swc$yy^VX}DUb;d4jmRitzrnhP|aDTq^I(1H}c5-VE\u003c(xYs`0_Aa*\nzk~\u003ekH(58~iSG2OxEl9jIl5D=(194$in\u003e\u00267eUk%_qS?u|ecwF\u003ciR3`\u003e+QmkmJP#P*C\nzH661C3C*U\u003e0UR9_88OZdEq#zl_2!wnR24v3Vn-8JZw{Ka#H2N61~FaL64KpLu^ca2\nzHnxx_!OdI?ux9?nbU)kmM1U;7t|G}jqBL-1xFL?(tr{)stjN`MoaW*MI^MT?c\u003e\u003eFK\nzh\u0026f26iZwAR\u0026xUcaUV}uf9upN$5y{yUbzrUpmGt\u0026t94!V=?lT0q=$`sRX!F6-N4Jli\nzJu1{aZ21{|qfuF;`{XoNRA\u003c;=C|H6j7Yt+)(??c`Zq\u003em)u3Ka;k;\u003eazQg8Qaqj\u003c6-\nz3`eFk#m0uVK+C0+Ftw-(U1nO%9A6gEadb@iXXu{26A3\u003e!`)OT1;Y;3Y1a9Z\u0026q3e9Q\nzl#pyAnWVa8LTYMl4xyQ`h9X\u0026Fj@9}3!k\u0026-dR26T`^=2=tOr~Vt\u003cf$CgFO_0wyvVhq\nzt@elzAf6-4D(2W?yUq8U-Cg(D0QiP`wHMlSe|9s}j|AF\u003eT;_Txdbe*H^`u6!vzUQr\nzbtKi3rmX^pn5`ZfvnUH8)9sl;s0K-O)Hp_?i5g3c*nE5dA)Jj%LYIYxWsp!OMbasC\nz`31z0EzHCG!P?s9=CwUVSO`|^CHX^MgM_Z#@{F6CmM~uaL%E`+\u003eQz!53S7~iiYiiM\nzVqHUr\u003e*_QfCs?+ZgUfYVqiW?ENzdS3Ng@jKCd_H3K}ZvlgC^X99JaIF9?z)JN~WGi\nzK~ZdT|B-{=5d4nq%acpfIJM~K@fH%NJ)MK71#$vgr?P@Ri%\u0026TV5eB)0cSUE2g^m%u\nzQX1G=PZEZ0X_\u0026H9K^D?PRO70KNXqG=kxNaJvSKps^P8bxoC)9#Is)WA1wuFOjs{K?\nzw#yb1bLO#VwKA}XBvKvq^OZ6\u003c7vfD5$9g5DlbI)^c%zQzt8p~jK=qnV_P`9Amf{s\u0026\nz\u003c!zZPrV^Dxsa)(b(dtZmrN;fP0C}SYN*\u003cD|EB5kNzj\u003c3hpuF6$8i@rS?Z\u003cLTfhiU9\nzO(oi=s{I)_OqCQGp\u003eox6p)Sml\u003eU0=o^\u0026FHJ$w`mksaR(=nq`PWgEdT\u0026m|(\u003eeKj3Y=\nzCcT=2FJF)5\u003cwsAqTA6;\u003ck*yL~\u00262`vG-WFmQ)\u003eiYZU\u003eJ4@%Q{14lr%?B98p=uky#\u003e^\nzRV*1TROYHx;kAZJD{w\u003ciFar+CS8*!em^YES\u003cM;\u003eb-W7p\u0026KD@sj^1fr\u003ccij8J5ASaS\nzOyuNhih7cI^vCem{r3mzi~Xeg\u003cK4(re^Os`|AYV+TmuD8M?KeTw\u003eCZf?SQKqdV1fJ\nzxn=2A?8un(9wePOu;t#`ja)yy|D5r+`Z)f}Vg02M7cB3;Pkt2OlwZc#41O=@@\u0026Wcu\nz\u0026\u003eM0%Iy}9\u00262bmlccE|m4H?reCLV\u00269QAb2F3Kyz=1{bEc$qJV\u0026`QwK56qldx?f`B{7\nz\u003ew_GbeqTKEa`+wsycJ}4?tsOBmHmg^iWTt1z92gKrs#*G?teJZn=9`iqA!Bihuj}$\nzZs?Q$5)Z%f+Wo\u003cZ+JWA*KX!N!VbArN`\u003ei-|`Jv}R96SH\u0026pz)%-U`%\u0026EK!Nk2H8*r8\nzvc5d~\u003e1p?qKZh@_4#kVQ@$mZ?@Bs(}6T|)2Z^Q4oBXK`X_xS+e*H(Sqze#TDcj0#r\nz\u00262PW47q2Kia9n\u003e~!wmA1Mc~p3\u003eb3|_=U(Y?-laU^wR!nXUCA|{gs\u0026a~o_)1*xS#(G\nUc\u0026V@t?}\u003eo-MIPQ0Pkemo-@\u003et4G5`Po\n\ndelta 158\nzc$~YmO\u003eW~q*##_{wb*@ZCW~\u003enZGPs)+c5pUH\u003e=R}Swf8Rn^n))FijV5XJy\u0026Uc|Ig_\nzx_Sev*ktWf^3\u0026BU8B?eKYGmb~o?y*bKYe*Kt4R9}TSg#e0%B$$X4$^OmNk%VJJ2i_\nzh!K-H\u0026+|=\u003eIKd(|-N1#Fd-?=VR*~\u0026m{;YKdAY*+%ra80\u00264FY1e?aQ0lSBnDxt1dW0\n\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-s3kz4jr1","title":"From d4c8de11a7baec89da839f8203847c28a56c9aa4 Mon Sep 17 00:00:00 2001","description":"From d4c8de11a7baec89da839f8203847c28a56c9aa4 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sat, 27 Dec 2025 15:05:56 +0500\nSubject: [PATCH 3/3] feat: enable parent commit navigation in commit detail page\n\nIntegrate parent commit navigation functionality into the commit detail page,\nallowing users to navigate through commit history by clicking on parent\ncommit hashes in the CommitHeader component.\n\nSubmodule Updates (nostr-git):\n- Update nostr-git submodule to latest commit\n- Includes CommitHeader component with parent commit navigation support\n- Parent commits now render as clickable links when getParentHref prop is provided\n\nCommit Detail Page Changes (commits/[commitid]/+page.svelte):\n- Import page store from $app/stores to access route parameters\n  - Enables dynamic URL generation for parent commit navigation\n  - Required for constructing commit detail page URLs\n\n- Add getParentHref navigation helper function\n  - Generates URLs for parent commit detail pages\n  - Uses current route parameters (relay and repository id)\n  - Properly encodes URL components for safe navigation\n  - Format: /spaces/{relay}/git/{id}/commits/{commitId}\n\n- Pass getParentHref prop to CommitHeader component\n  - Enables clickable parent commit links in commit header\n  - Maintains consistent navigation pattern across commit views\n  - Improves user experience for browsing commit history\n\nUser Experience Improvements:\n- Users can now click on parent commit hashes to navigate to parent commits\n- Seamless navigation through commit history without using browser back button\n- Consistent navigation pattern with commit list page (CommitCard component)\n- Visual feedback with hover effects on clickable parent commits\n\nThis change enhances the git browsing experience by providing intuitive\nnavigation through commit history, making it easier to explore repository\nchanges and understand commit relationships.\n---\n packages/nostr-git                                                       |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte |  9 ++++++++-\n 2 files changed, 9 insertions(+), 2 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex bc5b677..7c37eeb 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit bc5b677b0aacec5c7655def1aa6d447ce675ca28\n+Subproject commit 7c37eeb5ace4372c617a0833008519c5fb45a252\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\nindex b07053c..5f5c828 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\n@@ -12,6 +12,7 @@\n \u003c/style\u003e\n \n \u003cscript lang=\"ts\"\u003e\n+  import { page } from '$app/stores';\n   import {\n     ChevronDown,\n     ChevronRight,\n@@ -37,6 +38,11 @@\n   // Get repoClass from context\n   const repoClass = getContext\u003cRepo\u003e(REPO_KEY)\n \n+  // Create navigation helper for parent commits\n+  const getParentHref = (commitId: string) =\u003e {\n+    return `/spaces/${encodeURIComponent($page.params.relay)}/git/${encodeURIComponent($page.params.id)}/commits/${commitId}`;\n+  };\n+\n   if (!repoClass) {\n     throw new Error(\"Repo context not available\")\n   }\n@@ -168,7 +174,8 @@\n     email={commitMeta.email}\n     date={commitMeta.date}\n     message={commitMeta.message}\n-    parents={commitMeta.parents} /\u003e\n+    parents={commitMeta.parents}\n+    getParentHref={getParentHref} /\u003e\n \n   \u003c!-- Diff Summary --\u003e\n   \u003cdiv\u003e\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-s8d2t6t3","title":"Test new issue","description":"test","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T18:05:15.831483-08:00","closed_at":"2026-01-24T18:05:15.831483-08:00","close_reason":"Test/placeholder issue - closing as invalid","labels":["draft","issue","test"]}
{"id":"flotilla-sh50y8hk","title":"Comment count calculated incorrectly for patches","description":"We are counting 'e' tags of  the patch event, which will be 0 always.\nWhat we should do is counting how many nip22 (kind1111) events have this patch event (kind1617) as their root event.\nSEE patches.ts","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["bug","draft","issue"]}
{"id":"flotilla-smvqtl6p","title":"From 8d2646dd7bdcbd1745ef6f500915891a76a86b54 Mon Sep 17 00:00:00 2001","description":"From 8d2646dd7bdcbd1745ef6f500915891a76a86b54 Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/1] Expose repo address on repo page and sync submodule UI tweaks\n\n- surface the repo’s naddr on `src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte` with a copy-to-clipboard control so users can grab the address quickly\\n- update `packages/nostr-git` submodule to include the responsive new repository wizard (two-row step indicator on mobile) and tighter height limits for wizard panels to improve scrolling on small screens","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-sse69ner","title":"From a56b4021629c13cfb20720094170fb10fec9709f Mon Sep 17 00:00:00 2001","description":"From a56b4021629c13cfb20720094170fb10fec9709f Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Sat, 5 Jul 2025 14:11:31 -0700\nSubject: [PATCH 3/3] feat: replace workbench tab with feed tab and update icon to Layers\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte | 10 +++++-----\n 1 file changed, 5 insertions(+), 5 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 9b54ffe..f8ff9fe 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -1,7 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n   import { RepoHeader, RepoTab, toast} from \"@nostr-git/ui\"\n   import {ConfigProvider} from \"@nostr-git/ui\"\n-  import {FileCode, GitBranch, CircleAlert, GitPullRequest, PencilRuler, GitCommit} from \"@lucide/svelte\"\n+  import {FileCode, GitBranch, CircleAlert, GitPullRequest, PencilRuler, GitCommit, Layers} from \"@lucide/svelte\"\n   import {page} from \"$app/stores\"\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n   import Avatar from \"@lib/components/Avatar.svelte\"\n@@ -90,12 +90,12 @@\n           {/snippet}\n         \u003c/RepoTab\u003e\n         \u003cRepoTab\n-          tabValue=\"workbench\"\n-          label=\"Workbench\"\n-          href={`/spaces/${encodedRelay}/git/${id}/workbench`}\n+          tabValue=\"feed\"\n+          label=\"Feed\"\n+          href={`/spaces/${encodedRelay}/git/${id}/feed`}\n           {activeTab}\u003e\n           {#snippet icon()}\n-            \u003cPencilRuler class=\"h-4 w-4\" /\u003e\n+            \u003cLayers class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n       {/snippet}\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-tg7auf5x","title":"From 6f7f113b19f6897bd74c27ed6846da05571f83b5 Mon Sep 17 00:00:00 2001","description":"From 6f7f113b19f6897bd74c27ed6846da05571f83b5 Mon Sep 17 00:00:00 2001\nSubject: [PATCH 0/3] implementation of git repo file view and download\n\n*note* there are conflicts with the Buffer implementation that was added in a recent commit, it may be node version dependant","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["cover-letter","patch","root"]}
{"id":"flotilla-tlq78v2u","title":"From 1bfc579eb8ef46fcfc20aca3437bf54fd6b43abb Mon Sep 17 00:00:00 2001","description":"From 1bfc579eb8ef46fcfc20aca3437bf54fd6b43abb Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Wed, 30 Jul 2025 11:10:23 -0700\nSubject: [PATCH 3/4] feat: add commit details page with file diff viewer and GitHub identity verification\n\n---\n packages/nostr-git                                                       |   2 +-\n src/app/commands.ts                                                      |  10 ++++++++--\n src/app/components/GitAuth.svelte                                        |   2 --\n src/app/components/GitAuthAdd.svelte                                     |   1 +\n src/app/components/ProfileEdit.svelte                                    |  21 +++++++++++++++++++--\n src/app/components/ProfileEditForm.svelte                                | 216 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--\n src/app/components/SignUpProfile.svelte                                  |  12 ++++++++++--\n src/routes/spaces/[relay]/git/+page.svelte                               |  16 +++++++++++++---\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                  |  16 +++++++++++++++-\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte                    |   1 -\n src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte            |  13 ++++++++++++-\n src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte | 225 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts     | 120 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte             |   2 +-\n 14 files changed, 639 insertions(+), 18 deletions(-)\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 0336d88..d6f2fd1 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 0336d880f964d5179b4be9cbefb41989159fa1a3\n+Subproject commit d6f2fd17cddc608bc6d0e1e981b6e5a85f101ca9\ndiff --git a/src/app/commands.ts b/src/app/commands.ts\nindex ec0f247..e932183 100644\n--- a/src/app/commands.ts\n+++ b/src/app/commands.ts\n@@ -62,7 +62,7 @@ import {\n   NOTIFIER_RELAY,\n   userRoomsByUrl,\n } from \"@app/state\"\n-import type {CommentEvent, IssueEvent, StatusEvent} from \"@nostr-git/shared-types\"\n+import type {CommentEvent, IssueEvent, RepoAnnouncementEvent, StatusEvent} from \"@nostr-git/shared-types\"\n \n // Utils\n \n@@ -462,9 +462,15 @@ export const postIssue = (issue: IssueEvent, relays: string[]) =\u003e {\n }\n \n export const postStatus = (status: StatusEvent, relays: string[]) =\u003e {\n-  console.log(status)\n   return publishThunk({\n     relays: relays ?? [],\n     event: status,\n   })\n }\n+\n+export const postRepoAnnouncement = (repo: RepoAnnouncementEvent, relays: string[]) =\u003e {\n+  return publishThunk({\n+    relays: relays ?? [],\n+    event: repo,\n+  })\n+}\n\\ No newline at end of file\ndiff --git a/src/app/components/GitAuth.svelte b/src/app/components/GitAuth.svelte\nindex a8dd257..8f2e07b 100644\n--- a/src/app/components/GitAuth.svelte\n+++ b/src/app/components/GitAuth.svelte\n@@ -4,8 +4,6 @@\n   import Button from \"@lib/components/Button.svelte\"\n   import {pushModal} from \"@app/modal\"\n   import GitAuthAdd from \"@app/components/GitAuthAdd.svelte\"\n-  import {pubkey} from \"@welshman/app\"\n-  import {signer} from \"@welshman/app\"\n   import {tokens as tokensStore} from \"@nostr-git/ui\"\n \n   type Props = {\ndiff --git a/src/app/components/GitAuthAdd.svelte b/src/app/components/GitAuthAdd.svelte\nindex eb57d7a..4f277ce 100644\n--- a/src/app/components/GitAuthAdd.svelte\n+++ b/src/app/components/GitAuthAdd.svelte\n@@ -23,6 +23,7 @@\n \n   const back = () =\u003e history.back()\n   //ghp_REDACTED_TOKEN\n+  //ghp_REDACTED_TOKEN\n   const disabled = $state(true)\n \n   let host = $state(editToken?.host || \"\")\ndiff --git a/src/app/components/ProfileEdit.svelte b/src/app/components/ProfileEdit.svelte\nindex b3a2af3..4f7264a 100644\n--- a/src/app/components/ProfileEdit.svelte\n+++ b/src/app/components/ProfileEdit.svelte\n@@ -24,10 +24,27 @@\n \n   const back = () =\u003e history.back()\n \n-  const onsubmit = ({profile, shouldBroadcast}: {profile: Profile; shouldBroadcast: boolean}) =\u003e {\n+  const onsubmit = ({profile, shouldBroadcast, githubIdentity}: {profile: Profile; shouldBroadcast: boolean; githubIdentity?: {username: string; proof: string}}) =\u003e {\n     const router = Router.get()\n     const template = isPublishedProfile(profile) ? editProfile(profile) : createProfile(profile)\n     const scenarios = [router.FromRelays(getMembershipUrls($userMembership))]\n+    \n+    // Handle NIP-39 GitHub identity\n+    if (githubIdentity?.username \u0026\u0026 githubIdentity?.proof) {\n+      // Remove existing GitHub identity tags\n+      template.tags = template.tags.filter(tag =\u003e \n+        !(tag[0] === 'i' \u0026\u0026 tag[1]?.startsWith('github:'))\n+      )\n+      \n+      // Add new GitHub identity tag\n+      const githubTag = ['i', `github:${githubIdentity.username}`, githubIdentity.proof]\n+      template.tags.push(githubTag)\n+    } else {\n+      // Remove GitHub identity tags if no identity provided\n+      template.tags = template.tags.filter(tag =\u003e \n+        !(tag[0] === 'i' \u0026\u0026 tag[1]?.startsWith('github:'))\n+      )\n+    }\n \n     if (shouldBroadcast) {\n       scenarios.push(router.FromUser(), router.Index())\n@@ -45,7 +62,7 @@\n   }\n \u003c/script\u003e\n \n-\u003cProfileEditForm {initialValues} {onsubmit}\u003e\n+\u003cProfileEditForm {initialValues} {onsubmit} pubkey={$pubkey!}\u003e\n   {#snippet footer()}\n     \u003cdiv class=\"mt-4 flex flex-row items-center justify-between gap-4\"\u003e\n       \u003cButton class=\"btn btn-neutral\" onclick={back}\u003eDiscard Changes\u003c/Button\u003e\ndiff --git a/src/app/components/ProfileEditForm.svelte b/src/app/components/ProfileEditForm.svelte\nindex 13288e2..3f727f6 100644\n--- a/src/app/components/ProfileEditForm.svelte\n+++ b/src/app/components/ProfileEditForm.svelte\n@@ -2,6 +2,8 @@\n   import type {Snippet} from \"svelte\"\n   import type {Profile} from \"@welshman/util\"\n   import {preventDefault} from \"@lib/html\"\n+  import {nip19} from \"nostr-tools\"\n+  import {tokens as tokensStore} from \"@nostr-git/ui\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Field from \"@lib/components/Field.svelte\"\n   import FieldInline from \"@lib/components/FieldInline.svelte\"\n@@ -13,6 +15,10 @@\n   type Values = {\n     profile: Profile\n     shouldBroadcast: boolean\n+    githubIdentity?: {\n+      username: string\n+      proof: string // GitHub Gist ID\n+    }\n   }\n \n   type Props = {\n@@ -20,15 +26,120 @@\n     onsubmit: (values: Values) =\u003e void\n     hideAddress?: boolean\n     footer: Snippet\n+    pubkey: string\n   }\n \n-  const {initialValues, hideAddress, onsubmit, footer}: Props = $props()\n+  const {initialValues, hideAddress, onsubmit, footer, pubkey}: Props = $props()\n \n-  const values = $state(initialValues)\n+  const values = $state({\n+    ...initialValues,\n+    githubIdentity: (() =\u003e {\n+      // Extract GitHub identity from existing profile tags if present\n+      const existingGithubTag = initialValues.profile.event?.tags?.find(tag =\u003e \n+        tag[0] === 'i' \u0026\u0026 tag[1]?.startsWith('github:')\n+      )\n+      \n+      if (existingGithubTag) {\n+        const [, platformIdentity, proof] = existingGithubTag\n+        const username = platformIdentity.split(':')[1]\n+        if (username \u0026\u0026 proof) {\n+          return { username, proof }\n+        }\n+      }\n+      \n+      return { username: '', proof: '' }\n+    })()\n+  })\n \n   const submit = () =\u003e onsubmit($state.snapshot(values))\n \n   let file: File | undefined = $state()\n+  let isCreatingAttestation = $state(false)\n+  let attestationError = $state('')\n+  \n+  const npub = nip19.npubEncode(pubkey)\n+  \n+  // Check if user has GitHub token and no existing GitHub identity\n+  const githubToken = $derived(() =\u003e {\n+    const tokens = $tokensStore\n+    return tokens.find(t =\u003e t.host === 'github.com' || t.host === 'api.github.com')\n+  })\n+  \n+  const shouldOfferAutoAttestation = $derived(() =\u003e {\n+    return githubToken() \u0026\u0026 \n+           (!values.githubIdentity?.username || !values.githubIdentity?.proof) \u0026\u0026\n+           !isCreatingAttestation\n+  })\n+  \n+  // Auto-create GitHub attestation\n+  async function createGitHubAttestation() {\n+    const token = githubToken()\n+    if (!token) {\n+      attestationError = 'No GitHub token found'\n+      return\n+    }\n+    \n+    isCreatingAttestation = true\n+    attestationError = ''\n+    \n+    try {\n+      // Get GitHub user info\n+      const userResponse = await fetch('https://api.github.com/user', {\n+        headers: {\n+          'Authorization': `token ${token.token}`,\n+          'Accept': 'application/vnd.github.v3+json'\n+        }\n+      })\n+      \n+      if (!userResponse.ok) {\n+        throw new Error(`GitHub API error: ${userResponse.status}`)\n+      }\n+      \n+      const userData = await userResponse.json()\n+      const username = userData.login\n+      \n+      // Create attestation text\n+      const attestationText = `Verifying that I control the following Nostr public key: ${npub}`\n+      \n+      // Create GitHub Gist\n+      const gistResponse = await fetch('https://api.github.com/gists', {\n+        method: 'POST',\n+        headers: {\n+          'Authorization': `token ${token.token}`,\n+          'Accept': 'application/vnd.github.v3+json',\n+          'Content-Type': 'application/json'\n+        },\n+        body: JSON.stringify({\n+          description: 'Nostr Identity Verification (NIP-39)',\n+          public: true,\n+          files: {\n+            'nostr-verification.txt': {\n+              content: attestationText\n+            }\n+          }\n+        })\n+      })\n+      \n+      if (!gistResponse.ok) {\n+        throw new Error(`Failed to create Gist: ${gistResponse.status}`)\n+      }\n+      \n+      const gistData = await gistResponse.json()\n+      const gistId = gistData.id\n+      \n+      // Update form values\n+      values.githubIdentity = {\n+        username,\n+        proof: gistId\n+      }\n+      \n+    } catch (error) {\n+      console.error('Failed to create GitHub attestation:', error)\n+      attestationError = error instanceof Error ? error.message : 'Failed to create attestation'\n+    } finally {\n+      isCreatingAttestation = false\n+    }\n+  }\n \u003c/script\u003e\n \n \u003cform class=\"col-4\" onsubmit={preventDefault(submit)}\u003e\n@@ -63,6 +174,107 @@\n       Give a brief introduction to why you're here.\n     {/snippet}\n   \u003c/Field\u003e\n+  \n+  \u003c!-- Auto-Attestation Offer --\u003e\n+  {#if shouldOfferAutoAttestation()}\n+    \u003cdiv class=\"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4\"\u003e\n+      \u003cdiv class=\"flex items-start gap-3\"\u003e\n+        \u003cIcon icon=\"info-circle\" class=\"text-blue-600 mt-0.5\" /\u003e\n+        \u003cdiv class=\"flex-1\"\u003e\n+          \u003ch4 class=\"font-medium text-blue-900 mb-2\"\u003eAutomatic GitHub Verification Available\u003c/h4\u003e\n+          \u003cp class=\"text-sm text-blue-700 mb-3\"\u003e\n+            We detected you have a GitHub token configured. We can automatically create a verification Gist \n+            and set up your GitHub identity for you.\n+          \u003c/p\u003e\n+          \u003cButton \n+            class=\"btn btn-sm btn-primary\" \n+            onclick={createGitHubAttestation}\n+            disabled={isCreatingAttestation}\n+          \u003e\n+            {#if isCreatingAttestation}\n+              \u003cIcon icon=\"clock-circle\" class=\"animate-spin\" /\u003e\n+              Creating Attestation...\n+            {:else}\n+              \u003cIcon icon=\"git\" /\u003e\n+              Auto-Verify GitHub Identity\n+            {/if}\n+          \u003c/Button\u003e\n+          {#if attestationError}\n+            \u003cp class=\"text-sm text-red-600 mt-2\"\u003e{attestationError}\u003c/p\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  {/if}\n+  \n+  \u003c!-- GitHub Identity Section (NIP-39) --\u003e\n+  \u003cField\u003e\n+    {#snippet label()}\n+      \u003cp\u003eGitHub Identity \u003cspan class=\"text-xs text-gray-500\"\u003e(NIP-39)\u003c/span\u003e\u003c/p\u003e\n+    {/snippet}\n+    {#snippet input()}\n+      \u003clabel class=\"input input-bordered flex w-full items-center gap-2\"\u003e\n+        \u003cIcon icon=\"git\" /\u003e\n+        \u003cinput \n+          bind:value={values.githubIdentity.username} \n+          class=\"grow\" \n+          type=\"text\" \n+          placeholder=\"your-github-username\"\n+        /\u003e\n+      \u003c/label\u003e\n+    {/snippet}\n+    {#snippet info()}\n+      Your GitHub username for identity verification.\n+    {/snippet}\n+  \u003c/Field\u003e\n+  \n+  {#if values.githubIdentity?.username}\n+    \u003cField\u003e\n+      {#snippet label()}\n+        \u003cp\u003eGitHub Proof \u003cspan class=\"text-xs text-gray-500\"\u003e(Gist ID)\u003c/span\u003e\u003c/p\u003e\n+      {/snippet}\n+      {#snippet input()}\n+        \u003clabel class=\"input input-bordered flex w-full items-center gap-2\"\u003e\n+          \u003cIcon icon=\"link-round\" /\u003e\n+          \u003cinput \n+            bind:value={values.githubIdentity.proof} \n+            class=\"grow\" \n+            type=\"text\" \n+            placeholder=\"abc123def456\"\n+          /\u003e\n+        \u003c/label\u003e\n+      {/snippet}\n+      {#snippet info()}\n+        {#if !shouldOfferAutoAttestation() \u0026\u0026 !values.githubIdentity?.proof}\n+          \u003cp class=\"text-sm\"\u003e\n+            Create a GitHub Gist with the text: \u003cbr/\u003e\n+            \u003ccode class=\"bg-gray-100 px-1 rounded text-xs break-all\"\u003e\n+              Verifying that I control the following Nostr public key: {npub}\n+            \u003c/code\u003e\u003cbr/\u003e\n+            Then paste the Gist ID here.\n+          \u003c/p\u003e\n+        {:else if values.githubIdentity?.proof}\n+          \u003cp class=\"text-sm\"\u003e\n+            Your verification Gist is available at:\u003cbr/\u003e\n+            \u003ca \n+              href=\"https://gist.github.com/{values.githubIdentity?.username}/{values.githubIdentity?.proof}\" \n+              target=\"_blank\" \n+              rel=\"noopener noreferrer\"\n+              class=\"inline-flex items-center gap-1 text-blue-600 hover:text-blue-800 underline text-xs mt-1\"\n+            \u003e\n+              \u003cIcon icon=\"link-round\" size={3} /\u003e\n+              https://gist.github.com/{values.githubIdentity?.username}/{values.githubIdentity?.proof}\n+            \u003c/a\u003e\n+          \u003c/p\u003e\n+        {:else}\n+          \u003cp class=\"text-sm text-gray-500\"\u003e\n+            Gist ID will be automatically filled when you use the auto-verification above.\n+          \u003c/p\u003e\n+        {/if}\n+      {/snippet}\n+    \u003c/Field\u003e\n+  {/if}\n+  \n   {#if !hideAddress}\n     \u003cField\u003e\n       {#snippet label()}\ndiff --git a/src/app/components/SignUpProfile.svelte b/src/app/components/SignUpProfile.svelte\nindex 5c3bbe2..238d5db 100644\n--- a/src/app/components/SignUpProfile.svelte\n+++ b/src/app/components/SignUpProfile.svelte\n@@ -17,8 +17,16 @@\n     shouldBroadcast: true,\n   }\n \n-  const onsubmit = ({profile, shouldBroadcast}: {profile: Profile; shouldBroadcast: boolean}) =\u003e {\n-    const event = makeEvent(PROFILE, createProfile(profile))\n+  const onsubmit = ({profile, shouldBroadcast, githubIdentity}: {profile: Profile; shouldBroadcast: boolean; githubIdentity?: {username: string; proof: string}}) =\u003e {\n+    const template = createProfile(profile)\n+    \n+    // Handle NIP-39 GitHub identity\n+    if (githubIdentity?.username \u0026\u0026 githubIdentity?.proof) {\n+      const githubTag = ['i', `github:${githubIdentity.username}`, githubIdentity.proof]\n+      template.tags.push(githubTag)\n+    }\n+    \n+    const event = makeEvent(PROFILE, template)\n     const relays = shouldBroadcast ? INDEXER_RELAYS : []\n \n     loginWithNip01(secret)\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 5a0bf46..8a526ed 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -2,7 +2,7 @@\n   import {page} from \"$app/stores\"\n   import {Address, NAMED_BOOKMARKS, type TrustedEvent} from \"@welshman/util\"\n   import {GIT_REPO, GIT_REPO_BOOKMARK_DTAG} from \"@src/lib/util\"\n-  import {repository, userMutes} from \"@welshman/app\"\n+  import {publishThunk, repository, userMutes} from \"@welshman/app\"\n   import {fly} from \"@lib/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n@@ -20,7 +20,8 @@\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {derived as _derived} from \"svelte/store\"\n-    import { NewRepoWizard } from \"@nostr-git/ui\"\n+  import { NewRepoWizard } from \"@nostr-git/ui\"\n+    import type { RepoAnnouncementEvent } from \"@nostr-git/shared-types\"\n \n   const url = decodeRelay($page.params.relay)\n \n@@ -101,9 +102,18 @@\n \n   const onNewRepo = () =\u003e {\n     pushModal(NewRepoWizard, {\n-      onClose: () =\u003e {\n+      onCancel: () =\u003e {\n+        back()\n+      },\n+      onRepoCreated: () =\u003e {\n         back()\n       },\n+      onPublishEvent: async (event: RepoAnnouncementEvent) =\u003e {\n+        publishThunk({\n+          relays: [url],\n+          event,\n+        })\n+      },\n     })\n   }\n \u003c/script\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 842bddf..462d5a1 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -71,6 +71,13 @@\n     }\n   }\n \n+  function forkRepo() {\n+    if (!repoClass) return\n+    \n+    // Fork the repository\n+    repoClass.workerManager.forkAndCloneRepo()\n+  }\n+\n   // Connect the nostr-git toast store to the toast component\n   $effect(() =\u003e {\n     if ($toast.length \u003e 0) {\n@@ -94,7 +101,14 @@\n   {:else if !repoClass}\n     \u003cdiv class=\"p-4 text-center text-red-500\"\u003eRepository not found.\u003c/div\u003e\n   {:else}\n-    \u003cRepoHeader event={repoClass.repoEvent} {activeTab} isRepoWatched={false} {refreshRepo} {isRefreshing}\u003e\n+    \u003cRepoHeader\n+      event={repoClass.repoEvent}\n+      {activeTab}\n+      isRepoWatched={false}\n+      {refreshRepo}\n+      {isRefreshing}\n+      {forkRepo}\n+    \u003e\n       {#snippet children(activeTab: string)}\n         \u003cRepoTab\n           tabValue=\"feed\"\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 2ee4c84..ac2e937 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -15,7 +15,6 @@\n   } from \"@lucide/svelte\"\n   import {fade, fly, slide} from \"@lib/transition\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n-  import {pushToast} from \"@src/app/toast\"\n   import {formatDistanceToNow} from \"date-fns\"\n   import {nthEq} from \"@welshman/lib\"\n   import Button from \"@src/lib/components/Button.svelte\"\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\nindex 53595bc..64ee427 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n@@ -1,4 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n+  import { page } from '$app/stores';\n   import {GitBranch, User, Search} from \"@lucide/svelte\"\n   import {\n     Input,\n@@ -45,6 +46,11 @@\n   // Track if we're currently loading more commits\n   let isLoadingMore = $state(true)\n \n+  // Create navigation helper\n+  const getCommitUrl = (commitId: string) =\u003e {\n+    return `/spaces/${encodeURIComponent($page.params.relay)}/git/${encodeURIComponent($page.params.id)}/commits/${commitId}`;\n+  };\n+\n   // Set initial page size and load commits when the component mounts or when the repo changes\n   $effect(() =\u003e {\n     if (repoClass \u0026\u0026 repoClass.repoId \u0026\u0026 repoClass.mainBranch) {\n@@ -254,7 +260,12 @@\n         {#if commits}\n           \u003cdiv class=\"space-y-4\" transition:slide\u003e\n             {#each filteredCommits as commit (commit.oid)}\n-              \u003cCommitCard {commit} onReact={handleReact} onComment={handleComment} /\u003e\n+              \u003cCommitCard \n+                {commit} \n+                onReact={handleReact} \n+                onComment={handleComment}\n+                href={getCommitUrl(commit.oid)}\n+              /\u003e\n             {/each}\n           \u003c/div\u003e\n           \u003cdiv class=\"mt-6 flex flex-col items-center gap-4 sm:flex-row sm:justify-between\"\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\nnew file mode 100644\nindex 0000000..0c8f3fb\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\n@@ -0,0 +1,225 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import { page } from '$app/stores';\n+  import { ChevronDown, ChevronRight, FileText, FilePlus, FileMinus, FileX } from '@lucide/svelte';\n+  import { CommitHeader, SplitDiff } from '@nostr-git/ui';\n+  import type { PageData } from './$types';\n+\n+  let { data }: { data: PageData } = $props();\n+  \n+  // Extract data from page load\n+  const { commitMeta, changes, repoClass } = data;\n+\n+  // State for collapsible file panels\n+  let expandedFiles = $state\u003cSet\u003cstring\u003e\u003e(new Set());\n+\n+  // Toggle file expansion\n+  const toggleFile = (filepath: string) =\u003e {\n+    if (expandedFiles.has(filepath)) {\n+      expandedFiles.delete(filepath);\n+    } else {\n+      expandedFiles.add(filepath);\n+    }\n+    expandedFiles = new Set(expandedFiles); // Trigger reactivity\n+  };\n+\n+  // Get file status icon and styling\n+  const getFileStatusIcon = (status: string) =\u003e {\n+    switch (status) {\n+      case 'added':\n+        return { icon: FilePlus, class: 'text-green-600' };\n+      case 'deleted':\n+        return { icon: FileMinus, class: 'text-red-600' };\n+      case 'modified':\n+        return { icon: FileText, class: 'text-blue-600' };\n+      case 'renamed':\n+        return { icon: FileX, class: 'text-yellow-600' };\n+      default:\n+        return { icon: FileText, class: 'text-muted-foreground' };\n+    }\n+  };\n+\n+  // Get file status badge styling\n+  const getStatusBadgeClass = (status: string) =\u003e {\n+    switch (status) {\n+      case 'added':\n+        return 'bg-green-100 text-green-800 border-green-200';\n+      case 'deleted':\n+        return 'bg-red-100 text-red-800 border-red-200';\n+      case 'modified':\n+        return 'bg-blue-100 text-blue-800 border-blue-200';\n+      case 'renamed':\n+        return 'bg-yellow-100 text-yellow-800 border-yellow-200';\n+      default:\n+        return 'bg-gray-100 text-gray-800 border-gray-200';\n+    }\n+  };\n+\n+  // Calculate diff stats for each file\n+  const getFileStats = (hunks: any[]) =\u003e {\n+    let additions = 0;\n+    let deletions = 0;\n+    \n+    for (const hunk of hunks) {\n+      for (const patch of hunk.patches) {\n+        if (patch.type === '+') additions++;\n+        else if (patch.type === '-') deletions++;\n+      }\n+    }\n+    \n+    return { additions, deletions };\n+  };\n+\n+  // Calculate total diff stats\n+  const totalStats = $derived(() =\u003e {\n+    let totalAdditions = 0;\n+    let totalDeletions = 0;\n+    \n+    for (const change of changes) {\n+      const stats = getFileStats(change.diffHunks);\n+      totalAdditions += stats.additions;\n+      totalDeletions += stats.deletions;\n+    }\n+    \n+    return { totalAdditions, totalDeletions };\n+  });\n+\n+  // Expand all files by default if there are few changes\n+  $effect(() =\u003e {\n+    if (changes.length \u003c= 5) {\n+      expandedFiles = new Set(changes.map(change =\u003e change.path));\n+    }\n+  });\n+\u003c/script\u003e\n+\n+\u003csvelte:head\u003e\n+  \u003ctitle\u003eCommit {commitMeta.sha.slice(0, 7)} · {repoClass.repoEvent?.content ? JSON.parse(repoClass.repoEvent.content).name : 'Repository'}\u003c/title\u003e\n+\u003c/svelte:head\u003e\n+\n+\u003cdiv class=\"min-h-screen bg-background\"\u003e\n+  \u003c!-- Commit Header --\u003e\n+  \u003cCommitHeader\n+    sha={commitMeta.sha}\n+    author={commitMeta.author}\n+    email={commitMeta.email}\n+    date={commitMeta.date}\n+    message={commitMeta.message}\n+    parents={commitMeta.parents}\n+  /\u003e\n+\n+  \u003c!-- Diff Summary --\u003e\n+  \u003cdiv class=\"border-b border-border bg-card px-6 py-4\"\u003e\n+    \u003cdiv class=\"flex items-center justify-between\"\u003e\n+      \u003cdiv class=\"flex items-center gap-4\"\u003e\n+        \u003ch2 class=\"text-lg font-semibold text-foreground\"\u003e\n+          {changes.length} {changes.length === 1 ? 'file' : 'files'} changed\n+        \u003c/h2\u003e\n+        \u003cdiv class=\"flex items-center gap-2 text-sm text-muted-foreground\"\u003e\n+          {#if totalStats().totalAdditions \u003e 0}\n+            \u003cspan class=\"text-green-600\"\u003e+{totalStats().totalAdditions}\u003c/span\u003e\n+          {/if}\n+          {#if totalStats().totalDeletions \u003e 0}\n+            \u003cspan class=\"text-red-600\"\u003e-{totalStats().totalDeletions}\u003c/span\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+      \n+      \u003c!-- Expand/Collapse All --\u003e\n+      \u003cdiv class=\"flex items-center gap-2\"\u003e\n+        \u003cbutton\n+          onclick={() =\u003e {\n+            expandedFiles = new Set(changes.map(change =\u003e change.path));\n+          }}\n+          class=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n+        \u003e\n+          Expand all\n+        \u003c/button\u003e\n+        \u003cspan class=\"text-muted-foreground\"\u003e|\u003c/span\u003e\n+        \u003cbutton\n+          onclick={() =\u003e {\n+            expandedFiles = new Set();\n+          }}\n+          class=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n+        \u003e\n+          Collapse all\n+        \u003c/button\u003e\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  \u003c/div\u003e\n+\n+  \u003c!-- File Changes --\u003e\n+  \u003cdiv class=\"divide-y divide-border\"\u003e\n+    {#each changes as change (change.path)}\n+      {@const isExpanded = expandedFiles.has(change.path)}\n+      {@const statusInfo = getFileStatusIcon(change.status)}\n+      {@const stats = getFileStats(change.diffHunks)}\n+      \n+      \u003cdiv class=\"bg-background\"\u003e\n+        \u003c!-- File Header --\u003e\n+        \u003cbutton\n+          onclick={() =\u003e toggleFile(change.path)}\n+          class=\"w-full px-6 py-4 text-left hover:bg-muted/50 transition-colors focus:outline-none focus:bg-muted/50\"\n+        \u003e\n+          \u003cdiv class=\"flex items-center justify-between\"\u003e\n+            \u003cdiv class=\"flex items-center gap-3\"\u003e\n+              \u003c!-- Expand/Collapse Icon --\u003e\n+              {#if isExpanded}\n+                \u003cChevronDown class=\"h-4 w-4 text-muted-foreground\" /\u003e\n+              {:else}\n+                \u003cChevronRight class=\"h-4 w-4 text-muted-foreground\" /\u003e\n+              {/if}\n+              \n+              \u003c!-- File Status Icon --\u003e\n+              {#if statusInfo.icon}\n+                {@const IconComponent = statusInfo.icon}\n+                \u003cIconComponent class=\"h-4 w-4 {statusInfo.class}\" /\u003e\n+              {/if}\n+              \n+              \u003c!-- File Path --\u003e\n+              \u003cspan class=\"font-mono text-sm text-foreground\"\u003e{change.path}\u003c/span\u003e\n+              \n+              \u003c!-- Status Badge --\u003e\n+              \u003cspan class=\"rounded-full border px-2 py-0.5 text-xs font-medium {getStatusBadgeClass(change.status)}\"\u003e\n+                {change.status}\n+              \u003c/span\u003e\n+            \u003c/div\u003e\n+            \n+            \u003c!-- File Stats --\u003e\n+            \u003cdiv class=\"flex items-center gap-2 text-sm text-muted-foreground\"\u003e\n+              {#if stats.additions \u003e 0}\n+                \u003cspan class=\"text-green-600\"\u003e+{stats.additions}\u003c/span\u003e\n+              {/if}\n+              {#if stats.deletions \u003e 0}\n+                \u003cspan class=\"text-red-600\"\u003e-{stats.deletions}\u003c/span\u003e\n+              {/if}\n+            \u003c/div\u003e\n+          \u003c/div\u003e\n+        \u003c/button\u003e\n+\n+        \u003c!-- File Diff Content --\u003e\n+        {#if isExpanded}\n+          \u003cdiv class=\"px-6 pb-6\"\u003e\n+            \u003cSplitDiff hunks={change.diffHunks} filepath={change.path} /\u003e\n+          \u003c/div\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    {/each}\n+  \u003c/div\u003e\n+\n+  \u003c!-- Empty State --\u003e\n+  {#if changes.length === 0}\n+    \u003cdiv class=\"px-6 py-12 text-center\"\u003e\n+      \u003cFileText class=\"mx-auto h-12 w-12 text-muted-foreground\" /\u003e\n+      \u003ch3 class=\"mt-4 text-lg font-medium text-foreground\"\u003eNo file changes\u003c/h3\u003e\n+      \u003cp class=\"mt-2 text-sm text-muted-foreground\"\u003e\n+        This commit doesn't contain any file changes.\n+      \u003c/p\u003e\n+    \u003c/div\u003e\n+  {/if}\n+\u003c/div\u003e\n+\n+\u003cstyle\u003e\n+  /* Ensure proper font rendering for code */\n+  .font-mono {\n+    font-family: ui-monospace, SFMono-Regular, \"SF Mono\", Consolas, \"Liberation Mono\", Menlo, monospace;\n+  }\n+\u003c/style\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\nnew file mode 100644\nindex 0000000..3940ef5\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\n@@ -0,0 +1,120 @@\n+import type { PageLoad } from './$types';\n+import { getGitWorker } from '@nostr-git/core';\n+import { pushToast } from '@src/app/toast';\n+\n+export interface CommitChange {\n+  path: string;\n+  status: 'added' | 'modified' | 'deleted' | 'renamed';\n+  diffHunks: Array\u003c{\n+    oldStart: number;\n+    oldLines: number;\n+    newStart: number;\n+    newLines: number;\n+    patches: Array\u003c{ line: string; type: '+' | '-' | ' ' }\u003e;\n+  }\u003e;\n+}\n+\n+export interface CommitMeta {\n+  sha: string;\n+  author: string;\n+  email: string;\n+  date: number;\n+  message: string;\n+  parents: string[];\n+}\n+\n+export const load: PageLoad = async ({ params, parent }) =\u003e {\n+  const { commitid } = params;\n+  \n+  try {\n+    // Get parent data which includes repoClass\n+    const parentData = await parent();\n+    const { repoClass } = parentData;\n+    \n+    if (!repoClass || !repoClass.repoId) {\n+      pushToast({\n+        message: 'Repository not found',\n+        theme: 'error',\n+        timeout: 5000\n+      });\n+      return;\n+    }\n+\n+    // Get git worker instance\n+    const gitWorker = getGitWorker();\n+    \n+    // Ensure repository is properly initialized and cloned\n+    console.log('Initializing repository:', repoClass.repoId, 'with branch:', repoClass.mainBranch);\n+    \n+    try {\n+      // First ensure the repository is initialized\n+      await gitWorker.api.smartInitializeRepo({\n+        repoId: repoClass.repoEvent.id,\n+        branch: repoClass.mainBranch\n+      });\n+      \n+      // Then ensure we have full clone with sufficient depth\n+      await gitWorker.api.ensureFullClone({\n+        repoId: repoClass.repoEvent.id,\n+        branch: repoClass.mainBranch,\n+        depth: 100\n+      });\n+    } catch (initError) {\n+      console.error('Repository initialization failed:', initError);\n+      const errorMessage = initError instanceof Error ? initError.message : String(initError);\n+      pushToast({\n+        message: `Failed to initialize repository: ${errorMessage}`,\n+        theme: 'error',\n+        timeout: 5000\n+      });\n+      return;\n+    }\n+    \n+    // Get detailed commit information including file changes\n+    const commitDetails = await gitWorker.api.getCommitDetails({\n+      repoId: repoClass.repoEvent.id,\n+      commitId: commitid\n+    });\n+\n+    if (!commitDetails.success) {\n+      pushToast({\n+        message: commitDetails.error || 'Commit not found',\n+        theme: 'error',\n+        timeout: 5000\n+      });\n+      return;\n+    }\n+\n+    // Create commit metadata from detailed commit data\n+    const commitMeta: CommitMeta = {\n+      sha: commitDetails.meta.sha,\n+      author: commitDetails.meta.author,\n+      email: commitDetails.meta.email,\n+      date: commitDetails.meta.date,\n+      message: commitDetails.meta.message,\n+      parents: commitDetails.meta.parents\n+    };\n+\n+    // Convert git-worker changes to our CommitChange format\n+    const changes: CommitChange[] = commitDetails.changes.map((change: any) =\u003e ({\n+      path: change.path,\n+      status: change.status,\n+      diffHunks: change.diffHunks\n+    }));\n+\n+    return {\n+      commitMeta,\n+      changes,\n+      repoClass,\n+      commitid\n+    };\n+  } catch (err) {\n+    console.error('Error loading commit details:', err);\n+    pushToast({\n+      message: 'Failed to load commit details',\n+      theme: 'error',\n+      timeout: 5000\n+    });\n+    return;\n+  }\n+};\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex b1b82b8..ec8b922 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -24,7 +24,7 @@\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {makeFeed} from \"@src/app/requests\"\n   import {whenElementReady} from \"@src/lib/html\"\n-  import {fly, slide, slideAndFade} from \"@lib/transition\"\n+  import {slide, slideAndFade} from \"@lib/transition\"\n   import {pushModal} from \"@src/app/modal\"\n   import {\n     createStatusEvent,\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-tqsq33f6","title":"test a new issue","description":"Test","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["issue","test"]}
{"id":"flotilla-tz5fuhqx","title":"From 0a9cb75f9012b689f454805ad0a305cca0108fd1 Mon Sep 17 00:00:00 2001","description":"From 0a9cb75f9012b689f454805ad0a305cca0108fd1 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 29 May 2025 12:41:59 -0700\nSubject: [PATCH 1/4] feat: enhance UI with loading states, transitions and markdown styling\n\n---\n packages/nostr-git                                            |   2 +-\n src/routes/spaces/[relay]/+layout.svelte                      |   6 +++---\n src/routes/spaces/[relay]/git/+page.svelte                    |  18 ++++++------------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte       |  59 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte         | 164 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte    |   1 +\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte  |  18 ++++++++----------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte |  44 ++++++++++++++++++++++++++++++++++++++------\n 8 files changed, 236 insertions(+), 76 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 1148da4..565f147 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 1148da40e044d428c086d2085058225ef55d0986\n+Subproject commit 565f147cd1ff1efda2516b1b9c9e421870106f7d\ndiff --git a/src/routes/spaces/[relay]/+layout.svelte b/src/routes/spaces/[relay]/+layout.svelte\nindex b5df4f5..b72f734 100644\n--- a/src/routes/spaces/[relay]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/+layout.svelte\n@@ -17,10 +17,10 @@\n   import {decodeRelay, userRoomsByUrl} from \"@app/state\"\n   import {pullConservatively} from \"@app/requests\"\n   import {notifications} from \"@app/notifications\"\n-  import { FREELANCE_JOB, GIT_REPO } from \"@src/lib/util\"\n+  import {FREELANCE_JOB, GIT_REPO} from \"@src/lib/util\"\n \n-  type Props = {\n-    children?: Snippet\n+  interface Props {\n+    children?: import(\"svelte\").Snippet\n   }\n   const {children}: Props = $props()\n \ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 87479bf..29356f2 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -1,13 +1,6 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {onMount} from \"svelte\"\n   import {page} from \"$app/stores\"\n-  import {\n-    getPubkeyTagValues,\n-    getListTags,\n-    Address,\n-    NAMED_BOOKMARKS,\n-    type TrustedEvent,\n-  } from \"@welshman/util\"\n+  import {Address, NAMED_BOOKMARKS, type TrustedEvent} from \"@welshman/util\"\n   import {GIT_REPO} from \"@src/lib/util\"\n   import {repository, userMutes} from \"@welshman/app\"\n   import {fly} from \"@lib/transition\"\n@@ -63,7 +56,7 @@\n       })\n       const repoFilter = {kinds: [GIT_REPO], authors, \"#d\": dTagValues}\n       return _derived(deriveEvents(repository, {filters: [repoFilter]}), events =\u003e {\n-        if (events.length === 0) {\n+        if (events.length !== dTagValues.length) {\n           load({relays: relayHints, filters: [repoFilter]})\n         }\n         return events\n@@ -83,9 +76,10 @@\n     }\n   })\n \n-  onMount(() =\u003e {\n-    loading = false\n-    console.log(\"loadedBookmarkedRepos\", loadedBookmarkedRepos)\n+  $effect(() =\u003e {\n+    if (loadedBookmarkedRepos) {\n+      loading = false\n+    }\n   })\n \n   const onAddRepo = () =\u003e {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex ef46a62..02c4ef9 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -13,6 +13,7 @@\n   import {Address, GIT_ISSUE, GIT_PATCH, type Filter} from \"@welshman/util\"\n   import {load} from \"@welshman/net\"\n   import {nthEq} from \"@welshman/lib\"\n+    import PageBar from \"@src/lib/components/PageBar.svelte\"\n \n   const {id, relay} = $page.params\n \n@@ -77,11 +78,67 @@\n         relays: relays,\n         filters: [issuesFilter, patchesFilter, repoStateFilter],\n       })\n+\n+      if ($repoState \u0026\u0026 $issues \u0026\u0026 $patches) {\n+        console.log(\"issues\", $issues)\n+        console.log(\"patches\", $patches)\n+      }\n     }\n   })\n \u003c/script\u003e\n-\n+\u003cPageBar\u003e\n+  \u003cRepoHeader event={$eventStore as RepoAnnouncementEvent} {activeTab}\u003e\n+    {#snippet children(activeTab: string)}\n+      \u003cRepoTab\n+        tabValue={id}\n+        label=\"Overview\"\n+        href={`/spaces/${encodeddRelay}/git/${id}`}\n+        {activeTab}\u003e\n+        {#snippet icon()}\n+          \u003cFileCode class=\"h-4 w-4\" /\u003e\n+        {/snippet}\n+      \u003c/RepoTab\u003e\n+      \u003cRepoTab\n+        tabValue=\"code\"\n+        label=\"Code\"\n+        href={`/spaces/${encodeddRelay}/git/${id}/code`}\n+        {activeTab}\u003e\n+        {#snippet icon()}\n+          \u003cGitBranch class=\"h-4 w-4\" /\u003e\n+        {/snippet}\n+      \u003c/RepoTab\u003e\n+      \u003cRepoTab\n+        tabValue=\"issues\"\n+        label=\"Issues\"\n+        href={`/spaces/${encodeddRelay}/git/${id}/issues`}\n+        {activeTab}\u003e\n+        {#snippet icon()}\n+          \u003cCircleAlert class=\"h-4 w-4\" /\u003e\n+        {/snippet}\n+      \u003c/RepoTab\u003e\n+      \u003cRepoTab\n+        tabValue=\"patches\"\n+        label=\"Patches\"\n+        href={`/spaces/${encodeddRelay}/git/${id}/patches`}\n+        {activeTab}\u003e\n+        {#snippet icon()}\n+          \u003cGitPullRequest class=\"h-4 w-4\" /\u003e\n+        {/snippet}\n+      \u003c/RepoTab\u003e\n+      \u003cRepoTab\n+        tabValue=\"wiki\"\n+        label=\"Wiki\"\n+        href={`/spaces/${encodeddRelay}/git/${id}/wiki`}\n+        {activeTab}\u003e\n+        {#snippet icon()}\n+          \u003cBook class=\"h-4 w-4\" /\u003e\n+        {/snippet}\n+      \u003c/RepoTab\u003e\n+    {/snippet}\n+  \u003c/RepoHeader\u003e\n+\u003c/PageBar\u003e\n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n+\n   {#if $eventStore === undefined}\n     \u003cdiv class=\"p-4 text-center\"\u003eLoading repository...\u003c/div\u003e\n   {:else if !$eventStore}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 91516ec..977bd01 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -22,6 +22,8 @@\n     type RepoAnnouncementEvent,\n     type RepoStateEvent,\n   } from \"@nostr-git/shared-types\"\n+  import {fly} from \"@lib/transition\"\n+  import Spinner from \"@src/lib/components/Spinner.svelte\"\n \n   const eventStore = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n   const repo = getContext\u003c{\n@@ -31,30 +33,48 @@\n     patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n   }\u003e(\"repo\")\n \n-  let loading = $state(false)\n+  let loading = $state(true)\n \n   const repoState = repo.state()\n   const issues = repo.issues()\n   const patches = repo.patches()\n \n-  let issueCount = $derived.by(() =\u003e $issues?.length ?? 0)\n+  let issueCount = $derived.by(() =\u003e {\n+    if ($issues) {\n+      return $issues.length\n+    }\n+  })\n+\n+  let branchCount = $state(0)\n \n-  let branchCount = $derived.by(() =\u003e {\n+  $effect(() =\u003e {\n     if ($repoState) {\n       const repo = parseRepoStateEvent($repoState as RepoStateEvent)\n-      return repo.refs.length\n+      branchCount = repo.refs.length\n+    } else {\n+      listBranchesFromEvent({repoEvent: $eventStore}).then(b =\u003e (branchCount = b.length))\n     }\n-    return 0\n   })\n \n   let contributorCount = $derived.by(() =\u003e {\n     if ($eventStore) {\n       const repo = parseRepoAnnouncementEvent($eventStore as RepoAnnouncementEvent)\n-      return repo.maintainers?.length ?? 0\n+      const maintainerCount = repo.maintainers\n+        ? repo.maintainers.includes($eventStore.pubkey)\n+          ? repo.maintainers.length\n+          : repo.maintainers.length + 1\n+        : 1\n+      return maintainerCount\n     }\n     return 0\n   })\n \n+  const patchCount = $derived.by(() =\u003e {\n+    if ($patches) {\n+      return $patches.length\n+    }\n+  })\n+\n   const statuses = $derived.by(() =\u003e {\n     if ($issues) {\n       const statusFilter = [\n@@ -98,12 +118,10 @@\n   const mainBranch = $derived.by(async () =\u003e {\n     if ($repoState) {\n       const repo = parseRepoStateEvent($repoState as RepoStateEvent)\n-      console.log(repo)\n       return repo.head\n     } else {\n       const branches = await listBranchesFromEvent({repoEvent: $eventStore})\n-      console.log(branches)\n-      return branches?.[0].name\n+      return branches.length \u003e 0 ? branches[0].name : undefined\n     }\n   })\n \n@@ -117,7 +135,7 @@\n     {label: \"Issues\", value: () =\u003e issueCount, icon: CircleAlert},\n     {\n       label: \"Patches\",\n-      value: () =\u003e $patches.length,\n+      value: () =\u003e patchCount,\n       icon: GitPullRequest,\n     },\n   ]\n@@ -138,6 +156,7 @@\n       path: \"README.md\",\n     })\n     renderedReadme = readme ? md.render(readme) : \"\"\n+    loading = false\n   })\n \u003c/script\u003e\n \n@@ -146,7 +165,7 @@\n     {#each stats as stat}\n       \u003cCard class=\"p-4\"\u003e\n         \u003cdiv class=\"flex items-center gap-2\"\u003e\n-          \u003cstat.icon class=\"h-5 w-5 text-muted-foreground\" /\u003e\n+          \u003cstat.icon class=\"h-5 text-muted-foreground\" /\u003e\n           \u003cdiv\u003e\n             \u003cp class=\"text-sm text-muted-foreground\"\u003e{stat.label}\u003c/p\u003e\n             \u003cp class=\"text-2xl font-semibold\"\u003e{stat.value()}\u003c/p\u003e\n@@ -157,42 +176,101 @@\n   \u003c/div\u003e\n   {#if renderedReadme}\n     \u003cdiv\n-      class=\"prose-slate dark:prose-invert prose-headings:font-bold prose-headings:mb-3 prose-headings:mt-8 prose-h1:text-3xl prose-h2:text-2xl prose-h3:text-xl prose-p:leading-relaxed prose-p:my-4 prose-ul:my-4 prose-ol:my-4 prose-li:marker:text-primary prose-blockquote:border-l-4 prose-blockquote:border-accent prose-blockquote:bg-accent/10 prose-blockquote:p-4 prose-blockquote:rounded prose-blockquote:my-6 prose-table:my-6 prose-table:border prose-table:border-muted prose-th:bg-muted/50 prose-th:font-semibold prose-th:p-3 prose-td:p-3 prose-pre:bg-zinc-900 prose-pre:rounded-lg prose-pre:p-4 prose-code:bg-zinc-800 prose-code:rounded-md prose-code:px-2 prose-code:py-1 prose-code:text-sm prose max-w-none overflow-x-auto rounded-xl border border-muted bg-muted p-8 shadow-md\"\u003e\n+      class=\"prose max-w-2xl bg-white dark:bg-zinc-900\"\n+      in:fly\u003e\n       {@html renderedReadme}\n+      \u003cstyle\u003e\n+        .prose {\n+          color: theme('colors.zinc.50');\n+          background: none;\n+        }\n+        .dark .prose {\n+          color: theme('colors.white');\n+        }\n+        .prose h1, .prose h2, .prose h3 {\n+          font-weight: 600;\n+          line-height: 1.25;\n+          color: theme('colors.zinc.50');\n+          margin-top: 2rem;\n+          margin-bottom: 1rem;\n+        }\n+        .prose h1 {\n+          font-size: 2rem;\n+          border-bottom: 1px solid theme('colors.zinc.50');\n+          padding-bottom: 0.3em;\n+        }\n+        .prose h2 {\n+          font-size: 1.5rem;\n+          border-bottom: 1px solid theme('colors.zinc.50');\n+          padding-bottom: 0.2em;\n+        }\n+        .prose h3 {\n+          font-size: 1.25rem;\n+          padding-bottom: 0.1em;\n+        }\n+        .prose ul, .prose ol {\n+          margin: 1em 0;\n+          padding-left: 2em;\n+        }\n+        .prose li {\n+          margin: 0.3em 0;\n+        }\n+        .prose a {\n+          color: theme('colors.accent');\n+          text-decoration: underline;\n+          text-underline-offset: 2px;\n+          transition: color 0.2s;\n+        }\n+        .prose a:hover {\n+          color: theme('colors.primary');\n+        }\n+        .prose code {\n+          background: theme('colors.zinc.700');\n+          color: theme('colors.zinc.100');\n+          border-radius: 4px;\n+          padding: 0.2em 0.4em;\n+          font-size: 0.95em;\n+        }\n+        .prose pre {\n+          background: theme('colors.zinc.900');\n+          color: theme('colors.zinc.100');\n+          border-radius: 8px;\n+          padding: 1em;\n+          margin: 1.5em 0;\n+          font-size: 1em;\n+          overflow-x: auto;\n+        }\n+        .prose blockquote {\n+          border-left: 4px solid theme('colors.zinc.300');\n+          background: theme('colors.zinc.50');\n+          color: theme('colors.zinc.600');\n+          padding: 1em 1.5em;\n+          border-radius: 0.5em;\n+          margin: 1.5em 0;\n+          font-style: italic;\n+        }\n+        .prose table {\n+          width: 100%;\n+          border-collapse: collapse;\n+          margin-bottom: 1.5em;\n+          background: theme('colors.zinc.50');\n+          border-radius: 0.5em;\n+          overflow: hidden;\n+        }\n+        .prose th, .prose td {\n+          border: 1px solid theme('colors.zinc.200');\n+          padding: 0.6em 1em;\n+        }\n+        .prose th {\n+          background: theme('colors.zinc.100');\n+          font-weight: 600;\n+        }\n+      \u003c/style\u003e\n     \u003c/div\u003e\n+  {:else if loading}\n+    \u003cSpinner {loading}\u003eLoading README.md...\u003c/Spinner\u003e\n   {:else}\n     \u003cdiv class=\"text-muted-foreground\"\u003eNo README.md found.\u003c/div\u003e\n   {/if}\n \n-  \u003cstyle\u003e\n-    /* Further polish for markdown rendering in README */\n-    .prose h1,\n-    .prose h2,\n-    .prose h3 {\n-      letter-spacing: -0.01em;\n-    }\n-    .prose h1 {\n-      border-bottom: 1px solid theme(\"colors.border\");\n-      padding-bottom: 0.3em;\n-    }\n-    .prose blockquote {\n-      border-left-width: 4px;\n-      border-color: var(--tw-prose-accent);\n-      background: var(--tw-prose-accent-bg, rgba(59, 130, 246, 0.05));\n-      padding: 1rem;\n-      border-radius: 0.5rem;\n-      margin: 1.5rem 0;\n-    }\n-    .prose pre {\n-      margin: 1.5rem 0;\n-    }\n-    .prose table {\n-      border-radius: 0.5rem;\n-      overflow: hidden;\n-    }\n-    .prose th,\n-    .prose td {\n-      border: 1px solid theme(\"colors.zinc.700\");\n-    }\n-  \u003c/style\u003e\n \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex 1383488..a03e86c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -29,6 +29,7 @@\n     repo: Readable\u003cTrustedEvent\u003e\n     state: () =\u003e Readable\u003cRepoStateEvent\u003e\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n   }\u003e(\"repo\")\n \n   // UI state\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex d3d803b..a638f33 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -1,12 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n   import {Button, IssueCard} from \"@nostr-git/ui\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n-  import {\n-    Address,\n-    COMMENT,\n-    GIT_ISSUE,\n-    type TrustedEvent,\n-  } from \"@welshman/util\"\n+  import {Address, COMMENT, GIT_ISSUE, type TrustedEvent} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n   import {nthEq} from \"@welshman/lib\"\n   import {deriveProfile, repository} from \"@welshman/app\"\n@@ -14,6 +9,7 @@\n   import {makeFeed} from \"@src/app/requests\"\n   import type {Readable} from \"svelte/store\"\n   import {type RepoStateEvent} from \"@nostr-git/shared-types\"\n+  import {fly} from \"@lib/transition\"\n \n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n@@ -23,15 +19,15 @@\n     issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n   }\u003e(\"repo\")\n \n-  let issues = $derived(repo.issues())\n+  let issues = repo.issues()\n   const comments: TrustedEvent[] = $state([])\n \n   let loading = $state(true)\n   let element: HTMLElement | undefined = $state()\n \n   $effect(() =\u003e {\n-    if (!issues) {\n-      return\n+    if (issues) {\n+      loading = false\n     }\n \n     const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || []\n@@ -92,7 +88,9 @@\n   {:else}\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each $issues as issue (issue.id)}\n-        \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey, relays)} /\u003e\n+        \u003cdiv in:fly\u003e\n+          \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey)} /\u003e\n+        \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\n   {/if}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 99618ed..2c65bf6 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -9,6 +9,14 @@\n   import {makeFeed} from \"@src/app/requests\"\n   import type {Readable} from \"svelte/store\"\n   import {type RepoStateEvent} from \"@nostr-git/shared-types\"\n+  import {deriveEvents} from \"@welshman/store\"\n+  import {\n+    GIT_STATUS_OPEN,\n+    GIT_STATUS_COMPLETE,\n+    GIT_STATUS_CLOSED,\n+    GIT_STATUS_DRAFT,\n+  } from \"@welshman/util\"\n+    import { fly } from \"@lib/transition\"\n \n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n@@ -19,14 +27,36 @@\n     patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n   }\u003e(\"repo\")\n \n-  let patches = $derived(repo.patches())\n+  const patches = $derived(repo.patches())\n+\n+  const patchList = $derived.by(() =\u003e {\n+    if ($patches) {\n+      return $patches.map(patch =\u003e {\n+        const statuses = deriveEvents(repository, {\n+          filters: [\n+            {\n+              kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+              \"#e\": [patch.id],\n+            },\n+          ],\n+        })\n+        const profile = deriveProfile(patch.pubkey)\n+\n+        return {\n+          ...patch,\n+          status,\n+          profile,\n+        }\n+      })\n+    }\n+  })\n \n   let loading = $state(true)\n   let element: HTMLElement | undefined = $state()\n \n   $effect(() =\u003e {\n-    if (!patches) {\n-      return\n+    if (patches) {\n+      loading = false\n     }\n \n     const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || []\n@@ -51,7 +81,7 @@\n \n \u003cdiv bind:this={element}\u003e\n   \u003cdiv\n-    class=\"z-10 sticky top-0 mb-4 flex items-center justify-between bg-background/95 py-4 backdrop-blur supports-[backdrop-filter]:bg-background/60\"\u003e\n+    class=\"z-10 sticky top-0 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003ePatches\u003c/h2\u003e\n       \u003cp class=\"text-sm text-muted-foreground\"\u003eReview and merge code changes\u003c/p\u003e\n@@ -87,8 +117,10 @@\n     \u003c/div\u003e\n   {:else}\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n-      {#each $patches as patch}\n-        \u003cPatchCard event={patch} owner={deriveProfile(patch.pubkey)} /\u003e\n+      {#each patchList! as patch}\n+        \u003cdiv in:fly\u003e\n+          \u003cPatchCard event={patch} status={patch.status} owner={patch.profile} /\u003e\n+        \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\n   {/if}\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-u462yz27","title":"Render markdown and nostr entities on git feed","description":"It should render stuff as their corresponding cards would","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue"]}
{"id":"flotilla-u4m5ujte","title":"From 270e11de1ec28e1a1b5c49a39c397a198d7526aa Mon Sep 17 00:00:00 2001","description":"From 270e11de1ec28e1a1b5c49a39c397a198d7526aa Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 14 Aug 2025 15:24:35 -0700\nSubject: [PATCH 1/2] feat: add Nostr identifier fields to commit metadata interface\n\n---\n packages/nostr-git                                                       |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte |  3 +++\n src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts     | 10 +++++++++-\n 3 files changed, 13 insertions(+), 2 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 0903ee7..5ad9e1e 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 0903ee7ca0360e70e52200493f716b9eb599e8c1\n+Subproject commit 5ad9e1eed43e27bc1ca8779818226daf44aaf166\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\nindex c169e22..f0decd8 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\n@@ -123,6 +123,9 @@\n     message={commitMeta.message}\n     parents={commitMeta.parents}\n     displayName={commitMeta.author}\n+    pubkey={commitMeta.pubkey}\n+    nip05={commitMeta.nip05}\n+    nip39={commitMeta.nip39}\n   /\u003e\n \n   \u003c!-- Diff Summary --\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\nindex 3b456c8..f6ba348 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\n@@ -21,6 +21,10 @@ export interface CommitMeta {\n   date: number;\n   message: string;\n   parents: string[];\n+  // Optional Nostr identifiers if available (reserved for future resolver wiring)\n+  pubkey?: string;\n+  nip05?: string;\n+  nip39?: string;\n }\n \n export const load: PageLoad = async ({ params, parent }) =\u003e {\n@@ -92,7 +96,11 @@ export const load: PageLoad = async ({ params, parent }) =\u003e {\n       email: commitDetails.meta.email,\n       date: commitDetails.meta.date,\n       message: commitDetails.meta.message,\n-      parents: commitDetails.meta.parents\n+      parents: commitDetails.meta.parents,\n+      // Placeholders to be populated when resolver is wired\n+      pubkey: undefined,\n+      nip05: undefined,\n+      nip39: undefined\n     };\n \n     // Convert git-worker changes to our CommitChange format\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-uckl3mtf","title":"Cannot set Status of Patches","description":"we need to have this just like gitworkshop has itm similar to issue statuses","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue"]}
{"id":"flotilla-us09h60a","title":"From 9327eeb3f374d24080ea6c082d30ee7d946d9c07 Mon Sep 17 00:00:00 2001","description":"From 9327eeb3f374d24080ea6c082d30ee7d946d9c07 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Wed, 4 Jun 2025 20:37:48 -0700\nSubject: [PATCH 19/67] Add latest note from admin to relay dashboard\n\n---\n src/app/components/ProfileLatest.svelte | 40 ++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/+page.svelte  | 23 ++++++++++++++++-------\n 2 files changed, 56 insertions(+), 7 deletions(-)\n create mode 100644 src/app/components/ProfileLatest.svelte\n\ndiff --git a/src/app/components/ProfileLatest.svelte b/src/app/components/ProfileLatest.svelte\nnew file mode 100644\nindex 0000000..6a17bab\n--- /dev/null\n+++ b/src/app/components/ProfileLatest.svelte\n@@ -0,0 +1,40 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import type {Snippet} from \"svelte\"\n+  import {load} from \"@welshman/net\"\n+  import {NOTE} from \"@welshman/util\"\n+  import {fly} from \"@lib/transition\"\n+  import Spinner from \"@lib/components/Spinner.svelte\"\n+  import NoteItem from \"@app/components/NoteItem.svelte\"\n+\n+  interface Props {\n+    url: string\n+    pubkey: string\n+    limit?: number\n+    fallback?: Snippet\n+  }\n+\n+  const {url, pubkey, limit = 1, fallback}: Props = $props()\n+\n+  const events = load({\n+    relays: [url],\n+    filters: [{authors: [pubkey], kinds: [NOTE], limit}],\n+  })\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"col-4\"\u003e\n+  \u003cdiv class=\"flex flex-col gap-2\"\u003e\n+    {#await events}\n+      \u003cp class=\"center my-12 flex\"\u003e\n+        \u003cSpinner loading /\u003e\n+      \u003c/p\u003e\n+    {:then events}\n+      {#each events as event (event.id)}\n+        \u003cdiv in:fly\u003e\n+          \u003cNoteItem {url} {event} /\u003e\n+        \u003c/div\u003e\n+      {:else}\n+        {@render fallback?.()}\n+      {/each}\n+    {/await}\n+  \u003c/div\u003e\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/+page.svelte b/src/routes/spaces/[relay]/+page.svelte\nindex 93c9e7d..43c89ff 100644\n--- a/src/routes/spaces/[relay]/+page.svelte\n+++ b/src/routes/spaces/[relay]/+page.svelte\n@@ -11,6 +11,7 @@\n   import PageContent from \"@lib/components/PageContent.svelte\"\n   import StatusIndicator from \"@lib/components/StatusIndicator.svelte\"\n   import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n+  import ProfileLatest from \"@app/components/ProfileLatest.svelte\"\n   import ChannelName from \"@app/components/ChannelName.svelte\"\n   import SpaceJoin from \"@app/components/SpaceJoin.svelte\"\n   import RelayName from \"@app/components/RelayName.svelte\"\n@@ -49,7 +50,6 @@\n \n   const addRoom = () =\u003e pushModal(RoomCreate, {url})\n \n-  let relayAdminEvents: TrustedEvent[] = $state([])\n   let roomSearchQuery = $state(\"\")\n \n   const pubkey = $derived($relay?.profile?.pubkey)\n@@ -225,13 +225,22 @@\n               {/if}\n               \u003cChannelName {url} {room} /\u003e\n             \u003c/div\u003e\n-          \u003c/Link\u003e\n-        {/each}\n-        \u003cButton onclick={addRoom} class=\"btn btn-neutral whitespace-nowrap\"\u003e\n-          \u003cIcon icon=\"add-circle\" /\u003e\n-          Create\n-        \u003c/Button\u003e\n+          {/if}\n+        \u003c/div\u003e\n       \u003c/div\u003e\n+      {#if pubkey}\n+        \u003cdiv class=\"card2 bg-alt\"\u003e\n+          \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+            \u003cIcon icon=\"user-rounded\" /\u003e\n+            Latest Updates\n+          \u003c/h3\u003e\n+          \u003cProfileLatest {url} {pubkey}\u003e\n+            {#snippet fallback()}\n+              \u003cp class=\"text-sm opacity-60\"\u003eNo recent posts from the relay admin\u003c/p\u003e\n+            {/snippet}\n+          \u003c/ProfileLatest\u003e\n+        \u003c/div\u003e\n+      {/if}\n     \u003c/div\u003e\n   \u003c/PageContent\u003e\n \u003c/div\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-v05ct83e","title":"Fork : Operation FAILS if source host is NOT github and target host IS github","description":"- GRASP -\u003e Github fails (original repo: owner = npub does not work in GitHub api)\n- GitLab -\u003e GitHub fails\n\nThe annoying part of this bug is when repos like Amber (naddr1qvzqqqrhnypzqateqake4lc2fn77lflzq30jfpk8uhvtccalc66989er8cdmljceqqz5zmtzv4eqsrpqjs ) has a grasp URI listed before the GitHub URL . GitHub will not be attempted because the forking will fail due to the GRASP URI mishandling. \nSome repos do not even exist on GitHub, all of these will fail when we try to fork to GitHub. \n\nScreenshot:\nhttps://i.nostr.build/nmPaef4S10KEDaYZ.png","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["create_repo","forks","issue","v1"]}
{"id":"flotilla-v0qyzcjm","title":"From e75edb2d85c3c9357fc36e166de675d2d582367f Mon Sep 17 00:00:00 2001","description":"From e75edb2d85c3c9357fc36e166de675d2d582367f Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Thu, 5 Jun 2025 08:39:30 -0700\nSubject: [PATCH 22/67] Factor space recent activity into its own component\n\n---\n src/app/components/SpaceRecentActivity.svelte | 42 ++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/+page.svelte        | 78 +++---------------------------------------------------------------------------\n 2 files changed, 45 insertions(+), 75 deletions(-)\n create mode 100644 src/app/components/SpaceRecentActivity.svelte\n\ndiff --git a/src/app/components/SpaceRecentActivity.svelte b/src/app/components/SpaceRecentActivity.svelte\nnew file mode 100644\nindex 0000000..c5d4641\n--- /dev/null\n+++ b/src/app/components/SpaceRecentActivity.svelte\n@@ -0,0 +1,42 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import Icon from \"@lib/components/Icon.svelte\"\n+  import ChannelName from \"@app/components/ChannelName.svelte\"\n+  import {makeChannelId, channelsById, deriveUserRooms} from \"@app/state\"\n+\n+  interface Props {\n+    url: string\n+  }\n+\n+  const {url}: Props = $props()\n+\n+  const userRooms = deriveUserRooms(url)\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"card2 bg-alt\"\u003e\n+  \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+    \u003cIcon icon=\"chat-round\" /\u003e\n+    Recent Activity\n+  \u003c/h3\u003e\n+  \u003cdiv class=\"flex flex-col gap-3\"\u003e\n+    {#if $userRooms.length \u003e 0}\n+      {#each $userRooms.slice(0, 3) as room (room)}\n+        {@const channel = $channelsById.get(makeChannelId(url, room))}\n+        \u003cdiv class=\"flex items-center gap-3 rounded bg-base-100\"\u003e\n+          \u003cdiv class=\"flex items-center gap-2\"\u003e\n+            {#if channel?.closed || channel?.private}\n+              \u003cIcon icon=\"lock\" size={4} /\u003e\n+            {:else}\n+              \u003cIcon icon=\"hashtag\" /\u003e\n+            {/if}\n+            \u003cspan class=\"font-medium\"\u003e\n+              \u003cChannelName {url} {room} /\u003e\n+            \u003c/span\u003e\n+          \u003c/div\u003e\n+          \u003cspan class=\"ml-auto text-sm opacity-60\"\u003eActive conversations\u003c/span\u003e\n+        \u003c/div\u003e\n+      {/each}\n+    {:else}\n+      \u003cp class=\"text-sm opacity-60\"\u003eNo recent activity\u003c/p\u003e\n+    {/if}\n+  \u003c/div\u003e\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/+page.svelte b/src/routes/spaces/[relay]/+page.svelte\nindex 6dc5103..6d24186 100644\n--- a/src/routes/spaces/[relay]/+page.svelte\n+++ b/src/routes/spaces/[relay]/+page.svelte\n@@ -11,18 +11,12 @@\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n   import ProfileLatest from \"@app/components/ProfileLatest.svelte\"\n-  import ChannelName from \"@app/components/ChannelName.svelte\"\n   import SpaceJoin from \"@app/components/SpaceJoin.svelte\"\n   import RelayName from \"@app/components/RelayName.svelte\"\n   import RelayDescription from \"@app/components/RelayDescription.svelte\"\n   import SpaceQuickLinks from \"@app/components/SpaceQuickLinks.svelte\"\n-  import {\n-    decodeRelay,\n-    makeChannelId,\n-    channelsById,\n-    deriveUserRooms,\n-    userRoomsByUrl,\n-  } from \"@app/state\"\n+  import SpaceRecentActivity from \"@app/components/SpaceRecentActivity.svelte\"\n+  import {decodeRelay, userRoomsByUrl} from \"@app/state\"\n   import {\n     makeChatPath,\n     makeThreadPath,\n@@ -35,7 +29,6 @@\n \n   const url = decodeRelay($page.params.relay)\n   const relay = deriveRelay(url)\n-  const userRooms = deriveUserRooms(url)\n   const otherRooms = deriveOtherRooms(url)\n   const threadsPath = makeThreadPath(url)\n   const calendarPath = makeCalendarPath(url)\n@@ -131,72 +124,7 @@\n     \u003c/div\u003e\n     \u003cRelayDescription {url} /\u003e\n   \u003c/div\u003e\n-  \u003cdiv class=\"card2 bg-alt md:hidden\"\u003e\n-    \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n-      \u003cIcon icon=\"compass-big\" /\u003e\n-      Quick Links\n-    \u003c/h3\u003e\n-    \u003cdiv class=\"flex flex-col gap-2\"\u003e\n-      \u003cLink href={threadsPath} class=\"btn btn-primary w-full justify-start\"\u003e\n-        \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n-          \u003cIcon icon=\"notes-minimalistic\" /\u003e\n-          Threads\n-          {#if $notifications.has(threadsPath)}\n-            \u003cdiv\n-              class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n-              transition:fade\u003e\n-            \u003c/div\u003e\n-          {/if}\n-        \u003c/div\u003e\n-      \u003c/Link\u003e\n-      \u003cLink href={calendarPath} class=\"btn btn-secondary w-full justify-start\"\u003e\n-        \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n-          \u003cIcon icon=\"calendar-minimalistic\" /\u003e\n-          Calendar\n-          {#if $notifications.has(calendarPath)}\n-            \u003cdiv\n-              class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n-              transition:fade\u003e\n-            \u003c/div\u003e\n-          {/if}\n-        \u003c/div\u003e\n-      \u003c/Link\u003e\n-      {#if $userRooms.length + $otherRooms.length \u003e 10}\n-        \u003clabel class=\"input input-sm input-bordered flex flex-grow items-center gap-2\"\u003e\n-          \u003cIcon icon=\"magnifer\" size={4} /\u003e\n-          \u003cinput\n-            bind:value={roomSearchQuery}\n-            class=\"grow\"\n-            type=\"text\"\n-            placeholder=\"Search rooms...\" /\u003e\n-        \u003c/label\u003e\n-      {/if}\n-      {#each filteredRooms() as room (room)}\n-        {@const roomPath = makeRoomPath(url, room)}\n-        {@const channel = $channelsById.get(makeChannelId(url, room))}\n-        \u003cLink href={roomPath} class=\"btn btn-neutral btn-sm relative w-full justify-start\"\u003e\n-          \u003cdiv class=\"flex min-w-0 items-center gap-2 overflow-hidden text-nowrap\"\u003e\n-            {#if channel?.closed || channel?.private}\n-              \u003cIcon icon=\"lock\" size={4} /\u003e\n-            {:else}\n-              \u003cIcon icon=\"hashtag\" /\u003e\n-            {/if}\n-            \u003cChannelName {url} {room} /\u003e\n-          \u003c/div\u003e\n-          {#if $notifications.has(roomPath)}\n-            \u003cdiv class=\"absolute right-1 top-1 h-2 w-2 rounded-full bg-primary\" transition:fade\u003e\n-            \u003c/div\u003e\n-          {/if}\n-        \u003c/Link\u003e\n-      {/each}\n-      {#if hasNip29($relay)}\n-        \u003cButton onclick={addRoom} class=\"btn btn-neutral btn-sm w-full justify-start\"\u003e\n-          \u003cIcon icon=\"add-circle\" /\u003e\n-          Create Room\n-        \u003c/Button\u003e\n-      {/if}\n-    \u003c/div\u003e\n-  \u003c/div\u003e\n+  \u003cSpaceQuickLinks {url} /\u003e\n   \u003cdiv class=\"grid grid-cols-1 gap-2 lg:grid-cols-2\"\u003e\n     \u003cdiv class=\"flex flex-col gap-2\"\u003e\n       \u003cdiv class=\"card2 bg-alt\"\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-v1lfczm1","title":"From f3ebb35927980ea5919bb4fa396b0851b2d0f5ec Mon Sep 17 00:00:00 2001","description":"From f3ebb35927980ea5919bb4fa396b0851b2d0f5ec Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Tue, 11 Nov 2025 12:10:16 +0500\nSubject: [PATCH] feat(git): implement repository bookmarking functionality in repo layout\n\nImplement core bookmarking logic in repository detail page:\n\nAdd bookmark state management:\n- Add isBookmarked and isTogglingBookmark reactive state variables\n- Create effect to check bookmark status on component mount\n- Subscribe to bookmarksStore for real-time bookmark status updates\n- Use repo address from repoClass.address or derive from repoEvent\n- Handle edge cases when repoEvent is not available\n\nImplement bookmarkRepo function:\n- Toggle bookmark state (add/remove) based on current status\n- Build NIP-51 bookmark event tags with proper a-tag format\n- Preserve existing bookmarks when adding/removing\n- Include relay hints for better bookmark resolution\n- Update bookmarksStore immediately for responsive UI\n- Publish bookmark event to user's relays using publishThunk\n- Show appropriate toast notifications (success/error)\n- Handle errors gracefully with user-friendly messages\n- Prevent concurrent bookmark operations with isTogglingBookmark guard\n\nIntegrate with RepoHeader component:\n- Pass bookmarkRepo function as prop to RepoHeader\n- Pass isBookmarked state for visual feedback\n- Pass isTogglingBookmark for loading state\n- Connect bookmark functionality to UI component\n\nThis implementation follows the same pattern as other repo actions\n(forkRepo, settingsRepo) by keeping the UI component decoupled from\nbusiness logic, with all bookmark management handled in the layout.\n---\n packages/nostr-git                                      |   2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte | 136 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-----\n 2 files changed, 132 insertions(+), 6 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex deb66d0..9d7ef6b 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit deb66d015ea9373b71ab04f1da3fa52fcdbd4d28\n+Subproject commit 9d7ef6b2647634dca8a1f095d673da82c1284908\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 5cb6b16..cb48924 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -1,5 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {RepoHeader, RepoTab, toast} from \"@nostr-git/ui\"\n+  import {RepoHeader, RepoTab, toast, bookmarksStore} from \"@nostr-git/ui\"\n   import {ConfigProvider} from \"@nostr-git/ui\"\n   import {FileCode, GitBranch, CircleAlert, GitPullRequest, GitCommit, Layers} from \"@lucide/svelte\"\n   import {page} from \"$app/stores\"\n@@ -17,15 +17,15 @@\n   import {EditRepoPanel, ForkRepoDialog} from \"@nostr-git/ui\"\n   import {postRepoAnnouncement} from \"@lib/budabit/commands.js\"\n   import type {RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n-  import {derived as _derived} from \"svelte/store\"\n-  import {repository, pubkey, profilesByPubkey, profileSearch, loadProfile, relaySearch} from \"@welshman/app\"\n+  import {GIT_REPO_BOOKMARK_DTAG, GRASP_SET_KIND, DEFAULT_GRASP_SET_ID, parseGraspServersEvent} from \"@nostr-git/shared-types\"\n+  import {derived as _derived, get as getStore} from \"svelte/store\"\n+  import {repository, pubkey, profilesByPubkey, profileSearch, loadProfile, relaySearch, publishThunk} from \"@welshman/app\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {load} from \"@welshman/net\"\n   import {Router} from \"@welshman/router\"\n-  import {GRASP_SET_KIND, DEFAULT_GRASP_SET_ID, parseGraspServersEvent} from \"@nostr-git/shared-types\"\n   import {goto, afterNavigate, beforeNavigate} from \"$app/navigation\"\n   import {onMount} from \"svelte\"\n-  import {normalizeRelayUrl} from \"@welshman/util\"\n+  import {normalizeRelayUrl, NAMED_BOOKMARKS, makeEvent, Address} from \"@welshman/util\"\n   import PageBar from \"@src/lib/components/PageBar.svelte\"\n   import Button from \"@src/lib/components/Button.svelte\"\n   import Icon from \"@src/lib/components/Icon.svelte\"\n@@ -43,6 +43,37 @@\n   // Refresh state\n   let isRefreshing = $state(false)\n   \n+  // Bookmark state\n+  let isTogglingBookmark = $state(false)\n+  let isBookmarked = $state(false)\n+  \n+  // Check if repo is bookmarked\n+  $effect(() =\u003e {\n+    if (!repoClass || !repoClass.repoEvent) return\n+    try {\n+      const address = repoClass.address || Address.fromEvent(repoClass.repoEvent).toString()\n+      const bookmarks = getStore(bookmarksStore)\n+      isBookmarked = bookmarks.some((b) =\u003e b.address === address)\n+    } catch {\n+      isBookmarked = false\n+    }\n+  })\n+  \n+  // Subscribe to bookmarks store to update bookmark status\n+  $effect(() =\u003e {\n+    const unsubscribe = bookmarksStore.subscribe(() =\u003e {\n+      if (!repoClass || !repoClass.repoEvent) return\n+      try {\n+        const address = repoClass.address || Address.fromEvent(repoClass.repoEvent).toString()\n+        const bookmarks = getStore(bookmarksStore)\n+        isBookmarked = bookmarks.some((b) =\u003e b.address === address)\n+      } catch {\n+        isBookmarked = false\n+      }\n+    })\n+    return unsubscribe\n+  })\n+  \n   // Scroll position management\n   let pageContentElement = $state\u003cElement | undefined\u003e()\n   const scrollStorageKey = `repoScroll:${id}`\n@@ -281,6 +312,98 @@\n     })\n   }\n \n+  async function bookmarkRepo() {\n+    if (!repoClass || !$pubkey || isTogglingBookmark) return\n+\n+    isTogglingBookmark = true\n+\n+    try {\n+      if (!repoClass.repoEvent) {\n+        throw new Error(\"Repository event not available\")\n+      }\n+      \n+      // Get repo address\n+      const address = repoClass.address || Address.fromEvent(repoClass.repoEvent).toString()\n+      \n+      // Get current bookmarks\n+      const currentBookmarks = getStore(bookmarksStore)\n+      \n+      // Determine relay hint\n+      const relayHint = repoClass.relays?.[0] || Router.get().getRelaysForPubkey(repoClass.repoEvent.pubkey)?.[0] || \"\"\n+      const normalizedRelayHint = relayHint ? normalizeRelayUrl(relayHint) : \"\"\n+      \n+      // Build tags array\n+      const tags: string[][] = [[\"d\", GIT_REPO_BOOKMARK_DTAG]]\n+      \n+      if (isBookmarked) {\n+        // Remove bookmark: keep all bookmarks except this one\n+        currentBookmarks\n+          .filter((b) =\u003e b.address !== address)\n+          .forEach((b) =\u003e {\n+            const aTag: string[] = [\"a\", b.address]\n+            if (b.relayHint) {\n+              aTag.push(b.relayHint)\n+            }\n+            tags.push(aTag)\n+          })\n+      } else {\n+        // Add bookmark: keep all existing bookmarks and add this one\n+        currentBookmarks.forEach((b) =\u003e {\n+          const aTag: string[] = [\"a\", b.address]\n+          if (b.relayHint) {\n+            aTag.push(b.relayHint)\n+          }\n+          tags.push(aTag)\n+        })\n+        \n+        // Add the new bookmark\n+        const newATag: string[] = [\"a\", address]\n+        if (normalizedRelayHint) {\n+          newATag.push(normalizedRelayHint)\n+        }\n+        tags.push(newATag)\n+      }\n+      \n+      // Create and publish bookmark event\n+      const bookmarkEvent = makeEvent(NAMED_BOOKMARKS, { tags, content: \"\" })\n+      \n+      // Capture the action before updating store (for toast message)\n+      const wasRemoving = isBookmarked\n+      \n+      // Update store immediately for responsive UI\n+      if (isBookmarked) {\n+        bookmarksStore.remove(address)\n+      } else {\n+        bookmarksStore.add({\n+          address,\n+          event: null,\n+          relayHint: normalizedRelayHint,\n+        })\n+      }\n+      \n+      // Publish to relays\n+      const relaysToPublish = repoClass.relays.length \u003e 0 \n+        ? repoClass.relays.map(normalizeRelayUrl).filter(Boolean)\n+        : Router.get().FromUser().getUrls().map(normalizeRelayUrl).filter(Boolean)\n+      \n+      publishThunk({ event: bookmarkEvent, relays: relaysToPublish })\n+      \n+      pushToast({\n+        message: wasRemoving ? \"Bookmark removed\" : \"Repository bookmarked\",\n+      })\n+    } catch (error) {\n+      console.error(\"Failed to toggle bookmark:\", error)\n+      // Use the current isBookmarked state for error message (before any changes)\n+      const action = isBookmarked ? \"remove\" : \"add\"\n+      pushToast({\n+        message: `Failed to ${action} bookmark: ${error instanceof Error ? error.message : \"Unknown error\"}`,\n+        theme: \"error\",\n+      })\n+    } finally {\n+      isTogglingBookmark = false\n+    }\n+  }\n+\n   function overviewRepo() {\n     if (!repoClass) return\n     goto(`/spaces/${relay}/git/${id}/`)\n@@ -345,6 +468,9 @@\n       {forkRepo}\n       {settingsRepo}\n       {overviewRepo}\n+      {bookmarkRepo}\n+      {isBookmarked}\n+      isTogglingBookmark={isTogglingBookmark}\n       userPubkey={$pubkey}\n       \u003e\n       {#snippet children(activeTab: string)}\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-v1y7thm7","title":"Long comments overextend","description":"see https://budabit.club/spaces/budabit.nostr1.com/git/naddr1qvzqqqrhnypzp5zweue6xqa9npf0md5pak95zgsph2za35sentk88jmzdqwk925sqqy8xct5wd5x7mm56084h2/issues/d6261ac86480054803b79b0d5bfbf70babccc04af57477532061d502511378db","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue"]}
{"id":"flotilla-v2b86lq0","title":"Repo Bookmarks: Initial loading fails","description":"After login the user must refresh page at least once to load the bookmarked repos. \nShould be an initial reactivity bug","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","good first issue","issue","repo_bookmarks","v1"]}
{"id":"flotilla-v3j79ypf","title":"From f028b803613ceee1e5ffe89d10c3f84a4e66ad84 Mon Sep 17 00:00:00 2001","description":"From f028b803613ceee1e5ffe89d10c3f84a4e66ad84 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Thu, 25 Dec 2025 15:54:41 +0500\nSubject: [PATCH] feat: enhance commit page UI and update submodule\n\nImprove commit detail page with better layout, statistics display, and\nmobile responsiveness. Refactor markdown rendering to use consistent\ncomponent across patch pages.\n\nSubmodule updates (packages/nostr-git):\n- Update to commit 5e133cc: refactor commit card layout and diff viewer\n  * Improved commit card meta section layout\n  * Added responsive avatar sizing\n  * Enhanced diff viewer with horizontal scrolling\n\nCommit detail page (commits/[commitid]/+page.svelte):\n- Add custom styles for monospace font rendering and touch interactions\n- Redesign statistics display with grid layout:\n  * File count card with descriptive text\n  * Additions card with contextual labels (few/moderate/many)\n  * Deletions card with contextual labels\n  * Improved visual hierarchy and color coding\n- Enhance expand/collapse controls:\n  * Add ChevronsDown/ChevronsUp icons for better visual feedback\n  * Implement disabled states when all files are expanded/collapsed\n  * Add counter showing expanded files count\n  * Improve button styling with focus states and transitions\n  * Add touch-manipulation class for better mobile interaction\n- Improve file list layout:\n  * Add sticky header with backdrop blur for better navigation\n  * Enhance file header buttons with better spacing and touch targets\n  * Improve responsive design with mobile-first approach\n  * Better text truncation and wrapping for long file paths\n  * Enhanced status badge styling\n- Refactor layout structure:\n  * Change main container to flex column with gap spacing\n  * Improve padding and spacing throughout\n  * Better mobile breakpoints (sm:) for responsive design\n  * Add horizontal scrolling support for wide content\n\nPatch detail page (patches/[patchid]/+page.svelte):\n- Replace marked library HTML rendering with Markdown component:\n  * Use consistent Markdown component for PR content rendering\n  * Use consistent Markdown component for patch description rendering\n  * Remove direct HTML injection in favor of component-based approach\n  * Improves maintainability and consistency across the application\n\nThese changes improve:\n- Mobile user experience with touch-friendly interactions\n- Visual clarity with better statistics presentation\n- Code maintainability with consistent markdown rendering\n- Accessibility with better focus states and ARIA labels\n- Performance with optimized layout and rendering\n---\n packages/nostr-git                                                       |   2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte | 299 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------------------------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte  |   7 +++++--\n 3 files changed, 195 insertions(+), 113 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 3809d3d..5e133cc 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 3809d3dbbf39f8eb97c274deafb480b1cdbefb5e\n+Subproject commit 5e133cc7b6f9ad279d1163b5698900cff3090c64\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\nindex 7b0a53a..375a771 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\n@@ -1,131 +1,166 @@\n+\u003cstyle\u003e\n+  /* Ensure proper font rendering for code */\n+  .font-mono {\n+    font-family:\n+      ui-monospace, SFMono-Regular, \"SF Mono\", Consolas, \"Liberation Mono\", Menlo, monospace;\n+  }\n+\n+  /* Touch-friendly interactions */\n+  .touch-manipulation {\n+    touch-action: manipulation;\n+  }\n+\u003c/style\u003e\n+\n \u003cscript lang=\"ts\"\u003e\n-  import { ChevronDown, ChevronRight, FileText, FilePlus, FileMinus, FileX } from '@lucide/svelte';\n-  import { CommitHeader, SplitDiff } from '@nostr-git/ui';\n-  import type { PageData } from './$types';\n+  import {\n+    ChevronDown,\n+    ChevronRight,\n+    ChevronsDown,\n+    ChevronsUp,\n+    FileText,\n+    FilePlus,\n+    FileMinus,\n+    FileX,\n+    FileCode,\n+  } from \"@lucide/svelte\"\n+  import {CommitHeader, SplitDiff} from \"@nostr-git/ui\"\n+  import type {PageData} from \"./$types\"\n   import {getContext} from \"svelte\"\n   import {REPO_KEY} from \"@lib/budabit/state\"\n   import type {Repo} from \"@nostr-git/ui\"\n \n-  const { data }: { data: PageData } = $props();\n-  \n+  const {data}: {data: PageData} = $props()\n+\n   // Extract data from page load\n-  const { commitMeta, changes } = data;\n-  \n+  const {commitMeta, changes} = data\n+\n   // Get repoClass from context\n   const repoClass = getContext\u003cRepo\u003e(REPO_KEY)\n-  \n+\n   if (!repoClass) {\n     throw new Error(\"Repo context not available\")\n   }\n-  \n+\n   if (!commitMeta || !changes) {\n     throw new Error(\"Commit data not available\")\n   }\n \n   // State for collapsible file panels\n-  let expandedFiles = $state\u003cSet\u003cstring\u003e\u003e(new Set());\n+  let expandedFiles = $state\u003cSet\u003cstring\u003e\u003e(new Set())\n \n   // Toggle file expansion\n   const toggleFile = (filepath: string) =\u003e {\n     if (expandedFiles.has(filepath)) {\n-      expandedFiles.delete(filepath);\n+      expandedFiles.delete(filepath)\n     } else {\n-      expandedFiles.add(filepath);\n+      expandedFiles.add(filepath)\n     }\n-    expandedFiles = new Set(expandedFiles); // Trigger reactivity\n-  };\n+    expandedFiles = new Set(expandedFiles) // Trigger reactivity\n+  }\n \n   // Get file status icon and styling\n   const getFileStatusIcon = (status: string) =\u003e {\n     switch (status) {\n-      case 'added':\n-        return { icon: FilePlus, class: 'text-green-600' };\n-      case 'deleted':\n-        return { icon: FileMinus, class: 'text-red-600' };\n-      case 'modified':\n-        return { icon: FileText, class: 'text-blue-600' };\n-      case 'renamed':\n-        return { icon: FileX, class: 'text-yellow-600' };\n+      case \"added\":\n+        return {icon: FilePlus, class: \"text-green-600\"}\n+      case \"deleted\":\n+        return {icon: FileMinus, class: \"text-red-600\"}\n+      case \"modified\":\n+        return {icon: FileText, class: \"text-blue-600\"}\n+      case \"renamed\":\n+        return {icon: FileX, class: \"text-yellow-600\"}\n       default:\n-        return { icon: FileText, class: 'text-muted-foreground' };\n+        return {icon: FileText, class: \"text-muted-foreground\"}\n     }\n-  };\n+  }\n \n   // Get file status badge styling\n   const getStatusBadgeClass = (status: string) =\u003e {\n     switch (status) {\n-      case 'added':\n-        return 'bg-green-100 text-green-800 border-green-200';\n-      case 'deleted':\n-        return 'bg-red-100 text-red-800 border-red-200';\n-      case 'modified':\n-        return 'bg-blue-100 text-blue-800 border-blue-200';\n-      case 'renamed':\n-        return 'bg-yellow-100 text-yellow-800 border-yellow-200';\n+      case \"added\":\n+        return \"bg-green-100 text-green-800 border-green-200\"\n+      case \"deleted\":\n+        return \"bg-red-100 text-red-800 border-red-200\"\n+      case \"modified\":\n+        return \"bg-blue-100 text-blue-800 border-blue-200\"\n+      case \"renamed\":\n+        return \"bg-yellow-100 text-yellow-800 border-yellow-200\"\n       default:\n-        return 'bg-gray-100 text-gray-800 border-gray-200';\n+        return \"bg-gray-100 text-gray-800 border-gray-200\"\n     }\n-  };\n+  }\n \n   // Calculate diff stats for each file\n   const getFileStats = (hunks: any[]) =\u003e {\n-    let additions = 0;\n-    let deletions = 0;\n-    \n+    let additions = 0\n+    let deletions = 0\n+\n     for (const hunk of hunks) {\n       for (const patch of hunk.patches) {\n         // Accept both SplitDiff ('+', '-') and parse-diff ('add','del','normal') styles\n-        const t = patch.type;\n-        if (t === '+' || t === 'add') additions++;\n-        else if (t === '-' || t === 'del') deletions++;\n+        const t = patch.type\n+        if (t === \"+\" || t === \"add\") additions++\n+        else if (t === \"-\" || t === \"del\") deletions++\n       }\n     }\n-    \n-    return { additions, deletions };\n-  };\n+\n+    return {additions, deletions}\n+  }\n \n   // Calculate total diff stats\n   const totalStats = $derived(() =\u003e {\n-    let totalAdditions = 0;\n-    let totalDeletions = 0;\n-    \n+    let totalAdditions = 0\n+    let totalDeletions = 0\n+\n     for (const change of changes) {\n-      const stats = getFileStats(change.diffHunks);\n-      totalAdditions += stats.additions;\n-      totalDeletions += stats.deletions;\n+      const stats = getFileStats(change.diffHunks)\n+      totalAdditions += stats.additions\n+      totalDeletions += stats.deletions\n     }\n-    \n-    return { totalAdditions, totalDeletions };\n-  });\n+\n+    return {totalAdditions, totalDeletions}\n+  })\n \n   // Normalize hunks for SplitDiff to ensure patch.type is one of '+', '-', ' '\n   const normalizeHunks = (hunks: any[]) =\u003e {\n-    if (!Array.isArray(hunks)) return [];\n-    return hunks.map((h) =\u003e ({\n+    if (!Array.isArray(hunks)) return []\n+    return hunks.map(h =\u003e ({\n       oldStart: h.oldStart,\n       oldLines: h.oldLines,\n       newStart: h.newStart,\n       newLines: h.newLines,\n       patches: (h.patches || []).map((p: any) =\u003e ({\n         line: p.line,\n-        type: p.type === 'add' ? '+' : p.type === 'del' ? '-' : (p.type === ' ' || p.type === '+' || p.type === '-' ? p.type : ' '),\n+        type:\n+          p.type === \"add\"\n+            ? \"+\"\n+            : p.type === \"del\"\n+              ? \"-\"\n+              : p.type === \" \" || p.type === \"+\" || p.type === \"-\"\n+                ? p.type\n+                : \" \",\n       })),\n-    }));\n-  };\n+    }))\n+  }\n \n   // Expand all files by default if there are few changes\n   $effect(() =\u003e {\n     if (changes.length \u003c= 5) {\n-      expandedFiles = new Set(changes.map(change =\u003e change.path));\n+      expandedFiles = new Set(changes.map(change =\u003e change.path))\n     }\n-  });\n+  })\n+\n+  // Calculate expanded files count\n+  const expandedCount = $derived(expandedFiles.size)\n+  const allExpanded = $derived(expandedCount === changes.length \u0026\u0026 changes.length \u003e 0)\n+  const allCollapsed = $derived(expandedCount === 0)\n \u003c/script\u003e\n \n \u003csvelte:head\u003e\n   \u003ctitle\u003e{repoClass.name} - Commit {commitMeta.sha.slice(0, 7)}\u003c/title\u003e\n \u003c/svelte:head\u003e\n \n-\u003cdiv class=\"min-h-screen bg-background\"\u003e\n+\u003cdiv class=\"flex min-h-screen flex-col gap-4 bg-background\"\u003e\n   \u003c!-- Commit Header --\u003e\n   \u003cCommitHeader\n     sha={commitMeta.sha}\n@@ -133,45 +168,90 @@\n     email={commitMeta.email}\n     date={commitMeta.date}\n     message={commitMeta.message}\n-    parents={commitMeta.parents}\n-  /\u003e\n+    parents={commitMeta.parents} /\u003e\n \n   \u003c!-- Diff Summary --\u003e\n-  \u003cdiv class=\"border-b border-border bg-card px-6 py-4\"\u003e\n-    \u003cdiv class=\"flex items-center justify-between\"\u003e\n-      \u003cdiv class=\"flex items-center gap-4\"\u003e\n-        \u003ch2 class=\"text-lg font-semibold text-foreground\"\u003e\n-          {changes.length} {changes.length === 1 ? 'file' : 'files'} changed\n-        \u003c/h2\u003e\n-        \u003cdiv class=\"flex items-center gap-3 text-sm text-muted-foreground\"\u003e\n-          \u003cdiv class=\"rounded-lg border bg-muted/20 px-2 py-1 text-center\"\u003e\n-            \u003cspan class=\"text-green-600\"\u003e+{totalStats().totalAdditions}\u003c/span\u003e\n-          \u003c/div\u003e\n-          \u003cdiv class=\"rounded-lg border bg-muted/20 px-2 py-1 text-center\"\u003e\n-            \u003cspan class=\"text-red-600\"\u003e-{totalStats().totalDeletions}\u003c/span\u003e\n-          \u003c/div\u003e\n+  \u003cdiv\u003e\n+    \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n+      \u003ch3 class=\"flex items-center gap-2 text-lg font-medium\"\u003e\n+        \u003cFileCode class=\"h-5 w-5\" /\u003e\n+        Commit Details\n+      \u003c/h3\u003e\n+    \u003c/div\u003e\n+\n+    \u003c!-- Statistics Grid --\u003e\n+    \u003cdiv class=\"mb-4 grid grid-cols-1 gap-3 sm:grid-cols-3 sm:gap-4\"\u003e\n+      \u003cdiv class=\"rounded-lg border bg-muted/20 p-3 text-center\"\u003e\n+        \u003cdiv class=\"text-2xl font-bold text-primary\"\u003e{changes.length}\u003c/div\u003e\n+        \u003cdiv class=\"text-sm text-muted-foreground\"\u003e\n+          {changes.length === 1 ? \"file\" : \"files\"} changed\n+        \u003c/div\u003e\n+        \u003cdiv class=\"mt-1 text-xs text-muted-foreground\"\u003e\n+          {changes.length === 1 ? \"Single file\" : \"Multiple files\"}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+\n+      \u003cdiv class=\"rounded-lg border bg-green-50 p-3 text-center dark:bg-green-950/20\"\u003e\n+        \u003cdiv class=\"text-2xl font-bold text-green-600\"\u003e+{totalStats().totalAdditions}\u003c/div\u003e\n+        \u003cdiv class=\"text-sm text-muted-foreground\"\u003eLines Added\u003c/div\u003e\n+        \u003cdiv class=\"mt-1 text-xs text-muted-foreground\"\u003e\n+          {totalStats().totalAdditions === 0\n+            ? \"No additions\"\n+            : totalStats().totalAdditions \u003c 10\n+              ? \"Few additions\"\n+              : totalStats().totalAdditions \u003c 50\n+                ? \"Moderate additions\"\n+                : \"Many additions\"}\n         \u003c/div\u003e\n       \u003c/div\u003e\n-      \n-      \u003c!-- Expand/Collapse All --\u003e\n+\n+      \u003cdiv class=\"rounded-lg border bg-red-50 p-3 text-center dark:bg-red-950/20\"\u003e\n+        \u003cdiv class=\"text-2xl font-bold text-red-600\"\u003e-{totalStats().totalDeletions}\u003c/div\u003e\n+        \u003cdiv class=\"text-sm text-muted-foreground\"\u003eLines Removed\u003c/div\u003e\n+        \u003cdiv class=\"mt-1 text-xs text-muted-foreground\"\u003e\n+          {totalStats().totalDeletions === 0\n+            ? \"No deletions\"\n+            : totalStats().totalDeletions \u003c 10\n+              ? \"Few deletions\"\n+              : totalStats().totalDeletions \u003c 50\n+                ? \"Moderate deletions\"\n+                : \"Many deletions\"}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  \u003c/div\u003e\n+\n+  \u003cdiv\n+    class=\"z-10 sticky top-0 border-b border-border bg-card/95 px-4 py-3 shadow-sm backdrop-blur-sm sm:px-6 sm:py-4\"\u003e\n+    \u003cdiv class=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\"\u003e\n+      \u003c!-- Expand/Collapse Controls --\u003e\n       \u003cdiv class=\"flex items-center gap-2\"\u003e\n         \u003cbutton\n           onclick={() =\u003e {\n-            expandedFiles = new Set(changes.map(change =\u003e change.path));\n+            expandedFiles = new Set(changes.map(change =\u003e change.path))\n           }}\n-          class=\"text-sm text-muted-foreground transition-colors hover:text-foreground\"\n-        \u003e\n-          Expand all\n+          disabled={allExpanded}\n+          aria-label=\"Expand all files\"\n+          class=\"inline-flex touch-manipulation items-center gap-1.5 rounded-md border border-border bg-background px-3 py-1.5 text-sm font-medium text-foreground transition-all hover:border-border/80 hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 disabled:hover:bg-background\"\u003e\n+          \u003cChevronsDown class=\"h-4 w-4\" /\u003e\n+          \u003cspan\u003eExpand all\u003c/span\u003e\n         \u003c/button\u003e\n-        \u003cspan class=\"text-muted-foreground\"\u003e|\u003c/span\u003e\n         \u003cbutton\n           onclick={() =\u003e {\n-            expandedFiles = new Set();\n+            expandedFiles = new Set()\n           }}\n-          class=\"text-sm text-muted-foreground transition-colors hover:text-foreground\"\n-        \u003e\n-          Collapse all\n+          disabled={allCollapsed}\n+          aria-label=\"Collapse all files\"\n+          class=\"inline-flex touch-manipulation items-center gap-1.5 rounded-md border border-border bg-background px-3 py-1.5 text-sm font-medium text-foreground transition-all hover:border-border/80 hover:bg-muted focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 disabled:hover:bg-background\"\u003e\n+          \u003cChevronsUp class=\"h-4 w-4\" /\u003e\n+          \u003cspan\u003eCollapse all\u003c/span\u003e\n         \u003c/button\u003e\n+        {#if changes.length \u003e 0}\n+          \u003cspan class=\"ml-2 text-sm text-muted-foreground\"\u003e\n+            ({expandedCount} of {changes.length}\n+            {expandedCount === 1 ? \"file\" : \"files\"} expanded)\n+          \u003c/span\u003e\n+        {/if}\n       \u003c/div\u003e\n     \u003c/div\u003e\n   \u003c/div\u003e\n@@ -182,39 +262,45 @@\n       {@const isExpanded = expandedFiles.has(change.path)}\n       {@const statusInfo = getFileStatusIcon(change.status)}\n       {@const stats = getFileStats(change.diffHunks)}\n-      \n-      \u003cdiv class=\"bg-background\"\u003e\n+\n+      \u003cdiv class=\"w-full overflow-x-auto bg-background\"\u003e\n         \u003c!-- File Header --\u003e\n         \u003cbutton\n           onclick={() =\u003e toggleFile(change.path)}\n-          class=\"w-full px-6 py-4 text-left hover:bg-muted/50 transition-colors focus:outline-none focus:bg-muted/50\"\n-        \u003e\n-          \u003cdiv class=\"flex items-center justify-between gap-3\"\u003e\n-            \u003cdiv class=\"flex items-center gap-3 min-w-0 flex-1\"\u003e\n+          class=\"min-h-[44px] w-full touch-manipulation px-4 py-3 text-left transition-colors hover:bg-muted/50 focus:bg-muted/50 focus:outline-none sm:px-6 sm:py-4\"\u003e\n+          \u003cdiv\n+            class=\"flex min-w-fit flex-col gap-2 sm:flex-row sm:items-center sm:justify-between sm:gap-3\"\u003e\n+            \u003cdiv class=\"flex min-w-fit items-center gap-2 sm:gap-3\"\u003e\n               \u003c!-- Expand/Collapse Icon --\u003e\n               {#if isExpanded}\n-                \u003cChevronDown class=\"h-4 w-4 text-muted-foreground flex-shrink-0\" /\u003e\n+                \u003cChevronDown class=\"h-4 w-4 flex-shrink-0 text-muted-foreground\" /\u003e\n               {:else}\n-                \u003cChevronRight class=\"h-4 w-4 text-muted-foreground flex-shrink-0\" /\u003e\n+                \u003cChevronRight class=\"h-4 w-4 flex-shrink-0 text-muted-foreground\" /\u003e\n               {/if}\n-              \n+\n               \u003c!-- File Status Icon --\u003e\n               {#if statusInfo.icon}\n                 {@const IconComponent = statusInfo.icon}\n                 \u003cIconComponent class=\"h-4 w-4 {statusInfo.class} flex-shrink-0\" /\u003e\n               {/if}\n-              \n+\n               \u003c!-- File Path --\u003e\n-              \u003cspan class=\"font-mono text-sm text-foreground truncate\" title={change.path}\u003e{change.path}\u003c/span\u003e\n-              \n+              \u003cspan\n+                class=\"whitespace-nowrap font-mono text-xs text-foreground sm:text-sm\"\n+                title={change.path}\u003e{change.path}\u003c/span\u003e\n+\n               \u003c!-- Status Badge --\u003e\n-              \u003cspan class=\"rounded-full border px-2 py-0.5 text-xs font-medium whitespace-nowrap flex-shrink-0 {getStatusBadgeClass(change.status)}\"\u003e\n+              \u003cspan\n+                class=\"flex-shrink-0 whitespace-nowrap rounded-full border px-2 py-0.5 text-xs font-medium {getStatusBadgeClass(\n+                  change.status,\n+                )}\"\u003e\n                 {change.status}\n               \u003c/span\u003e\n             \u003c/div\u003e\n-            \n+\n             \u003c!-- File Stats --\u003e\n-            \u003cdiv class=\"flex items-center gap-2 text-sm text-muted-foreground whitespace-nowrap flex-shrink-0\"\u003e\n+            \u003cdiv\n+              class=\"ml-6 flex flex-shrink-0 items-center gap-2 whitespace-nowrap text-sm text-muted-foreground sm:ml-0\"\u003e\n               {#if stats.additions \u003e 0}\n                 \u003cspan class=\"text-green-600\"\u003e+{stats.additions}\u003c/span\u003e\n               {/if}\n@@ -227,7 +313,7 @@\n \n         \u003c!-- File Diff Content --\u003e\n         {#if isExpanded}\n-          \u003cdiv class=\"px-6 pb-6\"\u003e\n+          \u003cdiv class=\"px-4 pb-4 sm:px-6 sm:pb-6\"\u003e\n             \u003cSplitDiff hunks={normalizeHunks(change.diffHunks)} filepath={change.path} /\u003e\n           \u003c/div\u003e\n         {/if}\n@@ -237,7 +323,7 @@\n \n   \u003c!-- Empty State --\u003e\n   {#if changes.length === 0}\n-    \u003cdiv class=\"px-6 py-12 text-center\"\u003e\n+    \u003cdiv class=\"px-4 py-12 text-center sm:px-6\"\u003e\n       \u003cFileText class=\"mx-auto h-12 w-12 text-muted-foreground\" /\u003e\n       \u003ch3 class=\"mt-4 text-lg font-medium text-foreground\"\u003eNo file changes\u003c/h3\u003e\n       \u003cp class=\"mt-2 text-sm text-muted-foreground\"\u003e\n@@ -246,10 +332,3 @@\n     \u003c/div\u003e\n   {/if}\n \u003c/div\u003e\n-\n-\u003cstyle\u003e\n-  /* Ensure proper font rendering for code */\n-  .font-mono {\n-    font-family: ui-monospace, SFMono-Regular, \"SF Mono\", Consolas, \"Liberation Mono\", Menlo, monospace;\n-  }\n-\u003c/style\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 2f19106..7c17010 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -63,6 +63,7 @@\n   import {get} from \"svelte/store\"\n   import type {Readable} from \"svelte/store\"\n   import type {Repo} from \"@nostr-git/ui\"\n+    import Markdown from \"@src/lib/components/Markdown.svelte\"\n   \n   const repoClass = getContext\u003cRepo\u003e(REPO_KEY)\n   const repoRelaysStore = getContext\u003cReadable\u003cstring[]\u003e\u003e(REPO_RELAYS_KEY)\n@@ -925,7 +926,8 @@\n \n         \u003cdiv\n           class=\"prose-sm dark:prose-invert markdown-content prose mb-6 max-w-none text-muted-foreground\"\u003e\n-          {@html md.render(preprocessMarkdown(pr?.content || \"\"))}\n+          \u003c!-- {@html md.render(preprocessMarkdown(pr?.content || \"\"))} --\u003e\n+          \u003cMarkdown content={pr?.content || \"\"} /\u003e\n         \u003c/div\u003e\n \n         \u003cdiv class=\"space-y-4\"\u003e\n@@ -1003,7 +1005,8 @@\n \n         \u003cdiv\n           class=\"prose-sm dark:prose-invert markdown-content prose mb-6 max-w-none text-muted-foreground\"\u003e\n-          {@html md.render(preprocessMarkdown(patch?.description || \"\"))}\n+          \u003c!-- {@html md.render(preprocessMarkdown(patch?.description || \"\"))} --\u003e\n+          \u003cMarkdown content={patch?.description || \"\"} /\u003e\n         \u003c/div\u003e\n \n         \u003c!-- Technical Metadata --\u003e\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-v71tb2u2","title":"From f84fb4a429c1c321fef97f9451c71139c666f941 Mon Sep 17 00:00:00 2001","description":"From f84fb4a429c1c321fef97f9451c71139c666f941 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Tue, 18 Nov 2025 12:20:34 +0500\nSubject: [PATCH 2/13] feat: improve patch detail page markdown rendering and mobile responsiveness\n\n- Add markdown preprocessing utility to handle escaped newlines\n  - Create preprocessMarkdown() function in util.ts to convert literal \\n to actual newlines\n  - Enables proper rendering of markdown content with escaped line breaks\n\n- Enhance markdown styling in app.css\n  - Add .markdown-content styles for better code block handling\n  - Implement word-break and overflow-wrap for inline code\n  - Add proper overflow handling for pre blocks\n  - Ensure code blocks maintain proper whitespace\n\n- Improve patch detail page UI/UX\n  - Enable markdown breaks option for better line break rendering\n  - Add title truncation with ellipsis for long patch titles\n  - Replace @nostr-git/ui Profile component with local Profile component\n  - Apply prose classes for better markdown typography\n\n- Enhance mobile responsiveness\n  - Convert fixed layouts to responsive flex/grid layouts\n  - Add mobile-first breakpoints (sm:) throughout the page\n  - Improve navigation controls for mobile (hide text labels, show icons)\n  - Make commit hash and branch names break properly on small screens\n  - Adjust padding and spacing for mobile devices\n  - Improve stats display with responsive text sizes\n  - Better handling of long titles and metadata on mobile\n\n- Code quality improvements\n  - Remove unused Profile import from @nostr-git/ui\n  - Add proper title attributes for truncated text\n  - Improve code block display with break-all for long hashes\n  - Better spacing and layout consistency\n\n- Update nostr-git submodule to latest version\n---\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex a8eeeae..43bf1e9 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -16,7 +16,7 @@\n     User,\n     X,\n   } from \"@lucide/svelte\"\n-  import {Button, Profile, MergeStatus, toast, Status} from \"@nostr-git/ui\"\n+  import {Button, MergeStatus, toast, Status} from \"@nostr-git/ui\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import {IssueThread, MergeAnalyzer, PatchViewer} from \"@nostr-git/ui\"\n   import {pubkey, repository} from \"@welshman/app\"\n@@ -57,6 +57,7 @@\n   import {normalizeRelayUrl} from \"@welshman/util\"\n   import {profilesByPubkey, profileSearch, loadProfile} from \"@welshman/app\"\n   import {deriveRoleAssignments} from \"@lib/budabit\"\n+  import Profile from \"@src/app/components/Profile.svelte\"\n   import {preprocessMarkdown} from \"@lib/util\"\n \n   const {data}: LayoutProps = $props()\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-v9rfwxcg","title":"From ad33109095cbaf5fbfd341f90c39957e2fd034d2 Mon Sep 17 00:00:00 2001","description":"From ad33109095cbaf5fbfd341f90c39957e2fd034d2 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Wed, 4 Jun 2025 19:51:04 -0700\nSubject: [PATCH 4/4] feat: implement new issue form and improve patch status handling\n\n---\n .env                                                                    |   2 +-\n packages/nostr-git                                                      |   2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |  67 +++----------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte            |  14 ++++++++++++--\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte           |  39 +++++++++++++++++++++++++--------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 156 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------------------\n 6 files changed, 125 insertions(+), 155 deletions(-)\n\ndiff --git a/.env b/.env\nindex ddc932c..9fe5ff7 100644\n--- a/.env\n+++ b/.env\n@@ -5,7 +5,7 @@ VITE_PLATFORM_TERMS=\n VITE_PLATFORM_PRIVACY=\n VITE_PLATFORM_NAME=Budabit\n VITE_PLATFORM_LOGO=static/budabit.png\n-VITE_PLATFORM_RELAY=wss://budabit.nostr1.com\n+VITE_PLATFORM_RELAY=ws://192.168.1.149:7000\n VITE_PLATFORM_ACCENT=\"#D4AF37\"\n VITE_PLATFORM_SECONDARY=\"#EB5E28\"\n VITE_PLATFORM_DESCRIPTION=\"The Club for Builders in Freedom Tech.\"\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex bc609f5..06f8b78 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit bc609f563cbb0de023f5314f065737050cca3fd5\n+Subproject commit 06f8b78407f342e8c7007ae928e41d2f0de811da\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 1acffff..06b3626 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -3,17 +3,16 @@\n   import {page} from \"$app/stores\"\n   import {deriveNaddrEvent} from \"@app/state\"\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n-  import {FileCode, GitBranch, CircleAlert, GitPullRequest, Book} from \"@lucide/svelte\"\n+  import {FileCode, GitBranch, CircleAlert, GitPullRequest} from \"@lucide/svelte\"\n   import {parseRepoAnnouncementEvent, type RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n   import {setContext} from \"svelte\"\n   import {deriveEvents} from \"@welshman/store\"\n-  import {relays, repository} from \"@welshman/app\"\n+  import {repository} from \"@welshman/app\"\n   import {GIT_REPO_STATE} from \"@src/lib/util\"\n   import {derived as _derived} from \"svelte/store\"\n   import {Address, GIT_ISSUE, GIT_PATCH, type Filter} from \"@welshman/util\"\n   import {load} from \"@welshman/net\"\n   import {nthEq} from \"@welshman/lib\"\n-  import PageBar from \"@src/lib/components/PageBar.svelte\"\n   import {Buffer} from \"buffer\"\n \n   const {id, relay} = $page.params\n@@ -51,7 +50,7 @@\n   const patches = $derived.by(() =\u003e {\n     if ($eventStore) {\n       const address = Address.fromEvent($eventStore).toString()\n-      const patchFilter = [{kinds: [GIT_PATCH], \"#a\": [address]}]\n+      const patchFilter = [{kinds: [GIT_PATCH], \"#a\": [address], \"#t\": [\"root\"]}]\n       return deriveEvents(repository, {filters: patchFilter})\n     }\n   })\n@@ -87,57 +86,6 @@\n   })\n \u003c/script\u003e\n \n-\u003cPageBar\u003e\n-  \u003cRepoHeader event={$eventStore as RepoAnnouncementEvent} {activeTab}\u003e\n-    {#snippet children(activeTab: string)}\n-      \u003cRepoTab\n-        tabValue={id}\n-        label=\"Overview\"\n-        href={`/spaces/${encodeddRelay}/git/${id}`}\n-        {activeTab}\u003e\n-        {#snippet icon()}\n-          \u003cFileCode class=\"h-4 w-4\" /\u003e\n-        {/snippet}\n-      \u003c/RepoTab\u003e\n-      \u003cRepoTab\n-        tabValue=\"code\"\n-        label=\"Code\"\n-        href={`/spaces/${encodeddRelay}/git/${id}/code`}\n-        {activeTab}\u003e\n-        {#snippet icon()}\n-          \u003cGitBranch class=\"h-4 w-4\" /\u003e\n-        {/snippet}\n-      \u003c/RepoTab\u003e\n-      \u003cRepoTab\n-        tabValue=\"issues\"\n-        label=\"Issues\"\n-        href={`/spaces/${encodeddRelay}/git/${id}/issues`}\n-        {activeTab}\u003e\n-        {#snippet icon()}\n-          \u003cCircleAlert class=\"h-4 w-4\" /\u003e\n-        {/snippet}\n-      \u003c/RepoTab\u003e\n-      \u003cRepoTab\n-        tabValue=\"patches\"\n-        label=\"Patches\"\n-        href={`/spaces/${encodeddRelay}/git/${id}/patches`}\n-        {activeTab}\u003e\n-        {#snippet icon()}\n-          \u003cGitPullRequest class=\"h-4 w-4\" /\u003e\n-        {/snippet}\n-      \u003c/RepoTab\u003e\n-      \u003cRepoTab\n-        tabValue=\"wiki\"\n-        label=\"Wiki\"\n-        href={`/spaces/${encodeddRelay}/git/${id}/wiki`}\n-        {activeTab}\u003e\n-        {#snippet icon()}\n-          \u003cBook class=\"h-4 w-4\" /\u003e\n-        {/snippet}\n-      \u003c/RepoTab\u003e\n-    {/snippet}\n-  \u003c/RepoHeader\u003e\n-\u003c/PageBar\u003e\n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n   {#if $eventStore === undefined}\n     \u003cdiv class=\"p-4 text-center\"\u003eLoading repository...\u003c/div\u003e\n@@ -182,15 +130,6 @@\n             \u003cGitPullRequest class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab\n-          tabValue=\"wiki\"\n-          label=\"Wiki\"\n-          href={`/spaces/${encodeddRelay}/git/${id}/wiki`}\n-          {activeTab}\u003e\n-          {#snippet icon()}\n-            \u003cBook class=\"h-4 w-4\" /\u003e\n-          {/snippet}\n-        \u003c/RepoTab\u003e\n       {/snippet}\n     \u003c/RepoHeader\u003e\n     {@render children()}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex a638f33..d30eaa5 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -1,5 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {Button, IssueCard} from \"@nostr-git/ui\"\n+  import {Button, IssueCard, NewIssueForm} from \"@nostr-git/ui\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Address, COMMENT, GIT_ISSUE, type TrustedEvent} from \"@welshman/util\"\n   import {getContext} from \"svelte\"\n@@ -10,6 +10,7 @@\n   import type {Readable} from \"svelte/store\"\n   import {type RepoStateEvent} from \"@nostr-git/shared-types\"\n   import {fly} from \"@lib/transition\"\n+  import {pushModal} from \"@src/app/modal\"\n \n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n@@ -48,6 +49,15 @@\n       },\n     })\n   })\n+\n+  const onNewIssue = () =\u003e {\n+    pushModal(NewIssueForm, {\n+      selectedRepos: [],\n+      onClose: () =\u003e {},\n+    })\n+  }\n+\n+\n \u003c/script\u003e\n \n \u003cdiv bind:this={element}\u003e\n@@ -63,7 +73,7 @@\n         Filter\n       \u003c/Button\u003e\n \n-      \u003cButton size=\"sm\" class=\"gap-2 bg-git hover:bg-git-hover\"\u003e\n+      \u003cButton size=\"sm\" class=\"gap-2 bg-git hover:bg-git-hover\" onclick={onNewIssue}\u003e\n         \u003cPlus class=\"h-4 w-4\" /\u003e\n         New Issue\n       \u003c/Button\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 2c65bf6..fdc05e1 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -16,7 +16,8 @@\n     GIT_STATUS_CLOSED,\n     GIT_STATUS_DRAFT,\n   } from \"@welshman/util\"\n-    import { fly } from \"@lib/transition\"\n+  import {fly} from \"@lib/transition\"\n+  import {load} from \"@welshman/net\"\n \n   const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n@@ -27,21 +28,32 @@\n     patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n   }\u003e(\"repo\")\n \n-  const patches = $derived(repo.patches())\n+  const patches = $state(repo.patches())\n+\n+  const statuses = $derived.by(() =\u003e {\n+    if ($patches) {\n+      const filters = $patches.map(patch =\u003e {\n+        return {\n+          kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n+          \"#e\": [patch.id],\n+        }\n+      })\n+      const [tagId, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || []\n+      load({relays: relays, filters})\n+      return deriveEvents(repository, {filters})\n+    }\n+  })\n \n   const patchList = $derived.by(() =\u003e {\n     if ($patches) {\n       return $patches.map(patch =\u003e {\n-        const statuses = deriveEvents(repository, {\n-          filters: [\n-            {\n-              kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n-              \"#e\": [patch.id],\n-            },\n-          ],\n-        })\n         const profile = deriveProfile(patch.pubkey)\n-\n+        let status = $statuses?.filter(s =\u003e {\n+          let [tagId, eventId] = s.tags.find(nthEq(0, \"e\")) || []\n+          return eventId === patch.id\n+        }).sort(\n+          (a: TrustedEvent, b: TrustedEvent) =\u003e b.created_at - a.created_at,\n+        )[0]\n         return {\n           ...patch,\n           status,\n@@ -80,8 +92,7 @@\n \u003c/script\u003e\n \n \u003cdiv bind:this={element}\u003e\n-  \u003cdiv\n-    class=\"z-10 sticky top-0 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n+  \u003cdiv class=\"z-10 sticky top-0 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003ePatches\u003c/h2\u003e\n       \u003cp class=\"text-sm text-muted-foreground\"\u003eReview and merge code changes\u003c/p\u003e\n@@ -119,7 +130,7 @@\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n       {#each patchList! as patch}\n         \u003cdiv in:fly\u003e\n-          \u003cPatchCard event={patch} status={patch.status} owner={patch.profile} /\u003e\n+          \u003cPatchCard event={patch} status={patch.status} author={patch.profile} /\u003e\n         \u003c/div\u003e\n       {/each}\n     \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex e3c3b09..8a99209 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -1,12 +1,14 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n   import {GitCommit, MessageSquare, Check, X} from \"@lucide/svelte\"\n-  import { parseGitPatchFromEvent } from \"@nostr-git/core\"\n+  import {parseGitPatchFromEvent} from \"@nostr-git/core\"\n   import {type RepoStateEvent, type TrustedEvent} from \"@nostr-git/shared-types\"\n   import {Button} from \"@nostr-git/ui\"\n   import {Avatar, AvatarFallback, AvatarImage, DiffViewer, IssueThread} from \"@nostr-git/ui\"\n+  import {deriveProfile} from \"@welshman/app\"\n   import {getContext} from \"svelte\"\n   import type {Readable} from \"svelte/motion\"\n+  import markdownit from \"markdown-it\"\n \n   const repo = getContext\u003c{\n     repo: Readable\u003cTrustedEvent\u003e\n@@ -32,103 +34,111 @@\n       return []\n     }\n   })\n+\n+  const patchProfile = $derived.by(() =\u003e {\n+    if (patch) {\n+      return deriveProfile(patch.author.pubkey)\n+    }\n+  })\n+\n+  const md = markdownit({\n+    html: true,\n+    linkify: true,\n+    typographer: true,\n+  })\n+\n \u003c/script\u003e\n \n-\u003cdiv class=\"container max-w-6xl py-6\"\u003e\n-  \u003cdiv class=\"mt-6\"\u003e\n+{#if patch}\n+\u003cdiv class=\"z-10 sticky top-0 items-center justify-between py-4 backdrop-blur\"\u003e\n+  \u003cdiv\u003e\n     \u003cdiv class=\"rounded-lg border border-border bg-card p-6\"\u003e\n       \u003cdiv class=\"mb-4 flex items-start justify-between\"\u003e\n         \u003cdiv class=\"flex items-start gap-4\"\u003e\n           {#if patch?.status === \"open\"}\n             \u003cdiv class=\"mt-1\"\u003e\n-              \u003cdiv class=\"flex h-10 w-10 items-center justify-center rounded-full bg-amber-500/10\"\u003e\n-                \u003cGitCommit class=\"h-5 w-5 text-amber-500\" /\u003e\n+                \u003cdiv\n+                  class=\"flex h-10 w-10 items-center justify-center rounded-full bg-amber-500/10\"\u003e\n+                  \u003cGitCommit class=\"h-5 w-5 text-amber-500\" /\u003e\n+                \u003c/div\u003e\n               \u003c/div\u003e\n-            \u003c/div\u003e\n-          {:else if patch?.status === \"merged\"}\n-            \u003cdiv class=\"mt-1\"\u003e\n-              \u003cdiv class=\"flex h-10 w-10 items-center justify-center rounded-full bg-green-500/10\"\u003e\n-                \u003cCheck class=\"h-5 w-5 text-green-500\" /\u003e\n+            {:else if patch?.status === \"merged\"}\n+              \u003cdiv class=\"mt-1\"\u003e\n+                \u003cdiv\n+                  class=\"flex h-10 w-10 items-center justify-center rounded-full bg-green-500/10\"\u003e\n+                  \u003cCheck class=\"h-5 w-5 text-green-500\" /\u003e\n+                \u003c/div\u003e\n               \u003c/div\u003e\n-            \u003c/div\u003e\n-          {:else}\n-            \u003cdiv class=\"mt-1\"\u003e\n-              \u003cdiv class=\"flex h-10 w-10 items-center justify-center rounded-full bg-red-500/10\"\u003e\n-                \u003cX class=\"h-5 w-5 text-red-500\" /\u003e\n+            {:else}\n+              \u003cdiv class=\"mt-1\"\u003e\n+                \u003cdiv class=\"flex h-10 w-10 items-center justify-center rounded-full bg-red-500/10\"\u003e\n+                  \u003cX class=\"h-5 w-5 text-red-500\" /\u003e\n+                \u003c/div\u003e\n               \u003c/div\u003e\n-            \u003c/div\u003e\n-          {/if}\n-\n-          \u003cdiv\u003e\n-            \u003ch1 class=\"text-2xl font-bold\"\u003e{patch?.title}\u003c/h1\u003e\n+            {/if}\n \n-            \u003cdiv class=\"mt-1 flex items-center gap-2\"\u003e\n-              \u003cdiv class=\"git-tag bg-secondary\"\u003e\n-                {patch?.status === \"open\" ? \"Open\" : patch?.status === \"merged\" ? \"Merged\" : \"Closed\"}\n+            \u003cdiv\u003e\n+              \u003ch1 class=\"text-2xl font-bold\"\u003e{patch?.title}\u003c/h1\u003e\n+\n+              \u003cdiv class=\"mt-1 flex items-center gap-2\"\u003e\n+                \u003cdiv class=\"git-tag bg-secondary\"\u003e\n+                  {patch?.status === \"open\"\n+                    ? \"Open\"\n+                    : patch?.status === \"merged\"\n+                      ? \"Merged\"\n+                      : \"Closed\"}\n+                \u003c/div\u003e\n+                \u003cspan class=\"text-sm text-muted-foreground\"\u003e\n+                  {patch?.author.name} opened this patch • {new Date(\n+                    patch?.createdAt,\n+                  ).toLocaleString()}\n+                \u003c/span\u003e\n               \u003c/div\u003e\n-              \u003cspan class=\"text-sm text-muted-foreground\"\u003e\n-                {patch?.author.name} opened this patch • {new Date(patch?.createdAt).toLocaleString()}\n-              \u003c/span\u003e\n-            \u003c/div\u003e\n \n-            \u003cp class=\"mt-4 text-muted-foreground\"\u003e{patch?.description}\u003c/p\u003e\n+              \u003cp class=\"mt-4 text-muted-foreground\"\u003e{@html md.render(patch?.description || \"\")}\u003c/p\u003e\n+            \u003c/div\u003e\n           \u003c/div\u003e\n-        \u003c/div\u003e\n \n-        \u003cAvatar class=\"h-10 w-10\"\u003e\n-          \u003cAvatarImage src={patch?.author.picture} alt={patch?.author.name} /\u003e\n-          \u003cAvatarFallback\u003e{patch?.author.name.substring(0, 2).toUpperCase()}\u003c/AvatarFallback\u003e\n-        \u003c/Avatar\u003e\n-      \u003c/div\u003e\n+          \u003cAvatar class=\"h-10 w-10\"\u003e\n+            \u003cAvatarImage src={$patchProfile?.picture} alt={$patchProfile?.name} /\u003e\n+            \u003cAvatarFallback\u003e{$patchProfile?.name?.substring(0, 2).toUpperCase()}\u003c/AvatarFallback\u003e\n+          \u003c/Avatar\u003e\n+        \u003c/div\u003e\n \n-      \u003cdiv class=\"git-separator\"\u003e\u003c/div\u003e\n+        \u003cdiv class=\"git-separator\"\u003e\u003c/div\u003e\n \n-      \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n-        \u003ch2 class=\"text-lg font-medium\"\u003e{patch?.commitCount} Commits\u003c/h2\u003e\n+        \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n+          \u003ch2 class=\"text-lg font-medium\"\u003e{patch?.commitCount} Commits\u003c/h2\u003e\n \n-        \u003cdiv class=\"flex items-center gap-2\"\u003e\n-          \u003cButton variant=\"outline\" size=\"sm\"\u003eView on GitHub\u003c/Button\u003e\n+          \u003cdiv class=\"flex items-center gap-2\"\u003e\n+            \u003cButton variant=\"outline\" size=\"sm\"\u003eView on GitHub\u003c/Button\u003e\n \n-          {#if patch?.status === \"open\"}\n-            \u003cButton variant=\"default\" size=\"sm\" class=\"bg-git hover:bg-git-hover\"\u003e\n-              Merge Patch\n-            \u003c/Button\u003e\n-          {/if}\n+            {#if patch?.status === \"open\"}\n+              \u003cButton variant=\"default\" size=\"sm\" class=\"bg-git hover:bg-git-hover\"\u003e\n+                Merge Patch\n+              \u003c/Button\u003e\n+            {/if}\n+          \u003c/div\u003e\n         \u003c/div\u003e\n-      \u003c/div\u003e\n \n-      \u003cdiv class=\"mb-6 space-y-3\"\u003e\n-        {#each patch?.diff as commit (commit.id)}\n-          \u003cdiv class=\"flex items-start gap-3 rounded-md border border-border p-3\"\u003e\n-            \u003cGitCommit class=\"mt-1 h-5 w-5 text-muted-foreground\" /\u003e\n-            \u003cdiv\u003e\n-              \u003cp class=\"font-medium\"\u003e{commit.message}\u003c/p\u003e\n-              \u003cdiv class=\"mt-1 flex items-center gap-2 text-sm text-muted-foreground\"\u003e\n-                \u003cspan\u003e{commit.author}\u003c/span\u003e\n-                \u003cspan\u003e•\u003c/span\u003e\n-                \u003cspan\u003e{new Date(commit.date).toLocaleString()}\u003c/span\u003e\n-                \u003cspan\u003e•\u003c/span\u003e\n-                \u003ccode class=\"rounded bg-secondary/50 px-1.5 py-0.5 text-xs\"\n-                  \u003e{commit.id.substring(0, 7)}\u003c/code\u003e\n-              \u003c/div\u003e\n-            \u003c/div\u003e\n-          \u003c/div\u003e\n-        {/each}\n-      \u003c/div\u003e\n+        \u003cdiv class=\"mb-6 space-y-3\"\u003e\u003c/div\u003e\n \n-      \u003ch2 class=\"mb-4 text-lg font-medium\"\u003eChanges\u003c/h2\u003e\n-      \u003cDiffViewer diff={patch?.raw.diff} /\u003e\n+        \u003ch2 class=\"mb-4 text-lg font-medium\"\u003eChanges\u003c/h2\u003e\n+        {#if patch?.diff}\n+          \u003cDiffViewer diff={patch.diff} /\u003e\n+        {/if}\n \n-      \u003cdiv class=\"git-separator my-6\"\u003e\u003c/div\u003e\n+        \u003cdiv class=\"git-separator my-6\"\u003e\u003c/div\u003e\n \n-      \u003cdiv class=\"space-y-4\"\u003e\n-        \u003ch2 class=\"flex items-center gap-2 text-lg font-medium\"\u003e\n-          \u003cMessageSquare class=\"h-5 w-5\" /\u003e\n-          Discussion ({threadComments?.length})\n-        \u003c/h2\u003e\n+        \u003cdiv class=\"space-y-4\"\u003e\n+          \u003ch2 class=\"flex items-center gap-2 text-lg font-medium\"\u003e\n+            \u003cMessageSquare class=\"h-5 w-5\" /\u003e\n+            Discussion ({threadComments?.length})\n+          \u003c/h2\u003e\n \n-        \u003cIssueThread issueId={patch?.id} comments={threadComments} /\u003e\n+          \u003cIssueThread issueId={patch?.id} comments={threadComments} /\u003e\n+        \u003c/div\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n   \u003c/div\u003e\n-\u003c/div\u003e\n+{/if}\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-validation-acceptance-tests","title":"Define acceptance tests for Smart Widget support","description":"Define acceptance criteria and test cases for widget discovery, loading, rendering, and state persistence.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T00:21:39.733124-08:00"}
{"id":"flotilla-validation-interoperability","title":"Validate interoperability with non-Budabit clients","description":"Validate that Smart Widgets produced for Budabit can be rendered by other Smart Widget hosts without changes.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-16T00:21:39.733124-08:00","updated_at":"2026-01-16T00:21:39.733124-08:00"}
{"id":"flotilla-vd3y3x2w","title":"From cd49764a3f206cc538838758328a13914a8c82d3 Mon Sep 17 00:00:00 2001","description":"From cd49764a3f206cc538838758328a13914a8c82d3 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Fri, 15 Aug 2025 17:27:56 -0700\nSubject: [PATCH 2/2] refactor: remove redundant repo initialization in commit details page\n\n---\n packages/nostr-git                                                   |  2 +-\n src/app/components/GitActions.svelte                                 |  4 ++--\n src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts | 28 ++--------------------------\n 3 files changed, 5 insertions(+), 29 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 5ad9e1e..4bead42 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 5ad9e1eed43e27bc1ca8779818226daf44aaf166\n+Subproject commit 4bead42ae524a98b81918c725ee70f32223c6a53\ndiff --git a/src/app/components/GitActions.svelte b/src/app/components/GitActions.svelte\nindex 7d2c5d5..5c6f632 100644\n--- a/src/app/components/GitActions.svelte\n+++ b/src/app/components/GitActions.svelte\n@@ -15,7 +15,7 @@\n   import {goto} from \"$app/navigation\"\n   import { nip19 } from \"nostr-tools\"\n   import type { AddressPointer } from \"nostr-tools/nip19\"\n-  import { canonicalRepoKey } from \"@nostr-git/core\"\n+  import { canonicalRepoKey, sanitizeRelays } from \"@nostr-git/core\"\n   import { pushToast } from \"@app/toast\"\n \n   interface Props {\n@@ -29,7 +29,7 @@\n \n   let loadingIssues = $state(true)\n \n-  const [tagId, ...relays] = event.tags.find(nthEq(0, \"relays\")) || []\n+  const [tagId, ...relays] = sanitizeRelays(event.tags.find(nthEq(0, \"relays\")) || [])\n \n   const issueFilter = {\n     kinds: [GIT_ISSUE],\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\nindex f6ba348..2ceb0ec 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\n@@ -47,32 +47,8 @@ export const load: PageLoad = async ({ params, parent }) =\u003e {\n     // Get git worker instance\n     const gitWorker = getGitWorker();\n     \n-    // Ensure repository is properly initialized and cloned\n-    console.log('Initializing repository:', repoClass.repoId, 'with branch:', repoClass.mainBranch);\n-    \n-    try {\n-      // First ensure the repository is initialized\n-      await gitWorker.api.smartInitializeRepo({\n-        repoId: repoClass.canonicalKey,\n-        branch: repoClass.mainBranch\n-      });\n-      \n-      // Then ensure we have full clone with sufficient depth\n-      await gitWorker.api.ensureFullClone({\n-        repoId: repoClass.canonicalKey,\n-        branch: repoClass.mainBranch,\n-        depth: 100\n-      });\n-    } catch (initError) {\n-      console.error('Repository initialization failed:', initError);\n-      const errorMessage = initError instanceof Error ? initError.message : String(initError);\n-      pushToast({\n-        message: `Failed to initialize repository: ${errorMessage}`,\n-        theme: 'error',\n-        timeout: 5000\n-      });\n-      return;\n-    }\n+    // Initialization is handled by Repo class constructor (#loadCommitsFromRepo)\n+    // Avoid re-initializing here to prevent duplicate worker operations/logs\n     \n     // Get detailed commit information including file changes\n     const commitDetails = await gitWorker.api.getCommitDetails({\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-vdr2xgpl","title":"From 9aa7d5d8913509b740551d5d8bb46cbe92c565d8 Mon Sep 17 00:00:00 2001","description":"From 9aa7d5d8913509b740551d5d8bb46cbe92c565d8 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sat, 22 Nov 2025 02:13:56 +0500\nSubject: [PATCH 4/4] feat: Improve markdown rendering and update submodule\n\n---\n packages/nostr-git                                                      |   2 +-\n pnpm-lock.yaml                                                          | Bin 549183 -\u003e 549005 bytes\n src/app/components/ChannelMessage.svelte                                |   4 ++--\n src/lib/components/Markdown.svelte                                      | 336 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++----------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |   4 +++-\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte |   2 +-\n 6 files changed, 273 insertions(+), 75 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 2614623..13ba161 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 261462365b388cb074313c26d7e7a53944c092c8\n+Subproject commit 13ba16132fc286a3cda9564f417324c0719c393b\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 175a157b1649942dc3ae1b425a444fc901d04f35..a5d41816cf5e897efa8d5b7a387c92073068ac4b 100644\nGIT binary patch\ndelta 81\nzc%0jRNU`^z;)de#$@lFvrYl%;NKe+cS7\u003ch^Xg9531Y#y2W(HywAZ7((w(X`B\u003e?wyp\nbs\u003c#7G*KtgLwSvuc`hRB*_U-qaITB?7\u003ccl5p\n\ndelta 260\nzc%17!sJQ=-;)de#=^abi1f2{tHOeweQXNe7O!SNlG#pAQ3sQ^q^YT+t9gIx$EcAf#\nzC8\u003cTlsYM_aCO|GkeQ}9{v7V8h36MMe-!?Y6$sg^+nrD}{\u0026n{;KVkRJF24WT\u003cW(8ul\nz?X%0-=O3cFjgx1WOHYrp=a8A6x0Q{3`vNNt2af6ewj8XC29r0cs80SDBs%@PEl2tE\nU=f)iR(=+Tia\u003c\u003c#KaQMpr0BhS=SO5S3\n\ndiff --git a/src/app/components/ChannelMessage.svelte b/src/app/components/ChannelMessage.svelte\nindex 9a53d3b..dfcc641 100644\n--- a/src/app/components/ChannelMessage.svelte\n+++ b/src/app/components/ChannelMessage.svelte\n@@ -8,7 +8,7 @@\n   import Reply from \"@assets/icons/reply-2.svg?dataurl\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n-  import Content from \"@lib/budabit/components/Content.svelte\"\n+  import Markdown from \"@lib/components/Markdown.svelte\"\n   import ThunkFailure from \"@app/components/ThunkFailure.svelte\"\n   import ProfileDetail from \"@app/components/ProfileDetail.svelte\"\n   import ReactionSummary from \"@app/components/ReactionSummary.svelte\"\n@@ -79,7 +79,7 @@\n         \u003c/div\u003e\n       {/if}\n       \u003cdiv class=\"text-sm\"\u003e\n-        \u003cContent minimalQuote {event} {url} /\u003e\n+        \u003cMarkdown content={event.content} {event} {url} /\u003e\n         {#if thunk}\n           \u003cThunkFailure showToastOnRetry {thunk} class=\"mt-2\" /\u003e\n         {/if}\ndiff --git a/src/lib/components/Markdown.svelte b/src/lib/components/Markdown.svelte\nindex cd9ec6d..be66649 100644\n--- a/src/lib/components/Markdown.svelte\n+++ b/src/lib/components/Markdown.svelte\n@@ -116,7 +116,7 @@\n   }\n \n   .markdown :global(img) {\n-    @apply my-4 h-auto max-w-full;\n+    @apply my-4 h-auto max-w-full rounded-lg;\n   }\n \n   /* Profile mentions - ensure proper vertical alignment */\n@@ -126,7 +126,7 @@\n \u003c/style\u003e\n \n \u003cscript lang=\"ts\"\u003e\n-  import {marked, type Token, type Tokens, type TokenizerAndRendererExtension} from \"marked\"\n+  import {Marked, type Token, type Tokens, type TokenizerAndRendererExtension} from \"marked\"\n   import DOMPurify from \"dompurify\"\n   import {nip19, nip05} from \"nostr-tools\"\n   import hljs from \"highlight.js\"\n@@ -137,13 +137,29 @@\n   import {normalizeRelayUrl} from \"@welshman/util\"\n   import Profile from \"@app/components/Profile.svelte\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n+  import ContentLinkBlock from \"@app/components/ContentLinkBlock.svelte\"\n+  import ContentQuote from \"@app/components/ContentQuote.svelte\"\n+  import type {TrustedEvent} from \"@welshman/util\"\n \n   interface Props {\n     content?: string\n     relays?: string[]\n-  }\n-\n-  let {content = \"\", relays}: Props = $props()\n+    event?: TrustedEvent\n+    url?: string\n+    minimalQuote?: boolean\n+    hideMediaAtDepth?: number\n+    depth?: number\n+  }\n+\n+  let {\n+    content = \"\",\n+    relays,\n+    event,\n+    url,\n+    minimalQuote = false,\n+    hideMediaAtDepth = 1,\n+    depth = 0,\n+  }: Props = $props()\n \n   let sanitizedContent = $state(\"\")\n   let containerElement: HTMLDivElement | undefined = $state()\n@@ -163,7 +179,6 @@\n \n   // Helper function to shorten URLs\n   function shortenUrl(url: string, text?: string): string {\n-    // If custom text is provided and it's not the same as URL, use it\n     if (text \u0026\u0026 text !== url) {\n       return text\n     }\n@@ -176,7 +191,6 @@\n       if (pathname \u0026\u0026 pathname !== \"/\") {\n         const pathParts = pathname.split(\"/\").filter(Boolean)\n         if (pathParts.length \u003e 0) {\n-          // Show first part of path, truncate if too long\n           const firstPath = pathParts[0]\n           if (firstPath.length \u003e 20) {\n             return `${domain}/${firstPath.substring(0, 15)}...`\n@@ -186,7 +200,6 @@\n       }\n       return domain\n     } catch (e) {\n-      // Fallback for invalid URLs\n       return url.length \u003e 40 ? `${url.substring(0, 20)}...${url.substring(url.length - 15)}` : url\n     }\n   }\n@@ -194,7 +207,6 @@\n   // Helper function to shorten Nostr URIs\n   function shortenNostrUri(tagType: string, content: string): string {\n     const fullUri = `${tagType}${content}`\n-    // Show first 8 and last 8 characters\n     return `${fullUri.slice(0, 8)}:${fullUri.slice(-8)}`\n   }\n \n@@ -216,7 +228,6 @@\n   // Get profile for a pubkey\n   const getPub = async (token: Token) =\u003e {\n     if (token.type === \"nostr\") {\n-      console.log(\"[markdown walkTokens getPub]\", token)\n       const fullId = token.fullId\n       if (!fullId) return\n \n@@ -224,9 +235,6 @@\n         const result: any = nip19.decode(fullId)\n         let pubkey: string | undefined\n \n-        console.log(\"[markdown walkTokens getPub result]\", result, pubkey)\n-\n-        // Narrow types properly\n         if (result.type === \"nprofile\") {\n           pubkey = result.data.pubkey\n         } else if (result.type === \"npub\") {\n@@ -244,8 +252,6 @@\n           profile = $profilesByPubkey.get(pubkey)\n         }\n \n-        console.log(\"[markdown walkTokens getPub profile]\", profile)\n-\n         if (profile) {\n           token.userName = profile.name || profile.display_name || null\n         }\n@@ -296,8 +302,6 @@\n       const match = nostrRegex.exec(src)\n       if (match) {\n         const [fullMatch, prefix, fullId] = match\n-        console.log(\"[markdown tokenizer match]\", match)\n-        // fullId is the complete npub1..., note1..., etc.\n         return {\n           type: \"nostr\",\n           raw: fullMatch,\n@@ -316,47 +320,69 @@\n \n       try {\n         const decoded = nip19.decode(fullId)\n+        const decodedType = decoded.type as string\n \n-        if (decoded.type === \"nevent\" || decoded.type === \"note\") {\n-          url = `https://coracle.social/notes/${fullId}`\n-          external = true\n-        } else if (decoded.type === \"nprofile\") {\n-          external = true\n-          url = `https://coracle.social/people/${fullId}`\n+        // For note, nevent and naddr, use ContentQuote if event is provided\n+        if (event \u0026\u0026 decodedType === \"note\") {\n+          const noteId = decoded.data as unknown as string\n+          if (noteId) {\n+            return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"note\" data-id=\"${noteId}\" data-relays=\"[]\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n+          }\n+        }\n \n-          // For npub and nprofile, create a placeholder that we'll replace with a Svelte component\n-          if (pubkey) {\n-            return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+        if (event \u0026\u0026 decodedType === \"nevent\") {\n+          const eventData = decoded.data as any\n+          const eventId = eventData?.id\n+          if (eventId) {\n+            const relaysAttr = JSON.stringify(eventData.relays || [])\n+            return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"nevent\" data-id=\"${eventId}\" data-relays=\"${relaysAttr.replace(/\"/g, \"\u0026quot;\")}\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n           }\n-        } else if (decoded.type === \"npub\") {\n-          url = `/people/${fullId}`\n+        }\n \n-          // For npub and nprofile, create a placeholder that we'll replace with a Svelte component\n-          if (pubkey) {\n-            return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+        if (event \u0026\u0026 decodedType === \"naddr\") {\n+          const addrData = decoded.data as any\n+          if (addrData?.kind \u0026\u0026 addrData?.pubkey \u0026\u0026 addrData?.identifier !== undefined) {\n+            const relaysAttr = JSON.stringify(addrData.relays || [])\n+            return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"naddr\" data-kind=\"${addrData.kind}\" data-pubkey=\"${addrData.pubkey}\" data-identifier=\"${addrData.identifier}\" data-relays=\"${relaysAttr.replace(/\"/g, \"\u0026quot;\")}\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n           }\n-        } else if (decoded.type === \"naddr\") {\n-          const data = decoded.data\n-          // For git repos, use internal routing\n-          if (data.kind === 30617) {\n-            url = `/${fullId}`\n-          } else {\n+        }\n+\n+        // Handle other Nostr entity types\n+        switch (decodedType) {\n+          case \"note\":\n+            url = `https://coracle.social/notes/${fullId}`\n+            external = true\n+            break\n+          case \"nevent\":\n+            url = `https://coracle.social/notes/${fullId}`\n+            external = true\n+            break\n+          case \"nprofile\":\n+            external = true\n+            url = `https://coracle.social/people/${fullId}`\n+            if (pubkey) {\n+              return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+            }\n+            break\n+          case \"npub\":\n+            url = `/people/${fullId}`\n+            if (pubkey) {\n+              return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+            }\n+            break\n+          case \"naddr\":\n             external = true\n             url = `https://coracle.social/${fullId}`\n-          }\n+            break\n         }\n       } catch (err) {\n         console.error(\"Failed to decode in renderer:\", err, fullId)\n-        // If decoding fails, use default URL\n         url = `/${fullId}`\n       }\n \n-      // For other types, render as simple link\n       const linkText = userName ? `@${userName}` : shortenNostrUri(\"\", fullId)\n       const externalAttributes = external ? 'target=\"_blank\" rel=\"noopener noreferrer\"' : \"\"\n-      return `\u003ca href=\"${url}\" ${externalAttributes} \n-                    class=\"link\" title=\"${fullId}\"\u003e${linkText}\n-                    \u003c/a\u003e`\n+      return `\u003ca href=\"${url}\" ${externalAttributes} class=\"link\" title=\"${fullId}\"\u003e${linkText}\u003c/a\u003e`\n     },\n   }\n \n@@ -384,7 +410,6 @@\n     },\n     renderer(token: Tokens.Generic) {\n       if (token.isNip05) {\n-        // Render as Nostr link - create placeholder for Svelte component\n         const {pubkey} = token\n         if (pubkey) {\n           return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n@@ -396,14 +421,17 @@\n     },\n   }\n \n-  marked.use({\n+  // Create a new marked instance for this component\n+  const markedInstance = new Marked({\n     extensions: [nostrTokenizer, emailTokenizer],\n     async: true,\n     breaks: true,\n     walkTokens: getPub,\n     renderer: {\n-      image() {\n-        return \"\"\n+      image(token) {\n+        const {href, title, text} = token\n+        const alt = text || title || \"\"\n+        return `\u003cimg src=\"${href}\" alt=\"${alt}\" class=\"my-4 h-auto max-w-full rounded-lg\" /\u003e`\n       },\n       link(token) {\n         const {href, text} = token\n@@ -418,7 +446,6 @@\n           try {\n             const result: any = nip19.decode(fullId)\n \n-            // For npub and nprofile, create placeholder for Profile component\n             if (result.type === \"nprofile\" || result.type === \"npub\") {\n               let pubkey = \"\"\n               if (result.type === \"nprofile\") {\n@@ -432,32 +459,69 @@\n               }\n             }\n \n-            // For other nostr types, create regular links\n-            let url = `/${fullId}`\n+            // For note, nevent and naddr, use ContentQuote if event is provided\n+            if (\n+              event \u0026\u0026\n+              (result.type === \"note\" || result.type === \"nevent\" || result.type === \"naddr\")\n+            ) {\n+              if (result.type === \"note\") {\n+                const noteId = result.data as string\n+                if (noteId) {\n+                  return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"note\" data-id=\"${noteId}\" data-relays=\"[]\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n+                }\n+              } else if (result.type === \"nevent\") {\n+                const eventData = result.data as any\n+                const eventId = eventData?.id\n+                if (eventId) {\n+                  const relaysAttr = JSON.stringify(eventData.relays || [])\n+                  return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"nevent\" data-id=\"${eventId}\" data-relays=\"${relaysAttr.replace(/\"/g, \"\u0026quot;\")}\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n+                }\n+              } else if (result.type === \"naddr\") {\n+                const addrData = result.data as any\n+                if (addrData?.kind \u0026\u0026 addrData?.pubkey \u0026\u0026 addrData?.identifier !== undefined) {\n+                  const relaysAttr = JSON.stringify(addrData.relays || [])\n+                  return `\u003cspan class=\"markdown-quote-placeholder\" data-type=\"naddr\" data-kind=\"${addrData.kind}\" data-pubkey=\"${addrData.pubkey}\" data-identifier=\"${addrData.identifier}\" data-relays=\"${relaysAttr.replace(/\"/g, \"\u0026quot;\")}\" data-event-id=\"${event.id}\" data-url=\"${url || \"\"}\" data-minimal=\"${minimalQuote}\" data-depth=\"${depth}\" data-hide-media=\"${hideMediaAtDepth}\"\u003e\u003c/span\u003e`\n+                }\n+              }\n+            }\n+\n+            // Fallback to regular link if no event or not nevent/naddr\n+            let linkUrl = `/${fullId}`\n             let external = false\n \n             if (result.type === \"nevent\" || result.type === \"note\") {\n-              url = `https://coracle.social/notes/${fullId}`\n+              linkUrl = `https://coracle.social/notes/${fullId}`\n               external = true\n             } else if (result.type === \"naddr\") {\n-              const data = result.data\n+              const data = result.data as any\n               if (data.kind === 30617) {\n-                url = `/${fullId}`\n+                linkUrl = `/${fullId}`\n               } else {\n                 external = true\n-                url = `https://coracle.social/${fullId}`\n+                linkUrl = `https://coracle.social/${fullId}`\n               }\n             }\n \n             const externalAttributes = external ? 'target=\"_blank\" rel=\"noopener noreferrer\"' : \"\"\n             const linkText = text || fullId\n-            return `\u003ca href=\"${url}\" ${externalAttributes} class=\"link\" title=\"${fullId}\"\u003e${linkText}\u003c/a\u003e`\n+            return `\u003ca href=\"${linkUrl}\" ${externalAttributes} class=\"link\" title=\"${fullId}\"\u003e${linkText}\u003c/a\u003e`\n           } catch (err) {\n             console.error(\"Failed to decode nostr link:\", err, fullId)\n           }\n         }\n \n         // Regular URL handling\n+        // Check if this should be rendered as a block (media or standalone URL)\n+        const isMediaUrl = /\\.(jpe?g|png|gif|webp|svg|bmp|ico|mov|webm|mp4)(\\?.*)?$/i.test(href)\n+        // Standalone URL: when link text is the same as URL, or very similar (user just pasted URL)\n+        const isStandaloneUrl = !text || text === href || text.trim() === href.trim()\n+\n+        // Use ContentLinkBlock for media URLs or standalone URLs (when event is provided)\n+        if (event \u0026\u0026 (isMediaUrl || isStandaloneUrl)) {\n+          return `\u003cspan class=\"markdown-link-block-placeholder\" data-url=\"${href}\" data-event-id=\"${event.id}\"\u003e\u003c/span\u003e`\n+        }\n+\n+        // For inline links, render as regular link\n         const displayText = shortenUrl(href, text)\n         return `\u003ca href=\"${href}\" class=\"link\" title=\"${href}\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e${displayText}\u003c/a\u003e`\n       },\n@@ -481,9 +545,7 @@\n           language: validLang,\n         }).value\n \n-        return `\n-                    \u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-${validLang}\"\u003e${highlightedCode}\u003c/code\u003e\u003c/pre\u003e\n-                `\n+        return `\u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-${validLang}\"\u003e${highlightedCode}\u003c/code\u003e\u003c/pre\u003e`\n       },\n     },\n   })\n@@ -491,9 +553,23 @@\n   $effect(() =\u003e {\n     if (content) {\n       ;(async () =\u003e {\n-        const parsed = await marked(content)\n+        const parsed = await markedInstance.parse(content)\n         sanitizedContent = DOMPurify.sanitize(parsed, {\n-          ADD_ATTR: [\"target\", \"title\", \"data-pubkey\", \"data-url\"],\n+          ADD_ATTR: [\n+            \"target\",\n+            \"title\",\n+            \"data-pubkey\",\n+            \"data-url\",\n+            \"data-event-id\",\n+            \"data-type\",\n+            \"data-id\",\n+            \"data-relays\",\n+            \"data-kind\",\n+            \"data-identifier\",\n+            \"data-minimal\",\n+            \"data-depth\",\n+            \"data-hide-media\",\n+          ],\n           ADD_TAGS: [\"span\"],\n         })\n       })()\n@@ -519,45 +595,41 @@\n       setTimeout(() =\u003e {\n         if (!containerElement) return\n \n-        const placeholders = containerElement.querySelectorAll(\".nostr-profile-placeholder\")\n-        placeholders.forEach(placeholder =\u003e {\n+        // Mount profile placeholders\n+        const profilePlaceholders = containerElement.querySelectorAll(\".nostr-profile-placeholder\")\n+        profilePlaceholders.forEach(placeholder =\u003e {\n           const pubkey = placeholder.getAttribute(\"data-pubkey\")\n-          const url = placeholder.getAttribute(\"data-url\")\n+          const profileUrl = placeholder.getAttribute(\"data-url\")\n \n           if (pubkey) {\n             try {\n-              // Create a wrapper div to hold both components\n               const wrapper = document.createElement(\"div\")\n               wrapper.className = \"inline-flex items-center gap-1 align-middle\"\n               wrapper.style.verticalAlign = \"middle\"\n \n-              // Create containers for each component\n               const avatarContainer = document.createElement(\"span\")\n               const linkContainer = document.createElement(\"span\")\n \n               wrapper.appendChild(avatarContainer)\n               wrapper.appendChild(linkContainer)\n \n-              // Replace placeholder with wrapper\n               placeholder.replaceWith(wrapper)\n \n-              // Mount Profile component (avatar only, hideDetails=true)\n               const profileComponent = mount(Profile, {\n                 target: avatarContainer,\n                 props: {\n                   pubkey,\n-                  url: url || undefined,\n+                  url: profileUrl || undefined,\n                   avatarSize: 6,\n                   hideDetails: true,\n                 },\n               })\n \n-              // Mount ProfileLink component (name only)\n               const linkComponent = mount(ProfileLink, {\n                 target: linkContainer,\n                 props: {\n                   pubkey,\n-                  url: url || undefined,\n+                  url: profileUrl || undefined,\n                 },\n               })\n \n@@ -570,6 +642,130 @@\n             }\n           }\n         })\n+\n+        // Mount ContentLinkBlock for media/standalone links\n+        if (event) {\n+          const linkBlockPlaceholders = containerElement.querySelectorAll(\n+            \".markdown-link-block-placeholder\",\n+          )\n+          linkBlockPlaceholders.forEach(placeholder =\u003e {\n+            const linkUrl = placeholder.getAttribute(\"data-url\")\n+            const eventId = placeholder.getAttribute(\"data-event-id\")\n+\n+            if (linkUrl \u0026\u0026 eventId \u0026\u0026 event.id === eventId) {\n+              try {\n+                const container = document.createElement(\"div\")\n+                placeholder.replaceWith(container)\n+\n+                const linkBlockComponent = mount(ContentLinkBlock, {\n+                  target: container,\n+                  props: {\n+                    value: {url: new URL(linkUrl)},\n+                    event,\n+                  },\n+                })\n+                mountedComponents.push({target: container, component: linkBlockComponent})\n+              } catch (e) {\n+                console.error(\"Failed to mount ContentLinkBlock:\", e)\n+                // Fallback to regular link\n+                const link = document.createElement(\"a\")\n+                link.href = linkUrl\n+                link.textContent = linkUrl\n+                link.className = \"link\"\n+                link.target = \"_blank\"\n+                link.rel = \"noopener noreferrer\"\n+                placeholder.replaceWith(link)\n+              }\n+            }\n+          })\n+\n+          // Mount ContentQuote for note, nevent and naddr\n+          const quotePlaceholders = containerElement.querySelectorAll(\".markdown-quote-placeholder\")\n+          quotePlaceholders.forEach(placeholder =\u003e {\n+            const quoteType = placeholder.getAttribute(\"data-type\")\n+            const eventId = placeholder.getAttribute(\"data-event-id\")\n+            const quoteUrl = placeholder.getAttribute(\"data-url\") || url\n+            const minimal = placeholder.getAttribute(\"data-minimal\") === \"true\"\n+            const quoteDepth = parseInt(placeholder.getAttribute(\"data-depth\") || \"0\")\n+            const hideMedia = parseInt(placeholder.getAttribute(\"data-hide-media\") || \"1\")\n+\n+            if (eventId \u0026\u0026 event.id === eventId) {\n+              try {\n+                let quoteValue: any = null\n+\n+                if (quoteType === \"note\" || quoteType === \"nevent\") {\n+                  const id = placeholder.getAttribute(\"data-id\")\n+                  if (!id) {\n+                    console.error(`Missing id for ${quoteType} quote`)\n+                    return\n+                  }\n+                  const relaysAttr = placeholder.getAttribute(\"data-relays\") || \"[]\"\n+                  let relays: string[] = []\n+                  try {\n+                    relays = JSON.parse(relaysAttr.replace(/\u0026quot;/g, '\"'))\n+                  } catch (e) {\n+                    console.error(`Failed to parse relays for ${quoteType}:`, e)\n+                    relays = []\n+                  }\n+                  quoteValue = {id, relays}\n+                } else if (quoteType === \"naddr\") {\n+                  const kindAttr = placeholder.getAttribute(\"data-kind\")\n+                  const pubkeyAttr = placeholder.getAttribute(\"data-pubkey\")\n+                  const identifierAttr = placeholder.getAttribute(\"data-identifier\")\n+\n+                  if (!kindAttr || !pubkeyAttr || identifierAttr === null) {\n+                    console.error(\"Missing required fields for naddr quote\", {\n+                      kindAttr,\n+                      pubkeyAttr,\n+                      identifierAttr,\n+                    })\n+                    return\n+                  }\n+\n+                  const kind = parseInt(kindAttr)\n+                  if (isNaN(kind)) {\n+                    console.error(\"Invalid kind for naddr quote:\", kindAttr)\n+                    return\n+                  }\n+\n+                  const relaysAttr = placeholder.getAttribute(\"data-relays\") || \"[]\"\n+                  let relays: string[] = []\n+                  try {\n+                    relays = JSON.parse(relaysAttr.replace(/\u0026quot;/g, '\"'))\n+                  } catch (e) {\n+                    console.error(\"Failed to parse relays for naddr:\", e)\n+                    relays = []\n+                  }\n+                  quoteValue = {kind, pubkey: pubkeyAttr, identifier: identifierAttr, relays}\n+                }\n+\n+                if (quoteValue) {\n+                  const container = document.createElement(\"div\")\n+                  placeholder.replaceWith(container)\n+\n+                  const quoteComponent = mount(ContentQuote, {\n+                    target: container,\n+                    props: {\n+                      value: quoteValue,\n+                      event,\n+                      url: quoteUrl || undefined,\n+                      minimal,\n+                      depth: quoteDepth,\n+                      hideMediaAtDepth: hideMedia,\n+                    },\n+                  })\n+                  mountedComponents.push({target: container, component: quoteComponent})\n+                }\n+              } catch (e) {\n+                console.error(\"Failed to mount ContentQuote:\", e, {\n+                  quoteType,\n+                  eventId,\n+                  placeholder: placeholder.outerHTML,\n+                })\n+              }\n+            }\n+          })\n+        }\n       }, 0)\n     }\n \ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex a3e28ef..5ec58c7 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -13,6 +13,7 @@\n   import {pushToast} from \"@src/app/util/toast\"\n   import EventActions from \"@src/app/components/EventActions.svelte\"\n   import ReactionSummary from \"@src/app/components/ReactionSummary.svelte\"\n+  import Markdown from \"@src/lib/components/Markdown.svelte\"\n   import {pushModal} from \"@app/util/modal\"\n   import {EditRepoPanel, ForkRepoDialog} from \"@nostr-git/ui\"\n   import {postRepoAnnouncement} from \"@lib/budabit/commands.js\"\n@@ -609,7 +610,8 @@\n         ProfileLink: ProfileLink as typeof import(\"@nostr-git/ui\").ProfileLink,\n         EventActions: EventActions as typeof import(\"@nostr-git/ui\").EventActions,\n         ReactionSummary: ReactionSummary as typeof import(\"@nostr-git/ui\").ReactionSummary,\n-      }}\u003e\n+        Markdown: Markdown as any,\n+      } as any}\u003e\n       {@render children()}\n     \u003c/ConfigProvider\u003e\n   {/if}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 1118ba0..1f5e791 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -1176,7 +1176,7 @@\n   showNavigation={true}\n   showFileStats={true}\n   showPatchInfo={true}\n-  comments={$threadComments as CommentEvent[]}\n+  comments={diffComments}\n   rootEvent={selectedPatch?.raw}\n   onComment={handleCommentSubmit}\n   currentPubkey={$pubkey}\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-vfiws45m","title":"From 27187db42794b1dc29eff5aa254751693a8edb28 Mon Sep 17 00:00:00 2001","description":"From 27187db42794b1dc29eff5aa254751693a8edb28 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 7 Jul 2025 13:04:19 -0700\nSubject: [PATCH 2/2] refactor: simplify channel management and improve space UI layout\n\n---\n packages/nostr-git                     |   2 +-\n src/app/components/Content.svelte      | 102 ++++++++++++++++++++++++++++++++++++++++++++++++++++++------------------------------------------------\n src/app/components/MenuSpace.svelte    |   1 -\n src/app/state.ts                       |  44 ++++++++++++++++++++------------------------\n src/routes/spaces/[relay]/+page.svelte | 303 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------------------------------------------------------------------\n 5 files changed, 257 insertions(+), 195 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 035c761..4f3f9cc 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 035c7617c2016e99154120357ff4159dcaca5ef6\n+Subproject commit 4f3f9cc02cad3aefe6b103cd9d876e9853e6a2e9\ndiff --git a/src/app/components/Content.svelte b/src/app/components/Content.svelte\nindex 74a1980..0d3ad78 100644\n--- a/src/app/components/Content.svelte\n+++ b/src/app/components/Content.svelte\n@@ -32,7 +32,7 @@\n   import ContentTopic from \"@app/components/ContentTopic.svelte\"\n   import ContentMention from \"@app/components/ContentMention.svelte\"\n   import {entityLink, userSettingValues} from \"@app/state\"\n-  import {isKnownUnknown, unknownKindFallback} from \"@src/lib/unknown-kinds\"\n+  import {Template, isKnownUnknown} from \"@nostr-git/ui\"\n \n   interface Props {\n     event: any\n@@ -58,7 +58,7 @@\n     url,\n   }: Props = $props()\n \n-  const fullContent = parse(isKnownUnknown(event.kind) ? unknownKindFallback(event) : event)\n+  const fullContent = parse(event)\n \n   const expand = () =\u003e {\n     showEntire = true\n@@ -130,55 +130,61 @@\n       \u003c/p\u003e\n     \u003c/div\u003e\n   {:else}\n-    \u003cdiv\n-      class=\"overflow-hidden text-ellipsis break-words\"\n-      style={expandBlock ? \"mask-image: linear-gradient(0deg, transparent 0px, black 100px)\" : \"\"}\u003e\n-      {#each shortContent as parsed, i}\n-        {#if isNewline(parsed) \u0026\u0026 !isBlock(i - 1)}\n-          \u003cContentNewline value={parsed.value} /\u003e\n-        {:else if isTopic(parsed)}\n-          \u003cContentTopic value={parsed.value} /\u003e\n-        {:else if isEmoji(parsed)}\n-          \u003cContentEmoji value={parsed.value} /\u003e\n-        {:else if isCode(parsed)}\n-          \u003cContentCode\n-            value={parsed.value}\n-            isBlock={isStartAndEnd(i) || parsed.value.includes(\"\\n\")} /\u003e\n-        {:else if isCashu(parsed) || isInvoice(parsed)}\n-          \u003cContentToken value={parsed.value} /\u003e\n-        {:else if isLink(parsed)}\n-          {#if isBlock(i)}\n-            \u003cContentLinkBlock value={parsed.value} {event} /\u003e\n-          {:else}\n-            \u003cContentLinkInline value={parsed.value} /\u003e\n-          {/if}\n-        {:else if isProfile(parsed)}\n-          \u003cContentMention value={parsed.value} {url} /\u003e\n-        {:else if isEvent(parsed) || isAddress(parsed)}\n-          {#if isBlock(i)}\n-            \u003cContentQuote\n-              {depth}\n-              {url}\n-              {hideMediaAtDepth}\n+    {#if isKnownUnknown(event.kind)}\n+      \u003cdiv class=\"unknown-kind\"\u003e\n+        {@html new Template(event).render()}\n+      \u003c/div\u003e\n+    {:else}\n+      \u003cdiv\n+        class=\"overflow-hidden text-ellipsis break-words\"\n+        style={expandBlock ? \"mask-image: linear-gradient(0deg, transparent 0px, black 100px)\" : \"\"}\u003e\n+        {#each shortContent as parsed, i}\n+          {#if isNewline(parsed) \u0026\u0026 !isBlock(i - 1)}\n+            \u003cContentNewline value={parsed.value} /\u003e\n+          {:else if isTopic(parsed)}\n+            \u003cContentTopic value={parsed.value} /\u003e\n+          {:else if isEmoji(parsed)}\n+            \u003cContentEmoji value={parsed.value} /\u003e\n+          {:else if isCode(parsed)}\n+            \u003cContentCode\n               value={parsed.value}\n-              {event}\n-              minimal={minimalQuote} /\u003e\n+              isBlock={isStartAndEnd(i) || parsed.value.includes(\"\\n\")} /\u003e\n+          {:else if isCashu(parsed) || isInvoice(parsed)}\n+            \u003cContentToken value={parsed.value} /\u003e\n+          {:else if isLink(parsed)}\n+            {#if isBlock(i)}\n+              \u003cContentLinkBlock value={parsed.value} {event} /\u003e\n+            {:else}\n+              \u003cContentLinkInline value={parsed.value} /\u003e\n+            {/if}\n+          {:else if isProfile(parsed)}\n+            \u003cContentMention value={parsed.value} {url} /\u003e\n+          {:else if isEvent(parsed) || isAddress(parsed)}\n+            {#if isBlock(i)}\n+              \u003cContentQuote\n+                {depth}\n+                {url}\n+                {hideMediaAtDepth}\n+                value={parsed.value}\n+                {event}\n+                minimal={minimalQuote} /\u003e\n+            {:else}\n+              \u003cLink\n+                external\n+                class=\"overflow-hidden text-ellipsis whitespace-nowrap underline\"\n+                href={entityLink(parsed.raw)}\u003e\n+                {fromNostrURI(parsed.raw).slice(0, 16) + \"…\"}\n+              \u003c/Link\u003e\n+            {/if}\n+          {:else if isEllipsis(parsed) \u0026\u0026 expandInline}\n+            {@html renderAsHtml(parsed)}\n+            \u003cbutton type=\"button\" class=\"text-sm underline\"\u003e Read more \u003c/button\u003e\n           {:else}\n-            \u003cLink\n-              external\n-              class=\"overflow-hidden text-ellipsis whitespace-nowrap underline\"\n-              href={entityLink(parsed.raw)}\u003e\n-              {fromNostrURI(parsed.raw).slice(0, 16) + \"…\"}\n-            \u003c/Link\u003e\n+            {@html renderAsHtml(parsed)}\n           {/if}\n-        {:else if isEllipsis(parsed) \u0026\u0026 expandInline}\n-          {@html renderAsHtml(parsed)}\n-          \u003cbutton type=\"button\" class=\"text-sm underline\"\u003e Read more \u003c/button\u003e\n-        {:else}\n-          {@html renderAsHtml(parsed)}\n-        {/if}\n-      {/each}\n-    \u003c/div\u003e\n+        {/each}\n+      \u003c/div\u003e\n+    {/if}\n     {#if expandBlock}\n       \u003cdiv class=\"relative z-feature -mt-6 flex justify-center py-2\"\u003e\n         \u003cbutton\ndiff --git a/src/app/components/MenuSpace.svelte b/src/app/components/MenuSpace.svelte\nindex e5ca0e1..292b8e7 100644\n--- a/src/app/components/MenuSpace.svelte\n+++ b/src/app/components/MenuSpace.svelte\n@@ -24,7 +24,6 @@\n     memberships,\n     deriveUserRooms,\n     deriveOtherRooms,\n-    hasNip29,\n     alerts,\n   } from \"@app/state\"\n   import {notifications} from \"@app/notifications\"\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 9e4d2ae..fe6accb 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -18,6 +18,7 @@ import {\n   memoize,\n   identity,\n   always,\n+  addToMapKey,\n } from \"@welshman/lib\"\n import type {Socket} from \"@welshman/net\"\n import {Pool, load, AuthStateEvent, SocketEvent} from \"@welshman/net\"\n@@ -591,38 +592,33 @@ export const channels = derived(\n       for (const {url, room, name} of getMembershipRooms(membership)) {\n         const id = makeChannelId(url, room)\n \n-        if (!$channels.some(c =\u003e c.id === id)) {\n-          $channels.push({\n-            id,\n-            url,\n-            room,\n-            name,\n-            closed: false,\n-            private: false,\n-          })\n-        }\n+        $channels.push({\n+          id,\n+          url,\n+          room,\n+          name,\n+          closed: false,\n+          private: false,\n+        })\n       }\n     }\n \n     // Add rooms based on known messages\n     for (const event of $messages) {\n       const [_, room] = event.tags.find(nthEq(0, ROOM)) || []\n-\n       if (room) {\n         for (const url of $getUrlsForEvent(event.id)) {\n           const id = makeChannelId(url, room)\n \n-          if (!$channels.some(c =\u003e c.id === id)) {\n-            $channels.push({\n-              id,\n-              url,\n-              room,\n-              name: room,\n-              event,\n-              closed: false,\n-              private: false,\n-            })\n-          }\n+          $channels.push({\n+            id,\n+            url,\n+            room,\n+            name: room,\n+            event,\n+            closed: false,\n+            private: false,\n+          })\n         }\n       }\n     }\n@@ -707,8 +703,8 @@ export const userRoomsByUrl = withGetter(\n     const tags = getListTags($userMembership)\n     const $userRoomsByUrl = new Map\u003cstring, Set\u003cstring\u003e\u003e()\n \n-    for (const url of getRelayTagValues(tags)) {\n-      $userRoomsByUrl.set(normalizeRelayUrl(url), new Set())\n+    for (const [_, room, url] of getGroupTags(tags)) {\n+      addToMapKey($userRoomsByUrl, normalizeRelayUrl(url), room)\n     }\n \n     return $userRoomsByUrl\ndiff --git a/src/routes/spaces/[relay]/+page.svelte b/src/routes/spaces/[relay]/+page.svelte\nindex 698b47f..7628a49 100644\n--- a/src/routes/spaces/[relay]/+page.svelte\n+++ b/src/routes/spaces/[relay]/+page.svelte\n@@ -1,158 +1,219 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n-  import {displayRelayUrl, MESSAGE, THREAD} from \"@welshman/util\"\n-  import {deriveRelay, pubkey} from \"@welshman/app\"\n+  import {displayRelayUrl} from \"@welshman/util\"\n+  import {deriveRelay} from \"@welshman/app\"\n+  import {fade} from \"@lib/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Link from \"@lib/components/Link.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n   import PageBar from \"@lib/components/PageBar.svelte\"\n   import PageContent from \"@lib/components/PageContent.svelte\"\n   import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n-  import ProfileLatest from \"@app/components/ProfileLatest.svelte\"\n+  import ChannelName from \"@app/components/ChannelName.svelte\"\n   import SpaceJoin from \"@app/components/SpaceJoin.svelte\"\n   import RelayName from \"@app/components/RelayName.svelte\"\n+  import RoomCreate from \"@app/components/RoomCreate.svelte\"\n   import RelayDescription from \"@app/components/RelayDescription.svelte\"\n-  import SpaceQuickLinks from \"@app/components/SpaceQuickLinks.svelte\"\n-  import SpaceRelayStatus from \"@app/components/SpaceRelayStatus.svelte\"\n   import {\n-    channelsById,\n     decodeRelay,\n-    deriveEventsForUrl,\n-    deriveOtherRooms,\n     makeChannelId,\n+    channelsById,\n+    deriveUserRooms,\n+    deriveOtherRooms,\n     userRoomsByUrl,\n+    type Channel,\n   } from \"@app/state\"\n-  import {makeChatPath, makeThreadPath, makeCalendarPath, makeGitPath} from \"@app/routes\"\n+  import {\n+    makeChatPath,\n+    makeThreadPath,\n+    makeCalendarPath,\n+    makeGitPath,\n+    makeRoomPath,\n+  } from \"@app/routes\"\n+  import {notifications} from \"@app/notifications\"\n   import {pushModal} from \"@app/modal\"\n-  import ChannelName from \"@src/app/components/ChannelName.svelte\"\n+\n+  const channelIsLocked = (channel: Channel | undefined) =\u003e false\n \n   const url = decodeRelay($page.params.relay)\n   const relay = deriveRelay(url)\n+  const userRooms = deriveUserRooms(url)\n   const otherRooms = deriveOtherRooms(url)\n   const threadsPath = makeThreadPath(url)\n   const calendarPath = makeCalendarPath(url)\n   const gitPath = makeGitPath(url)\n-  const mentions = deriveEventsForUrl(url, [{\"#p\": [$pubkey!], kinds: [MESSAGE, THREAD]}])\n \n   const joinSpace = () =\u003e pushModal(SpaceJoin, {url})\n \n-  const owner = $derived($relay?.profile?.pubkey)\n-\u003c/script\u003e\n+  const addRoom = () =\u003e pushModal(RoomCreate, {url})\n \n-\u003cPageBar\u003e\n-  {#snippet icon()}\n-    \u003cdiv class=\"center\"\u003e\n-      \u003cIcon icon=\"home-smile\" /\u003e\n-    \u003c/div\u003e\n-  {/snippet}\n-  {#snippet title()}\n-    \u003cstrong\u003eHome\u003c/strong\u003e\n-  {/snippet}\n-  {#snippet action()}\n-    \u003cdiv class=\"row-2\"\u003e\n-      {#if !$userRoomsByUrl.has(url)}\n-        \u003cButton class=\"btn btn-primary btn-sm\" onclick={joinSpace}\u003e\n-          \u003cIcon icon=\"login-2\" /\u003e\n-          Join Space\n-        \u003c/Button\u003e\n-      {:else if $pubkey}\n-        \u003cLink class=\"btn btn-primary btn-sm\" href={makeChatPath([$pubkey])}\u003e\n-          \u003cIcon icon=\"letter\" /\u003e\n-          Contact Owner\n-        \u003c/Link\u003e\n-      {/if}\n-      \u003cMenuSpaceButton {url} /\u003e\n-    \u003c/div\u003e\n-  {/snippet}\n-\u003c/PageBar\u003e\n+  const pubkey = $derived($relay?.profile?.pubkey)\n+\u003c/script\u003e\n \n-\u003cPageContent class=\"flex flex-col gap-2 p-2 pt-4\"\u003e\n-  \u003cdiv class=\"card2 bg-alt col-4 text-left\"\u003e\n-    \u003cdiv class=\"relative flex gap-4\"\u003e\n-      \u003cdiv class=\"relative\"\u003e\n-        \u003cdiv class=\"avatar relative\"\u003e\n-          \u003cdiv\n-            class=\"center !flex h-12 w-12 min-w-12 rounded-full border-2 border-solid border-base-300 bg-base-300\"\u003e\n-            {#if $relay?.profile?.icon}\n-              \u003cimg alt=\"\" src={$relay.profile.icon} /\u003e\n-            {:else}\n-              \u003cIcon icon=\"ghost\" size={5} /\u003e\n-            {/if}\n-          \u003c/div\u003e\n-        \u003c/div\u003e\n-      \u003c/div\u003e\n-      \u003cdiv class=\"flex min-w-0 flex-col gap-1\"\u003e\n-        \u003ch2 class=\"ellipsize whitespace-nowrap text-xl\"\u003e\n-          \u003cRelayName {url} /\u003e\n-        \u003c/h2\u003e\n-        \u003cp class=\"ellipsize text-sm opacity-75\"\u003e{displayRelayUrl(url)}\u003c/p\u003e\n+\u003cdiv class=\"relative flex flex-col\"\u003e\n+  \u003cPageBar\u003e\n+    {#snippet icon()}\n+      \u003cdiv class=\"center\"\u003e\n+        \u003cIcon icon=\"home-smile\" /\u003e\n       \u003c/div\u003e\n-    \u003c/div\u003e\n-    \u003cRelayDescription {url} /\u003e\n-    {#if $relay?.profile?.terms_of_service || $relay?.profile?.privacy_policy}\n-      \u003cdiv class=\"flex gap-3\"\u003e\n-        {#if $relay.profile.terms_of_service}\n-          \u003cLink href={$relay.profile.terms_of_service} class=\"badge badge-neutral flex gap-2\"\u003e\n-            \u003cIcon icon=\"bill-list\" size={4} /\u003e\n-            Terms of Service\n-          \u003c/Link\u003e\n-        {/if}\n-        {#if $relay.profile.privacy_policy}\n-          \u003cLink href={$relay?.profile?.privacy_policy} class=\"badge badge-neutral flex gap-2\"\u003e\n-            \u003cIcon icon=\"shield-user\" size={4} /\u003e\n-            Privacy Policy\n+    {/snippet}\n+    {#snippet title()}\n+      \u003cstrong\u003eHome\u003c/strong\u003e\n+    {/snippet}\n+    {#snippet action()}\n+      \u003cdiv class=\"row-2\"\u003e\n+        {#if !$userRoomsByUrl.has(url)}\n+          \u003cButton class=\"btn btn-primary btn-sm\" onclick={joinSpace}\u003e\n+            \u003cIcon icon=\"login-2\" /\u003e\n+            Join Space\n+          \u003c/Button\u003e\n+        {:else if pubkey}\n+          \u003cLink class=\"btn btn-primary btn-sm\" href={makeChatPath([pubkey])}\u003e\n+            \u003cIcon icon=\"letter\" /\u003e\n+            Contact Owner\n           \u003c/Link\u003e\n         {/if}\n+        \u003cMenuSpaceButton {url} /\u003e\n       \u003c/div\u003e\n-    {/if}\n-  \u003c/div\u003e\n-  \u003cSpaceQuickLinks {url} /\u003e\n-  \u003cdiv class=\"grid grid-cols-1 gap-2 lg:grid-cols-2\"\u003e\n-    \u003cdiv class=\"flex flex-col gap-2\"\u003e\n-      \u003cdiv class=\"card2 bg-alt\"\u003e\n-        \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n-          \u003cIcon icon=\"chat-round\" /\u003e\n-          Recent Activity\n-        \u003c/h3\u003e\n-        \u003cdiv class=\"flex flex-col gap-3\"\u003e\n-          {#if $otherRooms.length \u003e 0}\n-            {#each $otherRooms.slice(0, 3) as room (room)}\n-              {@const channel = $channelsById.get(makeChannelId(url, room))}\n-              \u003cdiv class=\"flex items-center gap-3 rounded bg-base-100\"\u003e\n-                \u003cdiv class=\"flex items-center gap-2\"\u003e\n-                  {#if channel?.closed || channel?.private}\n-                    \u003cIcon icon=\"lock\" size={4} /\u003e\n-                  {:else}\n-                    \u003cIcon icon=\"hashtag\" /\u003e\n-                  {/if}\n-                  \u003cspan class=\"font-medium\"\u003e\n-                    \u003cChannelName {url} {room} /\u003e\n-                  \u003c/span\u003e\n-                \u003c/div\u003e\n-                \u003cspan class=\"ml-auto text-sm opacity-60\"\u003eActive conversations\u003c/span\u003e\n+    {/snippet}\n+  \u003c/PageBar\u003e\n+  \u003cPageContent\u003e\n+    \u003cdiv class=\"col-2 p-2\"\u003e\n+      \u003cdiv class=\"card2 bg-alt col-4 text-left\"\u003e\n+        \u003cdiv class=\"relative flex gap-4\"\u003e\n+          \u003cdiv class=\"relative\"\u003e\n+            \u003cdiv class=\"avatar relative\"\u003e\n+              \u003cdiv\n+                class=\"center !flex h-12 w-12 min-w-12 rounded-full border-2 border-solid border-base-300 bg-base-300\"\u003e\n+                {#if $relay?.profile?.icon}\n+                  \u003cimg alt=\"\" src={$relay.profile.icon} /\u003e\n+                {:else}\n+                  \u003cIcon icon=\"ghost\" size={5} /\u003e\n+                {/if}\n               \u003c/div\u003e\n-            {/each}\n-          {:else}\n-            \u003cp class=\"text-sm opacity-60\"\u003eNo recent activity\u003c/p\u003e\n-          {/if}\n+            \u003c/div\u003e\n+          \u003c/div\u003e\n+          \u003cdiv class=\"min-w-0\"\u003e\n+            \u003ch2 class=\"ellipsize whitespace-nowrap text-xl\"\u003e\n+              \u003cRelayName {url} /\u003e\n+            \u003c/h2\u003e\n+            \u003cp class=\"ellipsize text-sm opacity-75\"\u003e{displayRelayUrl(url)}\u003c/p\u003e\n+          \u003c/div\u003e\n         \u003c/div\u003e\n+        \u003cRelayDescription {url} /\u003e\n+        {#if $relay?.profile}\n+          {@const {software, version, supported_nips, limitation} = $relay.profile}\n+          \u003cdiv class=\"flex flex-wrap gap-1\"\u003e\n+            {#if limitation?.auth_required}\n+              \u003cp class=\"badge badge-neutral\"\u003e\n+                \u003cspan class=\"ellipsize\"\u003eAuthentication Required\u003c/span\u003e\n+              \u003c/p\u003e\n+            {/if}\n+            {#if limitation?.payment_required}\n+              \u003cp class=\"badge badge-neutral\"\u003e\u003cspan class=\"ellipsize\"\u003ePayment Required\u003c/span\u003e\u003c/p\u003e\n+            {/if}\n+            {#if limitation?.min_pow_difficulty}\n+              \u003cp class=\"badge badge-neutral\"\u003e\n+                \u003cspan class=\"ellipsize\"\u003eRequires PoW {limitation?.min_pow_difficulty}\u003c/span\u003e\n+              \u003c/p\u003e\n+            {/if}\n+            {#if Array.isArray(supported_nips)}\n+              \u003cp class=\"badge badge-neutral\"\u003e\n+                \u003cspan class=\"ellipsize\"\u003eNIPs: {supported_nips.join(\", \")}\u003c/span\u003e\n+              \u003c/p\u003e\n+            {/if}\n+            {#if software}\n+              \u003cp class=\"badge badge-neutral\"\u003e\u003cspan class=\"ellipsize\"\u003eSoftware: {software}\u003c/span\u003e\u003c/p\u003e\n+            {/if}\n+            {#if version}\n+              \u003cp class=\"badge badge-neutral\"\u003e\u003cspan class=\"ellipsize\"\u003eVersion: {version}\u003c/span\u003e\u003c/p\u003e\n+            {/if}\n+          \u003c/div\u003e\n+        {/if}\n+      \u003c/div\u003e\n+      \u003cdiv class=\"grid grid-cols-3 gap-2\"\u003e\n+        \u003cLink href={threadsPath} class=\"btn btn-primary\"\u003e\n+          \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n+            \u003cIcon icon=\"notes-minimalistic\" /\u003e\n+            Threads\n+            {#if $notifications.has(threadsPath)}\n+              \u003cdiv\n+                class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n+                transition:fade\u003e\n+              \u003c/div\u003e\n+            {/if}\n+          \u003c/div\u003e\n+        \u003c/Link\u003e\n+        \u003cLink href={calendarPath} class=\"btn btn-secondary\"\u003e\n+          \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n+            \u003cIcon icon=\"notes-minimalistic\" /\u003e\n+            Calendar\n+            {#if $notifications.has(calendarPath)}\n+              \u003cdiv\n+                class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n+                transition:fade\u003e\n+              \u003c/div\u003e\n+            {/if}\n+          \u003c/div\u003e\n+        \u003c/Link\u003e\n+        \u003c!-- \u003cLink href={jobsPath} class=\"btn btn-success\"\u003e --\u003e\n+        \u003c!--   \u003cdiv class=\"relative flex items-center gap-2\"\u003e --\u003e\n+        \u003c!--     \u003cIcon icon=\"jobs\" /\u003e --\u003e\n+        \u003c!--     Jobs --\u003e\n+        \u003c!--     {#if $notifications.has(jobsPath)} --\u003e\n+        \u003c!--       \u003cdiv --\u003e\n+        \u003c!--         class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\" --\u003e\n+        \u003c!--         transition:fade\u003e --\u003e\n+        \u003c!--       \u003c/div\u003e --\u003e\n+        \u003c!--     {/if} --\u003e\n+        \u003c!--   \u003c/div\u003e --\u003e\n+        \u003c!-- \u003c/Link\u003e --\u003e\n+        \u003cLink href={gitPath} class=\"btn btn-info\"\u003e\n+          \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n+            \u003cIcon icon=\"git\" /\u003e\n+            Git\n+            {#if $notifications.has(gitPath)}\n+              \u003cdiv\n+                class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n+                transition:fade\u003e\n+              \u003c/div\u003e\n+            {/if}\n+          \u003c/div\u003e\n+        \u003c/Link\u003e\n+        {#each $userRooms as room (room)}\n+          {@const roomPath = makeRoomPath(url, room)}\n+          \u003cLink href={roomPath} class=\"btn btn-neutral relative\"\u003e\n+            \u003cdiv class=\"flex min-w-0 items-center gap-2 overflow-hidden text-nowrap\"\u003e\n+              {#if channelIsLocked($channelsById.get(makeChannelId(url, room)))}\n+                \u003cIcon icon=\"lock\" size={4} /\u003e\n+              {:else}\n+                \u003cIcon icon=\"hashtag\" /\u003e\n+              {/if}\n+              \u003cChannelName {url} {room} /\u003e\n+            \u003c/div\u003e\n+            {#if $notifications.has(roomPath)}\n+              \u003cdiv class=\"absolute right-1 top-1 h-2 w-2 rounded-full bg-primary\" transition:fade\u003e\n+              \u003c/div\u003e\n+            {/if}\n+          \u003c/Link\u003e\n+        {/each}\n+        {#each $otherRooms as room (room)}\n+          \u003cLink href={makeRoomPath(url, room)} class=\"btn btn-neutral\"\u003e\n+            \u003cdiv class=\"relative flex min-w-0 items-center gap-2 overflow-hidden text-nowrap\"\u003e\n+              {#if channelIsLocked($channelsById.get(makeChannelId(url, room)))}\n+                \u003cIcon icon=\"lock\" size={4} /\u003e\n+              {:else}\n+                \u003cIcon icon=\"hashtag\" /\u003e\n+              {/if}\n+              \u003cChannelName {url} {room} /\u003e\n+            \u003c/div\u003e\n+          \u003c/Link\u003e\n+        {/each}\n+        \u003cButton onclick={addRoom} class=\"btn btn-neutral whitespace-nowrap\"\u003e\n+          \u003cIcon icon=\"add-circle\" /\u003e\n+          Create\n+        \u003c/Button\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n-    \u003cdiv class=\"flex flex-col gap-2\"\u003e\n-      \u003cSpaceRelayStatus {url} /\u003e\n-      {#if owner}\n-        \u003cdiv class=\"card2 bg-alt\"\u003e\n-          \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n-            \u003cIcon icon=\"user-rounded\" /\u003e\n-            Latest Updates\n-          \u003c/h3\u003e\n-          \u003cProfileLatest {url} pubkey={owner}\u003e\n-            {#snippet fallback()}\n-              \u003cp class=\"text-sm opacity-60\"\u003eNo recent posts from the relay admin\u003c/p\u003e\n-            {/snippet}\n-          \u003c/ProfileLatest\u003e\n-        \u003c/div\u003e\n-      {/if}\n-    \u003c/div\u003e\n-  \u003c/div\u003e\n-\u003c/PageContent\u003e\n+  \u003c/PageContent\u003e\n+\u003c/div\u003e\n\\ No newline at end of file\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-vhi6dsua","title":"From d9263aa46a87d20600631f92a0c093ee30fd9f95 Mon Sep 17 00:00:00 2001","description":"From d9263aa46a87d20600631f92a0c093ee30fd9f95 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sat, 27 Dec 2025 14:41:00 +0500\nSubject: [PATCH 2/3] feat: enhance commit navigation and improve commit detail page UX\n\nSubmodule Updates (nostr-git):\n- Update nostr-git submodule to latest commit with refactored CommitCard\n- CommitCard now supports parent commit navigation via getParentHref prop\n- Simplified component by removing react/comment functionality\n\nCommit List Page (commits/+page.svelte):\n- Add getParentHref prop to CommitCard component\n- Enable clickable parent commit links in commit cards\n- Pass getCommitUrl function to generate parent commit navigation URLs\n- Improve commit history navigation flow\n\nCommit Detail Page (commits/[commitid]/+page.svelte):\n- Remove sticky positioning from header controls (z-10 sticky top-0)\n- Simplify header layout by removing file count display\n- Improve visual hierarchy and reduce visual clutter\n- Maintain expand/collapse functionality without sticky behavior\n\nThese changes improve the user experience by:\n- Enabling seamless navigation through commit history via parent links\n- Reducing visual noise on the commit detail page\n- Simplifying the commit card component interface\n- Making the commit browsing experience more intuitive\n---\n packages/nostr-git                                                       |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte            | 10 +++++-----\n src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte |  8 +-------\n 3 files changed, 7 insertions(+), 13 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 2d22f18..bc5b677 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 2d22f18c02136c8facb40bab6bde2f89f66b7792\n+Subproject commit bc5b677b0aacec5c7655def1aa6d447ce675ca28\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\nindex e74e145..df2595c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n@@ -332,13 +332,13 @@\n         {#if commits}\n           \u003cdiv class=\"space-y-4\" transition:slide\u003e\n             {#each filteredCommits as commit (commit.oid)}\n-              \u003cCommitCard \n-                {commit} \n-                onReact={handleReact} \n+              \u003cCommitCard\n+                {commit}\n+                onReact={handleReact}\n                 onComment={handleComment}\n                 href={getCommitUrl(commit.oid)}\n-                displayName={commit?.commit?.author?.name || undefined}\n-              /\u003e\n+                getParentHref={getCommitUrl}\n+                displayName={commit?.commit?.author?.name || undefined} /\u003e\n             {/each}\n           \u003c/div\u003e\n           \u003cdiv class=\"mt-6 flex flex-col items-center gap-4 sm:flex-row sm:justify-between\"\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\nindex 375a771..b07053c 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\n@@ -222,7 +222,7 @@\n   \u003c/div\u003e\n \n   \u003cdiv\n-    class=\"z-10 sticky top-0 border-b border-border bg-card/95 px-4 py-3 shadow-sm backdrop-blur-sm sm:px-6 sm:py-4\"\u003e\n+    class=\"border-b border-border bg-card/95 px-4 py-3 shadow-sm backdrop-blur-sm sm:px-6 sm:py-4\"\u003e\n     \u003cdiv class=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\"\u003e\n       \u003c!-- Expand/Collapse Controls --\u003e\n       \u003cdiv class=\"flex items-center gap-2\"\u003e\n@@ -246,12 +246,6 @@\n           \u003cChevronsUp class=\"h-4 w-4\" /\u003e\n           \u003cspan\u003eCollapse all\u003c/span\u003e\n         \u003c/button\u003e\n-        {#if changes.length \u003e 0}\n-          \u003cspan class=\"ml-2 text-sm text-muted-foreground\"\u003e\n-            ({expandedCount} of {changes.length}\n-            {expandedCount === 1 ? \"file\" : \"files\"} expanded)\n-          \u003c/span\u003e\n-        {/if}\n       \u003c/div\u003e\n     \u003c/div\u003e\n   \u003c/div\u003e\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-vjctumj0","title":"From ae23203a406e64d6dcda0b26c4470a3046753f2b Mon Sep 17 00:00:00 2001","description":"From ae23203a406e64d6dcda0b26c4470a3046753f2b Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 7 Jul 2025 09:26:25 -0700\nSubject: [PATCH 1/2] refactor: optimize chat feed rendering and update tab navigation layout\n\n---\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte    | 12 ++++++------\n src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte | 26 ++++++--------------------\n 2 files changed, 12 insertions(+), 26 deletions(-)\n\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 2c24058..c92efa8 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -44,9 +44,9 @@\n     \u003cRepoHeader event={repoClass.repoEvent} {activeTab} isRepoWatched={false}\u003e\n       {#snippet children(activeTab: string)}\n         \u003cRepoTab\n-          tabValue={id}\n-          label=\"Overview\"\n-          href={`/spaces/${encodedRelay}/git/${id}`}\n+          tabValue=\"feed\"\n+          label=\"Feed\"\n+          href={`/spaces/${encodedRelay}/git/${id}/feed`}\n           {activeTab}\u003e\n           {#snippet icon()}\n             \u003cFileCode class=\"h-4 w-4\" /\u003e\n@@ -89,9 +89,9 @@\n           {/snippet}\n         \u003c/RepoTab\u003e\n         \u003cRepoTab\n-          tabValue=\"feed\"\n-          label=\"Feed\"\n-          href={`/spaces/${encodedRelay}/git/${id}/feed`}\n+          tabValue=\"workbench\"\n+          label=\"Workbench\"\n+          href={`/spaces/${encodedRelay}/git/${id}/workbench`}\n           {activeTab}\u003e\n           {#snippet icon()}\n             \u003cLayers class=\"h-4 w-4\" /\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte\nindex e847708..331986b 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/feed/+page.svelte\n@@ -198,12 +198,12 @@\n \n     if (events) {\n       const lastUserEvent = $events.find(e =\u003e e.pubkey === $pubkey)\n-\n+      const today = formatTimestampAsDate(Date.now()/1000)\n       // Adjust last checked to account for messages that came from a different device\n       const adjustedLastChecked =\n         lastChecked \u0026\u0026 lastUserEvent ? Math.max(lastUserEvent.created_at, lastChecked) : lastChecked\n \n-      for (const event of $events.toReversed()) {\n+      for (const event of $events) {\n         if (seen.has(event.id)) {\n           continue\n         }\n@@ -221,7 +221,7 @@\n           newMessagesSeen = true\n         }\n \n-        if (date !== previousDate) {\n+        if (date !== previousDate \u0026\u0026 date !== today) {\n           elements.push({type: \"date\", value: date, id: date, showPubkey: false})\n         }\n \n@@ -238,7 +238,7 @@\n       }\n     }\n \n-    elements.reverse()\n+    //elements.reverse()\n \n     setTimeout(onScroll, 100)\n \n@@ -279,20 +279,7 @@\n   }\n \n   onMount(() =\u003e {\n-    const observer = new ResizeObserver(() =\u003e {\n-      if (dynamicPadding \u0026\u0026 chatCompose) {\n-        dynamicPadding!.style.minHeight = `${chatCompose!.offsetHeight}px`\n-      }\n-    })\n-\n-    observer.observe(chatCompose!)\n-    observer.observe(dynamicPadding!)\n     start()\n-\n-    return () =\u003e {\n-      observer.unobserve(chatCompose!)\n-      observer.unobserve(dynamicPadding!)\n-    }\n   })\n \n   onDestroy(() =\u003e {\n@@ -308,8 +295,7 @@\n \u003cdiv\n   bind:this={element}\n   onscroll={onScroll}\n-  class=\"scroll-container cw md:bottom-sai fixed bottom-[calc(var(--saib)+3.5rem)] top-[calc(var(--sait)+16em)] flex flex-col-reverse overflow-y-auto overflow-x-hidden px-6 w-full\"\u003e\n-  \u003cdiv bind:this={dynamicPadding}\u003e\u003c/div\u003e\n+  class=\"scroll-container cw md:bottom-sai fixed bottom-[calc(var(--saib)+3.5rem)] top-[calc(var(--sait)+16rem)] flex flex-col overflow-y-auto overflow-x-hidden px-6 w-full\"\u003e\n   {#each elements as { type, id, value, showPubkey } (id)}\n     {#if type === \"new-messages\"}\n       \u003cdiv\n@@ -379,7 +365,7 @@\n {#if showScrollButton}\n   \u003cdiv in:fade class=\"chat__scroll-down\"\u003e\n     \u003cButton class=\"btn btn-circle btn-neutral\" onclick={scrollToBottom}\u003e\n-      \u003cIcon icon=\"alt-arrow-down\" /\u003e\n+      \u003cIcon icon=\"alt-arrow-up\" /\u003e\n     \u003c/Button\u003e\n   \u003c/div\u003e\n {/if}\n--\nlibgit2 1.9.0\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-vmmnqi94","title":"Import repos","description":"The goal is to have users import their repos from arbitrary providers with a smooth one-click experience:\n-  Basic Repo metadata + necessary nip34 repo metadata (relays, euc, ...): read basics from platform api, recommend good defaults and have an input field for custom relays\n\n- Code: If user doesn’t own the repo to be imported then we fork the original. This is the clean way to have access to all features after importing, like merge PRs and push branches. We don't allow importing without access tokens (rate limiting and repo access can produce lots of edge-cases without it)\n\n- Issues, comments, PRs: We publish ALL issues, comments and PRs of the repo on the repo relays to have a one-click experience. We don't care to exactly match platform users to nostr users.\n\nWe create nostr accounts for the github/gitlab users _on the fly_ and if we can read the user name and profile image from the platform then we create a nostr profile with that name and image and publish that along with the issues/comments/PRs\n\nFlow:\n1. User puts in the URL of the repo ( eg https://github.com/Pleb5/satshoot )\n2. We check if there's an access token associated with that host (in this case github) AND we make the user check a checkbox that \"My [host] token has read and write permissions to repos\", only let user further when this is checked but perform a basic automatic check as well.\n3. We check if access token indicates ownership of the target repo. If yes, we DON'T fork the repo, just publish nostr events. Otherwise we create the fork and indicate this on the UI (\"You don't own this repo, Fork will be created with name xyz\"). Name of the fork must be editable and checked for duplicate naming like with normal repo creation.\n4. Relay setup: \"Repo metadata will live on Nostr now, please select Repo relays\" . Recommend 2 default relays and let user add/remove anything. At least one relay must be present to continue.\n5. Big-ass button that says \"SET MY REPO FREE\" - starts the process. \n\nThe process must give fine-grained feedback about the progress of the operation and propagate any errors. \nFirst we try the git operations and if it fails we abort the process without publishing on nostr unnecessarily.\n\n+ Extra: later on we want to have this feature handle multiple providers to push the forked repo to: if multiple access tokens are present, we can let the user select github + gitlab + codeberg + custom server...\n\nWe DON'T implement this in the first version of this feature though, it is already complex enough.","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["enhancement","import-repo","issue"]}
{"id":"flotilla-vp7kk9gb","title":"From 69103f13aa6d699686b437f788e9e2384127d305 Mon Sep 17 00:00:00 2001","description":"From 69103f13aa6d699686b437f788e9e2384127d305 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Mon, 19 May 2025 10:06:43 -0700\nSubject: [PATCH 1/67] Add github action to publish dockerfile\n\n---\n .github/workflows/docker.yml | 47 +++++++++++++++++++++++++++++++++++++++++++++++\n 1 file changed, 47 insertions(+)\n create mode 100644 .github/workflows/docker.yml\n\ndiff --git a/.github/workflows/docker.yml b/.github/workflows/docker.yml\nnew file mode 100644\nindex 0000000..f78b67f\n--- /dev/null\n+++ b/.github/workflows/docker.yml\n@@ -0,0 +1,47 @@\n+name: Build and Publish Docker Image\n+\n+on:\n+  push:\n+    tags:\n+      - '*'\n+\n+env:\n+  REGISTRY: docker.io\n+  IMAGE_NAME: ${{ github.repository }}\n+\n+jobs:\n+  build-and-push:\n+    runs-on: ubuntu-latest\n+    permissions:\n+      contents: read\n+      packages: write\n+\n+    steps:\n+      - name: Checkout repository\n+        uses: actions/checkout@v4\n+        with:\n+          fetch-depth: 0\n+\n+      - name: Log in to Docker Hub\n+        uses: docker/login-action@v3\n+        with:\n+          username: ${{ secrets.DOCKERHUB_USERNAME }}\n+          password: ${{ secrets.DOCKERHUB_TOKEN }}\n+\n+      - name: Extract metadata (tags, labels) for Docker\n+        id: meta\n+        uses: docker/metadata-action@v5\n+        with:\n+          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\n+          tags: |\n+            type=semver,pattern={{version}}\n+            type=semver,pattern={{major}}.{{minor}}\n+            type=semver,pattern={{major}}\n+\n+      - name: Build and push Docker image\n+        uses: docker/build-push-action@v5\n+        with:\n+          context: .\n+          push: true\n+          tags: ${{ steps.meta.outputs.tags }}\n+          labels: ${{ steps.meta.outputs.labels }}\n--\nlibgit2 1.9.0\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-vv2dfkvn","title":"Avatars are not clickable links in nostr-git UI","description":"It is expected by users to view any profile in any context, comments and issue cards etc alike.\nProfileLink.svelte does this in Flotilla","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue"]}
{"id":"flotilla-vxzc0h02","title":"From efbf7cef566ebdb0616ee732927039047a5fec49 Mon Sep 17 00:00:00 2001","description":"From efbf7cef566ebdb0616ee732927039047a5fec49 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 12 May 2025 17:37:34 -0700\nSubject: [PATCH] feat: add README.md rendering and share repo event context across pages\n\n---\n package.json                                                  |  1 +\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte       | 36 +++++++++++++++++++++++++++++-------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte         | 73 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte    | 41 +++++++++++++++++++++--------------------\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte  |  3 +++\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte | 24 ++++++++++++++++--------\n 6 files changed, 135 insertions(+), 43 deletions(-)\n\ndiff --git a/package.json b/package.json\nindex bc46dab..b090f78 100644\n--- a/package.json\n+++ b/package.json\n@@ -77,6 +77,7 @@\n     \"idb\": \"^8.0.0\",\n     \"mustache\": \"^4.2.0\",\n     \"nostr-git\": \"github:chebizarro/nostr-git\",\n+    \"markdown-it\": \"^14.1.0\",\n     \"nostr-signer-capacitor-plugin\": \"coracle-social/nostr-signer-capacitor-plugin#9fbe4f8\",\n     \"nostr-tools\": \"^2.7.2\",\n     \"prettier-plugin-tailwindcss\": \"^0.6.5\",\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex f5a2fbd..ad22715 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -5,13 +5,15 @@\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n   import {FileCode, GitBranch, CircleAlert, GitPullRequest, Book} from \"@lucide/svelte\"\n   import {type RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n+  import {setContext} from \"svelte\"\n+\n   const {id, relay} = $page.params\n-  // Decode params for use in the app\n   const encodeddRelay = encodeURIComponent(relay)\n   const relayArray = Array.isArray(relay) ? relay : [relay]\n   const eventStore = deriveNaddrEvent(id, relayArray)\n   let {children} = $props()\n   let activeTab: string | undefined = $page.url.pathname.split(\"/\").pop()\n+  setContext(\"repo-event\", eventStore)\n \u003c/script\u003e\n \n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n@@ -20,29 +22,49 @@\n   {:else if !$eventStore}\n     \u003cdiv class=\"p-4 text-center text-red-500\"\u003eRepository not found.\u003c/div\u003e\n   {:else}\n-    \u003cRepoHeader event={$eventStore as RepoAnnouncementEvent} activeTab={activeTab}\u003e\n+    \u003cRepoHeader event={$eventStore as RepoAnnouncementEvent} {activeTab}\u003e\n       {#snippet children(activeTab)}\n-        \u003cRepoTab tabValue=\"overview\" label=\"Overview\" href={`/spaces/${encodeddRelay}/git/${id}`} {activeTab}\u003e\n+        \u003cRepoTab\n+          tabValue=\"overview\"\n+          label=\"Overview\"\n+          href={`/spaces/${encodeddRelay}/git/${id}`}\n+          {activeTab}\u003e\n           {#snippet icon()}\n             \u003cFileCode class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab tabValue=\"code\" label=\"Code\" href={`/spaces/${encodeddRelay}/git/${id}/code`} {activeTab}\u003e\n+        \u003cRepoTab\n+          tabValue=\"code\"\n+          label=\"Code\"\n+          href={`/spaces/${encodeddRelay}/git/${id}/code`}\n+          {activeTab}\u003e\n           {#snippet icon()}\n             \u003cGitBranch class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab tabValue=\"issues\" label=\"Issues\" href={`/spaces/${encodeddRelay}/git/${id}/issues`} {activeTab}\u003e\n+        \u003cRepoTab\n+          tabValue=\"issues\"\n+          label=\"Issues\"\n+          href={`/spaces/${encodeddRelay}/git/${id}/issues`}\n+          {activeTab}\u003e\n           {#snippet icon()}\n             \u003cCircleAlert class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab tabValue=\"patches\" label=\"Patches\" href={`/spaces/${encodeddRelay}/git/${id}/patches`} {activeTab}\u003e\n+        \u003cRepoTab\n+          tabValue=\"patches\"\n+          label=\"Patches\"\n+          href={`/spaces/${encodeddRelay}/git/${id}/patches`}\n+          {activeTab}\u003e\n           {#snippet icon()}\n             \u003cGitPullRequest class=\"h-4 w-4\" /\u003e\n           {/snippet}\n         \u003c/RepoTab\u003e\n-        \u003cRepoTab tabValue=\"wiki\" label=\"Wiki\" href={`/spaces/${encodeddRelay}/git/${id}/wiki`} {activeTab}\u003e\n+        \u003cRepoTab\n+          tabValue=\"wiki\"\n+          label=\"Wiki\"\n+          href={`/spaces/${encodeddRelay}/git/${id}/wiki`}\n+          {activeTab}\u003e\n           {#snippet icon()}\n             \u003cBook class=\"h-4 w-4\" /\u003e\n           {/snippet}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex e9e12d1..5aa3049 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -1,5 +1,9 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {onMount, tick} from \"svelte\"\n+  import {getContext, onMount, tick} from \"svelte\"\n+  import type {Readable} from \"svelte/store\"\n+  import {getRepoFileContentFromEvent} from \"@nostr-git/core\"\n+  import markdownit from \"markdown-it\"\n+\n   import {page} from \"$app/stores\"\n   import {sortBy, nthEq, now} from \"@welshman/lib\"\n   import {\n@@ -23,9 +27,8 @@\n   import type {AddressPointer} from \"nostr-tools/nip19\"\n   import {Router} from \"@welshman/router\"\n   import {Card} from \"@nostr-git/ui\"\n-    import { GitBranch, GitCommit, Users } from \"@lucide/svelte\"\n-    import key from \"@lucide/svelte/icons/key\"\n-    \n+  import {GitBranch, GitCommit, Users} from \"@lucide/svelte\"\n+\n   const {relay, id} = $page.params\n   const url = decodeRelay(relay)\n \n@@ -200,11 +203,30 @@\n   })\n \n   const stats = [\n-    { label: 'Active Branches', value: '5', icon: GitBranch },\n-    { label: 'Total Commits', value: '241', icon: GitCommit },\n-    { label: 'Contributors', value: '15', icon: Users },\n-  ];\n+    {label: \"Active Branches\", value: \"5\", icon: GitBranch},\n+    {label: \"Total Commits\", value: \"241\", icon: GitCommit},\n+    {label: \"Contributors\", value: \"15\", icon: Users},\n+  ]\n \n+  const eventStore = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n+\n+  let readme = $state\u003cstring | undefined\u003e(undefined)\n+  let renderedReadme = $state\u003cstring | undefined\u003e(undefined)\n+  const md = markdownit({\n+    html: true,\n+    linkify: true,\n+    typographer: true,\n+  })\n+\n+  $effect(async () =\u003e {\n+    if (!$eventStore) return\n+    readme = await getRepoFileContentFromEvent({\n+      repoEvent: $eventStore,\n+      branch: \"master\",\n+      path: \"README.md\",\n+    })\n+    renderedReadme = readme ? md.render(readme) : \"\"\n+  })\n \u003c/script\u003e\n \n \u003cdiv class=\"relative flex flex-col gap-3 px-2\"\u003e\n@@ -221,5 +243,40 @@\n       \u003c/Card\u003e\n     {/each}\n   \u003c/div\u003e\n+  {#if renderedReadme}\n+    \u003cdiv class=\"prose prose-slate max-w-none bg-muted border border-muted rounded-xl shadow-md p-8 overflow-x-auto dark:prose-invert prose-headings:font-bold prose-headings:mb-3 prose-headings:mt-8 prose-h1:text-3xl prose-h2:text-2xl prose-h3:text-xl prose-p:leading-relaxed prose-p:my-4 prose-ul:my-4 prose-ol:my-4 prose-li:marker:text-primary prose-blockquote:border-l-4 prose-blockquote:border-accent prose-blockquote:bg-accent/10 prose-blockquote:p-4 prose-blockquote:rounded prose-blockquote:my-6 prose-table:my-6 prose-table:border prose-table:border-muted prose-th:bg-muted/50 prose-th:font-semibold prose-th:p-3 prose-td:p-3 prose-pre:bg-zinc-900 prose-pre:rounded-lg prose-pre:p-4 prose-code:bg-zinc-800 prose-code:rounded-md prose-code:px-2 prose-code:py-1 prose-code:text-sm\"\u003e\n+      {@html renderedReadme}\n+    \u003c/div\u003e\n+  {:else}\n+    \u003cdiv class=\"text-muted-foreground\"\u003eNo README.md found.\u003c/div\u003e\n+  {/if}\n \n+\u003cstyle\u003e\n+  /* Further polish for markdown rendering in README */\n+  .prose h1, .prose h2, .prose h3 {\n+    letter-spacing: -0.01em;\n+  }\n+  .prose h1 {\n+    border-bottom: 1px solid theme('colors.border');\n+    padding-bottom: 0.3em;\n+  }\n+  .prose blockquote {\n+    border-left-width: 4px;\n+    border-color: var(--tw-prose-accent);\n+    background: var(--tw-prose-accent-bg, rgba(59,130,246,0.05));\n+    padding: 1rem;\n+    border-radius: 0.5rem;\n+    margin: 1.5rem 0;\n+  }\n+  .prose pre {\n+    margin: 1.5rem 0;\n+  }\n+  .prose table {\n+    border-radius: 0.5rem;\n+    overflow: hidden;\n+  }\n+  .prose th, .prose td {\n+    border: 1px solid theme('colors.zinc.700');\n+  }\n+\u003c/style\u003e\n \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex 6dca34b..5642ff0 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -1,44 +1,45 @@\n \u003cscript lang=\"ts\"\u003e\n-  import { FileView } from \"@nostr-git/ui\";\n-  import { GitBranch } from \"@lucide/svelte\";\n-  import { listRepoFiles } from \"@nostr-git/core\";\n-  let { params } = $props();\n-  let { host, owner, repo } = params;\n+  import {FileView} from \"@nostr-git/ui\"\n+  import {GitBranch} from \"@lucide/svelte\"\n+  import {listRepoFilesFromEvent, type FileEntry} from \"@nostr-git/core\"\n+  import {getContext} from \"svelte\"\n+  import type {Readable} from \"svelte/store\"\n+  import type {TrustedEvent} from \"@welshman/util\"\n \n-  let branches = $state([{ name: 'main', isDefault: true }]); // Replace with real branch fetch\n-  let selectedBranch = $state('main');\n-  let files = $state([]);\n+  const eventStore: Readable\u003cTrustedEvent\u003e = getContext(\"repo-event\")\n+\n+  let branches = $state([{name: \"master\", isDefault: true}]) // Replace with real branch fetch\n+  let selectedBranch = $state(\"master\")\n+  let files = $state([] as FileEntry[])\n \n   async function fetchFiles(branch: string) {\n-    files = await listRepoFiles({ host, owner, repo, branch });\n+    files = await listRepoFilesFromEvent({repoEvent: $eventStore, branch})\n   }\n \n   $effect(() =\u003e {\n-    fetchFiles(selectedBranch);\n-  });\n+    fetchFiles(selectedBranch)\n+  })\n \u003c/script\u003e\n \n-\u003cdiv class=\"border-border bg-card rounded-lg border\"\u003e\n+\u003cdiv class=\"rounded-lg border border-border bg-card\"\u003e\n   \u003cdiv class=\"p-4\"\u003e\n     \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n       \u003cdiv class=\"flex items-center gap-2\"\u003e\n-        \u003cGitBranch class=\"text-muted-foreground h-5 w-5\" /\u003e\n+        \u003cGitBranch class=\"h-5 w-5 text-muted-foreground\" /\u003e\n         \u003cselect\n-          class=\"border-border rounded border bg-secondary px-2 py-1\"\n-          bind:value={selectedBranch}\n-        \u003e\n+          class=\"rounded border border-border bg-secondary px-2 py-1\"\n+          bind:value={selectedBranch}\u003e\n           {#each branches as branch}\n             \u003coption value={branch.name}\u003e\n               {branch.name}\n-              {branch.isDefault ? ' (default)' : ''}\n+              {branch.isDefault ? \" (default)\" : \"\"}\n             \u003c/option\u003e\n           {/each}\n         \u003c/select\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n-    \u003cdiv class=\"border-border border-t pt-4\"\u003e\n+    \u003cdiv class=\"border-t border-border pt-4\"\u003e\n       \u003cdiv class=\"space-y-2\"\u003e\n-        \u003ch3 class=\"mb-4 font-medium\"\u003eFiles\u003c/h3\u003e\n         \u003cdiv class=\"space-y-2\"\u003e\n           {#each files as file}\n             \u003cFileView name={file.name} type={file.type} path={file.path} /\u003e\n@@ -47,4 +48,4 @@\n       \u003c/div\u003e\n     \u003c/div\u003e\n   \u003c/div\u003e\n-\u003c/div\u003e\n\\ No newline at end of file\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex e22bb14..5ca7d94 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -12,6 +12,9 @@\n   import {deriveProfile} from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n \n+  // Receive eventStore from layout via $props (Svelte 5 idiom)\n+  const { eventStore } = $props();\n+\n   const {id, relay} = $page.params\n   const relayArray = Array.isArray(relay) ? relay : [relay]\n   const repo = deriveNaddrEvent(id)\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 016bbeb..8707b08 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -3,13 +3,17 @@\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n   import {Button, PatchCard} from \"@nostr-git/ui\"\n   import {setChecked} from \"@src/app/notifications\"\n+  import {onMount} from \"svelte\"\n+  import {GIT_PATCH, type TrustedEvent} from \"@welshman/util\"\n+  import {Address} from \"@welshman/util\"\n+  import {load} from \"@welshman/net\"\n+  import {nthEq} from \"@welshman/lib\"\n   import {deriveNaddrEvent} from \"@src/app/state\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {deriveProfile} from \"@welshman/app\"\n-  import {nthEq} from \"@welshman/lib\"\n-  import {load} from \"@welshman/net\"\n-  import {Address, GIT_PATCH, type TrustedEvent} from \"@welshman/util\"\n-  import {onMount} from \"svelte\"\n+\n+  // Receive eventStore from layout via $props (Svelte 5 idiom)\n+  const { eventStore } = $props();\n \n   const {id, relay} = page.params\n   const relayArray = Array.isArray(relay) ? relay : [relay]\n@@ -18,10 +22,14 @@\n   let loading = $state(true)\n   let currentPage = $state(1)\n   const pageSize = 10\n-  const pageCount = $derived(() =\u003e Math.max(1, Math.ceil(patches.length / pageSize)))\n-  const paginatedPatches = $derived(() =\u003e\n-    patches.slice((currentPage - 1) * pageSize, currentPage * pageSize),\n-  )\n+\n+  function pageCount() {\n+    return Math.max(1, Math.ceil(patches.length / pageSize))\n+  }\n+\n+  function paginatedPatches() {\n+    return patches.slice((currentPage - 1) * pageSize, currentPage * pageSize)\n+  }\n \n   function prevPage() {\n     if (currentPage \u003e 1) currentPage = currentPage - 1\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-w0y6h326","title":"From 557f0f6431dbf70affece0e1b20488e012db0582 Mon Sep 17 00:00:00 2001","description":"From 557f0f6431dbf70affece0e1b20488e012db0582 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 16 Jun 2025 21:07:30 -0700\nSubject: [PATCH 2/2] refactor: simplify bookmark event handling and improve repo picker navigation\n\n---\n packages/nostr-git                         |  2 +-\n src/routes/spaces/[relay]/git/+page.svelte | 38 +++++++++++++++++++++++---------------\n 2 files changed, 24 insertions(+), 16 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 9518809..39e7f19 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 95188095ac3ae7ee64691f95e2692dc106076f30\n+Subproject commit 39e7f19463192065806e6662078ddced44f22a37\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 29356f2..9facc8e 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -27,18 +27,20 @@\n \n   const bookmarkRelays = [url, ...Router.get().FromUser().getUrls()]\n \n-  const bookmarks = $derived.by(() =\u003e {\n-    const bookmarkFilter = {kinds: [NAMED_BOOKMARKS], authors: [pubkey.get()!]}\n-    return _derived(\n-      deriveEvents(repository, {filters: [bookmarkFilter]}),\n-      (events: TrustedEvent[]) =\u003e {\n-        if (events.length === 0) {\n-          load({relays: bookmarkRelays, filters: [bookmarkFilter]})\n-        }\n-        return events[0]\n-      },\n-    )\n-  })\n+  const bookmarkFilter = {\n+    kinds: [NAMED_BOOKMARKS],\n+    authors: [pubkey.get()!],\n+  }\n+\n+  const bookmarks = _derived(\n+    deriveEvents(repository, {filters: [bookmarkFilter]}),\n+    (events: TrustedEvent[]) =\u003e {\n+      if (events.length === 0) {\n+        load({relays: bookmarkRelays, filters: [bookmarkFilter]})\n+      }\n+      return events[0]\n+    },\n+  )\n \n   const relaysOfAddresses = $state(new Map\u003cstring, string\u003e())\n \n@@ -48,7 +50,7 @@\n       const dTagValues: string[] = []\n       const authors: string[] = []\n       const relayHints: string[] = []\n-      aTagList.forEach(([letter, value, relayHint]) =\u003e {\n+      aTagList.forEach(([_, value, relayHint]) =\u003e {\n         dTagValues.push(value.split(\":\")[2])\n         authors.push(value.split(\":\")[1])\n         relaysOfAddresses.set(value, relayHint || \"\")\n@@ -73,19 +75,25 @@\n         const hint = relaysOfAddresses.get(addressString) ?? relayHintFromEvent\n         return {address: addressString, event: repo, relayHint: hint}\n       })\n+    } else {\n+      return []\n     }\n   })\n \n   $effect(() =\u003e {\n-    if (loadedBookmarkedRepos) {\n+    if (loadedBookmarkedRepos.length \u003e 0) {\n       loading = false\n     }\n   })\n \n+  const back = () =\u003e history.back()\n+\n   const onAddRepo = () =\u003e {\n     pushModal(RepoPicker, {\n       selectedRepos: loadedBookmarkedRepos,\n-      onClose: () =\u003e {},\n+      onClose: () =\u003e {\n+        back()\n+      },\n     })\n   }\n \u003c/script\u003e\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-w3egfra2","title":"Selecting item on repo header unnecessarily scrolls the bar to beginning","description":"Annoying on mobile","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue"]}
{"id":"flotilla-wgxhmbj6","title":"Overview tab copy btns to repo details","description":"Because copy btns are awesome","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue"]}
{"id":"flotilla-wl11rp7g","title":"From 71d067af6cacca817c4bb12cc043c0af9a1bae1f Mon Sep 17 00:00:00 2001","description":"From 71d067af6cacca817c4bb12cc043c0af9a1bae1f Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 26 May 2025 19:20:33 -0700\nSubject: [PATCH 2/2] refactor: migrate to Svelte 5 reactivity and improve repo state management\n\n---\n .env                                                          |   2 +-\n packages/nostr-git                                            |   2 +-\n src/app.html                                                  |   4 ----\n src/app/components/GitActions.svelte                          |  19 ++++++++++++-------\n src/app/components/RepoPicker.svelte                          |  10 ++++++----\n src/routes/spaces/[relay]/+layout.svelte                      |   4 +++-\n src/routes/spaces/[relay]/git/+page.svelte                    |  92 ++++++++++++++++++++++++++++++++++++++++++++------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte       |  79 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte         | 272 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte    | 174 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------------------------------------------------------------------------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte  |  64 ++++++++++++++++++++++++++++------------------------------------\n src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte | 104 ++++++++++++++++++++++++++++++++++++--------------------------------------------------------------------\n svelte.config.js                                              |   1 -\n 13 files changed, 366 insertions(+), 461 deletions(-)\n\ndiff --git a/.env b/.env\nindex 1bbf3e0..bc4e21d 100644\n--- a/.env\n+++ b/.env\n@@ -5,7 +5,7 @@ VITE_PLATFORM_TERMS=\n VITE_PLATFORM_PRIVACY=\n VITE_PLATFORM_NAME=Budabit\n VITE_PLATFORM_LOGO=static/budabit.png\n-VITE_PLATFORM_RELAY=wss://budabit.nostr1.com\n+VITE_PLATFORM_RELAY=ws://192.168.1.101:7000\n VITE_PLATFORM_ACCENT=\"#D4AF37\"\n VITE_PLATFORM_SECONDARY=\"#EB5E28\"\n VITE_PLATFORM_DESCRIPTION=\"The Club for Builders in Freedom Tech.\"\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex b536fcc..1148da4 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit b536fcc8a64b876ad9bed5615f3a62bf77888c85\n+Subproject commit 1148da40e044d428c086d2085058225ef55d0986\ndiff --git a/src/app.html b/src/app.html\nindex 59f1871..4cab09b 100644\n--- a/src/app.html\n+++ b/src/app.html\n@@ -28,9 +28,5 @@\n   \u003c/head\u003e\n   \u003cbody data-sveltekit-preload-data=\"hover\"\u003e\n     \u003cdiv style=\"display: contents\"\u003e%sveltekit.body%\u003c/div\u003e\n-    \u003cscript\n-      defer\n-      data-domain=\"flotilla.social\"\n-      src=\"https://plausible.coracle.social/js/script.manual.js\"\u003e\u003c/script\u003e\n   \u003c/body\u003e\n \u003c/html\u003e\ndiff --git a/src/app/components/GitActions.svelte b/src/app/components/GitActions.svelte\nindex 9fce7d5..0b68096 100644\n--- a/src/app/components/GitActions.svelte\n+++ b/src/app/components/GitActions.svelte\n@@ -13,9 +13,9 @@\n   import {makeGitPath} from \"@app/routes\"\n   import Button from \"@src/lib/components/Button.svelte\"\n   import Link from \"@src/lib/components/Link.svelte\"\n-  import {onMount} from \"svelte\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {deriveEvents} from \"@welshman/store\"\n+  import {nthEq} from \"@welshman/lib\"\n \n   interface Props {\n     url: any\n@@ -26,6 +26,10 @@\n \n   const {url, event, showIssues = true, showActivity}: Props = $props()\n \n+  let loadingIssues = $state(true)\n+\n+  const [tagId, ...relays] = event.tags.find(nthEq(0, \"relays\")) || []\n+\n   const issueFilter = {\n     kinds: [GIT_ISSUE],\n     \"#a\": [Address.fromEvent(event).toString()],\n@@ -43,12 +47,13 @@\n     }\n   }\n \n-  let loadingIssues = $state(false)\n-\n-\n-  onMount(() =\u003e {\n-    if (showIssues) {\n-      load({relays: [url], filters: [issueFilter]})\n+  $effect(() =\u003e {\n+    if (event) {\n+      if (showIssues) {\n+        load({relays: relays, filters: [issueFilter]}).then(() =\u003e {\n+          loadingIssues = false\n+        })\n+      }\n     }\n   })\n \ndiff --git a/src/app/components/RepoPicker.svelte b/src/app/components/RepoPicker.svelte\nindex fb344eb..bfcc901 100644\n--- a/src/app/components/RepoPicker.svelte\n+++ b/src/app/components/RepoPicker.svelte\n@@ -35,8 +35,8 @@\n   import {load} from \"@welshman/net\"\n \n   const url = decodeRelay($page.params.relay)\n-  const {\n-    selectedRepos,\n+  let {\n+    selectedRepos = $bindable(),\n   }: {\n     selectedRepos: Array\u003c{address: string; event: TrustedEvent; relayHint: string}\u003e\n   } = $props()\n@@ -168,12 +168,12 @@\n     })\n \n     $shouldReloadRepos = true\n-\n+    //selectedRepos = localSelectedReposState\n     goto(makeGitPath(url))\n   }\n \n   onMount(() =\u003e {\n-    const relays = [url, ...Router.get().FromUser().getUrls()];\n+    const relays = [url, ...Router.get().FromUser().getUrls()]\n     load({\n       relays,\n       filters,\n@@ -208,6 +208,8 @@\n     } else {\n       localSelectedReposState = localSelectedReposState.filter(r =\u003e r.address !== address)\n     }\n+    console.log(\"localSelectedReposState\", localSelectedReposState)\n+    selectedRepos.push(...localSelectedReposState)\n   }\n \u003c/script\u003e\n \ndiff --git a/src/routes/spaces/[relay]/+layout.svelte b/src/routes/spaces/[relay]/+layout.svelte\nindex 2906ab0..d05f571 100644\n--- a/src/routes/spaces/[relay]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/+layout.svelte\n@@ -54,7 +54,9 @@\n     checkConnection()\n \n     // Prime our cache so inputs show up quickly\n-    getUploadUrl(url)\n+    // Commented out to prevent warning over no blossom server endpoint\n+    // function doesn't seem to do what the comment says it does\n+    // getUploadUrl(url)\n \n     const relays = [url]\n     const since = ago(WEEK)\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 7b6604d..87479bf 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -9,7 +9,7 @@\n     type TrustedEvent,\n   } from \"@welshman/util\"\n   import {GIT_REPO} from \"@src/lib/util\"\n-  import {userMutes} from \"@welshman/app\"\n+  import {repository, userMutes} from \"@welshman/app\"\n   import {fly} from \"@lib/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n@@ -19,64 +19,61 @@\n   import GitItem from \"@app/components/GitItem.svelte\"\n   import RepoPicker from \"@app/components/RepoPicker.svelte\"\n   import {decodeRelay} from \"@app/state\"\n-  import {setChecked} from \"@app/notifications\"\n   import {pushModal} from \"@app/modal\"\n   import {load} from \"@welshman/net\"\n   import {pubkey} from \"@welshman/app\"\n   import {getAddressTags} from \"@welshman/util\"\n   import {Router} from \"@welshman/router\"\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n+  import {deriveEvents} from \"@welshman/store\"\n+  import {derived as _derived} from \"svelte/store\"\n \n   const url = decodeRelay($page.params.relay)\n \n-  const mutedPubkeys = getPubkeyTagValues(getListTags($userMutes))\n-  const repos: TrustedEvent[] = $state([])\n-\n   let loading = $state(true)\n-  let loadedBookmarkedRepos: Array\u003c{address: string; event: TrustedEvent; relayHint: string}\u003e = []\n \n-  async function loadBookmarkedRepos() {\n-    repos.length = 0\n-    loading = true\n-    // --- Logging bookmark filter and relays ---\n-    const bookmarkFilter = { kinds: [NAMED_BOOKMARKS], authors: [pubkey.get()!] };\n-    const bookmarkRelays = [url, ...Router.get().FromUser().getUrls()];\n-    let bookmark = [];\n-    try {\n-      bookmark = await load({\n-        relays: bookmarkRelays,\n-        filters: [bookmarkFilter],\n-      });\n-    } catch (e) {\n-      loading = false;\n-      return;\n-    }\n-    if (bookmark.length \u003e 0) {\n-      const aTagList = getAddressTags(bookmark[0].tags)\n+  const bookmarkRelays = [url, ...Router.get().FromUser().getUrls()]\n+\n+  const bookmarks = $derived.by(() =\u003e {\n+    const bookmarkFilter = {kinds: [NAMED_BOOKMARKS], authors: [pubkey.get()!]}\n+    return _derived(\n+      deriveEvents(repository, {filters: [bookmarkFilter]}),\n+      (events: TrustedEvent[]) =\u003e {\n+        if (events.length === 0) {\n+          load({relays: bookmarkRelays, filters: [bookmarkFilter]})\n+        }\n+        return events[0]\n+      },\n+    )\n+  })\n+\n+  const relaysOfAddresses = $state(new Map\u003cstring, string\u003e())\n+\n+  const repos = $derived.by(() =\u003e {\n+    if ($bookmarks) {\n+      const aTagList = getAddressTags($bookmarks.tags)\n       const dTagValues: string[] = []\n       const authors: string[] = []\n       const relayHints: string[] = []\n-      const relaysOfAddresses: Map\u003cstring, string\u003e = new Map()\n       aTagList.forEach(([letter, value, relayHint]) =\u003e {\n         dTagValues.push(value.split(\":\")[2])\n         authors.push(value.split(\":\")[1])\n         relaysOfAddresses.set(value, relayHint || \"\")\n         if (relayHint \u0026\u0026 !relayHints.includes(relayHint)) relayHints.push(relayHint)\n       })\n-      const repoFilter = { kinds: [GIT_REPO], authors, \"#d\": dTagValues };\n-      try {\n-        await load({\n-          relays: relayHints,\n-          filters: [repoFilter],\n-          onEvent(event, url) {\n-            repos.push(event);\n-          },\n-        });\n-      } catch (e) {\n-        loading = false;\n-        return;\n-      }\n-      loadedBookmarkedRepos = repos.map(repo =\u003e {\n+      const repoFilter = {kinds: [GIT_REPO], authors, \"#d\": dTagValues}\n+      return _derived(deriveEvents(repository, {filters: [repoFilter]}), events =\u003e {\n+        if (events.length === 0) {\n+          load({relays: relayHints, filters: [repoFilter]})\n+        }\n+        return events\n+      })\n+    }\n+  })\n+\n+  const loadedBookmarkedRepos = $derived.by(() =\u003e {\n+    if ($repos) {\n+      return $repos.map(repo =\u003e {\n         const address = Address.fromEvent(repo)\n         const addressString = address.toString()\n         const relayHintFromEvent = Router.get().getRelaysForPubkey(repo.pubkey)?.[0]\n@@ -84,18 +81,17 @@\n         return {address: addressString, event: repo, relayHint: hint}\n       })\n     }\n-    loading = false\n-  }\n+  })\n \n   onMount(() =\u003e {\n-    loadBookmarkedRepos()\n-    return () =\u003e setChecked($page.url.pathname)\n+    loading = false\n+    console.log(\"loadedBookmarkedRepos\", loadedBookmarkedRepos)\n   })\n \n   const onAddRepo = () =\u003e {\n     pushModal(RepoPicker, {\n       selectedRepos: loadedBookmarkedRepos,\n-      onClose: loadBookmarkedRepos,\n+      onClose: () =\u003e {},\n     })\n   }\n \u003c/script\u003e\n@@ -122,20 +118,20 @@\n \n \u003cPageContent\u003e\n   \u003cdiv class=\"flex flex-grow flex-col gap-2 overflow-auto p-2\"\u003e\n-    {#if loading || repos.length === 0}\n+    {#if loading}\n       \u003cp class=\"flex h-10 items-center justify-center py-20\" out:fly\u003e\n         \u003cSpinner {loading}\u003e\n           {#if loading}\n             Looking for Your Git Repos...\n-          {:else if repos.length === 0}\n+          {:else if !$repos || $repos.length === 0}\n             No Repos found.\n           {/if}\n         \u003c/Spinner\u003e\n       \u003c/p\u003e\n     {:else}\n-      {#each repos as repo (repo.id)}\n+      {#each loadedBookmarkedRepos! as repo (repo.event.id)}\n         \u003cdiv in:fly\u003e\n-          \u003cGitItem {url} event={repo} /\u003e\n+          \u003cGitItem {url} event={repo.event} /\u003e\n         \u003c/div\u003e\n       {/each}\n     {/if}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex ad22715..ef46a62 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -4,16 +4,81 @@\n   import {deriveNaddrEvent} from \"@app/state\"\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n   import {FileCode, GitBranch, CircleAlert, GitPullRequest, Book} from \"@lucide/svelte\"\n-  import {type RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n+  import {parseRepoAnnouncementEvent, type RepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n   import {setContext} from \"svelte\"\n+  import {deriveEvents} from \"@welshman/store\"\n+  import {relays, repository} from \"@welshman/app\"\n+  import {GIT_REPO_STATE} from \"@src/lib/util\"\n+  import {derived as _derived} from \"svelte/store\"\n+  import {Address, GIT_ISSUE, GIT_PATCH, type Filter} from \"@welshman/util\"\n+  import {load} from \"@welshman/net\"\n+  import {nthEq} from \"@welshman/lib\"\n \n   const {id, relay} = $page.params\n-  const encodeddRelay = encodeURIComponent(relay)\n-  const relayArray = Array.isArray(relay) ? relay : [relay]\n-  const eventStore = deriveNaddrEvent(id, relayArray)\n+\n   let {children} = $props()\n-  let activeTab: string | undefined = $page.url.pathname.split(\"/\").pop()\n+\n+  let eventStore = $state(deriveNaddrEvent(id, Array.isArray(relay) ? relay : [relay]))\n+\n+  const repoState = $derived.by(() =\u003e {\n+    if ($eventStore) {\n+      const repoEvent = parseRepoAnnouncementEvent($eventStore as RepoAnnouncementEvent)\n+      const address = repoEvent.repoId\n+      const repoStateFilter = [{kinds: [GIT_REPO_STATE], \"#d\": [address]}]\n+      const repoState = _derived(\n+        deriveEvents(repository, {filters: repoStateFilter}),\n+        events =\u003e events[0],\n+      )\n+      setContext(\"repo-state\", repoState)\n+      return repoState\n+    }\n+  })\n+\n+  const issues = $derived.by(() =\u003e {\n+    if ($eventStore) {\n+      const address = Address.fromEvent($eventStore).toString()\n+      const issueFilter = [{kinds: [GIT_ISSUE], \"#a\": [address]}]\n+      return deriveEvents(repository, {filters: issueFilter})\n+    }\n+  })\n+\n+  const patches = $derived.by(() =\u003e {\n+    if ($eventStore) {\n+      const address = Address.fromEvent($eventStore).toString()\n+      const patchFilter = [{kinds: [GIT_PATCH], \"#a\": [address]}]\n+      return deriveEvents(repository, {filters: patchFilter})\n+    }\n+  })\n+\n   setContext(\"repo-event\", eventStore)\n+\n+  const repo = $state({\n+    repo: eventStore,\n+    state: () =\u003e repoState,\n+    issues: () =\u003e issues,\n+    patches: () =\u003e patches,\n+  })\n+\n+  setContext(\"repo\", repo)\n+\n+  let activeTab: string | undefined = $page.url.pathname.split(\"/\").pop()\n+  const encodeddRelay = encodeURIComponent(relay)\n+\n+  $effect(async () =\u003e {\n+    if ($eventStore) {\n+      const repoEvent = parseRepoAnnouncementEvent($eventStore as RepoAnnouncementEvent)\n+      const address = repoEvent.repoId\n+      const repoStateFilter: Filter = {kinds: [GIT_REPO_STATE], \"#d\": [address]}\n+      const issuesFilter: Filter = {kinds: [GIT_ISSUE], \"#a\": [address]}\n+      const patchesFilter: Filter = {kinds: [GIT_PATCH], \"#a\": [address]}\n+      const [tagId, ...relays] = $eventStore.tags.find(nthEq(0, \"relays\")) ?? []\n+\n+      await load({\n+        relays: relays,\n+        filters: [issuesFilter, patchesFilter, repoStateFilter],\n+      })\n+    }\n+  })\n \u003c/script\u003e\n \n \u003cPageContent class=\"flex flex-grow flex-col gap-2 overflow-auto p-8\"\u003e\n@@ -23,9 +88,9 @@\n     \u003cdiv class=\"p-4 text-center text-red-500\"\u003eRepository not found.\u003c/div\u003e\n   {:else}\n     \u003cRepoHeader event={$eventStore as RepoAnnouncementEvent} {activeTab}\u003e\n-      {#snippet children(activeTab)}\n+      {#snippet children(activeTab: string)}\n         \u003cRepoTab\n-          tabValue=\"overview\"\n+          tabValue={id}\n           label=\"Overview\"\n           href={`/spaces/${encodeddRelay}/git/${id}`}\n           {activeTab}\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 5aa3049..91516ec 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -1,56 +1,58 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {getContext, onMount, tick} from \"svelte\"\n-  import type {Readable} from \"svelte/store\"\n-  import {getRepoFileContentFromEvent} from \"@nostr-git/core\"\n+  import {getContext} from \"svelte\"\n+  import {derived as _derived, type Readable} from \"svelte/store\"\n+  import {getRepoFileContentFromEvent, listBranchesFromEvent} from \"@nostr-git/core\"\n   import markdownit from \"markdown-it\"\n-\n-  import {page} from \"$app/stores\"\n-  import {sortBy, nthEq, now} from \"@welshman/lib\"\n+  import {sortBy} from \"@welshman/lib\"\n   import {\n-    Address,\n-    GIT_ISSUE,\n     GIT_STATUS_CLOSED,\n     GIT_STATUS_COMPLETE,\n     GIT_STATUS_DRAFT,\n     GIT_STATUS_OPEN,\n-    type Filter,\n     type TrustedEvent,\n   } from \"@welshman/util\"\n   import {repository} from \"@welshman/app\"\n   import {deriveEvents} from \"@welshman/store\"\n-  import {decodeRelay} from \"@app/state\"\n-  import {setChecked} from \"@app/notifications\"\n-  import {load} from \"@welshman/net\"\n-  import {nip19} from \"nostr-tools\"\n   import {getRootEventTagValue} from \"@src/lib/util\"\n-  import Divider from \"@src/lib/components/Divider.svelte\"\n-  import type {AddressPointer} from \"nostr-tools/nip19\"\n-  import {Router} from \"@welshman/router\"\n   import {Card} from \"@nostr-git/ui\"\n-  import {GitBranch, GitCommit, Users} from \"@lucide/svelte\"\n-\n-  const {relay, id} = $page.params\n-  const url = decodeRelay(relay)\n-\n-  let repoEvent: TrustedEvent | undefined = $state(undefined)\n+  import {CircleAlert, GitBranch, GitPullRequest, Users} from \"@lucide/svelte\"\n+  import {\n+    parseRepoAnnouncementEvent,\n+    parseRepoStateEvent,\n+    type RepoAnnouncementEvent,\n+    type RepoStateEvent,\n+  } from \"@nostr-git/shared-types\"\n \n-  let gitworkshopLink = $state(\"\")\n+  const eventStore = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n+  const repo = getContext\u003c{\n+    repo: Readable\u003cTrustedEvent\u003e\n+    state: () =\u003e Readable\u003cRepoStateEvent\u003e\n+    issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+  }\u003e(\"repo\")\n \n-  let statusSub: Subscription\n-  let newIssuesSub: Subscription\n-  const statusOfNewIssuesSubs: Subscription[] = []\n+  let loading = $state(false)\n \n-  let repoRelays: string[] = $state([])\n+  const repoState = repo.state()\n+  const issues = repo.issues()\n+  const patches = repo.patches()\n \n-  const back = () =\u003e history.back()\n+  let issueCount = $derived.by(() =\u003e $issues?.length ?? 0)\n \n-  const issues = $derived.by(() =\u003e {\n-    if (repoEvent) {\n-      const address = Address.fromEvent(repoEvent).toString()\n-      const issueFilter = [{kinds: [GIT_ISSUE], \"#a\": [address]}]\n+  let branchCount = $derived.by(() =\u003e {\n+    if ($repoState) {\n+      const repo = parseRepoStateEvent($repoState as RepoStateEvent)\n+      return repo.refs.length\n+    }\n+    return 0\n+  })\n \n-      return deriveEvents(repository, {filters: issueFilter})\n+  let contributorCount = $derived.by(() =\u003e {\n+    if ($eventStore) {\n+      const repo = parseRepoAnnouncementEvent($eventStore as RepoAnnouncementEvent)\n+      return repo.maintainers?.length ?? 0\n     }\n+    return 0\n   })\n \n   const statuses = $derived.by(() =\u003e {\n@@ -58,7 +60,7 @@\n       const statusFilter = [\n         {\n           kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n-          \"#e\": $issues.map(issue =\u003e issue.id),\n+          \"#e\": $issues.map((issue: TrustedEvent) =\u003e issue.id),\n         },\n       ]\n       return deriveEvents(repository, {filters: statusFilter})\n@@ -93,123 +95,33 @@\n     }\n   })\n \n-  let loading = $state(false)\n-  let failedToLoad = $state(false)\n-\n-  const initialize = async () =\u003e {\n-    setTimeout(() =\u003e {\n-      if (loading) failedToLoad = true\n-    }, 8000)\n-    loading = true\n-    await tick()\n-    const naddr = nip19.decode(id).data as AddressPointer\n-    const backupRelays = [...Router.get().FromPubkey(naddr.pubkey).getUrls()]\n-    const events = await load({\n-      relays: naddr.relays ?? backupRelays,\n-      filters: [\n-        {\n-          authors: [naddr.pubkey],\n-          kinds: [naddr.kind],\n-          \"#d\": [naddr.identifier],\n-        },\n-      ],\n-    })\n-    if (events.length \u003e 0) {\n-      repoEvent = events[0]\n-      const repoNpub = nip19.npubEncode(repoEvent.pubkey)\n-      const repoDtag = repoEvent.tags.find(nthEq(0, \"d\"))?.[1]\n-      gitworkshopLink = `https://gitworkshop.dev/${repoNpub}/${repoDtag}`\n-      const address = Address.fromEvent(repoEvent).toString()\n-\n-      const [tagId, ...relays] =\n-        repoEvent.tags.find(nthEq(0, \"relays\")) ?? naddr.relays ?? backupRelays\n-\n-      repoRelays = relays\n-\n-      const issuesFilter: Filter = {\n-        kinds: [GIT_ISSUE],\n-        \"#a\": [address],\n-      }\n-\n-      const issues = await load({\n-        relays: repoRelays,\n-        filters: [issuesFilter],\n-      })\n-\n-      loading = false\n-      await tick()\n-\n-      const statusesOfAllIssuesFilter: Filter = {\n-        kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n-        \"#e\": issues.map(issue =\u003e issue.id),\n-      }\n-\n-      const statuses = await load({\n-        relays: relays,\n-        filters: [statusesOfAllIssuesFilter],\n-      })\n-\n-      statusesOfAllIssuesFilter.since = now()\n-\n-      statusSub = subscribe({\n-        relays: repoRelays,\n-        filters: [statusesOfAllIssuesFilter],\n-        // onEvent: (status) =\u003e console.log(\"New status received\", status)\n-      })\n-\n-      issuesFilter.since = now()\n-\n-      newIssuesSub = subscribe({\n-        relays: relays,\n-        filters: [issuesFilter],\n-        onEvent: (issue: TrustedEvent) =\u003e {\n-          const statusFilter: Filter[] = [\n-            {\n-              kinds: [GIT_STATUS_OPEN, GIT_STATUS_COMPLETE, GIT_STATUS_CLOSED, GIT_STATUS_DRAFT],\n-              \"#e\": [issue.id],\n-              since: now(),\n-            },\n-          ]\n-          const sub = subscribe({\n-            relays: relays,\n-            filters: statusFilter,\n-            onEvent: (status: TrustedEvent) =\u003e {\n-              // console.log(\"Received new status\",status)\n-            },\n-          })\n-          statusOfNewIssuesSubs.push(sub)\n-        },\n-      })\n-    }\n-  }\n-\n-  onMount(() =\u003e {\n-    initialize()\n-\n-    return () =\u003e {\n-      if (statusSub) {\n-        statusSub.close()\n-      }\n-      if (newIssuesSub) {\n-        newIssuesSub.close()\n-      }\n-      if (statusOfNewIssuesSubs.length \u003e 0) {\n-        statusOfNewIssuesSubs.forEach(s =\u003e {\n-          s.close()\n-        })\n-      }\n-      setChecked($page.url.pathname)\n+  const mainBranch = $derived.by(async () =\u003e {\n+    if ($repoState) {\n+      const repo = parseRepoStateEvent($repoState as RepoStateEvent)\n+      console.log(repo)\n+      return repo.head\n+    } else {\n+      const branches = await listBranchesFromEvent({repoEvent: $eventStore})\n+      console.log(branches)\n+      return branches?.[0].name\n     }\n   })\n \n   const stats = [\n-    {label: \"Active Branches\", value: \"5\", icon: GitBranch},\n-    {label: \"Total Commits\", value: \"241\", icon: GitCommit},\n-    {label: \"Contributors\", value: \"15\", icon: Users},\n+    {\n+      label: \"Branches\",\n+      value: () =\u003e branchCount,\n+      icon: GitBranch,\n+    },\n+    {label: \"Contributors\", value: () =\u003e contributorCount, icon: Users},\n+    {label: \"Issues\", value: () =\u003e issueCount, icon: CircleAlert},\n+    {\n+      label: \"Patches\",\n+      value: () =\u003e $patches.length,\n+      icon: GitPullRequest,\n+    },\n   ]\n \n-  const eventStore = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n-\n   let readme = $state\u003cstring | undefined\u003e(undefined)\n   let renderedReadme = $state\u003cstring | undefined\u003e(undefined)\n   const md = markdownit({\n@@ -219,10 +131,10 @@\n   })\n \n   $effect(async () =\u003e {\n-    if (!$eventStore) return\n+    if (!mainBranch) return\n     readme = await getRepoFileContentFromEvent({\n       repoEvent: $eventStore,\n-      branch: \"master\",\n+      branch: (await mainBranch)?.split(\"/\").pop() || \"master\",\n       path: \"README.md\",\n     })\n     renderedReadme = readme ? md.render(readme) : \"\"\n@@ -230,53 +142,57 @@\n \u003c/script\u003e\n \n \u003cdiv class=\"relative flex flex-col gap-3 px-2\"\u003e\n-  \u003cdiv class=\"grid grid-cols-3 gap-4\"\u003e\n+  \u003cdiv class=\"grid grid-cols-4 gap-4\"\u003e\n     {#each stats as stat}\n       \u003cCard class=\"p-4\"\u003e\n         \u003cdiv class=\"flex items-center gap-2\"\u003e\n           \u003cstat.icon class=\"h-5 w-5 text-muted-foreground\" /\u003e\n           \u003cdiv\u003e\n             \u003cp class=\"text-sm text-muted-foreground\"\u003e{stat.label}\u003c/p\u003e\n-            \u003cp class=\"text-2xl font-semibold\"\u003e{stat.value}\u003c/p\u003e\n+            \u003cp class=\"text-2xl font-semibold\"\u003e{stat.value()}\u003c/p\u003e\n           \u003c/div\u003e\n         \u003c/div\u003e\n       \u003c/Card\u003e\n     {/each}\n   \u003c/div\u003e\n   {#if renderedReadme}\n-    \u003cdiv class=\"prose prose-slate max-w-none bg-muted border border-muted rounded-xl shadow-md p-8 overflow-x-auto dark:prose-invert prose-headings:font-bold prose-headings:mb-3 prose-headings:mt-8 prose-h1:text-3xl prose-h2:text-2xl prose-h3:text-xl prose-p:leading-relaxed prose-p:my-4 prose-ul:my-4 prose-ol:my-4 prose-li:marker:text-primary prose-blockquote:border-l-4 prose-blockquote:border-accent prose-blockquote:bg-accent/10 prose-blockquote:p-4 prose-blockquote:rounded prose-blockquote:my-6 prose-table:my-6 prose-table:border prose-table:border-muted prose-th:bg-muted/50 prose-th:font-semibold prose-th:p-3 prose-td:p-3 prose-pre:bg-zinc-900 prose-pre:rounded-lg prose-pre:p-4 prose-code:bg-zinc-800 prose-code:rounded-md prose-code:px-2 prose-code:py-1 prose-code:text-sm\"\u003e\n+    \u003cdiv\n+      class=\"prose-slate dark:prose-invert prose-headings:font-bold prose-headings:mb-3 prose-headings:mt-8 prose-h1:text-3xl prose-h2:text-2xl prose-h3:text-xl prose-p:leading-relaxed prose-p:my-4 prose-ul:my-4 prose-ol:my-4 prose-li:marker:text-primary prose-blockquote:border-l-4 prose-blockquote:border-accent prose-blockquote:bg-accent/10 prose-blockquote:p-4 prose-blockquote:rounded prose-blockquote:my-6 prose-table:my-6 prose-table:border prose-table:border-muted prose-th:bg-muted/50 prose-th:font-semibold prose-th:p-3 prose-td:p-3 prose-pre:bg-zinc-900 prose-pre:rounded-lg prose-pre:p-4 prose-code:bg-zinc-800 prose-code:rounded-md prose-code:px-2 prose-code:py-1 prose-code:text-sm prose max-w-none overflow-x-auto rounded-xl border border-muted bg-muted p-8 shadow-md\"\u003e\n       {@html renderedReadme}\n     \u003c/div\u003e\n   {:else}\n     \u003cdiv class=\"text-muted-foreground\"\u003eNo README.md found.\u003c/div\u003e\n   {/if}\n \n-\u003cstyle\u003e\n-  /* Further polish for markdown rendering in README */\n-  .prose h1, .prose h2, .prose h3 {\n-    letter-spacing: -0.01em;\n-  }\n-  .prose h1 {\n-    border-bottom: 1px solid theme('colors.border');\n-    padding-bottom: 0.3em;\n-  }\n-  .prose blockquote {\n-    border-left-width: 4px;\n-    border-color: var(--tw-prose-accent);\n-    background: var(--tw-prose-accent-bg, rgba(59,130,246,0.05));\n-    padding: 1rem;\n-    border-radius: 0.5rem;\n-    margin: 1.5rem 0;\n-  }\n-  .prose pre {\n-    margin: 1.5rem 0;\n-  }\n-  .prose table {\n-    border-radius: 0.5rem;\n-    overflow: hidden;\n-  }\n-  .prose th, .prose td {\n-    border: 1px solid theme('colors.zinc.700');\n-  }\n-\u003c/style\u003e\n+  \u003cstyle\u003e\n+    /* Further polish for markdown rendering in README */\n+    .prose h1,\n+    .prose h2,\n+    .prose h3 {\n+      letter-spacing: -0.01em;\n+    }\n+    .prose h1 {\n+      border-bottom: 1px solid theme(\"colors.border\");\n+      padding-bottom: 0.3em;\n+    }\n+    .prose blockquote {\n+      border-left-width: 4px;\n+      border-color: var(--tw-prose-accent);\n+      background: var(--tw-prose-accent-bg, rgba(59, 130, 246, 0.05));\n+      padding: 1rem;\n+      border-radius: 0.5rem;\n+      margin: 1.5rem 0;\n+    }\n+    .prose pre {\n+      margin: 1.5rem 0;\n+    }\n+    .prose table {\n+      border-radius: 0.5rem;\n+      overflow: hidden;\n+    }\n+    .prose th,\n+    .prose td {\n+      border: 1px solid theme(\"colors.zinc.700\");\n+    }\n+  \u003c/style\u003e\n \u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex 709f357..1383488 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -1,121 +1,90 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {getContext, onMount} from \"svelte\"\n-  import {FileView, Tabs, TabsList, TabsTrigger} from \"@nostr-git/ui\"\n+  import {getContext} from \"svelte\"\n+  import {FileView} from \"@nostr-git/ui\"\n   import {GitBranch} from \"@lucide/svelte\"\n-  import {listRepoFilesFromEvent, type FileEntry} from \"@nostr-git/core\"\n-  import {load} from \"@welshman/net\"\n-  import {nip19} from \"nostr-tools\"\n-  import {GIT_REPO_STATE} from \"@src/lib/util\"\n-  import {parseRepoStateEvent, type TrustedEvent} from \"@nostr-git/shared-types\"\n+  import {\n+    listRepoFilesFromEvent,\n+    type FileEntry,\n+    listBranchesFromEvent,\n+  } from \"@nostr-git/core\"\n+  import {\n+    parseRepoAnnouncementEvent,\n+    parseRepoStateEvent,\n+    type RepoAnnouncementEvent,\n+    type RepoStateEvent,\n+    type TrustedEvent,\n+    type RepoEvent,\n+  } from \"@nostr-git/shared-types\"\n   import {page} from \"$app/stores\"\n   import type {Readable} from \"svelte/store\"\n-  import {nthEq} from \"@welshman/lib\"\n   import Popover from \"@src/lib/components/Popover.svelte\"\n   import Button from \"@src/lib/components/Button.svelte\"\n   import {fly} from \"svelte/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n \n   const {id, relay} = $page.params\n-  const eventStore = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n+  const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n+  const repoStateEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-state-event\")\n+  const repo = getContext\u003c{\n+    repo: Readable\u003cTrustedEvent\u003e\n+    state: () =\u003e Readable\u003cRepoStateEvent\u003e\n+    issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+  }\u003e(\"repo\")\n \n   // UI state\n-  let loading = true\n-  let error: string | null = null\n-  let files: FileEntry[] = []\n-  let branches: {name: string; isDefault: boolean}[] = []\n-  let selectedBranch = \"master\"\n-  let fallbackToBranches = false\n+  let loading = $state(true)\n+  let error: string | null = $state(null)\n+  let files: FileEntry[] = $state([])\n+  let fallbackToBranches = $state(false)\n \n-  async function tryLoadRepoStateEvent() {\n-    try {\n-      loading = true\n-      error = null\n-      fallbackToBranches = false\n-      files = []\n-      branches = []\n+  const repoState = repo.state()\n \n-      const decoded = nip19.decode(id).data as {\n-        pubkey: string\n-        kind: number\n-        identifier: string\n-      }\n-      const filters = [\n-        {\n-          authors: [decoded.pubkey],\n-          kinds: [GIT_REPO_STATE],\n-          \"#d\": [decoded.identifier],\n-        },\n-      ]\n-      const [tagId, ...relays] = $eventStore.tags.find(nthEq(0, \"relays\")) || []\n-      const events = await load({relays: relays, filters})\n-      const event = events[0]\n-      if (event) {\n-        //files = await listRepoFilesFromEvent({repoEvent: event, branch: selectedBranch})\n-        try {\n-          const repoStateEvent = parseRepoStateEvent(event)\n-          branches = repoStateEvent.refs.map(branch =\u003e ({name: branch.ref, isDefault: false}))\n-        } catch (e) {\n-          branches = [{name: \"master\", isDefault: true}]\n-        }\n-        loading = false\n-        return\n-      } else {\n-        fallbackToBranches = true\n-        await loadBranchesFallback()\n-      }\n-    } catch (e) {\n-      error = (e as Error).message || \"Failed to load repository event.\"\n-      loading = false\n+  let branches = $derived.by(() =\u003e {\n+    if ($repoState) {\n+      const state = parseRepoStateEvent($repoState as RepoStateEvent)\n+      return state.refs.map(ref =\u003e ({name: ref.ref, commit: ref.commit, lineage: ref.lineage}))\n+    } else {\n+      return listBranchesFromEvent({repoEvent: $repoEvent})\n     }\n-  }\n+  })\n \n-  async function loadBranchesFallback() {\n-    try {\n-      branches = [{name: \"master\", isDefault: true}]\n-      selectedBranch = \"master\"\n-      // No repo event, so no files\n-      files = []\n-      loading = false\n-    } catch (e) {\n-      error = (e as Error).message || \"Failed to load branches.\"\n-      loading = false\n+  let selectedBranch = $derived.by(async () =\u003e {\n+    if ($repoState) {\n+      const repo = parseRepoStateEvent($repoState as RepoStateEvent)\n+      return repo.head\n+    } else {\n+      const branches = await listBranchesFromEvent({repoEvent: $repoEvent})\n+      return branches?.[0].name\n     }\n-  }\n+  })\n \n-  // Reload files when branch changes (if event loaded)\n-  async function onBranchChange() {\n-    if (!fallbackToBranches) {\n-      try {\n-        loading = true\n-        files = []\n-        const decoded = nip19.decode(id).data as {\n-          pubkey: string\n-          kind: number\n-          identifier: string\n-        }\n-        const filters = [\n-          {\n-            authors: [decoded.pubkey],\n-            kinds: [GIT_REPO_STATE],\n-            \"#d\": [decoded.identifier],\n-          },\n-        ]\n-        const events = await load({relays: [relay], filters})\n-        const event = events[0]\n-        if (event) {\n-          files = await listRepoFilesFromEvent({repoEvent: event, branch: selectedBranch})\n-        } else {\n-          files = []\n-        }\n-        loading = false\n-      } catch (e) {\n-        error = (e as Error).message || \"Failed to load files for branch.\"\n-        loading = false\n-      }\n+let selectedBranchValue = $state\u003cstring | undefined\u003e(undefined)\n+\n+  $effect(async () =\u003e {\n+    if (selectedBranch) {\n+      selectedBranchValue = await selectedBranch\n+      files = await listRepoFilesFromEvent({\n+        repoEvent: $repoEvent as RepoEvent,\n+        branch: selectedBranchValue,\n+      })\n     }\n-  }\n+  })\n+\n+  $effect(async () =\u003e {\n+    if ($repoState) {\n+      loading = false\n+      files = await listRepoFilesFromEvent({\n+        repoEvent: $repoEvent as RepoEvent,\n+        branch: await selectedBranch,\n+      })\n+    } else {\n+      console.log($repoEvent)\n+      branches = await listBranchesFromEvent({repoEvent: $repoEvent})\n+      loading = false\n+    }\n+  })\n \n-  let showMenu = false\n+  let showMenu = $state(false)\n \n   const toggleMenu = () =\u003e {\n     showMenu = !showMenu\n@@ -124,10 +93,6 @@\n   const openMenu = () =\u003e {\n     showMenu = true\n   }\n-\n-  onMount(() =\u003e {\n-    tryLoadRepoStateEvent()\n-  })\n \u003c/script\u003e\n \n \u003cdiv class=\"rounded-lg border border-border bg-card\"\u003e\n@@ -144,12 +109,11 @@\n         \u003cGitBranch class=\"h-5 w-5 text-muted-foreground\" /\u003e\n         \u003cselect\n           class=\"rounded border border-border bg-secondary px-2 py-1\"\n-          bind:value={selectedBranch}\n+          bind:value={selectedBranchValue}\n           disabled\u003e\n           {#each branches as branch}\n             \u003coption value={branch.name}\u003e\n               {branch.name}\n-              {branch.isDefault ? \" (default)\" : \"\"}\n             \u003c/option\u003e\n           {/each}\n         \u003c/select\u003e\n@@ -163,7 +127,7 @@\n           onclick={openMenu}\n           class=\"flex items-center gap-3 text-left transition-all hover:text-base-content\"\u003e\n           \u003cGitBranch class=\"h-5 w-5 text-muted-foreground\" /\u003e\n-          \u003cspan\u003e{selectedBranch}\u003c/span\u003e\n+          \u003cspan\u003e{selectedBranchValue}\u003c/span\u003e\n           \u003cIcon icon=\"alt-arrow-down\" /\u003e\n         \u003c/Button\u003e\n         {#if showMenu}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex 6751668..d3d803b 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -1,69 +1,61 @@\n \u003cscript lang=\"ts\"\u003e\n   import {Button, IssueCard} from \"@nostr-git/ui\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n-  import {page} from \"$app/stores\"\n   import {\n     Address,\n     COMMENT,\n-    getListTags,\n-    getPubkeyTagValues,\n     GIT_ISSUE,\n     type TrustedEvent,\n   } from \"@welshman/util\"\n-  import {getContext, onMount} from \"svelte\"\n-  import {setChecked} from \"@src/app/notifications\"\n+  import {getContext} from \"svelte\"\n   import {nthEq} from \"@welshman/lib\"\n-  import {deriveProfile, userMutes} from \"@welshman/app\"\n+  import {deriveProfile, repository} from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n-  import type {Readable} from \"svelte/store\"\n   import {makeFeed} from \"@src/app/requests\"\n+  import type {Readable} from \"svelte/store\"\n+  import {type RepoStateEvent} from \"@nostr-git/shared-types\"\n \n-  const repo = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n-  const [_, ...relays] = $repo.tags.find(nthEq(0, \"relays\")) || []\n-  const mutedPubkeys = getPubkeyTagValues(getListTags($userMutes))\n+  const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n-  const issueFilter = {\n-    kinds: [GIT_ISSUE, COMMENT],\n-    \"#a\": [Address.fromEvent($repo).toString()],\n-  }\n+  const repo = getContext\u003c{\n+    repo: Readable\u003cTrustedEvent\u003e\n+    state: () =\u003e Readable\u003cRepoStateEvent\u003e\n+    issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+  }\u003e(\"repo\")\n \n-  const issues: TrustedEvent[] = $state([])\n+  let issues = $derived(repo.issues())\n   const comments: TrustedEvent[] = $state([])\n \n   let loading = $state(true)\n   let element: HTMLElement | undefined = $state()\n \n-  onMount(() =\u003e {\n+  $effect(() =\u003e {\n+    if (!issues) {\n+      return\n+    }\n+\n+    const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || []\n+\n+    const issueFilter = {\n+      kinds: [GIT_ISSUE, COMMENT],\n+      \"#a\": [Address.fromEvent($repoEvent).toString()],\n+    }\n+\n     const {cleanup} = makeFeed({\n       element: element!,\n       relays: relays,\n       feedFilters: [issueFilter],\n       subscriptionFilters: [issueFilter],\n-      initialEvents: [],\n-      onEvent: event =\u003e {\n-        if (event.kind === GIT_ISSUE \u0026\u0026 !mutedPubkeys.includes(event.pubkey)) {\n-          issues.push(event)\n-        }\n-\n-        if (event.kind === COMMENT \u0026\u0026 !mutedPubkeys.includes(event.pubkey)) {\n-          comments.push(event)\n-        }\n-      },\n+      initialEvents: $issues,\n       onExhausted: () =\u003e {\n         loading = false\n       },\n     })\n-\n-    return () =\u003e {\n-      cleanup()\n-      setChecked($page.url.pathname)\n-    }\n   })\n \u003c/script\u003e\n \n \u003cdiv bind:this={element}\u003e\n-  \u003cdiv\n-    class=\"z-10 sticky top-0 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n+  \u003cdiv class=\"z-10 sticky top-0 mb-4 flex items-center justify-between py-4 backdrop-blur\"\u003e\n     \u003cdiv\u003e\n       \u003ch2 class=\"text-xl font-semibold\"\u003eIssues\u003c/h2\u003e\n       \u003cp class=\"text-sm text-muted-foreground\"\u003eTrack bugs and feature requests\u003c/p\u003e\n@@ -92,15 +84,15 @@\n         {/if}\n       \u003c/Spinner\u003e\n     \u003c/div\u003e\n-  {:else if issues.length === 0}\n+  {:else if $issues.length === 0}\n     \u003cdiv class=\"flex flex-col items-center justify-center py-12 text-gray-500\"\u003e\n       \u003cSearchX class=\"mb-2 h-8 w-8\" /\u003e\n       No issues found.\n     \u003c/div\u003e\n   {:else}\n     \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n-      {#each issues as issue (issue.id)}\n-        \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey, relayArray)} /\u003e\n+      {#each $issues as issue (issue.id)}\n+        \u003cIssueCard event={issue} author={deriveProfile(issue.pubkey, relays)} /\u003e\n       {/each}\n     \u003c/div\u003e\n   {/if}\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\nindex 8707b08..99618ed 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/+page.svelte\n@@ -1,74 +1,55 @@\n \u003cscript lang=\"ts\"\u003e\n-  import {page} from \"$app/state\"\n+  import {Button, IssueCard, PatchCard} from \"@nostr-git/ui\"\n   import {Funnel, Plus, SearchX} from \"@lucide/svelte\"\n-  import {Button, PatchCard} from \"@nostr-git/ui\"\n-  import {setChecked} from \"@src/app/notifications\"\n-  import {onMount} from \"svelte\"\n-  import {GIT_PATCH, type TrustedEvent} from \"@welshman/util\"\n-  import {Address} from \"@welshman/util\"\n-  import {load} from \"@welshman/net\"\n+  import {Address, GIT_PATCH, type TrustedEvent} from \"@welshman/util\"\n+  import {getContext} from \"svelte\"\n   import {nthEq} from \"@welshman/lib\"\n-  import {deriveNaddrEvent} from \"@src/app/state\"\n+  import {deriveProfile, repository} from \"@welshman/app\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n-  import {deriveProfile} from \"@welshman/app\"\n+  import {makeFeed} from \"@src/app/requests\"\n+  import type {Readable} from \"svelte/store\"\n+  import {type RepoStateEvent} from \"@nostr-git/shared-types\"\n \n-  // Receive eventStore from layout via $props (Svelte 5 idiom)\n-  const { eventStore } = $props();\n+  const repoEvent = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n-  const {id, relay} = page.params\n-  const relayArray = Array.isArray(relay) ? relay : [relay]\n-  const repo = deriveNaddrEvent(id, relayArray)\n-  let patches = $state([] as TrustedEvent[])\n-  let loading = $state(true)\n-  let currentPage = $state(1)\n-  const pageSize = 10\n+  const repo = getContext\u003c{\n+    repo: Readable\u003cTrustedEvent\u003e\n+    state: () =\u003e Readable\u003cRepoStateEvent\u003e\n+    issues: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+    patches: () =\u003e Readable\u003cTrustedEvent[]\u003e\n+  }\u003e(\"repo\")\n \n-  function pageCount() {\n-    return Math.max(1, Math.ceil(patches.length / pageSize))\n-  }\n+  let patches = $derived(repo.patches())\n \n-  function paginatedPatches() {\n-    return patches.slice((currentPage - 1) * pageSize, currentPage * pageSize)\n-  }\n+  let loading = $state(true)\n+  let element: HTMLElement | undefined = $state()\n \n-  function prevPage() {\n-    if (currentPage \u003e 1) currentPage = currentPage - 1\n-  }\n-  function nextPage() {\n-    if (currentPage \u003c pageCount()) currentPage = currentPage + 1\n-  }\n+  $effect(() =\u003e {\n+    if (!patches) {\n+      return\n+    }\n+\n+    const [_, ...relays] = $repoEvent.tags.find(nthEq(0, \"relays\")) || []\n \n-  async function loadPatches() {\n-    patches.length = 0\n     const patchFilter = {\n       kinds: [GIT_PATCH],\n-      \"#a\": [Address.fromEvent($repo).toString()],\n+      \"#a\": [Address.fromEvent($repoEvent).toString()],\n     }\n \n-    const [tagId, ...relays] = $repo.tags.find(nthEq(0, \"relays\")) || []\n-\n-    const patch = await load({\n+    const {cleanup} = makeFeed({\n+      element: element!,\n       relays: relays,\n-      filters: [patchFilter],\n+      feedFilters: [patchFilter],\n+      subscriptionFilters: [patchFilter],\n+      initialEvents: $patches,\n+      onExhausted: () =\u003e {\n+        loading = false\n+      },\n     })\n-    if (patch.length \u003e 0) {\n-      patches.push(...patch)\n-    }\n-  }\n-\n-  async function loadPatchesWrapper() {\n-    loading = true\n-    await loadPatches()\n-    loading = false\n-  }\n-\n-  onMount(() =\u003e {\n-    loadPatchesWrapper()\n-    return () =\u003e setChecked(page.url.pathname)\n   })\n \u003c/script\u003e\n \n-\u003cdiv\u003e\n+\u003cdiv bind:this={element}\u003e\n   \u003cdiv\n     class=\"z-10 sticky top-0 mb-4 flex items-center justify-between bg-background/95 py-4 backdrop-blur supports-[backdrop-filter]:bg-background/60\"\u003e\n     \u003cdiv\u003e\n@@ -99,29 +80,16 @@\n         {/if}\n       \u003c/Spinner\u003e\n     \u003c/div\u003e\n-  {:else if patches.length === 0}\n+  {:else if $patches.length === 0}\n     \u003cdiv class=\"flex flex-col items-center justify-center py-12 text-gray-500\"\u003e\n       \u003cSearchX class=\"mb-2 h-8 w-8\" /\u003e\n       No patches found.\n     \u003c/div\u003e\n   {:else}\n-    \u003cdiv class=\"flex max-h-[32rem] flex-col gap-y-4 overflow-y-auto rounded-md bg-background p-2\"\u003e\n-      {#each paginatedPatches() as patch}\n+    \u003cdiv class=\"flex flex-col gap-y-4 overflow-y-auto\"\u003e\n+      {#each $patches as patch}\n         \u003cPatchCard event={patch} owner={deriveProfile(patch.pubkey)} /\u003e\n       {/each}\n     \u003c/div\u003e\n-    \u003cdiv class=\"mt-4 flex items-center justify-center gap-4\"\u003e\n-      \u003cbutton\n-        onclick={prevPage}\n-        class=\"rounded bg-gray-100 px-3 py-1 hover:bg-gray-200 disabled:opacity-50\"\n-        disabled={currentPage === 1}\u003e\u0026larr; Prev\u003c/button\u003e\n-      \u003cspan class=\"text-gray-600\"\u003ePage {currentPage} of {pageCount()}\u003c/span\u003e\n-      \u003cbutton\n-        onclick={nextPage}\n-        class=\"rounded bg-gray-100 px-3 py-1 hover:bg-gray-200 disabled:opacity-50\"\n-        disabled={currentPage === pageCount()}\u003e\n-        Next \u0026rarr;\n-      \u003c/button\u003e\n-    \u003c/div\u003e\n   {/if}\n \u003c/div\u003e\ndiff --git a/svelte.config.js b/svelte.config.js\nindex 232bea4..4e81968 100644\n--- a/svelte.config.js\n+++ b/svelte.config.js\n@@ -16,7 +16,6 @@ export default {\n     },\n     csp: {\n       directives: {\n-        \"script-src\": [\"self\", \"plausible.coracle.social\"],\n         \"worker-src\": [\"self\", \"blob:\"],\n         \"style-src\": [\"self\", \"unsafe-inline\"],\n         \"frame-src\": [\"none\"],\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-wmb33tgd","title":"From c77a05850f16359c8ece07fbed007e23f302d045 Mon Sep 17 00:00:00 2001","description":"From c77a05850f16359c8ece07fbed007e23f302d045 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Wed, 28 May 2025 16:46:41 -0700\nSubject: [PATCH 6/67] Improve group membership detection\n\n---\n pnpm-lock.yaml                                | Bin 494118 -\u003e 494118 bytes\n src/app/commands.ts                           |  23 +++--------------------\n src/app/components/MenuSpaceRoomItem.svelte   |   4 ++--\n src/app/components/RoomCreate.svelte          |   5 ++---\n src/app/state.ts                              |  46 +++++++++++++++++++++++++++++++++++++++-------\n src/assets/icons/Bookmark.svg                 |   4 ++++\n src/assets/icons/Star.svg                     |   3 +++\n src/lib/components/Icon.svelte                |   4 ++++\n src/routes/+layout.svelte                     |   7 +------\n src/routes/spaces/[relay]/+page.svelte        |   1 -\n src/routes/spaces/[relay]/[room]/+page.svelte | 228 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++------------------------------------------------------------------------\n 11 files changed, 214 insertions(+), 111 deletions(-)\n create mode 100644 src/assets/icons/Bookmark.svg\n create mode 100644 src/assets/icons/Star.svg\n\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 331a27f783fe007e4147e023946558fc39c19aad..1d3e7b2f765bed151a06fbb6db406ebbb0308c8a 100644\nGIT binary patch\ndelta 47\nzc$`}{MQ+\u0026?xrP?T7N!\u003eF7M2#)Eo_|pOhyLVx%t^LL\u003eY~yC#tepwXaiQ+rCbPy\u0026@F=\nDR=W+l\n\ndelta 48\nzc$`}{MQ+\u0026?xrP?T7N!\u003eF7M2#)Eo_|pOoo=*x%t^LM1hRyg@;)*+vlmUZJ(#Y-jNCb\nDYWEI?\n\ndiff --git a/src/app/commands.ts b/src/app/commands.ts\nindex 53dfae7..8a086c6 100644\n--- a/src/app/commands.ts\n+++ b/src/app/commands.ts\n@@ -53,6 +53,7 @@ import {\n   tagEventForComment,\n   tagEventForQuote,\n   thunkIsComplete,\n+  getThunkError,\n } from \"@welshman/app\"\n import type {Thunk} from \"@welshman/app\"\n import {\n@@ -84,21 +85,6 @@ export const getPubkeyPetname = (pubkey: string) =\u003e {\n   return display\n }\n \n-export const getThunkError = (thunk: Thunk) =\u003e\n-  new Promise\u003cstring\u003e(resolve =\u003e {\n-    thunk.subscribe($thunk =\u003e {\n-      for (const [relay, status] of Object.entries($thunk.status)) {\n-        if (status === PublishStatus.Failure) {\n-          resolve($thunk.details[relay])\n-        }\n-      }\n-\n-      if (thunkIsComplete($thunk)) {\n-        resolve(\"\")\n-      }\n-    })\n-  })\n-\n export const prependParent = (parent: TrustedEvent | undefined, {content, tags}: EventContent) =\u003e {\n   if (parent) {\n     const nevent = nip19.neventEncode({\n@@ -190,12 +176,9 @@ export const removeSpaceMembership = async (url: string) =\u003e {\n   return publishThunk({event, relays})\n }\n \n-export const addRoomMembership = async (url: string, room: string, name: string) =\u003e {\n+export const addRoomMembership = async (url: string, room: string) =\u003e {\n   const list = get(userMembership) || makeList({kind: GROUPS})\n-  const newTags = [\n-    [\"r\", url],\n-    [\"group\", room, url, name],\n-  ]\n+  const newTags = [[\"r\", url], [\"group\", room, url]]\n   const event = await addToListPublicly(list, ...newTags).reconcile(nip44EncryptToSelf)\n   const relays = uniq([...Router.get().FromUser().getUrls(), ...getRelayTagValues(event.tags)])\n \ndiff --git a/src/app/components/MenuSpaceRoomItem.svelte b/src/app/components/MenuSpaceRoomItem.svelte\nindex 1a66672..e19cc26 100644\n--- a/src/app/components/MenuSpaceRoomItem.svelte\n+++ b/src/app/components/MenuSpaceRoomItem.svelte\n@@ -3,7 +3,7 @@\n   import SecondaryNavItem from \"@lib/components/SecondaryNavItem.svelte\"\n   import ChannelName from \"@app/components/ChannelName.svelte\"\n   import {makeRoomPath} from \"@app/routes\"\n-  import {deriveChannel, channelIsLocked} from \"@app/state\"\n+  import {deriveChannel} from \"@app/state\"\n   import {notifications} from \"@app/notifications\"\n \n   interface Props {\n@@ -23,7 +23,7 @@\n   href={path}\n   {replaceState}\n   notification={notify ? $notifications.has(path) : false}\u003e\n-  {#if channelIsLocked($channel)}\n+  {#if $channel?.closed || $channel?.private}\n     \u003cIcon icon=\"lock\" size={4} /\u003e\n   {:else}\n     \u003cIcon icon=\"hashtag\" /\u003e\ndiff --git a/src/app/components/RoomCreate.svelte b/src/app/components/RoomCreate.svelte\nindex e5c71d7..0a5195c 100644\n--- a/src/app/components/RoomCreate.svelte\n+++ b/src/app/components/RoomCreate.svelte\n@@ -2,7 +2,7 @@\n   import {goto} from \"$app/navigation\"\n   import {randomId} from \"@welshman/lib\"\n   import {displayRelayUrl} from \"@welshman/util\"\n-  import {deriveRelay} from \"@welshman/app\"\n+  import {deriveRelay, getThunkError} from \"@welshman/app\"\n   import {preventDefault} from \"@lib/html\"\n   import Field from \"@lib/components/Field.svelte\"\n   import Spinner from \"@lib/components/Spinner.svelte\"\n@@ -11,7 +11,7 @@\n   import ModalHeader from \"@lib/components/ModalHeader.svelte\"\n   import ModalFooter from \"@lib/components/ModalFooter.svelte\"\n   import {hasNip29, loadChannel} from \"@app/state\"\n-  import {addRoomMembership, createRoom, editRoom, joinRoom, getThunkError} from \"@app/commands\"\n+  import {createRoom, editRoom, joinRoom} from \"@app/commands\"\n   import {makeSpacePath} from \"@app/routes\"\n   import {pushToast} from \"@app/toast\"\n \n@@ -43,7 +43,6 @@\n \n     await loadChannel(url, room)\n \n-    addRoomMembership(url, room, name)\n     goto(makeSpacePath(url, room))\n   }\n \ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 4d2addd..7ea4047 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -34,6 +34,9 @@ import {\n   GROUPS,\n   THREAD,\n   COMMENT,\n+  GROUP_JOIN,\n+  GROUP_ADD_USER,\n+  GROUP_REMOVE_USER,\n   getGroupTags,\n   getRelayTagValues,\n   getPubkeyTagValues,\n@@ -43,6 +46,8 @@ import {\n   getListTags,\n   asDecryptedEvent,\n   normalizeRelayUrl,\n+  getTag,\n+  getTagValues,\n } from \"@welshman/util\"\n import type {TrustedEvent, SignedEvent, PublishedList, List, Filter} from \"@welshman/util\"\n import {Nip59, decrypt} from \"@welshman/signer\"\n@@ -517,8 +522,8 @@ export type Channel = {\n   room: string\n   name: string\n   event: TrustedEvent\n-  access: \"public\" | \"private\"\n-  membership: \"open\" | \"closed\"\n+  closed: boolean\n+  private: boolean\n   picture?: string\n   about?: string\n }\n@@ -551,8 +556,8 @@ export const channels = derived(\n             room,\n             event,\n             name: meta.name || room,\n-            access: meta.private ? \"private\" : \"public\",\n-            membership: meta.closed ? \"closed\" : \"open\",\n+            closed: Boolean(getTag(\"closed\", event.tags)),\n+            private: Boolean(getTag(\"private\", event.tags)),\n             picture: meta.picture,\n             about: meta.about,\n           })\n@@ -594,9 +599,6 @@ export const displayChannel = (url: string, room: string) =\u003e\n export const roomComparator = (url: string) =\u003e (room: string) =\u003e\n   displayChannel(url, room).toLowerCase()\n \n-export const channelIsLocked = (channel?: Channel) =\u003e\n-  channel?.access === \"private\" \u0026\u0026 channel?.membership === \"closed\"\n-\n // User stuff\n \n export const userSettings = withGetter(\n@@ -657,6 +659,36 @@ export const deriveOtherRooms = (url: string) =\u003e\n     ),\n   )\n \n+export enum MembershipStatus {\n+  Initial,\n+  Pending,\n+  Granted,\n+}\n+\n+export const deriveUserMembershipStatus = (url: string, room: string) =\u003e\n+  derived(\n+    [pubkey, deriveEventsForUrl(url, [{kinds: [GROUP_JOIN, GROUP_ADD_USER, GROUP_REMOVE_USER], '#h': [room]}])],\n+    ([$pubkey, $events]) =\u003e {\n+      let status = MembershipStatus.Initial\n+\n+      for (const event of $events) {\n+        if (event.kind === GROUP_JOIN \u0026\u0026 event.pubkey === $pubkey) {\n+          status = MembershipStatus.Pending\n+        }\n+\n+        if (event.kind === GROUP_REMOVE_USER \u0026\u0026 getTagValues(\"p\", event.tags).includes($pubkey!)) {\n+          break\n+        }\n+\n+        if (event.kind === GROUP_ADD_USER \u0026\u0026 getTagValues(\"p\", event.tags).includes($pubkey!)) {\n+          return MembershipStatus.Granted\n+        }\n+      }\n+\n+      return status\n+    }\n+  )\n+\n // Other utils\n \n export const encodeRelay = (url: string) =\u003e\ndiff --git a/src/assets/icons/Bookmark.svg b/src/assets/icons/Bookmark.svg\nnew file mode 100644\nindex 0000000..31a523d\n--- /dev/null\n+++ b/src/assets/icons/Bookmark.svg\n@@ -0,0 +1,4 @@\n+\u003csvg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"\u003e\n+\u003cpath d=\"M21 16.0909V11.0975C21 6.80891 21 4.6646 19.682 3.3323C18.364 2 16.2426 2 12 2C7.75736 2 5.63604 2 4.31802 3.3323C3 4.6646 3 6.80891 3 11.0975V16.0909C3 19.1875 3 20.7358 3.73411 21.4123C4.08421 21.735 4.52615 21.9377 4.99692 21.9915C5.98402 22.1045 7.13673 21.0849 9.44216 19.0458C10.4612 18.1445 10.9708 17.6938 11.5603 17.5751C11.8506 17.5166 12.1494 17.5166 12.4397 17.5751C13.0292 17.6938 13.5388 18.1445 14.5578 19.0458C16.8633 21.0849 18.016 22.1045 19.0031 21.9915C19.4739 21.9377 19.9158 21.735 20.2659 21.4123C21 20.7358 21 19.1875 21 16.0909Z\" stroke=\"#1C274D\" stroke-width=\"1.5\"/\u003e\n+\u003cpath d=\"M15 6H9\" stroke=\"#1C274D\" stroke-width=\"1.5\" stroke-linecap=\"round\"/\u003e\n+\u003c/svg\u003e\ndiff --git a/src/assets/icons/Star.svg b/src/assets/icons/Star.svg\nnew file mode 100644\nindex 0000000..669ceb5\n--- /dev/null\n+++ b/src/assets/icons/Star.svg\n@@ -0,0 +1,3 @@\n+\u003csvg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"\u003e\n+\u003cpath d=\"M9.15316 5.40838C10.4198 3.13613 11.0531 2 12 2C12.9469 2 13.5802 3.13612 14.8468 5.40837L15.1745 5.99623C15.5345 6.64193 15.7144 6.96479 15.9951 7.17781C16.2757 7.39083 16.6251 7.4699 17.3241 7.62805L17.9605 7.77203C20.4201 8.32856 21.65 8.60682 21.9426 9.54773C22.2352 10.4886 21.3968 11.4691 19.7199 13.4299L19.2861 13.9372C18.8096 14.4944 18.5713 14.773 18.4641 15.1177C18.357 15.4624 18.393 15.8341 18.465 16.5776L18.5306 17.2544C18.7841 19.8706 18.9109 21.1787 18.1449 21.7602C17.3788 22.3417 16.2273 21.8115 13.9243 20.7512L13.3285 20.4768C12.6741 20.1755 12.3469 20.0248 12 20.0248C11.6531 20.0248 11.3259 20.1755 10.6715 20.4768L10.0757 20.7512C7.77268 21.8115 6.62118 22.3417 5.85515 21.7602C5.08912 21.1787 5.21588 19.8706 5.4694 17.2544L5.53498 16.5776C5.60703 15.8341 5.64305 15.4624 5.53586 15.1177C5.42868 14.773 5.19043 14.4944 4.71392 13.9372L4.2801 13.4299C2.60325 11.4691 1.76482 10.4886 2.05742 9.54773C2.35002 8.60682 3.57986 8.32856 6.03954 7.77203L6.67589 7.62805C7.37485 7.4699 7.72433 7.39083 8.00494 7.17781C8.28555 6.96479 8.46553 6.64194 8.82547 5.99623L9.15316 5.40838Z\" stroke=\"#1C274C\" stroke-width=\"1.5\"/\u003e\n+\u003c/svg\u003e\ndiff --git a/src/lib/components/Icon.svelte b/src/lib/components/Icon.svelte\nindex 9204bd2..f188cc5 100644\n--- a/src/lib/components/Icon.svelte\n+++ b/src/lib/components/Icon.svelte\n@@ -9,6 +9,7 @@\n   import {switcher} from \"@welshman/lib\"\n   import AddSquare from \"@assets/icons/Add Square.svg?dataurl\"\n   import ArrowsALogout2 from \"@assets/icons/Arrows ALogout 2.svg?dataurl\"\n+  import Bookmark from \"@assets/icons/Bookmark.svg?dataurl\"\n   import Code2 from \"@assets/icons/Code 2.svg?dataurl\"\n   import Document from \"@assets/icons/Document.svg?dataurl\"\n   import Earth from \"@assets/icons/Earth.svg?dataurl\"\n@@ -82,6 +83,7 @@\n   import SmileCircle from \"@assets/icons/Smile Circle.svg?dataurl\"\n   import SquareShareLine from \"@assets/icons/Square Share Line.svg?dataurl\"\n   import SortVertical from \"@assets/icons/Sort Vertical.svg?dataurl\"\n+  import Star from \"@assets/icons/Star.svg?dataurl\"\n   import TrashBin2 from \"@assets/icons/Trash Bin 2.svg?dataurl\"\n   import UFO3 from \"@assets/icons/UFO 3.svg?dataurl\"\n   import UserHeart from \"@assets/icons/User Heart.svg?dataurl\"\n@@ -106,6 +108,7 @@\n   const data = switcher(icon, {\n     \"add-square\": AddSquare,\n     \"arrows-a-logout-2\": ArrowsALogout2,\n+    bookmark: Bookmark,\n     \"code-2\": Code2,\n     document: Document,\n     earth: Earth,\n@@ -181,6 +184,7 @@\n     \"ufo-3\": UFO3,\n     \"square-share-line\": SquareShareLine,\n     \"sort-vertical\": SortVertical,\n+    star: Star,\n     \"user-heart\": UserHeart,\n     \"user-circle\": UserCircle,\n     \"user-rounded\": UserRounded,\ndiff --git a/src/routes/+layout.svelte b/src/routes/+layout.svelte\nindex c9b8676..1d87079 100644\n--- a/src/routes/+layout.svelte\n+++ b/src/routes/+layout.svelte\n@@ -17,7 +17,6 @@\n     MESSAGE,\n     INBOX_RELAYS,\n     DIRECT_MESSAGE,\n-    GROUP_META,\n     MUTES,\n     FOLLOWS,\n     PROFILE,\n@@ -174,11 +173,7 @@\n           limit: 10_000,\n           repository,\n           rankEvent: (e: TrustedEvent) =\u003e {\n-            if (\n-              [PROFILE, FOLLOWS, MUTES, RELAYS, BLOSSOM_SERVERS, INBOX_RELAYS, GROUP_META].includes(\n-                e.kind,\n-              )\n-            ) {\n+            if ([PROFILE, FOLLOWS, MUTES, RELAYS, BLOSSOM_SERVERS, INBOX_RELAYS].includes(e.kind)) {\n               return 1\n             }\n \ndiff --git a/src/routes/spaces/[relay]/+page.svelte b/src/routes/spaces/[relay]/+page.svelte\nindex 8ef26e6..374f2ef 100644\n--- a/src/routes/spaces/[relay]/+page.svelte\n+++ b/src/routes/spaces/[relay]/+page.svelte\n@@ -17,7 +17,6 @@\n   import {\n     hasNip29,\n     decodeRelay,\n-    channelIsLocked,\n     makeChannelId,\n     channelsById,\n     deriveUserRooms,\ndiff --git a/src/routes/spaces/[relay]/[room]/+page.svelte b/src/routes/spaces/[relay]/[room]/+page.svelte\nindex 439ed2d..96c48b9 100644\n--- a/src/routes/spaces/[relay]/[room]/+page.svelte\n+++ b/src/routes/spaces/[relay]/[room]/+page.svelte\n@@ -1,12 +1,14 @@\n \u003cscript lang=\"ts\"\u003e\n+  import cx from 'classnames'\n   import {readable} from \"svelte/store\"\n   import {onMount, onDestroy} from \"svelte\"\n   import {page} from \"$app/stores\"\n   import type {Readable} from \"svelte/store\"\n   import {now, formatTimestampAsDate} from \"@welshman/lib\"\n+  import {request} from \"@welshman/net\"\n   import type {TrustedEvent, EventContent} from \"@welshman/util\"\n-  import {createEvent, MESSAGE, DELETE, REACTION} from \"@welshman/util\"\n-  import {pubkey, publishThunk, deriveRelay} from \"@welshman/app\"\n+  import {createEvent, MESSAGE, DELETE, REACTION, GROUP_ADD_USER, GROUP_REMOVE_USER} from \"@welshman/util\"\n+  import {pubkey, publishThunk, deriveRelay, getThunkError, waitForThunkCompletion} from \"@welshman/app\"\n   import {slide, fade, fly} from \"@lib/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n@@ -20,12 +22,15 @@\n   import ChannelCompose from \"@app/components/ChannelCompose.svelte\"\n   import ChannelComposeParent from \"@app/components/ChannelComposeParent.svelte\"\n   import {\n+    userRoomsByUrl,\n     userSettingValues,\n     decodeRelay,\n     tagRoom,\n-    userRoomsByUrl,\n     displayChannel,\n     getEventsForUrl,\n+    deriveUserMembershipStatus,\n+    deriveChannel,\n+    MembershipStatus,\n     channelsById,\n   } from \"@app/state\"\n   import {setChecked, checked} from \"@app/notifications\"\n@@ -35,7 +40,6 @@\n     addRoomMembership,\n     removeRoomMembership,\n     prependParent,\n-    getThunkError,\n   } from \"@app/commands\"\n   import {PROTECTED} from \"@app/state\"\n   import {makeFeed} from \"@app/requests\"\n@@ -47,26 +51,44 @@\n   const mounted = now()\n   const lastChecked = $checked[$page.url.pathname]\n   const url = decodeRelay($page.params.relay)\n+  const channel = deriveChannel(url, room)\n   const filter = {kinds: [MESSAGE, GIT_REPO], \"#h\": [room]}\n+  const isFavorite = $derived($userRoomsByUrl.get(url)?.has(room))\n+  const membershipStatus = deriveUserMembershipStatus(url, room)\n+\n+  const addFavorite = () =\u003e addRoomMembership(url, room)\n+\n+  const removeFavorite = () =\u003e removeRoomMembership(url, room)\n   const relay = deriveRelay(url)\n \n   const join = async () =\u003e {\n-    joiningRoom = true\n+    joining = true\n \n-    const message = await getThunkError(joinRoom(url, room))\n+    try {\n+      const message = await getThunkError(joinRoom(url, room))\n \n-    joiningRoom = false\n-\n-    if (message \u0026\u0026 !message.includes(\"already\")) {\n-      return pushToast({theme: \"error\", message})\n+      if (message \u0026\u0026 !message.startsWith(\"duplicate:\")) {\n+        return pushToast({theme: \"error\", message})\n+      } else {\n+        // Restart the feed now that we're a member\n+        start()\n+      }\n+    } finally {\n+      joining = false\n     }\n-\n-    addRoomMembership(url, room, displayChannel(url, room))\n   }\n \n-  const leave = () =\u003e {\n-    leaveRoom(url, room)\n-    removeRoomMembership(url, room)\n+  const leave = async () =\u003e {\n+    leaving = true\n+    try {\n+      const message = await getThunkError(leaveRoom(url, room))\n+\n+      if (message \u0026\u0026 !message.startsWith(\"duplicate:\")) {\n+        pushToast({theme: \"error\", message})\n+      }\n+    } finally {\n+      leaving = false\n+    }\n   }\n \n   const replyTo = (event: TrustedEvent) =\u003e {\n@@ -127,7 +149,8 @@\n \n   const scrollToBottom = () =\u003e element?.scrollTo({top: 0, behavior: \"smooth\"})\n \n-  let joiningRoom = $state(false)\n+  let joining = $state(false)\n+  let leaving = $state(false)\n   let loadingEvents = $state(true)\n   let share = $state(popKey\u003cTrustedEvent | undefined\u003e(\"share\"))\n   let parent: TrustedEvent | undefined = $state()\n@@ -199,8 +222,10 @@\n     return elements\n   })\n \n-  onMount(() =\u003e {\n-    ;({events, cleanup} = makeFeed({\n+  const start = () =\u003e {\n+    cleanup?.()\n+\n+    const feed = makeFeed({\n       element: element!,\n       relays: [url],\n       feedFilters: [filter],\n@@ -211,7 +236,25 @@\n       onExhausted: () =\u003e {\n         loadingEvents = false\n       },\n-    }))\n+    })\n+\n+    events = feed.events\n+    cleanup = feed.cleanup\n+  }\n+\n+  onMount(() =\u003e {\n+    const controller = new AbortController()\n+\n+    const req = request({\n+      signal: controller.signal,\n+      relays: [url],\n+      filters: [{\n+        kinds: [GROUP_ADD_USER, GROUP_REMOVE_USER],\n+        '#p': [$pubkey!],\n+        '#h': [room],\n+        limit: 10,\n+      }],\n+    })\n \n     const observer = new ResizeObserver(() =\u003e {\n       if (dynamicPadding \u0026\u0026 chatCompose) {\n@@ -221,8 +264,10 @@\n \n     observer.observe(chatCompose!)\n     observer.observe(dynamicPadding!)\n+    start()\n \n     return () =\u003e {\n+      controller.abort()\n       observer.unobserve(chatCompose!)\n       observer.unobserve(dynamicPadding!)\n     }\n@@ -251,21 +296,12 @@\n   {/snippet}\n   {#snippet action()}\n     \u003cdiv class=\"row-2\"\u003e\n-      {#if $userRoomsByUrl.get(url)?.has(room)}\n-        \u003cButton class=\"btn btn-neutral btn-sm\" onclick={leave}\u003e\n-          \u003cIcon icon=\"arrows-a-logout-2\" /\u003e\n-          Leave Room\n-        \u003c/Button\u003e\n-      {:else}\n-        \u003cButton class=\"btn btn-neutral btn-sm\" disabled={joiningRoom} onclick={join}\u003e\n-          {#if joiningRoom}\n-            \u003cspan class=\"loading loading-spinner loading-sm\"\u003e\u003c/span\u003e\n-          {:else}\n-            \u003cIcon icon=\"login-2\" /\u003e\n-          {/if}\n-          Join Room\n-        \u003c/Button\u003e\n-      {/if}\n+      \u003cButton\n+        class=\"btn btn-neutral btn-sm tooltip tooltip-left\"\n+        data-tip={isFavorite ? \"Remove Favorite\" : \"Add Favorite\"}\n+        onclick={isFavorite ? removeFavorite : addFavorite}\u003e\n+        \u003cIcon size={4} icon=\"bookmark\" class={cx({'text-primary': isFavorite})} /\u003e\n+      \u003c/Button\u003e\n       \u003cMenuSpaceButton {url} /\u003e\n     \u003c/div\u003e\n   {/snippet}\n@@ -273,48 +309,96 @@\n \n \u003cPageContent bind:element onscroll={onScroll} class=\"flex flex-col-reverse pt-4\"\u003e\n   \u003cdiv bind:this={dynamicPadding}\u003e\u003c/div\u003e\n-  {#each elements as { type, id, value, showPubkey } (id)}\n-    {#if type === \"new-messages\"}\n-      \u003cdiv\n-        bind:this={newMessages}\n-        class=\"flex items-center py-2 text-xs transition-colors\"\n-        class:opacity-0={showFixedNewMessages}\u003e\n-        \u003cdiv class=\"h-px flex-grow bg-primary\"\u003e\u003c/div\u003e\n-        \u003cp class=\"rounded-full bg-primary px-2 py-1 text-primary-content\"\u003eNew Messages\u003c/p\u003e\n-        \u003cdiv class=\"h-px flex-grow bg-primary\"\u003e\u003c/div\u003e\n-      \u003c/div\u003e\n-    {:else if type === \"date\"}\n-      \u003cDivider\u003e{value}\u003c/Divider\u003e\n-    {:else}\n-      \u003cdiv in:slide class:-mt-1={!showPubkey}\u003e\n-        \u003cChannelMessage\n-          {url}\n-          {room}\n-          {replyTo}\n-          event={$state.snapshot(value as TrustedEvent)}\n-          {showPubkey} /\u003e\n+  {#if $channel?.private \u0026\u0026 $membershipStatus !== MembershipStatus.Granted}\n+    \u003cdiv class=\"py-20\"\u003e\n+      \u003cdiv class=\"card2 col-8 m-auto max-w-md items-center text-center\"\u003e\n+        \u003cp class=\"row-2\"\u003e\n+          You aren't currently a member of this room.\n+        \u003c/p\u003e\n+        {#if $membershipStatus === MembershipStatus.Pending}\n+          \u003cButton class=\"btn btn-neutral btn-sm\" disabled={leaving} onclick={leave}\u003e\n+            \u003cIcon icon=\"clock-circle\" /\u003e\n+            Access Pending\n+          \u003c/Button\u003e\n+        {:else}\n+          \u003cButton class=\"btn btn-neutral btn-sm\" disabled={joining} onclick={join}\u003e\n+            {#if joining}\n+              \u003cspan class=\"loading loading-spinner loading-sm\"\u003e\u003c/span\u003e\n+            {:else}\n+              \u003cIcon icon=\"login-2\" /\u003e\n+            {/if}\n+            Join Room\n+          \u003c/Button\u003e\n+        {/if}\n       \u003c/div\u003e\n-    {/if}\n-  {/each}\n-  \u003cp class=\"flex h-10 items-center justify-center py-20\"\u003e\n-    {#if loadingEvents}\n-      \u003cSpinner loading={loadingEvents}\u003eLooking for messages...\u003c/Spinner\u003e\n-    {:else}\n-      \u003cSpinner\u003eEnd of message history\u003c/Spinner\u003e\n-    {/if}\n-  \u003c/p\u003e\n+    \u003c/div\u003e\n+  {:else}\n+    {#each elements as { type, id, value, showPubkey } (id)}\n+      {#if type === \"new-messages\"}\n+        \u003cdiv\n+          bind:this={newMessages}\n+          class=\"flex items-center py-2 text-xs transition-colors\"\n+          class:opacity-0={showFixedNewMessages}\u003e\n+          \u003cdiv class=\"h-px flex-grow bg-primary\"\u003e\u003c/div\u003e\n+          \u003cp class=\"rounded-full bg-primary px-2 py-1 text-primary-content\"\u003eNew Messages\u003c/p\u003e\n+          \u003cdiv class=\"h-px flex-grow bg-primary\"\u003e\u003c/div\u003e\n+        \u003c/div\u003e\n+      {:else if type === \"date\"}\n+        \u003cDivider\u003e{value}\u003c/Divider\u003e\n+      {:else}\n+        \u003cdiv in:slide class:-mt-1={!showPubkey}\u003e\n+          \u003cChannelMessage\n+            {url}\n+            {room}\n+            {replyTo}\n+            event={$state.snapshot(value as TrustedEvent)}\n+            {showPubkey} /\u003e\n+        \u003c/div\u003e\n+      {/if}\n+    {/each}\n+    \u003cp class=\"flex h-10 items-center justify-center py-20\"\u003e\n+      {#if loadingEvents}\n+        \u003cSpinner loading={loadingEvents}\u003eLooking for messages...\u003c/Spinner\u003e\n+      {:else}\n+        \u003cSpinner\u003eEnd of message history\u003c/Spinner\u003e\n+      {/if}\n+    \u003c/p\u003e\n+  {/if}\n \u003c/PageContent\u003e\n \n \u003cdiv class=\"chat__compose bg-base-200\" bind:this={chatCompose}\u003e\n-  \u003cdiv\u003e\n-    {#if parent}\n-      \u003cChannelComposeParent event={parent} clear={clearParent} verb=\"Replying to\" /\u003e\n-    {/if}\n-    {#if share}\n-      \u003cChannelComposeParent event={share} clear={clearShare} verb=\"Sharing\" /\u003e\n-    {/if}\n-  \u003c/div\u003e\n-  \u003cChannelCompose bind:this={compose} {onSubmit} {url} /\u003e\n+  {#if $channel?.private \u0026\u0026 $membershipStatus !== MembershipStatus.Granted}\n+    \u003c!-- pass --\u003e\n+  {:else if $channel?.closed \u0026\u0026 $membershipStatus !== MembershipStatus.Granted}\n+    \u003cdiv class=\"flex flex-row items-center justify-between m-4 px-4 py-3 card bg-alt\"\u003e\n+      \u003cp\u003eOnly members are allowed to post to this room.\u003c/p\u003e\n+      {#if $membershipStatus === MembershipStatus.Pending}\n+        \u003cButton class=\"btn btn-neutral btn-sm\" disabled={leaving} onclick={leave}\u003e\n+          \u003cIcon icon=\"clock-circle\" /\u003e\n+          Access Pending\n+        \u003c/Button\u003e\n+      {:else}\n+        \u003cButton class=\"btn btn-neutral btn-sm\" disabled={joining} onclick={join}\u003e\n+          {#if joining}\n+            \u003cspan class=\"loading loading-spinner loading-sm\"\u003e\u003c/span\u003e\n+          {:else}\n+            \u003cIcon icon=\"login-2\" /\u003e\n+          {/if}\n+          Ask to Join\n+        \u003c/Button\u003e\n+      {/if}\n+    \u003c/div\u003e\n+  {:else}\n+    \u003cdiv\u003e\n+      {#if parent}\n+        \u003cChannelComposeParent event={parent} clear={clearParent} verb=\"Replying to\" /\u003e\n+      {/if}\n+      {#if share}\n+        \u003cChannelComposeParent event={share} clear={clearShare} verb=\"Sharing\" /\u003e\n+      {/if}\n+    \u003c/div\u003e\n+    \u003cChannelCompose bind:this={compose} {onSubmit} {url} /\u003e\n+  {/if}\n \u003c/div\u003e\n \n {#if showScrollButton}\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-wp4vziy3","title":"Markdown rendering spams with errors","description":"https://i.nostr.build/ruXWcJ58fNtXtn36.png\n\nError: Token with \"paragraph\"","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue","markdown"]}
{"id":"flotilla-wsr092tf","title":"From 27187db42794b1dc29eff5aa254751693a8edb28 Mon Sep 17 00:00:00 2001","description":"From 27187db42794b1dc29eff5aa254751693a8edb28 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Mon, 7 Jul 2025 13:04:19 -0700\nSubject: [PATCH 1/2] refactor: simplify channel management and improve space UI layout\n\n---\n packages/nostr-git                     |   2 +-\n src/app/components/Content.svelte      | 102 ++++++++++++++++++++++++++++++++++++++++++++++++++++++------------------------------------------------\n src/app/components/MenuSpace.svelte    |   1 -\n src/app/state.ts                       |  44 ++++++++++++++++++++------------------------\n src/routes/spaces/[relay]/+page.svelte | 303 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------------------------------------------------------------------\n 5 files changed, 257 insertions(+), 195 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 035c761..4f3f9cc 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 035c7617c2016e99154120357ff4159dcaca5ef6\n+Subproject commit 4f3f9cc02cad3aefe6b103cd9d876e9853e6a2e9\ndiff --git a/src/app/components/Content.svelte b/src/app/components/Content.svelte\nindex 74a1980..0d3ad78 100644\n--- a/src/app/components/Content.svelte\n+++ b/src/app/components/Content.svelte\n@@ -32,7 +32,7 @@\n   import ContentTopic from \"@app/components/ContentTopic.svelte\"\n   import ContentMention from \"@app/components/ContentMention.svelte\"\n   import {entityLink, userSettingValues} from \"@app/state\"\n-  import {isKnownUnknown, unknownKindFallback} from \"@src/lib/unknown-kinds\"\n+  import {Template, isKnownUnknown} from \"@nostr-git/ui\"\n \n   interface Props {\n     event: any\n@@ -58,7 +58,7 @@\n     url,\n   }: Props = $props()\n \n-  const fullContent = parse(isKnownUnknown(event.kind) ? unknownKindFallback(event) : event)\n+  const fullContent = parse(event)\n \n   const expand = () =\u003e {\n     showEntire = true\n@@ -130,55 +130,61 @@\n       \u003c/p\u003e\n     \u003c/div\u003e\n   {:else}\n-    \u003cdiv\n-      class=\"overflow-hidden text-ellipsis break-words\"\n-      style={expandBlock ? \"mask-image: linear-gradient(0deg, transparent 0px, black 100px)\" : \"\"}\u003e\n-      {#each shortContent as parsed, i}\n-        {#if isNewline(parsed) \u0026\u0026 !isBlock(i - 1)}\n-          \u003cContentNewline value={parsed.value} /\u003e\n-        {:else if isTopic(parsed)}\n-          \u003cContentTopic value={parsed.value} /\u003e\n-        {:else if isEmoji(parsed)}\n-          \u003cContentEmoji value={parsed.value} /\u003e\n-        {:else if isCode(parsed)}\n-          \u003cContentCode\n-            value={parsed.value}\n-            isBlock={isStartAndEnd(i) || parsed.value.includes(\"\\n\")} /\u003e\n-        {:else if isCashu(parsed) || isInvoice(parsed)}\n-          \u003cContentToken value={parsed.value} /\u003e\n-        {:else if isLink(parsed)}\n-          {#if isBlock(i)}\n-            \u003cContentLinkBlock value={parsed.value} {event} /\u003e\n-          {:else}\n-            \u003cContentLinkInline value={parsed.value} /\u003e\n-          {/if}\n-        {:else if isProfile(parsed)}\n-          \u003cContentMention value={parsed.value} {url} /\u003e\n-        {:else if isEvent(parsed) || isAddress(parsed)}\n-          {#if isBlock(i)}\n-            \u003cContentQuote\n-              {depth}\n-              {url}\n-              {hideMediaAtDepth}\n+    {#if isKnownUnknown(event.kind)}\n+      \u003cdiv class=\"unknown-kind\"\u003e\n+        {@html new Template(event).render()}\n+      \u003c/div\u003e\n+    {:else}\n+      \u003cdiv\n+        class=\"overflow-hidden text-ellipsis break-words\"\n+        style={expandBlock ? \"mask-image: linear-gradient(0deg, transparent 0px, black 100px)\" : \"\"}\u003e\n+        {#each shortContent as parsed, i}\n+          {#if isNewline(parsed) \u0026\u0026 !isBlock(i - 1)}\n+            \u003cContentNewline value={parsed.value} /\u003e\n+          {:else if isTopic(parsed)}\n+            \u003cContentTopic value={parsed.value} /\u003e\n+          {:else if isEmoji(parsed)}\n+            \u003cContentEmoji value={parsed.value} /\u003e\n+          {:else if isCode(parsed)}\n+            \u003cContentCode\n               value={parsed.value}\n-              {event}\n-              minimal={minimalQuote} /\u003e\n+              isBlock={isStartAndEnd(i) || parsed.value.includes(\"\\n\")} /\u003e\n+          {:else if isCashu(parsed) || isInvoice(parsed)}\n+            \u003cContentToken value={parsed.value} /\u003e\n+          {:else if isLink(parsed)}\n+            {#if isBlock(i)}\n+              \u003cContentLinkBlock value={parsed.value} {event} /\u003e\n+            {:else}\n+              \u003cContentLinkInline value={parsed.value} /\u003e\n+            {/if}\n+          {:else if isProfile(parsed)}\n+            \u003cContentMention value={parsed.value} {url} /\u003e\n+          {:else if isEvent(parsed) || isAddress(parsed)}\n+            {#if isBlock(i)}\n+              \u003cContentQuote\n+                {depth}\n+                {url}\n+                {hideMediaAtDepth}\n+                value={parsed.value}\n+                {event}\n+                minimal={minimalQuote} /\u003e\n+            {:else}\n+              \u003cLink\n+                external\n+                class=\"overflow-hidden text-ellipsis whitespace-nowrap underline\"\n+                href={entityLink(parsed.raw)}\u003e\n+                {fromNostrURI(parsed.raw).slice(0, 16) + \"…\"}\n+              \u003c/Link\u003e\n+            {/if}\n+          {:else if isEllipsis(parsed) \u0026\u0026 expandInline}\n+            {@html renderAsHtml(parsed)}\n+            \u003cbutton type=\"button\" class=\"text-sm underline\"\u003e Read more \u003c/button\u003e\n           {:else}\n-            \u003cLink\n-              external\n-              class=\"overflow-hidden text-ellipsis whitespace-nowrap underline\"\n-              href={entityLink(parsed.raw)}\u003e\n-              {fromNostrURI(parsed.raw).slice(0, 16) + \"…\"}\n-            \u003c/Link\u003e\n+            {@html renderAsHtml(parsed)}\n           {/if}\n-        {:else if isEllipsis(parsed) \u0026\u0026 expandInline}\n-          {@html renderAsHtml(parsed)}\n-          \u003cbutton type=\"button\" class=\"text-sm underline\"\u003e Read more \u003c/button\u003e\n-        {:else}\n-          {@html renderAsHtml(parsed)}\n-        {/if}\n-      {/each}\n-    \u003c/div\u003e\n+        {/each}\n+      \u003c/div\u003e\n+    {/if}\n     {#if expandBlock}\n       \u003cdiv class=\"relative z-feature -mt-6 flex justify-center py-2\"\u003e\n         \u003cbutton\ndiff --git a/src/app/components/MenuSpace.svelte b/src/app/components/MenuSpace.svelte\nindex e5ca0e1..292b8e7 100644\n--- a/src/app/components/MenuSpace.svelte\n+++ b/src/app/components/MenuSpace.svelte\n@@ -24,7 +24,6 @@\n     memberships,\n     deriveUserRooms,\n     deriveOtherRooms,\n-    hasNip29,\n     alerts,\n   } from \"@app/state\"\n   import {notifications} from \"@app/notifications\"\ndiff --git a/src/app/state.ts b/src/app/state.ts\nindex 9e4d2ae..fe6accb 100644\n--- a/src/app/state.ts\n+++ b/src/app/state.ts\n@@ -18,6 +18,7 @@ import {\n   memoize,\n   identity,\n   always,\n+  addToMapKey,\n } from \"@welshman/lib\"\n import type {Socket} from \"@welshman/net\"\n import {Pool, load, AuthStateEvent, SocketEvent} from \"@welshman/net\"\n@@ -591,38 +592,33 @@ export const channels = derived(\n       for (const {url, room, name} of getMembershipRooms(membership)) {\n         const id = makeChannelId(url, room)\n \n-        if (!$channels.some(c =\u003e c.id === id)) {\n-          $channels.push({\n-            id,\n-            url,\n-            room,\n-            name,\n-            closed: false,\n-            private: false,\n-          })\n-        }\n+        $channels.push({\n+          id,\n+          url,\n+          room,\n+          name,\n+          closed: false,\n+          private: false,\n+        })\n       }\n     }\n \n     // Add rooms based on known messages\n     for (const event of $messages) {\n       const [_, room] = event.tags.find(nthEq(0, ROOM)) || []\n-\n       if (room) {\n         for (const url of $getUrlsForEvent(event.id)) {\n           const id = makeChannelId(url, room)\n \n-          if (!$channels.some(c =\u003e c.id === id)) {\n-            $channels.push({\n-              id,\n-              url,\n-              room,\n-              name: room,\n-              event,\n-              closed: false,\n-              private: false,\n-            })\n-          }\n+          $channels.push({\n+            id,\n+            url,\n+            room,\n+            name: room,\n+            event,\n+            closed: false,\n+            private: false,\n+          })\n         }\n       }\n     }\n@@ -707,8 +703,8 @@ export const userRoomsByUrl = withGetter(\n     const tags = getListTags($userMembership)\n     const $userRoomsByUrl = new Map\u003cstring, Set\u003cstring\u003e\u003e()\n \n-    for (const url of getRelayTagValues(tags)) {\n-      $userRoomsByUrl.set(normalizeRelayUrl(url), new Set())\n+    for (const [_, room, url] of getGroupTags(tags)) {\n+      addToMapKey($userRoomsByUrl, normalizeRelayUrl(url), room)\n     }\n \n     return $userRoomsByUrl\ndiff --git a/src/routes/spaces/[relay]/+page.svelte b/src/routes/spaces/[relay]/+page.svelte\nindex 698b47f..7628a49 100644\n--- a/src/routes/spaces/[relay]/+page.svelte\n+++ b/src/routes/spaces/[relay]/+page.svelte\n@@ -1,158 +1,219 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n-  import {displayRelayUrl, MESSAGE, THREAD} from \"@welshman/util\"\n-  import {deriveRelay, pubkey} from \"@welshman/app\"\n+  import {displayRelayUrl} from \"@welshman/util\"\n+  import {deriveRelay} from \"@welshman/app\"\n+  import {fade} from \"@lib/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Link from \"@lib/components/Link.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n   import PageBar from \"@lib/components/PageBar.svelte\"\n   import PageContent from \"@lib/components/PageContent.svelte\"\n   import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n-  import ProfileLatest from \"@app/components/ProfileLatest.svelte\"\n+  import ChannelName from \"@app/components/ChannelName.svelte\"\n   import SpaceJoin from \"@app/components/SpaceJoin.svelte\"\n   import RelayName from \"@app/components/RelayName.svelte\"\n+  import RoomCreate from \"@app/components/RoomCreate.svelte\"\n   import RelayDescription from \"@app/components/RelayDescription.svelte\"\n-  import SpaceQuickLinks from \"@app/components/SpaceQuickLinks.svelte\"\n-  import SpaceRelayStatus from \"@app/components/SpaceRelayStatus.svelte\"\n   import {\n-    channelsById,\n     decodeRelay,\n-    deriveEventsForUrl,\n-    deriveOtherRooms,\n     makeChannelId,\n+    channelsById,\n+    deriveUserRooms,\n+    deriveOtherRooms,\n     userRoomsByUrl,\n+    type Channel,\n   } from \"@app/state\"\n-  import {makeChatPath, makeThreadPath, makeCalendarPath, makeGitPath} from \"@app/routes\"\n+  import {\n+    makeChatPath,\n+    makeThreadPath,\n+    makeCalendarPath,\n+    makeGitPath,\n+    makeRoomPath,\n+  } from \"@app/routes\"\n+  import {notifications} from \"@app/notifications\"\n   import {pushModal} from \"@app/modal\"\n-  import ChannelName from \"@src/app/components/ChannelName.svelte\"\n+\n+  const channelIsLocked = (channel: Channel | undefined) =\u003e false\n \n   const url = decodeRelay($page.params.relay)\n   const relay = deriveRelay(url)\n+  const userRooms = deriveUserRooms(url)\n   const otherRooms = deriveOtherRooms(url)\n   const threadsPath = makeThreadPath(url)\n   const calendarPath = makeCalendarPath(url)\n   const gitPath = makeGitPath(url)\n-  const mentions = deriveEventsForUrl(url, [{\"#p\": [$pubkey!], kinds: [MESSAGE, THREAD]}])\n \n   const joinSpace = () =\u003e pushModal(SpaceJoin, {url})\n \n-  const owner = $derived($relay?.profile?.pubkey)\n-\u003c/script\u003e\n+  const addRoom = () =\u003e pushModal(RoomCreate, {url})\n \n-\u003cPageBar\u003e\n-  {#snippet icon()}\n-    \u003cdiv class=\"center\"\u003e\n-      \u003cIcon icon=\"home-smile\" /\u003e\n-    \u003c/div\u003e\n-  {/snippet}\n-  {#snippet title()}\n-    \u003cstrong\u003eHome\u003c/strong\u003e\n-  {/snippet}\n-  {#snippet action()}\n-    \u003cdiv class=\"row-2\"\u003e\n-      {#if !$userRoomsByUrl.has(url)}\n-        \u003cButton class=\"btn btn-primary btn-sm\" onclick={joinSpace}\u003e\n-          \u003cIcon icon=\"login-2\" /\u003e\n-          Join Space\n-        \u003c/Button\u003e\n-      {:else if $pubkey}\n-        \u003cLink class=\"btn btn-primary btn-sm\" href={makeChatPath([$pubkey])}\u003e\n-          \u003cIcon icon=\"letter\" /\u003e\n-          Contact Owner\n-        \u003c/Link\u003e\n-      {/if}\n-      \u003cMenuSpaceButton {url} /\u003e\n-    \u003c/div\u003e\n-  {/snippet}\n-\u003c/PageBar\u003e\n+  const pubkey = $derived($relay?.profile?.pubkey)\n+\u003c/script\u003e\n \n-\u003cPageContent class=\"flex flex-col gap-2 p-2 pt-4\"\u003e\n-  \u003cdiv class=\"card2 bg-alt col-4 text-left\"\u003e\n-    \u003cdiv class=\"relative flex gap-4\"\u003e\n-      \u003cdiv class=\"relative\"\u003e\n-        \u003cdiv class=\"avatar relative\"\u003e\n-          \u003cdiv\n-            class=\"center !flex h-12 w-12 min-w-12 rounded-full border-2 border-solid border-base-300 bg-base-300\"\u003e\n-            {#if $relay?.profile?.icon}\n-              \u003cimg alt=\"\" src={$relay.profile.icon} /\u003e\n-            {:else}\n-              \u003cIcon icon=\"ghost\" size={5} /\u003e\n-            {/if}\n-          \u003c/div\u003e\n-        \u003c/div\u003e\n-      \u003c/div\u003e\n-      \u003cdiv class=\"flex min-w-0 flex-col gap-1\"\u003e\n-        \u003ch2 class=\"ellipsize whitespace-nowrap text-xl\"\u003e\n-          \u003cRelayName {url} /\u003e\n-        \u003c/h2\u003e\n-        \u003cp class=\"ellipsize text-sm opacity-75\"\u003e{displayRelayUrl(url)}\u003c/p\u003e\n+\u003cdiv class=\"relative flex flex-col\"\u003e\n+  \u003cPageBar\u003e\n+    {#snippet icon()}\n+      \u003cdiv class=\"center\"\u003e\n+        \u003cIcon icon=\"home-smile\" /\u003e\n       \u003c/div\u003e\n-    \u003c/div\u003e\n-    \u003cRelayDescription {url} /\u003e\n-    {#if $relay?.profile?.terms_of_service || $relay?.profile?.privacy_policy}\n-      \u003cdiv class=\"flex gap-3\"\u003e\n-        {#if $relay.profile.terms_of_service}\n-          \u003cLink href={$relay.profile.terms_of_service} class=\"badge badge-neutral flex gap-2\"\u003e\n-            \u003cIcon icon=\"bill-list\" size={4} /\u003e\n-            Terms of Service\n-          \u003c/Link\u003e\n-        {/if}\n-        {#if $relay.profile.privacy_policy}\n-          \u003cLink href={$relay?.profile?.privacy_policy} class=\"badge badge-neutral flex gap-2\"\u003e\n-            \u003cIcon icon=\"shield-user\" size={4} /\u003e\n-            Privacy Policy\n+    {/snippet}\n+    {#snippet title()}\n+      \u003cstrong\u003eHome\u003c/strong\u003e\n+    {/snippet}\n+    {#snippet action()}\n+      \u003cdiv class=\"row-2\"\u003e\n+        {#if !$userRoomsByUrl.has(url)}\n+          \u003cButton class=\"btn btn-primary btn-sm\" onclick={joinSpace}\u003e\n+            \u003cIcon icon=\"login-2\" /\u003e\n+            Join Space\n+          \u003c/Button\u003e\n+        {:else if pubkey}\n+          \u003cLink class=\"btn btn-primary btn-sm\" href={makeChatPath([pubkey])}\u003e\n+            \u003cIcon icon=\"letter\" /\u003e\n+            Contact Owner\n           \u003c/Link\u003e\n         {/if}\n+        \u003cMenuSpaceButton {url} /\u003e\n       \u003c/div\u003e\n-    {/if}\n-  \u003c/div\u003e\n-  \u003cSpaceQuickLinks {url} /\u003e\n-  \u003cdiv class=\"grid grid-cols-1 gap-2 lg:grid-cols-2\"\u003e\n-    \u003cdiv class=\"flex flex-col gap-2\"\u003e\n-      \u003cdiv class=\"card2 bg-alt\"\u003e\n-        \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n-          \u003cIcon icon=\"chat-round\" /\u003e\n-          Recent Activity\n-        \u003c/h3\u003e\n-        \u003cdiv class=\"flex flex-col gap-3\"\u003e\n-          {#if $otherRooms.length \u003e 0}\n-            {#each $otherRooms.slice(0, 3) as room (room)}\n-              {@const channel = $channelsById.get(makeChannelId(url, room))}\n-              \u003cdiv class=\"flex items-center gap-3 rounded bg-base-100\"\u003e\n-                \u003cdiv class=\"flex items-center gap-2\"\u003e\n-                  {#if channel?.closed || channel?.private}\n-                    \u003cIcon icon=\"lock\" size={4} /\u003e\n-                  {:else}\n-                    \u003cIcon icon=\"hashtag\" /\u003e\n-                  {/if}\n-                  \u003cspan class=\"font-medium\"\u003e\n-                    \u003cChannelName {url} {room} /\u003e\n-                  \u003c/span\u003e\n-                \u003c/div\u003e\n-                \u003cspan class=\"ml-auto text-sm opacity-60\"\u003eActive conversations\u003c/span\u003e\n+    {/snippet}\n+  \u003c/PageBar\u003e\n+  \u003cPageContent\u003e\n+    \u003cdiv class=\"col-2 p-2\"\u003e\n+      \u003cdiv class=\"card2 bg-alt col-4 text-left\"\u003e\n+        \u003cdiv class=\"relative flex gap-4\"\u003e\n+          \u003cdiv class=\"relative\"\u003e\n+            \u003cdiv class=\"avatar relative\"\u003e\n+              \u003cdiv\n+                class=\"center !flex h-12 w-12 min-w-12 rounded-full border-2 border-solid border-base-300 bg-base-300\"\u003e\n+                {#if $relay?.profile?.icon}\n+                  \u003cimg alt=\"\" src={$relay.profile.icon} /\u003e\n+                {:else}\n+                  \u003cIcon icon=\"ghost\" size={5} /\u003e\n+                {/if}\n               \u003c/div\u003e\n-            {/each}\n-          {:else}\n-            \u003cp class=\"text-sm opacity-60\"\u003eNo recent activity\u003c/p\u003e\n-          {/if}\n+            \u003c/div\u003e\n+          \u003c/div\u003e\n+          \u003cdiv class=\"min-w-0\"\u003e\n+            \u003ch2 class=\"ellipsize whitespace-nowrap text-xl\"\u003e\n+              \u003cRelayName {url} /\u003e\n+            \u003c/h2\u003e\n+            \u003cp class=\"ellipsize text-sm opacity-75\"\u003e{displayRelayUrl(url)}\u003c/p\u003e\n+          \u003c/div\u003e\n         \u003c/div\u003e\n+        \u003cRelayDescription {url} /\u003e\n+        {#if $relay?.profile}\n+          {@const {software, version, supported_nips, limitation} = $relay.profile}\n+          \u003cdiv class=\"flex flex-wrap gap-1\"\u003e\n+            {#if limitation?.auth_required}\n+              \u003cp class=\"badge badge-neutral\"\u003e\n+                \u003cspan class=\"ellipsize\"\u003eAuthentication Required\u003c/span\u003e\n+              \u003c/p\u003e\n+            {/if}\n+            {#if limitation?.payment_required}\n+              \u003cp class=\"badge badge-neutral\"\u003e\u003cspan class=\"ellipsize\"\u003ePayment Required\u003c/span\u003e\u003c/p\u003e\n+            {/if}\n+            {#if limitation?.min_pow_difficulty}\n+              \u003cp class=\"badge badge-neutral\"\u003e\n+                \u003cspan class=\"ellipsize\"\u003eRequires PoW {limitation?.min_pow_difficulty}\u003c/span\u003e\n+              \u003c/p\u003e\n+            {/if}\n+            {#if Array.isArray(supported_nips)}\n+              \u003cp class=\"badge badge-neutral\"\u003e\n+                \u003cspan class=\"ellipsize\"\u003eNIPs: {supported_nips.join(\", \")}\u003c/span\u003e\n+              \u003c/p\u003e\n+            {/if}\n+            {#if software}\n+              \u003cp class=\"badge badge-neutral\"\u003e\u003cspan class=\"ellipsize\"\u003eSoftware: {software}\u003c/span\u003e\u003c/p\u003e\n+            {/if}\n+            {#if version}\n+              \u003cp class=\"badge badge-neutral\"\u003e\u003cspan class=\"ellipsize\"\u003eVersion: {version}\u003c/span\u003e\u003c/p\u003e\n+            {/if}\n+          \u003c/div\u003e\n+        {/if}\n+      \u003c/div\u003e\n+      \u003cdiv class=\"grid grid-cols-3 gap-2\"\u003e\n+        \u003cLink href={threadsPath} class=\"btn btn-primary\"\u003e\n+          \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n+            \u003cIcon icon=\"notes-minimalistic\" /\u003e\n+            Threads\n+            {#if $notifications.has(threadsPath)}\n+              \u003cdiv\n+                class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n+                transition:fade\u003e\n+              \u003c/div\u003e\n+            {/if}\n+          \u003c/div\u003e\n+        \u003c/Link\u003e\n+        \u003cLink href={calendarPath} class=\"btn btn-secondary\"\u003e\n+          \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n+            \u003cIcon icon=\"notes-minimalistic\" /\u003e\n+            Calendar\n+            {#if $notifications.has(calendarPath)}\n+              \u003cdiv\n+                class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n+                transition:fade\u003e\n+              \u003c/div\u003e\n+            {/if}\n+          \u003c/div\u003e\n+        \u003c/Link\u003e\n+        \u003c!-- \u003cLink href={jobsPath} class=\"btn btn-success\"\u003e --\u003e\n+        \u003c!--   \u003cdiv class=\"relative flex items-center gap-2\"\u003e --\u003e\n+        \u003c!--     \u003cIcon icon=\"jobs\" /\u003e --\u003e\n+        \u003c!--     Jobs --\u003e\n+        \u003c!--     {#if $notifications.has(jobsPath)} --\u003e\n+        \u003c!--       \u003cdiv --\u003e\n+        \u003c!--         class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\" --\u003e\n+        \u003c!--         transition:fade\u003e --\u003e\n+        \u003c!--       \u003c/div\u003e --\u003e\n+        \u003c!--     {/if} --\u003e\n+        \u003c!--   \u003c/div\u003e --\u003e\n+        \u003c!-- \u003c/Link\u003e --\u003e\n+        \u003cLink href={gitPath} class=\"btn btn-info\"\u003e\n+          \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n+            \u003cIcon icon=\"git\" /\u003e\n+            Git\n+            {#if $notifications.has(gitPath)}\n+              \u003cdiv\n+                class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n+                transition:fade\u003e\n+              \u003c/div\u003e\n+            {/if}\n+          \u003c/div\u003e\n+        \u003c/Link\u003e\n+        {#each $userRooms as room (room)}\n+          {@const roomPath = makeRoomPath(url, room)}\n+          \u003cLink href={roomPath} class=\"btn btn-neutral relative\"\u003e\n+            \u003cdiv class=\"flex min-w-0 items-center gap-2 overflow-hidden text-nowrap\"\u003e\n+              {#if channelIsLocked($channelsById.get(makeChannelId(url, room)))}\n+                \u003cIcon icon=\"lock\" size={4} /\u003e\n+              {:else}\n+                \u003cIcon icon=\"hashtag\" /\u003e\n+              {/if}\n+              \u003cChannelName {url} {room} /\u003e\n+            \u003c/div\u003e\n+            {#if $notifications.has(roomPath)}\n+              \u003cdiv class=\"absolute right-1 top-1 h-2 w-2 rounded-full bg-primary\" transition:fade\u003e\n+              \u003c/div\u003e\n+            {/if}\n+          \u003c/Link\u003e\n+        {/each}\n+        {#each $otherRooms as room (room)}\n+          \u003cLink href={makeRoomPath(url, room)} class=\"btn btn-neutral\"\u003e\n+            \u003cdiv class=\"relative flex min-w-0 items-center gap-2 overflow-hidden text-nowrap\"\u003e\n+              {#if channelIsLocked($channelsById.get(makeChannelId(url, room)))}\n+                \u003cIcon icon=\"lock\" size={4} /\u003e\n+              {:else}\n+                \u003cIcon icon=\"hashtag\" /\u003e\n+              {/if}\n+              \u003cChannelName {url} {room} /\u003e\n+            \u003c/div\u003e\n+          \u003c/Link\u003e\n+        {/each}\n+        \u003cButton onclick={addRoom} class=\"btn btn-neutral whitespace-nowrap\"\u003e\n+          \u003cIcon icon=\"add-circle\" /\u003e\n+          Create\n+        \u003c/Button\u003e\n       \u003c/div\u003e\n     \u003c/div\u003e\n-    \u003cdiv class=\"flex flex-col gap-2\"\u003e\n-      \u003cSpaceRelayStatus {url} /\u003e\n-      {#if owner}\n-        \u003cdiv class=\"card2 bg-alt\"\u003e\n-          \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n-            \u003cIcon icon=\"user-rounded\" /\u003e\n-            Latest Updates\n-          \u003c/h3\u003e\n-          \u003cProfileLatest {url} pubkey={owner}\u003e\n-            {#snippet fallback()}\n-              \u003cp class=\"text-sm opacity-60\"\u003eNo recent posts from the relay admin\u003c/p\u003e\n-            {/snippet}\n-          \u003c/ProfileLatest\u003e\n-        \u003c/div\u003e\n-      {/if}\n-    \u003c/div\u003e\n-  \u003c/div\u003e\n-\u003c/PageContent\u003e\n+  \u003c/PageContent\u003e\n+\u003c/div\u003e\n\\ No newline at end of file\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-wstprpt0","title":"From 1fe17b299cab3499a86b6807201a8af4de2a63b9 Mon Sep 17 00:00:00 2001","description":"From 1fe17b299cab3499a86b6807201a8af4de2a63b9 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Wed, 5 Nov 2025 11:20:44 +0500\nSubject: [PATCH] feat: add Git navigation to primary nav and space quick links\n\n---\n src/app/components/PrimaryNav.svelte      | 44 +++++++++++++++++++++++++++++++++++++++++++-\n src/app/components/SpaceQuickLinks.svelte | 14 ++++++++++++++\n 2 files changed, 57 insertions(+), 1 deletion(-)\n\ndiff --git a/src/app/components/PrimaryNav.svelte b/src/app/components/PrimaryNav.svelte\nindex 6a018be..6c77a4f 100644\n--- a/src/app/components/PrimaryNav.svelte\n+++ b/src/app/components/PrimaryNav.svelte\n@@ -13,7 +13,7 @@\n   import MenuOtherSpaces from \"@app/components/MenuOtherSpaces.svelte\"\n   import MenuSettings from \"@app/components/MenuSettings.svelte\"\n   import PrimaryNavItemSpace from \"@app/components/PrimaryNavItemSpace.svelte\"\n-  import {userRoomsByUrl, canDecrypt, PLATFORM_RELAYS, PLATFORM_LOGO} from \"@app/core/state\"\n+  import {userRoomsByUrl, canDecrypt, PLATFORM_RELAYS, PLATFORM_LOGO, decodeRelay} from \"@app/core/state\"\n   import {pushModal} from \"@app/util/modal\"\n   import {makeSpacePath} from \"@app/util/routes\"\n   import {notifications} from \"@app/util/notifications\"\n@@ -24,6 +24,7 @@\n   import HomeSmile from \"@assets/icons/home-smile.svg?dataurl\"\n   import SettingsMinimalistic from \"@assets/icons/settings-minimalistic.svg?dataurl\"\n   import Settings from \"@assets/icons/settings.svg?dataurl\"\n+  import Git from \"@assets/icons/git.svg?dataurl\"\n \n   type Props = {\n     children?: Snippet\n@@ -39,12 +40,47 @@\n \n   const openChat = () =\u003e ($canDecrypt ? goto(\"/chat\") : pushModal(ChatEnable, {next: \"/chat\"}))\n \n+  const openGit = () =\u003e {\n+    // Try to get current space from route params\n+    \n+    console.log('page', $page)\n+    console.log('spaceUrls', spaceUrls)\n+    const currentRelay = $page.params.relay\n+    if (currentRelay) {\n+      const url = decodeRelay(currentRelay)\n+      goto(makeSpacePath(url, \"git\"))\n+      return\n+    }\n+    // If not in a space, navigate to first available space's git\n+    if (spaceUrls.length \u003e 0) {\n+      goto(makeSpacePath(spaceUrls[0], \"git\"))\n+      return\n+    }\n+    // If no spaces available, show spaces menu\n+    showSpacesMenu()\n+  }\n+\n   const hasNotification = (url: string) =\u003e {\n     const path = makeSpacePath(url)\n \n     return !$page.url.pathname.startsWith(path) \u0026\u0026 $notifications.has(path)\n   }\n \n+  const gitNotification = $derived(() =\u003e {\n+    // Check if current space has git notifications\n+    const currentRelay = $page.params.relay\n+    if (currentRelay) {\n+      const url = decodeRelay(currentRelay)\n+      const gitPath = makeSpacePath(url, \"git\")\n+      return $notifications.has(gitPath)\n+    }\n+    // Check if any space has git notifications\n+    return spaceUrls.some(url =\u003e {\n+      const gitPath = makeSpacePath(url, \"git\")\n+      return $notifications.has(gitPath)\n+    })\n+  })\n+\n   let windowHeight = $state(0)\n \n   const itemHeight = 56\n@@ -128,6 +164,12 @@\n         notification={$notifications.has(\"/chat\")}\u003e\n         \u003cAvatar icon={Letter} class=\"!h-10 !w-10\" /\u003e\n       \u003c/PrimaryNavItem\u003e\n+      \u003cPrimaryNavItem\n+        title=\"Git\"\n+        onclick={openGit}\n+        notification={gitNotification()}\u003e\n+        \u003cAvatar icon={Git} class=\"!h-10 !w-10\" /\u003e\n+      \u003c/PrimaryNavItem\u003e\n       {#if PLATFORM_RELAYS.length !== 1}\n         \u003cPrimaryNavItem\n           title=\"Spaces\"\ndiff --git a/src/app/components/SpaceQuickLinks.svelte b/src/app/components/SpaceQuickLinks.svelte\nindex c005ab6..37f7c4d 100644\n--- a/src/app/components/SpaceQuickLinks.svelte\n+++ b/src/app/components/SpaceQuickLinks.svelte\n@@ -1,4 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n+\timport Git from '@assets/icons/git.svg?dataurl';\n   import {deriveRelay} from \"@welshman/app\"\n   import {fade} from \"@lib/transition\"\n   import CompassBig from \"@assets/icons/compass-big.svg?dataurl\"\n@@ -38,6 +39,7 @@\n   const goalsPath = makeSpacePath(url, \"goals\")\n   const threadsPath = makeSpacePath(url, \"threads\")\n   const calendarPath = makeSpacePath(url, \"calendar\")\n+  const gitPath = makeSpacePath(url, \"git\")\n \n   const addRoom = () =\u003e pushModal(RoomCreate, {url})\n \n@@ -140,5 +142,17 @@\n         \u003c/div\u003e\n       \u003c/Link\u003e\n     {/if}\n+    \u003cLink href={gitPath} class=\"btn btn-neutral w-full justify-start\"\u003e\n+      \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n+        \u003cIcon icon={Git} /\u003e\n+        Git\n+        {#if $notifications.has(gitPath)}\n+          \u003cdiv\n+            class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-neutral-content\"\n+            transition:fade\u003e\n+          \u003c/div\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    \u003c/Link\u003e\n   \u003c/div\u003e\n \u003c/div\u003e\n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-wudgs32r","title":"From 43dc3005da973003cbe2e8735dd35b187facbca7 Mon Sep 17 00:00:00 2001","description":"From 43dc3005da973003cbe2e8735dd35b187facbca7 Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Sun, 28 Dec 2025 20:33:07 +0500\nSubject: [PATCH] feat(git): implement automatic navigation to forked repositories\n\nAdd navigation functionality to automatically redirect users to their newly\nforked repository after successful fork completion.\n\nChanges:\n- Add navigateToForkedRepo function in git layout component\n  - Parses RepoAnnouncementEvent to extract repo name and pubkey\n  - Creates naddr using nip19.naddrEncode with proper relay information\n  - Constructs navigation path: /spaces/[relay]/git/[naddr]\n  - Uses SvelteKit's goto() for proper client-side navigation\n  - Includes comprehensive error handling with user-friendly toast messages\n\n- Integrate navigation callback with ForkRepoDialog\n  - Pass navigateToForkedRepo callback prop to ForkRepoDialog component\n  - Pass pubkey prop to ForkRepoDialog for proper event handling\n  - Navigation works for all repo types (GRASP, GitHub, GitLab, etc.)\n    that publish RepoAnnouncementEvent\n\n- Add ForkResult type definition locally\n  (since it's not exported from @nostr-git/ui package)\n\nBenefits:\n- Improved UX: Users are automatically taken to their fork after creation\n- Works universally: Supports all repository providers that publish events\n- Proper routing: Uses SvelteKit navigation for optimal performance\n- Error resilient: Graceful fallback with error messages if navigation fails\n\nRelated: Updates ForkRepoDialog component in @nostr-git/ui submodule\n---\n packages/nostr-git                                      |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte | 64 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n 2 files changed, 65 insertions(+), 1 deletion(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 7c37eeb..70fa873 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 7c37eeb5ace4372c617a0833008519c5fb45a252\n+Subproject commit 70fa873ac7ca689ae0e65126cfdf4c4c0c6ccb92\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 0b388fe..0c7763b 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -17,6 +17,18 @@\n   import {pushModal} from \"@app/util/modal\"\n   import {EditRepoPanel, ForkRepoDialog} from \"@nostr-git/ui\"\n   import {postRepoAnnouncement} from \"@lib/budabit/commands.js\"\n+  import {nip19} from \"nostr-tools\"\n+  \n+  // ForkResult type definition (matches @nostr-git/ui)\n+  interface ForkResult {\n+    repoId: string\n+    forkUrl: string\n+    defaultBranch: string\n+    branches: string[]\n+    tags: string[]\n+    announcementEvent: RepoAnnouncementEvent\n+    stateEvent: RepoStateEvent\n+  }\n   import type {RepoAnnouncementEvent, RepoStateEvent, IssueEvent, PatchEvent, PullRequestEvent, StatusEvent, CommentEvent, LabelEvent} from \"@nostr-git/shared-types\"\n   import {GIT_REPO_BOOKMARK_DTAG, GRASP_SET_KIND, DEFAULT_GRASP_SET_ID, parseGraspServersEvent, GIT_REPO_ANNOUNCEMENT, GIT_REPO_STATE, GIT_PULL_REQUEST, normalizeRelayUrl as normalizeRelayUrlShared, parseRepoAnnouncementEvent} from \"@nostr-git/shared-types\"\n   import {derived, get as getStore, type Readable} from \"svelte/store\"\n@@ -598,16 +610,68 @@\n     }\n   }\n \n+  function navigateToForkedRepo(result: ForkResult) {\n+    try {\n+      const parsed = parseRepoAnnouncementEvent(result.announcementEvent)\n+      const repoName = parsed.name\n+      \n+      if (!repoName || !$pubkey) {\n+        console.warn(\"Cannot navigate: missing repo name or pubkey\", { repoName, $pubkey })\n+        return\n+      }\n+\n+      // Extract relays from announcement event or use current relay\n+      const relays = parsed.relays \u0026\u0026 parsed.relays.length \u003e 0 \n+        ? parsed.relays \n+        : relay \n+          ? [relay] \n+          : []\n+\n+      // Use current relay or first relay from announcement\n+      const effectiveRelay = relay || relays[0]\n+      if (!effectiveRelay) {\n+        console.warn(\"Cannot navigate: no relay URL available\")\n+        pushToast({ message: \"Fork completed, but cannot navigate without a relay URL.\", theme: \"error\" })\n+        return\n+      }\n+\n+      // Create naddr\n+      const naddr = nip19.naddrEncode({\n+        kind: 30617, // GIT_REPO_ANNOUNCEMENT\n+        pubkey: $pubkey || \"\",\n+        identifier: repoName,\n+        relays: relays.length \u003e 0 ? relays : undefined,\n+      })\n+\n+      // Encode relay URL for the route\n+      const encodedRelay = encodeURIComponent(effectiveRelay)\n+      \n+      // Navigate to the forked repo page\n+      const targetPath = `/spaces/${encodedRelay}/git/${naddr}`\n+      console.log(\"🚀 Navigating to forked repo:\", targetPath)\n+      \n+      goto(targetPath)\n+    } catch (error) {\n+      console.error(\"Failed to navigate to forked repo:\", error)\n+      pushToast({ \n+        message: \"Fork completed, but navigation failed. Please manually navigate to the repository.\", \n+        theme: \"error\" \n+      })\n+    }\n+  }\n+\n   function forkRepo() {\n     if (!repoClass) return\n \n     pushModal(ForkRepoDialog, {\n       repo: repoClass,\n+      pubkey: $pubkey || \"\",\n       onPublishEvent: (event: any) =\u003e {\n         // Handle event publishing\n         postRepoAnnouncement(event, [])\n       },\n       graspServerUrls: graspServerUrls,\n+      navigateToForkedRepo: navigateToForkedRepo,\n     })\n   }\n \n--\nlibgit2 1.9.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-x9xaepcz","title":"Filters in issues and patches should be inclusive","description":"Right now they function like exclusive radio buttons. what we need is an inclusive checkbox-like behavior","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["enhancement","issue"]}
{"id":"flotilla-xe63tfsk","title":"Reset repo button removed issues and patches","description":"They only loaded after navigating back to repos list and back to repo.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue"]}
{"id":"flotilla-xlxg3x6a","title":"From f8ff163d610e8d1a342fcefb4baf292ac6c08708 Mon Sep 17 00:00:00 2001","description":"From f8ff163d610e8d1a342fcefb4baf292ac6c08708 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Thu, 17 Apr 2025 15:03:56 +1000\nSubject: [PATCH 3/3] Added support for custom rendering of  unkown event kinds\n\n---\n .env              | 2 +-\n package-lock.json | Bin 561695 -\u003e 581820 bytes\n 2 files changed, 1 insertion(+), 1 deletion(-)\n\ndiff --git a/.env b/.env\nindex 914777c..d774467 100644\n--- a/.env\n+++ b/.env\n@@ -5,7 +5,7 @@ VITE_PLATFORM_TERMS=\n VITE_PLATFORM_PRIVACY=\n VITE_PLATFORM_NAME=Budabit\n VITE_PLATFORM_LOGO=static/budabit.png\n-VITE_PLATFORM_RELAY=wss://budabit.nostr1.com\n+VITE_PLATFORM_RELAY=ws://127.0.0.1:7000\n VITE_PLATFORM_ACCENT=\"#D4AF37\"\n VITE_PLATFORM_DESCRIPTION=\"The Club for Builders in Freedom Tech.\"\n VITE_GLITCHTIP_API_KEY=\ndiff --git a/package-lock.json b/package-lock.json\nindex 588cb94c6d50d3f1c7a3c5dcb35f25ed706dba2b..a3e5738195a8e416a4875b789a592af93f4107ac 100644\nGIT binary patch\ndelta 10113\nzc$|%T39ua3bzRN\u0026KR^(~!UY6CkRT`kB!~ZZ_w@8KVklzvy{BjCS=tqqdY$g+p6;Gr\nzX6ZyKGL9A}4i_QOiz8M@r=-M*BL$QaeM_=r!da?PmRL;UvRScRByCqrmrE3BsZyzO\nzWTj^Yz+XtXf~t\u003es@80)\u0026PT%+Lz31NdU;fI4-@N|FwNCit*mGP?P^1eVKY!tq$?e28\nz_RVzouE?RAa=\u003e+?_g!toHZBZRceyC|P(1$Qfr?js\u0026bCd+Fdf(43go|-jqPM(p\u0026xwp\nze$_F@rfn\u0026zu#`ip$Zu)VV#\u003cLRzYsbDG;=fg*p=I@(V?w9lPwgy{ciXYW0O!?wA3~X\nz^(tAa1-a1B8P?);lB#z{kfad~4tqXY8(UefQ%H\u003eSU7fAy85m)GP9F~ZR;@p4)7ezQ\nzj9a2VsuMH?S)h45@(8eg5IJ-9ARJvCDz2d#!z~$bPsh%Hi4#k1{|\u0026300QTPLR\u0026x7l\nzD0z`_Wz!\u0026KM8Rv^Y*Z*iBB`@\u003cuSIv}V{y9Z)OoD~jj)A@iy2r+*OclE%cUxgm=zcg\nz${|)-sMl47D6)l|lPgXZx@6k~NOxjSKXQ8$E;kC@Mz\u003c5-=x\u003eKlwOncLN`_#HlD*U*\nz+weAW;fXuW-}rZ76m0gEDDkFe2-4PipONig*@qUH!Gfh0yc3C?0`Ci(Cm;4K$\u003ew!a\nz(A@dz7ad!GoV~)UlT(+$D_;*C0iXHx;6MDEp|d+zemyk$0ti1BLc#e=coY078a@Hq\nz\u0026xIagd@4\u003eA3iFyXr}8zjshUDOSHpQS-f\u003cKBxW)HNi9}Ju3%HR(;W\u003e#)9Mdl7?I}8\u0026\nzOoxl?1T7;fLN(A-vTerG!!fs*\u003cM!1PuUrK5Yta@s|8zJ5p00({hga|\u003ep6LSaziylf\nzAzykfge}3GxOht=1$(+Oouit@)~\u003cLfv5kP{bD@ijuI5OsXU=pqD-5#5RHdnR=ZMs%\nz1c)o?E?%*^j@O\u0026|6TCvE\u003e0TdCp(+~p3zJ1PA!Tz0ti`82JTdl^c1A)yIHjaf7QA{b\nzybHGpo~FW\u00261DXim5#dc8e6SU{AH4izICjf?Cr$@)aX;2Tu#2+WX`vNe7c=U-\u0026yTEH\nzr!bbF%v?t15;J7k0b1+mE\u003e_9u*\u0026dpmHwX\u003eJvSlu=\u003cyo@Ux6C2N8OFk8b4=ImP3AT=\nz8arNTpH26G+~7T3mt62nX5)baI4`eNTe|AF`{C}\u0026cTx9v+8pK+P!p9\u003cs5uz\u00269i%-\u003c\nzR-24mOjjrYv!*;zv\u003eATdYC36!C@HSjAeD)jo0Uj0FXkYDVkBkgB1ES_c;uvuPo\u0026K4\nzY\u003cm~bu\u003c!%BP{HqD;j`-#*|q2f!Ym-EkW\u003eZ@%T(IXqTUelNERmM\u003cN64Oaw#\u0026EOL1*v\nzp29}G8Pm1f+AJHV^\u003cJIH%u_T!NKh?jh_Ja?cdAoW7GK=Pdhi|ue-IcGyiSDAtzmRb\nzXaOZkaI)K*sA+0}p\u003cI8|CEB\u003e0CUGG_V5yc\u003cLX=Kf!iZ5CsV?$F8FTftDeI#~jjck0\nzIn|0|TFQuGn=TbAydRJ6gYi}He^cQ@;Pa_{hFHmdoVsa^6lQvrK0OlC\u003c5awxX$=cz\nzQde?jT_~B;g${AEMk`k)hl{)cx5T0D#@QA-Fc\u003cBD\u0026v$*vPARZpOYx\u003eyp4q8%*)J4$\nzSp?~yhCcEzfzLb{zO)BSFueo(\u003c\u0026!sUf}`VF+?Y4ZHPv@)jN-?`oYWW\u003c@;wzzW@;`W\nzO=mTnVc2}Pj$l=?ixf#Kmm0uYwr{fotJL#hcT#BeMO(@FFl~9H+1-Ccz6$RAMEEfH\nzw@\u003eXeN+7$qg3!qelH`o(B2ie3`Yf3rN)?(hr\u003eP\u003c`PRoh(Ok7y=3{?vDXNb\u003e5OdK;%\nzbviN\u0026\u003e}cGC`^Z!x#_jlw@~p02oTu~5z?@3p`qwru-9qp?x4!ozfUgARSjWkZ#\u003ctV=\nzBwoOrT0_igYBmvXO)5\u003ca_C=\u003eMnHI{8ZlMO1bKQn9!D+UEbxQuM)v8S!ZKG1rQAuny\nzvpS?O!!}\u0026QoKD#\u0026e$=UaEge1*kvI{\u0026(Ttqg@6ab74CFz\u0026+vm\u00265TDI%QL4Z_\u003cMY1I(\nz\u003ck?*AHIzc3X9y)x%W3s2!s774FSET-*\u0026`Bhe9@dwO\u003e%}VB%Y|1iBZ0l)MS~jk2!HD\nz$V#@9g=DS4XFl@81W\u003enbflI9SC+lHzG;mF{3@71cyJglyF+PJ+#bhJfm6\u003cr_Tg+tc\nz$?ROBoK\u0026V\u003c$;RQ4IiqV*V_wZEcn\u0026KTJBc*uG~Ky?bCBck4*1~X(cS\u0026|mq$%o^-aSK\nz*oy7x2hz#O?S0z)DMi_@+qIe39XDsWgy^%_d^Vmkx}YxLvO8~x4Y@fg;oaKUBVm70\nzk;#EajHff2tSshcpXtL\u003e5t)~)Sy~x3Q;_M8%Dq9cJR?#$`hc_l?CY^ZJMU$~;c!$9\nz5P;?|dip@XKDSh;!amGv(JoXwMPj_xl#6hwZjG}H+=nfwFA)qf8MelW@q8*+xJqX|\nz*GUv6b1rKxWQrvRM%@{9tH`*e)QNbuiM8{?1l1TfDYrDGZ\u003c_*l-p_~S@ZnXaP+e(!\nz_4=h#2S7h^OSupCE$J?FT-6j}5TB%Zt?iXdeY#wxCbB\u003e7Iha\u003e2+6!G(L^j2VTzN6I\nzDWuvqdgY1DmNkeH*v=3e6v`F7ZyUvSt3BeOW*zM@%59-\u003cnsz|IB=Ms%\u003c6}2;A5M*X\nz6}!m!S}|M7)idyvuV{qlk$h`NPV;TF=uGEYpU4hJ!!d-\u003c7fz|bS5xEy=A4{M\u00269xrV\nzoq8=\u003eqKbafU1ad7CUmp1J=c??\u003eTQvOx4s\u003e|6a15}gzh;28~j%3MjT{l9nB;sc\u0026;+(\nzOs8ql\u003c|Zsh(W#OGGrfGNh8dJNSGX4CDOHX!34KD\u0026_*}a@FZWP=+J*H+)`2N`;Tak;\nzZI6*`pU1`I?KlSbgG%@a$UU*S+WYcqy7PJ^{Ebj7s6|xmAf-FElJ57twP@F*IlMSf\nzd#OSq$xqV*qF-;MTNKM@$w86!MZYKZMY7vyRMHtmPA-hP3YonmMX8z@*I1kw8EC%9\nzRZSmFbn6wLY7Pe~Qo4O\u0026d!`mXzsHclGz#9Wg-@-mIcxA)gPgEhxnT4=wP}Wq_sQyz\nz%TGI;1r;ignp84%xs=IP\u003e0)l4N\u003e$YggLlh(u3scYj1\u003exO9(Eg\u0026TSY7yGt0zeSl4fB\nz\u0026E=QJ0)s3L2Cp@)hgYio)?1boYw@lHYo!LB%M77ZTgx^JVo\u0026eNvy@@#%y\u003c^hs$weH\nz(\u003ejAV5hQ+VQB1_yVsma(t!yP*T}WJk;\u0026bL8?M^*-\u003eUErUU\u0026?C3wjz9l1xvey!x3xg\nz\u003cklXaCWiUE\u003e?fKyKdAQWFfsLOOb(t-`UNG64W(Wyjn}fK-%)E~w~!M{JvC!b`GoCi\nzHLOF7\u003c=O;BeF14ICBiPF1-xsxjXZd`xKRZUY;PRi`DcxAD;!FKP;TQapi3J^!M\u0026~U\nzPd8o8b|rfYJo`xa+)e9k2FGqK*3_j_@0so5t;Q!9Qk_u@q{G^z\u003c#jO$Arr|(qt=z(\nz5v~\u003c2z1XZxD@6\u003eai58y_X}%6sBreC#n~G8DK-FB48y8^*rcJnxTJ!+H(WTL@fa65?\nzWE4TR3Gm{#!w=rOTfeM|{Q$vD)v;x{a8P*P9#Vc#2R`\u003e3;k!aN#w(usz26AmaZ|8j\nzjPLCc1g!1oq5Th7lBy#I9{bRe-h5bkVofLxh@thvA3D81g\u0026stDVx6uIito9V4GwBf\nz?G3nlmDj%=MsB\u003e\u0026iFNGwkW~U_**x?iQS`*xQT8p*hR?0H=7YC3A@B+w9O}RNr_nRt\nzYKISp?=\u0026^ZPy?\u003cEsfK(N`Kz-LIH=@9\u0026xMi?xqDSQx2jNYjJB4Gp8ZnjV@y4rYYxY3\nz2a\u00262H3\u0026uxQIk7PPIme{Du9GbK{;*w(d-(~$cZEu-i?IEsCKaiPj\u003et~C3=iuIWU5T5\nz4#hJQdmgt~xzZi4S`OgBtD!r=ufU;Wm*v%$uHFgWCbtuNTLmkWTkgV=9AJEB\u003c4N!~\nzw|NA-{H^GN;P@9pPi\u003csOTbijL^l\u003ccJC$D_ym3Dr9$Dv~(@WQ\u003eJGoX%zUO)Namj=(h\nz7\u003c(LiDG`2e*H*zQ@cx$rr~J#uqRBIR9=jR^c3Pu?!P{?zFENejs1Wxtq=uSPxUonx\nzu;}^Dz?(K;gf0\u003eDq#LBNd3@+`%CKW(N}5s;i-cn~rB1t0\u003ertpA8\u003eNNHvq_fJ6M3\u0026U\nzt57I-u^GVuJPeZMQ~mHUF!;0ZJ\u003ed1bHt-#t3EzJ?x@@X}NiljZlmOQXK@fqz7\u003e?Zs\nz-R!jm7;g@@lHk=(hb}R6ZKigooy-tRxy69ZlU++FPA3fyttA`YRHCM|3g-uWPf%K7\nzzDvjBix$(b\u0026;\u003eo7O\u003cUFc1VLehfRdC\u003ca7|3_xFv\u003ei)-bQV6y5-rVuy}{PyNTuJ9l3G\nzyWubXotU#Qge~wXBB=J\u003ecsCLS`u~U|PH`*gGI|6EcPHR\u0026eB)6j?I+ld\u003ct\u003c#\u003eo#ZJ`\nz@6Q@\u0026u{cFCzUvL=c\u0026CFBRM{ldu?;m%c\u003c2n\u0026qT3cTTq1+ZPG9L*T{cI_9?~\u003eWOT$n^\nzLML$}$W#x2Yo}vpcHsXLPSrPtLBzDBtJnY0{lI!Yik}m7i8Hp=QaJ#%Zw}tR5`8pa\nzNNvkaFA_BD;0lwZeXm@vj_Z|5JC6@*{bC6b3^(Tye6PZ2\u0026eW^NiI\u0026u;;\u003eg(anOfc+\nzOlh1$FxwdDuwTeYa@\u003c\u003cbS0@kM4_^3TaF~}(!yO?X`JYdR1A}ot2?fdEccaN;f-P*J\nzi6x}f06g?wV53%J\u003e}RWX$7swJJS|kxRyvLMGCg\u0026aKucY@*rlqIfL8`qWE-VPHIbc_\nz+Ec3-7!_hDYRZ*Id6Dd6\u003cwDU))|Gf!LdvB|V51e5d%zQaw0Yv5;QP?T(j9r#fL4=j\nz190DpqTqYKws~pi$\u003cIc\u003cQHsbix+2WaUyGf+`pn_8$3!\u0026{1!z~Ffp5Gz4tzsxPe@}(\nzH(a=ip=n\u0026|+DQ?s8hDYi\u003ej|UDx\u003e+I#TYlMAORkZ$8qI{h@bmp\u003cJtK96UcN=a3yF}G\nzjH9J!zE*2C3}y~pP4C\u003e;(!cm\u0026WInuOMIcs9$z@^r0Qi;9MUnu5qOl9RnssR@b3v%y\nzCj`g;Q?SEbrLQ-Kqm*j)vy-CZ=1?LJl`_\u0026KU+hAYMh?=(e78s{*u0t\u003cOzVNG\u003en(\u0026e\nzk{E^wO|qyB_zFjIm9}ctXhX~+8tzvU2X^?ASoHgwp_@UN1SftJLGPAtMqc@5;0+Xy\nz27y\u003cgD@\u003eATaA`Bk4`C}a^_`*Bp_Q\u003eRDPvM)q(GIjN4oR~o5VYWTATKuN_xOd#(ARJ\nz$Rq=Fi@f4zxN_5KTAVFr3Ybr\u003eymja7Q_\u003c_8NDx!Oi\u003eITf!wDEP9}8ipWHlgQ%RswC\nzb920v0I%Y)%N=Ew8d7YZky$uVF=3CBdo`}mr2`IvL0ZC=1$$JeR7!n_Am(m6*N`h-\nzzQE\u0026VRWEc\u0026yilW\u0026wznwNdkEduU?x?^+$uQn!Nw)\u003c{\u0026S%RjvtK5;Pu0Y?t3gqjX|JA\nzSBU`$Qquk=^4`pF{kJ#nJK?E@OLDf\u0026Ew+LkwmAp9(u_U;-ne`7@nynD-K!d+EjgyG\nzc+Tz{0_0aiTcCa=dT8hEPelLSr@{BX8zI2g-i#apPafSkv-8)#8U5d#\u0026=90Q9XcIB\nzwo\u0026lvUq|tW_chCdyt%J?zO`KTtFOl{cBEcLr^|G%A-Kf\u003e#CI40nkf#R4{Fw_QAA1!\nztug9kD^OaSW_pa@$n^!;(-liilY=BZPf2mUH5h2BoX6yLo-7D0jReR\u0026vD4t~e;s=C\nziCgh=ZKCbu{$Bk4Q1\u003cLgq5C#\u0026gpzjxd)\u003e8i)a7r\u0026+i(E*52vBir-NtgeZp8Z)Nw#w\nzf=ct9PV7{K(@d~^_Ry)jEY4N7c-x#glC8?%1RGQvKl*#o!{FXuj-CMDI~zH3cF$uR\nzh1(uEH%LozI|Y7reB\u0026YToqF_c@X9=L;#gq58\u0026^Vtu5Js\u003cSd#?p`sQWu=O\u003c!EB7qKk\nz?|;P}1J|y^qTrRE#ZYkW\u0026tgY{q\u003c4KQbgAQINLb4hc*vDSoaDQ@R7`cSV$mtmql#Ti\nzGgb?u*|M!\u003cj562iG+U#ISZO=us@9\u003cKM!H\u003c!M?|q\u003c3!W%o7BynyL#Yd%{do8ipnpG\u003e\nzT|wAbUweQL{\u003eA2l0Q\u0026M~a%\u003c0y@3|7$e-v\u0026hzza_wdc1=ZxRP%VO92-SiiMmrO5!QS\nzjuS4bLWY#7GN}qNK|0A+iR;a3X@_eXi\u0026+-VA!3;+i|~MrSKO}MR(vm`A\u0026zOn@nRRe\nz_OC)$PJTpKd+~+n)=mKZr3a4gyOIH+PsGlE^VA0Zp{tqz`~eYo\u003ey7AR3`tOi08iNJ\nzFvEIEfgKIHqqfbd0z4=D*+}6!bvs+tM{sjcE#bNXSNVe9HDnL3l{f=NsRmIY7sHX1\nzk#ewPNh2dDDsRT{v$54(5cuHNHrKH3y\u003e\u0026Ts6VGxC-hLwp({Y\u003eaT6!GsE;_1SC8in3\nznd)^~)sxnIQm(KXZ%{\u003c8%61z5qAz;}\u0026Z-4zlAyI@-p%GqEZk+1c}*\u003c%MUt\u0026z1(eR)\nzLJlC\u00265We%-?bvILh_n?P^zG\u003eVAq2ejKp4M!td0W_zhqPE(G~*IvG8SvW3YV1D^rPH\nzP8w\u00260w3V0^GO`7YllipLs~8N`ZqHzK?hugH=S7?z;\u003erAYR?#T2pkzp{=ORuik?r*D\nz+T4WHbg_$?G\u003cbF^k^_JIY~=Fh\u003eg(La)o0#31CIY`GzxwULWxs1q(Q{HiD)(XQat=9\nzGj9n=Gp}@TiOX0F(k~F{k\u003c}\u003eV;`8RXPi3%1w\u003eq\u003cu?j-AFtWvEFv3w?H3otPrbaIn!\nzeTdWYoEeQMi^LjuR!p!ER_ZN_zo(Dhc=vUX0qKn}z5=\u003cE`AqEOA@HfcAB%\u003eh^\u003cC1E\nzQGwTfDHgqZ9W_=kZ-tN*nL\u003co@Bzv_cmk\u003eD9t}u17)Ft)eu$K+a*d*OR\u003eeLj{V62#\u0026\nzIQrNz#4d#OM2fX1S#\u003ec{eRO6jDwima5*cEa$k_x`Uf3\u0026~;EgW?;o\u003cXUP)C2~2eCWA\nzcVAsz5dTu_p\u0026j#cG5pTRO~wr9mtx7gKY}TPca8=Oi$GM%YA\u003cFJY`_zc+Z`;5yp|ab\nzd4?\u003eZ9@g?PTrT18s8|@\u003cq*t2FojBL7N|UkfmAif\u00269tXjQm^Vk\u0026Ha?+c5#|%DIa\u00262f\nz-v8O=iTn26k}vtydJfXpq8E3*^2ONmXTYn4fYVD~i(LkY7\u003c!~5IHh(kDMGolRzchh\nzZ\u0026s_em~c{Yye`+hrdpS|5mTzeBLczvatbBbT2IjYx!gk1a8_\u003e@\u003e%\u003e6k^k5}k^ZPTB\nzv6=Qd^)Abzo$S|R4~EzI?JW3tKXMxUn`^N%S3crSemnSiM3T59Dxg\u003ej$0bA%h$Jr)\nzGKP\u003er=*0*jl^_L-zyuxv*Z*\u003co(uLb!ao_kO0USJ^4c`Z@JQY5\u0026+g{k;2Dnw;2BUjg\nzdm0~mir~FDi}z%CeL4L}e3{tx\u003eTYHI_3y\u0026VjJdkk{@9KD6C_dez\u003eW5\u003cpMevfICS3w\nzYkNqd\u003eYDb=?3vuMY-t\u003c8!13\u003ef9|Eu59YMjLKNda?ez_1k49piIXTU4}KDH5E8UfIk\nzBaeeC8yit@7\u003e)(S+vUjd5WZ\u00261g^rrFsJS~+S+\u003cmCd4cbg1$LBgb\u003c0^JwU|IwuAp`F\nz6b7Z|ehx9XjNnqlpn;RNT8D\u003cUc5Xm8qFv_~q+-hH+`#iDjh*ZFMx+q\u003c)C\u003cvz;M`AQ\nzcY*(`#*Q6TB}pQ%\u003cPD$xEjE041rfY?Ep}\u003eWel3;{UH!?=li-6_W9PtiHGGk=m|mWT\nz6Y#Jzb\u0026)\u003ch?QmqeN|j5!0%wh!X@aUQv?QAM6NWMM@m{;{*quTi?z\u003cXQYqv5Z+Q9SH\nz+#6RVO6~eJpGc0V_R??f-+AR5vD~GQ2AbyP{ou9VkHx?r{V\u003c$3Y6Wa#*^vuAg0Opj\nz61mJIm0E_R7fGKLB+N-J#8lrmt;wuAg%(9h=^`1Oq\u0026nm51R-#=Bvljf{H)uV#sf+q\nz)etmiD2bWOPs~}D?q|yl*iX9LV8zqnC!(\u003e#X)1S~)m8p6FqwzX?)\u003eqavCl\u003e}Z?GKj\nz+9NR\u003cJaaJ=J9~@wELQOLF(LEIn~%2%\u0026rC2`rZHdzqX41h9IShKqoP7QC(k)#PD=z!\nzJKT7jX\u003cMUquc?iwx$fd9HYm0eb+wf$j;3Be\u003e-q_4Y@;LI@l(rtqI0XF2fXl3V4=VL\nz%*MGT9}0@^X9AY`yMGv~AK8?\u0026fa!4};C?T97W{{oBKSE=x*_BERo8Xj9MIOGM;XIb\nz6P*TD$)nJ?WiM1MRntp_4u%TDlH97oH5bmL*=Aq!pmYz-\u003cNcbOC~^bRQF|\u0026O26e|6\nz@nK0Y;*~gW\u003c+v0}p=D\u003eC%5KxE`El\u0026x=g+?z+d2R4#)Uh\u003e+avJKiO`wI(iQ((W)nTR\nzB8$r\u0026=W4JOFh=m=F9avBS\u003chQoh7e\u003eoPo(L_NW%vBd}#AMFW%E?-R4XqD*=5YjcQ9!\nzSuV54_wc\u0026Mt5RC+m~A31\u0026ZhRLsFcW2tM8-rt_Y_GlU3=v-26ze`QX@v*!`e-F31~y\nzVMp%-FW\u003cKj1OMQq\u0026{6RH9|mM}`8O)D6)5n|e~H|E_0y-$\u003e^%L`jbG?)tP7Q8Jsd`0\nzaQ#Oc_}y#Ks#UuhZ3T*l-`lvv^j(CED@li7$@zkX-Eqcjjs3Y`S}CHH%%qjL*f%{U\nzmmL`K{5X!#=)}?(xr}*Iuht\u003cKMix`p_#~;)`Ejv`c=ohe%\u0026b~!iG!W08!a_-f8n(E\nz3|xKj@q55~|8V2czoD-No~JiAcV4M%8rH_T\u003cXX{^AcWzk_Y`5b+G6Wi8Tw}AQAX!;\nzcBj^LN=l=yk7!2_;f3m2ravKyT%wL;r;?AQN5vsoOt\u0026*5*TvO*E1RyQ(1kf3(_\u003ce`\nz$b1qr3*~+g4^c10%a#19BmKnx*Q?%$a^RmoxA7!+\u003cBo6?{P\u0026\u0026EqaS+1ojbp~`R1d?\nz4%Cm}oqK}7{TXs2`LPd`mch#\u0026l!3R\u0026jmJ7H?fMH?@sdH@o}xZR^-@E*YEZS2=_ePs\nzH%*pwNl%Y*Rl*rS^M+Psr\u003eS`r\u003eNPFF$z;$`e!*uIKb51i2?mM_o-?Xk\u003c\u0026IqfZ{M+T\nb9=w0|\u003c{isTN`v#i7lU^G\u003cWDyL*4O_ZD6tC{\n\ndelta 1871\nzc$_tqZLHf?8ON1#Z*K0|(RHHIy1voUt(}O}IB^`?gXzj~?AVTDUpvl=y*DLsUYwi6\nzapJ^|2hyf~*g%M\u003e\u003eb4^U(kcepq(Rqd0t4d1oi-+fsMZP8O=6nhE2}`_MZh**+?)2\u003e\nzdCr\u0026L`Tz8P\u0026M)3P{o?n(ctrzmEWxMX{5$dRop@~b2k^D6*#3(@y!Qb7^;Ya~Sb8ls\nzcn0o11|Ece!NJ||B^8{m4q8Y_Gpj;V\u0026@ohKO1N$7XoK=OMY7AfYo)jxCD}NFZ_mU=\nzt;0A1X%op#em+SHRg9i{!L\u0026Cnv@\u003c3{yO}y)Y\u003e-_-fTtdc-48E42%dv~PyhwDJ^~52\nz+yeLBq!-}zEpT*2_vHoGSxCIXw`saICf\u0026)R(M)^!3F2{5Dl;FoD5I#=f=ZH7+%lfm\nzY{U%+ei?ZFPTLTg{79DC)tWBKV\u0026G\u003c|UOg=i-HWe(XAk~9e3t_IpiO~eD{eHNU2%72\nze!0AG#KMqHcHOojF2{~hHiv?iwm99er;S;|OO2D\u003eTs3i\u003e8Sbb%W=^kH8\u003eww4H6E~f\nzZde$UEQb}DMqbDh\u003c7p7\u0026Z*yOQR~4YaZ_wbr75A?+IK9W!a6X$?wFy7\u003eGfhO!I2ANs\nz7%dG\u003cEKbnLEGV@sAI;FCPOXm*CDN?nb!^%xIIbX\u0026ENw6ho17TAPC8XkC^VNbyF\u003c_L\nzVDo7F%qs7-kHF{Pc)4*1Uco_p1\u0026{9b!T\u0026Je_$v9Fmv9kfs|bl?J8hh0+1A*UaaCbb\nzOG}orwSX%3r7=d}B3oY8WujV1qa@eh#jH%26QiShx`\u003e)-c3jZ9Lt~huJ#iSmCxK%z\nzc)1AfUqPeO9q=R\u003ciC^h%*PF?PL$+JFVcxWOdLgQvdBF`*Q*pqSxca1y4m6ELS!)~h\nz{47VPvs^2vx$Y95%Qda*%_qL0S|y\u0026Q%1kw9X^20CueZUkR;sV@;LNSGe3Z5z+)nF|\nzrrnW}dXHo=Mbe7I#3\u003c@rY1u*D(b$!}c0Wg;3nc0u\u00261Z*ZsVN%BpomJXyyhfF_Kefb\nzp3G\u0026YQj3?\u003ep{mZ5q@~{ke+Dm\u0026Bhv57w\u003euq;3AiPJBP(z#\u003eB$uoEd=Ri;N{q~MT)G(\nz@ItCrom+_D1(\u003elI)d~|aV{rMtldf7wYBtfdq\u0026qj{hJ)*=Io\u0026FWglNsPb-QEoi+;=A\nzOB_at9|Lf5Bc2G8HSjoi;nB$TrAJmJXW)xA*o1dHdP}{gv-x_bhx_x?EI*zVcs7+B\nz_epBn#Z{z_;I*jrh-G5BX=aoT+D^}T!)y2*UaGkqQZejczRfEvr4c;cA\u003cKyBkC-I9\nzun{$G_hIk\u003eJpOoO;m5z(yl1a*Vf2C+fd8{27thnT)tqSGT6eAJr0d?Y\u0026rawTQ\u003c#d|\nzJm+E*(G)AgF45`+*}*8A#@hs\u00265|\u0026j\u0026z)V*+M?Rub{$MP6X$v\u003cv1{c+(\u003c4|@5nGJD)\nzD@f4UjP2F`Dtx62PVD_}FZ7~4*dqp{z`9NwGvt}6h$gvE$BnK=E5rh$3RG8hNoj;v\nzob4Q2\u003c#?W8()}4qP;}76{P}b?a{H;8Jr?v9mc-F*$KOf!i#+^eX6-n9GT2Ck*LvV#\nz5JTaGCpV75XP@2J2bBT%=gXf\u003e0DzyKkJMcKD!2=teQxs*Jo*I4-yH9J`A`7Ph7WxY\nz{OE~r{}\u003cMXa_ElMezz6AcX{m!7he3=+M*Zo\u0026Gnxp!g~hmyRncQufOp%c;Kyd0bY7L\nzu|GU_WBp(?REqHn$3nCl-\u003c8AbKaJnD2~R!{`!oFSGwX-p$=`0CgeTtyhv7HBw0R`_\nz?pyJH?+ZVEH~y_7@Z!^J8Tjg-;%DKTUQ|;n;4O1H\u003cp;_nn=Vs\u0026#*}Q=YAcmC!e9-V\nzEioM=\u003ey8XlGg(qy5_HMu%|\u0026jxkWr_f?V0_l\u003e?D\u003cKQBy4|*FYPXMW--$f!x\u003e%zy5Lj\nz1PIUkE\u0026fO\u003ehQOyjh%Ei\u0026@A2c\u0026S@|$_pVqRf_-rRR@VQ=%s\u0026wsEFQZ|u\u003e\u0026wMr#m$i(\nzQ_Is\u003edd6`w(=1Vx8E|\u003eAmf|x*Qtjr_)qo!MhnC?\u003c_FV5f{LIcaQ4XGpMV)(fn)o~v\nz4@R4K;6soIzx|K+!8746k8PY^3;k0YKi~iKC+9Z8PtGMy-5I|Bl|-W!Za\u003c%JC*h66\nO=Jf}{r!t#gzWje7Ux#@B\n\n--\nlibgit2 1.8.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-y6pb6u1p","title":"From cf987ad45ffd2944e1b557ad1b752f70bbe14044 Mon Sep 17 00:00:00 2001","description":"From cf987ad45ffd2944e1b557ad1b752f70bbe14044 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Thu, 5 Jun 2025 11:49:45 -0700\nSubject: [PATCH 28/67] tweak relay status component\n\n---\n src/app/components/SpaceRelayStatus.svelte | 102 +++++++++++++++++++++++++++++++++++++++++++++++++++---------------------------------------------------\n 1 file changed, 51 insertions(+), 51 deletions(-)\n\ndiff --git a/src/app/components/SpaceRelayStatus.svelte b/src/app/components/SpaceRelayStatus.svelte\nindex f29235d..21d9aaf 100644\n--- a/src/app/components/SpaceRelayStatus.svelte\n+++ b/src/app/components/SpaceRelayStatus.svelte\n@@ -14,57 +14,57 @@\n   const owner = $derived($relay?.profile?.pubkey)\n \u003c/script\u003e\n \n-\u003cdiv class=\"card2 bg-alt\"\u003e\n-  \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n-    \u003cIcon icon=\"server\" /\u003e\n-    Relay Status\n-  \u003c/h3\u003e\n-  \u003cdiv class=\"flex flex-col gap-3\"\u003e\n+\u003cdiv class=\"card2 bg-alt flex flex-col gap-4\"\u003e\n+  \u003cdiv class=\"flex items-center justify-between\"\u003e\n+    \u003ch3 class=\"flex items-center gap-2 text-lg font-semibold\"\u003e\n+      \u003cIcon icon=\"server\" /\u003e\n+      Relay Details\n+    \u003c/h3\u003e\n     \u003cSocketStatusIndicator {url} /\u003e\n-    {#if $relay?.profile}\n-      {@const {software, version, supported_nips, limitation} = $relay.profile}\n-      \u003cdiv class=\"flex flex-wrap gap-1\"\u003e\n-        {#if owner}\n-          \u003cdiv class=\"badge badge-neutral\"\u003e\n-            \u003cspan class=\"ellipsize\"\u003eAdministrator: \u003cProfileLink unstyled pubkey={owner} /\u003e\u003c/span\u003e\n-          \u003c/div\u003e\n-        {/if}\n-        {#if $relay?.profile?.contact}\n-          \u003cdiv class=\"badge badge-neutral\"\u003e\n-            \u003cspan class=\"ellipsize\"\u003eContact: {$relay.profile.contact}\u003c/span\u003e\n-          \u003c/div\u003e\n-        {/if}\n-        {#if software}\n-          \u003cdiv class=\"badge badge-neutral\"\u003e\n-            \u003cspan class=\"ellipsize\"\u003eSoftware: {software}\u003c/span\u003e\n-          \u003c/div\u003e\n-        {/if}\n-        {#if version}\n-          \u003cdiv class=\"badge badge-neutral\"\u003e\n-            \u003cspan class=\"ellipsize\"\u003eVersion: {version}\u003c/span\u003e\n-          \u003c/div\u003e\n-        {/if}\n-        {#if Array.isArray(supported_nips)}\n-          \u003cp class=\"badge badge-neutral\"\u003e\n-            \u003cspan class=\"ellipsize\"\u003eSupported NIPs: {supported_nips.join(\", \")}\u003c/span\u003e\n-          \u003c/p\u003e\n-        {/if}\n-        {#if limitation?.auth_required}\n-          \u003cp class=\"badge badge-warning\"\u003e\n-            \u003cspan class=\"ellipsize\"\u003eAuth Required\u003c/span\u003e\n-          \u003c/p\u003e\n-        {/if}\n-        {#if limitation?.payment_required}\n-          \u003cp class=\"badge badge-warning\"\u003e\n-            \u003cspan class=\"ellipsize\"\u003ePayment Required\u003c/span\u003e\n-          \u003c/p\u003e\n-        {/if}\n-        {#if limitation?.min_pow_difficulty}\n-          \u003cp class=\"badge badge-warning\"\u003e\n-            \u003cspan class=\"ellipsize\"\u003eMin PoW: {limitation?.min_pow_difficulty}\u003c/span\u003e\n-          \u003c/p\u003e\n-        {/if}\n-      \u003c/div\u003e\n-    {/if}\n   \u003c/div\u003e\n+  {#if $relay?.profile}\n+    {@const {software, version, supported_nips, limitation} = $relay.profile}\n+    \u003cdiv class=\"flex flex-wrap gap-1\"\u003e\n+      {#if owner}\n+        \u003cdiv class=\"badge badge-neutral\"\u003e\n+          \u003cspan class=\"ellipsize\"\u003eAdministrator: \u003cProfileLink unstyled pubkey={owner} /\u003e\u003c/span\u003e\n+        \u003c/div\u003e\n+      {/if}\n+      {#if $relay?.profile?.contact}\n+        \u003cdiv class=\"badge badge-neutral\"\u003e\n+          \u003cspan class=\"ellipsize\"\u003eContact: {$relay.profile.contact}\u003c/span\u003e\n+        \u003c/div\u003e\n+      {/if}\n+      {#if software}\n+        \u003cdiv class=\"badge badge-neutral\"\u003e\n+          \u003cspan class=\"ellipsize\"\u003eSoftware: {software}\u003c/span\u003e\n+        \u003c/div\u003e\n+      {/if}\n+      {#if version}\n+        \u003cdiv class=\"badge badge-neutral\"\u003e\n+          \u003cspan class=\"ellipsize\"\u003eVersion: {version}\u003c/span\u003e\n+        \u003c/div\u003e\n+      {/if}\n+      {#if Array.isArray(supported_nips)}\n+        \u003cp class=\"badge badge-neutral\"\u003e\n+          \u003cspan class=\"ellipsize\"\u003eSupported NIPs: {supported_nips.join(\", \")}\u003c/span\u003e\n+        \u003c/p\u003e\n+      {/if}\n+      {#if limitation?.auth_required}\n+        \u003cp class=\"badge badge-warning\"\u003e\n+          \u003cspan class=\"ellipsize\"\u003eAuth Required\u003c/span\u003e\n+        \u003c/p\u003e\n+      {/if}\n+      {#if limitation?.payment_required}\n+        \u003cp class=\"badge badge-warning\"\u003e\n+          \u003cspan class=\"ellipsize\"\u003ePayment Required\u003c/span\u003e\n+        \u003c/p\u003e\n+      {/if}\n+      {#if limitation?.min_pow_difficulty}\n+        \u003cp class=\"badge badge-warning\"\u003e\n+          \u003cspan class=\"ellipsize\"\u003eMin PoW: {limitation?.min_pow_difficulty}\u003c/span\u003e\n+        \u003c/p\u003e\n+      {/if}\n+    \u003c/div\u003e\n+  {/if}\n \u003c/div\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-ylr9qnpc","title":"From bfd5236e722a2d60edbcc4fe31b6a752275849da Mon Sep 17 00:00:00 2001","description":"From bfd5236e722a2d60edbcc4fe31b6a752275849da Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Thu, 29 May 2025 14:45:04 -0700\nSubject: [PATCH 11/67] Add minimal style for quotes of chat messages\n\n---\n CHANGELOG.md                             |  1 +\n src/app/components/ChannelMessage.svelte |  2 +-\n src/app/components/Content.svelte        | 12 ++++++++++--\n src/app/components/ContentQuote.svelte   | 30 ++++++++++++++++++++----------\n 4 files changed, 32 insertions(+), 13 deletions(-)\n\ndiff --git a/CHANGELOG.md b/CHANGELOG.md\nindex 01f0775..b0cc8f4 100644\n--- a/CHANGELOG.md\n+++ b/CHANGELOG.md\n@@ -10,6 +10,7 @@\n * Remove room tag from threads/calendars\n * Show pubkey on profile detail\n * Support pasting pubkey into chat start dialog\n+* Add minimal style for quoted messages\n \n # 1.0.4\n \ndiff --git a/src/app/components/ChannelMessage.svelte b/src/app/components/ChannelMessage.svelte\nindex 98008e2..fa03213 100644\n--- a/src/app/components/ChannelMessage.svelte\n+++ b/src/app/components/ChannelMessage.svelte\n@@ -75,7 +75,7 @@\n         \u003c/div\u003e\n       {/if}\n       \u003cdiv class=\"text-sm\"\u003e\n-        \u003cContent {event} {url} /\u003e\n+        \u003cContent minimalQuote {event} {url} /\u003e\n         {#if thunk}\n           \u003cThunkStatus {thunk} class=\"mt-2\" /\u003e\n         {/if}\ndiff --git a/src/app/components/Content.svelte b/src/app/components/Content.svelte\nindex d9b2839..a92778a 100644\n--- a/src/app/components/Content.svelte\n+++ b/src/app/components/Content.svelte\n@@ -41,6 +41,7 @@\n     showEntire?: boolean\n     hideMediaAtDepth?: number\n     expandMode?: string\n+    minimalQuote?: boolean\n     depth?: number\n     url?: string\n   }\n@@ -52,6 +53,7 @@\n     showEntire = $bindable(false),\n     hideMediaAtDepth = 1,\n     expandMode = \"block\",\n+    minimalQuote = false,\n     depth = 0,\n     url,\n   }: Props = $props()\n@@ -129,7 +131,7 @@\n     \u003c/div\u003e\n   {:else}\n     \u003cdiv\n-      class=\"overflow-hidden text-ellipsis break-words\"\n+      class=\"flex flex-col overflow-hidden text-ellipsis break-words\"\n       style={expandBlock ? \"mask-image: linear-gradient(0deg, transparent 0px, black 100px)\" : \"\"}\u003e\n       {#each shortContent as parsed, i}\n         {#if isNewline(parsed) \u0026\u0026 !isBlock(i - 1)}\n@@ -154,7 +156,13 @@\n           \u003cContentMention value={parsed.value} {url} /\u003e\n         {:else if isEvent(parsed) || isAddress(parsed)}\n           {#if isBlock(i)}\n-            \u003cContentQuote {depth} {url} {hideMediaAtDepth} value={parsed.value} {event} /\u003e\n+            \u003cContentQuote\n+              {depth}\n+              {url}\n+              {hideMediaAtDepth}\n+              value={parsed.value}\n+              {event}\n+              minimal={minimalQuote} /\u003e\n           {:else}\n             \u003cLink\n               external\ndiff --git a/src/app/components/ContentQuote.svelte b/src/app/components/ContentQuote.svelte\nindex 2ef2f0c..ed8a7c9 100644\n--- a/src/app/components/ContentQuote.svelte\n+++ b/src/app/components/ContentQuote.svelte\n@@ -5,14 +5,14 @@\n   import {Router} from \"@welshman/router\"\n   import {tracker, repository} from \"@welshman/app\"\n   import type {TrustedEvent} from \"@welshman/util\"\n-  import {Address, DIRECT_MESSAGE, MESSAGE, THREAD, EVENT_TIME} from \"@welshman/util\"\n+  import {Address, getTagValue, DIRECT_MESSAGE, MESSAGE, THREAD, EVENT_TIME} from \"@welshman/util\"\n   import {scrollToEvent} from \"@lib/html\"\n   import Button from \"@lib/components/Button.svelte\"\n   import Spinner from \"@lib/components/Spinner.svelte\"\n   import NoteCard from \"@app/components/NoteCard.svelte\"\n   import NoteContent from \"@app/components/NoteContent.svelte\"\n   import {deriveEvent, entityLink, ROOM} from \"@app/state\"\n-  import {makeThreadPath, makeCalendarPath, makeRoomPath} from \"@app/routes\"\n+  import {makeThreadPath, makeSpacePath, makeCalendarPath, makeRoomPath} from \"@app/routes\"\n \n   type Props = {\n     value: any\n@@ -20,9 +20,10 @@\n     event: TrustedEvent\n     depth: number\n     url?: string\n+    minimal?: boolean\n   }\n \n-  const {value, event, depth, hideMediaAtDepth, url}: Props = $props()\n+  const {value, event, depth, hideMediaAtDepth, url, minimal}: Props = $props()\n \n   const {id, identifier, kind, pubkey, relays = []} = value\n   const idOrAddress = id || new Address(kind, pubkey, identifier).toString()\n@@ -37,11 +38,12 @@\n     ? nip19.neventEncode({id, relays: mergedRelays})\n     : new Address(kind, pubkey, identifier, mergedRelays).toNaddr()\n \n-  const openMessage = (url: string, room: string, id: string) =\u003e {\n+  const openMessage = (url: string, room: string | undefined, id: string) =\u003e {\n     const event = repository.getEvent(id)\n+    const path = room ? makeRoomPath(url, room) : makeSpacePath(url, \"chat\")\n \n     if (event) {\n-      goto(makeRoomPath(url, room))\n+      goto(path)\n       scrollToEvent(id)\n     }\n \n@@ -55,9 +57,9 @@\n       }\n \n       const [url] = tracker.getRelays($quote.id)\n-      const room = $quote.tags.find(nthEq(0, ROOM))?.[1]\n+      const room = getTagValue(ROOM, $quote.tags)\n \n-      if (url \u0026\u0026 room) {\n+      if (url) {\n         if ($quote.kind === THREAD) {\n           return goto(makeThreadPath(url, $quote.id))\n         }\n@@ -95,9 +97,17 @@\n \n \u003cButton class=\"my-2 block max-w-full text-left\" {onclick}\u003e\n   {#if $quote}\n-    \u003cNoteCard event={$quote} {url} class=\"bg-alt rounded-box p-4\"\u003e\n-      \u003cNoteContent {hideMediaAtDepth} {url} event={$quote} depth={depth + 1} /\u003e\n-    \u003c/NoteCard\u003e\n+    {#if minimal \u0026\u0026 $quote.kind === MESSAGE}\n+      \u003cdiv\n+        class=\"border-l-2 border-solid border-l-primary py-1 pl-2 opacity-90\"\n+        style=\"background-color: color-mix(in srgb, var(--primary) 10%, var(--base-300) 90%);\"\u003e\n+        \u003cNoteContent {hideMediaAtDepth} {url} event={$quote} depth={depth + 1} /\u003e\n+      \u003c/div\u003e\n+    {:else}\n+      \u003cNoteCard event={$quote} {url} class=\"bg-alt rounded-box p-4\"\u003e\n+        \u003cNoteContent {hideMediaAtDepth} {url} event={$quote} depth={depth + 1} /\u003e\n+      \u003c/NoteCard\u003e\n+    {/if}\n   {:else}\n     \u003cdiv class=\"rounded-box p-4\"\u003e\n       \u003cSpinner loading\u003eLoading event...\u003c/Spinner\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-yoake4t0","title":"From 25bf629cf117c22c01086fadb29d5e6f22d889dd Mon Sep 17 00:00:00 2001","description":"From 25bf629cf117c22c01086fadb29d5e6f22d889dd Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Wed, 14 May 2025 20:55:28 -0700\nSubject: [PATCH 1/2] feat: add repository state loading and branch switching with fallback handling\n\n---\n src/lib/util.ts                                            |   1 +\n src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte | 167 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------------------\n 2 files changed, 147 insertions(+), 21 deletions(-)\n\ndiff --git a/src/lib/util.ts b/src/lib/util.ts\nindex 209439a..d137a27 100644\n--- a/src/lib/util.ts\n+++ b/src/lib/util.ts\n@@ -36,6 +36,7 @@ export const FREELANCE_JOB = 32767\n   // GIT_REPOSITORY is mistakenly defined in welshman as 30403 which\n   // is a Draft Classified listing (nip99) kind in reality.\n export const GIT_REPO = 30617\n+export const GIT_REPO_STATE = 30618\n export const GIT_REPO_BOOKMARK_DTAG = 'followed_git_repos'\n \n export enum GitIssueStatus {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\nindex 5642ff0..1613054 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/code/+page.svelte\n@@ -1,34 +1,139 @@\n \u003cscript lang=\"ts\"\u003e\n+  import {getContext, onMount} from \"svelte\"\n   import {FileView} from \"@nostr-git/ui\"\n   import {GitBranch} from \"@lucide/svelte\"\n   import {listRepoFilesFromEvent, type FileEntry} from \"@nostr-git/core\"\n-  import {getContext} from \"svelte\"\n+  import {load} from \"@welshman/net\"\n+  import {nip19} from \"nostr-tools\"\n+  import {GIT_REPO_STATE} from \"@src/lib/util\"\n+  import {parseRepoStateEvent, type TrustedEvent} from \"@nostr-git/shared-types\"\n+  import {page} from \"$app/stores\"\n   import type {Readable} from \"svelte/store\"\n-  import type {TrustedEvent} from \"@welshman/util\"\n+    import { nthEq } from \"@welshman/lib\"\n \n-  const eventStore: Readable\u003cTrustedEvent\u003e = getContext(\"repo-event\")\n+  const {id, relay} = $page.params\n+  const relayArray = Array.isArray(relay) ? relay : [relay]\n \n-  let branches = $state([{name: \"master\", isDefault: true}]) // Replace with real branch fetch\n-  let selectedBranch = $state(\"master\")\n-  let files = $state([] as FileEntry[])\n+  const eventStore = getContext\u003cReadable\u003cTrustedEvent\u003e\u003e(\"repo-event\")\n \n-  async function fetchFiles(branch: string) {\n-    files = await listRepoFilesFromEvent({repoEvent: $eventStore, branch})\n+  // UI state\n+  let loading = true\n+  let error: string | null = null\n+  let files: FileEntry[] = []\n+  let branches: {name: string; isDefault: boolean}[] = []\n+  let selectedBranch = \"master\"\n+  let fallbackToBranches = false\n+\n+  async function tryLoadRepoStateEvent() {\n+    try {\n+      loading = true\n+      error = null\n+      fallbackToBranches = false\n+      files = []\n+      branches = []\n+\n+      const decoded = nip19.decode(id).data as {\n+        pubkey: string\n+        kind: number\n+        identifier: string\n+      }\n+      const filters = [\n+        {\n+          authors: [decoded.pubkey],\n+          kinds: [GIT_REPO_STATE],\n+          \"#d\": [decoded.identifier],\n+        },\n+      ]\n+      const [tagId, ...relays] = $eventStore.tags.find(nthEq(0, \"relays\")) || []\n+      const events = await load({relays: relays, filters})\n+      const event = events[0]\n+      if (event) {\n+        //files = await listRepoFilesFromEvent({repoEvent: event, branch: selectedBranch})\n+        try {\n+          const repoStateEvent = parseRepoStateEvent(event)\n+          branches = repoStateEvent.refs.map(branch =\u003e ({name: branch.ref, isDefault: false}))\n+        } catch (e) {\n+          branches = [{name: \"master\", isDefault: true}]\n+        }\n+        loading = false\n+        return\n+      } else {\n+        fallbackToBranches = true\n+        await loadBranchesFallback()\n+      }\n+    } catch (e) {\n+      error = (e as Error).message || \"Failed to load repository event.\"\n+      loading = false\n+    }\n   }\n \n-  $effect(() =\u003e {\n-    fetchFiles(selectedBranch)\n+  async function loadBranchesFallback() {\n+    try {\n+      branches = [{name: \"master\", isDefault: true}]\n+      selectedBranch = \"master\"\n+      // No repo event, so no files\n+      files = []\n+      loading = false\n+    } catch (e) {\n+      error = (e as Error).message || \"Failed to load branches.\"\n+      loading = false\n+    }\n+  }\n+\n+  // Reload files when branch changes (if event loaded)\n+  async function onBranchChange() {\n+    if (!fallbackToBranches) {\n+      try {\n+        loading = true\n+        files = []\n+        const decoded = nip19.decode(id).data as {\n+          pubkey: string\n+          kind: number\n+          identifier: string\n+        }\n+        const filters = [\n+          {\n+            authors: [decoded.pubkey],\n+            kinds: [GIT_REPO_STATE],\n+            \"#d\": [decoded.identifier],\n+          },\n+        ]\n+        const events = await load({relays: [relay], filters})\n+        const event = events[0]\n+        if (event) {\n+          files = await listRepoFilesFromEvent({repoEvent: event, branch: selectedBranch})\n+        } else {\n+          files = []\n+        }\n+        loading = false\n+      } catch (e) {\n+        error = (e as Error).message || \"Failed to load files for branch.\"\n+        loading = false\n+      }\n+    }\n+  }\n+\n+  onMount(() =\u003e {\n+    tryLoadRepoStateEvent()\n   })\n \u003c/script\u003e\n \n \u003cdiv class=\"rounded-lg border border-border bg-card\"\u003e\n   \u003cdiv class=\"p-4\"\u003e\n-    \u003cdiv class=\"mb-4 flex items-center justify-between\"\u003e\n-      \u003cdiv class=\"flex items-center gap-2\"\u003e\n+    {#if loading}\n+      \u003cdiv class=\"text-muted-foreground\"\u003eLoading repository files...\u003c/div\u003e\n+    {:else if error}\n+      \u003cdiv class=\"text-red-500\"\u003e{error}\u003c/div\u003e\n+    {:else if fallbackToBranches}\n+      \u003cdiv class=\"mb-2 text-muted-foreground\"\u003e\n+        No repository event found. Showing available branches.\n+      \u003c/div\u003e\n+      \u003cdiv class=\"mb-4 flex items-center gap-2\"\u003e\n         \u003cGitBranch class=\"h-5 w-5 text-muted-foreground\" /\u003e\n         \u003cselect\n           class=\"rounded border border-border bg-secondary px-2 py-1\"\n-          bind:value={selectedBranch}\u003e\n+          bind:value={selectedBranch}\n+          disabled\u003e\n           {#each branches as branch}\n             \u003coption value={branch.name}\u003e\n               {branch.name}\n@@ -37,15 +142,35 @@\n           {/each}\n         \u003c/select\u003e\n       \u003c/div\u003e\n-    \u003c/div\u003e\n-    \u003cdiv class=\"border-t border-border pt-4\"\u003e\n-      \u003cdiv class=\"space-y-2\"\u003e\n-        \u003cdiv class=\"space-y-2\"\u003e\n-          {#each files as file}\n-            \u003cFileView name={file.name} type={file.type} path={file.path} /\u003e\n+      \u003cdiv class=\"border-t border-border pt-4\"\u003e\n+        \u003cdiv class=\"text-muted-foreground\"\u003eNo files available for this branch.\u003c/div\u003e\n+      \u003c/div\u003e\n+    {:else}\n+      \u003cdiv class=\"mb-4 flex items-center gap-2\"\u003e\n+        \u003cGitBranch class=\"h-5 w-5 text-muted-foreground\" /\u003e\n+        \u003cselect\n+          class=\"rounded border border-border bg-secondary px-2 py-1\"\n+          bind:value={selectedBranch}\n+          on:change={onBranchChange}\u003e\n+          {#each branches as branch}\n+            \u003coption value={branch.name}\u003e\n+              {branch.name}\n+              {branch.isDefault ? \" (default)\" : \"\"}\n+            \u003c/option\u003e\n           {/each}\n-        \u003c/div\u003e\n+        \u003c/select\u003e\n+      \u003c/div\u003e\n+      \u003cdiv class=\"border-t border-border pt-4\"\u003e\n+        {#if files.length === 0}\n+          \u003cdiv class=\"text-muted-foreground\"\u003eNo files found in this branch.\u003c/div\u003e\n+        {:else}\n+          \u003cdiv class=\"space-y-2\"\u003e\n+            {#each files as file}\n+              \u003cFileView name={file.name} type={file.type} path={file.path} /\u003e\n+            {/each}\n+          \u003c/div\u003e\n+        {/if}\n       \u003c/div\u003e\n-    \u003c/div\u003e\n+    {/if}\n   \u003c/div\u003e\n \u003c/div\u003e\n--\nlibgit2 1.8.1\n\n","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["patch","root"]}
{"id":"flotilla-ypwcxqk4","title":"From ea62036528a6d06a1f6a8dee1748ac2369b93de4 Mon Sep 17 00:00:00 2001","description":"From ea62036528a6d06a1f6a8dee1748ac2369b93de4 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Tue, 3 Jun 2025 10:41:38 -0700\nSubject: [PATCH 14/67] Use encrypted uploads\n\n---\n pnpm-lock.yaml                                  | Bin 494118 -\u003e 492330 bytes\n src/app/components/ChatCompose.svelte           | 14 +++++++++++++-\n src/app/components/ContentLinkBlockImage.svelte | 33 +++++++++++++++++++++++++++++----\n src/app/editor/index.ts                         | 23 ++++++++++-------------\n 4 files changed, 52 insertions(+), 18 deletions(-)\n\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 1d3e7b2f765bed151a06fbb6db406ebbb0308c8a..e5d3f9b51bf5f02998ad745b794177e978e344e3 100644\nGIT binary patch\ndelta 1486\nzc$`}{MQ\u0026A_+=Mvm{Ib-dqRf=kVk\u003c5M1$Bq=)STjs+{8Tn#DW5KD}|iQylg8yJ$\u003c-v\nzL1J=tVtQ\u0026ZNPc=hKbvShURBBYc_pcNC8$QHl;z^p1e8bBkeZTNl3#\u003ef4=+\u003e`M9uVt\nzPZ@=k@tU5NnwnC~HQkYyO;`@Ms+`OuuIUq%*o1\u003e{tI116^H@=8PGTiq%fTw9E52Y9\nz!5?l#`K2YPMX071XQt\u003c+;s^z(Hi!~5ZNOkj#nk1DtPP|DRaa?AW)5DfKnga-{Na?v\nzn?xo*P?i$KE_04cUy)$K0qK{-DLdVdhfRF)WhN0kjsPYm9F73WY(C3\u003cmQkKSS^;Sn\nz$00YJQ5EO{bv}G90460IE\u0026$0y@M+`G3ru1-^a5q3ACzH}oP3Q\u003e1dk8E2@Z!3Ac+xZ\nzi11_`erbZK5oC%4F3IWsf^1TgC-939Or1E4fk;lz=L334l?k7hz^N67m%wt\u003c7x1x3\nzOzsm9!IQs1$rogX7\u003cQ@Vivrs(3NW\u0026VY|l+)v`?Jwew=ac^c!DUd8YTCVC\u003eqy_9Wv0\nz_U-(a7(H)qf4i0`qkQ`_Rpw;T?N6\u003clJFTZ%KV*~LKC6;\u003er_%PPbC?U(O}`b)F3\u003eLP\nz!?Io0hjps$_OqR=5!ut-zOpKVjLeu0G\u003ev_F=nq!@\u003e9(gBdA8SmV|~sz9cZ}7_Ju!K\nq=S\u003cn\u0026(#zJbw_R%wTPXMT)5qDQrKdmgVin*1_7U5;g6%-Fearwe;Uaqg\n\ndelta 1877\nzc${riTa4Ri6;_h5r=4yu(@tl$x9PAHN-\u003c4r$99t4EsW!FZqCiIlQ?-8ZQ?j_Vkb@\u003c\nzJBd?}wxU|33ZX$M{Okh=q!oz!E\u003e)FX?L#Xh1Ph`9X\u003c2PWRfItMun){?B@jX\u0026;VFA*\nz#r{v{_MLP7??31N!E@{1y}rJ)edE6OU;Ah2L+juI40mSK!7~pOXAOQF96ALbn7wlF\nz#0Tyh=%H6VA86or\u003eo7FC0j\u003cq)hfadkMR;xY+L4v_;maVm2A=^ttMKA`F{d8N`ttJW\nzN9%y~1Mt4t=Fyc8(|\u003elK3%zx8\u003c\u0026nVU*;B_pw0!Y}W8Zt\u003em`C*0h6=d\u003c8_#E?h{;lH\nzuB0USsYQx{O^gtZ#DlT0O\u003eL\u003esp;0a8\u003cDA}OhN`M\u003esSc{8rbUS;A(n|Z%H3%Ui#HT)\nzB\u0026u}OVEJe~$|pmU\u003eiE(nkiQC@on8Cp+4\u003c`\u0026\u0026*7RU2%i0u2PwBG7O~L)QtgatNZpo$\nzY_g8v5s7UPW8E5rWTD$2iZaf!0jyUnbtlfWFHx\u003ccw1t+!ounB@%}_\u003cj#Y@S0rJzj|\nz!(gnvYTw$0\u0026Vsjp\u003c@x\u0026Tnb#2slk(#Niey?+y4)0dkrp$ok|dqTab\u003eKWMe\u003eo6iRNp(\nzO4by!5J{(bsaWqcSvsb6x@^}mDzP%{*jYR?(0T-#sS\u003eu\u003ciSCuTwF`X`eEBucH817|\nz81P\u0026uQE95=bUATa5lps8WR(#i)vz\u003e^;7ncAD@-\u0026a\u003eO2\u003e-8w~?vM!d|DcoOZ7o4HiY\nzv6Uhd%A{;5rzAu\u003cS){^2ecC|fB0cx~+Vh9S71cB\u003eOII#7l)7Q}WMz}|qks\u003e4E|j;X\nzLe|y?h9PhxAuDUcUMYn4v~WMvDh#q=dKkilJ|6BFBP`kK=DBh`$0o;gc@)jCWIr!j\nzH7P}p;=vqY$RR4B^Mp3w-3vbbF7(9w?caOIKZ0vN@;(NRoc4aY6e\u003c+CrqmKL8EtA\u0026\nzRa@!~YW\u003cvTrsMg1v(=\u0026Wh+U|L^g`UwM;hwjjv\u003eoIGTo3T97E\u003e$YNLm5Wd?17=JBji\nzmQ9iCcB$5U^~c`9c\u0026YA=B1LQl{UPw@1\u003ebooWHLQnQPC;RXp)+sLa8u^Rjesm$18|4\nz5%Xyzz~xd#4M){xufzv}0g);PxTao767@o\u0026P-|rsNh#uWEgMe;N0=c5^u4#cauYrd\nzKJ~o!-2CNpKK%I6mTFzB8@h#IF2AzTP)zVs;6\u003cb$\u0026l=5EJDSTAtU8QDlSo0UHl%9S\nz5}YC08\u003eXnH6IX;b9cQA$%s3G*ZV7=DuU7\u0026?u~!~OFdEOQs1T8)CLI=\u003eNQ\u003eh8w#)7O\nzFA?9)Q=sw\u0026d\u003c^_-$@\u003eYB4k`hm!4?x$b!Z|wol%-xO)bVJ=x7jUn\u003eLXZT\u0026\u0026F|qUlJ1\nz(U3k7NtKAO(Gw6(SLKS_NQ+K1IAMu+E5Tdxh|v`=IOjPD(64\u0026n1\u0026s1zvzNZ|F|hdt\nzbO_$Y{gj^qSN;l}1l\u003e2`eGeH\u003cgIjOH(EEmO-+_*=|4\u0026}pcyRP~Pir@w\u0026hW{NZNiWF\nzgP?yGURiKsLcnt$S_LoOh4(LPV}1\u003cm-gDK@{S#h\u003cTouQ`v;S~8Kl}^dW8gn`;S\u0026e8\nzQGeKvp-XOJ@EsWb_\u003cYCqz48S3\u003cy\u0026slt9N`GMXt?\u003c3k6HlBYDIOAcoRZagqr(Rj1y!\nzv;@agg}g3H?UX\u0026ityGL8\u003c2|+$jFx%?O}4n^Ad)SYCCQv\u003ciRieLFE$gX(I3z0Z}=uZ\nzIrzvXft{`w5u+h2Kp0Mk!rIvc$|+2(o3\u003efp\u003e~gl4BkPWs6G~\u00262$\u0026fKRB(~``T}Fxn\nzk*h}7f~_#bVAK*UtEe`*1FS1CK`k|iOJEuGtb\u003e0qdzQX*Gqy0l8H2umX}\u003e$;n=T=K\nza-O~lb+m\u003c`AN7OhccD$6D*^hq3unP?1A@U1ccG\u003co=bzlz^ONt\u003ce}2\u003c)`pPiSZP=#n\nz`mjA8xV;NqS$ZJ4rpsTL2i}2Bc~?K`!|\u003ezt@Vn5@uOGBbMY%Yx\u003e6\u00267020`r^cpbd+\nz7Q8n9`*ZMh|3iB?|NKq3eqiPQ_rpcK\u003cXzkV)Z_4BaOWztIKOurK6A\u003euaT(kn`%Z$(\ni61)PodHBdYc@O?tfAu3;aeD\u003cX#uiS@|CU~Sn))v+_+|S5\n\ndiff --git a/src/app/components/ChatCompose.svelte b/src/app/components/ChatCompose.svelte\nindex ed8f179..9a5a57b 100644\n--- a/src/app/components/ChatCompose.svelte\n+++ b/src/app/components/ChatCompose.svelte\n@@ -20,6 +20,8 @@\n \n   export const focus = () =\u003e editor.then(ed =\u003e ed.chain().focus().run())\n \n+  const uploadFiles = () =\u003e editor.then(ed =\u003e ed.chain().selectFiles().run())\n+\n   const submit = async () =\u003e {\n     if ($uploading) return\n \n@@ -40,11 +42,21 @@\n     submit,\n     uploading,\n     aggressive: true,\n-    disableFileUpload: true,\n   })\n \u003c/script\u003e\n \n \u003cform class=\"relative z-feature flex gap-2 p-2\" onsubmit={preventDefault(submit)}\u003e\n+  \u003cButton\n+    data-tip=\"Add an image\"\n+    class=\"center tooltip tooltip-right h-10 w-10 min-w-10 rounded-box bg-base-300 transition-colors hover:bg-base-200\"\n+    disabled={$uploading}\n+    onclick={uploadFiles}\u003e\n+    {#if $uploading}\n+      \u003cspan class=\"loading loading-spinner loading-xs\"\u003e\u003c/span\u003e\n+    {:else}\n+      \u003cIcon icon=\"gallery-send\" /\u003e\n+    {/if}\n+  \u003c/Button\u003e\n   \u003cdiv class=\"chat-editor flex-grow overflow-hidden\"\u003e\n     \u003cEditorContent {editor} /\u003e\n   \u003c/div\u003e\ndiff --git a/src/app/components/ContentLinkBlockImage.svelte b/src/app/components/ContentLinkBlockImage.svelte\nindex 87db740..36a02e6 100644\n--- a/src/app/components/ContentLinkBlockImage.svelte\n+++ b/src/app/components/ContentLinkBlockImage.svelte\n@@ -1,14 +1,39 @@\n \u003cscript lang=\"ts\"\u003e\n+  import {onMount, onDestroy} from \"svelte\"\n   import {getTags, getTagValue, tagsFromIMeta} from \"@welshman/util\"\n+  import {decryptFile} from \"@welshman/editor\"\n   import {imgproxy} from \"@app/state\"\n \n   const {value, event, ...props} = $props()\n \n   const url = value.url.toString()\n-  const meta = getTags(\"imeta\", event.tags)\n-    .map(tagsFromIMeta)\n-    .find(meta =\u003e getTagValue(\"url\", meta) === url)\n-  const src = imgproxy(url)\n+  const meta =\n+    getTags(\"imeta\", event.tags)\n+      .map(tagsFromIMeta)\n+      .find(meta =\u003e getTagValue(\"url\", meta) === url) || []\n+\n+  const key = getTagValue(\"decryption-key\", meta)\n+  const nonce = getTagValue(\"decryption-nonce\", meta)\n+  const encryptionAlgorithm = getTagValue(\"encryption-algorithm\", meta)\n+\n+  let src = $state(imgproxy(url))\n+\n+  onMount(async () =\u003e {\n+    if (encryptionAlgorithm === \"aes-gcm\" \u0026\u0026 key \u0026\u0026 nonce) {\n+      const response = await fetch(url)\n+\n+      if (response.ok) {\n+        const ciphertext = new Uint8Array(await response.arrayBuffer())\n+        const decryptedData = decryptFile({ciphertext, key, nonce, encryptionAlgorithm})\n+\n+        src = URL.createObjectURL(new Blob([new Uint8Array(decryptedData)]))\n+      }\n+    }\n+  })\n+\n+  onDestroy(() =\u003e {\n+    URL.revokeObjectURL(src)\n+  })\n \u003c/script\u003e\n \n \u003cimg alt=\"\" {src} {...props} /\u003e\ndiff --git a/src/app/editor/index.ts b/src/app/editor/index.ts\nindex c560a50..cab84a0 100644\n--- a/src/app/editor/index.ts\n+++ b/src/app/editor/index.ts\n@@ -35,7 +35,6 @@ export const makeEditor = async ({\n   submit,\n   uploading,\n   wordCount,\n-  disableFileUpload,\n }: {\n   aggressive?: boolean\n   autofocus?: boolean\n@@ -46,7 +45,6 @@ export const makeEditor = async ({\n   submit: () =\u003e void\n   uploading?: Writable\u003cboolean\u003e\n   wordCount?: Writable\u003cnumber\u003e\n-  disableFileUpload?: boolean\n }) =\u003e {\n   return new Editor({\n     content,\n@@ -69,18 +67,17 @@ export const makeEditor = async ({\n               aggressive,\n             },\n           },\n-          fileUpload: disableFileUpload\n-            ? false\n-            : {\n-                config: {\n-                  onDrop() {\n-                    uploading?.set(true)\n-                  },\n-                  onComplete() {\n-                    uploading?.set(false)\n-                  },\n-                },\n+          fileUpload: {\n+            config: {\n+              encryptionAlgorithm: \"aes-gcm\",\n+              onDrop() {\n+                uploading?.set(true)\n+              },\n+              onComplete() {\n+                uploading?.set(false)\n               },\n+            },\n+          },\n           nprofile: {\n             extend: {\n               addNodeView: () =\u003e makeMentionNodeView(url),\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-yr34tksr","title":"From db2fb33c956e7cd1f28fafc2e223025baca2d307 Mon Sep 17 00:00:00 2001","description":"From db2fb33c956e7cd1f28fafc2e223025baca2d307 Mon Sep 17 00:00:00 2001\nFrom: Jon Staab \u003cshtaab@gmail.com\u003e\nDate: Wed, 4 Jun 2025 20:42:28 -0700\nSubject: [PATCH 20/67] Tweak room search and owner display\n\n---\n src/app/components/ProfileLink.svelte  |   6 ++++--\n src/routes/spaces/[relay]/+page.svelte | 188 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-----\n 2 files changed, 187 insertions(+), 7 deletions(-)\n\ndiff --git a/src/app/components/ProfileLink.svelte b/src/app/components/ProfileLink.svelte\nindex 9eceee4..a63ff15 100644\n--- a/src/app/components/ProfileLink.svelte\n+++ b/src/app/components/ProfileLink.svelte\n@@ -1,4 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n+  import cx from 'classnames'\n   import {preventDefault} from \"@lib/html\"\n   import Button from \"@lib/components/Button.svelte\"\n   import ProfileName from \"@app/components/ProfileName.svelte\"\n@@ -8,13 +9,14 @@\n   type Props = {\n     pubkey: string\n     url?: string\n+    unstyled?: boolean\n   }\n \n-  const {pubkey, url}: Props = $props()\n+  const {pubkey, url, unstyled}: Props = $props()\n \n   const openProfile = () =\u003e pushModal(ProfileDetail, {pubkey, url})\n \u003c/script\u003e\n \n-\u003cButton onclick={preventDefault(openProfile)} class=\"link-content\"\u003e\n+\u003cButton onclick={preventDefault(openProfile)} class={cx({'link-content': !unstyled})}\u003e\n   @\u003cProfileName {pubkey} {url} /\u003e\n \u003c/Button\u003e\ndiff --git a/src/routes/spaces/[relay]/+page.svelte b/src/routes/spaces/[relay]/+page.svelte\nindex 43c89ff..dfcc950 100644\n--- a/src/routes/spaces/[relay]/+page.svelte\n+++ b/src/routes/spaces/[relay]/+page.svelte\n@@ -1,7 +1,7 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n-  import {displayRelayUrl} from \"@welshman/util\"\n-  import {deriveRelay} from \"@welshman/app\"\n+  import {displayRelayUrl, MESSAGE, THREAD} from \"@welshman/util\"\n+  import {deriveRelay, pubkey} from \"@welshman/app\"\n   import {AuthStatus, SocketStatus} from \"@welshman/net\"\n   import {fade} from \"@lib/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n@@ -10,6 +10,7 @@\n   import PageBar from \"@lib/components/PageBar.svelte\"\n   import PageContent from \"@lib/components/PageContent.svelte\"\n   import StatusIndicator from \"@lib/components/StatusIndicator.svelte\"\n+  import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import MenuSpaceButton from \"@app/components/MenuSpaceButton.svelte\"\n   import ProfileLatest from \"@app/components/ProfileLatest.svelte\"\n   import ChannelName from \"@app/components/ChannelName.svelte\"\n@@ -26,6 +27,7 @@\n     deriveOtherRooms,\n     userRoomsByUrl,\n     deriveSocket,\n+    deriveEventsForUrl,\n   } from \"@app/state\"\n   import {\n     makeChatPath,\n@@ -45,6 +47,7 @@\n   const threadsPath = makeThreadPath(url)\n   const calendarPath = makeCalendarPath(url)\n   const gitPath = makeGitPath(url)\n+  const mentions = deriveEventsForUrl(url, [{'#p': [$pubkey!], kinds: [MESSAGE, THREAD]}])\n \n   const joinSpace = () =\u003e pushModal(SpaceJoin, {url})\n \n@@ -52,7 +55,7 @@\n \n   let roomSearchQuery = $state(\"\")\n \n-  const pubkey = $derived($relay?.profile?.pubkey)\n+  const owner = $derived($relay?.profile?.pubkey)\n \n   const filteredRooms = $derived(() =\u003e {\n     if (!roomSearchQuery) return [...$userRooms, ...$otherRooms]\n@@ -224,17 +227,192 @@\n                 \u003cIcon icon=\"hashtag\" /\u003e\n               {/if}\n               \u003cChannelName {url} {room} /\u003e\n+    \u003c/div\u003e\n+    \u003cRelayDescription {url} /\u003e\n+  \u003c/div\u003e\n+  \u003cdiv class=\"card2 bg-alt md:hidden\"\u003e\n+    \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+      \u003cIcon icon=\"compass-big\" /\u003e\n+      Quick Links\n+    \u003c/h3\u003e\n+    \u003cdiv class=\"flex flex-col gap-2\"\u003e\n+      \u003cLink href={threadsPath} class=\"btn btn-primary w-full justify-start\"\u003e\n+        \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n+          \u003cIcon icon=\"notes-minimalistic\" /\u003e\n+          Threads\n+          {#if $notifications.has(threadsPath)}\n+            \u003cdiv\n+              class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n+              transition:fade\u003e\n+            \u003c/div\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/Link\u003e\n+      \u003cLink href={calendarPath} class=\"btn btn-secondary w-full justify-start\"\u003e\n+        \u003cdiv class=\"relative flex items-center gap-2\"\u003e\n+          \u003cIcon icon=\"calendar-minimalistic\" /\u003e\n+          Calendar\n+          {#if $notifications.has(calendarPath)}\n+            \u003cdiv\n+              class=\"absolute -right-3 -top-1 h-2 w-2 rounded-full bg-primary-content\"\n+              transition:fade\u003e\n+            \u003c/div\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/Link\u003e\n+      {#if $userRooms.length + $otherRooms.length \u003e 10}\n+        \u003clabel class=\"input input-sm input-bordered flex flex-grow items-center gap-2\"\u003e\n+          \u003cIcon icon=\"magnifer\" size={4} /\u003e\n+          \u003cinput\n+            bind:value={roomSearchQuery}\n+            class=\"grow\"\n+            type=\"text\"\n+            placeholder=\"Search rooms...\" /\u003e\n+        \u003c/label\u003e\n+      {/if}\n+      {#each filteredRooms() as room (room)}\n+        {@const roomPath = makeRoomPath(url, room)}\n+        {@const channel = $channelsById.get(makeChannelId(url, room))}\n+        \u003cLink href={roomPath} class=\"btn btn-neutral btn-sm relative w-full justify-start\"\u003e\n+          \u003cdiv class=\"flex min-w-0 items-center gap-2 overflow-hidden text-nowrap\"\u003e\n+            {#if channel?.closed || channel?.private}\n+              \u003cIcon icon=\"lock\" size={4} /\u003e\n+            {:else}\n+              \u003cIcon icon=\"hashtag\" /\u003e\n+            {/if}\n+            \u003cChannelName {url} {room} /\u003e\n+          \u003c/div\u003e\n+          {#if $notifications.has(roomPath)}\n+            \u003cdiv class=\"absolute right-1 top-1 h-2 w-2 rounded-full bg-primary\" transition:fade\u003e\n+            \u003c/div\u003e\n+          {/if}\n+        \u003c/Link\u003e\n+      {/each}\n+      {#if hasNip29($relay)}\n+        \u003cButton onclick={addRoom} class=\"btn btn-neutral btn-sm w-full justify-start\"\u003e\n+          \u003cIcon icon=\"add-circle\" /\u003e\n+          Create Room\n+        \u003c/Button\u003e\n+      {/if}\n+    \u003c/div\u003e\n+  \u003c/div\u003e\n+  \u003cdiv class=\"grid grid-cols-1 gap-2 lg:grid-cols-2\"\u003e\n+    \u003cdiv class=\"flex flex-col gap-2\"\u003e\n+      \u003cdiv class=\"card2 bg-alt\"\u003e\n+        \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+          \u003cIcon icon=\"chat-round\" /\u003e\n+          Recent Activity\n+        \u003c/h3\u003e\n+        \u003cdiv class=\"flex flex-col gap-3\"\u003e\n+          {#if $userRooms.length \u003e 0}\n+            {#each $userRooms.slice(0, 3) as room (room)}\n+              {@const channel = $channelsById.get(makeChannelId(url, room))}\n+              \u003cdiv class=\"flex items-center gap-3 rounded bg-base-100\"\u003e\n+                \u003cdiv class=\"flex items-center gap-2\"\u003e\n+                  {#if channel?.closed || channel?.private}\n+                    \u003cIcon icon=\"lock\" size={4} /\u003e\n+                  {:else}\n+                    \u003cIcon icon=\"hashtag\" /\u003e\n+                  {/if}\n+                  \u003cspan class=\"font-medium\"\u003e\n+                    \u003cChannelName {url} {room} /\u003e\n+                  \u003c/span\u003e\n+                \u003c/div\u003e\n+                \u003cspan class=\"ml-auto text-sm opacity-60\"\u003eActive conversations\u003c/span\u003e\n+              \u003c/div\u003e\n+            {/each}\n+          {:else}\n+            \u003cp class=\"text-sm opacity-60\"\u003eNo recent activity\u003c/p\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+    \u003cdiv class=\"flex flex-col gap-2\"\u003e\n+      \u003cdiv class=\"card2 bg-alt\"\u003e\n+        \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n+          \u003cIcon icon=\"server\" /\u003e\n+          Relay Status\n+        \u003c/h3\u003e\n+        \u003cdiv class=\"flex flex-col gap-3\"\u003e\n+          {#if $socket.status === SocketStatus.Open}\n+            {#if $socket.auth.status === AuthStatus.None}\n+              \u003cStatusIndicator class=\"bg-green-500\"\u003eConnected\u003c/StatusIndicator\u003e\n+            {:else if $socket.auth.status === AuthStatus.Requested}\n+              \u003cStatusIndicator class=\"bg-yellow-500\"\u003eAuthenticating\u003c/StatusIndicator\u003e\n+            {:else if $socket.auth.status === AuthStatus.PendingSignature}\n+              \u003cStatusIndicator class=\"bg-yellow-500\"\u003eAuthenticating\u003c/StatusIndicator\u003e\n+            {:else if $socket.auth.status === AuthStatus.DeniedSignature}\n+              \u003cStatusIndicator class=\"bg-red-500\"\u003eFailed to Authenticate\u003c/StatusIndicator\u003e\n+            {:else if $socket.auth.status === AuthStatus.PendingResponse}\n+              \u003cStatusIndicator class=\"bg-yellow-500\"\u003eAuthenticating\u003c/StatusIndicator\u003e\n+            {:else if $socket.auth.status === AuthStatus.Forbidden}\n+              \u003cStatusIndicator class=\"bg-red-500\"\u003eAccess Denied\u003c/StatusIndicator\u003e\n+            {:else if $socket.auth.status === AuthStatus.Ok}\n+              \u003cStatusIndicator class=\"bg-green-500\"\u003eConnected\u003c/StatusIndicator\u003e\n+            {/if}\n+          {:else if $socket.status === SocketStatus.Opening}\n+            \u003cStatusIndicator class=\"bg-yellow-500\"\u003eConnecting\u003c/StatusIndicator\u003e\n+          {:else if $socket.status === SocketStatus.Closing}\n+            \u003cStatusIndicator class=\"bg-gray-500\"\u003eNot Connected\u003c/StatusIndicator\u003e\n+          {:else if $socket.status === SocketStatus.Closed}\n+            \u003cStatusIndicator class=\"bg-gray-500\"\u003eNot Connected\u003c/StatusIndicator\u003e\n+          {:else if $socket.status === SocketStatus.Error}\n+            \u003cStatusIndicator class=\"bg-red-500\"\u003eFailed to Connect\u003c/StatusIndicator\u003e\n+          {/if}\n+          {#if $relay?.profile}\n+            {@const {software, version, supported_nips, limitation} = $relay.profile}\n+            \u003cdiv class=\"flex flex-wrap gap-1\"\u003e\n+              {#if owner}\n+                \u003cdiv class=\"badge badge-neutral\"\u003e\n+                  \u003cspan class=\"ellipsize\"\u003eAdministrator: \u003cProfileLink unstyled pubkey={owner} /\u003e\u003c/span\u003e\n+                \u003c/div\u003e\n+              {/if}\n+              {#if $relay?.profile?.contact}\n+                \u003cdiv class=\"badge badge-neutral\"\u003e\n+                  \u003cspan class=\"ellipsize\"\u003eContact: {$relay.profile.contact}\u003c/span\u003e\n+                \u003c/div\u003e\n+              {/if}\n+              {#if software}\n+                \u003cdiv class=\"badge badge-neutral\"\u003e\n+                  \u003cspan class=\"ellipsize\"\u003eSoftware: {software}\u003c/span\u003e\n+                \u003c/div\u003e\n+              {/if}\n+              {#if version}\n+                \u003cdiv class=\"badge badge-neutral\"\u003e\n+                  \u003cspan class=\"ellipsize\"\u003eVersion: {version}\u003c/span\u003e\n+                \u003c/div\u003e\n+              {/if}\n+              {#if Array.isArray(supported_nips)}\n+                \u003cp class=\"badge badge-neutral\"\u003e\n+                  \u003cspan class=\"ellipsize\"\u003eSupported NIPs: {supported_nips.join(\", \")}\u003c/span\u003e\n+                \u003c/p\u003e\n+              {/if}\n+              {#if limitation?.auth_required}\n+                \u003cp class=\"badge badge-warning\"\u003e\n+                  \u003cspan class=\"ellipsize\"\u003eAuth Required\u003c/span\u003e\n+                \u003c/p\u003e\n+              {/if}\n+              {#if limitation?.payment_required}\n+                \u003cp class=\"badge badge-warning\"\u003e\n+                  \u003cspan class=\"ellipsize\"\u003ePayment Required\u003c/span\u003e\n+                \u003c/p\u003e\n+              {/if}\n+              {#if limitation?.min_pow_difficulty}\n+                \u003cp class=\"badge badge-warning\"\u003e\n+                  \u003cspan class=\"ellipsize\"\u003eMin PoW: {limitation?.min_pow_difficulty}\u003c/span\u003e\n+                \u003c/p\u003e\n+              {/if}\n             \u003c/div\u003e\n           {/if}\n         \u003c/div\u003e\n       \u003c/div\u003e\n-      {#if pubkey}\n+      {#if owner}\n         \u003cdiv class=\"card2 bg-alt\"\u003e\n           \u003ch3 class=\"mb-4 flex items-center gap-2 text-lg font-semibold\"\u003e\n             \u003cIcon icon=\"user-rounded\" /\u003e\n             Latest Updates\n           \u003c/h3\u003e\n-          \u003cProfileLatest {url} {pubkey}\u003e\n+          \u003cProfileLatest {url} pubkey={owner}\u003e\n             {#snippet fallback()}\n               \u003cp class=\"text-sm opacity-60\"\u003eNo recent posts from the relay admin\u003c/p\u003e\n             {/snippet}\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-yr84afr9","title":"Feature: Releases with blossom","description":"Implement the nip that zapstore uses for software releases.\nShould use blossom to do this","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["enhancement","issue","releases"]}
{"id":"flotilla-z74j9605","title":"From 58c642d04d17926ecde519cf133d8738aafc99cb Mon Sep 17 00:00:00 2001","description":"From 58c642d04d17926ecde519cf133d8738aafc99cb Mon Sep 17 00:00:00 2001\nFrom: daniyal \u003cdaniyal@nostrdev.com\u003e\nDate: Thu, 20 Nov 2025 12:10:34 +0500\nSubject: [PATCH 3/4] feat(markdown): created a markdown component and used it in issue page\n\n---\n package.json                                                           |   4 ++++\n pnpm-lock.yaml                                                         | Bin 541733 -\u003e 549183 bytes\n src/lib/components/Markdown.svelte                                     | 591 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte | 173 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------------------------------\n 4 files changed, 683 insertions(+), 85 deletions(-)\n create mode 100644 src/lib/components/Markdown.svelte\n\ndiff --git a/package.json b/package.json\nindex 5b21328..ef9c385 100644\n--- a/package.json\n+++ b/package.json\n@@ -24,6 +24,7 @@\n     \"@sveltejs/vite-plugin-svelte\": \"^4.0.4\",\n     \"@types/eslint\": \"^9.6.1\",\n     \"@types/markdown-it\": \"^14.1.2\",\n+    \"@types/marked\": \"^6.0.0\",\n     \"@types/mustache\": \"^4.2.6\",\n     \"@types/throttle-debounce\": \"^5.0.2\",\n     \"@vitest/coverage-v8\": \"^3.2.4\",\n@@ -102,13 +103,16 @@\n     \"daisyui\": \"^4.12.24\",\n     \"date-fns\": \"^4.1.0\",\n     \"date-picker-svelte\": \"^2.16.0\",\n+    \"dompurify\": \"^3.3.0\",\n     \"dotenv\": \"^16.6.1\",\n     \"emoji-picker-element\": \"^1.27.0\",\n     \"fuse.js\": \"^7.1.0\",\n+    \"highlight.js\": \"^11.11.1\",\n     \"husky\": \"^9.1.7\",\n     \"idb\": \"^8.0.3\",\n     \"isomorphic-git\": \"https://github.com/chebizarro/isomorphic-git/releases/download/v2.0.0-alpha/isomorphic-git-2.0.0-alpha.tgz\",\n     \"markdown-it\": \"^14.1.0\",\n+    \"marked\": \"^17.0.0\",\n     \"mustache\": \"^4.2.0\",\n     \"nostr-signer-capacitor-plugin\": \"^0.0.4\",\n     \"nostr-tools\": \"^2.17.0\",\ndiff --git a/pnpm-lock.yaml b/pnpm-lock.yaml\nindex 53095d9b4f4893f93f0c545a65632b3e432ea7a0..175a157b1649942dc3ae1b425a444fc901d04f35 100644\nGIT binary patch\ndelta 7476\nzc%1E7TWl*w8CK%N32@q;qaIGrX-U~g#0oXL-kUEQWHqsq_!i$1+p#S~yO*(d;=N^O\nz)=ms1Isz3Q5S1{}A|WBQ5\u003elUlDnfoN@J1hcc|knVCoV#\u0026\u0026Lc+%G3%VFoFerJDKCE5\nz%gq1H\u003e^I~8`{$qWFMhE8_V3q!{nNWErsKJ=cRqPNbSES*!sK`C?Pc\u003c0*vV^m|FjDG\nzx\u003cM{Hd9ZeGnd2Cao7`W!y)t`axXYLBZ7y86zyLA=w2TnIi0MPDdy0pEtJ)R@7G_l2\nzj9t~zj%#b4ilJ@Mk2Q;NtdNl6Jjb)Kp1_JJl@;hXs{\u0026dSM2VJr0s*RuAS*1dCPnQ\u003c\nz\u003cfPpQ8m4*nkW0}VN3\u00267{xoIVW95=0F?4Sq\u0026#LCA5BPTU@c0\u003c@\u003cljJ6f-H3}+EiGd#\nztGY=jZU~uZ4;sLdO|T*CPTtBse-U7CT6P=*s\u0026c@1gWtDR3^0wb3uH5b1~$~vQbOf5\nzkz?t2l6*)MWR8}BrqQy(Nn%o#lY}yXVgePUl$=P!MOu=Q3N0pqL@OMx\u0026{CX\u003eD=8_V\nzh#Cl\u003eGujuAcym\u0026~J3(\u0026oc$Zi|V^C;-f(aM|v+~KLz\u003c#\u003e6!Dsk7;lJ;8c9pEbHja%\u003e\nzBC%KH_Z6qA)G`%ZREt@)JKC=uj7Xomk\u0026}xNPJ{Cz3)(xd3X7!{SBD4LqORoBpj\u003eE\u003c\nz3tR;jC5C_;RVW9QmfSwHwc~=\u003c;U!#vBiL!T289zFs%8sykN3yjBTiR^ilODpUY9pm\nzIp2a\u003eyJDzjWvEz(hGNw}ZhHY`z7-D|2hZ|R0Ts-asAda^azo|I\u003cEBt;bogp^1QoMr\nz65Ls3+!\u003cFIYP\u003ew|h=l2=L\u0026!Y#adN4Ai\u0026gW*VK?78(Q?L6fpMthBzQmwsAkjCc*E=F\nzBtbnl\u003c6gI2hrK#;pwrdfkhL@WjiXxG\u0026Y#\u003cH\u0026Q*+~LXNnDG\u0026nQsZe54AE+~5u7a+\u0026B\nzh*v-IeOiO00\u003eQw49{0Bmp8b@^asS\u0026IpF7|)TyXNYXDiFHI{?~5e)5@x\u003cm7GknNX5p\nzFX`uA3_mh(-FuVYvR|Cs\u003e@F\u003e^m)}_TK0g=iT(EP\u0026UW;Ha|FV@_^#Ad%\u003ctO~=*}@Z-\nz-(wbT%;h+j\u003c6Mr{CC67+=lYxLZ?3=V(cgR7Z*Ta2{bBf4hW+a15Mr\u003c$XGDf)H@Ab9\nzC}!Cj*ycqh#Sl9NE)ivb5J~Y0kMOp@@Qg@`{x^Rfe%}A^C*eE(!?o4tE`J24eSfR6\nzbmO9-Lqs`-*M}CR%ZTzU4Y+;V0u*sB3-$;(3sb5tTYZ2Ssy5R#MF?sX)~{YnK*^Ry\nzc~0MzH9%o|W-;V|0i^\u0026eQ$xazjF9TtE)@(PS{~3S\u003cT=ig?P6x~;KyI~ou4h=`mXcA\nz)cIiHmCeu1^7HKk*=gT0Hk\u00268ri6e`dQ4^W^nc74BCd9Gij#N_IteC2^r\u003eWA=\u003eTqn*\nz?yD!ceq(\u003evC\u003e#if4%92o8DI7|y)2sAe*MI5sbV!zv~#6A@=r^lXM@qp6vCcD\u00261RL-\nzKo458pOm4@84HTUwIS4q4Pr#uBWs5IFCh9Fg\u003e35F_9)G!EE`i60Kx2#uAzmnY#2ae\nzrhoqD!XMrbUmYm;A3j`+w%uqiQSKaa{al3u#Ua~h)fIgw345_-vX)A!TFnshmADHB\nzr*h^fb9Ml;N=%WeQ6A)2^=!=c_48)bY;yI1f~upv!*a(suBX$}*WX#Z@7(\u003cOc!D`W\nz+rfc^|G-+@Y_vxsTNFonDbvb!Yy)QMBe^!jT8zh?{lQ@!w|9?EI7?Osa*Hq4+GoN6\nz8!ZmCRO~cc\u003ceg~wfQ=F17x~j@*^M?^no}(K_upAu^KY\u0026$E%`6~W@\u0026Z0{`JsyYQA*L\nzmyY?;aXm*LJHw~_KcdjBxd!JNoNMq}G\u0026n8bP)!Wa(iqNv\u003e*df3\u0026C+1Evv\u003c6=2Rp@4\nztdx!JwoGn3Hk@+(s9f+8okIf;)a-DigRGOvAJ^L1fm9q-\u00263v(xF\u003e\u003c}J\u003eWtL_PMis-\nzY\u0026FoK8H;oF?quEhlK\u003c3TA?)u(Lbt!~zZoLe($s%*`Hgo!$)fy)*z($wSNY5q#U\u0026Y*\nz)RBzj-gIvie)#H*tF\u0026Z$_TPrT^M#eK_|8X5VgKc=)jLz^-{CiQpZ;_\u003c5hN5JWmfJ^\nz|DIV{zC8~#^FT8XG}jYo\u003ec=aIyH8yOnwhY-sBgV8y\u003eGA7fBFC4K2FK@@jI*GtFHW=\nNOn77ZtH|nb?LUe(o@D?4\n\ndelta 302\nzc%0jRNO5V0;)WR#lW$3!-~35ZfpPM3$IR\u0026`q\u0026RpcpOLfP\u003e\u003e+Q;w)v=PDi=t2^9^Hf\nzJ}AS0Y4T??pXm-fto)PjRTypV^Eku`lA6q3tTI_r!D#Y^3d!jK+t}Er39\u003c@JzN5r5\nz`D~c%=Ji2GR3_iI)0nPc%^^Km-(F#}X~p#P=~^Edr6x~!t~I@DGb``pr;pW|uRqv+\nz{Q;w)#\u0026%gQrac$7XWeG1ESR1e!_L2bg%7iV1\u003c\u003cCX$\u00266LP\u003e?MgsNr^c*ljl0-Z1?J6\nz4lrpCKgbNkEZf5mvMx9`9jKjWyUPT\u0026Uv1kbh_lae+3pd;E+PWao+\u003epx-;\u003cqnyHW|e\npxWsgzK9TK7J?!S|Kn~mvbYLCF^j9m`T\u0026Mqc=3w7`\u0026zU1p768mjcd-Bf\n\ndiff --git a/src/lib/components/Markdown.svelte b/src/lib/components/Markdown.svelte\nnew file mode 100644\nindex 0000000..cd9ec6d\n--- /dev/null\n+++ b/src/lib/components/Markdown.svelte\n@@ -0,0 +1,591 @@\n+\u003cstyle\u003e\n+  .markdown {\n+    @apply text-base leading-relaxed;\n+  }\n+\n+  .markdown :global(h1) {\n+    @apply mb-4 mt-6 text-3xl font-bold;\n+  }\n+\n+  .markdown :global(h2) {\n+    @apply mb-3 mt-5 text-2xl font-bold;\n+  }\n+\n+  .markdown :global(h3) {\n+    @apply mb-2 mt-4 text-xl font-semibold;\n+  }\n+\n+  .markdown :global(h4) {\n+    @apply mb-2 mt-3 text-lg font-semibold;\n+  }\n+\n+  .markdown :global(h5) {\n+    @apply mb-1 mt-2 text-base font-semibold;\n+  }\n+\n+  .markdown :global(h6) {\n+    @apply mb-1 mt-2 text-sm font-semibold;\n+  }\n+\n+  .markdown :global(p) {\n+    @apply my-3;\n+  }\n+\n+  .markdown :global(a) {\n+    @apply text-primary hover:underline;\n+  }\n+\n+  .markdown :global(strong) {\n+    @apply font-bold;\n+  }\n+\n+  .markdown :global(em) {\n+    @apply italic;\n+  }\n+\n+  .markdown :global(code) {\n+    @apply rounded bg-base-200 px-1.5 py-0.5 font-mono text-sm;\n+    color: hsl(var(--bc) / 0.9);\n+  }\n+\n+  .markdown :global(pre) {\n+    @apply my-4 overflow-x-auto rounded-lg border border-base-300 bg-base-300/50 p-4;\n+    box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);\n+  }\n+\n+  .markdown :global(pre code) {\n+    @apply bg-transparent p-0 text-sm;\n+    font-family: \"Menlo\", \"Monaco\", \"Courier New\", monospace;\n+    line-height: 1.5;\n+  }\n+\n+  .markdown :global(blockquote) {\n+    @apply my-4 border-l-4 border-primary pl-4 italic;\n+  }\n+\n+  .markdown :global(ul) {\n+    @apply my-3 list-disc pl-6;\n+  }\n+\n+  .markdown :global(ol) {\n+    @apply my-3 list-decimal pl-6;\n+  }\n+\n+  .markdown :global(li) {\n+    @apply my-1;\n+  }\n+\n+  .markdown :global(hr) {\n+    @apply my-6 border-t border-base-300;\n+  }\n+\n+  /* Table wrapper for horizontal scroll on mobile */\n+  .markdown :global(table) {\n+    @apply my-4 w-full border-collapse;\n+    display: block;\n+    overflow-x: auto;\n+    -webkit-overflow-scrolling: touch;\n+  }\n+\n+  @media (min-width: 768px) {\n+    .markdown :global(table) {\n+      display: table;\n+    }\n+  }\n+\n+  .markdown :global(th) {\n+    @apply border border-base-300 bg-base-200 p-2 font-semibold;\n+    white-space: nowrap;\n+  }\n+\n+  @media (min-width: 768px) {\n+    .markdown :global(th) {\n+      white-space: normal;\n+    }\n+  }\n+\n+  .markdown :global(td) {\n+    @apply border border-base-300 p-2;\n+    white-space: nowrap;\n+  }\n+\n+  @media (min-width: 768px) {\n+    .markdown :global(td) {\n+      white-space: normal;\n+    }\n+  }\n+\n+  .markdown :global(img) {\n+    @apply my-4 h-auto max-w-full;\n+  }\n+\n+  /* Profile mentions - ensure proper vertical alignment */\n+  .markdown :global(.inline-flex) {\n+    vertical-align: middle;\n+  }\n+\u003c/style\u003e\n+\n+\u003cscript lang=\"ts\"\u003e\n+  import {marked, type Token, type Tokens, type TokenizerAndRendererExtension} from \"marked\"\n+  import DOMPurify from \"dompurify\"\n+  import {nip19, nip05} from \"nostr-tools\"\n+  import hljs from \"highlight.js\"\n+  import \"highlight.js/styles/github-dark.css\"\n+  import {profilesByPubkey, loadProfile} from \"@welshman/app\"\n+  import {getContext, mount} from \"svelte\"\n+  import {REPO_RELAYS_KEY} from \"@lib/budabit\"\n+  import {normalizeRelayUrl} from \"@welshman/util\"\n+  import Profile from \"@app/components/Profile.svelte\"\n+  import ProfileLink from \"@app/components/ProfileLink.svelte\"\n+\n+  interface Props {\n+    content?: string\n+    relays?: string[]\n+  }\n+\n+  let {content = \"\", relays}: Props = $props()\n+\n+  let sanitizedContent = $state(\"\")\n+  let containerElement: HTMLDivElement | undefined = $state()\n+  let mountedComponents: Array\u003c{target: Element; component: any}\u003e = []\n+\n+  // Get relays from context if not provided\n+  const contextRelays = getContext\u003cstring[]\u003e(REPO_RELAYS_KEY)\n+  const defaultRelays = $derived.by(() =\u003e {\n+    if (relays \u0026\u0026 relays.length \u003e 0) {\n+      return relays.map((u: string) =\u003e normalizeRelayUrl(u)).filter(Boolean) as string[]\n+    }\n+    if (contextRelays \u0026\u0026 contextRelays.length \u003e 0) {\n+      return contextRelays.map((u: string) =\u003e normalizeRelayUrl(u)).filter(Boolean) as string[]\n+    }\n+    return []\n+  })\n+\n+  // Helper function to shorten URLs\n+  function shortenUrl(url: string, text?: string): string {\n+    // If custom text is provided and it's not the same as URL, use it\n+    if (text \u0026\u0026 text !== url) {\n+      return text\n+    }\n+\n+    try {\n+      const urlObj = new URL(url)\n+      const domain = urlObj.hostname.replace(\"www.\", \"\")\n+      const pathname = urlObj.pathname\n+\n+      if (pathname \u0026\u0026 pathname !== \"/\") {\n+        const pathParts = pathname.split(\"/\").filter(Boolean)\n+        if (pathParts.length \u003e 0) {\n+          // Show first part of path, truncate if too long\n+          const firstPath = pathParts[0]\n+          if (firstPath.length \u003e 20) {\n+            return `${domain}/${firstPath.substring(0, 15)}...`\n+          }\n+          return `${domain}/${firstPath}${pathParts.length \u003e 1 ? \"/...\" : \"\"}`\n+        }\n+      }\n+      return domain\n+    } catch (e) {\n+      // Fallback for invalid URLs\n+      return url.length \u003e 40 ? `${url.substring(0, 20)}...${url.substring(url.length - 15)}` : url\n+    }\n+  }\n+\n+  // Helper function to shorten Nostr URIs\n+  function shortenNostrUri(tagType: string, content: string): string {\n+    const fullUri = `${tagType}${content}`\n+    // Show first 8 and last 8 characters\n+    return `${fullUri.slice(0, 8)}:${fullUri.slice(-8)}`\n+  }\n+\n+  // Resolve NIP-05 identifier to pubkey using nostr-tools\n+  async function resolveNip05(identifier: string): Promise\u003cstring | null\u003e {\n+    if (!identifier.includes(\"@\")) {\n+      return null\n+    }\n+\n+    try {\n+      const profile = await nip05.queryProfile(identifier)\n+      return profile?.pubkey || null\n+    } catch (e) {\n+      console.error(`Failed to resolve NIP-05 ${identifier}:`, e)\n+      return null\n+    }\n+  }\n+\n+  // Get profile for a pubkey\n+  const getPub = async (token: Token) =\u003e {\n+    if (token.type === \"nostr\") {\n+      console.log(\"[markdown walkTokens getPub]\", token)\n+      const fullId = token.fullId\n+      if (!fullId) return\n+\n+      try {\n+        const result: any = nip19.decode(fullId)\n+        let pubkey: string | undefined\n+\n+        console.log(\"[markdown walkTokens getPub result]\", result, pubkey)\n+\n+        // Narrow types properly\n+        if (result.type === \"nprofile\") {\n+          pubkey = result.data.pubkey\n+        } else if (result.type === \"npub\") {\n+          pubkey = result.data\n+        }\n+\n+        if (!pubkey) return\n+\n+        token.pubkey = pubkey\n+\n+        // Get or load profile\n+        let profile = $profilesByPubkey.get(pubkey)\n+        if (!profile \u0026\u0026 defaultRelays.length \u003e 0) {\n+          await loadProfile(pubkey, defaultRelays)\n+          profile = $profilesByPubkey.get(pubkey)\n+        }\n+\n+        console.log(\"[markdown walkTokens getPub profile]\", profile)\n+\n+        if (profile) {\n+          token.userName = profile.name || profile.display_name || null\n+        }\n+      } catch (e) {\n+        console.error(\"Failed to decode nostr token:\", e, fullId)\n+      }\n+    } else if (token.type === \"email\") {\n+      try {\n+        const pubkey = await resolveNip05(token.text)\n+        if (pubkey) {\n+          token.isNip05 = true\n+          token.tagType = \"npub\"\n+          token.content = pubkey\n+          token.pubkey = pubkey\n+\n+          // Get or load profile\n+          let profile = $profilesByPubkey.get(pubkey)\n+          if (!profile \u0026\u0026 defaultRelays.length \u003e 0) {\n+            await loadProfile(pubkey, defaultRelays)\n+            profile = $profilesByPubkey.get(pubkey)\n+          }\n+\n+          if (profile) {\n+            token.userName = profile.name || profile.display_name || token.text\n+          } else {\n+            token.userName = token.text\n+          }\n+        } else {\n+          token.isNip05 = false\n+        }\n+      } catch (e) {\n+        console.error(`Failed to fetch NIP-05 user for ${token.text}:`, e)\n+        token.isNip05 = false\n+      }\n+    }\n+  }\n+\n+  // Bech32 characters are alphanumeric excluding '1', 'b', 'i', 'o'\n+  const nostrRegex = /^(nostr:)?(n(?:event|ote|pub|profile|addr)1[ac-hj-np-z02-9]{6,})/\n+  const nostrTokenizer: TokenizerAndRendererExtension = {\n+    name: \"nostr\",\n+    level: \"inline\",\n+    start(src: string) {\n+      const match = src.match(/(nostr:)?n(?:event|ote|pub|profile|addr)1/)\n+      return match ? match.index! : -1\n+    },\n+    tokenizer(src: string) {\n+      const match = nostrRegex.exec(src)\n+      if (match) {\n+        const [fullMatch, prefix, fullId] = match\n+        console.log(\"[markdown tokenizer match]\", match)\n+        // fullId is the complete npub1..., note1..., etc.\n+        return {\n+          type: \"nostr\",\n+          raw: fullMatch,\n+          text: fullMatch,\n+          fullId: fullId,\n+          prefix: prefix || \"\",\n+          userName: null,\n+          tokens: [],\n+        }\n+      }\n+    },\n+    renderer(token: Tokens.Generic) {\n+      const {fullId, userName, pubkey} = token\n+      let url = `/${fullId}`\n+      let external = false\n+\n+      try {\n+        const decoded = nip19.decode(fullId)\n+\n+        if (decoded.type === \"nevent\" || decoded.type === \"note\") {\n+          url = `https://coracle.social/notes/${fullId}`\n+          external = true\n+        } else if (decoded.type === \"nprofile\") {\n+          external = true\n+          url = `https://coracle.social/people/${fullId}`\n+\n+          // For npub and nprofile, create a placeholder that we'll replace with a Svelte component\n+          if (pubkey) {\n+            return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+          }\n+        } else if (decoded.type === \"npub\") {\n+          url = `/people/${fullId}`\n+\n+          // For npub and nprofile, create a placeholder that we'll replace with a Svelte component\n+          if (pubkey) {\n+            return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+          }\n+        } else if (decoded.type === \"naddr\") {\n+          const data = decoded.data\n+          // For git repos, use internal routing\n+          if (data.kind === 30617) {\n+            url = `/${fullId}`\n+          } else {\n+            external = true\n+            url = `https://coracle.social/${fullId}`\n+          }\n+        }\n+      } catch (err) {\n+        console.error(\"Failed to decode in renderer:\", err, fullId)\n+        // If decoding fails, use default URL\n+        url = `/${fullId}`\n+      }\n+\n+      // For other types, render as simple link\n+      const linkText = userName ? `@${userName}` : shortenNostrUri(\"\", fullId)\n+      const externalAttributes = external ? 'target=\"_blank\" rel=\"noopener noreferrer\"' : \"\"\n+      return `\u003ca href=\"${url}\" ${externalAttributes} \n+                    class=\"link\" title=\"${fullId}\"\u003e${linkText}\n+                    \u003c/a\u003e`\n+    },\n+  }\n+\n+  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+/\n+  const emailTokenizer: TokenizerAndRendererExtension = {\n+    name: \"email\",\n+    level: \"inline\",\n+    start(src: string) {\n+      const match = src.match(emailRegex)\n+      return match ? match.index! : -1\n+    },\n+    tokenizer(src: string) {\n+      const match = emailRegex.exec(src)\n+      if (match) {\n+        const [fullMatch] = match\n+        return {\n+          type: \"email\",\n+          raw: fullMatch,\n+          text: fullMatch,\n+          href: `mailto:${fullMatch}`,\n+          isNip05: false,\n+          tokens: [],\n+        }\n+      }\n+    },\n+    renderer(token: Tokens.Generic) {\n+      if (token.isNip05) {\n+        // Render as Nostr link - create placeholder for Svelte component\n+        const {pubkey} = token\n+        if (pubkey) {\n+          return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+        }\n+        return `\u003ca href=\"mailto:${token.text}\" class=\"link\"\u003e${token.text}\u003c/a\u003e`\n+      } else {\n+        return `\u003ca href=\"${token.href}\" class=\"link\"\u003e${token.text}\u003c/a\u003e`\n+      }\n+    },\n+  }\n+\n+  marked.use({\n+    extensions: [nostrTokenizer, emailTokenizer],\n+    async: true,\n+    breaks: true,\n+    walkTokens: getPub,\n+    renderer: {\n+      image() {\n+        return \"\"\n+      },\n+      link(token) {\n+        const {href, text} = token\n+\n+        // Check if href is a nostr URI\n+        const nostrMatch = href.match(\n+          /^(nostr:)?(n(?:event|ote|pub|profile|addr)1[ac-hj-np-z02-9]{6,})$/,\n+        )\n+        if (nostrMatch) {\n+          const fullId = nostrMatch[2]\n+\n+          try {\n+            const result: any = nip19.decode(fullId)\n+\n+            // For npub and nprofile, create placeholder for Profile component\n+            if (result.type === \"nprofile\" || result.type === \"npub\") {\n+              let pubkey = \"\"\n+              if (result.type === \"nprofile\") {\n+                pubkey = result.data.pubkey\n+              } else if (result.type === \"npub\") {\n+                pubkey = result.data\n+              }\n+\n+              if (pubkey) {\n+                return `\u003cspan class=\"nostr-profile-placeholder\" data-pubkey=\"${pubkey}\" data-url=\"\"\u003e\u003c/span\u003e`\n+              }\n+            }\n+\n+            // For other nostr types, create regular links\n+            let url = `/${fullId}`\n+            let external = false\n+\n+            if (result.type === \"nevent\" || result.type === \"note\") {\n+              url = `https://coracle.social/notes/${fullId}`\n+              external = true\n+            } else if (result.type === \"naddr\") {\n+              const data = result.data\n+              if (data.kind === 30617) {\n+                url = `/${fullId}`\n+              } else {\n+                external = true\n+                url = `https://coracle.social/${fullId}`\n+              }\n+            }\n+\n+            const externalAttributes = external ? 'target=\"_blank\" rel=\"noopener noreferrer\"' : \"\"\n+            const linkText = text || fullId\n+            return `\u003ca href=\"${url}\" ${externalAttributes} class=\"link\" title=\"${fullId}\"\u003e${linkText}\u003c/a\u003e`\n+          } catch (err) {\n+            console.error(\"Failed to decode nostr link:\", err, fullId)\n+          }\n+        }\n+\n+        // Regular URL handling\n+        const displayText = shortenUrl(href, text)\n+        return `\u003ca href=\"${href}\" class=\"link\" title=\"${href}\" target=\"_blank\" rel=\"noopener noreferrer\"\u003e${displayText}\u003c/a\u003e`\n+      },\n+      list(token) {\n+        const listItems = token.items\n+          .map(item =\u003e {\n+            const itemContent = this.parser.parseInline(item.tokens)\n+            return `\u003cli\u003e${itemContent}\u003c/li\u003e`\n+          })\n+          .join(\"\\n\")\n+\n+        const listClass = token.ordered ? \"list-decimal list-inside\" : \"list-disc list-inside\"\n+\n+        return token.ordered\n+          ? `\u003col class=\"${listClass}\"\u003e${listItems}\u003c/ol\u003e`\n+          : `\u003cul class=\"${listClass}\"\u003e${listItems}\u003c/ul\u003e`\n+      },\n+      code(token) {\n+        const validLang = token.lang || \"plaintext\"\n+        const highlightedCode = hljs.highlight(token.text, {\n+          language: validLang,\n+        }).value\n+\n+        return `\n+                    \u003cpre class=\"hljs\"\u003e\u003ccode class=\"language-${validLang}\"\u003e${highlightedCode}\u003c/code\u003e\u003c/pre\u003e\n+                `\n+      },\n+    },\n+  })\n+\n+  $effect(() =\u003e {\n+    if (content) {\n+      ;(async () =\u003e {\n+        const parsed = await marked(content)\n+        sanitizedContent = DOMPurify.sanitize(parsed, {\n+          ADD_ATTR: [\"target\", \"title\", \"data-pubkey\", \"data-url\"],\n+          ADD_TAGS: [\"span\"],\n+        })\n+      })()\n+    } else {\n+      sanitizedContent = \"\"\n+    }\n+  })\n+\n+  // Mount ProfileLink components after content is rendered\n+  $effect(() =\u003e {\n+    if (containerElement \u0026\u0026 sanitizedContent) {\n+      // Clean up previously mounted components\n+      mountedComponents.forEach(({component}) =\u003e {\n+        try {\n+          component.$destroy?.()\n+        } catch (e) {\n+          // Ignore errors during cleanup\n+        }\n+      })\n+      mountedComponents = []\n+\n+      // Find all profile placeholders and mount components\n+      setTimeout(() =\u003e {\n+        if (!containerElement) return\n+\n+        const placeholders = containerElement.querySelectorAll(\".nostr-profile-placeholder\")\n+        placeholders.forEach(placeholder =\u003e {\n+          const pubkey = placeholder.getAttribute(\"data-pubkey\")\n+          const url = placeholder.getAttribute(\"data-url\")\n+\n+          if (pubkey) {\n+            try {\n+              // Create a wrapper div to hold both components\n+              const wrapper = document.createElement(\"div\")\n+              wrapper.className = \"inline-flex items-center gap-1 align-middle\"\n+              wrapper.style.verticalAlign = \"middle\"\n+\n+              // Create containers for each component\n+              const avatarContainer = document.createElement(\"span\")\n+              const linkContainer = document.createElement(\"span\")\n+\n+              wrapper.appendChild(avatarContainer)\n+              wrapper.appendChild(linkContainer)\n+\n+              // Replace placeholder with wrapper\n+              placeholder.replaceWith(wrapper)\n+\n+              // Mount Profile component (avatar only, hideDetails=true)\n+              const profileComponent = mount(Profile, {\n+                target: avatarContainer,\n+                props: {\n+                  pubkey,\n+                  url: url || undefined,\n+                  avatarSize: 6,\n+                  hideDetails: true,\n+                },\n+              })\n+\n+              // Mount ProfileLink component (name only)\n+              const linkComponent = mount(ProfileLink, {\n+                target: linkContainer,\n+                props: {\n+                  pubkey,\n+                  url: url || undefined,\n+                },\n+              })\n+\n+              mountedComponents.push(\n+                {target: avatarContainer, component: profileComponent},\n+                {target: linkContainer, component: linkComponent},\n+              )\n+            } catch (e) {\n+              console.error(\"Failed to mount Profile components:\", e)\n+            }\n+          }\n+        })\n+      }, 0)\n+    }\n+\n+    return () =\u003e {\n+      // Cleanup on component unmount\n+      mountedComponents.forEach(({component}) =\u003e {\n+        try {\n+          component.$destroy?.()\n+        } catch (e) {\n+          // Ignore errors\n+        }\n+      })\n+    }\n+  })\n+\u003c/script\u003e\n+\n+\u003cdiv class=\"markdown max-w-full overflow-hidden\" bind:this={containerElement}\u003e\n+  {@html sanitizedContent}\n+\u003c/div\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte\nindex 217534d..60d0539 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/[issueid]/+page.svelte\n@@ -27,10 +27,10 @@\n   import {slide} from \"svelte/transition\"\n   import {getContext, onMount} from \"svelte\"\n   import {postComment, postStatus, postLabel, postRoleLabel} from \"@lib/budabit\"\n-  import { PeoplePicker } from \"@nostr-git/ui\"\n-  import { createLabelEvent, type LabelEvent } from \"@nostr-git/shared-types\"\n-  import { publishDelete } from \"@app/core/commands\"\n-  import { ROLE_NS } from \"@lib/budabit/labels\"\n+  import {PeoplePicker} from \"@nostr-git/ui\"\n+  import {createLabelEvent, type LabelEvent} from \"@nostr-git/shared-types\"\n+  import {publishDelete} from \"@app/core/commands\"\n+  import {ROLE_NS} from \"@lib/budabit/labels\"\n   import {\n     REPO_RELAYS_KEY,\n     deriveEffectiveLabels,\n@@ -39,7 +39,8 @@\n     loadRepoAnnouncements,\n     deriveRoleAssignments,\n   } from \"@lib/budabit\"\n-  import { normalizeEffectiveLabels, toNaturalArray } from \"@lib/budabit/labels\"\n+  import {normalizeEffectiveLabels, toNaturalArray} from \"@lib/budabit/labels\"\n+  import Markdown from \"@src/lib/components/Markdown.svelte\"\n \n   const markdown = markdownit({\n     html: true,\n@@ -121,7 +122,7 @@\n         content: \"\",\n         e: [issue.id],\n         namespaces: [value],\n-        labels: [{ value }],\n+        labels: [{value}],\n       }) as any\n       console.debug(\"[IssueDetail] addLabel event payload\", labelEvent)\n       postLabel(labelEvent as any, relays)\n@@ -170,16 +171,13 @@\n     return toNaturalArray(norm.flat)\n   })\n \n-  const roleAssignments = $derived.by(() =\u003e\n-    issue ? deriveRoleAssignments(issue.id) : undefined\n-  )\n+  const roleAssignments = $derived.by(() =\u003e (issue ? deriveRoleAssignments(issue.id) : undefined))\n   const assignees = $derived.by(() =\u003e\n-    Array.from((roleAssignments?.get()?.assignees || new Set()) as Set\u003cstring\u003e)\n+    Array.from((roleAssignments?.get()?.assignees || new Set()) as Set\u003cstring\u003e),\n   )\n \n   // PeoplePicker will render from LabelEvent[] directly\n \n-\n   // Resolve effective status using precedence rules (maintainers \u003e author \u003e others; kind; recency)\n   const resolved = $derived.by(() =\u003e {\n     if (!$statusEvents || !issue) return undefined\n@@ -258,49 +256,49 @@\n     return thunk\n   }\n \n-    // Profile functions for PeoplePicker\n-    const getProfile = async (pubkey: string) =\u003e {\n-        const profile = $profilesByPubkey.get(pubkey)\n-        if (profile) {\n-            return {\n-                name: profile.name,\n-                picture: profile.picture,\n-                nip05: profile.nip05,\n-                display_name: profile.display_name,\n-            }\n-        }\n-        // Try to load profile if not in cache\n-        // Filter out invalid relay URLs to prevent errors\n-        const validRelays = (repoClass.relays || []).filter((relay: string) =\u003e {\n-            try {\n-                const url = new URL(relay)\n-                return url.protocol === 'ws:' || url.protocol === 'wss:'\n-            } catch {\n-                console.warn(`Invalid relay URL filtered out: ${relay}`)\n-                return false\n-            }\n-        })\n-        \n-        if (validRelays.length \u003e 0) {\n-            await loadProfile(pubkey, validRelays)\n-        }\n-        \n-        const loadedProfile = $profilesByPubkey.get(pubkey)\n-        if (loadedProfile) {\n-            return {\n-                name: loadedProfile.name,\n-                picture: loadedProfile.picture,\n-                nip05: loadedProfile.nip05,\n-                display_name: loadedProfile.display_name,\n-            }\n-        }\n-        return null\n+  // Profile functions for PeoplePicker\n+  const getProfile = async (pubkey: string) =\u003e {\n+    const profile = $profilesByPubkey.get(pubkey)\n+    if (profile) {\n+      return {\n+        name: profile.name,\n+        picture: profile.picture,\n+        nip05: profile.nip05,\n+        display_name: profile.display_name,\n+      }\n+    }\n+    // Try to load profile if not in cache\n+    // Filter out invalid relay URLs to prevent errors\n+    const validRelays = (repoClass.relays || []).filter((relay: string) =\u003e {\n+      try {\n+        const url = new URL(relay)\n+        return url.protocol === \"ws:\" || url.protocol === \"wss:\"\n+      } catch {\n+        console.warn(`Invalid relay URL filtered out: ${relay}`)\n+        return false\n+      }\n+    })\n+\n+    if (validRelays.length \u003e 0) {\n+      await loadProfile(pubkey, validRelays)\n     }\n \n+    const loadedProfile = $profilesByPubkey.get(pubkey)\n+    if (loadedProfile) {\n+      return {\n+        name: loadedProfile.name,\n+        picture: loadedProfile.picture,\n+        nip05: loadedProfile.nip05,\n+        display_name: loadedProfile.display_name,\n+      }\n+    }\n+    return null\n+  }\n+\n   const searchProfiles = async (query: string) =\u003e {\n     // profileSearch.searchValues returns an array of pubkeys (strings)\n     const pubkeys = $profileSearch.searchValues(query)\n-    \n+\n     // Map each pubkey to a profile object by looking it up in profilesByPubkey\n     return pubkeys.map((pubkey: string) =\u003e {\n       const profile = $profilesByPubkey.get(pubkey)\n@@ -320,20 +318,23 @@\n \u003c/svelte:head\u003e\n \n {#if issue}\n-  \u003cdiv class=\"z-10 sticky top-0 items-center justify-between py-2 sm:py-4 backdrop-blur px-2 sm:px-0\" transition:slide\u003e\n-    \u003cCard class=\"git-card transition-colors p-4 sm:p-6\"\u003e\n+  \u003cdiv\n+    class=\"z-10 sticky top-0 items-center justify-between px-2 py-2 backdrop-blur sm:px-0 sm:py-4\"\n+    transition:slide\u003e\n+    \u003cCard class=\"git-card p-4 transition-colors sm:p-6\"\u003e\n       \u003cdiv class=\"flex items-start gap-2 sm:gap-4\"\u003e\n         {#if statusIcon}\n           {@const {icon: Icon, color} = statusIcon()}\n           \u003cdiv class=\"mt-1 flex-shrink-0\"\u003e\n-            \u003cdiv class=\"flex h-8 w-8 sm:h-10 sm:w-10 items-center justify-center rounded-full bg-amber-500/10\"\u003e\n+            \u003cdiv\n+              class=\"flex h-8 w-8 items-center justify-center rounded-full bg-amber-500/10 sm:h-10 sm:w-10\"\u003e\n               \u003cIcon class={`h-4 w-4 sm:h-6 sm:w-6 ${color}`} /\u003e\n             \u003c/div\u003e\n           \u003c/div\u003e\n         {/if}\n         \u003cdiv class=\"min-w-0 flex-1\"\u003e\n-          \u003ch1 class=\"break-words text-lg sm:text-xl font-semibold\"\u003e{issue.subject || \"Issue\"}\u003c/h1\u003e\n-          \u003cdiv class=\"mt-2 flex flex-col sm:flex-row sm:items-center gap-2\"\u003e\n+          \u003ch1 class=\"break-words text-lg font-semibold sm:text-xl\"\u003e{issue.subject || \"Issue\"}\u003c/h1\u003e\n+          \u003cdiv class=\"mt-2 flex flex-col gap-2 sm:flex-row sm:items-center\"\u003e\n             \u003cStatus\n               repo={repoClass}\n               rootId={issue.id}\n@@ -343,18 +344,22 @@\n               actorPubkey={$pubkey}\n               compact={true}\n               ProfileComponent={ProfileLink} /\u003e\n-            \u003cspan class=\"text-xs sm:text-sm text-muted-foreground flex flex-wrap items-center gap-1\"\u003e\n+            \u003cspan\n+              class=\"flex flex-wrap items-center gap-1 text-xs text-muted-foreground sm:text-sm\"\u003e\n               \u003cProfileLink pubkey={issue?.author.pubkey}\u003e\u003c/ProfileLink\u003e\n               \u003cspan class=\"hidden sm:inline\"\u003eopened this issue •\u003c/span\u003e\n               \u003cspan class=\"sm:hidden\"\u003eopened\u003c/span\u003e\n-              \u003cspan class=\"text-xs break-all sm:break-normal\"\u003e{new Date(issue?.createdAt).toLocaleString()}\u003c/span\u003e\n+              \u003cspan class=\"break-all text-xs sm:break-normal\"\n+                \u003e{new Date(issue?.createdAt).toLocaleString()}\u003c/span\u003e\n             \u003c/span\u003e\n           \u003c/div\u003e\n         \u003c/div\u003e\n       \u003c/div\u003e\n \n-      \u003cdiv class=\"prose-sm dark:prose-invert prose mt-6 sm:mt-8 max-w-none break-words [\u0026_*]:break-words [\u0026_pre]:overflow-x-auto [\u0026_code]:break-words\"\u003e\n-        {@html markdown.render(issue.content)}\n+      \u003cdiv\n+        class=\"prose-sm dark:prose-invert prose mt-6 max-w-none break-words sm:mt-8 [\u0026_*]:break-words [\u0026_code]:break-words [\u0026_pre]:overflow-x-auto\"\u003e\n+        \u003c!-- {@html markdown.render(issue.content)} --\u003e\n+        \u003cMarkdown content={issue.content} /\u003e\n       \u003c/div\u003e\n \n       \u003cdiv class=\"git-separator my-4 sm:my-6\"\u003e\u003c/div\u003e\n@@ -369,16 +374,17 @@\n           \u003c/div\u003e\n         {/if}\n         {#if isMaintainerOrAuthor}\n-          \u003cdiv class=\"flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full max-w-full\"\u003e\n+          \u003cdiv\n+            class=\"flex w-full max-w-full flex-col items-stretch gap-2 sm:flex-row sm:items-center\"\u003e\n             \u003cinput\n-              class=\"flex-1 min-w-0 rounded-md border border-border bg-background px-3 py-2 sm:px-2 sm:py-1 text-sm min-h-[44px] sm:min-h-0\"\n+              class=\"min-h-[44px] min-w-0 flex-1 rounded-md border border-border bg-background px-3 py-2 text-sm sm:min-h-0 sm:px-2 sm:py-1\"\n               placeholder=\"Add tag...\"\n               bind:value={newLabel}\n               onkeydown={e =\u003e {\n                 if (e.key === \"Enter\") addLabel()\n               }} /\u003e\n             \u003cbutton\n-              class=\"flex-shrink-0 rounded-md border border-border px-3 py-2 sm:px-3 sm:py-1 text-sm min-h-[44px] sm:min-h-0\"\n+              class=\"min-h-[44px] flex-shrink-0 rounded-md border border-border px-3 py-2 text-sm sm:min-h-0 sm:px-3 sm:py-1\"\n               onclick={addLabel}\n               disabled={addingLabel || !newLabel.trim()}\u003e\n               \u003cspan class=\"whitespace-nowrap\"\u003e{addingLabel ? \"Adding...\" : \"Add Tag\"}\u003c/span\u003e\n@@ -400,24 +406,24 @@\n             {getProfile}\n             {searchProfiles}\n             add={async (pubkey: string) =\u003e {\n-              if (!issue) return;\n+              if (!issue) return\n               try {\n                 const relays = (repoClass.relays || repoRelays || []).map((u: string) =\u003e\n-                  normalizeRelayUrl(u)\n-                );\n+                  normalizeRelayUrl(u),\n+                )\n                 postRoleLabel({\n                   rootId: issue.id,\n                   role: \"assignee\",\n                   pubkeys: [pubkey],\n                   repoAddr: (repoClass as any)?.repoEvent?.id,\n                   relays,\n-                });\n+                })\n                 await load({\n                   relays,\n-                  filters: [{ kinds: [1985], \"#e\": [issue.id] }],\n-                });\n+                  filters: [{kinds: [1985], \"#e\": [issue.id]}],\n+                })\n               } catch (err) {\n-                console.error(\"[IssueDetail] Failed to add assignee\", err);\n+                console.error(\"[IssueDetail] Failed to add assignee\", err)\n               }\n             }}\n             onDeleteLabel={async (evt: LabelEvent) =\u003e {\n@@ -426,23 +432,20 @@\n                 const relays = (repoClass.relays || repoRelays || [])\n                   .map((u: string) =\u003e normalizeRelayUrl(u))\n                   .filter(Boolean)\n-                publishDelete({ event: evt as any, relays, protect: false })\n-                await load({ relays, filters: [{ kinds: [1985], \"#e\": [issue.id] }] })\n+                publishDelete({event: evt as any, relays, protect: false})\n+                await load({relays, filters: [{kinds: [1985], \"#e\": [issue.id]}]})\n               } catch (err) {\n                 console.error(\"[IssueDetail] Failed to delete assignee label\", err)\n               }\n-            }}\n-          /\u003e\n+            }} /\u003e\n+        {:else if assignees.length}\n+          \u003cdiv class=\"flex flex-wrap gap-2\"\u003e\n+            {#each assignees as pk (pk)}\n+              \u003cProfileLink pubkey={pk} /\u003e\n+            {/each}\n+          \u003c/div\u003e\n         {:else}\n-          {#if assignees.length}\n-            \u003cdiv class=\"flex flex-wrap gap-2\"\u003e\n-              {#each assignees as pk (pk)}\n-                \u003cProfileLink pubkey={pk} /\u003e\n-              {/each}\n-            \u003c/div\u003e\n-          {:else}\n-            \u003cdiv class=\"text-xs sm:text-sm text-muted-foreground\"\u003eNo assignees yet.\u003c/div\u003e\n-          {/if}\n+          \u003cdiv class=\"text-xs text-muted-foreground sm:text-sm\"\u003eNo assignees yet.\u003c/div\u003e\n         {/if}\n       \u003c/div\u003e\n \n@@ -462,8 +465,8 @@\n \n       \u003cdiv class=\"git-separator my-4 sm:my-6\"\u003e\u003c/div\u003e\n \n-      \u003ch2 class=\"my-2 flex items-center gap-2 text-base sm:text-lg font-medium\"\u003e\n-        \u003cMessageSquare class=\"h-4 w-4 sm:h-5 sm:w-5 flex-shrink-0\" /\u003e\n+      \u003ch2 class=\"my-2 flex items-center gap-2 text-base font-medium sm:text-lg\"\u003e\n+        \u003cMessageSquare class=\"h-4 w-4 flex-shrink-0 sm:h-5 sm:w-5\" /\u003e\n         \u003cspan class=\"break-words\"\u003eDiscussion ({$threadComments?.length})\u003c/span\u003e\n       \u003c/h2\u003e\n \n@@ -476,8 +479,8 @@\n     \u003c/Card\u003e\n   \u003c/div\u003e\n {:else}\n-  \u003cdiv class=\"flex flex-col items-center justify-center py-8 sm:py-12 px-4\"\u003e\n+  \u003cdiv class=\"flex flex-col items-center justify-center px-4 py-8 sm:py-12\"\u003e\n     \u003cSearchX class=\"mb-2 h-6 w-6 sm:h-8 sm:w-8\" /\u003e\n-    \u003cp class=\"text-sm sm:text-base text-center\"\u003eNo issue found.\u003c/p\u003e\n+    \u003cp class=\"text-center text-sm sm:text-base\"\u003eNo issue found.\u003c/p\u003e\n   \u003c/div\u003e\n {/if}\n--\nlibgit2 1.9.1\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-z9kic8k1","title":"Repotab should be responsive on mobile","description":"We dont need to make every little thing responsive yet, but this is important","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","issue"]}
{"id":"flotilla-zesr9tw4","title":"Sent DMs are not shown","description":"Probably a problem with creating the live subscription","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","closed_at":"2026-01-24T17:55:52.370417-08:00","labels":["bug","dm","issue","v1"]}
{"id":"flotilla-zeykgdo5","title":"From 1bfc579eb8ef46fcfc20aca3437bf54fd6b43abb Mon Sep 17 00:00:00 2001","description":"From 1bfc579eb8ef46fcfc20aca3437bf54fd6b43abb Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Wed, 30 Jul 2025 11:10:23 -0700\nSubject: [PATCH 3/8] feat: add commit details page with file diff viewer and GitHub identity verification\n\n---\n packages/nostr-git                                                       |   2 +-\n src/app/commands.ts                                                      |  10 ++++++++--\n src/app/components/GitAuth.svelte                                        |   2 --\n src/app/components/GitAuthAdd.svelte                                     |   1 +\n src/app/components/ProfileEdit.svelte                                    |  21 +++++++++++++++++++--\n src/app/components/ProfileEditForm.svelte                                | 216 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--\n src/app/components/SignUpProfile.svelte                                  |  12 ++++++++++--\n src/routes/spaces/[relay]/git/+page.svelte                               |  16 +++++++++++++---\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                  |  16 +++++++++++++++-\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte                    |   1 -\n src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte            |  13 ++++++++++++-\n src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte | 225 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts     | 120 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte             |   2 +-\n 14 files changed, 639 insertions(+), 18 deletions(-)\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\n create mode 100644 src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 0336d88..d6f2fd1 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 0336d880f964d5179b4be9cbefb41989159fa1a3\n+Subproject commit d6f2fd17cddc608bc6d0e1e981b6e5a85f101ca9\ndiff --git a/src/app/commands.ts b/src/app/commands.ts\nindex ec0f247..e932183 100644\n--- a/src/app/commands.ts\n+++ b/src/app/commands.ts\n@@ -62,7 +62,7 @@ import {\n   NOTIFIER_RELAY,\n   userRoomsByUrl,\n } from \"@app/state\"\n-import type {CommentEvent, IssueEvent, StatusEvent} from \"@nostr-git/shared-types\"\n+import type {CommentEvent, IssueEvent, RepoAnnouncementEvent, StatusEvent} from \"@nostr-git/shared-types\"\n \n // Utils\n \n@@ -462,9 +462,15 @@ export const postIssue = (issue: IssueEvent, relays: string[]) =\u003e {\n }\n \n export const postStatus = (status: StatusEvent, relays: string[]) =\u003e {\n-  console.log(status)\n   return publishThunk({\n     relays: relays ?? [],\n     event: status,\n   })\n }\n+\n+export const postRepoAnnouncement = (repo: RepoAnnouncementEvent, relays: string[]) =\u003e {\n+  return publishThunk({\n+    relays: relays ?? [],\n+    event: repo,\n+  })\n+}\n\\ No newline at end of file\ndiff --git a/src/app/components/GitAuth.svelte b/src/app/components/GitAuth.svelte\nindex a8dd257..8f2e07b 100644\n--- a/src/app/components/GitAuth.svelte\n+++ b/src/app/components/GitAuth.svelte\n@@ -4,8 +4,6 @@\n   import Button from \"@lib/components/Button.svelte\"\n   import {pushModal} from \"@app/modal\"\n   import GitAuthAdd from \"@app/components/GitAuthAdd.svelte\"\n-  import {pubkey} from \"@welshman/app\"\n-  import {signer} from \"@welshman/app\"\n   import {tokens as tokensStore} from \"@nostr-git/ui\"\n \n   type Props = {\ndiff --git a/src/app/components/GitAuthAdd.svelte b/src/app/components/GitAuthAdd.svelte\nindex eb57d7a..4f277ce 100644\n--- a/src/app/components/GitAuthAdd.svelte\n+++ b/src/app/components/GitAuthAdd.svelte\n@@ -23,6 +23,7 @@\n \n   const back = () =\u003e history.back()\n   //ghp_REDACTED_TOKEN\n+  //ghp_REDACTED_TOKEN\n   const disabled = $state(true)\n \n   let host = $state(editToken?.host || \"\")\ndiff --git a/src/app/components/ProfileEdit.svelte b/src/app/components/ProfileEdit.svelte\nindex b3a2af3..4f7264a 100644\n--- a/src/app/components/ProfileEdit.svelte\n+++ b/src/app/components/ProfileEdit.svelte\n@@ -24,10 +24,27 @@\n \n   const back = () =\u003e history.back()\n \n-  const onsubmit = ({profile, shouldBroadcast}: {profile: Profile; shouldBroadcast: boolean}) =\u003e {\n+  const onsubmit = ({profile, shouldBroadcast, githubIdentity}: {profile: Profile; shouldBroadcast: boolean; githubIdentity?: {username: string; proof: string}}) =\u003e {\n     const router = Router.get()\n     const template = isPublishedProfile(profile) ? editProfile(profile) : createProfile(profile)\n     const scenarios = [router.FromRelays(getMembershipUrls($userMembership))]\n+    \n+    // Handle NIP-39 GitHub identity\n+    if (githubIdentity?.username \u0026\u0026 githubIdentity?.proof) {\n+      // Remove existing GitHub identity tags\n+      template.tags = template.tags.filter(tag =\u003e \n+        !(tag[0] === 'i' \u0026\u0026 tag[1]?.startsWith('github:'))\n+      )\n+      \n+      // Add new GitHub identity tag\n+      const githubTag = ['i', `github:${githubIdentity.username}`, githubIdentity.proof]\n+      template.tags.push(githubTag)\n+    } else {\n+      // Remove GitHub identity tags if no identity provided\n+      template.tags = template.tags.filter(tag =\u003e \n+        !(tag[0] === 'i' \u0026\u0026 tag[1]?.startsWith('github:'))\n+      )\n+    }\n \n     if (shouldBroadcast) {\n       scenarios.push(router.FromUser(), router.Index())\n@@ -45,7 +62,7 @@\n   }\n \u003c/script\u003e\n \n-\u003cProfileEditForm {initialValues} {onsubmit}\u003e\n+\u003cProfileEditForm {initialValues} {onsubmit} pubkey={$pubkey!}\u003e\n   {#snippet footer()}\n     \u003cdiv class=\"mt-4 flex flex-row items-center justify-between gap-4\"\u003e\n       \u003cButton class=\"btn btn-neutral\" onclick={back}\u003eDiscard Changes\u003c/Button\u003e\ndiff --git a/src/app/components/ProfileEditForm.svelte b/src/app/components/ProfileEditForm.svelte\nindex 13288e2..3f727f6 100644\n--- a/src/app/components/ProfileEditForm.svelte\n+++ b/src/app/components/ProfileEditForm.svelte\n@@ -2,6 +2,8 @@\n   import type {Snippet} from \"svelte\"\n   import type {Profile} from \"@welshman/util\"\n   import {preventDefault} from \"@lib/html\"\n+  import {nip19} from \"nostr-tools\"\n+  import {tokens as tokensStore} from \"@nostr-git/ui\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Field from \"@lib/components/Field.svelte\"\n   import FieldInline from \"@lib/components/FieldInline.svelte\"\n@@ -13,6 +15,10 @@\n   type Values = {\n     profile: Profile\n     shouldBroadcast: boolean\n+    githubIdentity?: {\n+      username: string\n+      proof: string // GitHub Gist ID\n+    }\n   }\n \n   type Props = {\n@@ -20,15 +26,120 @@\n     onsubmit: (values: Values) =\u003e void\n     hideAddress?: boolean\n     footer: Snippet\n+    pubkey: string\n   }\n \n-  const {initialValues, hideAddress, onsubmit, footer}: Props = $props()\n+  const {initialValues, hideAddress, onsubmit, footer, pubkey}: Props = $props()\n \n-  const values = $state(initialValues)\n+  const values = $state({\n+    ...initialValues,\n+    githubIdentity: (() =\u003e {\n+      // Extract GitHub identity from existing profile tags if present\n+      const existingGithubTag = initialValues.profile.event?.tags?.find(tag =\u003e \n+        tag[0] === 'i' \u0026\u0026 tag[1]?.startsWith('github:')\n+      )\n+      \n+      if (existingGithubTag) {\n+        const [, platformIdentity, proof] = existingGithubTag\n+        const username = platformIdentity.split(':')[1]\n+        if (username \u0026\u0026 proof) {\n+          return { username, proof }\n+        }\n+      }\n+      \n+      return { username: '', proof: '' }\n+    })()\n+  })\n \n   const submit = () =\u003e onsubmit($state.snapshot(values))\n \n   let file: File | undefined = $state()\n+  let isCreatingAttestation = $state(false)\n+  let attestationError = $state('')\n+  \n+  const npub = nip19.npubEncode(pubkey)\n+  \n+  // Check if user has GitHub token and no existing GitHub identity\n+  const githubToken = $derived(() =\u003e {\n+    const tokens = $tokensStore\n+    return tokens.find(t =\u003e t.host === 'github.com' || t.host === 'api.github.com')\n+  })\n+  \n+  const shouldOfferAutoAttestation = $derived(() =\u003e {\n+    return githubToken() \u0026\u0026 \n+           (!values.githubIdentity?.username || !values.githubIdentity?.proof) \u0026\u0026\n+           !isCreatingAttestation\n+  })\n+  \n+  // Auto-create GitHub attestation\n+  async function createGitHubAttestation() {\n+    const token = githubToken()\n+    if (!token) {\n+      attestationError = 'No GitHub token found'\n+      return\n+    }\n+    \n+    isCreatingAttestation = true\n+    attestationError = ''\n+    \n+    try {\n+      // Get GitHub user info\n+      const userResponse = await fetch('https://api.github.com/user', {\n+        headers: {\n+          'Authorization': `token ${token.token}`,\n+          'Accept': 'application/vnd.github.v3+json'\n+        }\n+      })\n+      \n+      if (!userResponse.ok) {\n+        throw new Error(`GitHub API error: ${userResponse.status}`)\n+      }\n+      \n+      const userData = await userResponse.json()\n+      const username = userData.login\n+      \n+      // Create attestation text\n+      const attestationText = `Verifying that I control the following Nostr public key: ${npub}`\n+      \n+      // Create GitHub Gist\n+      const gistResponse = await fetch('https://api.github.com/gists', {\n+        method: 'POST',\n+        headers: {\n+          'Authorization': `token ${token.token}`,\n+          'Accept': 'application/vnd.github.v3+json',\n+          'Content-Type': 'application/json'\n+        },\n+        body: JSON.stringify({\n+          description: 'Nostr Identity Verification (NIP-39)',\n+          public: true,\n+          files: {\n+            'nostr-verification.txt': {\n+              content: attestationText\n+            }\n+          }\n+        })\n+      })\n+      \n+      if (!gistResponse.ok) {\n+        throw new Error(`Failed to create Gist: ${gistResponse.status}`)\n+      }\n+      \n+      const gistData = await gistResponse.json()\n+      const gistId = gistData.id\n+      \n+      // Update form values\n+      values.githubIdentity = {\n+        username,\n+        proof: gistId\n+      }\n+      \n+    } catch (error) {\n+      console.error('Failed to create GitHub attestation:', error)\n+      attestationError = error instanceof Error ? error.message : 'Failed to create attestation'\n+    } finally {\n+      isCreatingAttestation = false\n+    }\n+  }\n \u003c/script\u003e\n \n \u003cform class=\"col-4\" onsubmit={preventDefault(submit)}\u003e\n@@ -63,6 +174,107 @@\n       Give a brief introduction to why you're here.\n     {/snippet}\n   \u003c/Field\u003e\n+  \n+  \u003c!-- Auto-Attestation Offer --\u003e\n+  {#if shouldOfferAutoAttestation()}\n+    \u003cdiv class=\"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4\"\u003e\n+      \u003cdiv class=\"flex items-start gap-3\"\u003e\n+        \u003cIcon icon=\"info-circle\" class=\"text-blue-600 mt-0.5\" /\u003e\n+        \u003cdiv class=\"flex-1\"\u003e\n+          \u003ch4 class=\"font-medium text-blue-900 mb-2\"\u003eAutomatic GitHub Verification Available\u003c/h4\u003e\n+          \u003cp class=\"text-sm text-blue-700 mb-3\"\u003e\n+            We detected you have a GitHub token configured. We can automatically create a verification Gist \n+            and set up your GitHub identity for you.\n+          \u003c/p\u003e\n+          \u003cButton \n+            class=\"btn btn-sm btn-primary\" \n+            onclick={createGitHubAttestation}\n+            disabled={isCreatingAttestation}\n+          \u003e\n+            {#if isCreatingAttestation}\n+              \u003cIcon icon=\"clock-circle\" class=\"animate-spin\" /\u003e\n+              Creating Attestation...\n+            {:else}\n+              \u003cIcon icon=\"git\" /\u003e\n+              Auto-Verify GitHub Identity\n+            {/if}\n+          \u003c/Button\u003e\n+          {#if attestationError}\n+            \u003cp class=\"text-sm text-red-600 mt-2\"\u003e{attestationError}\u003c/p\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  {/if}\n+  \n+  \u003c!-- GitHub Identity Section (NIP-39) --\u003e\n+  \u003cField\u003e\n+    {#snippet label()}\n+      \u003cp\u003eGitHub Identity \u003cspan class=\"text-xs text-gray-500\"\u003e(NIP-39)\u003c/span\u003e\u003c/p\u003e\n+    {/snippet}\n+    {#snippet input()}\n+      \u003clabel class=\"input input-bordered flex w-full items-center gap-2\"\u003e\n+        \u003cIcon icon=\"git\" /\u003e\n+        \u003cinput \n+          bind:value={values.githubIdentity.username} \n+          class=\"grow\" \n+          type=\"text\" \n+          placeholder=\"your-github-username\"\n+        /\u003e\n+      \u003c/label\u003e\n+    {/snippet}\n+    {#snippet info()}\n+      Your GitHub username for identity verification.\n+    {/snippet}\n+  \u003c/Field\u003e\n+  \n+  {#if values.githubIdentity?.username}\n+    \u003cField\u003e\n+      {#snippet label()}\n+        \u003cp\u003eGitHub Proof \u003cspan class=\"text-xs text-gray-500\"\u003e(Gist ID)\u003c/span\u003e\u003c/p\u003e\n+      {/snippet}\n+      {#snippet input()}\n+        \u003clabel class=\"input input-bordered flex w-full items-center gap-2\"\u003e\n+          \u003cIcon icon=\"link-round\" /\u003e\n+          \u003cinput \n+            bind:value={values.githubIdentity.proof} \n+            class=\"grow\" \n+            type=\"text\" \n+            placeholder=\"abc123def456\"\n+          /\u003e\n+        \u003c/label\u003e\n+      {/snippet}\n+      {#snippet info()}\n+        {#if !shouldOfferAutoAttestation() \u0026\u0026 !values.githubIdentity?.proof}\n+          \u003cp class=\"text-sm\"\u003e\n+            Create a GitHub Gist with the text: \u003cbr/\u003e\n+            \u003ccode class=\"bg-gray-100 px-1 rounded text-xs break-all\"\u003e\n+              Verifying that I control the following Nostr public key: {npub}\n+            \u003c/code\u003e\u003cbr/\u003e\n+            Then paste the Gist ID here.\n+          \u003c/p\u003e\n+        {:else if values.githubIdentity?.proof}\n+          \u003cp class=\"text-sm\"\u003e\n+            Your verification Gist is available at:\u003cbr/\u003e\n+            \u003ca \n+              href=\"https://gist.github.com/{values.githubIdentity?.username}/{values.githubIdentity?.proof}\" \n+              target=\"_blank\" \n+              rel=\"noopener noreferrer\"\n+              class=\"inline-flex items-center gap-1 text-blue-600 hover:text-blue-800 underline text-xs mt-1\"\n+            \u003e\n+              \u003cIcon icon=\"link-round\" size={3} /\u003e\n+              https://gist.github.com/{values.githubIdentity?.username}/{values.githubIdentity?.proof}\n+            \u003c/a\u003e\n+          \u003c/p\u003e\n+        {:else}\n+          \u003cp class=\"text-sm text-gray-500\"\u003e\n+            Gist ID will be automatically filled when you use the auto-verification above.\n+          \u003c/p\u003e\n+        {/if}\n+      {/snippet}\n+    \u003c/Field\u003e\n+  {/if}\n+  \n   {#if !hideAddress}\n     \u003cField\u003e\n       {#snippet label()}\ndiff --git a/src/app/components/SignUpProfile.svelte b/src/app/components/SignUpProfile.svelte\nindex 5c3bbe2..238d5db 100644\n--- a/src/app/components/SignUpProfile.svelte\n+++ b/src/app/components/SignUpProfile.svelte\n@@ -17,8 +17,16 @@\n     shouldBroadcast: true,\n   }\n \n-  const onsubmit = ({profile, shouldBroadcast}: {profile: Profile; shouldBroadcast: boolean}) =\u003e {\n-    const event = makeEvent(PROFILE, createProfile(profile))\n+  const onsubmit = ({profile, shouldBroadcast, githubIdentity}: {profile: Profile; shouldBroadcast: boolean; githubIdentity?: {username: string; proof: string}}) =\u003e {\n+    const template = createProfile(profile)\n+    \n+    // Handle NIP-39 GitHub identity\n+    if (githubIdentity?.username \u0026\u0026 githubIdentity?.proof) {\n+      const githubTag = ['i', `github:${githubIdentity.username}`, githubIdentity.proof]\n+      template.tags.push(githubTag)\n+    }\n+    \n+    const event = makeEvent(PROFILE, template)\n     const relays = shouldBroadcast ? INDEXER_RELAYS : []\n \n     loginWithNip01(secret)\ndiff --git a/src/routes/spaces/[relay]/git/+page.svelte b/src/routes/spaces/[relay]/git/+page.svelte\nindex 5a0bf46..8a526ed 100644\n--- a/src/routes/spaces/[relay]/git/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/+page.svelte\n@@ -2,7 +2,7 @@\n   import {page} from \"$app/stores\"\n   import {Address, NAMED_BOOKMARKS, type TrustedEvent} from \"@welshman/util\"\n   import {GIT_REPO, GIT_REPO_BOOKMARK_DTAG} from \"@src/lib/util\"\n-  import {repository, userMutes} from \"@welshman/app\"\n+  import {publishThunk, repository, userMutes} from \"@welshman/app\"\n   import {fly} from \"@lib/transition\"\n   import Icon from \"@lib/components/Icon.svelte\"\n   import Button from \"@lib/components/Button.svelte\"\n@@ -20,7 +20,8 @@\n   import PageContent from \"@src/lib/components/PageContent.svelte\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {derived as _derived} from \"svelte/store\"\n-    import { NewRepoWizard } from \"@nostr-git/ui\"\n+  import { NewRepoWizard } from \"@nostr-git/ui\"\n+    import type { RepoAnnouncementEvent } from \"@nostr-git/shared-types\"\n \n   const url = decodeRelay($page.params.relay)\n \n@@ -101,9 +102,18 @@\n \n   const onNewRepo = () =\u003e {\n     pushModal(NewRepoWizard, {\n-      onClose: () =\u003e {\n+      onCancel: () =\u003e {\n+        back()\n+      },\n+      onRepoCreated: () =\u003e {\n         back()\n       },\n+      onPublishEvent: async (event: RepoAnnouncementEvent) =\u003e {\n+        publishThunk({\n+          relays: [url],\n+          event,\n+        })\n+      },\n     })\n   }\n \u003c/script\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex 842bddf..462d5a1 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -71,6 +71,13 @@\n     }\n   }\n \n+  function forkRepo() {\n+    if (!repoClass) return\n+    \n+    // Fork the repository\n+    repoClass.workerManager.forkAndCloneRepo()\n+  }\n+\n   // Connect the nostr-git toast store to the toast component\n   $effect(() =\u003e {\n     if ($toast.length \u003e 0) {\n@@ -94,7 +101,14 @@\n   {:else if !repoClass}\n     \u003cdiv class=\"p-4 text-center text-red-500\"\u003eRepository not found.\u003c/div\u003e\n   {:else}\n-    \u003cRepoHeader event={repoClass.repoEvent} {activeTab} isRepoWatched={false} {refreshRepo} {isRefreshing}\u003e\n+    \u003cRepoHeader\n+      event={repoClass.repoEvent}\n+      {activeTab}\n+      isRepoWatched={false}\n+      {refreshRepo}\n+      {isRefreshing}\n+      {forkRepo}\n+    \u003e\n       {#snippet children(activeTab: string)}\n         \u003cRepoTab\n           tabValue=\"feed\"\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex 2ee4c84..ac2e937 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -15,7 +15,6 @@\n   } from \"@lucide/svelte\"\n   import {fade, fly, slide} from \"@lib/transition\"\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n-  import {pushToast} from \"@src/app/toast\"\n   import {formatDistanceToNow} from \"date-fns\"\n   import {nthEq} from \"@welshman/lib\"\n   import Button from \"@src/lib/components/Button.svelte\"\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\nindex 53595bc..64ee427 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/+page.svelte\n@@ -1,4 +1,5 @@\n \u003cscript lang=\"ts\"\u003e\n+  import { page } from '$app/stores';\n   import {GitBranch, User, Search} from \"@lucide/svelte\"\n   import {\n     Input,\n@@ -45,6 +46,11 @@\n   // Track if we're currently loading more commits\n   let isLoadingMore = $state(true)\n \n+  // Create navigation helper\n+  const getCommitUrl = (commitId: string) =\u003e {\n+    return `/spaces/${encodeURIComponent($page.params.relay)}/git/${encodeURIComponent($page.params.id)}/commits/${commitId}`;\n+  };\n+\n   // Set initial page size and load commits when the component mounts or when the repo changes\n   $effect(() =\u003e {\n     if (repoClass \u0026\u0026 repoClass.repoId \u0026\u0026 repoClass.mainBranch) {\n@@ -254,7 +260,12 @@\n         {#if commits}\n           \u003cdiv class=\"space-y-4\" transition:slide\u003e\n             {#each filteredCommits as commit (commit.oid)}\n-              \u003cCommitCard {commit} onReact={handleReact} onComment={handleComment} /\u003e\n+              \u003cCommitCard \n+                {commit} \n+                onReact={handleReact} \n+                onComment={handleComment}\n+                href={getCommitUrl(commit.oid)}\n+              /\u003e\n             {/each}\n           \u003c/div\u003e\n           \u003cdiv class=\"mt-6 flex flex-col items-center gap-4 sm:flex-row sm:justify-between\"\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\nnew file mode 100644\nindex 0000000..0c8f3fb\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.svelte\n@@ -0,0 +1,225 @@\n+\u003cscript lang=\"ts\"\u003e\n+  import { page } from '$app/stores';\n+  import { ChevronDown, ChevronRight, FileText, FilePlus, FileMinus, FileX } from '@lucide/svelte';\n+  import { CommitHeader, SplitDiff } from '@nostr-git/ui';\n+  import type { PageData } from './$types';\n+\n+  let { data }: { data: PageData } = $props();\n+  \n+  // Extract data from page load\n+  const { commitMeta, changes, repoClass } = data;\n+\n+  // State for collapsible file panels\n+  let expandedFiles = $state\u003cSet\u003cstring\u003e\u003e(new Set());\n+\n+  // Toggle file expansion\n+  const toggleFile = (filepath: string) =\u003e {\n+    if (expandedFiles.has(filepath)) {\n+      expandedFiles.delete(filepath);\n+    } else {\n+      expandedFiles.add(filepath);\n+    }\n+    expandedFiles = new Set(expandedFiles); // Trigger reactivity\n+  };\n+\n+  // Get file status icon and styling\n+  const getFileStatusIcon = (status: string) =\u003e {\n+    switch (status) {\n+      case 'added':\n+        return { icon: FilePlus, class: 'text-green-600' };\n+      case 'deleted':\n+        return { icon: FileMinus, class: 'text-red-600' };\n+      case 'modified':\n+        return { icon: FileText, class: 'text-blue-600' };\n+      case 'renamed':\n+        return { icon: FileX, class: 'text-yellow-600' };\n+      default:\n+        return { icon: FileText, class: 'text-muted-foreground' };\n+    }\n+  };\n+\n+  // Get file status badge styling\n+  const getStatusBadgeClass = (status: string) =\u003e {\n+    switch (status) {\n+      case 'added':\n+        return 'bg-green-100 text-green-800 border-green-200';\n+      case 'deleted':\n+        return 'bg-red-100 text-red-800 border-red-200';\n+      case 'modified':\n+        return 'bg-blue-100 text-blue-800 border-blue-200';\n+      case 'renamed':\n+        return 'bg-yellow-100 text-yellow-800 border-yellow-200';\n+      default:\n+        return 'bg-gray-100 text-gray-800 border-gray-200';\n+    }\n+  };\n+\n+  // Calculate diff stats for each file\n+  const getFileStats = (hunks: any[]) =\u003e {\n+    let additions = 0;\n+    let deletions = 0;\n+    \n+    for (const hunk of hunks) {\n+      for (const patch of hunk.patches) {\n+        if (patch.type === '+') additions++;\n+        else if (patch.type === '-') deletions++;\n+      }\n+    }\n+    \n+    return { additions, deletions };\n+  };\n+\n+  // Calculate total diff stats\n+  const totalStats = $derived(() =\u003e {\n+    let totalAdditions = 0;\n+    let totalDeletions = 0;\n+    \n+    for (const change of changes) {\n+      const stats = getFileStats(change.diffHunks);\n+      totalAdditions += stats.additions;\n+      totalDeletions += stats.deletions;\n+    }\n+    \n+    return { totalAdditions, totalDeletions };\n+  });\n+\n+  // Expand all files by default if there are few changes\n+  $effect(() =\u003e {\n+    if (changes.length \u003c= 5) {\n+      expandedFiles = new Set(changes.map(change =\u003e change.path));\n+    }\n+  });\n+\u003c/script\u003e\n+\n+\u003csvelte:head\u003e\n+  \u003ctitle\u003eCommit {commitMeta.sha.slice(0, 7)} · {repoClass.repoEvent?.content ? JSON.parse(repoClass.repoEvent.content).name : 'Repository'}\u003c/title\u003e\n+\u003c/svelte:head\u003e\n+\n+\u003cdiv class=\"min-h-screen bg-background\"\u003e\n+  \u003c!-- Commit Header --\u003e\n+  \u003cCommitHeader\n+    sha={commitMeta.sha}\n+    author={commitMeta.author}\n+    email={commitMeta.email}\n+    date={commitMeta.date}\n+    message={commitMeta.message}\n+    parents={commitMeta.parents}\n+  /\u003e\n+\n+  \u003c!-- Diff Summary --\u003e\n+  \u003cdiv class=\"border-b border-border bg-card px-6 py-4\"\u003e\n+    \u003cdiv class=\"flex items-center justify-between\"\u003e\n+      \u003cdiv class=\"flex items-center gap-4\"\u003e\n+        \u003ch2 class=\"text-lg font-semibold text-foreground\"\u003e\n+          {changes.length} {changes.length === 1 ? 'file' : 'files'} changed\n+        \u003c/h2\u003e\n+        \u003cdiv class=\"flex items-center gap-2 text-sm text-muted-foreground\"\u003e\n+          {#if totalStats().totalAdditions \u003e 0}\n+            \u003cspan class=\"text-green-600\"\u003e+{totalStats().totalAdditions}\u003c/span\u003e\n+          {/if}\n+          {#if totalStats().totalDeletions \u003e 0}\n+            \u003cspan class=\"text-red-600\"\u003e-{totalStats().totalDeletions}\u003c/span\u003e\n+          {/if}\n+        \u003c/div\u003e\n+      \u003c/div\u003e\n+      \n+      \u003c!-- Expand/Collapse All --\u003e\n+      \u003cdiv class=\"flex items-center gap-2\"\u003e\n+        \u003cbutton\n+          onclick={() =\u003e {\n+            expandedFiles = new Set(changes.map(change =\u003e change.path));\n+          }}\n+          class=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n+        \u003e\n+          Expand all\n+        \u003c/button\u003e\n+        \u003cspan class=\"text-muted-foreground\"\u003e|\u003c/span\u003e\n+        \u003cbutton\n+          onclick={() =\u003e {\n+            expandedFiles = new Set();\n+          }}\n+          class=\"text-sm text-muted-foreground hover:text-foreground transition-colors\"\n+        \u003e\n+          Collapse all\n+        \u003c/button\u003e\n+      \u003c/div\u003e\n+    \u003c/div\u003e\n+  \u003c/div\u003e\n+\n+  \u003c!-- File Changes --\u003e\n+  \u003cdiv class=\"divide-y divide-border\"\u003e\n+    {#each changes as change (change.path)}\n+      {@const isExpanded = expandedFiles.has(change.path)}\n+      {@const statusInfo = getFileStatusIcon(change.status)}\n+      {@const stats = getFileStats(change.diffHunks)}\n+      \n+      \u003cdiv class=\"bg-background\"\u003e\n+        \u003c!-- File Header --\u003e\n+        \u003cbutton\n+          onclick={() =\u003e toggleFile(change.path)}\n+          class=\"w-full px-6 py-4 text-left hover:bg-muted/50 transition-colors focus:outline-none focus:bg-muted/50\"\n+        \u003e\n+          \u003cdiv class=\"flex items-center justify-between\"\u003e\n+            \u003cdiv class=\"flex items-center gap-3\"\u003e\n+              \u003c!-- Expand/Collapse Icon --\u003e\n+              {#if isExpanded}\n+                \u003cChevronDown class=\"h-4 w-4 text-muted-foreground\" /\u003e\n+              {:else}\n+                \u003cChevronRight class=\"h-4 w-4 text-muted-foreground\" /\u003e\n+              {/if}\n+              \n+              \u003c!-- File Status Icon --\u003e\n+              {#if statusInfo.icon}\n+                {@const IconComponent = statusInfo.icon}\n+                \u003cIconComponent class=\"h-4 w-4 {statusInfo.class}\" /\u003e\n+              {/if}\n+              \n+              \u003c!-- File Path --\u003e\n+              \u003cspan class=\"font-mono text-sm text-foreground\"\u003e{change.path}\u003c/span\u003e\n+              \n+              \u003c!-- Status Badge --\u003e\n+              \u003cspan class=\"rounded-full border px-2 py-0.5 text-xs font-medium {getStatusBadgeClass(change.status)}\"\u003e\n+                {change.status}\n+              \u003c/span\u003e\n+            \u003c/div\u003e\n+            \n+            \u003c!-- File Stats --\u003e\n+            \u003cdiv class=\"flex items-center gap-2 text-sm text-muted-foreground\"\u003e\n+              {#if stats.additions \u003e 0}\n+                \u003cspan class=\"text-green-600\"\u003e+{stats.additions}\u003c/span\u003e\n+              {/if}\n+              {#if stats.deletions \u003e 0}\n+                \u003cspan class=\"text-red-600\"\u003e-{stats.deletions}\u003c/span\u003e\n+              {/if}\n+            \u003c/div\u003e\n+          \u003c/div\u003e\n+        \u003c/button\u003e\n+\n+        \u003c!-- File Diff Content --\u003e\n+        {#if isExpanded}\n+          \u003cdiv class=\"px-6 pb-6\"\u003e\n+            \u003cSplitDiff hunks={change.diffHunks} filepath={change.path} /\u003e\n+          \u003c/div\u003e\n+        {/if}\n+      \u003c/div\u003e\n+    {/each}\n+  \u003c/div\u003e\n+\n+  \u003c!-- Empty State --\u003e\n+  {#if changes.length === 0}\n+    \u003cdiv class=\"px-6 py-12 text-center\"\u003e\n+      \u003cFileText class=\"mx-auto h-12 w-12 text-muted-foreground\" /\u003e\n+      \u003ch3 class=\"mt-4 text-lg font-medium text-foreground\"\u003eNo file changes\u003c/h3\u003e\n+      \u003cp class=\"mt-2 text-sm text-muted-foreground\"\u003e\n+        This commit doesn't contain any file changes.\n+      \u003c/p\u003e\n+    \u003c/div\u003e\n+  {/if}\n+\u003c/div\u003e\n+\n+\u003cstyle\u003e\n+  /* Ensure proper font rendering for code */\n+  .font-mono {\n+    font-family: ui-monospace, SFMono-Regular, \"SF Mono\", Consolas, \"Liberation Mono\", Menlo, monospace;\n+  }\n+\u003c/style\u003e\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\nnew file mode 100644\nindex 0000000..3940ef5\n--- /dev/null\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\n@@ -0,0 +1,120 @@\n+import type { PageLoad } from './$types';\n+import { getGitWorker } from '@nostr-git/core';\n+import { pushToast } from '@src/app/toast';\n+\n+export interface CommitChange {\n+  path: string;\n+  status: 'added' | 'modified' | 'deleted' | 'renamed';\n+  diffHunks: Array\u003c{\n+    oldStart: number;\n+    oldLines: number;\n+    newStart: number;\n+    newLines: number;\n+    patches: Array\u003c{ line: string; type: '+' | '-' | ' ' }\u003e;\n+  }\u003e;\n+}\n+\n+export interface CommitMeta {\n+  sha: string;\n+  author: string;\n+  email: string;\n+  date: number;\n+  message: string;\n+  parents: string[];\n+}\n+\n+export const load: PageLoad = async ({ params, parent }) =\u003e {\n+  const { commitid } = params;\n+  \n+  try {\n+    // Get parent data which includes repoClass\n+    const parentData = await parent();\n+    const { repoClass } = parentData;\n+    \n+    if (!repoClass || !repoClass.repoId) {\n+      pushToast({\n+        message: 'Repository not found',\n+        theme: 'error',\n+        timeout: 5000\n+      });\n+      return;\n+    }\n+\n+    // Get git worker instance\n+    const gitWorker = getGitWorker();\n+    \n+    // Ensure repository is properly initialized and cloned\n+    console.log('Initializing repository:', repoClass.repoId, 'with branch:', repoClass.mainBranch);\n+    \n+    try {\n+      // First ensure the repository is initialized\n+      await gitWorker.api.smartInitializeRepo({\n+        repoId: repoClass.repoEvent.id,\n+        branch: repoClass.mainBranch\n+      });\n+      \n+      // Then ensure we have full clone with sufficient depth\n+      await gitWorker.api.ensureFullClone({\n+        repoId: repoClass.repoEvent.id,\n+        branch: repoClass.mainBranch,\n+        depth: 100\n+      });\n+    } catch (initError) {\n+      console.error('Repository initialization failed:', initError);\n+      const errorMessage = initError instanceof Error ? initError.message : String(initError);\n+      pushToast({\n+        message: `Failed to initialize repository: ${errorMessage}`,\n+        theme: 'error',\n+        timeout: 5000\n+      });\n+      return;\n+    }\n+    \n+    // Get detailed commit information including file changes\n+    const commitDetails = await gitWorker.api.getCommitDetails({\n+      repoId: repoClass.repoEvent.id,\n+      commitId: commitid\n+    });\n+\n+    if (!commitDetails.success) {\n+      pushToast({\n+        message: commitDetails.error || 'Commit not found',\n+        theme: 'error',\n+        timeout: 5000\n+      });\n+      return;\n+    }\n+\n+    // Create commit metadata from detailed commit data\n+    const commitMeta: CommitMeta = {\n+      sha: commitDetails.meta.sha,\n+      author: commitDetails.meta.author,\n+      email: commitDetails.meta.email,\n+      date: commitDetails.meta.date,\n+      message: commitDetails.meta.message,\n+      parents: commitDetails.meta.parents\n+    };\n+\n+    // Convert git-worker changes to our CommitChange format\n+    const changes: CommitChange[] = commitDetails.changes.map((change: any) =\u003e ({\n+      path: change.path,\n+      status: change.status,\n+      diffHunks: change.diffHunks\n+    }));\n+\n+    return {\n+      commitMeta,\n+      changes,\n+      repoClass,\n+      commitid\n+    };\n+  } catch (err) {\n+    console.error('Error loading commit details:', err);\n+    pushToast({\n+      message: 'Failed to load commit details',\n+      theme: 'error',\n+      timeout: 5000\n+    });\n+    return;\n+  }\n+};\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\nindex b1b82b8..ec8b922 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/issues/+page.svelte\n@@ -24,7 +24,7 @@\n   import Spinner from \"@src/lib/components/Spinner.svelte\"\n   import {makeFeed} from \"@src/app/requests\"\n   import {whenElementReady} from \"@src/lib/html\"\n-  import {fly, slide, slideAndFade} from \"@lib/transition\"\n+  import {slide, slideAndFade} from \"@lib/transition\"\n   import {pushModal} from \"@src/app/modal\"\n   import {\n     createStatusEvent,\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-zkmuw1hi","title":"From 0461faf180d89631d7201701ec56bcc341467431 Mon Sep 17 00:00:00 2001","description":"From 0461faf180d89631d7201701ec56bcc341467431 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Tue, 8 Jul 2025 21:54:13 -0700\nSubject: [PATCH 3/3] feat: add permalink extension to editor and patch apply button to UI\n\n---\n packages/nostr-git                                                      |  2 +-\n src/app/editor/index.ts                                                 |  7 +++++++\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte | 17 ++++++++++++-----\n 3 files changed, 20 insertions(+), 6 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 4f3f9cc..fa2291f 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 4f3f9cc02cad3aefe6b103cd9d876e9853e6a2e9\n+Subproject commit fa2291f7ee37f2ccb8179a3f76f31daeb423f6f7\ndiff --git a/src/app/editor/index.ts b/src/app/editor/index.ts\nindex 4b6c772..bd05a42 100644\n--- a/src/app/editor/index.ts\n+++ b/src/app/editor/index.ts\n@@ -17,6 +17,8 @@ import {Editor, MentionSuggestion, WelshmanExtension} from \"@welshman/editor\"\n import {makeMentionNodeView} from \"./MentionNodeView\"\n import ProfileSuggestion from \"./ProfileSuggestion.svelte\"\n import {pushToast} from \"@app/toast\"\n+import {PermalinkExtension} from \"@nostr-git/ui\"\n+import Spinner from \"@lib/components/Spinner.svelte\"\n \n export const getBlossomServer = () =\u003e {\n   const userUrls = getTagValues(\"server\", getListTags(userBlossomServers.get()))\n@@ -54,6 +56,11 @@ export const makeEditor = async ({\n     autofocus,\n     element: document.createElement(\"div\"),\n     extensions: [\n+      PermalinkExtension.configure({\n+        signer: async (e) =\u003e await signer.get().sign(e),\n+        relays: Router.get().FromUser().getUrls(),\n+        spinnerComponent: Spinner,\n+      }),\n       WelshmanExtension.configure({\n         submit,\n         extensions: {\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex f6214ea..3765238 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -1,6 +1,6 @@\n \u003cscript lang=\"ts\"\u003e\n   import {page} from \"$app/stores\"\n-  import {Check, ChevronLeft, ChevronRight, GitCommit, MessageSquare, X} from \"@lucide/svelte\"\n+  import {Check, ChevronLeft, ChevronRight, GitCommit, GitMerge, MessageSquare, X} from \"@lucide/svelte\"\n   import {Button, Profile} from \"@nostr-git/ui\"\n   import ProfileLink from \"@app/components/ProfileLink.svelte\"\n   import {DiffViewer, IssueThread} from \"@nostr-git/ui\"\n@@ -119,15 +119,16 @@\n     }\n   })\n \n-  function truncateHash(hash: string): string {\n-    return hash.substring(0, 7)\n-  }\n-\n   const md = markdownit({\n     html: true,\n     linkify: true,\n     typographer: true,\n   })\n+\n+  const applyPatch = () =\u003e {\n+    \n+  }\n+\n \u003c/script\u003e\n \n {#if patch}\n@@ -266,6 +267,12 @@\n           {/key}\n         \u003c/div\u003e\n \n+        \u003cdiv class=\"flex justify-end\"\u003e\n+          \u003cButton onclick={applyPatch} variant=\"default\"\u003e\n+            \u003cGitMerge class=\"h-4 w-4\" /\u003e Apply\n+          \u003c/Button\u003e\n+        \u003c/div\u003e\n+\n         \u003cdiv class=\"git-separator my-6\"\u003e\u003c/div\u003e\n \n         \u003cdiv class=\"space-y-4\"\u003e\n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
{"id":"flotilla-zzj90zpt","title":"From a7fd91fde3b8807bd51b1a4b9b387a808d91a953 Mon Sep 17 00:00:00 2001","description":"From a7fd91fde3b8807bd51b1a4b9b387a808d91a953 Mon Sep 17 00:00:00 2001\nFrom: Biz \u003cchebizarro@gmail.com\u003e\nDate: Sun, 10 Aug 2025 17:59:45 -0700\nSubject: [PATCH 8/8] refactor: standardize repo ID references to use canonicalKey across UI components\n\n---\n packages/nostr-git                                                      |  2 +-\n src/app/components/GitActions.svelte                                    | 39 +++++++++++++++++++++++++++++++++------\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte                 |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts                     | 20 ++++++++++++++------\n src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte                   |  2 +-\n src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts    |  6 +++---\n src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte |  4 ++--\n 7 files changed, 55 insertions(+), 20 deletions(-)\n\ndiff --git a/packages/nostr-git b/packages/nostr-git\nindex 738600a..a1a07c4 160000\n--- a/packages/nostr-git\n+++ b/packages/nostr-git\n@@ -1 +1 @@\n-Subproject commit 738600a6c9cd9f752d21d78a193bf11d44b1011c\n+Subproject commit a1a07c45d8d7af42f2b13dfa7e86396528a9c8d6\ndiff --git a/src/app/components/GitActions.svelte b/src/app/components/GitActions.svelte\nindex dda62fc..7d2c5d5 100644\n--- a/src/app/components/GitActions.svelte\n+++ b/src/app/components/GitActions.svelte\n@@ -1,18 +1,22 @@\n \u003cscript lang=\"ts\"\u003e\n   import {load} from \"@welshman/net\"\n   import {Address, GIT_ISSUE, type EventContent, type TrustedEvent} from \"@welshman/util\"\n-  import {pubkey, repository} from \"@welshman/app\"\n+  import {repository} from \"@welshman/app\"\n   import ReactionSummary from \"@app/components/ReactionSummary.svelte\"\n   import ThunkStatusOrDeleted from \"@app/components/ThunkStatusOrDeleted.svelte\"\n   import EventActions from \"@app/components/EventActions.svelte\"\n   import {publishDelete, publishReaction} from \"@app/commands\"\n   import {makeGitPath} from \"@app/routes\"\n-  import Button from \"@src/lib/components/Button.svelte\"\n-  import Spinner from \"@src/lib/components/Spinner.svelte\"\n+  import Button from \"@lib/components/Button.svelte\"\n+  import Spinner from \"@lib/components/Spinner.svelte\"\n   import {deriveEvents} from \"@welshman/store\"\n   import {nthEq} from \"@welshman/lib\"\n   import {navigating} from \"$app/state\"\n   import {goto} from \"$app/navigation\"\n+  import { nip19 } from \"nostr-tools\"\n+  import type { AddressPointer } from \"nostr-tools/nip19\"\n+  import { canonicalRepoKey } from \"@nostr-git/core\"\n+  import { pushToast } from \"@app/toast\"\n \n   interface Props {\n     url: any\n@@ -57,13 +61,36 @@\n   })\n \n   const gotoRepo = async () =\u003e {\n-    const destination = makeGitPath(url, Address.fromEvent(event).toNaddr())\n+    const naddr = Address.fromEvent(event).toNaddr()\n+    try {\n+      const decoded = nip19.decode(naddr).data as AddressPointer\n+      const repoId = `${decoded.pubkey}:${decoded.identifier}`\n+      canonicalRepoKey(repoId)\n+    } catch (e) {\n+      pushToast({\n+        message: `Invalid repository identifier; expected \"owner/name\" or \"owner:name\". Cannot open repo until it is fixed: ${e}`,\n+        timeout: 7000,\n+      })\n+      return\n+    }\n+    const destination = makeGitPath(url, naddr)\n     goto(destination)\n   }\n \n   const gotoIssues = async () =\u003e {\n-    const destination = makeGitPath(url, Address.fromEvent(event).toNaddr()) + \"/issues\"\n-\n+    const naddr = Address.fromEvent(event).toNaddr()\n+    try {\n+      const decoded = nip19.decode(naddr).data as AddressPointer\n+      const repoId = `${decoded.pubkey}:${decoded.identifier}`\n+      canonicalRepoKey(repoId)\n+    } catch (e) {\n+      pushToast({\n+        message: `Invalid repository identifier; expected \"owner/name\" or \"owner:name\". Cannot open issues until repo is fixed.`,\n+        timeout: 7000,\n+      })\n+      return\n+    }\n+    const destination = makeGitPath(url, naddr) + \"/issues\"\n     goto(destination)\n   }\n \ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\nindex bbba2e9..f7ec02e 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.svelte\n@@ -48,7 +48,7 @@\n \n       // Call syncWithRemote through the repo's worker manager\n       const result = await repoClass.workerManager.syncWithRemote({\n-        repoId: repoClass.repoEvent.id,\n+        repoId: repoClass.canonicalKey,\n         cloneUrls,\n         branch: repoClass.mainBranch,\n       })\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\nindex 24a4d40..8d1862e 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+layout.ts\n@@ -22,9 +22,17 @@ export const load: LayoutLoad = async ({ params }) =\u003e {\n     const { repository } = await import('@welshman/app');\n     const { load } = await import(\"@welshman/net\");\n     const { Repo } = await import('@nostr-git/ui');\n+    const { canonicalRepoKey } = await import('@nostr-git/core');\n \n     const decoded = nip19.decode(id).data as AddressPointer;\n-    const repoId = decoded.identifier;\n+    const repoId = `${decoded.pubkey}:${decoded.identifier}`;\n+    const repoName = decoded.identifier;\n+    // Enforce canonical repo key at routing layer (fail fast)\n+    try {\n+        canonicalRepoKey(repoId);\n+    } catch (e) {\n+        throw new Error(`Invalid repoId: \"${repoId}\". Expected canonical repoId in the form \"owner/name\" or \"owner:name\".`);\n+    }\n     const url = decodeRelay(relay);\n \n     const fallbackRelays = INDEXER_RELAYS\n@@ -35,7 +43,7 @@ export const load: LayoutLoad = async ({ params }) =\u003e {\n     const filters = [{\n         authors: [decoded.pubkey],\n         kinds: [GIT_REPO_STATE, GIT_REPO],\n-        \"#d\": [decoded.identifier],\n+        \"#d\": [repoName],\n     }]\n \n     await load({ relays: relayListFromUrl as string[], filters })\n@@ -44,7 +52,7 @@ export const load: LayoutLoad = async ({ params }) =\u003e {\n         filters: [{\n             authors: [decoded.pubkey],\n             kinds: [GIT_REPO],\n-            \"#d\": [decoded.identifier],\n+            \"#d\": [repoName],\n         }]\n     }), (events) =\u003e events[0]) as Readable\u003cRepoAnnouncementEvent\u003e;\n \n@@ -52,7 +60,7 @@ export const load: LayoutLoad = async ({ params }) =\u003e {\n         filters: [{\n             authors: [decoded.pubkey],\n             kinds: [GIT_REPO_STATE],\n-            \"#d\": [decoded.identifier],\n+            \"#d\": [repoName],\n         }]\n     }), (events) =\u003e {\n \n@@ -76,12 +84,12 @@ export const load: LayoutLoad = async ({ params }) =\u003e {\n \n     const issueFilters = {\n         kinds: [GIT_ISSUE],\n-        \"#a\": [`${GIT_REPO}:${decoded.pubkey}:${decoded.identifier}`],\n+        \"#a\": [`${GIT_REPO}:${repoId}`],\n     }\n \n     const patchFilters = {\n         kinds: [GIT_PATCH],\n-        \"#a\": [`${GIT_REPO}:${decoded.pubkey}:${decoded.identifier}`],\n+        \"#a\": [`${GIT_REPO}:${repoId}`],\n     }\n \n     await load({ \ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\nindex ac2e937..ec5a1a8 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/+page.svelte\n@@ -66,7 +66,7 @@\n   const repoMetadata = $derived({\n     name: repoClass.repo?.name || \"Unknown Repository\",\n     description: repoClass.repo?.description || \"\",\n-    repoId: repoClass.repo?.repoId || \"\",\n+    repoId: repoClass.canonicalKey || \"\",\n     maintainers: maintainers || [],\n     relays: $repoRelays,\n     cloneUrls: repoClass.repo?.clone || [],\ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\nindex 3940ef5..60c20eb 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/commits/[commitid]/+page.ts\n@@ -49,13 +49,13 @@ export const load: PageLoad = async ({ params, parent }) =\u003e {\n     try {\n       // First ensure the repository is initialized\n       await gitWorker.api.smartInitializeRepo({\n-        repoId: repoClass.repoEvent.id,\n+        repoId: repoClass.canonicalKey,\n         branch: repoClass.mainBranch\n       });\n       \n       // Then ensure we have full clone with sufficient depth\n       await gitWorker.api.ensureFullClone({\n-        repoId: repoClass.repoEvent.id,\n+        repoId: repoClass.canonicalKey,\n         branch: repoClass.mainBranch,\n         depth: 100\n       });\n@@ -72,7 +72,7 @@ export const load: PageLoad = async ({ params, parent }) =\u003e {\n     \n     // Get detailed commit information including file changes\n     const commitDetails = await gitWorker.api.getCommitDetails({\n-      repoId: repoClass.repoEvent.id,\n+      repoId: repoClass.canonicalKey,\n       commitId: commitid\n     });\n \ndiff --git a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\nindex 0535fb6..1abf15d 100644\n--- a/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n+++ b/src/routes/spaces/[relay]/git/[id=naddr]/patches/[patchid]/+page.svelte\n@@ -364,8 +364,8 @@\n     }\n       \n     // Execute merge via worker\n-    // Use repoEvent.id as primary repository ID since that's what gets initialized in the worker\n-    const effectiveRepoId = repoClass.repoEvent?.id || repoClass.repoId || '';\n+    // Use canonical repo ID consistently for worker operations\n+    const effectiveRepoId = repoClass.canonicalKey || repoClass.repoId || '';\n     \n     try {\n         \n--\nlibgit2 1.9.0\n\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-24T17:55:51.370417-08:00","updated_at":"2026-01-24T17:55:51.370417-08:00","labels":["patch"]}
